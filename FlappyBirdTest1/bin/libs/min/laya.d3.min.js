!function(L,v){v.un,v.uns;var e=v.static,t=v.class,n=v.getset,w=v.__newvec,F=(laya.ani.AnimationContent,laya.ani.AnimationPlayer),B=(laya.ani.AnimationState,laya.ani.AnimationTemplet),U=laya.maths.Arith,H=laya.webgl.atlas.AtlasResourceManager,G=laya.webgl.shader.BaseShader,z=laya.utils.Browser,k=laya.webgl.utils.Buffer,X=laya.utils.Byte,Y=(laya.ani.bone.canvasmesh.CacheAbleSkinMesh,laya.utils.ClassUtils),Z=v.Config,i=(laya.events.Event,laya.events.EventDispatcher),j=laya.utils.Handler,K=laya.net.Loader,q=laya.net.LoaderManager,Q=laya.maths.MathUtil,$=laya.display.Node,J=laya.renders.Render,ee=(laya.renders.RenderContext,laya.renders.RenderSprite,laya.webgl.utils.RenderState2D),r=laya.resource.Resource,te=laya.utils.RunDriver,ne=(laya.webgl.shader.Shader,laya.webgl.utils.ShaderCompile),a=laya.display.Sprite,T=laya.utils.Stat,ie=laya.utils.StringKey,re=(laya.display.css.Style,laya.resource.Texture,laya.net.URL),ae=laya.utils.Utils,c=laya.webgl.WebGL,f=laya.webgl.WebGLContext,oe=(laya.webgl.canvas.WebGLContext2D,v.interface("laya.d3.core.IClone"),v.interface("laya.d3.graphics.IVertex"),v.interface("laya.d3.core.render.IUpdate"),v.interface("laya.d3.core.scene.ITreeNode"),v.interface("laya.d3.core.render.IRenderable"),t(se,"laya.d3.animation.AnimationClipParser01"),se.READ_DATA=function(){se._DATA.offset=se._reader.getUint32(),se._DATA.size=se._reader.getUint32()},se.READ_BLOCK=function(){for(var e=se._BLOCK.count=se._reader.getUint16(),t=se._BLOCK.blockStarts=[],n=se._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(se._reader.getUint32()),n.push(se._reader.getUint32())},se.READ_STRINGS=function(){var e=se._reader.getUint32(),t=se._reader.getUint16(),n=se._reader.pos;se._reader.pos=e+se._DATA.offset;for(var i=0;i<t;i++)se._strings[i]=se._reader.readUTFString();se._reader.pos=n},se.parse=function(e,t){se._animationClip=e;(se._reader=t).__getBuffer();se.READ_DATA(),se.READ_BLOCK(),se.READ_STRINGS();for(var n=0,i=se._BLOCK.count;n<i;n++){var r=t.getUint16(),a=se._strings[r],o=se["READ_"+a];if(null==o)throw new Error("model file err,no this function:"+r+" "+a);o.call()}},se.READ_ANIMATIONS=function(){var e=0,t=0,n=se._reader,i=n.__getBuffer(),r=[],a=n.getUint8();for(r.length=a,e=0;e<a;e++)r[e]=n.getUint16();var o=[],s=n.getUint16();for(o.length=s,e=0;e<s;e++)o[e]=n.getFloat32();var l=se._animationClip,h=(l.name=se._strings[n.getUint16()],l._duration=n.getFloat32()),_=(l.islooping=!!n.getByte(),l._frameRate=n.getInt16(),n.getInt16()),u=l._nodes=new Array;u.length=_;(l._publicClipDatas=[]).length=_;for(var d=l._nodesMap={},c=0,f=0,e=0;e<_;e++){var m=u[e]=new me,p=n.getUint16(),E=m.path=[];for(E.length=p,t=0;t<p;t++)E[t]=se._strings[n.getUint16()];var g=E.join("/"),v=d[g],g=(v||(d[g]=v=[]),v.push(m),n.getInt16()),v=(-1!==g&&(m.componentType=se._strings[g]),de._propertyIndexDic[se._strings[n.getUint16()]]);if(null==v)throw new Error("AnimationClipParser01:unknown property name.");for(var g=v<4,g=!g||""===E[0],T=((m._cacheProperty=g)?c++:f++,m.propertyNameID=v,r[n.getUint8()]),S=(m.keyFrameWidth=T/4,m.keyFrames=[]),D=S.length=n.getUint16(),x=null,M=NaN,t=0;t<D;t++){var R=S[t]=new ce,M=R.startTime=o[n.getUint16()],I=n.pos;R.inTangent=new Float32Array(i.slice(I,I+T)),n.pos+=T,I=n.pos,R.outTangent=new Float32Array(i.slice(I,I+T)),n.pos+=T,I=n.pos,R.data=new Float32Array(i.slice(I,I+T)),n.pos+=T,x&&(x.next=R,x.duration=M-x.startTime),x=R}R.next=null,R.duration=h-M}var A=l._nodeToCachePropertyMap=new Int32Array(_),C=l._cachePropertyMap=new Int32Array(c),y=l._unCachePropertyMap=new Int32Array(f),c=f=0;for(e=0;e<_;e++)(m=u[e])._cacheProperty?(A[e]=c,C[c++]=e):y[f++]=e},se._animationClip=null,se._reader=null,se._strings=[],e(se,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),se);function se(){}t(he,"laya.d3.animation.AnimationClipParser02"),he.READ_DATA=function(){he._DATA.offset=he._reader.getUint32(),he._DATA.size=he._reader.getUint32()},he.READ_BLOCK=function(){for(var e=he._BLOCK.count=he._reader.getUint16(),t=he._BLOCK.blockStarts=[],n=he._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(he._reader.getUint32()),n.push(he._reader.getUint32())},he.READ_STRINGS=function(){var e=he._reader.getUint32(),t=he._reader.getUint16(),n=he._reader.pos;he._reader.pos=e+he._DATA.offset;for(var i=0;i<t;i++)he._strings[i]=he._reader.readUTFString();he._reader.pos=n},he.parse=function(e,t){he._animationClip=e;(he._reader=t).__getBuffer();he.READ_DATA(),he.READ_BLOCK(),he.READ_STRINGS();for(var n=0,i=he._BLOCK.count;n<i;n++){var r=t.getUint16(),a=he._strings[r],o=he["READ_"+a];if(null==o)throw new Error("model file err,no this function:"+r+" "+a);o.call()}},he.READ_ANIMATIONS=function(){var e=0,t=0,n=he._reader,i=n.__getBuffer(),r=[],a=n.getUint8();for(r.length=a,e=0;e<a;e++)r[e]=n.getUint16();var o=[],s=n.getUint16();for(o.length=s,e=0;e<s;e++)o[e]=n.getFloat32();var l=he._animationClip,h=(l.name=he._strings[n.getUint16()],l._duration=n.getFloat32()),_=(l.islooping=!!n.getByte(),l._frameRate=n.getInt16(),n.getInt16()),u=l._nodes=new Array;u.length=_;(l._publicClipDatas=[]).length=_;for(var d=l._nodesMap={},c=0,f=0,e=0;e<_;e++){var m=u[e]=new me,p=n.getUint16(),E=m.path=[];for(E.length=p,t=0;t<p;t++)E[t]=he._strings[n.getUint16()];var g=E.join("/"),v=d[g],g=(v||(d[g]=v=[]),v.push(m),n.getInt16()),v=(-1!==g&&(m.componentType=he._strings[g]),de._propertyIndexDic[he._strings[n.getUint16()]]);if(null==v)throw new Error("AnimationClipParser02:unknown property name.");for(var g=v<4,g=!g||""===E[0],T=((m._cacheProperty=g)?c++:f++,m.propertyNameID=v,r[n.getUint8()]),S=(m.keyFrameWidth=T/4,m.keyFrames=[]),D=S.length=n.getUint16(),x=null,M=NaN,t=0;t<D;t++){var R=S[t]=new ce,M=R.startTime=o[n.getUint16()],I=n.pos;R.inTangent=new Float32Array(i.slice(I,I+T)),n.pos+=T,I=n.pos,R.outTangent=new Float32Array(i.slice(I,I+T)),n.pos+=T,I=n.pos,R.data=new Float32Array(i.slice(I,I+T)),n.pos+=T,x&&(x.next=R,x.duration=M-x.startTime),x=R}R.next=null,R.duration=h-M}var A=n.getUint16();for(e=0;e<A;e++){var C,y=new _e,O=(y.time=n.getFloat32(),y.eventName=he._strings[n.getUint16()],n.getUint16());for(0<O&&(y.params=C=[]),t=0;t<O;t++)switch(n.getByte()){case 0:C.push(!!n.getByte());break;case 1:C.push(n.getInt32());break;case 2:C.push(n.getFloat32());break;case 3:C.push(he._strings[n.getUint16()]);break;default:throw new Error("unknown type.")}l.addEvent(y)}var N=l._nodeToCachePropertyMap=new Int32Array(_),V=l._cachePropertyMap=new Int32Array(c),L=l._unCachePropertyMap=new Int32Array(f),c=f=0;for(e=0;e<_;e++)(m=u[e])._cacheProperty?(N[e]=c,V[c++]=e):L[f++]=e},he._animationClip=null,he._reader=null,he._strings=[],e(he,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]);var le=he;function he(){}t(ue,"laya.d3.animation.AnimationEvent");var _e=ue;function ue(){this.time=NaN,this.eventName=null,this.params=null}t(o,"laya.d3.animation.AnimationNode"),s=o.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.addChild=function(e){e._parent=this,e.transform.setParent(this.transform),this._childs.push(e)},s.removeChild=function(e){e=this._childs.indexOf(e);-1!==e&&this._childs.splice(e,1)},s.getChildByName=function(e){for(var t=0,n=this._childs.length;t<n;t++){var i=this._childs[t];if(i.name===e)return i}return null},s.getChildByIndex=function(e){return this._childs[e]},s.getChildCount=function(){return this._childs.length},s.cloneTo=function(e){var t=e;t.name=this.name;for(var n=0,i=this._childs.length;n<i;n++){var r=this._childs[n],a=r.clone(),r=(t.addChild(a),r.transform),a=a.transform;a.setLocalPosition(r.getLocalPosition()),a.setLocalRotation(r.getLocalRotation()),a.setLocalScale(r.getLocalScale()),a._localRotationEuler=r._localRotationEuler,a._setWorldMatrixIgnoreUpdate(r.getWorldMatrix())}},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},o.__init__=function(){o.registerAnimationNodeProperty("localPosition",o._getLocalPosition,o._setLocalPosition),o.registerAnimationNodeProperty("localRotation",o._getLocalRotation,o._setLocalRotation),o.registerAnimationNodeProperty("localScale",o._getLocalScale,o._setLocalScale),o.registerAnimationNodeProperty("localRotationEuler",o._getLocalRotationEuler,o._setLocalRotationEuler),o.registerAnimationNodeProperty("particleRender.sharedMaterial.tintColor",o._getParticleRenderSharedMaterialTintColor,o._setParticleRenderSharedMaterialTintColor),o.registerAnimationNodeProperty("meshRender.sharedMaterial.tilingOffset",o._getMeshRenderSharedMaterialTilingOffset,o._setMeshRenderSharedMaterialTilingOffset),o.registerAnimationNodeProperty("meshRender.sharedMaterial.albedoColor",o._getMeshRenderSharedMaterialAlbedo,o._setMeshRenderSharedMaterialAlbedo),o.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.tilingOffset",o._getSkinnedMeshRenderSharedMaterialTilingOffset,o._setSkinnedMeshRenderSharedMaterialTilingOffset),o.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedoColor",o._getSkinnedMeshRenderSharedMaterialAlbedo,o._setSkinnedMeshRenderSharedMaterialAlbedo),o.registerAnimationNodeProperty("meshRender.sharedMaterial.albedo",o._getMeshRenderSharedMaterialAlbedo,o._setMeshRenderSharedMaterialAlbedo),o.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedo",o._getSkinnedMeshRenderSharedMaterialAlbedo,o._setSkinnedMeshRenderSharedMaterialAlbedo),o.registerAnimationNodeProperty("meshRender.sharedMaterial.intensity",o._getMeshRenderSharedMaterialIntensity,o._setMeshRenderSharedMaterialIntensity),o.registerAnimationNodeProperty("meshRender.sharedMaterial.alpha",o._getMeshRenderSharedMaterialAlpha,o._setMeshRenderSharedMaterialAlpha),o.registerAnimationNodeProperty("meshRender.sharedMaterial.alphaColor",o._getMeshRenderSharedMaterialAlphaColor,o._setMeshRenderSharedMaterialAlphaColor),o.registerAnimationNodeProperty("meshRender.sharedMaterial.baseColor",o._getMeshRenderSharedMaterialBaseColor,o._setMeshRenderSharedMaterialBaseColor),o.registerAnimationNodeProperty("meshRender.sharedMaterial.dissolve",o._getMeshRenderSharedMaterialDissolve,o._setMeshRenderSharedMaterialDissolve),o.registerAnimationNodeProperty("meshRender.sharedMaterial.dissolveSpeed",o._getMeshRenderSharedMaterialDissolveSpeed,o._setMeshRenderSharedMaterialDissolveSpeed),o.registerAnimationNodeProperty("meshRender.sharedMaterial.mMultiplier",o._getMeshRenderSharedMaterialMMultiplier,o._setMeshRenderSharedMaterialMMultiplier),o.registerAnimationNodeProperty("meshRender.sharedMaterial.baseScrollSpeedX",o._getMeshRenderSharedMaterialBaseScrollSpeedX,o._setMeshRenderSharedMaterialBaseScrollSpeedX),o.registerAnimationNodeProperty("meshRender.sharedMaterial.baseScrollSpeedY",o._getMeshRenderSharedMaterialBaseScrollSpeedY,o._setMeshRenderSharedMaterialBaseScrollSpeedY),o.registerAnimationNodeProperty("meshRender.sharedMaterial.secondScrollSpeedX",o._getMeshRenderSharedMaterialSecondScrollSpeedX,o._setMeshRenderSharedMaterialSecondScrollSpeedX),o.registerAnimationNodeProperty("meshRender.sharedMaterial.secondScrollSpeedY",o._getMeshRenderSharedMaterialSecondScrollSpeedY,o._setMeshRenderSharedMaterialSecondScrollSpeedY),o.registerAnimationNodeProperty("meshRender.sharedMaterial.detailTilingOffset",o._getMeshRenderSharedMaterialDetailTilingOffset,o._setMeshRenderSharedMaterialDetailTilingOffset),o.registerAnimationNodeProperty("meshRender.sharedMaterial.dissolveTilingOffset",o._getMeshRenderSharedMaterialDissolveTilingOffset,o._setMeshRenderSharedMaterialDissolveTilingOffset),o.registerAnimationNodeProperty("meshRender.sharedMaterial.maskTilingOffset",o._getMeshRenderSharedMaterialMaskTilingOffset,o._setMeshRenderSharedMaterialMaskTilingOffset)},o.registerAnimationNodeProperty=function(e,t,n){if(o._propertyIndexDic[e])throw new Error("AnimationNode: this propertyName has registered.");o._propertyIndexDic[e]=o._propertyIDCounter,o._propertyGetFuncs[o._propertyIDCounter]=t,o._propertySetFuncs[o._propertyIDCounter]=n,o._propertyIDCounter++},o._getLocalPosition=function(e,t){return e?e.transform.getLocalPosition():t._transform.localPosition.elements},o._setLocalPosition=function(e,t,n){e?e.transform.setLocalPosition(n):((t=(e=t._transform).localPosition).elements=n,e.localPosition=t)},o._getLocalRotation=function(e,t){return e?e.transform.getLocalRotation():t._transform.localRotation.elements},o._setLocalRotation=function(e,t,n){e?e.transform.setLocalRotation(n):((t=(e=t._transform).localRotation).elements=n,e.localRotation=t)},o._getLocalScale=function(e,t){return e?e.transform.getLocalScale():t._transform.localScale.elements},o._setLocalScale=function(e,t,n){e?e.transform.setLocalScale(n):((t=(e=t._transform).localScale).elements=n,e.localScale=t)},o._getLocalRotationEuler=function(e,t){return e?e.transform.getLocalRotationEuler():t._transform.localRotationEuler.elements},o._setLocalRotationEuler=function(e,t,n){e?e.transform.setLocalRotationEuler(n):((t=(e=t._transform).localRotationEuler).elements=n,e.localRotationEuler=t)},o._getMeshRenderSharedMaterialTilingOffset=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.tilingOffset.elements:null:t.meshRender.sharedMaterial.tilingOffset.elements},o._setMeshRenderSharedMaterialTilingOffset=function(e,t,n){var i,r;e?(e=e.transform._entity)&&((r=(i=e.owner.meshRender.material).tilingOffset).elements=n,i.tilingOffset=r):((r=(i=t.meshRender.material).tilingOffset).elements=n,i.tilingOffset=r)},o._getMeshRenderSharedMaterialAlbedo=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.albedoColor.elements:null:t.meshRender.sharedMaterial.albedoColor.elements},o._setMeshRenderSharedMaterialAlbedo=function(e,t,n){var i,r;e?(e=e.transform._entity)&&((r=(i=e.owner.meshRender.material).albedoColor).elements=n,i.albedoColor=r):((r=(i=t.meshRender.material).albedoColor).elements=n,i.albedoColor=r)},o._getSkinnedMeshRenderSharedMaterialTilingOffset=function(e,t){return e?(e=e.transform._entity)?e.owner.skinnedMeshRender.sharedMaterial.tilingOffset.elements:null:t.skinnedMeshRender.sharedMaterial.tilingOffset.elements},o._setSkinnedMeshRenderSharedMaterialTilingOffset=function(e,t,n){var i,r;e?(e=e.transform._entity)&&((r=(i=e.owner.skinnedMeshRender.material).tilingOffset).elements=n,i.tilingOffset=r):((r=(i=t.skinnedMeshRender.material).tilingOffset).elements=n,i.tilingOffset=r)},o._getSkinnedMeshRenderSharedMaterialAlbedo=function(e,t){return e?(e=e.transform._entity)?e.owner.skinnedMeshRender.sharedMaterial.albedoColor.elements:null:t.skinnedMeshRender.sharedMaterial.albedoColor.elements},o._setSkinnedMeshRenderSharedMaterialAlbedo=function(e,t,n){var i,r;e?(e=e.transform._entity)&&((r=(i=e.owner.skinnedMeshRender.material).albedoColor).elements=n,i.albedoColor=r):((r=(i=t.skinnedMeshRender.material).albedoColor).elements=n,i.albedoColor=r)},o._getParticleRenderSharedMaterialTintColor=function(e,t){return e?(e=e.transform._entity)?e.owner.particleRender.sharedMaterial.tintColor.elements:null:t.particleRender.sharedMaterial.tintColor.elements},o._setParticleRenderSharedMaterialTintColor=function(e,t,n){var i,r;e?(e=e.transform._entity)&&((r=(i=e.owner.particleRender.material).tintColor).elements=n,i.tintColor=r):((r=(i=t.particleRender.material).tintColor).elements=n,i.tintColor=r)},o._getMeshRenderSharedMaterialAlphaColor=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.alphaColor.elements:null:t.meshRender.sharedMaterial.alphaColor.elements},o._setMeshRenderSharedMaterialAlphaColor=function(e,t,n){var i,r;e?(e=e.transform._entity)&&((r=(i=e.owner.meshRender.material).alphaColor).elements=n,i.alphaColor=r):((r=(i=t.meshRender.material).alphaColor).elements=n,i.alphaColor=r)},o._getMeshRenderSharedMaterialBaseColor=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.baseColor.elements:null:t.meshRender.sharedMaterial.baseColor.elements},o._setMeshRenderSharedMaterialBaseColor=function(e,t,n){var i,r;e?(e=e.transform._entity)&&((r=(i=e.owner.meshRender.material).baseColor).elements=n,i.baseColor=r):((r=(i=t.meshRender.material).baseColor).elements=n,i.baseColor=r)},o._getMeshRenderSharedMaterialDissolve=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.dissolve:0:t.meshRender.sharedMaterial.dissolve},o._setMeshRenderSharedMaterialDissolve=function(e,t,n){e?(e=e.transform._entity)&&(e.owner.meshRender.material.dissolve=n[0]):t.meshRender.material.dissolve=n[0]},o._getMeshRenderSharedMaterialDissolveSpeed=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.dissolveSpeed:0:t.meshRender.sharedMaterial.dissolveSpeed},o._setMeshRenderSharedMaterialDissolveSpeed=function(e,t,n){e?(e=e.transform._entity)&&(e.owner.meshRender.material.dissolveSpeed=n[0]):t.meshRender.material.dissolveSpeed=n[0]},o._getMeshRenderSharedMaterialMMultiplier=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.mMultiplier:0:t.meshRender.sharedMaterial.mMultiplier},o._setMeshRenderSharedMaterialMMultiplier=function(e,t,n){e?(e=e.transform._entity)&&(e.owner.meshRender.material.mMultiplier=n[0]):t.meshRender.material.mMultiplier=n[0]},o._getMeshRenderSharedMaterialBaseScrollSpeedX=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.baseScrollSpeedX:0:t.meshRender.sharedMaterial.baseScrollSpeedX},o._setMeshRenderSharedMaterialBaseScrollSpeedX=function(e,t,n){e?(e=e.transform._entity)&&(e.owner.meshRender.material.baseScrollSpeedX=n[0]):t.meshRender.material.baseScrollSpeedX=n[0]},o._getMeshRenderSharedMaterialBaseScrollSpeedY=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.baseScrollSpeedY:0:t.meshRender.sharedMaterial.baseScrollSpeedY},o._setMeshRenderSharedMaterialBaseScrollSpeedY=function(e,t,n){e?(e=e.transform._entity)&&(e.owner.meshRender.material.baseScrollSpeedY=n[0]):t.meshRender.material.baseScrollSpeedY=n[0]},o._getMeshRenderSharedMaterialSecondScrollSpeedX=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.secondScrollSpeedX:0:t.meshRender.sharedMaterial.secondScrollSpeedX},o._setMeshRenderSharedMaterialSecondScrollSpeedX=function(e,t,n){e?(e=e.transform._entity)&&(e.owner.meshRender.material.secondScrollSpeedX=n[0]):t.meshRender.material.secondScrollSpeedX=n[0]},o._getMeshRenderSharedMaterialSecondScrollSpeedY=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.secondScrollSpeedY:0:t.meshRender.sharedMaterial.secondScrollSpeedY},o._setMeshRenderSharedMaterialSecondScrollSpeedY=function(e,t,n){e?(e=e.transform._entity)&&(e.owner.meshRender.material.secondScrollSpeedY=n[0]):t.meshRender.material.secondScrollSpeedY=n[0]},o._getMeshRenderSharedMaterialAlpha=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.alpha:0:t.meshRender.sharedMaterial.alpha},o._setMeshRenderSharedMaterialAlpha=function(e,t,n){e?(e=e.transform._entity)&&(e.owner.meshRender.material.alpha=n[0]):t.meshRender.material.alpha=n[0]},o._getMeshRenderSharedMaterialIntensity=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.intensity:0:t.meshRender.sharedMaterial.intensity},o._setMeshRenderSharedMaterialIntensity=function(e,t,n){e?(e=e.transform._entity)&&(e.owner.meshRender.material.intensity=n[0]):t.meshRender.material.intensity=n[0]},o._getMeshRenderSharedMaterialDetailTilingOffset=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.detailTilingOffset.elements:null:t.meshRender.sharedMaterial.detailTilingOffset.elements},o._setMeshRenderSharedMaterialDetailTilingOffset=function(e,t,n){var i,r;e?(e=e.transform._entity)&&((r=(i=e.owner.meshRender.material).detailTilingOffset).elements=n,i.detailTilingOffset=r):((r=(i=t.meshRender.material).detailTilingOffset).elements=n,i.detailTilingOffset=r)},o._getMeshRenderSharedMaterialDissolveTilingOffset=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.dissolveTilingOffset.elements:null:t.meshRender.sharedMaterial.dissolveTilingOffset.elements},o._setMeshRenderSharedMaterialDissolveTilingOffset=function(e,t,n){var i,r;e?(e=e.transform._entity)&&((r=(i=e.owner.meshRender.material).dissolveTilingOffset).elements=n,i.dissolveTilingOffset=r):((r=(i=t.meshRender.material).dissolveTilingOffset).elements=n,i.dissolveTilingOffset=r)},o._getMeshRenderSharedMaterialMaskTilingOffset=function(e,t){return e?(e=e.transform._entity)?e.owner.meshRender.sharedMaterial.maskTilingOffset.elements:null:t.meshRender.sharedMaterial.maskTilingOffset.elements},o._setMeshRenderSharedMaterialMaskTilingOffset=function(e,t,n){var i,r;e?(e=e.transform._entity)&&((r=(i=e.owner.meshRender.material).maskTilingOffset).elements=n,i.maskTilingOffset=r):((r=(i=t.meshRender.material).maskTilingOffset).elements=n,i.maskTilingOffset=r)},o._propertyIDCounter=0,o._propertyIndexDic={},o._propertySetFuncs=[],o._propertyGetFuncs=[];var de=o;function o(){this._childs=[],this.transform=new Hr(this)}t(fe,"laya.d3.animation.Keyframe");var ce=fe;function fe(){this.startTime=NaN,this.inTangent=null,this.outTangent=null,this.data=null,this.duration=NaN,this.next=null}t(pe,"laya.d3.animation.KeyframeNode");var me=pe;function pe(){this._cacheProperty=!1,this.path=null,this.componentType=null,this.propertyNameID=0,this.keyFrameWidth=0,this.defaultData=null,this.keyFrames=null}t(ge,"laya.d3.core.glitter.SplineCurvePositionVelocity"),(s=ge.prototype).Init=function(e,t,n,i){e.cloneTo(this._d),t.cloneTo(this._c),W.scale(e,2,this._a),W.scale(n,2,this._tempVector30),W.subtract(this._a,this._tempVector30,this._a),W.add(this._a,t,this._a),W.add(this._a,i,this._a),W.scale(n,3,this._b),W.scale(e,3,this._tempVector30),W.subtract(this._b,this._tempVector30,this._b),W.subtract(this._b,i,this._b),W.scale(t,2,this._tempVector30),W.subtract(this._b,this._tempVector30,this._b)},s.Slerp=function(e,t){W.scale(this._a,e*e*e,this._tempVector30),W.scale(this._b,e*e,this._tempVector31),W.scale(this._c,e,this._tempVector32),W.add(this._tempVector30,this._tempVector31,t),W.add(t,this._tempVector32,t),W.add(t,this._d,t)};var Ee=ge;function ge(){this._tempVector30=new W,this._tempVector31=new W,this._tempVector32=new W,this._a=new W,this._b=new W,this._c=new W,this._d=new W}t(Te,"laya.d3.core.HeightMap"),(s=Te.prototype)._inBounds=function(e,t){return 0<=e&&e<this._h&&0<=t&&t<this._w},s.getHeight=function(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN},n(0,s,"width",function(){return this._w}),n(0,s,"height",function(){return this._h}),n(0,s,"maxHeight",function(){return this._maxHeight}),n(0,s,"minHeight",function(){return this._minHeight}),Te.creatFromMesh=function(e,t,n,i){for(var r=[],a=[],o=e.getSubMeshCount(),s=0;s<o;s++){for(var l=e.getSubMesh(s),h=l._getVertexBuffer(),_=h.getData(),u=[],d=0;d<_.length;d+=h.vertexDeclaration.vertexStride/4){var c=new W(_[d+0],_[d+1],_[d+2]);u.push(c)}r.push(u);l=l._getIndexBuffer();a.push(l.getData())}var f=e.boundingBox,m=f.min.x,p=f.min.z,E=f.max.x,g=f.max.z,v=f.min.y,f=f.max.y,g=g-p,T=i.elements[0]=(E-m)/(t-1),S=i.elements[1]=g/(n-1),D=new Te(t,n,v,f),x=Te._tempRay,E=x.direction.elements,M=(E[0]=0,E[1]=-1,E[2]=0,f+.1);x.origin.elements[1]=M;for(var R=0;R<n;R++){var I=p+R*S;D._datas[R]=[];for(var A=0;A<t;A++){var C=x.origin.elements,C=(C[0]=m+A*T,C[2]=I,Te._getPosition(x,r,a));D._datas[R][A]=C===Number.MAX_VALUE?NaN:M-C}}return D},Te.createFromImage=function(e,t,n){for(var i=e.width,r=e.height,a=new Te(i,r,t,n),o=(n-t)/254,s=e.getPixels(),l=0,h=0;h<r;h++)for(var _=a._datas[h]=[],u=0;u<i;u++){var d=s[l++],c=s[l++],f=s[l++],m=s[l++];_[u]=255==d&&255==c&&255==f&&255==m?NaN:(d+c+f)/3*o+t}return a},Te._getPosition=function(e,t,n){for(var i=Number.MAX_VALUE,r=0;r<t.length;r++)for(var a=t[r],o=n[r],s=0;s<o.length;s+=3){var l=a[o[s+0]],h=a[o[s+1]],_=a[o[s+2]],l=Nr.rayIntersectsTriangle(e,l,h,_);!isNaN(l)&&l<i&&(i=l)}return i},e(Te,["_tempRay",function(){return this._tempRay=new ir(new W,new W)}]);var ve=Te;function Te(e,t,n,i){this._datas=null,this._w=0,this._h=0,this._minHeight=NaN,this._maxHeight=NaN,this._datas=[],this._w=e,this._h=t,this._minHeight=n,this._maxHeight=i}t(De,"laya.d3.core.Layer"),(s=De.prototype)._binarySearchIndex=function(){for(var e=0,t=De._collsionTestList.length-1;e<=t;){var n=Math.floor((e+t)/2),i=De._collsionTestList[n];if(i==this._number)return n;i>this._number?t=n-1:e=n+1}return e},s._addCollider=function(e){0===this._colliders.length&&De._collsionTestList.splice(this._binarySearchIndex(),0,this._number),e._isRigidbody?(this._colliders.unshift(e),this._nonRigidbodyOffset++):this._colliders.push(e)},s._removeCollider=function(e){e=this._colliders.indexOf(e);e<this._nonRigidbodyOffset&&this._nonRigidbodyOffset--,this._colliders.splice(e,1),0===this._colliders.length&&De._collsionTestList.splice(De._collsionTestList.indexOf(this._number),1)},n(0,s,"number",function(){return this._number}),n(0,s,"visible",function(){return this._visible},function(e){this._visible=e,De._visibleLayers=e?De._visibleLayers|this.mask:De._visibleLayers&~this.mask}),n(0,s,"mask",function(){return this._mask}),n(1,De,"visibleLayers",function(){return De._visibleLayers},function(e){De._visibleLayers=e;for(var t=0,n=De._layerList.length;t<n;t++){var i=De._layerList[t];i._visible=0!=(i._mask&De._visibleLayers)}}),De.__init__=function(){De._layerList.length=31;for(var e=0;e<31;e++){var t=new De;De._layerList[e]=t,0===e?(t.name="Default Layer",t.visible=!0):(t.name="Layer-"+e,t.visible=!1),t._number=e,t._mask=Math.pow(2,e)}De.currentCreationLayer=De._layerList[0]},De.getLayerByNumber=function(e){if(e<0||30<e)throw new Error("无法返回指定Layer，该number超出范围！");return De._layerList[e]},De.getLayerByName=function(e){for(var t=0;t<31;t++)if(De._layerList[t].name===e)return De._layerList[t];throw new Error("无法返回指定Layer,该name不存在")},De.isVisible=function(e){return 0!=(e&De._currentCameraCullingMask&De._visibleLayers)},De._layerList=[],De._visibleLayers=2147483647,De._collsionTestList=[],De._currentCameraCullingMask=2147483647,De.maxCount=31,De.currentCreationLayer=null;var Se=De;function De(){this._visible=!0,this._nonRigidbodyOffset=0,this._colliders=[]}t(Me,"laya.d3.core.particleShuriKen.module.Burst"),s=Me.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.cloneTo=function(e){e._time=this._time,e._minCount=this._minCount,e._maxCount=this._maxCount},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"time",function(){return this._time}),n(0,s,"minCount",function(){return this._minCount}),n(0,s,"maxCount",function(){return this._maxCount});var xe=Me;function Me(e,t,n){this._time=NaN,this._minCount=0,this._maxCount=0,this._time=e,this._minCount=t,this._maxCount=n}t(Ie,"laya.d3.core.particleShuriKen.module.ColorOverLifetime"),(s=Ie.prototype).cloneTo=function(e){this._color.cloneTo(e._color),e.enbale=this.enbale},s.clone=function(){var e;switch(this._color.type){case 0:e=Le.createByConstant(this._color.constant.clone());break;case 1:e=Le.createByGradient(this._color.gradient.clone());break;case 2:e=Le.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:e=Le.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},n(0,s,"color",function(){return this._color});var Re=Ie;function Ie(e){this._color=null,this.enbale=!1,this._color=e}t(Ce,"laya.d3.core.particleShuriKen.module.Emission"),s=Ce.prototype,v.imps(s,{"laya.d3.core.IClone":!0,"laya.resource.IDestroy":!0}),s._destroy=function(){this._bursts=null,this._destroyed=!0},s.getBurstsCount=function(){return this._bursts.length},s.getBurstByIndex=function(e){return this._bursts[e]},s.addBurst=function(e){var t=this._bursts.length;if(0<t)for(var n=0;n<t;n++)this._bursts[n].time>e.time&&this._bursts.splice(n,0,e);this._bursts.push(e)},s.removeBurst=function(e){e=this._bursts.indexOf(e);-1!==e&&this._bursts.splice(e,1)},s.removeBurstByIndex=function(e){this._bursts.splice(e,1)},s.clearBurst=function(){this._bursts.length=0},s.cloneTo=function(e){var t=e._bursts;t.length=this._bursts.length;for(var n=0,i=this._bursts.length;n<i;n++){var r=t[n];r?this._bursts[n].cloneTo(r):t[n]=this._bursts[n].clone()}e._emissionRate=this._emissionRate,e.enbale=this.enbale},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"destroyed",function(){return this._destroyed}),n(0,s,"emissionRate",function(){return this._emissionRate},function(e){if(e<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=e});var Ae=Ce;function Ce(){this._destroyed=!1,this._emissionRate=0,this._bursts=null,this.enbale=!1,this._destroyed=!1,this.emissionRate=10,this._bursts=[]}t(Oe,"laya.d3.core.particleShuriKen.module.FrameOverTime"),s=Oe.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.cloneTo=function(e){e._type=this._type,e._constant=this._constant,this._overTime.cloneTo(e._overTime),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._overTimeMin.cloneTo(e._overTimeMin),this._overTimeMax.cloneTo(e._overTimeMax)},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"frameOverTimeData",function(){return this._overTime}),n(0,s,"constant",function(){return this._constant}),n(0,s,"type",function(){return this._type}),n(0,s,"frameOverTimeDataMin",function(){return this._overTimeMin}),n(0,s,"constantMin",function(){return this._constantMin}),n(0,s,"frameOverTimeDataMax",function(){return this._overTimeMax}),n(0,s,"constantMax",function(){return this._constantMax}),Oe.createByConstant=function(e){var t=new Oe;return t._type=0,t._constant=e,t},Oe.createByOverTime=function(e){var t=new Oe;return t._type=1,t._overTime=e,t},Oe.createByRandomTwoConstant=function(e,t){var n=new Oe;return n._type=2,n._constantMin=e,n._constantMax=t,n},Oe.createByRandomTwoOverTime=function(e,t){var n=new Oe;return n._type=3,n._overTimeMin=e,n._overTimeMax=t,n};var ye=Oe;function Oe(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}t(Ve,"laya.d3.core.particleShuriKen.module.GradientAngularVelocity"),s=Ve.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.cloneTo=function(e){e._type=this._type,e._separateAxes=this._separateAxes,e._constant=this._constant,this._constantSeparate.cloneTo(e._constantSeparate),this._gradient.cloneTo(e._gradient),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(e._constantMinSeparate),this._constantMaxSeparate.cloneTo(e._constantMaxSeparate),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"gradientZ",function(){return this._gradientZ}),n(0,s,"constant",function(){return this._constant}),n(0,s,"gradient",function(){return this._gradient}),n(0,s,"separateAxes",function(){return this._separateAxes}),n(0,s,"type",function(){return this._type}),n(0,s,"constantSeparate",function(){return this._constantSeparate}),n(0,s,"gradientX",function(){return this._gradientX}),n(0,s,"gradientY",function(){return this._gradientY}),n(0,s,"gradientW",function(){return this._gradientW}),n(0,s,"gradientMin",function(){return this._gradientMin}),n(0,s,"constantMin",function(){return this._constantMin}),n(0,s,"gradientMax",function(){return this._gradientMax}),n(0,s,"constantMax",function(){return this._constantMax}),n(0,s,"gradientWMin",function(){return this._gradientWMin}),n(0,s,"constantMinSeparate",function(){return this._constantMinSeparate}),n(0,s,"constantMaxSeparate",function(){return this._constantMaxSeparate}),n(0,s,"gradientXMin",function(){return this._gradientXMin}),n(0,s,"gradientXMax",function(){return this._gradientXMax}),n(0,s,"gradientWMax",function(){return this._gradientWMax}),n(0,s,"gradientYMin",function(){return this._gradientYMin}),n(0,s,"gradientYMax",function(){return this._gradientYMax}),n(0,s,"gradientZMin",function(){return this._gradientZMin}),n(0,s,"gradientZMax",function(){return this._gradientZMax}),Ve.createByConstant=function(e){var t=new Ve;return t._type=0,t._separateAxes=!1,t._constant=e,t},Ve.createByConstantSeparate=function(e){var t=new Ve;return t._type=0,t._separateAxes=!0,t._constantSeparate=e,t},Ve.createByGradient=function(e){var t=new Ve;return t._type=1,t._separateAxes=!1,t._gradient=e,t},Ve.createByGradientSeparate=function(e,t,n,i){var r=new Ve;return r._type=1,r._separateAxes=!0,r._gradientX=e,r._gradientY=t,r._gradientZ=n,r._gradientW=i,r},Ve.createByRandomTwoConstant=function(e,t){var n=new Ve;return n._type=2,n._separateAxes=!1,n._constantMin=e,n._constantMax=t,n},Ve.createByRandomTwoConstantSeparate=function(e,t){var n=new Ve;return n._type=2,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=t,n},Ve.createByRandomTwoGradient=function(e,t){var n=new Ve;return n._type=3,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=t,n},Ve.createByRandomTwoGradientSeparate=function(e,t,n,i,r,a,o,s){var l=new Ve;return l._type=3,l._separateAxes=!0,l._gradientXMin=e,l._gradientXMax=t,l._gradientYMin=n,l._gradientYMax=i,l._gradientZMin=r,l._gradientZMax=a,l._gradientWMin=o,l._gradientWMax=s,l};var Ne=Ve;function Ve(){this._type=0,this._separateAxes=!1,this._constant=NaN,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}t(we,"laya.d3.core.particleShuriKen.module.GradientColor"),s=we.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.cloneTo=function(e){e._type=this._type,this._constant.cloneTo(e._constant),this._constantMin.cloneTo(e._constantMin),this._constantMax.cloneTo(e._constantMax),this._gradient.cloneTo(e._gradient),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax)},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"gradient",function(){return this._gradient}),n(0,s,"constant",function(){return this._constant}),n(0,s,"type",function(){return this._type}),n(0,s,"gradientMin",function(){return this._gradientMin}),n(0,s,"constantMin",function(){return this._constantMin}),n(0,s,"gradientMax",function(){return this._gradientMax}),n(0,s,"constantMax",function(){return this._constantMax}),we.createByConstant=function(e){var t=new we;return t._type=0,t._constant=e,t},we.createByGradient=function(e){var t=new we;return t._type=1,t._gradient=e,t},we.createByRandomTwoConstant=function(e,t){var n=new we;return n._type=2,n._constantMin=e,n._constantMax=t,n},we.createByRandomTwoGradient=function(e,t){var n=new we;return n._type=3,n._gradientMin=e,n._gradientMax=t,n};var Le=we;function we(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}t(Pe,"laya.d3.core.particleShuriKen.module.GradientDataColor"),s=Pe.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.addAlpha=function(e,t){this._alphaCurrentLength<8?(6===this._alphaCurrentLength&&1!==e&&(e=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._alphaElements[this._alphaCurrentLength++]=e,this._alphaElements[this._alphaCurrentLength++]=t):console.log("GradientDataColor warning:data count must lessEqual than 4")},s.addRGB=function(e,t){this._rgbCurrentLength<16?(12===this._rgbCurrentLength&&1!==e&&(e=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._rgbElements[this._rgbCurrentLength++]=e,this._rgbElements[this._rgbCurrentLength++]=t.x,this._rgbElements[this._rgbCurrentLength++]=t.y,this._rgbElements[this._rgbCurrentLength++]=t.z):console.log("GradientDataColor warning:data count must lessEqual than 4")},s.cloneTo=function(e){var t=0,n=0,i=(e._alphaCurrentLength=this._alphaCurrentLength,e._alphaElements);for(i.length=this._alphaElements.length,t=0,n=this._alphaElements.length;t<n;t++)i[t]=this._alphaElements[t];e._rgbCurrentLength=this._rgbCurrentLength;var r=e._rgbElements;for(r.length=this._rgbElements.length,t=0,n=this._rgbElements.length;t<n;t++)r[t]=this._rgbElements[t]},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"alphaGradientCount",function(){return this._alphaCurrentLength/2}),n(0,s,"rgbGradientCount",function(){return this._rgbCurrentLength/4});var Fe=Pe;function Pe(){this._alphaCurrentLength=0,this._rgbCurrentLength=0,this._alphaElements=null,this._rgbElements=null,this._alphaElements=new Float32Array(8),this._rgbElements=new Float32Array(16)}t(Be,"laya.d3.core.particleShuriKen.module.GradientDataInt"),s=Be.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.add=function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("Warning:data count must lessEqual than 4")},s.cloneTo=function(e){e._currentLength=this._currentLength;var t=e._elements;t.length=this._elements.length;for(var n=0,i=this._elements.length;n<i;n++)t[n]=this._elements[n]},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"gradientCount",function(){return this._currentLength/2});var be=Be;function Be(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}t(He,"laya.d3.core.particleShuriKen.module.GradientDataNumber"),s=He.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.add=function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("GradientDataNumber warning:data count must lessEqual than 4")},s.getKeyByIndex=function(e){return this._elements[2*e]},s.getValueByIndex=function(e){return this._elements[2*e+1]},s.getAverageValue=function(){for(var e=0,t=this._currentLength-2;e<t;e+=2){var n=this._elements[e+1];n+=this._elements[e+3],this._elements[e+2],this._elements[e]}return 0},s.cloneTo=function(e){e._currentLength=this._currentLength;var t=e._elements;t.length=this._elements.length;for(var n=0,i=this._elements.length;n<i;n++)t[n]=this._elements[n]},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"gradientCount",function(){return this._currentLength/2});var Ue=He;function He(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}t(Ge,"laya.d3.core.particleShuriKen.module.GradientDataVector2"),s=Ge.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.add=function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t.x,this._elements[this._currentLength++]=t.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")},s.cloneTo=function(e){e._currentLength=this._currentLength;var t=e._elements;t.length=this._elements.length;for(var n=0,i=this._elements.length;n<i;n++)t[n]=this._elements[n]},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"gradientCount",function(){return this._currentLength/3});function Ge(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(12)}t(We,"laya.d3.core.particleShuriKen.module.GradientSize"),s=We.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.getMaxSizeInGradient=function(){var e=0,t=0,n=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(e=0,t=this._gradientX.gradientCount;e<t;e++)n=Math.max(n,this._gradientX.getValueByIndex(e));for(e=0,t=this._gradientY.gradientCount;e<t;e++)n=Math.max(n,this._gradientY.getValueByIndex(e))}else for(e=0,t=this._gradient.gradientCount;e<t;e++)n=Math.max(n,this._gradient.getValueByIndex(e));break;case 1:n=this._separateAxes?(n=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),n=Math.max(n,this._constantMinSeparate.y),Math.max(n,this._constantMaxSeparate.y)):Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(e=0,t=this._gradientXMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientXMin.getValueByIndex(e));for(e=0,t=this._gradientXMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientXMax.getValueByIndex(e));for(e=0,t=this._gradientYMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientYMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientZMax.getValueByIndex(e))}else{for(e=0,t=this._gradientMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientMin.getValueByIndex(e));for(e=0,t=this._gradientMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientMax.getValueByIndex(e))}}return n},s.cloneTo=function(e){e._type=this._type,e._separateAxes=this._separateAxes,this._gradient.cloneTo(e._gradient),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(e._constantMinSeparate),this._constantMaxSeparate.cloneTo(e._constantMaxSeparate),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"gradientZ",function(){return this._gradientZ}),n(0,s,"gradient",function(){return this._gradient}),n(0,s,"separateAxes",function(){return this._separateAxes}),n(0,s,"type",function(){return this._type}),n(0,s,"gradientMin",function(){return this._gradientMin}),n(0,s,"constantMin",function(){return this._constantMin}),n(0,s,"gradientX",function(){return this._gradientX}),n(0,s,"gradientY",function(){return this._gradientY}),n(0,s,"gradientMax",function(){return this._gradientMax}),n(0,s,"constantMax",function(){return this._constantMax}),n(0,s,"constantMinSeparate",function(){return this._constantMinSeparate}),n(0,s,"constantMaxSeparate",function(){return this._constantMaxSeparate}),n(0,s,"gradientXMin",function(){return this._gradientXMin}),n(0,s,"gradientXMax",function(){return this._gradientXMax}),n(0,s,"gradientYMin",function(){return this._gradientYMin}),n(0,s,"gradientYMax",function(){return this._gradientYMax}),n(0,s,"gradientZMin",function(){return this._gradientZMin}),n(0,s,"gradientZMax",function(){return this._gradientZMax}),We.createByGradient=function(e){var t=new We;return t._type=0,t._separateAxes=!1,t._gradient=e,t},We.createByGradientSeparate=function(e,t,n){var i=new We;return i._type=0,i._separateAxes=!0,i._gradientX=e,i._gradientY=t,i._gradientZ=n,i},We.createByRandomTwoConstant=function(e,t){var n=new We;return n._type=1,n._separateAxes=!1,n._constantMin=e,n._constantMax=t,n},We.createByRandomTwoConstantSeparate=function(e,t){var n=new We;return n._type=1,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=t,n},We.createByRandomTwoGradient=function(e,t){var n=new We;return n._type=2,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=t,n},We.createByRandomTwoGradientSeparate=function(e,t,n,i,r,a){var o=new We;return o._type=2,o._separateAxes=!0,o._gradientXMin=e,o._gradientXMax=t,o._gradientYMin=n,o._gradientYMax=i,o._gradientZMin=r,o._gradientZMax=a,o};var ze=We;function We(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}t(Xe,"laya.d3.core.particleShuriKen.module.GradientVelocity"),s=Xe.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.cloneTo=function(e){e._type=this._type,this._constant.cloneTo(e._constant),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),this._constantMin.cloneTo(e._constantMin),this._constantMax.cloneTo(e._constantMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"gradientZ",function(){return this._gradientZ}),n(0,s,"constant",function(){return this._constant}),n(0,s,"type",function(){return this._type}),n(0,s,"gradientXMax",function(){return this._gradientXMax}),n(0,s,"constantMin",function(){return this._constantMin}),n(0,s,"gradientX",function(){return this._gradientX}),n(0,s,"gradientY",function(){return this._gradientY}),n(0,s,"gradientXMin",function(){return this._gradientXMin}),n(0,s,"constantMax",function(){return this._constantMax}),n(0,s,"gradientYMin",function(){return this._gradientYMin}),n(0,s,"gradientYMax",function(){return this._gradientYMax}),n(0,s,"gradientZMin",function(){return this._gradientZMin}),n(0,s,"gradientZMax",function(){return this._gradientZMax}),Xe.createByConstant=function(e){var t=new Xe;return t._type=0,t._constant=e,t},Xe.createByGradient=function(e,t,n){var i=new Xe;return i._type=1,i._gradientX=e,i._gradientY=t,i._gradientZ=n,i},Xe.createByRandomTwoConstant=function(e,t){var n=new Xe;return n._type=2,n._constantMin=e,n._constantMax=t,n},Xe.createByRandomTwoGradient=function(e,t,n,i,r,a){var o=new Xe;return o._type=3,o._gradientXMin=e,o._gradientXMax=t,o._gradientYMin=n,o._gradientYMax=i,o._gradientZMin=r,o._gradientZMax=a,o};var ke=Xe;function Xe(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}t(Ze,"laya.d3.core.particleShuriKen.module.RotationOverLifetime"),s=Ze.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s.cloneTo=function(e){this._angularVelocity.cloneTo(e._angularVelocity),e.enbale=this.enbale},s.clone=function(){var e;switch(this._angularVelocity.type){case 0:e=this._angularVelocity.separateAxes?Ne.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):Ne.createByConstant(this._angularVelocity.constant);break;case 1:e=this._angularVelocity.separateAxes?Ne.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone(),this._angularVelocity.gradientW.clone()):Ne.createByGradient(this._angularVelocity.gradient.clone());break;case 2:e=this._angularVelocity.separateAxes?Ne.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):Ne.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:e=this._angularVelocity.separateAxes?Ne.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):Ne.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},n(0,s,"angularVelocity",function(){return this._angularVelocity});var Ye=Ze;function Ze(e){this._angularVelocity=null,this.enbale=!1,this._angularVelocity=e}t(je,"laya.d3.core.particleShuriKen.module.shape.BaseShape"),s=je.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s._getShapeBoundBox=function(e){throw new Error("BaseShape: must override it.")},s._getSpeedBoundBox=function(e){throw new Error("BaseShape: must override it.")},s.generatePositionAndDirection=function(e,t,n,i){throw new Error("BaseShape: must override it.")},s._calculateProceduralBounds=function(e,t,n){this._getShapeBoundBox(e);var i=e.min,r=e.max,i=(W.multiply(i,t,i),W.multiply(r,t,r),new bi(new W,new W)),t=(this.randomDirection?(i.min=new W(-1,-1,-1),i.max=new W(1,1,1)):this._getSpeedBoundBox(i),new bi(new W,new W)),r=t.min,t=t.max,a=(W.scale(i.min,n.y,r),W.scale(i.max,n.y,t),W.add(e.min,r,r),W.add(e.max,t,t),W.min(e.min,r,e.min),W.max(e.max,r,e.max),new bi(new W,new W)),o=a.min,s=a.max;W.scale(i.min,n.x,o),W.scale(i.max,n.x,s),W.min(a.min,s,r),W.max(a.min,s,t),W.min(e.min,r,e.min),W.max(e.max,r,e.max)},s.cloneTo=function(e){e.enable=this.enable},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e};var s=je;function je(){this.enable=!1,this.randomDirection=!1}t(qe,"laya.d3.core.particleShuriKen.module.shape.ShapeUtils"),qe._randomPointUnitArcCircle=function(e,t,n){var t=t.elements,i=NaN,i=n?n.getFloat()*e:Math.random()*e;t[0]=Math.cos(i),t[1]=Math.sin(i)},qe._randomPointInsideUnitArcCircle=function(e,t,n){var i=t.elements,e=(qe._randomPointUnitArcCircle(e,t,n),NaN),e=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5);i[0]=i[0]*e,i[1]=i[1]*e},qe._randomPointUnitCircle=function(e,t){var e=e.elements,n=NaN,n=t?t.getFloat()*Math.PI*2:Math.random()*Math.PI*2;e[0]=Math.cos(n),e[1]=Math.sin(n)},qe._randomPointInsideUnitCircle=function(e,t){var n=e.elements,e=(qe._randomPointUnitCircle(e),NaN),e=t?Math.pow(t.getFloat(),.5):Math.pow(Math.random(),.5);n[0]=n[0]*e,n[1]=n[1]*e},qe._randomPointUnitSphere=function(e,t){var e=e.elements,n=NaN,i=NaN,i=t?(n=e[2]=2*t.getFloat()-1,t.getFloat()*Math.PI*2):(n=e[2]=2*Math.random()-1,Math.random()*Math.PI*2),t=Math.sqrt(1-n*n);e[0]=t*Math.cos(i),e[1]=t*Math.sin(i)},qe._randomPointInsideUnitSphere=function(e,t){var n=e.elements,e=(qe._randomPointUnitSphere(e),NaN),e=t?Math.pow(t.getFloat(),1/3):Math.pow(Math.random(),1/3);n[0]=n[0]*e,n[1]=n[1]*e,n[2]=n[2]*e},qe._randomPointInsideHalfUnitBox=function(e,t){e=e.elements;t?(e[0]=t.getFloat()-.5,e[1]=t.getFloat()-.5,e[2]=t.getFloat()-.5):(e[0]=Math.random()-.5,e[1]=Math.random()-.5,e[2]=Math.random()-.5)};var Ke=qe;function qe(){}t($e,"laya.d3.core.particleShuriKen.module.SizeOverLifetime"),l=$e.prototype,v.imps(l,{"laya.d3.core.IClone":!0}),l.cloneTo=function(e){this._size.cloneTo(e._size),e.enbale=this.enbale},l.clone=function(){var e;switch(this._size.type){case 0:e=this._size.separateAxes?ze.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):ze.createByGradient(this._size.gradient.clone());break;case 1:e=this._size.separateAxes?ze.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):ze.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:e=this._size.separateAxes?ze.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):ze.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},n(0,l,"size",function(){return this._size});var Qe=$e;function $e(e){this._size=null,this.enbale=!1,this._size=e}t(et,"laya.d3.core.particleShuriKen.module.StartFrame"),l=et.prototype,v.imps(l,{"laya.d3.core.IClone":!0}),l.cloneTo=function(e){e._type=this._type,e._constant=this._constant,e._constantMin=this._constantMin,e._constantMax=this._constantMax},l.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,l,"constant",function(){return this._constant}),n(0,l,"type",function(){return this._type}),n(0,l,"constantMin",function(){return this._constantMin}),n(0,l,"constantMax",function(){return this._constantMax}),et.createByConstant=function(e){var t=new et;return t._type=0,t._constant=e,t},et.createByRandomTwoConstant=function(e,t){var n=new et;return n._type=1,n._constantMin=e,n._constantMax=t,n};var Je=et;function et(){this._type=0,this._constant=NaN,this._constantMin=NaN,this._constantMax=NaN}t(nt,"laya.d3.core.particleShuriKen.module.TextureSheetAnimation"),l=nt.prototype,v.imps(l,{"laya.d3.core.IClone":!0}),l.cloneTo=function(e){this.tiles.cloneTo(e.tiles),e.type=this.type,e.randomRow=this.randomRow,this._frame.cloneTo(e._frame),this._startFrame.cloneTo(e._startFrame),e.cycles=this.cycles,e.enableUVChannels=this.enableUVChannels,e.enable=this.enable},l.clone=function(){var e,t;switch(this._frame.type){case 0:e=ye.createByConstant(this._frame.constant);break;case 1:e=ye.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:e=ye.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:e=ye.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}switch(this._startFrame.type){case 0:t=Je.createByConstant(this._startFrame.constant);break;case 1:t=Je.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var n=new this.constructor(e,t);return this.tiles.cloneTo(n.tiles),n.type=this.type,n.randomRow=this.randomRow,n.cycles=this.cycles,n.enableUVChannels=this.enableUVChannels,n.enable=this.enable,n},n(0,l,"frame",function(){return this._frame}),n(0,l,"startFrame",function(){return this._startFrame});var tt=nt;function nt(e,t){this._frame=null,this._startFrame=null,this.tiles=null,this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new ar(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=e,this._startFrame=t}t(rt,"laya.d3.core.particleShuriKen.module.VelocityOverLifetime"),l=rt.prototype,v.imps(l,{"laya.d3.core.IClone":!0}),l.cloneTo=function(e){this._velocity.cloneTo(e._velocity),e.enbale=this.enbale,e.space=this.space},l.clone=function(){var e;switch(this._velocity.type){case 0:e=ke.createByConstant(this._velocity.constant.clone());break;case 1:e=ke.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:e=ke.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:e=ke.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t.space=this.space,t},n(0,l,"velocity",function(){return this._velocity});var it=rt;function rt(e){this._velocity=null,this.enbale=!1,this.space=0,this._velocity=e}t(y,"laya.d3.core.particleShuriKen.ShurikenParticleData"),y._getStartLifetimeFromGradient=function(e,t){for(var n=1,i=e.gradientCount;n<i;n++){var r,a=e.getKeyByIndex(n);if(t<=a)return a=(t-(r=e.getKeyByIndex(n-1)))/(a-r),Q.lerp(e.getValueByIndex(n-1),e.getValueByIndex(n),a)}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")},y._randomInvertRoationArray=function(e,t,n,i,r){var a=NaN;i?(i.seed=r[6],a=i.getFloat(),r[6]=i.seed):a=Math.random(),a<n?(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2]):(t[0]=e[0],t[1]=e[1],t[2]=e[2])},y._randomInvertRoation=function(e,t,n,i){var r=NaN;return n?(n.seed=i[6],r=n.getFloat(),i[6]=n.seed):r=Math.random(),e=r<t?-e:e},y.create=function(e,t,n){var i=e.autoRandomSeed,r=e._rand,a=e._randomSeeds;switch(e.startColorType){case 0:var o=e.startColorConstant.elements;y.startColor[0]=o[0],y.startColor[1]=o[1],y.startColor[2]=o[2],y.startColor[3]=o[3];break;case 2:i?Q.lerpVector4(e.startColorConstantMin.elements,e.startColorConstantMax.elements,Math.random(),y.startColor):(r.seed=a[3],Q.lerpVector4(e.startColorConstantMin.elements,e.startColorConstantMax.elements,r.getFloat(),y.startColor),a[3]=r.seed)}var s=e.colorOverLifetime;if(s&&s.enbale){var l=s.color;switch(l.type){case 0:y.startColor[0]=y.startColor[0]*l.constant.x,y.startColor[1]=y.startColor[1]*l.constant.y,y.startColor[2]=y.startColor[2]*l.constant.z,y.startColor[3]=y.startColor[3]*l.constant.w;break;case 2:var h=NaN,_=(i?h=Math.random():(r.seed=a[10],h=r.getFloat(),a[10]=r.seed),l.constantMin),u=l.constantMax;y.startColor[0]=y.startColor[0]*Q.lerp(_.x,u.x,h),y.startColor[1]=y.startColor[1]*Q.lerp(_.y,u.y,h),y.startColor[2]=y.startColor[2]*Q.lerp(_.z,u.z,h),y.startColor[3]=y.startColor[3]*Q.lerp(_.w,u.w,h)}}var d,c,f=y.startSize;switch(e.startSizeType){case 0:e.threeDStartSize?(d=e.startSizeConstantSeparate,f[0]=d.x,f[1]=d.y,f[2]=d.z):f[0]=f[1]=f[2]=e.startSizeConstant;break;case 2:e.threeDStartSize?(d=e.startSizeConstantMinSeparate,c=e.startSizeConstantMaxSeparate,i?(f[0]=Q.lerp(d.x,c.x,Math.random()),f[1]=Q.lerp(d.y,c.y,Math.random()),f[2]=Q.lerp(d.z,c.z,Math.random())):(r.seed=a[4],f[0]=Q.lerp(d.x,c.x,r.getFloat()),f[1]=Q.lerp(d.y,c.y,r.getFloat()),f[2]=Q.lerp(d.z,c.z,r.getFloat()),a[4]=r.seed)):i?f[0]=f[1]=f[2]=Q.lerp(e.startSizeConstantMin,e.startSizeConstantMax,Math.random()):(r.seed=a[4],f[0]=f[1]=f[2]=Q.lerp(e.startSizeConstantMin,e.startSizeConstantMax,r.getFloat()),a[4]=r.seed)}var m,p,E,s=e.sizeOverLifetime,g=(s&&s.enbale&&1===s.size.type&&((s=s.size).separateAxes?i?(f[0]=f[0]*Q.lerp(s.constantMinSeparate.x,s.constantMaxSeparate.x,Math.random()),f[1]=f[1]*Q.lerp(s.constantMinSeparate.y,s.constantMaxSeparate.y,Math.random()),f[2]=f[2]*Q.lerp(s.constantMinSeparate.z,s.constantMaxSeparate.z,Math.random())):(r.seed=a[11],f[0]=f[0]*Q.lerp(s.constantMinSeparate.x,s.constantMaxSeparate.x,r.getFloat()),f[1]=f[1]*Q.lerp(s.constantMinSeparate.y,s.constantMaxSeparate.y,r.getFloat()),f[2]=f[2]*Q.lerp(s.constantMinSeparate.z,s.constantMaxSeparate.z,r.getFloat()),a[11]=r.seed):(x=NaN,i?x=Q.lerp(s.constantMin,s.constantMax,Math.random()):(r.seed=a[11],x=Q.lerp(s.constantMin,s.constantMax,r.getFloat()),a[11]=r.seed),f[0]=f[0]*x,f[1]=f[1]*x,f[2]=f[2]*x)),t.renderMode);if(1!==g)switch(e.startRotationType){case 0:e.threeDStartRotation?(m=e.startRotationConstantSeparate,p=y._tempVector30.elements,y._randomInvertRoationArray(m.elements,p,e.randomizeRotationDirection,i?null:r,a),y.startRotation[0]=p[0],y.startRotation[1]=p[1],y.startRotation[2]=4!==g?-p[2]:p[2]):y.startRotation[0]=y._randomInvertRoation(e.startRotationConstant,e.randomizeRotationDirection,i?null:r,a);break;case 2:e.threeDStartRotation?(m=e.startRotationConstantMinSeparate,p=e.startRotationConstantMaxSeparate,E=y._tempVector30.elements,i?(E[0]=Q.lerp(m.x,p.x,Math.random()),E[1]=Q.lerp(m.y,p.y,Math.random()),E[2]=Q.lerp(m.z,p.z,Math.random())):(r.seed=a[5],E[0]=Q.lerp(m.x,p.x,r.getFloat()),E[1]=Q.lerp(m.y,p.y,r.getFloat()),E[2]=Q.lerp(m.z,p.z,r.getFloat()),a[5]=r.seed),y._randomInvertRoationArray(E,E,e.randomizeRotationDirection,i?null:r,a),y.startRotation[0]=E[0],y.startRotation[1]=E[1],y.startRotation[2]=4!==g?-E[2]:E[2]):i?y.startRotation[0]=y._randomInvertRoation(Q.lerp(e.startRotationConstantMin,e.startRotationConstantMax,Math.random()),e.randomizeRotationDirection,i?null:r,a):(r.seed=a[5],y.startRotation[0]=y._randomInvertRoation(Q.lerp(e.startRotationConstantMin,e.startRotationConstantMax,r.getFloat()),e.randomizeRotationDirection,i?null:r,a),a[5]=r.seed)}switch(e.startLifetimeType){case 0:y.startLifeTime=e.startLifetimeConstant;break;case 1:y.startLifeTime=y._getStartLifetimeFromGradient(e.startLifeTimeGradient,e.emissionTime);break;case 2:i?y.startLifeTime=Q.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,Math.random()):(r.seed=a[7],y.startLifeTime=Q.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,r.getFloat()),a[7]=r.seed);break;case 3:var v=e.emissionTime;i?y.startLifeTime=Q.lerp(y._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,v),y._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,v),Math.random()):(r.seed=a[7],y.startLifeTime=Q.lerp(y._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,v),y._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,v),r.getFloat()),a[7]=r.seed)}switch(e.startSpeedType){case 0:y.startSpeed=e.startSpeedConstant;break;case 2:i?y.startSpeed=Q.lerp(e.startSpeedConstantMin,e.startSpeedConstantMax,Math.random()):(r.seed=a[8],y.startSpeed=Q.lerp(e.startSpeedConstantMin,e.startSpeedConstantMax,r.getFloat()),a[8]=r.seed)}var T=e.textureSheetAnimation;if(T&&T.enable){var s=T.tiles,S=s.x,D=s.y,x=1/S,t=1/D,M=0,R=T.startFrame;switch(R.type){case 0:M=R.constant;break;case 1:i?M=Q.lerp(R.constantMin,R.constantMax,Math.random()):(r.seed=a[14],M=Q.lerp(R.constantMin,R.constantMax,r.getFloat()),a[14]=r.seed)}var I=T.frame;switch(I.type){case 0:M+=I.constant;break;case 2:i?M+=Q.lerp(I.constantMin,I.constantMax,Math.random()):(r.seed=a[15],M+=Q.lerp(I.constantMin,I.constantMax,r.getFloat()),a[15]=r.seed)}var A=0;switch(T.type){case 0:A=Math.floor(M/S);break;case 1:T.randomRow?i?A=Math.floor(Math.random()*D):(r.seed=a[13],A=Math.floor(r.getFloat()*D),a[13]=r.seed):A=T.rowIndex}s=Math.floor(M%S);y.startUVInfo[0]=x,y.startUVInfo[1]=t,y.startUVInfo[2]=s*x,y.startUVInfo[3]=A*t}else y.startUVInfo[0]=1,y.startUVInfo[1]=1,y.startUVInfo[2]=0,y.startUVInfo[3]=0;switch(e.simulationSpace){case 0:var C=n.position.elements,C=(y.simulationWorldPostion[0]=C[0],y.simulationWorldPostion[1]=C[1],y.simulationWorldPostion[2]=C[2],n.rotation.elements);y.simulationWorldRotation[0]=C[0],y.simulationWorldRotation[1]=C[1],y.simulationWorldRotation[2]=C[2],y.simulationWorldRotation[3]=C[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}},y.startLifeTime=NaN,y.startSpeed=NaN,e(y,["_tempVector30",function(){return this._tempVector30=new W},"_tempQuaternion",function(){return this._tempQuaternion=new $i},"startColor",function(){return this.startColor=new Float32Array(4)},"startSize",function(){return this.startSize=new Float32Array(3)},"startRotation",function(){return this.startRotation=new Float32Array(3)},"startUVInfo",function(){return this.startUVInfo=new Float32Array(4)},"simulationWorldPostion",function(){return this.simulationWorldPostion=new Float32Array(3)},"simulationWorldRotation",function(){return this.simulationWorldRotation=new Float32Array(4)}]);var at=y;function y(){}t(st,"laya.d3.core.PhasorSpriter3D"),(l=st.prototype).line=function(e,t,n,i){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+2*this._floatSizePerVer>this._vbData.length||this._posInIBData+2>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e.x,e.y,e.z,t.x,t.y,t.z,t.w),this.addVertex(n.x,n.y,n.z,i.x,i.y,i.z,i.w),this.addIndexes(this._tempUint0,this._tempUint0+1),this},l.circle=function(e,t,n,i,r,a){for(this._hasBegun&&1===this._primitiveType||this.drawLinesException(),this._tempUint0=2*t,(this._posInVBData+this._tempUint0*this._floatSizePerVer>this._vbData.length||this._posInIBData+2*this._tempUint0>this._ibData.length)&&this.flush(),this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=0,this._tempInt0=0;this._tempNumver0<6.2832;this._tempNumver0=this._tempNumver0+3.1416/t,this._tempInt0++)this.addVertex(Math.sin(this._tempNumver0)*e,Math.cos(this._tempNumver0)*e,0,n,i,r,a),0===this._tempInt0?this.addIndexes(this._tempUint1):this._tempInt0===this._tempUint0-1?(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2,this._tempUint1)):(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2));return this},l.plane=function(e,t,n,i,r,a,o,s,l){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+4*this._floatSizePerVer>this._vbData.length||this._posInIBData+6>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n,a,o,s,l),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n,a,o,s,l),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n,a,o,s,l),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n,a,o,s,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint0+3),this},l.box=function(e,t,n,i,r,a,o,s,l,h){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+36>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempNumver2=a/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n+this._tempNumver2,o,s,l,h),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n+this._tempNumver2,o,s,l,h),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n+this._tempNumver2,o,s,l,h),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n+this._tempNumver2,o,s,l,h),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n-this._tempNumver2,o,s,l,h),this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n-this._tempNumver2,o,s,l,h),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n-this._tempNumver2,o,s,l,h),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n-this._tempNumver2,o,s,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint3,this._tempUint4,this._tempUint5,this._tempUint6,this._tempUint6,this._tempUint5,this._tempUint7,this._tempUint5,this._tempUint0,this._tempUint7,this._tempUint7,this._tempUint0,this._tempUint2,this._tempUint1,this._tempUint4,this._tempUint3,this._tempUint3,this._tempUint4,this._tempUint6,this._tempUint5,this._tempUint4,this._tempUint0,this._tempUint0,this._tempUint4,this._tempUint1,this._tempUint2,this._tempUint3,this._tempUint7,this._tempUint7,this._tempUint3,this._tempUint6),this},l.cone=function(e,t,n,i,r,a,o){for(this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+(2*n+2)*this._floatSizePerVer>this._vbData.length||this._posInIBData+6*n>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData,this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=2*Math.PI/n,this.addVertexIndex(0,t,0,i,r,a,o,this._tempUint0),this.addVertexIndex(0,0,0,i,r,a,o,this._tempUint0+this._floatSizePerVer),this._tempInt0=2,this._tempNumver1=0,this._tempInt1=0;this._tempInt1<n;this._tempInt1++)this._tempNumver2=Math.cos(this._tempNumver1),this._tempNumver3=Math.sin(this._tempNumver1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,i,r,a,o,this._tempUint0+this._tempInt0*this._floatSizePerVer),this.addIndexes(this._tempUint1,this._tempUint1+this._tempInt0),this._tempInt1==n-1?this.addIndexes(this._tempUint1+2):this.addIndexes(this._tempUint1+this._tempInt0+1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,i,r,a,o,this._tempUint0+(this._tempInt0+n)*this._floatSizePerVer),this.addIndexes(this._tempUint1+1),this._tempInt1==n-1?this.addIndexes(this._tempUint1+n+2):this.addIndexes(this._tempUint1+this._tempInt0+n+1),this.addIndexes(this._tempUint1+this._tempInt0+n),this._tempInt0++,this._tempNumver1+=this._tempNumver0;return this},l.boundingBoxLine=function(e,t,n,i,r,a,o,s,l,h){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+48>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e,r,a,o,s,l,h),this.addVertex(i,r,a,o,s,l,h),this.addVertex(e,t,a,o,s,l,h),this.addVertex(i,t,a,o,s,l,h),this.addVertex(i,r,n,o,s,l,h),this.addVertex(e,r,n,o,s,l,h),this.addVertex(i,t,n,o,s,l,h),this.addVertex(e,t,n,o,s,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint1,this._tempUint3,this._tempUint3,this._tempUint2,this._tempUint2,this._tempUint0,this._tempUint4,this._tempUint5,this._tempUint5,this._tempUint7,this._tempUint7,this._tempUint6,this._tempUint6,this._tempUint4,this._tempUint5,this._tempUint0,this._tempUint0,this._tempUint2,this._tempUint2,this._tempUint7,this._tempUint7,this._tempUint5,this._tempUint1,this._tempUint4,this._tempUint4,this._tempUint6,this._tempUint6,this._tempUint3,this._tempUint3,this._tempUint1,this._tempUint5,this._tempUint4,this._tempUint4,this._tempUint1,this._tempUint1,this._tempUint0,this._tempUint0,this._tempUint5,this._tempUint2,this._tempUint3,this._tempUint3,this._tempUint6,this._tempUint6,this._tempUint7,this._tempUint7,this._tempUint2),this},l.addVertex=function(e,t,n,i,r,a,o){return this._hasBegun||this.addVertexIndexException(),this._vbData[this._posInVBData]=e,this._vbData[this._posInVBData+1]=t,this._vbData[this._posInVBData+2]=n,this._vbData[this._posInVBData+3]=i,this._vbData[this._posInVBData+4]=r,this._vbData[this._posInVBData+5]=a,this._vbData[this._posInVBData+6]=o,this._posInVBData+=this._floatSizePerVer,this},l.addVertexIndex=function(e,t,n,i,r,a,o,s){return this._hasBegun||this.addVertexIndexException(),this._vbData[s]=e,this._vbData[s+1]=t,this._vbData[s+2]=n,this._vbData[s+3]=i,this._vbData[s+4]=r,this._vbData[s+5]=a,this._vbData[s+6]=o,(s+=this._floatSizePerVer)>this._posInVBData&&(this._posInVBData=s),this},l.addIndexes=function(e){var t=arguments;this._hasBegun||this.addVertexIndexException();for(var n=0;n<t.length;n++)this._ibData[this._posInIBData]=t[n],this._posInIBData++;return this},l.begin=function(e,t){return this._hasBegun&&this.beginException0(),1!==e&&4!==e&&this.beginException1(),this._primitiveType=e,this._camera=t,this._hasBegun=!0,this},l.end=function(){return this._hasBegun||this.endException(),this.flush(),this._hasBegun=!1,this},l.flush=function(){0!==this._posInVBData&&(this._ib.setData(this._ibData),this._vb.setData(this._vbData),this._vb._bind(),this._ib._bind(),this._shader=this._shaderCompile.withCompile(0,0,0),this._shader.bind(),this._shader.uploadAttributes(st._vertexDeclaration.shaderValues.data,null),this._spriteShaderValue.setValue(1,this._camera.projectionViewMatrix.elements),this._shader.uploadSpriteUniforms(this._spriteShaderValue.data),T.drawCall++,c.mainContext.drawElements(this._primitiveType,this._posInIBData,5123,0),this._posInIBData=0,this._posInVBData=0)},l.addVertexIndexException=function(){throw new Error("请先调用begin()函数")},l.beginException0=function(){throw new Error("调用begin()前请确保已成功调用end()！")},l.beginException1=function(){throw new Error("只支持“LINES”和“TRIANGLES”两种基元！")},l.endException=function(){throw new Error("调用end()前请确保已成功调用begin()！")},l.drawLinesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“LINES”基元！")},l.drawTrianglesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“TRIANGLES”基元！")},e(st,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(28,[new _(0,"vector3",0),new _(12,"vector4",1)])}]);var ot=st;function st(){this._tempInt0=0,this._tempInt1=0,this._tempUint0=0,this._tempUint1=0,this._tempUint2=0,this._tempUint3=0,this._tempUint4=0,this._tempUint5=0,this._tempUint6=0,this._tempUint7=0,this._tempNumver0=NaN,this._tempNumver1=NaN,this._tempNumver2=NaN,this._tempNumver3=NaN,this._floatSizePerVer=7,this._defaultBufferSize=600*this._floatSizePerVer,this._vb=null,this._posInVBData=0,this._ib=null,this._posInIBData=0,this._primitiveType=NaN,this._hasBegun=!1,this._numVertsPerPrimitive=0,this._camera=null,this._sharderNameID=0,this._shader=null,this._shaderCompile=null,this._vbData=new Float32Array(this._defaultBufferSize),this._ibData=new Uint16Array(this._defaultBufferSize),this._spriteShaderValue=new gr,this._vb=Es.create(st._vertexDeclaration,this._defaultBufferSize/this._floatSizePerVer,35048),this._ib=ds.create("ushort",this._defaultBufferSize,35048),this._sharderNameID=Ko.nameKey.getID("LINE"),this._shaderCompile=g._preCompileShader[this._sharderNameID]}t(ht,"laya.d3.core.render.RenderElement"),(l=ht.prototype).getDynamicBatchBakedVertexs=function(e){for(var e=this._renderObj._getVertexBuffer(e),t=e.getData().slice(),e=e.vertexDeclaration,n=e.getVertexElementByUsage(0).offset/4,i=e.getVertexElementByUsage(3).offset/4,r=this._sprite3D.transform,a=r.worldMatrix,o=r.rotation,s=e.vertexStride/4,l=0,h=t.length;l<h;l+=s){var _=l+n,u=l+i;br.transformVector3ArrayToVector3ArrayCoordinate(t,_,a,t,_),br.transformVector3ArrayByQuat(t,u,o,t,u)}return t},l.getBakedIndices=function(){return this._renderObj._getIndexBuffer().getData()},l._destroy=function(){this._staticBatch&&this._staticBatch._manager._garbageCollection(this)},n(0,l,"id",function(){return this._id}),n(0,l,"renderObj",function(){return this._renderObj},function(e){this._renderObj!==e&&(this._renderObj=e)}),ht._uniqueIDCounter=0;var lt=ht;function ht(){this._id=0,this._type=0,this._mainSortID=0,this._render=null,this._sprite3D=null,this._material=null,this._renderObj=null,this._staticBatch=null,this._tempBatchIndexStart=0,this._tempBatchIndexEnd=0,this._canDynamicBatch=!1,this._shaderValue=null,this._onPreRenderFunction=null,this._id=++ht._uniqueIDCounter,this._canDynamicBatch=!0,this._shaderValue=new gr}t(ut,"laya.d3.core.render.RenderQueue"),(l=ut.prototype)._sortOpaqueFunc=function(e,t){var n;return e._render&&t._render?0==(n=e._material.renderQueue-t._material.renderQueue)?e._render._distanceForSort-t._render._distanceForSort:n:0},l._sortAlphaFunc=function(e,t){var n;return e._render&&t._render?0==(n=e._material.renderQueue-t._material.renderQueue)?t._render._distanceForSort-e._render._distanceForSort:n:0},l._begainRenderElement=function(e,t,n){return!!t._beforeRender(e)},l._sortAlpha=function(e){ut._cameraPosition=e,this._finalElements.sort(this._sortAlphaFunc)},l._sortOpaque=function(e){ut._cameraPosition=e,this._finalElements.sort(this._sortOpaqueFunc)},l._preRender=function(e){this._finalElements=this._renderElements.concat(this._dynamicBatchCombineRenderElements)},l._render=function(e,t){for(var n,i,r,a,o,s,l=T.loopCount,h=this._scene,_=e.camera,u=(_.id,!1),d=0,c=this._finalElements.length;d<c;d++){var f,m,p,E=this._finalElements[d];if(null!=E._onPreRenderFunction&&E._onPreRenderFunction.call(E._sprite3D,e),0===E._type){if(e.owner=p=E._sprite3D,e.renderElement=E,p._preRenderUpdateComponents(e),f=E.renderObj,m=E._material,this._begainRenderElement(e,f,m)){if(n=f._getVertexBuffers(),r=(i=f._getVertexBuffer(0)).vertexDeclaration,u=(a=e._shader=m._getShader(h._shaderDefineValue,r.shaderDefineValue,p._shaderDefineValue)).bind()||l!==a._uploadLoopCount,n){if(a._uploadVertexBuffer!==n||u){for(var g=0;g<n.length;g++){var v=n[g];a.uploadAttributesX(v.vertexDeclaration.shaderValues.data,v)}a._uploadVertexBuffer=n}}else a._uploadVertexBuffer===i&&!u||(a.uploadAttributes(r.shaderValues.data,null),a._uploadVertexBuffer=i);a._uploadScene===h&&!u||(a.uploadSceneUniforms(h._shaderValues.data),a._uploadScene=h),_===a._uploadCamera&&a._uploadSprite3D===p&&!u||(a.uploadSpriteUniforms(p._shaderValues.data),a._uploadSprite3D=p),_===a._uploadCamera&&!u||(a.uploadCameraUniforms(_._shaderValues.data),a._uploadCamera=_),a._uploadMaterial===m&&!u||(m._upload(),a._uploadMaterial=m),o!==m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(t,p.transform),o=m,s=p):s!==p&&(m._setRenderStateFrontFace(t,p.transform),s=p),f._render(e),a._uploadLoopCount=l}p._postRenderUpdateComponents(e)}else 2===E._type&&(E.renderObj,e.owner=p=E._sprite3D,e.renderElement=E,e._batchIndexStart=E._tempBatchIndexStart,e._batchIndexEnd=E._tempBatchIndexEnd,f=E.renderObj,m=E._material,this._begainRenderElement(e,f,m))&&(r=(i=f._getVertexBuffer(0)).vertexDeclaration,u=(a=e._shader=m._getShader(h._shaderDefineValue,r.shaderDefineValue,p._shaderDefineValue)).bind()||l!==a._uploadLoopCount,a._uploadVertexBuffer===i&&!u||(a.uploadAttributes(r.shaderValues.data,null),a._uploadVertexBuffer=i),a._uploadScene===h&&!u||(a.uploadSceneUniforms(h._shaderValues.data),a._uploadScene=h),_===a._uploadCamera&&a._uploadSprite3D===p&&!u||(a.uploadSpriteUniforms(p._shaderValues.data),a._uploadSprite3D=p),_===a._uploadCamera&&!u||(a.uploadCameraUniforms(_._shaderValues.data),a._uploadCamera=_),a._uploadMaterial===m&&!u||(m._upload(),a._uploadMaterial=m),o!==m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(t,p.transform),o=m,s=p):s!==p&&(m._setRenderStateFrontFace(t,p.transform),s=p),f._render(e),a._uploadLoopCount=l)}},l._renderShadow=function(e,t){for(var n,i,r,a,o,s,l=T.loopCount,h=this._scene,_=e.camera,u=0,d=this._finalElements.length;u<d;u++){var c,f,m=this._finalElements[u];0===m._type&&(e.owner=f=m._sprite3D,t||f._projectionViewWorldUpdateCamera===_&&f._projectionViewWorldUpdateLoopCount===T.loopCount||(f._render._renderUpdate(e._projectionViewMatrix),f._projectionViewWorldUpdateLoopCount=T.loopCount,f._projectionViewWorldUpdateCamera=_),e.renderElement=m,f._preRenderUpdateComponents(e),c=m.renderObj,m=m._material,this._begainRenderElement(e,c,null)&&(i=(n=c._getVertexBuffer(0)).vertexDeclaration,a=(r=e._shader=m._getShader(h._shaderDefineValue,i.shaderDefineValue,f._shaderDefineValue)).bind()||l!==r._uploadLoopCount,r._uploadVertexBuffer===n&&!a||(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),_===r._uploadCamera&&r._uploadSprite3D===f&&!a||(r.uploadSpriteUniforms(f._shaderValues.data),r._uploadSprite3D=f),_===r._uploadCamera&&!a||(r.uploadCameraUniforms(_._shaderValues.data),r._uploadCamera=_),r._uploadMaterial===m&&!a||(m._upload(),r._uploadMaterial=m),r._uploadRenderElement,o!==m?(m._setRenderStateFrontFace(!1,f.transform),o=m,s=f):s!==f&&(m._setRenderStateFrontFace(!1,f.transform),s=f),c._render(e),r._uploadLoopCount=l),f._postRenderUpdateComponents(e))}},l._clearRenderElements=function(){this._dynamicBatchCombineRenderElements.length=0,this._renderElements.length=0,this._needSort=!0},l._addRenderElement=function(e){this._renderElements.push(e),this._needSort=!0},l._addDynamicBatchElement=function(e){this._dynamicBatchCombineRenderElements.push(e)},n(0,l,"id",function(){return this._id}),ut._uniqueIDCounter=0,ut._cameraPosition=null;var _t=ut;function ut(e){this._id=0,this._needSort=!1,this._renderElements=null,this._renderableRenderObjects=null,this._dynamicBatchCombineRenderElements=null,this._finalElements=null,this._scene=null,this._id=++ut._uniqueIDCounter,this._needSort=!1,this._scene=e,this._renderElements=[],this._renderableRenderObjects=[],this._dynamicBatchCombineRenderElements=[]}t(ct,"laya.d3.core.render.RenderState"),ct.clientWidth=0,ct.clientHeight=0;var dt=ct;function ct(){this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0,this._viewMatrix=null,this._projectionMatrix=null,this._projectionViewMatrix=null,this._viewport=null,this._shader=null,this.elapsedTime=NaN,this.scene=null,this.owner=null,this.renderElement=null,this.camera=null}t(mt,"laya.d3.core.scene.OctreeNode"),l=mt.prototype,v.imps(l,{"laya.d3.core.scene.ITreeNode":!0}),l.init=function(e,t){var n=new W,i=new W;W.scale(t,-.5,n),W.scale(t,.5,i),W.add(n,e,n),W.add(i,e,i),this.exactBox=new bi(n,i),this.relaxBox=new bi(n,i)},l.addTreeNode=function(e){1===Wi.boxContainsBox(this._relaxBox,e.boundingBox)?this.addNodeDown(e,0):this.addObject(e)},l.addChild=function(e){var t,n=this._children[e];return null==n&&(n=new mt(this._scene,this._currentDepth+1),(this._children[e]=n)._parent=this,W.subtract(this._exactBox.max,this._exactBox.min,mt.tempSize),W.multiply(mt.tempSize,mt._octreeSplit[e],mt.tempCenter),W.add(this._exactBox.min,mt.tempCenter,mt.tempCenter),W.scale(mt.tempSize,.25,mt.tempSize),e=new W,t=new W,W.subtract(mt.tempCenter,mt.tempSize,e),W.add(mt.tempCenter,mt.tempSize,t),n.exactBox=new bi(e,t),W.scale(mt.tempSize,mt.relax,mt.tempSize),e=new W,t=new W,W.subtract(mt.tempCenter,mt.tempSize,e),W.add(mt.tempCenter,mt.tempSize,t),n.relaxBox=new bi(e,t)),n},l.addObject=function(e){(e._treeNode=this)._objects.push(e)},l.removeObject=function(e){return e._treeNode!=this?(console.log("OctreeNode::removeObject error"),!1):-1!==(e=this._objects.indexOf(e))&&(this._objects.splice(e,1),!0)},l.clearObject=function(){this._objects.length=0},l.addNodeUp=function(e,t){this._parent&&1!==Wi.boxContainsBox(this._exactBox,e.boundingBox)?this._parent.addNodeUp(e,t-1):this.addNodeDown(e,t)},l.addNodeDown=function(e,t){var n;t<this._scene.treeLevel&&(n=this.inChildIndex(e.boundingBoxCenter),n=this.addChild(n),1===Wi.boxContainsBox(n._relaxBox,e.boundingBox))?n.addNodeDown(e,++t):this.addObject(e)},l.inChildIndex=function(e){return 4*(e.z<this._boundingBoxCenter.z?0:1)+2*(e.y<this._boundingBoxCenter.y?0:1)+(e.x<this._boundingBoxCenter.x?0:1)},l.updateObject=function(e){1===Wi.boxContainsBox(this._relaxBox,e.boundingBox)?(this.removeObject(e),e._treeNode=null,this.addNodeDown(e,this._currentDepth)):this._parent&&(this.removeObject(e),e._treeNode=null,this._parent.addNodeUp(e,this._currentDepth-1))},l.cullingObjects=function(e,t,n,i,r){for(var a=0,o=0,s=this._scene._dynamicBatchManager,a=0,l=this._objects.length;a<l;a++){var h=this._objects[a];if(Se.isVisible(h._owner.layer.mask)&&h.enable&&(!t||(T.treeSpriteCollision+=1,0!==e.containsBoundSphere(h.boundingSphere)))){h._renderUpdate(r),h._distanceForSort=W.distance(h.boundingSphere.center,i)+h.sortingFudge;for(var _=h._renderElements,o=0,u=_.length;o<u;o++){var d=_[o],c=d._staticBatch;c&&c._material===d._material?c._addBatchRenderElement(d):(c=d.renderObj).triangleCount<10&&1===c._vertexBufferCount&&c._getIndexBuffer()&&d._material.renderQueue<2&&d._canDynamicBatch&&!h._owner.isStatic?s._addPrepareRenderElement(d):this._scene.getRenderQueue(d._material.renderQueue)._addRenderElement(d)}}}for(a=0;a<8;a++){var f=this._children[a];if(null!=f){var m=t;if(t){var p=e.containsBoundBox(f._relaxBox);if(T.treeNodeCollision+=1,0===p)continue;m=2===p}f.cullingObjects(e,m,n,i,r)}}},l.cullingShadowObjects=function(e,t,n,i,r){for(var a=0,o=0,a=(this._scene._dynamicBatchManager,0),s=this._objects.length;a<s;a++){var l=this._objects[a];if(l.castShadow&&Se.isVisible(l._owner.layer.mask)&&l.enable&&(!n||0!==e[0].containsBoundSphere(l.boundingSphere)))for(var h=1,_=e.length;h<_;h++){var u=t[h-1];if(0!==e[h].containsBoundSphere(l.boundingSphere))for(var d=l._renderElements,o=0,c=d.length;o<c;o++)u._addRenderElement(d[o])}}for(a=0;a<8;a++){var f=this._children[a];if(null!=f){var m=n;if(n){var p=e[0].containsBoundBox(f._relaxBox);if(0===p)continue;m=2===p}f.cullingShadowObjects(e,t,m,i,r)}}},l.cullingShadowObjectsOnePSSM=function(e,t,n,i,r,a){for(var o=t[0],s=0,l=0,s=0,h=this._objects.length;s<h;s++){var _=this._objects[s];if(_.castShadow&&Se.isVisible(_._owner.layer.mask)&&_.enable&&(!i||0!==e.containsBoundSphere(_.boundingSphere))){_._renderUpdate(n);for(var u=_._renderElements,l=0,d=u.length;l<d;l++)o._addRenderElement(u[l])}}for(s=0;s<8;s++){var c=this._children[s];if(null!=c){var f=i;if(i){var m=e.containsBoundBox(c._relaxBox);if(0===m)continue;f=2===m}c.cullingShadowObjectsOnePSSM(e,t,n,f,r,a)}}},l.renderBoudingBox=function(e){this._renderBoudingBox(e);for(var t=0;t<8;++t){var n=this._children[t];n&&n.renderBoudingBox(e)}},l.buildAllChild=function(e){if(e<this._scene.treeLevel)for(var t=0;t<8;t++)this.addChild(t).buildAllChild(e+1)},l._renderBoudingBox=function(e){},n(0,l,"exactBox",function(){return this._exactBox},function(e){this._exactBox=e,W.add(e.min,e.max,this._boundingBoxCenter),W.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter)}),n(0,l,"relaxBox",function(){return this._relaxBox},function(e){(this._relaxBox=e).getCorners(this._corners),Gi.createfromPoints(this._corners,this._boundingSphere)}),mt.debugMode=!1,mt.relax=1.15,mt.CHILDNUM=8,e(mt,["tempVector0",function(){return this.tempVector0=new W},"tempSize",function(){return this.tempSize=new W},"tempCenter",function(){return this.tempCenter=new W},"_octreeSplit",function(){return this._octreeSplit=[new W(.25,.25,.25),new W(.75,.25,.25),new W(.25,.75,.25),new W(.75,.75,.25),new W(.25,.25,.75),new W(.75,.25,.75),new W(.25,.75,.75),new W(.75,.75,.75)]}]);var ft=mt;function mt(e,t){this._exactBox=null,this._relaxBox=null,this._scene=null,this._parent=null,this._currentDepth=0,this._boundingSphere=new Gi(new W,0),this._corners=[new W,new W,new W,new W,new W,new W,new W,new W],this._boundingBoxCenter=new W,this._children=w(8),this._objects=[],this._tempBoundBoxCorners=[new W,new W,new W,new W,new W,new W,new W,new W],this._scene=e,this._currentDepth=t}t(pt,"laya.d3.core.scene.SceneManager");function pt(){}t(gt,"laya.d3.core.trail.module.Color",null,"Color$1"),gt.prototype.cloneTo=function(e){e._r=this._r,e._g=this._g,e._b=this._b,e._a=this._a},e(gt,["RED",function(){return this.RED=new gt(1,0,0,1)},"GREEN",function(){return this.GREEN=new gt(0,1,0,1)},"BLUE",function(){return this.BLUE=new gt(0,0,1,1)},"CYAN",function(){return this.CYAN=new gt(0,1,1,1)},"YELLOW",function(){return this.YELLOW=new gt(1,.92,.016,1)},"MAGENTA",function(){return this.MAGENTA=new gt(1,0,1,1)},"GRAY",function(){return this.GRAY=new gt(.5,.5,.5,1)},"WHITE",function(){return this.WHITE=new gt(1,1,1,1)},"BLACK",function(){return this.BLACK=new gt(0,0,0,1)}]);var Et=gt;function gt(e,t,n,i){this._r=NaN,this._g=NaN,this._b=NaN,this._a=NaN,void 0===t&&(t=1),void 0===n&&(n=1),void 0===i&&(i=1),this._r=e=void 0===e?1:e,this._g=t,this._b=n,this._a=i}t(Tt,"laya.d3.core.trail.module.Gradient"),(l=Tt.prototype).setKeys=function(e,t){this._colorKeys=e;for(var n,i=this.index=0;i<e.length;i++){var r,a=(r=e[i]).color;this._colorKeyData[this.index++]=a._r,this._colorKeyData[this.index++]=a._g,this._colorKeyData[this.index++]=a._b,this._colorKeyData[this.index++]=r.time}this._alphaKeys=t;for(var o=this.index=0;o<t.length;o++)n=t[o],this._alphaKeyData[this.index++]=n.alpha,this._alphaKeyData[this.index++]=n.time},l.cloneTo=function(e){for(var t=0,n=0,i=this.colorKeys,r=[],t=0,n=i.length;t<n;t++){var a=new xt;i[t].cloneTo(a),r.push(a)}var o=this.alphaKeys,s=[];for(t=0,n=o.length;t<n;t++){var l=new St;o[t].cloneTo(l),s.push(l)}e.setKeys(r,s)},n(0,l,"mode",function(){return this._mode},function(e){this._mode=e}),n(0,l,"colorKeys",function(){return this._colorKeys},function(e){this._colorKeys=e;for(var t=this.index=0;t<e.length;t++){var n=e[t],i=n.color;this._colorKeyData[this.index++]=i._r,this._colorKeyData[this.index++]=i._g,this._colorKeyData[this.index++]=i._b,this._colorKeyData[this.index++]=n.time}}),n(0,l,"alphaKeys",function(){return this._alphaKeys},function(e){this._alphaKeys=e;for(var t=this.index=0;t<e.length;t++){var n=e[t];this._alphaKeyData[this.index++]=n.alpha,this._alphaKeyData[this.index++]=n.time}});var vt=Tt;function Tt(){this._mode=0,this._colorKeys=null,this._alphaKeys=null,this.index=0,this._colorKeyData=new Float32Array(40),this._alphaKeyData=new Float32Array(20),this._colorKeys=[],this._alphaKeys=[]}t(Dt,"laya.d3.core.trail.module.GradientAlphaKey"),(l=Dt.prototype).cloneTo=function(e){e.alpha=this.alpha,e.time=this.time},n(0,l,"alpha",function(){return this._alpha},function(e){this._alpha=e}),n(0,l,"time",function(){return this._time},function(e){this._time=e});var St=Dt;function Dt(e,t){this._alpha=NaN,this._time=NaN,void 0===t&&(t=0),this._alpha=e=void 0===e?0:e,this._time=t}t(Mt,"laya.d3.core.trail.module.GradientColorKey"),(l=Mt.prototype).cloneTo=function(e){this.color.cloneTo(e.color),e.time=this.time},n(0,l,"color",function(){return this._color},function(e){this._color=e}),n(0,l,"time",function(){return this._time},function(e){this._time=e});var xt=Mt;function Mt(e,t){this._color=null,this._time=NaN,void 0===t&&(t=0),this._color=e||new Et,this._time=t}t(Rt,"laya.d3.core.trail.module.GradientMode"),Rt.Blend=0,Rt.Fixed=1;function Rt(){}t(It,"laya.d3.core.trail.module.TextureMode"),It.Stretch=0,It.Tile=1;function It(){}t(Ct,"laya.d3.core.trail.module.TrailKeyFrame"),Ct.prototype.cloneTo=function(e){e.time=this.time,e.inTangent=this.inTangent,e.outTangent=this.outTangent,e.value=this.value};var At=Ct;function Ct(){this.time=NaN,this.inTangent=NaN,this.outTangent=NaN,this.value=NaN}t(Ot,"laya.d3.core.trail.TrailRenderElement"),l=Ot.prototype,v.imps(l,{"laya.d3.core.render.IRenderable":!0}),l._updateTrail=function(){this._everyAddVerticeCount1=0,this._isStart||this._addTrailByFirstPosition(this._lastPosition,this._curPosition),this._addTrailByNextPosition(this._curPosition),this._vertexBuffer1.setData(this._vertices1,this._verticesIndex1,this._verticesIndex1,this._everyAddVerticeCount1),this._verticesIndex1+=this._everyAddVerticeCount1,this._curPosition.cloneTo(this._lastPosition),2==this._virtualVerticesCount&&(this._verticesIndex1-=2*this._floatCountPerVertices1)},l._addTrailByFirstPosition=function(e,t){W.subtract(t,e,this._delVector3),W.cross(this._delVector3,this._camera.forward,this._pointAtoBVector3),W.normalize(this._pointAtoBVector3,this._pointAtoBVector3),W.scale(this._pointAtoBVector3,this._owner.widthMultiplier/2,this._pointAtoBVector3),this._updateVerticesByPosition(e),e.cloneTo(this._lastFixedVertexPosition),this._verticesCount+=2,this._curtime=this._owner._hasLifeSubTrail?this._owner._curSubTrailFinishCurTime:this._owner._curtime,this._everyGroupVertexBirthTime.push(this._curtime),this._isStart=!0,this._owner._hasLifeSubTrail=!0},l._addTrailByNextPosition=function(e){W.subtract(e,this._lastFixedVertexPosition,this._delVector3),W.cross(this._delVector3,this._camera.forward,this._pointAtoBVector3),W.normalize(this._pointAtoBVector3,this._pointAtoBVector3),W.scale(this._pointAtoBVector3,this._owner.widthMultiplier/2,this._pointAtoBVector3),this._delLength=W.scalarLength(this._delVector3),this._delLength-this._owner.minVertexDistance>=M.zeroTolerance?(this._owner._trailTotalLength+=this._delLength,this._owner._trailSupplementLength=0,this._updateVerticesByPosition(e),e.cloneTo(this._lastFixedVertexPosition),this._verticesCount+=2,this._virtualVerticesCount=0,this._everyGroupVertexBirthTime.push(this._owner._curtime),this._verticesCount==this._maxVerticesCount&&this._onTrailRenderElementFinish()):(this._owner._trailSupplementLength=this._delLength,this._updateVerticesByPosition(e),this._virtualVerticesCount=2)},l._updateVerticesByPosition=function(e){this._pointe=e.elements,this._pointAtoBVector3e=this._pointAtoBVector3.elements,this._curtime=this._owner._curtime,this._owner._hasLifeSubTrail&&0==this._isStart&&(this._pointe=this._owner._curSubTrailFinishPosition.elements,this._pointAtoBVector3e=this._owner._curSubTrailFinishDirection.elements,this._curtime=this._owner._curSubTrailFinishCurTime),this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=-this._pointAtoBVector3e[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=-this._pointAtoBVector3e[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=-this._pointAtoBVector3e[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._curtime,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=1,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointAtoBVector3e[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointAtoBVector3e[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointAtoBVector3e[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._curtime,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=0,this._VerticesToTailLength[this._verticesCount/2]=this._owner._trailTotalLength+this._owner._trailSupplementLength,0==this._owner._trailSupplementLength?this._everyVertexToPreVertexDistance[this._verticesCount/2]=this._delLength:this._everyVertexToPreVertexDistance[this._verticesCount/2]=this._isStart?this._owner._trailSupplementLength:0},l._updateVertexBuffer2=function(){for(var e=0,t=0,n=0,n=0,i=(this._verticesCount+this._virtualVerticesCount)/2;n<i;n++)t=0==this._owner.textureMode?(this._VerticesToTailLength[n]-this._owner._trailDeadLength)/(this._owner._trailTotalLength+this._owner._trailSupplementLength-this._owner._trailDeadLength):this._owner._trailTotalLength+this._owner._trailSupplementLength-this._VerticesToTailLength[n],this._vertices2[e++]=1-t,this._vertices2[e++]=1-t;this._vertexBuffer2.setData(this._vertices2,0,0,this._verticesCount+this._virtualVerticesCount)},l._onTrailRenderElementFinish=function(){this._lastFixedVertexPosition.cloneTo(this._owner._curSubTrailFinishPosition),this._pointAtoBVector3.cloneTo(this._owner._curSubTrailFinishDirection),this._owner._curSubTrailFinishCurTime=this._owner._curtime,this._isFinish=!0},l._updateDisappear=function(){for(var e=0,e=this._curDisappearIndex,t=(this._verticesCount+this._virtualVerticesCount)/2;e<t;e++)this._owner._curtime-this._everyGroupVertexBirthTime[e]>=this._owner.time+M.zeroTolerance&&(this._curDisappearIndex++,this._owner._trailDeadLength+=this._everyVertexToPreVertexDistance[this._curDisappearIndex],this._curDisappearIndex>=(this._verticesCount+this._virtualVerticesCount)/2)&&(this._isDead=!0)},l._beforeRender=function(e){return this._camera=e.camera,null!=this._camera&&(this._owner._owner.transform.position.cloneTo(this._curPosition),!this._isDead)&&(this._verticesCount<this._maxVerticesCount?(this._owner._isStart||(this._owner._owner.transform.position.cloneTo(this._lastPosition),this._owner._isStart=!0),W.equals(this._lastPosition,this._curPosition)||this._updateTrail()):this._isFinish&&(this._isFinish=!1,this._owner._curSubTrailFinished=!0),0<this._verticesCount)&&(this._updateVertexBuffer2(),this._updateDisappear(),!0)},l._render=function(e){this._isDead||(c.mainContext.drawArrays(5,2*this._curDisappearIndex,this._verticesCount+this._virtualVerticesCount-2*this._curDisappearIndex),T.drawCall++,T.trianglesFaces+=this._verticesCount+this._virtualVerticesCount-2*this._curDisappearIndex-2)},l._getVertexBuffer=function(e){return 0===(e=void 0===e?0:e)?this._vertexBuffer1:1===e?this._vertexBuffer2:null},l._getVertexBuffers=function(){return this._vertexBuffers},l._getIndexBuffer=function(){return null},l.reActivate=function(){this._id=laya.d3.core.trail.TrailRenderElement.renderElementCount++,this._isStart=!1,this._isFinish=!1,this._isDead=!1,this._verticesCount=0,this._virtualVerticesCount=0,this._verticesIndex1=0,this._delLength=0,this._curDisappearIndex=0,this._everyGroupVertexBirthTime=[],this._owner._curSubTrailFinishPosition.cloneTo(this._lastPosition)},l._destroy=function(){this._vertexBuffer1.dispose(),this._vertexBuffer2.dispose(),this._vertices1=null,this._vertexBuffer1=null,this._vertices2=null,this._vertexBuffer2=null,this._vertexBuffers=null,this._everyGroupVertexBirthTime=null,this._VerticesToTailLength=null,this._everyVertexToPreVertexDistance=null,this._lastPosition=null,this._curPosition=null,this._delVector3=null,this._lastFixedVertexPosition=null,this._pointAtoBVector3=null,this._pointe=null,this._pointAtoBVector3e=null,this._pointA=null,this._pointB=null},n(0,l,"_vertexBufferCount",function(){return this._vertexBuffers.length}),n(0,l,"triangleCount",function(){return 0}),Ot.renderElementCount=0;var yt=Ot;function Ot(e){this._id=0,this._owner=null,this._camera=null,this._vertexBuffers=null,this._verticesCount=0,this._virtualVerticesCount=0,this._maxVerticesCount=256,this._vertices1=null,this._vertexBuffer1=null,this._floatCountPerVertices1=8,this._verticesIndex1=0,this._everyAddVerticeCount1=0,this._delLength=0,this._vertices2=null,this._vertexBuffer2=null,this._floatCountPerVertices2=1,this._everyGroupVertexBirthTime=null,this._VerticesToTailLength=null,this._everyVertexToPreVertexDistance=null,this._pointe=null,this._pointAtoBVector3e=null,this._isStart=!1,this._isFinish=!1,this._isDead=!1,this._curtime=NaN,this._curDisappearIndex=0,this._lastPosition=new W,this._curPosition=new W,this._delVector3=new W,this._lastFixedVertexPosition=new W,this._pointAtoBVector3=new W,this._pointA=new W,this._pointB=new W,this._owner=e,this._id=Ot.renderElementCount++,(0==this._id?e._owner.transform.position:e._curSubTrailFinishPosition).cloneTo(this._lastPosition),this._everyGroupVertexBirthTime=[],this._VerticesToTailLength=new Float32Array(this._maxVerticesCount),this._everyVertexToPreVertexDistance=new Float32Array(this._maxVerticesCount),this._vertices1=new Float32Array(this._maxVerticesCount*this._floatCountPerVertices1),this._vertices2=new Float32Array(this._maxVerticesCount*this._floatCountPerVertices2),this._vertexBuffer1=new Es(Nt.vertexDeclaration1,this._maxVerticesCount,35044,!0),this._vertexBuffer2=new Es(Nt.vertexDeclaration2,this._maxVerticesCount,35044,!0),this._vertexBuffers=[],this._vertexBuffers.push(this._vertexBuffer1),this._vertexBuffers.push(this._vertexBuffer2)}t(Vt,"laya.d3.core.trail.VertexTrail"),l=Vt.prototype,v.imps(l,{"laya.d3.graphics.IVertex":!0}),n(0,l,"vertexDeclaration",function(){return Vt._vertexDeclaration1}),n(1,Vt,"vertexDeclaration1",function(){return Vt._vertexDeclaration1}),n(1,Vt,"vertexDeclaration2",function(){return Vt._vertexDeclaration2}),e(Vt,["_vertexDeclaration1",function(){return this._vertexDeclaration1=new h(32,[new _(0,"vector3",0),new _(12,"vector3",41),new _(24,"single",33),new _(28,"single",40)])},"_vertexDeclaration2",function(){return this._vertexDeclaration2=new h(4,[new _(0,"single",38)])}]);var Nt=Vt;function Vt(){}t(Lt,"laya.d3.extension.domino.DominoKeyFrame");function Lt(){this.position=W.ZERO,this.rotation=$i.DEFAULT,this.scale=new W(.3,.6,.1)}t(Ft,"laya.d3.extension.domino.DominoRenderElement"),l=Ft.prototype,v.imps(l,{"laya.d3.core.render.IRenderable":!0}),l.addDomino=function(e,t,n){void 0===e&&(e=W.ZERO),void 0===t&&(t=$i.DEFAULT),void 0===n&&(n=W.ONE),this._curDominoCount++,this._owner.dominoCount++,this._owner.dominoPosition.push(e),this.addDataForVertexBuffer1(),this.addDataForVertexBuffer2(e,t,n),this.addDataForIndexBuffer()},l.updateDomino=function(e,t,n,i){void 0===t&&(t=W.ZERO),void 0===n&&(n=$i.DEFAULT),void 0===i&&(i=W.ONE),this._everyUpdateVerticeCount2=0;var r,a,o,s=this._perDominoVertexCount*this._floatCountPerVertices2*e,l=Eo._positions,h=Eo._normals,_=0,u=l.length;for(R.createAffineTransformation(t,n,i,this._localMatrix),_=0;_<u;_++)W.transformCoordinate(l[_],this._localMatrix,this._localPostion),o=(a=this._localPostion.elements)[0],r=a[1],a=a[2],this._vertices2[s+this._everyUpdateVerticeCount2++]=o,this._vertices2[s+this._everyUpdateVerticeCount2++]=r,this._vertices2[s+this._everyUpdateVerticeCount2++]=a,W.TransformNormal(h[_],this._localMatrix,this._localNormal),r=(o=this._localNormal.elements)[0],a=o[1],o=o[2],this._vertices2[s+this._everyUpdateVerticeCount2++]=r,this._vertices2[s+this._everyUpdateVerticeCount2++]=a,this._vertices2[s+this._everyUpdateVerticeCount2++]=o;this._vertexBuffer2.setData(this._vertices2,s,s,this._everyUpdateVerticeCount2)},l.updateDominos=function(e,t,n){this._everyUpdateVerticeCount2=0;for(var i,r,a,o,s=this._perDominoVertexCount*this._floatCountPerVertices2*e,l=Eo._positions,h=Eo._normals,_=0,u=0,d=l.length,_=0;_<t;_++)for(o=n[_],R.createAffineTransformation(o.position,o.rotation,o.scale,this._localMatrix),u=0;u<d;u++)W.transformCoordinate(l[u],this._localMatrix,this._localPostion),a=(r=this._localPostion.elements)[0],i=r[1],r=r[2],this._vertices2[s+this._everyUpdateVerticeCount2++]=a,this._vertices2[s+this._everyUpdateVerticeCount2++]=i,this._vertices2[s+this._everyUpdateVerticeCount2++]=r,W.TransformNormal(h[u],this._localMatrix,this._localNormal),i=(a=this._localNormal.elements)[0],r=a[1],a=a[2],this._vertices2[s+this._everyUpdateVerticeCount2++]=i,this._vertices2[s+this._everyUpdateVerticeCount2++]=r,this._vertices2[s+this._everyUpdateVerticeCount2++]=a;this._vertexBuffer2.setData(this._vertices2,s,s,this._everyUpdateVerticeCount2)},l.addDataForVertexBuffer1=function(){this._everyAddVerticeCount1=0,this.addDataForVertices1(this._topColor),this.addDataForVertices1(this._buttomColor),this.addDataForVertices1(this._leftColor),this.addDataForVertices1(this._rightColor),this.addDataForVertices1(this._frontColor),this.addDataForVertices1(this._backColor),this._vertexBuffer1.setData(this._vertices1,this._verticesIndex1,this._verticesIndex1,this._everyAddVerticeCount1),this._verticesIndex1+=this._everyAddVerticeCount1},l.addDataForVertexBuffer2=function(e,t,n){void 0===e&&(e=W.ZERO),void 0===t&&(t=$i.DEFAULT),void 0===n&&(n=W.ONE),this._everyAddVerticeCount2=0;var i,r,a,o=Eo._positions,s=Eo._normals,l=0,h=o.length;for(R.createAffineTransformation(e,t,n,this._localMatrix),l=0;l<h;l++)W.transformCoordinate(o[l],this._localMatrix,this._localPostion),a=(r=this._localPostion.elements)[0],i=r[1],r=r[2],this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=a,this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=i,this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=r,W.TransformNormal(s[l],this._localMatrix,this._localNormal),i=(a=this._localNormal.elements)[0],r=a[1],a=a[2],this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=i,this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=r,this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=a;this._vertexBuffer2.setData(this._vertices2,this._verticesIndex2,this._verticesIndex2,this._everyAddVerticeCount2),this._verticesIndex2+=this._everyAddVerticeCount2},l.addDataForIndexBuffer=function(){this._everyAddindiceCount=0,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+0,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+1,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+2,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+2,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+3,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+0,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+4,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+7,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+6,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+6,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+5,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+4,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+8,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+9,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+10,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+10,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+11,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+8,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+12,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+15,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+14,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+14,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+13,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+12,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+16,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+17,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+18,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+18,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+19,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+16,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+20,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+23,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+22,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+22,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+21,this._indices[this._indicesIndex+this._everyAddindiceCount++]=this._index+20,this._indexBuffer.setData(this._indices,this._indicesIndex,this._indicesIndex,this._everyAddindiceCount),this._indicesIndex+=this._everyAddindiceCount,this._index+=this._perDominoVertexCount},l.addDataForVertices1=function(e){for(var e=e.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=0;a<4;a++)this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=t,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=n,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=i,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=r},l._beforeRender=function(e){return this._indexBuffer._bind(),!0},l._render=function(e){c.mainContext.drawElements(4,this._indicesIndex,5123,0),T.drawCall++,T.trianglesFaces+=this._indicesIndex/3},l._getIndexBuffer=function(){return this._indexBuffer},l._getVertexBuffer=function(e){return 0===(e=void 0===e?0:e)?this._vertexBuffer1:1===e?this._vertexBuffer2:null},l._getVertexBuffers=function(){return this._vertexBuffers},l._getIndexBuffer=function(){return null},n(0,l,"_vertexBufferCount",function(){return this._vertexBuffers.length}),n(0,l,"triangleCount",function(){return this._indicesIndex/3}),Ft.renderElementCount=0;var wt=Ft;function Ft(e){this._owner=null,this.id=0,this._curDominoCount=0,this._perDominoVertexCount=24,this._perDominoIndiceCount=36,this._vertexBuffers=null,this._vertices1=null,this._vertexBuffer1=null,this._floatCountPerVertices1=4,this._verticesIndex1=0,this._everyAddVerticeCount1=0,this._vertices2=null,this._vertexBuffer2=null,this._floatCountPerVertices2=6,this._verticesIndex2=0,this._everyAddVerticeCount2=0,this._everyUpdateVerticeCount2=0,this._indices=null,this._indexBuffer=null,this._indicesIndex=0,this._everyAddindiceCount=0,this._index=0,this._color=new P(Math.random(),Math.random(),Math.random(),1),this._topColor=this._color,this._buttomColor=this._color,this._leftColor=this._color,this._rightColor=this._color,this._frontColor=this._color,this._backColor=this._color,this._localMatrix=new R,this._localPostion=new W,this._localNormal=new W,this._owner=e,this.id=Ft.renderElementCount++;e=this._owner.DominoRenderElementMaxDominoCount*this._perDominoVertexCount,this._vertices1=new Float32Array(e*this._floatCountPerVertices1),this._vertices2=new Float32Array(e*this._floatCountPerVertices2),this._vertexBuffer1=new Es(Pt.vertexDeclaration1,e,35044,!0),this._vertexBuffer2=new Es(Pt.vertexDeclaration2,e,35044,!0),this._vertexBuffers=[],this._vertexBuffers.push(this._vertexBuffer1),this._vertexBuffers.push(this._vertexBuffer2),e=this._owner.DominoRenderElementMaxDominoCount*this._perDominoIndiceCount;this._indices=new Uint16Array(e),this._indexBuffer=new ds("ushort",e,35044,!0)}t(bt,"laya.d3.extension.domino.DominoVertex"),l=bt.prototype,v.imps(l,{"laya.d3.graphics.IVertex":!0}),n(0,l,"vertexDeclaration",function(){return bt._vertexDeclaration1}),n(1,bt,"vertexDeclaration1",function(){return bt._vertexDeclaration1}),n(1,bt,"vertexDeclaration2",function(){return bt._vertexDeclaration2}),e(bt,["_vertexDeclaration1",function(){return this._vertexDeclaration1=new h(16,[new _(0,"vector4",1)])},"_vertexDeclaration2",function(){return this._vertexDeclaration2=new h(24,[new _(0,"vector3",0),new _(12,"vector3",3)])}]);var Pt=bt;function bt(){}t(Ut,"laya.d3.extension.lineRender.LineVertex"),n(0,Ut.prototype,"vertexDeclaration",function(){return Ut._vertexDeclaration1}),n(1,Ut,"vertexDeclaration1",function(){return Ut._vertexDeclaration1}),n(1,Ut,"vertexDeclaration2",function(){return Ut._vertexDeclaration2}),n(1,Ut,"vertexDeclaration3",function(){return Ut._vertexDeclaration3}),e(Ut,["_vertexDeclaration1",function(){return this._vertexDeclaration1=new h(16,[new _(0,"vector3",0),new _(12,"single",40)])},"_vertexDeclaration2",function(){return this._vertexDeclaration2=new h(12,[new _(0,"vector3",41)])},"_vertexDeclaration3",function(){return this._vertexDeclaration3=new h(8,[new _(0,"single",38),new _(4,"single",39)])}]);var Bt=Ut;function Ut(){}t(Gt,"laya.d3.graphics.DynamicBatch"),l=Gt.prototype,v.imps(l,{"laya.d3.core.render.IRenderable":!0}),l._getVertexBuffer=function(e){return 0===(e=void 0===e?0:e)?this._vertexBuffer:null},l._getIndexBuffer=function(){return this._indexBuffer},l._getCombineRenderElementFromPool=function(e,t,n){var i=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return i||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=i=new lt,i._sprite3D=new Fl),i._sprite3D._render._renderUpdate(n),i},l._getRenderElement=function(e,t,n){this._vertexDatas||(this._vertexDatas=new Float32Array(this._vertexDeclaration.vertexStride/4*Gt.maxVertexCount),this._indexDatas=new Uint16Array(Gt.maxIndexCount),this._vertexBuffer=Es.create(this._vertexDeclaration,Gt.maxVertexCount,35048),this._indexBuffer=ds.create("ushort",Gt.maxIndexCount,35048));for(var i=this._merageElements.length=0,r=0,a=0,o=this._combineRenderElements.length;a<o;a++){var s=this._combineRenderElements[a],l=s.getDynamicBatchBakedVertexs(0),h=s.getBakedIndices(),_=s._sprite3D.transform._isFrontFaceInvert,u=i/(this._vertexDeclaration.vertexStride/4),d=r,c=d+h.length,f=(s._tempBatchIndexStart=d,s._tempBatchIndexEnd=c,this._indexDatas.set(h,r),0);if(_)for(f=d;f<c;f+=3){this._indexDatas[f]=u+this._indexDatas[f];var m=this._indexDatas[f+1],p=this._indexDatas[f+2];this._indexDatas[f+1]=u+p,this._indexDatas[f+2]=u+m}else for(f=d;f<c;f+=3)this._indexDatas[f]=u+this._indexDatas[f],this._indexDatas[f+1]=u+this._indexDatas[f+1],this._indexDatas[f+2]=u+this._indexDatas[f+2];r+=h.length,this._vertexDatas.set(l,i),i+=l.length}for(this._vertexBuffer.setData(this._vertexDatas),this._indexBuffer.setData(this._indexDatas),a=this._combineRenderElementPoolIndex=0,o=this._materials.length;a<o;a++){var E=this._getCombineRenderElementFromPool(e,t,n),g=(E._type=2,E._staticBatch=null,(E.renderObj=this)._combineRenderElements[this._materialToRenderElementsOffsets[a]]._tempBatchIndexStart),v=a+1===this._materialToRenderElementsOffsets.length?r:this._combineRenderElements[this._materialToRenderElementsOffsets[a+1]]._tempBatchIndexStart;E._tempBatchIndexStart=g,E._tempBatchIndexEnd=v,E._material=this._materials[a],this._merageElements.push(E)}},l._addCombineRenderObjTest=function(e){var e=e.renderObj,t=this._currentCombineIndexCount+e._getIndexBuffer().indexCount,e=this._currentCombineVertexCount+e._getVertexBuffer().vertexCount;return!(Gt.maxVertexCount<e||Gt.maxIndexCount<t)},l._addCombineRenderObj=function(e){var t=e.renderObj;this._combineRenderElements.push(e),this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount},l._addCombineMaterial=function(e){this._materials.push(e)},l._addMaterialToRenderElementOffset=function(e){this._materialToRenderElementsOffsets.push(e)},l._clearRenderElements=function(){this._combineRenderElements.length=0,this._materials.length=0,this._materialToRenderElementsOffsets.length=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0},l._addToRenderQueue=function(e,t,n,i){this._getRenderElement(t,n,i);for(var r=0,a=this._materials.length;r<a;r++)e.getRenderQueue(this._materials[r].renderQueue)._addDynamicBatchElement(this._merageElements[r])},l._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},l._render=function(e){var t=e._batchIndexEnd-e._batchIndexStart;c.mainContext.drawElements(4,t,5123,2*e._batchIndexStart),T.drawCall++,T.trianglesFaces+=t/3},l._getVertexBuffers=function(){return null},n(0,l,"_vertexBufferCount",function(){return 1}),n(0,l,"triangleCount",function(){return this._indexBuffer.indexCount/3}),n(0,l,"combineRenderElementsCount",function(){return this._combineRenderElements.length}),Gt.maxVertexCount=2e4,Gt.maxIndexCount=4e4,Gt.maxCombineTriangleCount=10;var Ht=Gt;function Gt(e){this._vertexDeclaration=null,this._vertexDatas=null,this._indexDatas=null,this._vertexBuffer=null,this._indexBuffer=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=null,this._materials=null,this._materialToRenderElementsOffsets=null,this._merageElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=[],this._materialToRenderElementsOffsets=[],this._materials=[],this._merageElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._vertexDeclaration=e}t(Wt,"laya.d3.graphics.DynamicBatchManager"),(l=Wt.prototype).getDynamicBatch=function(e,t){var n,t=e.id.toString()+t;return this._dynamicBatches[t]?n=this._dynamicBatches[t]:this._dynamicBatches[t]=n=new Ht(e),n},l._garbageCollection=function(){for(var e in this._dynamicBatches)0===this._dynamicBatches[e].combineRenderElementsCount&&delete this._dynamicBatches[e]},l._addPrepareRenderElement=function(e){this._prepareDynamicBatchCombineElements.push(e)},l._finishCombineDynamicBatch=function(e){this._prepareDynamicBatchCombineElements.sort(Wt._sortPrepareDynamicBatch);for(var t,n,i,r,a,o=-1,s=!0,l=0,h=-1,_=0,u=this._prepareDynamicBatchCombineElements.length;_<u;_++){var d,c,f=(d=this._prepareDynamicBatchCombineElements[_]).renderObj._getVertexBuffer(0).vertexDeclaration,m=n!==f,p=(m&&(l=0,n=f),l!==o);p&&(o=l),(m||p)&&(i=this.getDynamicBatch(f,l),t=null),s?s=i._addCombineRenderObjTest(d)?(t!==(c=d._material)?(r&&(e.getRenderQueue(a._material.renderQueue)._addRenderElement(a),a=r=null,h=-1),r=c,h=i.combineRenderElementsCount,a=d,t=c):r?(m=a.renderObj,p=d.renderObj,m._getVertexBuffer().vertexCount+p._getVertexBuffer().vertexCount>Ht.maxVertexCount||m._getIndexBuffer().indexCount+p._getIndexBuffer().indexCount>Ht.maxIndexCount?(e.getRenderQueue(a._material.renderQueue)._addRenderElement(a),r=c,h=i.combineRenderElementsCount,a=d):(i._addCombineMaterial(r),i._addMaterialToRenderElementOffset(h),i._addCombineRenderObj(a),a=r=null,h=-1,i._addCombineRenderObj(d))):i._addCombineRenderObj(d),!0):(r&&(e.getRenderQueue(a._material.renderQueue)._addRenderElement(a),a=r=null,h=-1),l++,!1):(f=this._prepareDynamicBatchCombineElements[_-1],i._addMaterialToRenderElementOffset(i.combineRenderElementsCount),t=f._material,i._addCombineMaterial(t),i._addCombineRenderObj(f),s=!0,t!==(c=d._material)?(r=c,h=i.combineRenderElementsCount,a=d):i._addCombineRenderObj(d),t=c)}r&&(e.getRenderQueue(a._material.renderQueue)._addRenderElement(a),a=r=null,h=-1),this._prepareDynamicBatchCombineElements.length=0},l._clearRenderElements=function(){for(var e in this._dynamicBatches)this._dynamicBatches[e]._clearRenderElements()},l._addToRenderQueue=function(e,t,n,i){for(var r in this._dynamicBatches){r=this._dynamicBatches[r];0<r.combineRenderElementsCount&&r._addToRenderQueue(e,t,n,i)}},l.dispose=function(){this._dynamicBatches=null},Wt._sortPrepareDynamicBatch=function(e,t){return e._mainSortID-t._mainSortID};var zt=Wt;function Wt(){this._dynamicBatches=null,this._prepareDynamicBatchCombineElements=null,this._dynamicBatches={},this._prepareDynamicBatchCombineElements=[]}t(Xt,"laya.d3.graphics.FrustumCulling"),Xt.renderShadowObjectCulling=function(e,t,n,i,r){for(var a=0,o=0,s=0,l=0,a=0,s=n.length;a<s;a++){var h=n[a];h&&h._clearRenderElements()}var _,u,d,c=e._cullingRenders;if(1<r){for(a=0,s=e._cullingRendersLength;a<s;a++)if((_=c[a]).castShadow&&Se.isVisible(_._owner.layer.mask)&&_.enable)for(var f=1,m=t.length;f<m;f++)if(u=n[f-1],0!==t[f].containsBoundSphere(_.boundingSphere))for(o=0,l=(d=_._renderElements).length;o<l;o++)u._addRenderElement(d[o])}else for(a=0,s=e._cullingRendersLength;a<s;a++)if((_=c[a]).castShadow&&Se.isVisible(_._owner.layer.mask)&&_.enable&&0!==t[0].containsBoundSphere(_.boundingSphere))for(_._renderUpdate(i),u=n[0],o=0,l=(d=_._renderElements).length;o<l;o++)u._addRenderElement(d[o])},Xt.renderShadowObjectCullingOctree=function(e,t,n,i,r){for(var a=0,o=n.length;a<o;a++){var s=n[a];s&&s._clearRenderElements()}1<r?e.treeRoot.cullingShadowObjects(t,n,!0,0,e):e.treeRoot.cullingShadowObjectsOnePSSM(t[0],n,i,!0,0,e)},Xt.renderObjectCulling=function(e,t,n,i,r,a){for(var o=0,s=0,l=0,h=t._quenes,_=t._dynamicBatchManager,u=t._cullingRenders,o=0,s=h.length;o<s;o++){var d=h[o];d&&d._clearRenderElements()}var c=Yt._staticBatchManagers;for(o=0,s=c.length;o<s;o++)c[o]._clearRenderElements();_._clearRenderElements();var f=n.transform.position;for(o=0,s=t._cullingRendersLength;o<s;o++){var m=u[o];if(Se.isVisible(m._owner.layer.mask)&&m.enable&&0!==e.containsBoundSphere(m.boundingSphere)&&m._renderUpdate(a)){m._distanceForSort=W.distance(m.boundingSphere.center,f)+m.sortingFudge;for(var p=m._renderElements,l=0,E=p.length;l<E;l++){var g=p[l],v=g._staticBatch;v&&v._material===g._material?v._addBatchRenderElement(g):(v=g.renderObj).triangleCount<10&&1===v._vertexBufferCount&&v._getIndexBuffer()&&g._material.renderQueue<2&&g._canDynamicBatch&&!m._owner.isStatic?_._addPrepareRenderElement(g):t.getRenderQueue(g._material.renderQueue)._addRenderElement(g)}}}for(o=0,s=c.length;o<s;o++)c[o]._addToRenderQueue(t,i,r,a);_._finishCombineDynamicBatch(t),_._addToRenderQueue(t,i,r,a)},Xt.renderObjectCullingOctree=function(e,t,n,i,r,a){for(var o=0,s=0,l=t._quenes,h=t._dynamicBatchManager,o=0,s=l.length;o<s;o++){var _=l[o];_&&_._clearRenderElements()}var u=Yt._staticBatchManagers;for(o=0,s=u.length;o<s;o++)u[o]._clearRenderElements();for(h._clearRenderElements(),t._cullingRenders.length=0,t.treeRoot.cullingObjects(e,!0,0,n.transform.position,a),o=0,s=u.length;o<s;o++)u[o]._addToRenderQueue(t,i,r,a);h._finishCombineDynamicBatch(t),h._addToRenderQueue(t,i,r,a)},Xt.renderObjectCullingNoBoundFrustum=function(e,t,n,i,r){for(var a=0,o=0,s=0,l=e._quenes,h=e._dynamicBatchManager,_=e._cullingRenders,a=0,o=l.length;a<o;a++){var u=l[a];u&&u._clearRenderElements()}var d=Yt._staticBatchManagers;for(a=0,o=d.length;a<o;a++)d[a]._clearRenderElements();h._clearRenderElements();var c=t.transform.position;for(a=0,o=e._cullingRendersLength;a<o;a++){var f=_[a];if(Se.isVisible(f._owner.layer.mask)&&f.enable){f._renderUpdate(r),f._distanceForSort=W.distance(f.boundingSphere.center,c)+f.sortingFudge;for(var m=f._renderElements,s=0,p=m.length;s<p;s++){var E=m[s],g=E._staticBatch;g&&g._material===E._material?g._addBatchRenderElement(E):(g=E.renderObj).triangleCount<10&&1===g._vertexBufferCount&&g._getIndexBuffer()&&E._material.renderQueue<2&&E._canDynamicBatch&&!f._owner.isStatic?h._addPrepareRenderElement(E):e.getRenderQueue(E._material.renderQueue)._addRenderElement(E)}}}for(a=0,o=d.length;a<o;a++)d[a]._addToRenderQueue(e,n,i,r);h._finishCombineDynamicBatch(e),h._addToRenderQueue(e,n,i,r)};var kt=Xt;function Xt(){}t(Zt,"laya.d3.graphics.StaticBatchManager"),(l=Zt.prototype)._finishInit=function(){for(var e in this._staticBatches)this._staticBatches[e]._finishInit();this._initBatchRenderElements.length=0},l._initStaticBatchs=function(e){throw new Error("StaticBatchManager:must override this function.")},l._addInitBatchSprite=function(e){for(var t=e._render._renderElements,n=0,i=t.length;n<i;n++)this._initBatchRenderElements.push(t[n])},l._clearRenderElements=function(){for(var e in this._staticBatches)this._staticBatches[e]._clearRenderElements()},l._garbageCollection=function(e){var t=e._staticBatch,n=t._initBatchRenderElements,e=n.indexOf(e);n.splice(e,1),0===n.length&&(t.dispose(),delete this._staticBatches[t._key])},l._addToRenderQueue=function(e,t,n,i){for(var r in this._staticBatches){r=this._staticBatches[r];0<r._batchRenderElements.length&&r._updateToRenderQueue(e,i)}},l.dispose=function(){this._staticBatches=null},Zt._addToStaticBatchQueue=function(e){e instanceof laya.d3.core.RenderableSprite3D&&e._addToInitStaticBatchManager();for(var t=0,n=e.numChildren;t<n;t++)Zt._addToStaticBatchQueue(e._childs[t])},Zt.combine=function(e,t){var n,i=0,r=0;if(t)for(i=0,r=t.length;i<r;i++)t[i]._addToInitStaticBatchManager();else e&&Zt._addToStaticBatchQueue(e);for(i=0,r=Zt._staticBatchManagers.length;i<r;i++)(n=Zt._staticBatchManagers[i])._initStaticBatchs(e),n._finishInit()},Zt._staticBatchManagers=[];var Yt=Zt;function Zt(){this._initBatchRenderElements=null,this._staticBatches=null,this._initBatchRenderElements=[],this._staticBatches={}}t(jt,"laya.d3.graphics.StaticBatch"),l=jt.prototype,v.imps(l,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),l._binarySearch=function(e){for(var t,n=0,i=this._batchRenderElements.length-1;n<=i;)t=Math.floor((n+i)/2),this._compareBatchRenderElement(this._batchRenderElements[t],e)?i=t-1:n=t+1;return n},l._compareBatchRenderElement=function(e,t){throw new Error("StaticBatch:must override this function.")},l._getVertexDecLightMap=function(e){return e===hi.vertexDeclaration?Jn.vertexDeclaration:e===si.vertexDeclaration?Qn.vertexDeclaration:e===Un.vertexDeclaration?yn.vertexDeclaration:e===Ei.vertexDeclaration?null:e===vn.vertexDeclaration?Sn.vertexDeclaration:e===ci.vertexDeclaration?ii.vertexDeclaration:e===Zn.vertexDeclaration?Kn.vertexDeclaration:e===ui.vertexDeclaration?ti.vertexDeclaration:e===si.vertexDeclaration?Qn.vertexDeclaration:e===Gn.vertexDeclaration?Nn.vertexDeclaration:e===Ei.vertexDeclaration?null:e===vn.vertexDeclaration?Sn.vertexDeclaration:e===mi.vertexDeclaration?ai.vertexDeclaration:e===Zn.vertexDeclaration?Kn.vertexDeclaration:e},l._getCombineRenderElementFromPool=function(){throw new Error("StaticBatch:must override this function.")},l._addBatchRenderElement=function(e){this._batchRenderElements.splice(this._binarySearch(e),0,e)},l._updateToRenderQueue=function(e,t){this._combineRenderElementPoolIndex=0,this._getRenderElement(e.getRenderQueue(this._material.renderQueue)._renderElements,e,t)},l._getRenderElement=function(e,t,n){throw new Error("StaticBatch:must override this function.")},l._finishInit=function(){throw new Error("StaticBatch:must override this function.")},l._clearRenderElements=function(){this._batchRenderElements.length=0},l.dispose=function(){},l._getVertexBuffer=function(e){return void 0===e&&(e=0),null},l._getIndexBuffer=function(){return null},l._beforeRender=function(e){return!0},l._render=function(e){},l._getVertexBuffers=function(){return null},n(0,l,"_vertexBufferCount",function(){return 1}),n(0,l,"triangleCount",function(){return 0}),jt.combine=function(e){console.log("StaticBatch: discard property,please use StaticBatchManager.combine() function instead."),Yt.combine(e)},jt.maxBatchVertexCount=65535;var l=jt;function jt(e,t,n){this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=null,this._initBatchRenderElements=null,this._batchRenderElements=null,this._material=null,this._rootOwner=null,this._key=null,this._manager=null,this._key=e,this._manager=t,this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=[],this._initBatchRenderElements=[],this._batchRenderElements=[],this._rootOwner=n}t(Kt,"laya.d3.graphics.VertexDeclaration"),(u=Kt.prototype)._addShaderDefine=function(e){this._shaderDefineValue|=e},u._removeShaderDefine=function(e){this._shaderDefineValue&=~e},u.getVertexElements=function(){return this._vertexElements.slice()},u.getVertexElementByUsage=function(e){return this._vertexElementsDic[e]},u.unBinding=function(){},n(0,u,"shaderDefineValue",function(){return this._shaderDefineValue}),n(0,u,"id",function(){return this._id}),n(0,u,"vertexStride",function(){return this._vertexStride}),n(0,u,"shaderValues",function(){return this._shaderValues}),Kt._getTypeSize=function(e){switch(e){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"color":case"byte4":case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},Kt.getVertexStride=function(e){for(var t=0,n=0;n<e.Length;n++){var i=e[n],i=i.offset+Kt._getTypeSize(i.elementFormat);t<i&&(t=i)}return t},Kt._maxVertexDeclarationBit=1e3,Kt._uniqueIDCounter=1,e(Kt,["maxVertexDeclaration",function(){return this.maxVertexDeclaration=2147483647-1e3*Math.floor(2147483.647)}]);var h=Kt;function Kt(e,t){if(this._id=0,this._shaderValues=null,this._shaderDefineValue=0,this._vertexStride=0,this._vertexElements=null,this._vertexElementsDic=null,this._id=++Kt._uniqueIDCounter,this._id>Kt.maxVertexDeclaration)throw new Error("VertexDeclaration: VertexDeclaration count should not large than ",Kt.maxVertexDeclaration);this._shaderValues=new gr,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t;for(var n=0;n<t.length;n++){var i=t[n],r=i.elementUsage,i=(this._vertexElementsDic[r]=i,[Kt._getTypeSize(i.elementFormat)/4,5126,!1,this._vertexStride,i.offset]);switch(this._shaderValues.setValue(r,i),r){case 1:this._addShaderDefine(g.SHADERDEFINE_COLOR);break;case 2:this._addShaderDefine(g.SHADERDEFINE_UV0);break;case 15:this._addShaderDefine(g.SHADERDEFINE_UV1)}}}t(qt,"laya.d3.graphics.VertexElement");var _=qt;function qt(e,t,n){this.offset=0,this.elementFormat=null,this.elementUsage=0,this.offset=e,this.elementFormat=t,this.elementUsage=n}t(Qt,"laya.d3.graphics.VertexElementFormat"),Qt.Single="single",Qt.Vector2="vector2",Qt.Vector3="vector3",Qt.Vector4="vector4",Qt.Color="color",Qt.Byte4="byte4",Qt.Short2="short2",Qt.Short4="short4",Qt.NormalizedShort2="normalizedshort2",Qt.NormalizedShort4="normalizedshort4",Qt.HalfVector2="halfvector2",Qt.HalfVector4="halfvector4";function Qt(){}t($t,"laya.d3.graphics.VertexElementUsage"),$t.POSITION0=0,$t.COLOR0=1,$t.TEXTURECOORDINATE0=2,$t.NORMAL0=3,$t.BINORMAL0=4,$t.TANGENT0=5,$t.BLENDINDICES0=6,$t.BLENDWEIGHT0=7,$t.DEPTH0=8,$t.FOG0=9,$t.POINTSIZE0=10,$t.SAMPLE0=11,$t.TESSELLATEFACTOR0=12,$t.COLOR1=13,$t.NEXTTEXTURECOORDINATE0=14,$t.TEXTURECOORDINATE1=15,$t.NEXTTEXTURECOORDINATE1=16,$t.CORNERTEXTURECOORDINATE0=17,$t.VELOCITY0=18,$t.STARTCOLOR0=19,$t.STARTSIZE=20,$t.AGEADDSCALE0=21,$t.STARTROTATION=22,$t.ENDCOLOR0=23,$t.STARTLIFETIME=24,$t.TIME0=33,$t.SHAPEPOSITIONSTARTLIFETIME=30,$t.DIRECTIONTIME=32,$t.SIZEROTATION0=27,$t.RADIUS0=28,$t.RADIAN0=29,$t.STARTSPEED=31,$t.RANDOM0=34,$t.RANDOM1=35,$t.SIMULATIONWORLDPOSTION=36,$t.SIMULATIONWORLDROTATION=37,$t.TEXTURECOORDINATE0X=38,$t.TEXTURECOORDINATE0X1=39,$t.TEXTURECOORDINATE0Y=40,$t.OFFSETVECTOR=41;function $t(){}t(en,"laya.d3.graphics.VertexGlitter"),u=en.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate0}),n(0,u,"position",function(){return this._position}),n(0,u,"time",function(){return this._time}),n(0,u,"vertexDeclaration",function(){return en._vertexDeclaration}),n(1,en,"vertexDeclaration",function(){return en._vertexDeclaration}),e(en,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(24,[new _(0,"vector3",0),new _(12,"vector2",2),new _(20,"single",33)])}]);var Jt=en;function en(e,t,n){this._position=null,this._textureCoordinate0=null,this._time=NaN,this._position=e,this._textureCoordinate0=t,this._time=n}t(tn,"laya.d3.graphics.VertexParticle"),u=tn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"endColor",function(){return this._endColor}),n(0,u,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),n(0,u,"sizeRotation",function(){return this._sizeRotation}),n(0,u,"velocity",function(){return this._velocity}),n(0,u,"position",function(){return this._position}),n(0,u,"startColor",function(){return this._startColor}),n(0,u,"radius",function(){return this._radius}),n(0,u,"radian",function(){return this._radian}),n(0,u,"ageAddScale",function(){return this._ageAddScale}),n(0,u,"time",function(){return this._time}),n(0,u,"vertexDeclaration",function(){return tn._vertexDeclaration}),n(1,tn,"vertexDeclaration",function(){return tn._vertexDeclaration}),e(tn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(116,[new _(0,"vector4",17),new _(16,"vector3",0),new _(28,"vector3",18),new _(40,"vector4",19),new _(56,"vector4",23),new _(72,"vector3",27),new _(84,"vector2",28),new _(92,"vector4",29),new _(108,"single",24),new _(112,"single",33)])}]);function tn(e,t,n,i,r,a,o,s,l,h){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._endColor=null,this._sizeRotation=null,this._radius=null,this._radian=null,this._ageAddScale=NaN,this._time=NaN,this._cornerTextureCoordinate=e,this._position=t,this._velocity=n,this._startColor=i,this._endColor=r,this._sizeRotation=a,this._radius=o,this._radian=s,this._ageAddScale=l,this._time=h}t(rn,"laya.d3.graphics.VertexPosition"),u=rn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"position",function(){return this._position}),n(0,u,"vertexDeclaration",function(){return rn._vertexDeclaration}),n(1,rn,"vertexDeclaration",function(){return rn._vertexDeclaration}),e(rn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(12,[new _(0,"vector3",0)])}]);var nn=rn;function rn(e){this._position=null,this._position=e}t(on,"laya.d3.graphics.VertexPositionNormal"),u=on.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"vertexDeclaration",function(){return on._vertexDeclaration}),n(1,on,"vertexDeclaration",function(){return on._vertexDeclaration}),e(on,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(24,[new _(0,"vector3",0),new _(12,"vector3",3)])}]);var an=on;function on(e,t){this._position=null,this._normal=null,this._position=e,this._normal=t}t(ln,"laya.d3.graphics.VertexPositionNormalColor"),u=ln.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"color",function(){return this._color}),n(0,u,"vertexDeclaration",function(){return ln._vertexDeclaration}),n(1,ln,"vertexDeclaration",function(){return ln._vertexDeclaration}),e(ln,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(40,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1)])}]);var sn=ln;function ln(e,t,n){this._position=null,this._normal=null,this._color=null,this._position=e,this._normal=t,this._color=n}t(_n,"laya.d3.graphics.VertexPositionNormalColorSkin"),u=_n.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"color",function(){return this._color}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"vertexDeclaration",function(){return _n._vertexDeclaration}),n(1,_n,"vertexDeclaration",function(){return _n._vertexDeclaration}),e(_n,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(72,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector4",7),new _(56,"vector4",6)])}]);var hn=_n;function _n(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._blendIndex=i,this._blendWeight=r}t(dn,"laya.d3.graphics.VertexPositionNormalColorSkinSTangent"),u=dn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"color",function(){return this._color}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"vertexDeclaration",function(){return dn._vertexDeclaration}),n(1,dn,"vertexDeclaration",function(){return dn._vertexDeclaration}),e(dn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(88,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector4",7),new _(56,"vector4",6),new _(72,"vector4",5)])}]);var un=dn;function dn(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}t(fn,"laya.d3.graphics.VertexPositionNormalColorSkinTangent"),u=fn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"color",function(){return this._color}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"vertexDeclaration",function(){return fn._vertexDeclaration}),n(1,fn,"vertexDeclaration",function(){return fn._vertexDeclaration}),e(fn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(84,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector4",7),new _(56,"vector4",6),new _(72,"vector3",5)])}]);var cn=fn;function fn(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}t(pn,"laya.d3.graphics.VertexPositionNormalColorSTangent"),u=pn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"color",function(){return this._color}),n(0,u,"vertexDeclaration",function(){return pn._vertexDeclaration}),n(1,pn,"vertexDeclaration",function(){return pn._vertexDeclaration}),e(pn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(56,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector4",5)])}]);var mn=pn;function pn(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i}t(gn,"laya.d3.graphics.VertexPositionNormalColorTangent"),u=gn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"color",function(){return this._color}),n(0,u,"vertexDeclaration",function(){return gn._vertexDeclaration}),n(1,gn,"vertexDeclaration",function(){return gn._vertexDeclaration}),e(gn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(52,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector3",5)])}]);var En=gn;function gn(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i}t(Tn,"laya.d3.graphics.VertexPositionNormalColorTexture"),u=Tn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"color",function(){return this._color}),n(0,u,"vertexDeclaration",function(){return Tn._vertexDeclaration}),n(1,Tn,"vertexDeclaration",function(){return Tn._vertexDeclaration}),e(Tn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(48,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2)])}]);var vn=Tn;function Tn(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i}t(Dn,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1"),u=Dn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"color",function(){return this._color}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return Dn._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(1,Dn,"vertexDeclaration",function(){return Dn._vertexDeclaration}),e(Dn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(56,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector2",15)])}]);var Sn=Dn;function Dn(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r}t(Mn,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin"),u=Mn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"color",function(){return this._color}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return Mn._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(1,Mn,"vertexDeclaration",function(){return Mn._vertexDeclaration}),e(Mn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(88,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector2",15),new _(56,"vector4",7),new _(72,"vector4",6)])}]);var xn=Mn;function Mn(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=o}t(In,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinSTangent"),u=In.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"color",function(){return this._color}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return In._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(1,In,"vertexDeclaration",function(){return In._vertexDeclaration}),e(In,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(104,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector2",15),new _(56,"vector4",7),new _(72,"vector4",6),new _(88,"vector4",5)])}]);var Rn=In;function In(e,t,n,i,r,a,o,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=o,this._blendWeight=s}t(Cn,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent"),u=Cn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),u.VertexPositionNormalColorTexture0SkinTangent=function(e,t,n,i,r,a,o,s){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=o,this._blendWeight=s},n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"color",function(){return this._color}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return Cn._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(1,Cn,"vertexDeclaration",function(){return Cn._vertexDeclaration}),e(Cn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(100,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector2",15),new _(56,"vector4",7),new _(72,"vector4",6),new _(88,"vector3",5)])}]);var An=Cn;function Cn(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}t(On,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1STangent"),u=On.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"color",function(){return this._color}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return On._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(1,On,"vertexDeclaration",function(){return On._vertexDeclaration}),e(On,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(72,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector2",15),new _(56,"vector4",5)])}]);var yn=On;function On(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a}t(Vn,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent"),u=Vn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),u.VertexPositionNormalColorTexture0Tangent=function(e,t,n,i,r,a){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a},n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"color",function(){return this._color}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return Vn._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(1,Vn,"vertexDeclaration",function(){return Vn._vertexDeclaration}),e(Vn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(68,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector2",15),new _(56,"vector3",5)])}]);var Nn=Vn;function Vn(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}t(wn,"laya.d3.graphics.VertexPositionNormalColorTextureSkin"),u=wn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"color",function(){return this._color}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"vertexDeclaration",function(){return wn._vertexDeclaration}),n(1,wn,"vertexDeclaration",function(){return wn._vertexDeclaration}),e(wn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(80,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector4",7),new _(64,"vector4",6)])}]);var Ln=wn;function wn(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._blendIndex=r,this._blendWeight=a}t(Pn,"laya.d3.graphics.VertexPositionNormalColorTextureSkinSTangent"),u=Pn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"color",function(){return this._color}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"vertexDeclaration",function(){return Pn._vertexDeclaration}),n(1,Pn,"vertexDeclaration",function(){return Pn._vertexDeclaration}),e(Pn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(96,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector4",7),new _(64,"vector4",6),new _(80,"vector4",5)])}]);var Fn=Pn;function Pn(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o}t(Bn,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent"),u=Bn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"color",function(){return this._color}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"vertexDeclaration",function(){return Bn._vertexDeclaration}),n(1,Bn,"vertexDeclaration",function(){return Bn._vertexDeclaration}),e(Bn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(92,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector4",7),new _(64,"vector4",6),new _(80,"vector3",5)])}]);var bn=Bn;function Bn(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o}t(Hn,"laya.d3.graphics.VertexPositionNormalColorTextureSTangent"),u=Hn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"color",function(){return this._color}),n(0,u,"vertexDeclaration",function(){return Hn._vertexDeclaration}),n(1,Hn,"vertexDeclaration",function(){return Hn._vertexDeclaration}),e(Hn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(64,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector4",5)])}]);var Un=Hn;function Hn(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r}t(zn,"laya.d3.graphics.VertexPositionNormalColorTextureTangent"),u=zn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"color",function(){return this._color}),n(0,u,"vertexDeclaration",function(){return zn._vertexDeclaration}),n(1,zn,"vertexDeclaration",function(){return zn._vertexDeclaration}),e(zn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(60,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",1),new _(40,"vector2",2),new _(48,"vector3",5)])}]);var Gn=zn;function zn(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r}t(kn,"laya.d3.graphics.VertexPositionNormalSTangent"),u=kn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"vertexDeclaration",function(){return kn._vertexDeclaration}),n(1,kn,"vertexDeclaration",function(){return kn._vertexDeclaration}),e(kn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(40,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector4",5)])}]);var Wn=kn;function kn(e,t,n){this._position=null,this._normal=null,this._tangent=null,this._position=e,this._normal=t,this._tangent=n}t(Yn,"laya.d3.graphics.VertexPositionNormalTangent"),u=Yn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"vertexDeclaration",function(){return Yn._vertexDeclaration}),n(1,Yn,"vertexDeclaration",function(){return Yn._vertexDeclaration}),e(Yn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(36,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector3",5)])}]);var Xn=Yn;function Yn(e,t,n){this._position=null,this._normal=null,this._tangent=null,this._position=e,this._normal=t,this._tangent=n}t(jn,"laya.d3.graphics.VertexPositionNormalTexture"),u=jn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"vertexDeclaration",function(){return jn._vertexDeclaration}),n(1,jn,"vertexDeclaration",function(){return jn._vertexDeclaration}),e(jn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(32,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2)])}]);var Zn=jn;function jn(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}t(qn,"laya.d3.graphics.VertexPositionNormalTexture0Texture1"),u=qn.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return qn._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(1,qn,"vertexDeclaration",function(){return qn._vertexDeclaration}),e(qn,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(40,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector2",15)])}]);var Kn=qn;function qn(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i}t($n,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin"),u=$n.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return $n._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(1,$n,"vertexDeclaration",function(){return $n._vertexDeclaration}),e($n,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(72,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector2",15),new _(40,"vector4",7),new _(56,"vector4",6)])}]);var Qn=$n;function $n(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._blendIndex=r,this._blendWeight=a}t(ei,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinSTangent"),u=ei.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return ei._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(1,ei,"vertexDeclaration",function(){return ei._vertexDeclaration}),e(ei,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(88,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector2",15),new _(40,"vector4",7),new _(56,"vector4",6),new _(72,"vector4",5)])}]);var Jn=ei;function ei(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o}t(ni,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent"),u=ni.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),u.VertexPositionNormalTexture0SkinTangent=function(e,t,n,i,r,a,o){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o},n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return ni._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(1,ni,"vertexDeclaration",function(){return ni._vertexDeclaration}),e(ni,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(84,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector2",15),new _(40,"vector4",7),new _(56,"vector4",6),new _(72,"vector3",5)])}]);var ti=ni;function ni(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}t(ri,"laya.d3.graphics.VertexPositionNormalTexture0Texture1STangent"),u=ri.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return ri._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(1,ri,"vertexDeclaration",function(){return ri._vertexDeclaration}),e(ri,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(56,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector2",15),new _(40,"vector4",5)])}]);var ii=ri;function ri(e,t,n,i,r){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r}t(oi,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent"),u=oi.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),u.VertexPositionNormalTexture0Tangent=function(e,t,n,i,r){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r},n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return oi._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(1,oi,"vertexDeclaration",function(){return oi._vertexDeclaration}),e(oi,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(52,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector2",15),new _(40,"vector3",5)])}]);var ai=oi;function oi(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}t(li,"laya.d3.graphics.VertexPositionNormalTextureSkin"),u=li.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"vertexDeclaration",function(){return li._vertexDeclaration}),n(1,li,"vertexDeclaration",function(){return li._vertexDeclaration}),e(li,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(64,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector4",7),new _(48,"vector4",6)])}]);var si=li;function li(e,t,n,i,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._blendIndex=i,this._blendWeight=r}t(_i,"laya.d3.graphics.VertexPositionNormalTextureSkinSTangent"),u=_i.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"vertexDeclaration",function(){return _i._vertexDeclaration}),n(1,_i,"vertexDeclaration",function(){return _i._vertexDeclaration}),e(_i,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(80,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector4",7),new _(48,"vector4",6),new _(64,"vector4",5)])}]);var hi=_i;function _i(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}t(di,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent"),u=di.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(0,u,"vertexDeclaration",function(){return di._vertexDeclaration}),n(1,di,"vertexDeclaration",function(){return di._vertexDeclaration}),e(di,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(76,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector4",7),new _(48,"vector4",6),new _(64,"vector3",5)])}]);var ui=di;function di(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}t(fi,"laya.d3.graphics.VertexPositionNormalTextureSTangent"),u=fi.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"vertexDeclaration",function(){return fi._vertexDeclaration}),n(1,fi,"vertexDeclaration",function(){return fi._vertexDeclaration}),e(fi,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(48,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector4",5)])}]);var ci=fi;function fi(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i}t(pi,"laya.d3.graphics.VertexPositionNormalTextureTangent"),u=pi.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"vertexDeclaration",function(){return pi._vertexDeclaration}),n(1,pi,"vertexDeclaration",function(){return pi._vertexDeclaration}),e(pi,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(44,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector3",5)])}]);var mi=pi;function pi(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i}t(gi,"laya.d3.graphics.VertexPositionNTBTexture"),u=gi.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"vertexDeclaration",function(){return gi._vertexDeclaration}),n(1,gi,"vertexDeclaration",function(){return gi._vertexDeclaration}),e(gi,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(56,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector3",5),new _(36,"vector3",4),new _(48,"vector2",2)])}]);var Ei=gi;function gi(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}t(Ti,"laya.d3.graphics.VertexPositionNTBTexture0Texture1Skin"),u=Ti.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"tangent",function(){return this._tangent}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return Ti._vertexDeclaration}),n(0,u,"textureCoordinate1",function(){return this._textureCoordinate1}),n(0,u,"blendIndex",function(){return this._blendIndex}),n(0,u,"blendWeight",function(){return this._blendWeight}),n(1,Ti,"vertexDeclaration",function(){return Ti._vertexDeclaration}),e(Ti,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(96,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector3",5),new _(36,"vector3",4),new _(48,"vector2",2),new _(56,"vector2",15),new _(64,"vector4",7),new _(80,"vector4",6)])}]);var vi=Ti;function Ti(e,t,n,i,r,a,o,s){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this.binormal=null,this._position=e,this._normal=t,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=o,this._blendWeight=s}t(Di,"laya.d3.graphics.VertexPositionNTBTextureSkin"),u=Di.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"textureCoordinate",function(){return this._textureCoordinate}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"vertexDeclaration",function(){return Di._vertexDeclaration}),n(1,Di,"vertexDeclaration",function(){return Di._vertexDeclaration}),e(Di,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(88,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector3",5),new _(36,"vector3",4),new _(48,"vector2",2),new _(56,"vector4",7),new _(72,"vector4",6)])}]);var Si=Di;function Di(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}t(Mi,"laya.d3.graphics.VertexPositionTerrain"),u=Mi.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"normal",function(){return this._normal}),n(0,u,"position",function(){return this._position}),n(0,u,"textureCoord0",function(){return this._textureCoord0}),n(0,u,"textureCoord1",function(){return this._textureCoord1}),n(0,u,"vertexDeclaration",function(){return Mi._vertexDeclaration}),n(1,Mi,"vertexDeclaration",function(){return Mi._vertexDeclaration}),e(Mi,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(40,[new _(0,"vector3",0),new _(12,"vector3",3),new _(24,"vector2",2),new _(32,"vector2",15)])}]);var xi=Mi;function Mi(e,t,n,i){this._position=null,this._normal=null,this._textureCoord0=null,this._textureCoord1=null,this._position=e,this._normal=t,this._textureCoord0=n,this._textureCoord1=i}t(Ii,"laya.d3.graphics.VertexPositionTexture0"),u=Ii.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"position",function(){return this._position}),n(0,u,"textureCoordinate0",function(){return this._textureCoordinate0}),n(0,u,"vertexDeclaration",function(){return Ii._vertexDeclaration}),n(1,Ii,"vertexDeclaration",function(){return Ii._vertexDeclaration}),e(Ii,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(20,[new _(0,"vector3",0),new _(12,"vector2",2)])}]);var Ri=Ii;function Ii(e,t){this._position=null,this._textureCoordinate0=null,this._position=e,this._textureCoordinate0=t}t(Ci,"laya.d3.graphics.VertexShurikenParticleBillboard"),u=Ci.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),n(0,u,"random1",function(){return this._randoms1}),n(0,u,"startRotation2",function(){return this._startRotation2}),n(0,u,"positionStartLifeTime",function(){return this._positionStartLifeTime}),n(0,u,"velocity",function(){return this._velocity}),n(0,u,"random0",function(){return this._randoms0}),n(0,u,"startSize",function(){return this._startSize}),n(0,u,"startColor",function(){return this._startColor}),n(0,u,"startRotation0",function(){return this._startRotation0}),n(0,u,"startRotation1",function(){return this._startRotation1}),n(0,u,"startLifeTime",function(){return this._startLifeTime}),n(0,u,"time",function(){return this._time}),n(0,u,"startSpeed",function(){return this._startSpeed}),n(0,u,"simulationWorldPostion",function(){return this._simulationWorldPostion}),n(0,u,"vertexDeclaration",function(){return Ci._vertexDeclaration}),n(1,Ci,"vertexDeclaration",function(){return Ci._vertexDeclaration}),e(Ci,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(152,[new _(0,"vector4",17),new _(16,"vector4",30),new _(32,"vector4",32),new _(48,"vector4",19),new _(64,"vector3",20),new _(76,"vector3",22),new _(88,"single",31),new _(92,"vector4",34),new _(108,"vector4",35),new _(124,"vector3",36),new _(136,"vector4",37)])}]);var Ai=Ci;function Ci(e,t,n,i,r,a,o,s,l,h,_,u,d,c){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=e,this._positionStartLifeTime=t,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=o,this._startRotation2=s,this._startLifeTime=l,this._time=h,this._startSpeed=_,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=c}t(Oi,"laya.d3.graphics.VertexShurikenParticleMesh"),u=Oi.prototype,v.imps(u,{"laya.d3.graphics.IVertex":!0}),n(0,u,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),n(0,u,"velocity",function(){return this._velocity}),n(0,u,"position",function(){return this._positionStartLifeTime}),n(0,u,"random0",function(){return this._randoms0}),n(0,u,"startSize",function(){return this._startSize}),n(0,u,"startColor",function(){return this._startColor}),n(0,u,"startRotation0",function(){return this._startRotation0}),n(0,u,"startRotation1",function(){return this._startRotation1}),n(0,u,"random1",function(){return this._randoms1}),n(0,u,"startRotation2",function(){return this._startRotation2}),n(0,u,"startLifeTime",function(){return this._startLifeTime}),n(0,u,"time",function(){return this._time}),n(0,u,"startSpeed",function(){return this._startSpeed}),n(0,u,"simulationWorldPostion",function(){return this._simulationWorldPostion}),n(0,u,"vertexDeclaration",function(){return Oi._vertexDeclaration}),n(1,Oi,"vertexDeclaration",function(){return Oi._vertexDeclaration}),e(Oi,["_vertexDeclaration",function(){return this._vertexDeclaration=new h(172,[new _(0,"vector3",0),new _(12,"vector4",1),new _(28,"vector2",2),new _(36,"vector4",30),new _(52,"vector4",32),new _(68,"vector4",19),new _(84,"vector3",20),new _(96,"vector3",22),new _(108,"single",31),new _(112,"vector4",34),new _(128,"vector4",35),new _(144,"vector3",36),new _(156,"vector4",37)])}]);var yi=Oi;function Oi(e,t,n,i,r,a,o,s,l,h,_,u,d,c){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=e,this._positionStartLifeTime=t,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=o,this._startRotation2=s,this._startLifeTime=l,this._time=h,this._startSpeed=_,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=c}t(Vi,"laya.d3.loaders.LoadModelV01"),(u=Vi.prototype)._onLoaded=function(e){this._readData=e,this.READ_BLOCK();for(var t=0;t<this._BLOCK.count;t++){var n=this._readData.getUint16(),i=this._strings[n],r=this["READ_"+i];if(null==r)throw new Error("model file err,no this function:"+n+" "+i);if(!r.call(this))break}return this._mesh},u.onError=function(){},u._readString=function(){return this._strings[this._readData.getUint16()]},u.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},u.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},u.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var e=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var t=0;t<this._STRINGS.size;t++)this._strings[t]=this._readData.readUTFString();return this._readData.pos=e,!0},u.READ_MATERIAL=function(){var e=this._readData.getUint16(),t=(this._readString(),this._readString());return this._materials[e]="null"!==t?K.getRes(this._materialMap[t]):new Va,!0},u.READ_MESH=function(){this._readString();switch(this._version){case"LAYAMODEL:01":console.log("Warning: The (.lm) file is converted by old fbxTools,please reConverted it use  lastest fbxTools version,later we will remove the  support of old version (.lm) support.");break;case"LAYASKINANI:01":case"LAYAMODEL:02":var e,t=this._readData.__getBuffer(),n=0,i=this._readData.getUint32(),r=this._readData.getUint32(),i=(new Float32Array(t.slice(i+this._DATA.offset,i+this._DATA.offset+r)),this._readData.getUint32()),r=this._readData.getUint32(),a=new Float32Array(t.slice(i+this._DATA.offset,i+this._DATA.offset+r));for(this.mesh._inverseBindPoses=[],n=0,e=a.length;n<e;n+=16){var o=new R(a[n+0],a[n+1],a[n+2],a[n+3],a[n+4],a[n+5],a[n+6],a[n+7],a[n+8],a[n+9],a[n+10],a[n+11],a[n+12],a[n+13],a[n+14],a[n+15]);this.mesh._inverseBindPoses.push(o)}break;default:throw new Error("LoadModel:unknown version.")}return!0},u.READ_SUBMESH=function(){this._readString(),this._readData.getUint8();for(var e=this._readString(),e=(this._shaderAttributes=e.match(Vi._attrReg),this._readData.getUint32()),t=this._readData.getUint32(),n=(this._readData.getUint32(),this._readData.getUint32(),this._readData.getUint32()),i=this._readData.getUint32(),r=this._readData.getUint32(),a=this._readData.getUint32(),o=this._readData.__getBuffer(),s=new dr(this._mesh),l=this._getVertexDeclaration(),h=Es.create(l,i/l.vertexStride,35044,!0),l=n+this._DATA.offset,n=o.slice(l,l+i),_=(h.setData(new Float32Array(n)),(s._vertexBuffer=h).vertexDeclaration.getVertexElements()),u=0;u<_.length;u++)s._bufferUsage[_[u].elementUsage]=h;l=ds.create("ushort",t/2,35044,!0),i=e+this._DATA.offset,n=o.slice(i,i+t),l.setData(new Uint16Array(n)),s._indexBuffer=l,e=o.slice(r+this._DATA.offset,r+this._DATA.offset+a);return s._boneIndicesList[0]=new Uint8Array(e),this._subMeshes.push(s),!0},u.READ_DATAAREA=function(){return!1},u._getVertexDeclaration=function(){for(var e,t=!1,n=!1,i=!1,r=!1,a=!1,o=!1,s=!1,l=!1,h=!1,_=0;_<this._shaderAttributes.length;_+=8)switch(this._shaderAttributes[_]){case"POSITION":t=!0;break;case"NORMAL":n=!0;break;case"COLOR":i=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":l=!0;break;case"TANGENT":o=!0;break;case"BINORMAL":h=!0}return t&&n&&i&&r&&a&&s&&l&&o?e=An.vertexDeclaration:t&&n&&i&&r&&a&&s&&l?e=xn.vertexDeclaration:t&&n&&r&&a&&s&&l&&o?e=ti.vertexDeclaration:t&&n&&r&&a&&s&&l?e=Qn.vertexDeclaration:t&&n&&i&&r&&s&&l&&o?e=bn.vertexDeclaration:t&&n&&i&&r&&s&&l?e=Ln.vertexDeclaration:t&&n&&o&&h&&r&&s&&l?e=Si.vertexDeclaration:t&&n&&r&&s&&l&&o?e=ui.vertexDeclaration:t&&n&&r&&s&&l?e=si.vertexDeclaration:t&&n&&i&&s&&l&&o?e=cn.vertexDeclaration:t&&n&&i&&s&&l?e=hn.vertexDeclaration:t&&n&&i&&r&&a&&o?e=Nn.vertexDeclaration:t&&n&&i&&r&&a?e=Sn.vertexDeclaration:t&&n&&r&&a&&o?e=ai.vertexDeclaration:t&&n&&r&&a?e=Kn.vertexDeclaration:t&&n&&i&&r&&o?e=Gn.vertexDeclaration:t&&n&&r&&o&&h?e=Ei.vertexDeclaration:t&&n&&i&&r?e=vn.vertexDeclaration:t&&n&&r&&o?e=mi.vertexDeclaration:t&&n&&r?e=Zn.vertexDeclaration:t&&n&&i&&o?e=En.vertexDeclaration:t&&n&&i&&(e=sn.vertexDeclaration),e},n(0,u,"mesh",function(){return this._mesh}),Vi._attrReg=new RegExp("(\\w+)|([:,;])","g");var Ni=Vi;function Vi(e,t,n,i,r,a){this._version=null,this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._subMeshes=null,this._materialMap=null,this._readData=null,this._mesh=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._mesh=n,this._materials=i,this._subMeshes=r,this._materialMap=a,this._version=t,this._onLoaded(e)}t(m,"laya.d3.loaders.LoadModelV02"),m.parse=function(e,t,n,i,r,a){m._mesh=n,m._materials=i,m._subMeshes=r,m._materialMap=a,m._version=t,m._readData=e,m.READ_DATA(),m.READ_BLOCK(),m.READ_STRINGS();for(var o=0,s=m._BLOCK.count;o<s;o++){m._readData.pos=m._BLOCK.blockStarts[o];var l=m._readData.getUint16(),h=m._strings[l],_=m["READ_"+h];if(null==_)throw new Error("model file err,no this function:"+l+" "+h);_.call()}m._strings.length=0,m._readData=null,m._version=null,m._mesh=null,m._materials=null,m._subMeshes=null,m._materialMap=null},m._readString=function(){return m._strings[m._readData.getUint16()]},m.READ_DATA=function(){m._DATA.offset=m._readData.getUint32(),m._DATA.size=m._readData.getUint32()},m.READ_BLOCK=function(){for(var e=m._BLOCK.count=m._readData.getUint16(),t=m._BLOCK.blockStarts=[],n=m._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(m._readData.getUint32()),n.push(m._readData.getUint32())},m.READ_STRINGS=function(){var e=m._readData.getUint32(),t=m._readData.getUint16(),n=m._readData.pos;m._readData.pos=e+m._DATA.offset;for(var i=0;i<t;i++)m._strings[i]=m._readData.readUTFString();m._readData.pos=n},m.READ_MATERIAL=function(){m._readString(),m._readString();var e=m._readString();return""!==e&&m._materials.push(K.getRes(m._materialMap[e])),!0},m.READ_MESH=function(){m._readString();for(var e,t=m._readData.__getBuffer(),n=0,i=m._readData.getInt16(),r=m._DATA.offset,n=0;n<i;n++){var a=r+m._readData.getUint32(),o=m._readData.getUint32(),a=new Float32Array(t.slice(a,a+o)),o=m._readString().match(m._attrReg),o=m._getVertexDeclaration(o),o=Es.create(o,4*a.length/o.vertexStride,35044,!0);o.setData(a),m._mesh._vertexBuffers.push(o)}var s=r+m._readData.getUint32(),l=m._readData.getUint32(),s=new Uint16Array(t.slice(s,s+l)),l=ds.create("ushort",l/2,35044,!0),h=(l.setData(s),m._mesh._indexBuffer=l,m._mesh._boneNames=[]),_=m._readData.getUint16();for(h.length=_,n=0;n<_;n++)h[n]=m._strings[m._readData.getUint16()];var s=m._readData.getUint32(),l=m._readData.getUint32(),s=(new Float32Array(t.slice(r+s,r+s+l)),m._readData.getUint32()),l=m._readData.getUint32(),u=new Float32Array(t.slice(r+s,r+s+l));for(m._mesh._inverseBindPoses=[],n=0,e=u.length;n<e;n+=16){var d=new R(u[n+0],u[n+1],u[n+2],u[n+3],u[n+4],u[n+5],u[n+6],u[n+7],u[n+8],u[n+9],u[n+10],u[n+11],u[n+12],u[n+13],u[n+14],u[n+15]);m._mesh._inverseBindPoses.push(d)}return m._mesh._skinnedDatas=new Float32Array(16*u.length),!0},m.READ_SUBMESH=function(){var e=m._readData.__getBuffer(),t=new dr(m._mesh),n=m._readData.getInt16(),i=m._readData.getUint32(),r=m._readData.getUint32(),n=(t._vertexBuffer=m._mesh._vertexBuffers[n],t._vertexStart=i,t._vertexCount=r,m._readData.getUint32()),i=m._readData.getUint32(),r=m._mesh._indexBuffer,a=(t._indexBuffer=r,t._indexStart=n,t._indexCount=i,t._indices=new Uint16Array(r.getData().buffer,2*n,i),m._DATA.offset),o=t._subIndexBufferStart,s=t._subIndexBufferCount,r=t._boneIndicesList,l=m._readData.getUint16();o.length=l,s.length=l,r.length=l;for(var h=0;h<l;h++){o[h]=m._readData.getUint32(),s[h]=m._readData.getUint32();var _=m._readData.getUint32(),u=m._readData.getUint32();t._boneIndicesList[h]=new Uint8Array(e.slice(a+_,a+_+u))}return m._subMeshes.push(t),!0},m._getVertexDeclaration=function(e){for(var t,n=!1,i=!1,r=!1,a=!1,o=!1,s=!1,l=!1,h=!1,_=!1,u=0;u<e.length;u++)switch(e[u]){case"POSITION":n=!0;break;case"NORMAL":i=!0;break;case"COLOR":r=!0;break;case"UV":a=!0;break;case"UV1":o=!0;break;case"BLENDWEIGHT":l=!0;break;case"BLENDINDICES":h=!0;break;case"TANGENT":s=!0;break;case"BINORMAL":_=!0}return n&&i&&r&&a&&o&&l&&h&&s?t=An.vertexDeclaration:n&&i&&r&&a&&o&&l&&h?t=xn.vertexDeclaration:n&&i&&a&&o&&l&&h&&s?t=ti.vertexDeclaration:n&&i&&a&&o&&l&&h?t=Qn.vertexDeclaration:n&&i&&r&&a&&l&&h&&s?t=bn.vertexDeclaration:n&&i&&r&&a&&l&&h?t=Ln.vertexDeclaration:n&&i&&a&&l&&h&&s?t=ui.vertexDeclaration:n&&i&&a&&l&&h?t=si.vertexDeclaration:n&&i&&r&&l&&h&&s?t=cn.vertexDeclaration:n&&i&&r&&l&&h?t=hn.vertexDeclaration:n&&i&&r&&a&&o&&s?t=Nn.vertexDeclaration:n&&i&&r&&a&&o?t=Sn.vertexDeclaration:n&&i&&a&&o&&s?t=ai.vertexDeclaration:n&&i&&a&&o?t=Kn.vertexDeclaration:n&&i&&r&&a&&s?t=Gn.vertexDeclaration:n&&i&&a&&s&&_?t=Ei.vertexDeclaration:n&&i&&r&&a?t=vn.vertexDeclaration:n&&i&&a&&s?t=mi.vertexDeclaration:n&&i&&a?t=Zn.vertexDeclaration:n&&i&&r&&s?t=En.vertexDeclaration:n&&i&&r&&(t=sn.vertexDeclaration),t},m._attrReg=new RegExp("(\\w+)|([:,;])","g"),m._strings=[],m._readData=null,m._version=null,m._mesh=null,m._materials=null,m._subMeshes=null,m._materialMap=null,e(m,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]);var Li=m;function m(){}t(p,"laya.d3.loaders.LoadModelV03"),p.parse=function(e,t,n,i,r){p._mesh=n,p._subMeshes=i,p._materialMap=r,p._version=t,p._readData=e,p.READ_DATA(),p.READ_BLOCK(),p.READ_STRINGS();for(var a=0,o=p._BLOCK.count;a<o;a++){p._readData.pos=p._BLOCK.blockStarts[a];var s=p._readData.getUint16(),l=p._strings[s],h=p["READ_"+l];if(null==h)throw new Error("model file err,no this function:"+s+" "+l);h.call()}p._strings.length=0,p._readData=null,p._version=null,p._mesh=null,p._subMeshes=null,p._materialMap=null},p._readString=function(){return p._strings[p._readData.getUint16()]},p.READ_DATA=function(){p._DATA.offset=p._readData.getUint32(),p._DATA.size=p._readData.getUint32()},p.READ_BLOCK=function(){for(var e=p._BLOCK.count=p._readData.getUint16(),t=p._BLOCK.blockStarts=[],n=p._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(p._readData.getUint32()),n.push(p._readData.getUint32())},p.READ_STRINGS=function(){var e=p._readData.getUint32(),t=p._readData.getUint16(),n=p._readData.pos;p._readData.pos=e+p._DATA.offset;for(var i=0;i<t;i++)p._strings[i]=p._readData.readUTFString();p._readData.pos=n},p.READ_MESH=function(){p._readString();for(var e,t=p._readData.__getBuffer(),n=0,i=p._readData.getInt16(),r=p._DATA.offset,n=0;n<i;n++){var a,o=r+p._readData.getUint32(),s=p._readData.getUint32(),o=new Float32Array(t.slice(o,o+s)),l=p._readString();switch(p._version){case"LAYAMODEL:03":a=p._vertexDeclarationMap_Discard[l];break;case"LAYAMODEL:0301":a=p._vertexDeclarationMap[l];break;default:throw new Error("LoadModelV03: unknown version.")}if(!a)throw new Error("LoadModelV03: unknown vertexDeclaration.");s=Es.create(a,4*o.length/a.vertexStride,35044,!0);s.setData(o),p._mesh._vertexBuffers.push(s)}var h=r+p._readData.getUint32(),_=p._readData.getUint32(),h=new Uint16Array(t.slice(h,h+_)),_=ds.create("ushort",_/2,35044,!0),u=(_.setData(h),p._mesh._indexBuffer=_,p._mesh._boneNames=[]),d=p._readData.getUint16();for(u.length=d,n=0;n<d;n++)u[n]=p._strings[p._readData.getUint16()];p._readData.pos+=8;var h=p._readData.getUint32(),_=p._readData.getUint32(),c=new Float32Array(t.slice(r+h,r+h+_));for(p._mesh._inverseBindPoses=[],n=0,e=c.length;n<e;n+=16){var f=new R(c[n+0],c[n+1],c[n+2],c[n+3],c[n+4],c[n+5],c[n+6],c[n+7],c[n+8],c[n+9],c[n+10],c[n+11],c[n+12],c[n+13],c[n+14],c[n+15]);p._mesh._inverseBindPoses.push(f)}return p._mesh._skinnedDatas=new Float32Array(16*c.length),!0},p.READ_SUBMESH=function(){var e=p._readData.__getBuffer(),t=new dr(p._mesh),n=p._readData.getInt16(),i=p._readData.getUint32(),r=p._readData.getUint32(),n=(t._vertexBuffer=p._mesh._vertexBuffers[n],t._vertexStart=i,t._vertexCount=r,p._readData.getUint32()),i=p._readData.getUint32(),r=p._mesh._indexBuffer,a=(t._indexBuffer=r,t._indexStart=n,t._indexCount=i,t._indices=new Uint16Array(r.getData().buffer,2*n,i),p._DATA.offset),o=t._subIndexBufferStart,s=t._subIndexBufferCount,l=t._boneIndicesList,h=p._readData.getUint16();o.length=h,s.length=h,l.length=h;for(var _=0;_<h;_++){o[_]=p._readData.getUint32(),s[_]=p._readData.getUint32();var u=p._readData.getUint32(),d=p._readData.getUint32();l[_]=new Uint8Array(e.slice(a+u,a+u+d))}return p._subMeshes.push(t),!0},p._strings=[],p._readData=null,p._version=null,p._mesh=null,p._subMeshes=null,p._materialMap=null,e(p,["_vertexDeclarationMap_Discard",function(){return this._vertexDeclarationMap_Discard={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":An.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":xn.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":vi.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":ti.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":Qn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":bn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":Ln.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":ui.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":si.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":cn.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":hn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":Nn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":Sn.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":ai.vertexDeclaration,"POSITION,NORMAL,UV,UV1":Kn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":Gn.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":Ei.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":vn.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":mi.vertexDeclaration,"POSITION,NORMAL,UV":Zn.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":En.vertexDeclaration,"POSITION,NORMAL,COLOR":sn.vertexDeclaration,"POSITION,NORMAL,TANGENT":Xn.vertexDeclaration,"POSITION,NORMAL":an.vertexDeclaration,"POSITION,UV":Ri.vertexDeclaration,POSITION:nn.vertexDeclaration}},"_vertexDeclarationMap",function(){return this._vertexDeclarationMap={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":Rn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":xn.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":vi.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":Jn.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":Qn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":Fn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":Ln.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":hi.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":si.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":un.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":hn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":yn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":Sn.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":ii.vertexDeclaration,"POSITION,NORMAL,UV,UV1":Kn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":Un.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":Ei.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":vn.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":ci.vertexDeclaration,"POSITION,NORMAL,UV":Zn.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":mn.vertexDeclaration,"POSITION,NORMAL,COLOR":sn.vertexDeclaration,"POSITION,NORMAL,TANGENT":Wn.vertexDeclaration,"POSITION,NORMAL":an.vertexDeclaration,"POSITION,UV":Ri.vertexDeclaration,POSITION:nn.vertexDeclaration}},"_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]);var wi=p;function p(){}t(Pi,"laya.d3.loaders.MeshReader"),Pi.read=function(e,t,n,i,r){var a=new X(e),o=(a.pos=0,a.readUTFString());switch(o){case"LAYAMODEL:01":case"LAYASKINANI:01":Pi._readVersion01(a,o,t,n,i,r);break;case"LAYAMODEL:02":Li.parse(a,o,t,n,i,r);break;case"LAYAMODEL:03":case"LAYAMODEL:0301":wi.parse(a,o,t,i,r);break;default:throw new Error("MeshReader: unknown mesh version.")}t._setSubMeshes(i)},Pi._readVersion01=function(e,t,n,i,r,a){new Ni(e,t,n,i,r,a)};var Fi=Pi;function Pi(){}t(Bi,"laya.d3.math.BoundBox"),u=Bi.prototype,v.imps(u,{"laya.d3.core.IClone":!0}),u.getCorners=function(e){e.length=8;var t=this.min.elements,n=this.max.elements,i=t[0],r=t[1],t=t[2],a=n[0],o=n[1],n=n[2];e[0]=new W(i,o,n),e[1]=new W(a,o,n),e[2]=new W(a,r,n),e[3]=new W(i,r,n),e[4]=new W(i,o,t),e[5]=new W(a,o,t),e[6]=new W(a,r,t),e[7]=new W(i,r,t)},u.toDefault=function(){this.min.toDefault(),this.max.toDefault()},u.cloneTo=function(e){this.min.cloneTo(e.min),this.max.cloneTo(e.max)},u.clone=function(){var e=new this.constructor(new W,new W);return this.cloneTo(e),e},Bi.createfromPoints=function(e,t){if(null==e)throw new Error("points");var n=t.min,i=t.max,t=n.elements,t=(t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE,i.elements);t[0]=-Number.MAX_VALUE,t[1]=-Number.MAX_VALUE,t[2]=-Number.MAX_VALUE;for(var r=0,a=e.length;r<a;++r)W.min(n,e[r],n),W.max(i,e[r],i)},Bi.merge=function(e,t,n){W.min(e.min,t.min,n.min),W.max(e.max,t.max,n.max)};var bi=Bi;function Bi(e,t){this.min=null,this.max=null,this.min=e,this.max=t}t(Hi,"laya.d3.math.BoundFrustum"),(u=Hi.prototype).equalsBoundFrustum=function(e){return this._matrix.equalsOtherMatrix(e.matrix)},u.equalsObj=function(e){return e instanceof laya.d3.math.BoundFrustum&&this.equalsBoundFrustum(e)},u.getPlane=function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},u.getCorners=function(e){Hi._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(e[0]),Hi._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(e[1]),Hi._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(e[2]),Hi._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(e[3]),Hi._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(e[4]),Hi._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(e[5]),Hi._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(e[6]),Hi._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(e[7])},u.containsPoint=function(e){for(var t=qi.PlaneIntersectionType_Front,n=qi.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=Wi.intersectsPlaneAndPoint(this._near,e);break;case 1:n=Wi.intersectsPlaneAndPoint(this._far,e);break;case 2:n=Wi.intersectsPlaneAndPoint(this._left,e);break;case 3:n=Wi.intersectsPlaneAndPoint(this._right,e);break;case 4:n=Wi.intersectsPlaneAndPoint(this._top,e);break;case 5:n=Wi.intersectsPlaneAndPoint(this._bottom,e)}switch(n){case qi.PlaneIntersectionType_Back:return 0;case qi.PlaneIntersectionType_Intersecting:t=qi.PlaneIntersectionType_Intersecting}}return t!==qi.PlaneIntersectionType_Intersecting?1:2},u.containsBoundBox=function(e){for(var t,n=Hi._tempV30,i=Hi._tempV31,r=1,a=0;a<6;a++){if(t=this.getPlane(a),this._getBoxToPlanePVertexNVertex(e,t.normal,n,i),Wi.intersectsPlaneAndPoint(t,n)===qi.PlaneIntersectionType_Back)return 0;Wi.intersectsPlaneAndPoint(t,i)===qi.PlaneIntersectionType_Back&&(r=2)}return r},u.containsBoundSphere=function(e){for(var t=qi.PlaneIntersectionType_Front,n=qi.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=Wi.intersectsPlaneAndSphere(this._near,e);break;case 1:n=Wi.intersectsPlaneAndSphere(this._far,e);break;case 2:n=Wi.intersectsPlaneAndSphere(this._left,e);break;case 3:n=Wi.intersectsPlaneAndSphere(this._right,e);break;case 4:n=Wi.intersectsPlaneAndSphere(this._top,e);break;case 5:n=Wi.intersectsPlaneAndSphere(this._bottom,e)}switch(n){case qi.PlaneIntersectionType_Back:return 0;case qi.PlaneIntersectionType_Intersecting:t=qi.PlaneIntersectionType_Intersecting}}return t!==qi.PlaneIntersectionType_Intersecting?1:2},u._getBoxToPlanePVertexNVertex=function(e,t,n,i){var r=e.min,a=r.elements,e=e.max,o=e.elements,t=t.elements,s=t[0],l=t[1],t=t[2],r=(r.cloneTo(n),n.elements),n=(0<=s&&(r[0]=o[0]),0<=l&&(r[1]=o[1]),0<=t&&(r[2]=o[2]),e.cloneTo(i),i.elements);0<=s&&(n[0]=a[0]),0<=l&&(n[1]=a[1]),0<=t&&(n[2]=a[2])},n(0,u,"top",function(){return this._top}),n(0,u,"matrix",function(){return this._matrix},function(e){this._matrix=e,Hi._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),n(0,u,"near",function(){return this._near}),n(0,u,"far",function(){return this._far}),n(0,u,"left",function(){return this._left}),n(0,u,"right",function(){return this._right}),n(0,u,"bottom",function(){return this._bottom}),Hi._getPlanesFromMatrix=function(e,t,n,i,r,a,o){var e=e.elements,s=e[0],l=e[1],h=e[2],_=e[3],u=e[4],d=e[5],c=e[6],f=e[7],m=e[8],p=e[9],E=e[10],g=e[11],v=e[12],T=e[13],S=e[14],e=e[15],D=t.normal.elements,D=(D[0]=_+h,D[1]=f+c,D[2]=g+E,t.distance=e+S,t.normalize(),n.normal.elements),t=(D[0]=_-h,D[1]=f-c,D[2]=g-E,n.distance=e-S,n.normalize(),i.normal.elements),h=(t[0]=_+s,t[1]=f+u,t[2]=g+m,i.distance=e+v,i.normalize(),r.normal.elements),c=(h[0]=_-s,h[1]=f-u,h[2]=g-m,r.distance=e-v,r.normalize(),a.normal.elements),D=(c[0]=_-l,c[1]=f-d,c[2]=g-p,a.distance=e-T,a.normalize(),o.normal.elements);D[0]=_+l,D[1]=f+d,D[2]=g+p,o.distance=e+T,o.normalize()},Hi._get3PlaneInterPoint=function(e,t,n){var i=e.normal,r=t.normal,a=n.normal,i=(W.cross(r,a,Hi._tempV30),W.cross(a,i,Hi._tempV31),W.cross(i,r,Hi._tempV32),W.dot(i,Hi._tempV30)),r=W.dot(r,Hi._tempV31),a=W.dot(a,Hi._tempV32);return W.scale(Hi._tempV30,-e.distance/i,Hi._tempV33),W.scale(Hi._tempV31,-t.distance/r,Hi._tempV34),W.scale(Hi._tempV32,-n.distance/a,Hi._tempV35),W.add(Hi._tempV33,Hi._tempV34,Hi._tempV36),W.add(Hi._tempV35,Hi._tempV36,Hi._tempV37),Hi._tempV37},e(Hi,["_tempV30",function(){return this._tempV30=new W},"_tempV31",function(){return this._tempV31=new W},"_tempV32",function(){return this._tempV32=new W},"_tempV33",function(){return this._tempV33=new W},"_tempV34",function(){return this._tempV34=new W},"_tempV35",function(){return this._tempV35=new W},"_tempV36",function(){return this._tempV36=new W},"_tempV37",function(){return this._tempV37=new W}]);var Ui=Hi;function Hi(e){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=e,this._near=new qi(new W),this._far=new qi(new W),this._left=new qi(new W),this._right=new qi(new W),this._top=new qi(new W),this._bottom=new qi(new W),Hi._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}t(zi,"laya.d3.math.BoundSphere"),u=zi.prototype,v.imps(u,{"laya.d3.core.IClone":!0}),u.toDefault=function(){this.center.toDefault(),this.radius=0},u.intersectsRayDistance=function(e){return Wi.intersectsRayAndSphereRD(e,this)},u.intersectsRayPoint=function(e,t){return Wi.intersectsRayAndSphereRP(e,this,t)},u.cloneTo=function(e){this.center.cloneTo(e.center),e.radius=this.radius},u.clone=function(){var e=new this.constructor(new W,new W);return this.cloneTo(e),e},zi.createFromSubPoints=function(e,t,n,i){if(null==e)throw new Error("points");if(t<0||t>=e.length)throw new Error("start"+t+"Must be in the range [0, "+(e.length-1)+"]");if(n<0||t+n>e.length)throw new Error("count"+n+"Must be in the range <= "+e.length+"}");var r=t+n,a=zi._tempVector3;a.elements[0]=0,a.elements[1]=0,a.elements[2]=0;for(var o=t;o<r;++o)W.add(e[o],a,a);for(var s=i.center,l=(W.scale(a,1/n,s),0),o=t;o<r;++o){var h=W.distanceSquared(s,e[o]);l<h&&(l=h)}i.radius=Math.sqrt(l)},zi.createfromPoints=function(e,t){if(null==e)throw new Error("points");zi.createFromSubPoints(e,0,e.length,t)},e(zi,["_tempVector3",function(){return this._tempVector3=new W}]);var Gi=zi;function zi(e,t){this.center=null,this.radius=NaN,this.center=e,this.radius=t}t(x,"laya.d3.math.Collision"),x.distancePlaneToPoint=function(e,t){return W.dot(e.normal,t)-e.distance},x.distanceBoxToPoint=function(e,t){var n=e.min.elements,i=n[0],r=n[1],n=n[2],e=e.max.elements,a=e[0],o=e[1],e=e[2],t=t.elements,s=t[0],l=t[1],t=t[2],h=0;return s<i&&(h+=(i-s)*(i-s)),a<s&&(h+=(a-s)*(a-s)),l<r&&(h+=(r-l)*(r-l)),o<l&&(h+=(o-l)*(o-l)),t<n&&(h+=(n-t)*(n-t)),e<t&&(h+=(e-t)*(e-t)),Math.sqrt(h)},x.distanceBoxToBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],n=n[2],e=e.max.elements,a=e[0],o=e[1],e=e[2],s=t.min.elements,l=s[0],h=s[1],s=s[2],t=t.max.elements,_=t[0],u=t[1],t=t[2],d=0,c=NaN;return _<i?d+=(c=i-_)*c:a<l&&(d+=(c=l-a)*c),u<r?d+=(c=r-u)*c:o<h&&(d+=(c=h-o)*c),t<n?d+=(c=n-t)*c:e<s&&(d+=(c=s-e)*c),Math.sqrt(d)},x.distanceSphereToPoint=function(e,t){t=Math.sqrt(W.distanceSquared(e.center,t));return t-=e.radius,Math.max(t,0)},x.distanceSphereToSphere=function(e,t){var n=Math.sqrt(W.distanceSquared(e.center,t.center));return n-=e.radius+t.radius,Math.max(n,0)},x.intersectsRayAndTriangleRD=function(e,t,n,i,r){var a,o,s,l,h,_=e.origin.elements,u=_[0],d=_[1],_=_[2],e=e.direction.elements,c=e[0],f=e[1],e=e[2],t=t.elements,m=t[0],p=t[1],t=t[2],n=n.elements,E=n[0],g=n[1],n=n[2],i=i.elements,v=i[0],T=i[1],i=i[2],S=x._tempV30.elements,S=(S[0],S[1],S[2],x._tempV31.elements),S=(S[0],S[1],S[2],x._tempV32.elements),D=(S[0],S[1],S[2],(S=E-m)*(T=f*(E=i-t)-e*(i=T-p))+(g=g-p)*(h=e*(v=v-m)-c*E)+(n=n-t)*(a=c*i-f*v));return M.isZero(D)||(o=(l=x._tempV33.elements)[0],s=l[1],l=l[2],u=(o=u-m)*T+(s=d-p)*h+(l=_-t)*a,(u*=m=1/D)<0)||1<u||(d=(T=x._tempV34.elements)[0],p=T[1],h=T[2],_=c*(d=s*n-l*g)+f*(p=l*S-o*n)+e*(h=o*g-s*S),(_*=m)<0)||1<u+_||(t=v*d+i*p+E*h,(t*=m)<0)?!1:!0},x.intersectsRayAndTriangleRP=function(e,t,n,i,r){return x.intersectsRayAndTriangleRD(e,t,n,i,NaN)?(W.scale(e.direction,NaN,x._tempV30),W.add(e.origin,x._tempV30,r),!0):(r=W.ZERO,!1)},x.intersectsRayAndPoint=function(e,t){W.subtract(e.origin,t,x._tempV30);t=W.dot(x._tempV30,e.direction),e=W.dot(x._tempV30,x._tempV30)-M.zeroTolerance;return!(0<e&&0<t||t*t-e<0)},x.intersectsRayAndRay=function(e,t,n){var i=e.origin,r=i.elements,a=r[0],o=r[1],r=r[2],e=e.direction,s=e.elements,l=s[0],h=s[1],s=s[2],_=t.origin,u=_.elements,d=u[0],c=u[1],u=u[2],t=t.direction,f=t.elements,m=f[0],p=f[1],f=f[2],E=(W.cross(e,t,x._tempV30),x._tempV30.elements),g=W.scalarLengthSquared(x._tempV30);if(M.isZero(g)&&M.nearEqual(d,a)&&M.nearEqual(c,o)&&M.nearEqual(u,r))W.ZERO.cloneTo(n);else{d=d-a,a=c-o,c=u-r,o=E[0],u=E[1],r=E[2],E=(d*h*r+a*s*o+c*l*u-d*s*u-a*l*r-c*h*o)/g,s=(W.scale(e,(d*p*r+a*f*o+c*m*u-d*f*u-a*m*r-c*p*o)/g,x._tempV30),W.scale(t,E,x._tempV31),W.add(i,x._tempV30,x._tempV32),W.add(_,x._tempV31,x._tempV33),x._tempV32.elements),l=x._tempV33.elements;if(!M.nearEqual(l[0],s[0])||!M.nearEqual(l[1],s[1])||!M.nearEqual(l[2],s[2]))return W.ZERO.cloneTo(n),!1;x._tempV32.cloneTo(n)}return!0},x.intersectsPlaneAndTriangle=function(e,t,n,i){t=x.intersectsPlaneAndPoint(e,t),n=x.intersectsPlaneAndPoint(e,n),e=x.intersectsPlaneAndPoint(e,i);return t==qi.PlaneIntersectionType_Front&&n==qi.PlaneIntersectionType_Front&&e==qi.PlaneIntersectionType_Front?qi.PlaneIntersectionType_Front:t==qi.PlaneIntersectionType_Back&&n==qi.PlaneIntersectionType_Back&&e==qi.PlaneIntersectionType_Back?qi.PlaneIntersectionType_Back:qi.PlaneIntersectionType_Intersecting},x.intersectsRayAndPlaneRD=function(e,t,n){var i=t.normal,r=W.dot(i,e.direction);return!(M.isZero(r)||(i=W.dot(i,e.origin),(-t.distance-i)/r<0&&1))},x.intersectsRayAndPlaneRP=function(e,t,n){return x.intersectsRayAndPlaneRD(e,t,NaN)?(W.scale(e.direction,NaN,x._tempV30),W.add(e.origin,x._tempV30,x._tempV31),!0):(W.ZERO,!1)},x.intersectsRayAndBoxRD=function(e,t){var n=e.origin.elements,i=n[0],r=n[1],n=n[2],e=e.direction.elements,a=e[0],o=e[1],e=e[2],s=t.min.elements,l=s[0],h=s[1],s=s[2],t=t.max.elements,_=t[0],u=t[1],t=t[2],d=0,c=M.MaxValue;if(M.isZero(a)){if(i<l||_<i)return-1}else{a=1/a,l=(l-i)*a,_=(_-i)*a;if(_<l&&(i=l,l=_,_=i),d=Math.max(l,d),(c=Math.min(_,c))<d)return-1}if(M.isZero(o)){if(r<h||u<r)return-1}else{a=1/o,i=(h-r)*a,l=(u-r)*a;if(l<i&&(_=i,i=l,l=_),d=Math.max(i,d),(c=Math.min(l,c))<d)return-1}if(M.isZero(e)){if(n<s||t<n)return-1}else{o=1/e,h=(s-n)*o,u=(t-n)*o;if(u<h&&(r=h,h=u,u=r),d=Math.max(h,d),(c=Math.min(u,c))<d)return-1}return d},x.intersectsRayAndBoxRP=function(e,t,n){t=x.intersectsRayAndBoxRD(e,t);return-1===t?W.ZERO.cloneTo(n):(W.scale(e.direction,t,x._tempV30),W.add(e.origin,x._tempV30,x._tempV31),x._tempV31.cloneTo(n)),t},x.intersectsRayAndSphereRD=function(e,t){var n=t.radius,t=(W.subtract(e.origin,t.center,x._tempV30),W.dot(x._tempV30,e.direction)),e=W.dot(x._tempV30,x._tempV30)-n*n;return 0<e&&0<t||(n=t*t-e)<0?-1:(e=-t-Math.sqrt(n))<0?0:e},x.intersectsRayAndSphereRP=function(e,t,n){t=x.intersectsRayAndSphereRD(e,t);return-1===t?W.ZERO.cloneTo(n):(W.scale(e.direction,t,x._tempV30),W.add(e.origin,x._tempV30,x._tempV31),x._tempV31.cloneTo(n)),t},x.intersectsSphereAndTriangle=function(e,t,n,i){var r=e.center,e=e.radius;return x.closestPointPointTriangle(r,t,n,i,x._tempV30),W.subtract(x._tempV30,r,x._tempV31),W.dot(x._tempV31,x._tempV31)<=e*e},x.intersectsPlaneAndPoint=function(e,t){t=W.dot(e.normal,t)+e.distance;return 0<t?qi.PlaneIntersectionType_Front:t<0?qi.PlaneIntersectionType_Back:qi.PlaneIntersectionType_Intersecting},x.intersectsPlaneAndPlane=function(e,t){W.cross(e.normal,t.normal,x._tempV30);e=W.dot(x._tempV30,x._tempV30);return!M.isZero(e)},x.intersectsPlaneAndPlaneRL=function(e,t,n){var i=e.normal,r=t.normal,a=(W.cross(i,r,x._tempV34),W.dot(x._tempV34,x._tempV34));return!M.isZero(a)&&(W.scale(r,e.distance,x._tempV30),W.scale(i,t.distance,x._tempV31),W.subtract(x._tempV30,x._tempV31,x._tempV32),W.cross(x._tempV32,x._tempV34,x._tempV33),W.normalize(x._tempV34,x._tempV34),new ir(x._tempV33,x._tempV34),!0)},x.intersectsPlaneAndBox=function(e,t){var n=e.distance,e=e.normal,i=e.elements,r=i[0],a=i[1],i=i[2],o=t.min.elements,s=o[0],l=o[1],o=o[2],t=t.max.elements,h=t[0],_=t[1],t=t[2];return x._tempV30.elements[0]=0<r?s:h,x._tempV30.elements[1]=0<a?l:_,x._tempV30.elements[2]=0<i?o:t,x._tempV31.elements[0]=0<r?h:s,x._tempV31.elements[1]=0<a?_:l,x._tempV31.elements[2]=0<i?t:o,0<W.dot(e,x._tempV30)+n?qi.PlaneIntersectionType_Front:W.dot(e,x._tempV31)+n<0?qi.PlaneIntersectionType_Back:qi.PlaneIntersectionType_Intersecting},x.intersectsPlaneAndSphere=function(e,t){var n=t.radius,t=W.dot(e.normal,t.center)+e.distance;return n<t?qi.PlaneIntersectionType_Front:t<-n?qi.PlaneIntersectionType_Back:qi.PlaneIntersectionType_Intersecting},x.intersectsBoxAndBox=function(e,t){var n=e.min.elements,e=e.max.elements,i=t.min.elements,t=t.max.elements;return!(n[0]>t[0]||i[0]>e[0]||n[1]>t[1]||i[1]>e[1]||n[2]>t[2]||i[2]>e[2])},x.intersectsBoxAndSphere=function(e,t){var n=t.center,t=t.radius;return W.Clamp(n,e.min,e.max,x._tempV30),W.distanceSquared(n,x._tempV30)<=t*t},x.intersectsSphereAndSphere=function(e,t){var n=e.radius+t.radius;return W.distanceSquared(e.center,t.center)<=n*n},x.boxContainsPoint=function(e,t){var n=e.min.elements,e=e.max.elements,t=t.elements;return n[0]<=t[0]&&e[0]>=t[0]&&n[1]<=t[1]&&e[1]>=t[1]&&n[2]<=t[2]&&e[2]>=t[2]?1:0},x.boxContainsBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],n=n[2],e=e.max.elements,a=e[0],o=e[1],e=e[2],s=t.min.elements,l=s[0],h=s[1],s=s[2],t=t.max.elements,_=t[0],u=t[1],t=t[2];return a<l||_<i||o<h||u<r||e<s||t<n?0:i<=l&&_<=_&&r<=h&&u<=o&&n<=s&&t<=e?1:2},x.boxContainsSphere=function(e,t){var n=e.min,i=n.elements,r=i[0],a=i[1],i=i[2],e=e.max,o=e.elements,s=o[0],l=o[1],o=o[2],h=t.center,_=h.elements,u=_[0],d=_[1],_=_[2],t=t.radius;return W.Clamp(h,n,e,x._tempV30),t*t<W.distanceSquared(h,x._tempV30)?0:r+t<=u&&u<=s-t&&t<s-r&&a+t<=d&&d<=l-t&&t<l-a&&i+t<=_&&_<=o-t&&t<o-i?1:2},x.sphereContainsPoint=function(e,t){return W.distanceSquared(t,e.center)<=e.radius*e.radius?1:0},x.sphereContainsTriangle=function(e,t,n,i){var r=x.sphereContainsPoint(e,t),a=x.sphereContainsPoint(e,n),o=x.sphereContainsPoint(e,i);return 1==r&&1==a&&1==o?1:x.intersectsSphereAndTriangle(e,t,n,i)?2:0},x.sphereContainsBox=function(e,t){var n=e.center.elements,n=(n[0],n[1],n[2],e.radius),i=t.min.elements,i=(i[0],i[1],i[2],t.max.elements),i=(i[0],i[1],i[2],x._tempV30.elements);i[0],i[1],i[2];return x.intersectsBoxAndSphere(t,e)?(i=n*n,W.scalarLengthSquared(x._tempV30)>i||W.scalarLengthSquared(x._tempV30)>i||W.scalarLengthSquared(x._tempV30)>i||W.scalarLengthSquared(x._tempV30)>i||W.scalarLengthSquared(x._tempV30)>i||W.scalarLengthSquared(x._tempV30)>i||W.scalarLengthSquared(x._tempV30)>i||W.scalarLengthSquared(x._tempV30)>i?2:1):0},x.sphereContainsSphere=function(e,t){var n=e.radius,i=t.radius,e=W.distance(e.center,t.center);return n+i<e?0:n-i<e?2:1},x.closestPointPointTriangle=function(e,t,n,i,r){W.subtract(n,t,x._tempV30),W.subtract(i,t,x._tempV31),W.subtract(e,t,x._tempV32),W.subtract(e,n,x._tempV33),W.subtract(e,i,x._tempV34);var a,e=W.dot(x._tempV30,x._tempV32),o=W.dot(x._tempV31,x._tempV32),s=W.dot(x._tempV30,x._tempV33),l=W.dot(x._tempV31,x._tempV33),h=W.dot(x._tempV30,x._tempV34),_=W.dot(x._tempV31,x._tempV34);e<=0&&o<=0?t.cloneTo(r):0<=s&&l<=s?n.cloneTo(r):(a=e*l-s*o)<=0&&0<=e&&s<=0?(W.scale(x._tempV30,e/(e-s),r),W.add(t,r,r)):0<=_&&h<=_?i.cloneTo(r):(e=h*o-e*_)<=0&&0<=o&&_<=0?(W.scale(x._tempV31,o/(o-_),r),W.add(t,r,r)):(o=s*_-h*l)<=0&&0<=l-s&&0<=h-_?(l=(l-s)/(l-s+(h-_)),W.subtract(i,n,r),W.scale(r,l,r),W.add(n,r,r)):(h=a*(s=1/(o+e+a)),W.scale(x._tempV30,e*s,x._tempV35),W.scale(x._tempV31,h,x._tempV36),W.add(x._tempV35,x._tempV36,r),W.add(t,r,r))},x.closestPointPlanePoint=function(e,t,n){var i=e.normal,e=W.dot(i,t)-e.distance;W.scale(i,e,x._tempV30),W.subtract(t,x._tempV30,n)},x.closestPointBoxPoint=function(e,t,n){W.max(t,e.min,x._tempV30),W.min(x._tempV30,e.max,n)},x.closestPointSpherePoint=function(e,t,n){var i=e.center;W.subtract(t,i,n),W.normalize(n,n),W.scale(n,e.radius,n),W.add(n,i,n)},x.closestPointSphereSphere=function(e,t,n){var i=e.center;W.subtract(t.center,i,n),W.normalize(n,n),W.scale(n,e.radius,n),W.add(n,i,n)},e(x,["_tempV30",function(){return this._tempV30=new W},"_tempV31",function(){return this._tempV31=new W},"_tempV32",function(){return this._tempV32=new W},"_tempV33",function(){return this._tempV33=new W},"_tempV34",function(){return this._tempV34=new W},"_tempV35",function(){return this._tempV35=new W},"_tempV36",function(){return this._tempV36=new W}]);var Wi=x;function x(){}t(ki,"laya.d3.math.ContainmentType"),ki.Disjoint=0,ki.Contains=1,ki.Intersects=2;function ki(){}t(Xi,"laya.d3.math.MathUtils3D"),Xi.isZero=function(e){return Math.abs(e)<Xi.zeroTolerance},Xi.nearEqual=function(e,t){return!!Xi.isZero(e-t)},Xi.fastInvSqrt=function(e){return Xi.isZero(e)?e:1/Math.sqrt(e)},e(Xi,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=340282347e30},"MinValue",function(){return this.MinValue=-340282347e30}]);var M=Xi;function Xi(){}t(Zi,"laya.d3.math.Matrix3x3"),u=Zi.prototype,v.imps(u,{"laya.d3.core.IClone":!0}),u.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],l=e[7],e=e[8];return t*(e*a-o*l)+n*(-e*r+o*s)+i*(l*r-a*s)},u.translate=function(e,t){var t=t.elements,n=this.elements,e=e.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],l=n[5],h=n[6],_=n[7],n=n[8],u=e[0],e=e[1];t[0]=i,t[1]=r,t[2]=a,t[3]=o,t[4]=s,t[5]=l,t[6]=u*i+e*o+h,t[7]=u*r+e*s+_,t[8]=u*a+e*l+n},u.rotate=function(e,t){var t=t.elements,n=this.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],l=n[5],h=n[6],_=n[7],n=n[8],u=Math.sin(e),e=Math.cos(e);t[0]=e*i+u*o,t[1]=e*r+u*s,t[2]=e*a+u*l,t[3]=e*o-u*i,t[4]=e*s-u*r,t[5]=e*l-u*a,t[6]=h,t[7]=_,t[8]=n},u.scale=function(e,t){var t=t.elements,n=this.elements,e=e.elements,i=e[0],e=e[1];t[0]=i*n[0],t[1]=i*n[1],t[2]=i*n[2],t[3]=e*n[3],t[4]=e*n[4],t[5]=e*n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8]},u.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],l=n[5],h=n[6],_=n[7],n=n[8],u=n*s-l*_,d=-n*o+l*h,c=_*o-s*h,f=i*u+r*d+a*c;f||(e=null),t[0]=u*(f=1/f),t[1]=(-n*r+a*_)*f,t[2]=(l*r-a*s)*f,t[3]=d*f,t[4]=(n*i-a*h)*f,t[5]=(-l*i+a*o)*f,t[6]=c*f,t[7]=(-_*i+r*h)*f,t[8]=(s*i-r*o)*f},u.transpose=function(e){var t,n,i=e.elements,r=this.elements;e===this?(e=r[1],t=r[2],n=r[5],i[1]=r[3],i[2]=r[6],i[3]=e,i[5]=r[7],i[6]=t,i[7]=n):(i[0]=r[0],i[1]=r[3],i[2]=r[6],i[3]=r[1],i[4]=r[4],i[5]=r[7],i[6]=r[2],i[7]=r[5],i[8]=r[8])},u.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},u.cloneTo=function(e){var t,n=this.elements,i=e.elements;if(n!==i)for(t=0;t<9;++t)i[t]=n[t]},u.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},Zi.createFromTranslation=function(e,t){t.elements;e=e.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1},Zi.createFromRotation=function(e,t){var t=t.elements,n=Math.sin(e),e=Math.cos(e);t[0]=e,t[1]=n,t[2]=0,t[3]=-n,t[4]=e,t[5]=0,t[6]=0,t[7]=0,t[8]=1},Zi.createFromScaling=function(e,t){t=t.elements,e=e.elements;t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1},Zi.createFromMatrix4x4=function(e,t){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10]},Zi.multiply=function(e,t,n){var n=n.elements,e=e.elements,t=t.elements,i=e[0],r=e[1],a=e[2],o=e[3],s=e[4],l=e[5],h=e[6],_=e[7],e=e[8],u=t[0],d=t[1],c=t[2],f=t[3],m=t[4],p=t[5],E=t[6],g=t[7],t=t[8];n[0]=u*i+d*o+c*h,n[1]=u*r+d*s+c*_,n[2]=u*a+d*l+c*e,n[3]=f*i+m*o+p*h,n[4]=f*r+m*s+p*_,n[5]=f*a+m*l+p*e,n[6]=E*i+g*o+t*h,n[7]=E*r+g*s+t*_,n[8]=E*a+g*l+t*e},Zi.lookAt=function(e,t,n,i){W.subtract(e,t,Zi._tempV30),W.normalize(Zi._tempV30,Zi._tempV30),W.cross(n,Zi._tempV30,Zi._tempV31),W.normalize(Zi._tempV31,Zi._tempV31),W.cross(Zi._tempV30,Zi._tempV31,Zi._tempV32);e=Zi._tempV30.elements,t=Zi._tempV31.elements,n=Zi._tempV32.elements,i=i.elements;i[0]=t[0],i[3]=t[1],i[6]=t[2],i[1]=n[0],i[4]=n[1],i[7]=n[2],i[2]=e[0],i[5]=e[1],i[8]=e[2]},Zi.DEFAULT=new Zi,e(Zi,["_tempV30",function(){return this._tempV30=new W},"_tempV31",function(){return this._tempV31=new W},"_tempV32",function(){return this._tempV32=new W}]);var Yi=Zi;function Zi(){var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}t(ji,"laya.d3.math.Matrix4x4"),u=ji.prototype,v.imps(u,{"laya.d3.core.IClone":!0}),u.getElementByRowColumn=function(e,t){if(e<0||3<e)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||3<t)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]},u.setElementByRowColumn=function(e,t,n){if(e<0||3<e)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||3<t)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=n},u.equalsOtherMatrix=function(e){var t=this.elements,e=e.elements;return M.nearEqual(t[0],e[0])&&M.nearEqual(t[1],e[1])&&M.nearEqual(t[2],e[2])&&M.nearEqual(t[3],e[3])&&M.nearEqual(t[4],e[4])&&M.nearEqual(t[5],e[5])&&M.nearEqual(t[6],e[6])&&M.nearEqual(t[7],e[7])&&M.nearEqual(t[8],e[8])&&M.nearEqual(t[9],e[9])&&M.nearEqual(t[10],e[10])&&M.nearEqual(t[11],e[11])&&M.nearEqual(t[12],e[12])&&M.nearEqual(t[13],e[13])&&M.nearEqual(t[14],e[14])&&M.nearEqual(t[15],e[15])},u.decomposeTransRotScale=function(e,t,n){var i=ji._tempMatrix4x4;return this.decomposeTransRotMatScale(e,i,n)?($i.createFromMatrix4x4(i,t),!0):(t.identity(),!1)},u.decomposeTransRotMatScale=function(e,t,n){var i,r,a,o=this.elements,e=e.elements,t=t.elements,n=n.elements,e=(e[0]=o[12],e[1]=o[13],e[2]=o[14],o[0]),s=o[1],l=o[2],h=o[4],_=o[5],u=o[6],d=o[8],c=o[9],o=o[10],f=n[0]=Math.sqrt(e*e+s*s+l*l),m=n[1]=Math.sqrt(h*h+_*_+u*u),p=n[2]=Math.sqrt(d*d+c*c+o*o);return M.isZero(f)||M.isZero(m)||M.isZero(p)?(t[1]=t[2]=t[3]=t[4]=t[6]=t[7]=t[8]=t[9]=t[11]=t[12]=t[13]=t[14]=0,!(t[0]=t[5]=t[10]=t[15]=1)):((a=(i=ji._tempVector0).elements)[0]=d/p,a[1]=c/p,a[2]=o/p,(r=(a=ji._tempVector1).elements)[0]=e/f,r[1]=s/f,r[2]=l/f,W.cross(i,a,r=ji._tempVector2),W.cross(r,i,a=ji._tempVector1),t[3]=t[7]=t[11]=t[12]=t[13]=t[14]=0,t[15]=1,t[0]=a.x,t[1]=a.y,t[2]=a.z,t[4]=r.x,t[5]=r.y,t[6]=r.z,t[8]=i.x,t[9]=i.y,t[10]=i.z,t[0]*e+t[1]*s+t[2]*l<0&&(n[0]=-f),t[4]*h+t[5]*_+t[6]*u<0&&(n[1]=-m),t[8]*d+t[9]*c+t[10]*o<0&&(n[2]=-p),!0)},u.decomposeYawPitchRoll=function(e){var e=e.elements,t=Math.asin(-this.elements[9]);e[1]=t,Math.cos(t)>M.zeroTolerance?(e[2]=Math.atan2(this.elements[1],this.elements[5]),e[0]=Math.atan2(this.elements[8],this.elements[10])):(e[2]=Math.atan2(-this.elements[4],this.elements[0]),e[0]=0)},u.normalize=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=Math.sqrt(t*t+n*n+i*i);r?1!=r&&(e[0]=t*(r=1/r),e[1]=n*r,e[2]=i*r):(e[0]=0,e[1]=0,e[2]=0)},u.transpose=function(){var e=this.elements,t=e[1];return e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},u.invert=function(e){var t=this.elements,e=e.elements,n=t[0],i=t[1],r=t[2],a=t[3],o=t[4],s=t[5],l=t[6],h=t[7],_=t[8],u=t[9],d=t[10],c=t[11],f=t[12],m=t[13],p=t[14],t=t[15],E=n*s-i*o,g=n*l-r*o,v=n*h-a*o,T=i*l-r*s,S=i*h-a*s,D=r*h-a*l,x=_*m-u*f,M=_*p-d*f,R=_*t-c*f,I=u*p-d*m,A=u*t-c*m,C=d*t-c*p,y=E*C-g*A+v*I+T*R-S*M+D*x;0!==Math.abs(y)&&(e[0]=(s*C-l*A+h*I)*(y=1/y),e[1]=(r*A-i*C-a*I)*y,e[2]=(m*D-p*S+t*T)*y,e[3]=(d*S-u*D-c*T)*y,e[4]=(l*R-o*C-h*M)*y,e[5]=(n*C-r*R+a*M)*y,e[6]=(p*v-f*D-t*g)*y,e[7]=(_*D-d*v+c*g)*y,e[8]=(o*A-s*R+h*x)*y,e[9]=(i*R-n*A-a*x)*y,e[10]=(f*S-m*v+t*E)*y,e[11]=(u*v-_*S-c*E)*y,e[12]=(s*M-o*I-l*x)*y,e[13]=(n*I-i*M+r*x)*y,e[14]=(m*g-f*T-p*E)*y,e[15]=(_*T-u*g+d*E)*y)},u.identity=function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1},u.cloneTo=function(e){var t,n=this.elements,i=e.elements;if(n!==i)for(t=0;t<16;++t)i[t]=n[t]},u.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},u.getTranslationVector=function(e){var t=this.elements,e=e.elements;e[0]=t[12],e[1]=t[13],e[2]=t[14]},u.setTranslationVector=function(e){var t=this.elements,e=e.elements;t[12]=e[0],t[13]=e[1],t[14]=e[2]},u.getForward=function(e){var t=this.elements,e=e.elements;e[0]=-t[8],e[1]=-t[9],e[2]=-t[10]},u.setForward=function(e){var t=this.elements,e=e.elements;t[8]=-e[0],t[9]=-e[1],t[10]=-e[2]},ji.createRotationX=function(e,t){var t=t.elements,n=Math.sin(e),e=Math.cos(e);t[1]=t[2]=t[3]=t[4]=t[7]=t[8]=t[11]=t[12]=t[13]=t[14]=0,t[0]=t[15]=1,t[5]=t[10]=e,t[6]=n,t[9]=-n},ji.createRotationY=function(e,t){var t=t.elements,n=Math.sin(e),e=Math.cos(e);t[1]=t[3]=t[4]=t[6]=t[7]=t[9]=t[11]=t[12]=t[13]=t[14]=0,t[5]=t[15]=1,t[0]=t[10]=e,t[2]=-n,t[8]=n},ji.createRotationZ=function(e,t){var t=t.elements,n=Math.sin(e),e=Math.cos(e);t[2]=t[3]=t[6]=t[7]=t[8]=t[9]=t[11]=t[12]=t[13]=t[14]=0,t[10]=t[15]=1,t[0]=t[5]=e,t[1]=n,t[4]=-n},ji.createRotationYawPitchRoll=function(e,t,n,i){$i.createFromYawPitchRoll(e,t,n,ji._tempQuaternion),ji.createRotationQuaternion(ji._tempQuaternion,i)},ji.createRotationAxis=function(e,t,n){var e=e.elements,i=e[0],r=e[1],e=e[2],a=Math.cos(t),t=Math.sin(t),o=i*i,s=r*r,l=e*e,h=i*r,_=i*e,u=r*e,n=n.elements;n[3]=n[7]=n[11]=n[12]=n[13]=n[14]=0,n[15]=1,n[0]=o+a*(1-o),n[1]=h-a*h+t*e,n[2]=_-a*_-t*r,n[4]=h-a*h-t*e,n[5]=s+a*(1-s),n[6]=u-a*u+t*i,n[8]=_-a*_+t*r,n[9]=u-a*u-t*i,n[10]=l+a*(1-l)},ji.createRotationQuaternion=function(e,t){var e=e.elements,t=t.elements,n=e[0],i=e[1],r=e[2],e=e[3],a=n*n,o=i*i,s=r*r,l=n*i,h=r*e,_=r*n,u=i*e,i=i*r,r=n*e;t[3]=t[7]=t[11]=t[12]=t[13]=t[14]=0,t[15]=1,t[0]=1-2*(o+s),t[1]=2*(l+h),t[2]=2*(_-u),t[4]=2*(l-h),t[5]=1-2*(s+a),t[6]=2*(i+r),t[8]=2*(_+u),t[9]=2*(i-r),t[10]=1-2*(o+a)},ji.createTranslate=function(e,t){e=e.elements,t=t.elements;t[4]=t[8]=t[1]=t[9]=t[2]=t[6]=t[3]=t[7]=t[11]=0,t[0]=t[5]=t[10]=t[15]=1,t[12]=e[0],t[13]=e[1],t[14]=e[2]},ji.createScaling=function(e,t){e=e.elements,t=t.elements;t[0]=e[0],t[5]=e[1],t[10]=e[2],t[1]=t[4]=t[8]=t[12]=t[9]=t[13]=t[2]=t[6]=t[14]=t[3]=t[7]=t[11]=0,t[15]=1},ji.multiply=function(e,t,n){var i,r,a,o,s,l=n.elements,h=e.elements,_=t.elements;if(l===_)for(_=new Float32Array(16),i=0;i<16;++i)_[i]=l[i];for(i=0;i<4;i++)r=h[i],a=h[i+4],o=h[i+8],s=h[i+12],l[i]=r*_[0]+a*_[1]+o*_[2]+s*_[3],l[i+4]=r*_[4]+a*_[5]+o*_[6]+s*_[7],l[i+8]=r*_[8]+a*_[9]+o*_[10]+s*_[11],l[i+12]=r*_[12]+a*_[13]+o*_[14]+s*_[15]},ji.createFromQuaternion=function(e,t){var t=t.elements,e=e.elements,n=e[0],i=e[1],r=e[2],e=e[3],a=n+n,o=i+i,s=r+r,n=n*a,l=i*a,i=i*o,h=r*a,_=r*o,r=r*s,a=e*a,o=e*o,e=e*s;t[0]=1-i-r,t[1]=l+e,t[2]=h-o,t[3]=0,t[4]=l-e,t[5]=1-n-r,t[6]=_+a,t[7]=0,t[8]=h+o,t[9]=_-a,t[10]=1-n-i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},ji.createAffineTransformation=function(e,t,n,i){var e=e.elements,t=t.elements,n=n.elements,i=i.elements,r=t[0],a=t[1],o=t[2],t=t[3],s=r+r,l=a+a,h=o+o,_=r*s,u=r*l,r=r*h,d=a*l,a=a*h,o=o*h,s=t*s,l=t*l,t=t*h,h=n[0],c=n[1],n=n[2];i[0]=(1-(d+o))*h,i[1]=(u+t)*h,i[2]=(r-l)*h,i[3]=0,i[4]=(u-t)*c,i[5]=(1-(_+o))*c,i[6]=(a+s)*c,i[7]=0,i[8]=(r+l)*n,i[9]=(a-s)*n,i[10]=(1-(_+d))*n,i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1},ji.createLookAt=function(e,t,n,i){var r=i.elements,a=ji._tempVector0,o=ji._tempVector1,s=ji._tempVector2;W.subtract(e,t,s),W.normalize(s,s),W.cross(n,s,a),W.normalize(a,a),W.cross(s,a,o),i.identity(),r[0]=a.x,r[4]=a.y,r[8]=a.z,r[1]=o.x,r[5]=o.y,r[9]=o.z,r[2]=s.x,r[6]=s.y,r[10]=s.z,r[12]=-W.dot(a,e),r[13]=-W.dot(o,e),r[14]=-W.dot(s,e)},ji.createPerspective=function(e,t,n,i,r){var r=r.elements,e=1/Math.tan(e/2),a=1/(n-i);r[0]=e/t,r[5]=e,r[10]=(i+n)*a,r[11]=-1,r[14]=2*i*n*a,r[1]=r[2]=r[3]=r[4]=r[6]=r[7]=r[8]=r[9]=r[12]=r[13]=r[15]=0},ji.createOrthoOffCenterRH=function(e,t,n,i,r,a,o){var o=o.elements,s=1/(e-t),l=1/(n-i),h=1/(r-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=0,o[15]=1,o[0]=-2*s,o[5]=-2*l,o[10]=2*h,o[12]=(e+t)*s,o[13]=(i+n)*l,o[14]=(a+r)*h},ji.translation=function(e,t){e=e.elements,t=t.elements;t[0]=t[5]=t[10]=t[15]=1,t[12]=e[0],t[13]=e[1],t[14]=e[2]},e(ji,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new ji},"_tempVector0",function(){return this._tempVector0=new W},"_tempVector1",function(){return this._tempVector1=new W},"_tempVector2",function(){return this._tempVector2=new W},"_tempQuaternion",function(){return this._tempQuaternion=new $i},"DEFAULT",function(){return this.DEFAULT=new ji},"ZERO",function(){return this.ZERO=new ji(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}]);var R=ji;function ji(e,t,n,i,r,a,o,s,l,h,_,u,d,c,f,m){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===l&&(l=0),void 0===h&&(h=0),void 0===_&&(_=1),void 0===u&&(u=0),void 0===d&&(d=0),void 0===c&&(c=0),void 0===f&&(f=0),void 0===m&&(m=1);var p=this.elements=new Float32Array(16);p[0]=e,p[1]=t,p[2]=n,p[3]=i,p[4]=r,p[5]=a,p[6]=o,p[7]=s,p[8]=l,p[9]=h,p[10]=_,p[11]=u,p[12]=d,p[13]=c,p[14]=f,p[15]=m}t(E,"laya.d3.math.OrientedBoundBox"),(u=E.prototype).getCorners=function(e){var t=E._tempV30.elements,n=E._tempV31.elements,i=E._tempV32.elements,r=this.extents.elements,t=(t[0]=r[0],t[1]=t[2]=0,n[1]=r[1],n[0]=n[2]=0,i[2]=r[2],i[0]=i[1]=0,W.TransformNormal(E._tempV30,this.transformation,E._tempV30),W.TransformNormal(E._tempV31,this.transformation,E._tempV31),W.TransformNormal(E._tempV32,this.transformation,E._tempV32),E._tempV33);this.transformation.getTranslationVector(t),e.length=8,W.add(t,E._tempV30,E._tempV34),W.add(E._tempV34,E._tempV31,E._tempV34),W.add(E._tempV34,E._tempV32,e[0]),W.add(t,E._tempV30,E._tempV34),W.add(E._tempV34,E._tempV31,E._tempV34),W.subtract(E._tempV34,E._tempV32,e[1]),W.subtract(t,E._tempV30,E._tempV34),W.add(E._tempV34,E._tempV31,E._tempV34),W.subtract(E._tempV34,E._tempV32,e[2]),W.subtract(t,E._tempV30,E._tempV34),W.add(E._tempV34,E._tempV31,E._tempV34),W.add(E._tempV34,E._tempV32,e[3]),W.add(t,E._tempV30,E._tempV34),W.subtract(E._tempV34,E._tempV31,E._tempV34),W.add(E._tempV34,E._tempV32,e[4]),W.add(t,E._tempV30,E._tempV34),W.subtract(E._tempV34,E._tempV31,E._tempV34),W.subtract(E._tempV34,E._tempV32,e[5]),W.subtract(t,E._tempV30,E._tempV34),W.subtract(E._tempV34,E._tempV31,E._tempV34),W.subtract(E._tempV34,E._tempV32,e[6]),W.subtract(t,E._tempV30,E._tempV34),W.subtract(E._tempV34,E._tempV31,E._tempV34),W.add(E._tempV34,E._tempV32,e[7])},u.transform=function(e){R.multiply(this.transformation,e,this.transformation)},u.scale=function(e){W.multiply(this.extents,e,this.extents)},u.translate=function(e){this.transformation.getTranslationVector(E._tempV30),W.add(E._tempV30,e,E._tempV31),this.transformation.setTranslationVector(E._tempV31)},u.Size=function(e){W.scale(this.extents,2,e)},u.getSize=function(e){var t=this.extents.elements,t=(E._tempV30.x=t[0],E._tempV31.y=t[1],E._tempV32.z=t[2],W.TransformNormal(E._tempV30,this.transformation,E._tempV30),W.TransformNormal(E._tempV31,this.transformation,E._tempV31),W.TransformNormal(E._tempV31,this.transformation,E._tempV32),e.elements);t[0]=W.scalarLength(E._tempV30),t[1]=W.scalarLength(E._tempV31),t[2]=W.scalarLength(E._tempV32)},u.getSizeSquared=function(e){var t=this.extents.elements,t=(E._tempV30.x=t[0],E._tempV31.y=t[1],E._tempV32.z=t[2],W.TransformNormal(E._tempV30,this.transformation,E._tempV30),W.TransformNormal(E._tempV31,this.transformation,E._tempV31),W.TransformNormal(E._tempV31,this.transformation,E._tempV32),e.elements);t[0]=W.scalarLengthSquared(E._tempV30),t[1]=W.scalarLengthSquared(E._tempV31),t[2]=W.scalarLengthSquared(E._tempV32)},u.getCenter=function(e){this.transformation.getTranslationVector(e)},u.containsPoint=function(e){var t=this.extents.elements,n=t[0],i=t[1],t=t[2],e=(this.transformation.invert(E._tempM0),W.transformCoordinate(e,E._tempM0,E._tempV30),E._tempV30.elements),r=Math.abs(e[0]),a=Math.abs(e[1]),e=Math.abs(e[2]);return M.nearEqual(r,n)&&M.nearEqual(a,i)&&M.nearEqual(e,t)?2:r<n&&a<i&&e<t?1:0},u.containsPoints=function(e){for(var t=this.extents.elements,n=t[0],i=t[1],r=t[2],a=(this.transformation.invert(E._tempM0),!0),o=!1,s=0;s<e.length;s++){W.transformCoordinate(e[s],E._tempM0,E._tempV30);var l=E._tempV30.elements,h=Math.abs(l[0]),_=Math.abs(l[1]),l=Math.abs(l[2]);M.nearEqual(h,n)&&M.nearEqual(_,i)&&M.nearEqual(l,r)&&(o=!0),h<n&&_<i&&l<r?o=!0:a=!1}return a?1:o?2:0},u.containsSphere=function(e,t){void 0===t&&(t=!1);var n,i,r,a,o=this.extents.elements,s=o[0],l=o[1],o=o[2],h=e.radius,e=(this.transformation.invert(E._tempM0),W.transformCoordinate(e.center,E._tempM0,E._tempV30),NaN),e=t?h:(W.scale(W.UnitX,h,E._tempV31),W.TransformNormal(E._tempV31,E._tempM0,E._tempV31),W.scalarLength(E._tempV31));return W.scale(this.extents,-1,E._tempV32),W.Clamp(E._tempV30,E._tempV32,this.extents,E._tempV33),e*e<W.distanceSquared(E._tempV30,E._tempV33)?0:(h=(t=E._tempV30.elements)[0],n=t[1],t=t[2],i=(a=E._tempV32.elements)[0],r=a[1],a=a[2],i+e<=h&&h<=s-e&&e<s-i&&r+e<=n&&n<=l-e&&e<l-r&&a+e<=t&&t<=o-e&&e<o-a?1:2)},u.containsOrientedBoundBox=function(e){var t=0,n=0,i=(e.getCorners(E._corners),this.containsPoints(E._corners));if(0!=i)return i;for(var r,a=this.extents.elements,o=(e.extents.cloneTo(E._tempV35),E._tempV35.elements),t=(E._getRows(this.transformation,E._rows1),E._getRows(e.transformation,E._rows2),0);t<4;t++)for(n=0;n<4;n++)3==t||3==n?(E._tempM0.setElementByRowColumn(t,n,0),E._tempM1.setElementByRowColumn(t,n,0)):(r=W.dot(E._rows1[t],E._rows2[n]),E._tempM0.setElementByRowColumn(t,n,r),E._tempM1.setElementByRowColumn(t,n,Math.abs(r)));e.getCenter(E._tempV34),this.getCenter(E._tempV36),W.subtract(E._tempV34,E._tempV36,E._tempV30);var s=E._tempV31.elements,l=(s[0]=W.dot(E._tempV30,E._rows1[0]),s[1]=W.dot(E._tempV30,E._rows1[1]),s[2]=W.dot(E._tempV30,E._rows1[2]),E._tempV32.elements),h=E._tempV33.elements;for(t=0;t<3;t++)if(l[0]=E._tempM1.getElementByRowColumn(t,0),l[1]=E._tempM1.getElementByRowColumn(t,1),l[2]=E._tempM1.getElementByRowColumn(t,2),a[t]+W.dot(E._tempV35,E._tempV32)<Math.abs(s[t]))return 0;for(n=0;n<3;n++)if(l[0]=E._tempM1.getElementByRowColumn(0,n),l[1]=E._tempM1.getElementByRowColumn(1,n),l[2]=E._tempM1.getElementByRowColumn(2,n),h[0]=E._tempM0.getElementByRowColumn(0,n),h[1]=E._tempM0.getElementByRowColumn(1,n),h[2]=E._tempM0.getElementByRowColumn(2,n),W.dot(this.extents,E._tempV32)+o[n]<Math.abs(W.dot(E._tempV31,E._tempV33)))return 0;for(t=0;t<3;t++)for(n=0;n<3;n++){var _=(t+1)%3,u=(t+2)%3,d=(n+1)%3,c=(n+2)%3;if(a[_]*E._tempM1.getElementByRowColumn(u,n)+a[u]*E._tempM1.getElementByRowColumn(_,n)+(o[d]*E._tempM1.getElementByRowColumn(t,c)+o[c]*E._tempM1.getElementByRowColumn(t,d))<Math.abs(s[u]*E._tempM0.getElementByRowColumn(_,n)-s[_]*E._tempM0.getElementByRowColumn(u,n)))return 0}return 2},u.containsLine=function(e,t){E._corners[0]=e,E._corners[1]=t;var n,i,r,a,o,s,l,h,_,u=this.containsPoints(E._corners);return 0!=u?u:(n=(u=this.extents.elements)[0],i=u[1],u=u[2],this.transformation.invert(E._tempM0),W.transformCoordinate(e,E._tempM0,E._tempV30),W.transformCoordinate(t,E._tempM0,E._tempV31),W.add(E._tempV30,E._tempV31,E._tempV32),W.scale(E._tempV32,.5,E._tempV32),W.subtract(E._tempV30,E._tempV32,E._tempV33),t=(e=E._tempV33.elements)[0],r=e[1],a=e[2],o=(l=E._tempV34.elements)[0]=Math.abs(e[0]),s=l[1]=Math.abs(e[1]),l=l[2]=Math.abs(e[2]),h=(e=E._tempV32.elements)[0],_=e[1],e=e[2],Math.abs(h)>n+o||Math.abs(_)>i+s||Math.abs(e)>u+l||Math.abs(_*a-e*r)>i*l+u*s||Math.abs(h*a-e*t)>n*l+u*o||Math.abs(h*r-_*t)>n*s+i*o?0:2)},u.containsBoundBox=function(e){var t=0,n=0,i=e.min,r=e.max,e=(e.getCorners(E._corners),this.containsPoints(E._corners));if(0!=e)return e;W.subtract(r,i,E._tempV30),W.scale(E._tempV30,.5,E._tempV30),W.add(i,E._tempV30,E._tempV30),W.subtract(r,E._tempV30,E._tempV31);for(var a=this.extents.elements,o=E._tempV31.elements,t=(E._getRows(this.transformation,E._rows1),this.transformation.invert(E._tempM0),0);t<3;t++)for(n=0;n<3;n++)E._tempM1.setElementByRowColumn(t,n,Math.abs(E._tempM0.getElementByRowColumn(t,n)));this.getCenter(E._tempV35),W.subtract(E._tempV30,E._tempV35,E._tempV32);var s=E._tempV31.elements,l=(s[0]=W.dot(E._tempV32,E._rows1[0]),s[1]=W.dot(E._tempV32,E._rows1[1]),s[2]=W.dot(E._tempV32,E._rows1[2]),E._tempV33.elements),h=E._tempV34.elements;for(t=0;t<3;t++)if(l[0]=E._tempM1.getElementByRowColumn(t,0),l[1]=E._tempM1.getElementByRowColumn(t,1),l[2]=E._tempM1.getElementByRowColumn(t,2),a[t]+W.dot(E._tempV31,E._tempV33)<Math.abs(s[t]))return 0;for(n=0;n<3;n++)if(l[0]=E._tempM1.getElementByRowColumn(0,n),l[1]=E._tempM1.getElementByRowColumn(1,n),l[2]=E._tempM1.getElementByRowColumn(2,n),h[0]=E._tempM0.getElementByRowColumn(0,n),h[1]=E._tempM0.getElementByRowColumn(1,n),h[2]=E._tempM0.getElementByRowColumn(2,n),W.dot(this.extents,E._tempV33)+o[n]<Math.abs(W.dot(E._tempV31,E._tempV34)))return 0;for(t=0;t<3;t++)for(n=0;n<3;n++){var _=(t+1)%3,u=(t+2)%3,d=(n+1)%3,c=(n+2)%3;if(a[_]*E._tempM1.getElementByRowColumn(u,n)+a[u]*E._tempM1.getElementByRowColumn(_,n)+(o[d]*E._tempM1.getElementByRowColumn(t,c)+o[c]*E._tempM1.getElementByRowColumn(t,d))<Math.abs(s[u]*E._tempM0.getElementByRowColumn(_,n)-s[_]*E._tempM0.getElementByRowColumn(u,n)))return 0}return 2},u.intersectsRay=function(e,t){W.scale(this.extents,-1,E._tempV30),this.transformation.invert(E._tempM0),W.TransformNormal(e.direction,E._tempM0,E._ray.direction),W.transformCoordinate(e.origin,E._tempM0,E._ray.origin),E._boxBound1.min=E._tempV30,E._boxBound1.max=this.extents;e=Wi.intersectsRayAndBoxRP(E._ray,E._boxBound1,t);return-1!==e&&W.transformCoordinate(t,this.transformation,t),e},u._getLocalCorners=function(e){e.length=8;var t=this.extents.elements;E._tempV30.x=t[0],E._tempV31.y=t[1],E._tempV32.z=t[2],W.add(E._tempV30,E._tempV31,E._tempV33),W.add(E._tempV33,E._tempV32,e[0]),W.add(E._tempV30,E._tempV31,E._tempV33),W.subtract(E._tempV33,E._tempV32,e[1]),W.subtract(E._tempV31,E._tempV30,E._tempV33),W.subtract(E._tempV33,E._tempV30,e[2]),W.subtract(E._tempV31,E._tempV30,E._tempV33),W.add(E._tempV33,E._tempV32,e[3]),W.subtract(E._tempV30,E._tempV31,E._tempV33),W.add(E._tempV33,E._tempV32,e[4]),W.subtract(E._tempV30,E._tempV31,E._tempV33),W.subtract(E._tempV33,E._tempV32,e[5]),W.scale(e[0],-1,e[6]),W.subtract(E._tempV32,E._tempV30,E._tempV33),W.subtract(E._tempV33,E._tempV31,e[7])},u.equals=function(e){return this.extents==e.extents&&this.transformation==e.transformation},u.cloneTo=function(e){this.extents.cloneTo(e.extents),this.transformation.cloneTo(e.transformation)},E.createByBoundBox=function(e,t){var n=e.min,e=e.max,n=(W.subtract(e,n,E._tempV30),W.scale(E._tempV30,.5,E._tempV30),W.add(n,E._tempV30,E._tempV31),W.subtract(e,E._tempV31,E._tempV32),R.translation(E._tempV31,E._tempM0),E._tempV32.clone()),e=E._tempM0.clone();t.extents=n,t.transformation=e},E.createByMinAndMaxVertex=function(e,t){return W.subtract(t,e,E._tempV30),W.scale(E._tempV30,.5,E._tempV30),W.add(e,E._tempV30,E._tempV31),W.subtract(t,E._tempV31,E._tempV32),R.translation(E._tempV31,E._tempM0),new E(E._tempV32,E._tempM0)},E._getRows=function(e,t){t.length=3;var e=e.elements,n=t[0].elements,n=(n[0]=e[0],n[1]=e[1],n[2]=e[2],t[1].elements),n=(n[0]=e[4],n[1]=e[5],n[2]=e[6],t[2].elements);n[0]=e[8],n[1]=e[9],n[2]=e[10]},E.getObbtoObbMatrix4x4=function(e,t,n,i){var r=e.transformation,a=t.transformation;if(n){E._getRows(r,E._rows1),E._getRows(a,E._rows2);for(var o=0;o<3;o++)for(var s=0;s<3;s++)i.setElementByRowColumn(o,s,W.dot(E._rows2[o],E._rows1[s]));t.getCenter(E._tempV30),e.getCenter(E._tempV31),W.subtract(E._tempV30,E._tempV31,E._tempV32);n=i.elements;n[12]=W.dot(E._tempV32,E._rows1[0]),n[13]=W.dot(E._tempV32,E._rows1[1]),n[14]=W.dot(E._tempV32,E._rows1[2]),n[15]=1}else r.invert(E._tempM0),R.multiply(a,E._tempM0,i)},E.merge=function(e,t,n){var i=e.extents,r=e.transformation,e=(E.getObbtoObbMatrix4x4(e,t,n,E._tempM0),t._getLocalCorners(E._corners),W.transformCoordinate(E._corners[0],E._tempM0,E._corners[0]),W.transformCoordinate(E._corners[1],E._tempM0,E._corners[1]),W.transformCoordinate(E._corners[2],E._tempM0,E._corners[2]),W.transformCoordinate(E._corners[3],E._tempM0,E._corners[3]),W.transformCoordinate(E._corners[4],E._tempM0,E._corners[4]),W.transformCoordinate(E._corners[5],E._tempM0,E._corners[5]),W.transformCoordinate(E._corners[6],E._tempM0,E._corners[6]),W.transformCoordinate(E._corners[7],E._tempM0,E._corners[7]),W.scale(i,-1,E._boxBound1.min),i.cloneTo(E._boxBound1.max),bi.createfromPoints(E._corners,E._boxBound2),bi.merge(E._boxBound2,E._boxBound1,E._boxBound3),E._boxBound3.min),n=E._boxBound3.max;W.subtract(n,e,E._tempV30),W.scale(E._tempV30,.5,E._tempV30),W.add(e,E._tempV30,E._tempV32),W.subtract(n,E._tempV32,i),W.transformCoordinate(E._tempV32,r,E._tempV33)},e(E,["_tempV30",function(){return this._tempV30=new W},"_tempV31",function(){return this._tempV31=new W},"_tempV32",function(){return this._tempV32=new W},"_tempV33",function(){return this._tempV33=new W},"_tempV34",function(){return this._tempV34=new W},"_tempV35",function(){return this._tempV35=new W},"_tempV36",function(){return this._tempV36=new W},"_tempM0",function(){return this._tempM0=new R},"_tempM1",function(){return this._tempM1=new R},"_corners",function(){return this._corners=[new W,new W,new W,new W,new W,new W,new W,new W]},"_rows1",function(){return this._rows1=[new W,new W,new W]},"_rows2",function(){return this._rows2=[new W,new W,new W]},"_ray",function(){return this._ray=new ir(new W,new W)},"_boxBound1",function(){return this._boxBound1=new bi(new W,new W)},"_boxBound2",function(){return this._boxBound2=new bi(new W,new W)},"_boxBound3",function(){return this._boxBound3=new bi(new W,new W)}]);var Ki=E;function E(e,t){this.extents=null,this.transformation=null,this.extents=e,this.transformation=t}t(Qi,"laya.d3.math.Plane"),Qi.prototype.normalize=function(){var e=this.normal.elements,t=e[0],n=e[1],i=e[2],r=1/Math.sqrt(t*t+n*n+i*i);e[0]=t*r,e[1]=n*r,e[2]=i*r,this.distance*=r},Qi.createPlaneBy3P=function(e,t,n){var e=e.elements,t=t.elements,n=n.elements,i=t[0]-e[0],r=t[1]-e[1],t=t[2]-e[2],a=n[0]-e[0],o=n[1]-e[1],n=n[2]-e[2],s=r*n-t*o,t=t*a-i*n,n=i*o-r*a,i=1/Math.sqrt(s*s+t*t+n*n),o=s*i,r=t*i,a=n*i,s=Qi._TEMPVec3.elements,t=(s[0]=o,s[1]=r,s[2]=a,-(o*e[0]+r*e[1]+a*e[2]));return new Qi(Qi._TEMPVec3,t)},Qi.PlaneIntersectionType_Back=0,Qi.PlaneIntersectionType_Front=1,Qi.PlaneIntersectionType_Intersecting=2,e(Qi,["_TEMPVec3",function(){return this._TEMPVec3=new W}]);var qi=Qi;function Qi(e,t){this.normal=null,this.distance=NaN,void 0===t&&(t=0),this.normal=e,this.distance=t}t(Ji,"laya.d3.math.Quaternion"),u=Ji.prototype,v.imps(u,{"laya.d3.core.IClone":!0}),u.scaling=function(e,t){var t=t.elements,n=this.elements;t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t[3]=n[3]*e},u.normalize=function(e){var e=e.elements,t=this.elements,n=t[0],i=t[1],r=t[2],t=t[3],a=n*n+i*i+r*r+t*t;0<a&&(a=1/Math.sqrt(a),e[0]=n*a,e[1]=i*a,e[2]=r*a,e[3]=t*a)},u.length=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],e=e[3];return Math.sqrt(t*t+n*n+i*i+e*e)},u.rotateX=function(e,t){var t=t.elements,n=this.elements,i=(e*=.5,n[0]),r=n[1],a=n[2],n=n[3],o=Math.sin(e),e=Math.cos(e);t[0]=i*e+n*o,t[1]=r*e+a*o,t[2]=a*e-r*o,t[3]=n*e-i*o},u.rotateY=function(e,t){var t=t.elements,n=this.elements,i=(e*=.5,n[0]),r=n[1],a=n[2],n=n[3],o=Math.sin(e),e=Math.cos(e);t[0]=i*e-a*o,t[1]=r*e+n*o,t[2]=a*e+i*o,t[3]=n*e-r*o},u.rotateZ=function(e,t){var t=t.elements,n=this.elements,i=(e*=.5,n[0]),r=n[1],a=n[2],n=n[3],o=Math.sin(e),e=Math.cos(e);t[0]=i*e+r*o,t[1]=r*e-i*o,t[2]=a*e+n*o,t[3]=n*e-a*o},u.getYawPitchRoll=function(e){W.transformQuat(W.ForwardRH,this,Ji.TEMPVector31),W.transformQuat(W.Up,this,Ji.TEMPVector32);var t=Ji.TEMPVector32.elements,n=(Ji.angleTo(W.ZERO,Ji.TEMPVector31,Ji.TEMPVector33),Ji.TEMPVector33.elements),t=(n[0]==Math.PI/2?(n[1]=Ji.arcTanAngle(t[2],t[0]),n[2]=0):n[0]==-Math.PI/2?(n[1]=Ji.arcTanAngle(-t[2],-t[0]),n[2]=0):(R.createRotationY(-n[1],Ji.TEMPMatrix0),R.createRotationX(-n[0],Ji.TEMPMatrix1),W.transformCoordinate(Ji.TEMPVector32,Ji.TEMPMatrix0,Ji.TEMPVector32),W.transformCoordinate(Ji.TEMPVector32,Ji.TEMPMatrix1,Ji.TEMPVector32),n[2]=Ji.arcTanAngle(t[1],-t[0])),n[1]<=-Math.PI&&(n[1]=Math.PI),n[2]<=-Math.PI&&(n[2]=Math.PI),n[1]>=Math.PI&&n[2]>=Math.PI&&(n[1]=0,n[2]=0,n[0]=Math.PI-n[0]),e.elements);t[0]=n[1],t[1]=n[0],t[2]=n[2]},u.invert=function(e){var e=e.elements,t=this.elements,n=t[0],i=t[1],r=t[2],t=t[3],a=n*n+i*i+r*r+t*t,a=a?1/a:0;e[0]=-n*a,e[1]=-i*a,e[2]=-r*a,e[3]=t*a},u.identity=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1},u.fromArray=function(e,t){this.elements[0]=e[(t=void 0===t?0:t)+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]},u.cloneTo=function(e){var t,n=this.elements,i=e.elements;if(n!==i)for(t=0;t<4;++t)i[t]=n[t]},u.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},u.equals=function(e){var t=this.elements,e=e.elements;return M.nearEqual(t[0],e[0])&&M.nearEqual(t[1],e[1])&&M.nearEqual(t[2],e[2])&&M.nearEqual(t[3],e[3])},u.lengthSquared=function(){var e=this.elements[0],t=this.elements[1],n=this.elements[2],i=this.elements[3];return e*e+t*t+n*n+i*i},n(0,u,"x",function(){return this.elements[0]}),n(0,u,"y",function(){return this.elements[1]}),n(0,u,"z",function(){return this.elements[2]}),n(0,u,"w",function(){return this.elements[3]}),Ji.createFromYawPitchRoll=function(e,t,n,i){var n=.5*n,t=.5*t,e=.5*e,r=Math.sin(n),n=Math.cos(n),a=Math.sin(t),t=Math.cos(t),o=Math.sin(e),e=Math.cos(e),i=i.elements;i[0]=e*a*n+o*t*r,i[1]=o*t*n-e*a*r,i[2]=e*t*r-o*a*n,i[3]=e*t*n+o*a*r},Ji.multiply=function(e,t,n){var e=e.elements,t=t.elements,n=n.elements,i=e[0],r=e[1],a=e[2],e=e[3],o=t[0],s=t[1],l=t[2],t=t[3],h=a*o-i*l,_=i*s-r*o,u=i*o+r*s+a*l;n[0]=i*t+o*e+(r*l-a*s),n[1]=r*t+s*e+h,n[2]=a*t+l*e+_,n[3]=e*t-u},Ji.arcTanAngle=function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:0<e?Math.atan(t/e):e<0?0<t?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0},Ji.angleTo=function(e,t,n){W.subtract(t,e,Ji.TEMPVector30),W.normalize(Ji.TEMPVector30,Ji.TEMPVector30),n.elements[0]=Math.asin(Ji.TEMPVector30.y),n.elements[1]=Ji.arcTanAngle(-Ji.TEMPVector30.z,-Ji.TEMPVector30.x)},Ji.createFromAxisAngle=function(e,t,n){var n=n.elements,e=e.elements,i=(t*=.5,Math.sin(t));n[0]=i*e[0],n[1]=i*e[1],n[2]=i*e[2],n[3]=Math.cos(t)},Ji.createFromMatrix3x3=function(e,t){var n,i,r,t=t.elements,e=e.elements,a=e[0]+e[4]+e[8];0<a?(r=Math.sqrt(a+1),t[3]=.5*r,t[0]=(e[5]-e[7])*(r=.5/r),t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r):(e[4]>e[a=0]&&(a=1),n=((a=e[8]>e[3*a+a]?2:a)+1)%3,i=(a+2)%3,r=Math.sqrt(e[3*a+a]-e[3*n+n]-e[3*i+i]+1),t[a]=.5*r,t[3]=(e[3*n+i]-e[3*i+n])*(r=.5/r),t[n]=(e[3*n+a]+e[3*a+n])*r,t[i]=(e[3*i+a]+e[3*a+i])*r)},Ji.createFromMatrix4x4=function(e,t){var n,i,e=e.elements,t=t.elements,r=e[0]+e[5]+e[10];0<r?(n=Math.sqrt(r+1),t[3]=.5*n,t[0]=(e[6]-e[9])*(n=.5/n),t[1]=(e[8]-e[2])*n,t[2]=(e[1]-e[4])*n):e[0]>=e[5]&&e[0]>=e[10]?(i=.5/(n=Math.sqrt(1+e[0]-e[5]-e[10])),t[0]=.5*n,t[1]=(e[1]+e[4])*i,t[2]=(e[2]+e[8])*i,t[3]=(e[6]-e[9])*i):e[5]>e[10]?(n=Math.sqrt(1+e[5]-e[0]-e[10]),t[0]=(e[4]+e[1])*(i=.5/n),t[1]=.5*n,t[2]=(e[9]+e[6])*i,t[3]=(e[8]-e[2])*i):(n=Math.sqrt(1+e[10]-e[0]-e[5]),t[0]=(e[8]+e[2])*(i=.5/n),t[1]=(e[9]+e[6])*i,t[2]=.5*n,t[3]=(e[1]-e[4])*i)},Ji.slerp=function(e,t,n,i){var r,a,e=e.elements,t=t.elements,i=i.elements,o=e[0],s=e[1],l=e[2],e=e[3],h=t[0],_=t[1],u=t[2],t=t[3],d=o*h+s*_+l*u+e*t;return d<0&&(d=-d,h=-h,_=-_,u=-u,t=-t),d=1e-6<1-d?(d=Math.acos(d),r=Math.sin(d),a=Math.sin((1-n)*d)/r,Math.sin(n*d)/r):(a=1-n,n),i[0]=a*o+d*h,i[1]=a*s+d*_,i[2]=a*l+d*u,i[3]=a*e+d*t,i},Ji.lerp=function(e,t,n,i){var i=i.elements,e=e.elements,t=t.elements,r=e[0],a=e[1],o=e[2],e=e[3];i[0]=r+n*(t[0]-r),i[1]=a+n*(t[1]-a),i[2]=o+n*(t[2]-o),i[3]=e+n*(t[3]-e)},Ji.add=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3]},Ji.dot=function(e,t){e=e.elements,t=t.elements;return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},Ji.rotationLookAt=function(e,t,n){Ji.lookAt(W.ZERO,e,t,n)},Ji.lookAt=function(e,t,n,i){Yi.lookAt(e,t,n,Ji._tempMatrix3x3),Ji.rotationMatrix(Ji._tempMatrix3x3,i)},Ji.invert=function(e,t){var n=e.elements,t=t.elements,e=e.lengthSquared();M.isZero(e)||(t[0]=-n[0]*(e=1/e),t[1]=-n[1]*e,t[2]=-n[2]*e,t[3]=n[3]*e)},Ji.rotationMatrix=function(e,t){var e=e.elements,n=e[0],i=e[1],r=e[2],a=e[3],o=e[4],s=e[5],l=e[6],h=e[7],e=e[8],t=t.elements,_=NaN,u=NaN,d=n+o+e;0<d?(_=Math.sqrt(d+1),t[3]=.5*_,t[0]=(s-h)*(_=.5/_),t[1]=(l-r)*_,t[2]=(i-a)*_):o<=n&&e<=n?(u=.5/(_=Math.sqrt(1+n-o-e)),t[0]=.5*_,t[1]=(i+a)*u,t[2]=(r+l)*u,t[3]=(s-h)*u):e<o?(_=Math.sqrt(1+o-n-e),t[0]=(a+i)*(u=.5/_),t[1]=.5*_,t[2]=(h+s)*u,t[3]=(l-r)*u):(_=Math.sqrt(1+e-n-o),t[0]=(l+r)*(u=.5/_),t[1]=(h+s)*u,t[2]=.5*_,t[3]=(i-a)*u)},Ji.DEFAULT=new Ji,e(Ji,["TEMPVector30",function(){return this.TEMPVector30=new W},"TEMPVector31",function(){return this.TEMPVector31=new W},"TEMPVector32",function(){return this.TEMPVector32=new W},"TEMPVector33",function(){return this.TEMPVector33=new W},"TEMPMatrix0",function(){return this.TEMPMatrix0=new R},"TEMPMatrix1",function(){return this.TEMPMatrix1=new R},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new Yi},"NAN",function(){return this.NAN=new Ji(NaN,NaN,NaN,NaN)}]);var $i=Ji;function Ji(e,t,n,i){this.elements=new Float32Array(4),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this.elements[0]=e=void 0===e?0:e,this.elements[1]=t,this.elements[2]=n,this.elements[3]=i}t(tr,"laya.d3.math.Rand"),(u=tr.prototype).getUint=function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^(this._temp[0]^this._temp[0]>>>8),this.seeds[3]},u.getFloat=function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)},u.getSignedFloat=function(){return 2*this.getFloat()-1},n(0,u,"seed",function(){return this.seeds[0]},function(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}),tr.getFloatFromInt=function(e){return 1/8388607*(8388607&e)},tr.getByteFromInt=function(e){return(8388607&e)>>>15};var er=tr;function tr(e){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}t(nr,"laya.d3.math.RandX"),(u=nr.prototype).randomint=function(){var e=this._state0U,t=this._state0L,n=this._state1U,i=this._state1L,r=(i>>>0)+(t>>>0),a=n+e+(r/2>>>31)>>>0,r=r>>>0,o=0,s=0;o=(e^=o=e<<23|(-512&t)>>>9)^(this._state0U=n),s=(t^=s=t<<23)^(this._state0L=i),o^=e>>>18;return s=s^(t>>>18|(262143&e)<<14)^(i>>>5|(31&n)<<27),this._state1U=o^=n>>>5,this._state1L=s,[a,r]},u.random=function(){var e=this.randomint(),t=e[0],e=0|(e[1]>>>12|(4095&t)<<20);return nr._CONVERTION_BUFFER.setUint32(0,1023<<20|t>>>12,!1),nr._CONVERTION_BUFFER.setUint32(4,e,!1),er._CONVERTION_BUFFER.getFloat64(0,!1)-1},e(nr,["_CONVERTION_BUFFER",function(){return this._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8))},"defaultRand",function(){return this.defaultRand=new er([0,Date.now()/65536,0,Date.now()%65536])}]);function nr(e){if(this._state0U=NaN,this._state0L=NaN,this._state1U=NaN,this._state1L=NaN,!(e instanceof Array)||4!==e.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|e[0],this._state0L=0|e[1],this._state1U=0|e[2],this._state1L=0|e[3]}t(rr,"laya.d3.math.Ray");var ir=rr;function rr(e,t){this.origin=null,this.direction=null,this.origin=e,this.direction=t}t(or,"laya.d3.math.Vector2"),u=or.prototype,v.imps(u,{"laya.d3.core.IClone":!0}),u.fromArray=function(e,t){this.elements[0]=e[(t=void 0===t?0:t)+0],this.elements[1]=e[t+1]},u.cloneTo=function(e){var e=e.elements,t=this.elements;e[0]=t[0],e[1]=t[1]},u.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,u,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),n(0,u,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),or.scale=function(e,t,n){n=n.elements,e=e.elements;n[0]=e[0]*t,n[1]=e[1]*t},e(or,["ZERO",function(){return this.ZERO=new or(0,0)},"ONE",function(){return this.ONE=new or(1,1)}]);var ar=or;function or(e,t){this.elements=new Float32Array(2),void 0===t&&(t=0);var n=this.elements;n[0]=e=void 0===e?0:e,n[1]=t}t(sr,"laya.d3.math.Vector3"),u=sr.prototype,v.imps(u,{"laya.d3.core.IClone":!0}),u.fromArray=function(e,t){this.elements[0]=e[(t=void 0===t?0:t)+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2]},u.cloneTo=function(e){var e=e.elements,t=this.elements;e[0]=t[0],e[1]=t[1],e[2]=t[2]},u.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},u.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},n(0,u,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),n(0,u,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),n(0,u,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),sr.distanceSquared=function(e,t){var e=e.elements,t=t.elements,n=e[0]-t[0],i=e[1]-t[1],e=e[2]-t[2];return n*n+i*i+e*e},sr.distance=function(e,t){var e=e.elements,t=t.elements,n=e[0]-t[0],i=e[1]-t[1],e=e[2]-t[2];return Math.sqrt(n*n+i*i+e*e)},sr.min=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2])},sr.max=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2])},sr.transformQuat=function(e,t,n){var n=n.elements,e=e.elements,t=t.elements,i=e[0],r=e[1],e=e[2],a=t[0],o=t[1],s=t[2],t=t[3],l=t*i+o*e-s*r,h=t*r+s*i-a*e,_=t*e+a*r-o*i,i=-a*i-o*r-s*e;n[0]=l*t+i*-a+h*-s-_*-o,n[1]=h*t+i*-o+_*-a-l*-s,n[2]=_*t+i*-s+l*-o-h*-a},sr.scalarLength=function(e){var e=e.elements,t=e[0],n=e[1],e=e[2];return Math.sqrt(t*t+n*n+e*e)},sr.scalarLengthSquared=function(e){var e=e.elements,t=e[0],n=e[1],e=e[2];return t*t+n*n+e*e},sr.normalize=function(e,t){var e=e.elements,t=t.elements,n=e[0],i=e[1],r=e[2],n=n*n+i*i+r*r;0<n&&(n=1/Math.sqrt(n),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n)},sr.multiply=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2]},sr.scale=function(e,t,n){n=n.elements,e=e.elements;n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t},sr.lerp=function(e,t,n,i){var i=i.elements,e=e.elements,t=t.elements,r=e[0],a=e[1],e=e[2];i[0]=r+n*(t[0]-r),i[1]=a+n*(t[1]-a),i[2]=e+n*(t[2]-e)},sr.transformV3ToV3=function(e,t,n){var i=sr._tempVector4,e=(sr.transformV3ToV4(e,t,i),i.elements),t=n.elements;t[0]=e[0],t[1]=e[1],t[2]=e[2]},sr.transformV3ToV4=function(e,t,n){var e=e.elements,i=e[0],r=e[1],e=e[2],t=t.elements,n=n.elements;n[0]=i*t[0]+r*t[4]+e*t[8]+t[12],n[1]=i*t[1]+r*t[5]+e*t[9]+t[13],n[2]=i*t[2]+r*t[6]+e*t[10]+t[14],n[3]=i*t[3]+r*t[7]+e*t[11]+t[15]},sr.TransformNormal=function(e,t,n){var e=e.elements,i=e[0],r=e[1],e=e[2],t=t.elements,n=n.elements;n[0]=i*t[0]+r*t[4]+e*t[8],n[1]=i*t[1]+r*t[5]+e*t[9],n[2]=i*t[2]+r*t[6]+e*t[10]},sr.transformCoordinate=function(e,t,n){var i=sr._tempVector4.elements,e=e.elements,r=e[0],a=e[1],e=e[2],t=t.elements,r=(i[0]=r*t[0]+a*t[4]+e*t[8]+t[12],i[1]=r*t[1]+a*t[5]+e*t[9]+t[13],i[2]=r*t[2]+a*t[6]+e*t[10]+t[14],i[3]=1/(r*t[3]+a*t[7]+e*t[11]+t[15]),n.elements);r[0]=i[0]*i[3],r[1]=i[1]*i[3],r[2]=i[2]*i[3]},sr.Clamp=function(e,t,n,i){var e=e.elements,r=e[0],a=e[1],e=e[2],t=t.elements,o=t[0],s=t[1],t=t[2],n=n.elements,l=n[0],h=n[1],n=n[2],i=i.elements,a=(a=h<a?h:a)<s?s:a,e=(e=n<e?n:e)<t?t:e;i[0]=(r=l<r?l:r)<o?o:r,i[1]=a,i[2]=e},sr.add=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2]},sr.subtract=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2]},sr.cross=function(e,t,n){var e=e.elements,t=t.elements,n=n.elements,i=e[0],r=e[1],e=e[2],a=t[0],o=t[1],t=t[2];n[0]=r*t-e*o,n[1]=e*a-i*t,n[2]=i*o-r*a},sr.dot=function(e,t){e=e.elements,t=t.elements;return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},sr.equals=function(e,t){e=e.elements,t=t.elements;return M.nearEqual(Math.abs(e[0]),Math.abs(t[0]))&&M.nearEqual(Math.abs(e[1]),Math.abs(t[1]))&&M.nearEqual(Math.abs(e[2]),Math.abs(t[2]))},sr.ZERO=new sr(0,0,0),sr.ONE=new sr(1,1,1),sr.NegativeUnitX=new sr(-1,0,0),sr.UnitX=new sr(1,0,0),sr.UnitY=new sr(0,1,0),sr.UnitZ=new sr(0,0,1),sr.ForwardRH=new sr(0,0,-1),sr.ForwardLH=new sr(0,0,1),sr.Up=new sr(0,1,0),sr.NAN=new sr(NaN,NaN,NaN),e(sr,["_tempVector4",function(){return this._tempVector4=new P}]);var W=sr;function sr(e,t,n){this.elements=new Float32Array(3),void 0===t&&(t=0),void 0===n&&(n=0);var i=this.elements;i[0]=e=void 0===e?0:e,i[1]=t,i[2]=n}t(lr,"laya.d3.math.Vector4"),u=lr.prototype,v.imps(u,{"laya.d3.core.IClone":!0}),u.fromArray=function(e,t){this.elements[0]=e[(t=void 0===t?0:t)+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]},u.cloneTo=function(e){var e=e.elements,t=this.elements;e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]},u.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},u.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},u.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},n(0,u,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),n(0,u,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),n(0,u,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),n(0,u,"w",function(){return this.elements[3]},function(e){this.elements[3]=e}),lr.lerp=function(e,t,n,i){var i=i.elements,e=e.elements,t=t.elements,r=e[0],a=e[1],o=e[2],e=e[3];i[0]=r+n*(t[0]-r),i[1]=a+n*(t[1]-a),i[2]=o+n*(t[2]-o),i[3]=e+n*(t[3]-e)},lr.transformByM4x4=function(e,t,n){var e=e.elements,i=e[0],r=e[1],a=e[2],e=e[3],t=t.elements,n=n.elements;n[0]=i*t[0]+r*t[4]+a*t[8]+e*t[12],n[1]=i*t[1]+r*t[5]+a*t[9]+e*t[13],n[2]=i*t[2]+r*t[6]+a*t[10]+e*t[14],n[3]=i*t[3]+r*t[7]+a*t[11]+e*t[15]},lr.equals=function(e,t){e=e.elements,t=t.elements;return M.nearEqual(Math.abs(e[0]),Math.abs(t[0]))&&M.nearEqual(Math.abs(e[1]),Math.abs(t[1]))&&M.nearEqual(Math.abs(e[2]),Math.abs(t[2]))&&M.nearEqual(Math.abs(e[3]),Math.abs(t[3]))},lr.normalize=function(e,t){var n=e.elements,t=t.elements,e=e.length();0<e&&(t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t[3]=n[3]*e)},lr.add=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3]},lr.subtract=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3]},lr.multiply=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n[3]=e[3]*t[3]},lr.scale=function(e,t,n){n=n.elements,e=e.elements;n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t},lr.Clamp=function(e,t,n,i){var e=e.elements,r=e[0],a=e[1],o=e[2],e=e[3],t=t.elements,s=t[0],l=t[1],h=t[2],t=t[3],n=n.elements,_=n[0],u=n[1],d=n[2],n=n[3],i=i.elements,a=(a=u<a?u:a)<l?l:a,o=(o=d<o?d:o)<h?h:o,e=(e=n<e?n:e)<t?t:e;i[0]=(r=_<r?_:r)<s?s:r,i[1]=a,i[2]=o,i[3]=e},lr.distanceSquared=function(e,t){var e=e.elements,t=t.elements,n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2],e=e[3]-t[3];return n*n+i*i+r*r+e*e},lr.distance=function(e,t){var e=e.elements,t=t.elements,n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2],e=e[3]-t[3];return Math.sqrt(n*n+i*i+r*r+e*e)},lr.dot=function(e,t){e=e.elements,t=t.elements;return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},lr.min=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n[3]=Math.min(e[3],t[3])},lr.max=function(e,t,n){n=n.elements,e=e.elements,t=t.elements;n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n[3]=Math.max(e[3],t[3])},e(lr,["ZERO",function(){return this.ZERO=new lr},"ONE",function(){return this.ONE=new lr(1,1,1,1)},"UnitX",function(){return this.UnitX=new lr(1,0,0,0)},"UnitY",function(){return this.UnitY=new lr(0,1,0,0)},"UnitZ",function(){return this.UnitZ=new lr(0,0,1,0)},"UnitW",function(){return this.UnitW=new lr(0,0,0,1)}]);var P=lr;function lr(e,t,n,i){this.elements=new Float32Array(4),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0);var r=this.elements;r[0]=e=void 0===e?0:e,r[1]=t,r[2]=n,r[3]=i}t(_r,"laya.d3.math.Viewport"),(u=_r.prototype).project=function(e,t,n){W.transformV3ToV3(e,t,n);e=e.elements,t=t.elements,n=n.elements,e=e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+t[15];1!==e&&(n[0]=n[0]/e,n[1]=n[1]/e,n[2]=n[2]/e),n[0]=.5*(n[0]+1)*this.width+this.x,n[1]=.5*(1-n[1])*this.height+this.y,n[2]=n[2]*(this.maxDepth-this.minDepth)+this.minDepth},u.unprojectFromMat=function(e,t,n){var e=e.elements,i=t.elements,r=n.elements,a=(r[0]=(e[0]-this.x)/this.width*2-1,r[1]=-((e[1]-this.y)/this.height*2-1),(this.maxDepth-this.minDepth)/2),e=(r[2]=(e[2]-this.minDepth-a)/a,r[0]*i[3]+r[1]*i[7]+r[2]*i[11]+i[15]);W.transformV3ToV3(n,t,n),1!==e&&(r[0]=r[0]/e,r[1]=r[1]/e,r[2]=r[2]/e)},u.unprojectFromWVP=function(e,t,n,i,r){R.multiply(t,n,_r._tempMatrix4x4),i&&R.multiply(_r._tempMatrix4x4,i,_r._tempMatrix4x4),_r._tempMatrix4x4.invert(_r._tempMatrix4x4),this.unprojectFromMat(e,_r._tempMatrix4x4,r)},e(_r,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new R}]);var hr=_r;function _r(e,t,n,i){this.minDepth=0,this.maxDepth=1,this.x=e,this.y=t,this.width=n,this.height=i}t(ur,"laya.d3.resource.models.Sky"),(u=ur.prototype)._setEnvironmentDiffuse=function(){this._environmentDiffuse.loaded?this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse):this._environmentDiffuse.on("loaded",this,this._environmentDiffuseLoaded)},u._setEnvironmentSpecular=function(){var e;this._environmentSpecular.loaded?((e=this._environmentSpecular.simLodInfo)&&e instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,e),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular)):this._environmentSpecular.on("loaded",this,this._environmentSpecularLoaded)},u._environmentDiffuseLoaded=function(){this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse)},u._environmentSpecularLoaded=function(){var e=this._environmentSpecular.simLodInfo;e&&e instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,e),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular)},u._render=function(e){},u.destroy=function(){this.__ownerCamera=null},n(0,u,"_ownerCamera",null,function(e){this.__ownerCamera=e,this._environmentDiffuse&&this._setEnvironmentDiffuse(),this._environmentSpecular&&this._setEnvironmentSpecular()}),n(0,u,"alphaBlending",function(){return this._alphaBlending},function(e){this._alphaBlending=e,this._alphaBlending<0&&(this._alphaBlending=0),1<this._alphaBlending&&(this._alphaBlending=1)}),n(0,u,"envDiffuseSHBlue",null,function(e){this.__ownerCamera._shaderValues.setValue(12,e)}),n(0,u,"colorIntensity",function(){return this._colorIntensity},function(e){this._colorIntensity=e,this._colorIntensity<0&&(this._colorIntensity=0)}),n(0,u,"envDiffuseSHGreen",null,function(e){this.__ownerCamera._shaderValues.setValue(11,e)}),n(0,u,"envDiffuseSHRed",null,function(e){this.__ownerCamera._shaderValues.setValue(10,e)}),n(0,u,"environmentDiffuse",function(){return this._environmentDiffuse},function(e){e.minFifter=9728,this._environmentDiffuse=e,this.__ownerCamera&&this._setEnvironmentDiffuse()}),n(0,u,"environmentSpecular",function(){return this._environmentSpecular},function(e){this._environmentSpecular=e,this.__ownerCamera&&this._setEnvironmentSpecular()}),ur.MVPMATRIX=0,ur.INTENSITY=1,ur.ALPHABLENDING=2,ur.DIFFUSETEXTURE=3;var u=ur;function ur(){this._alphaBlending=1,this._colorIntensity=1,this._shaderValue=new gr}t(cr,"laya.d3.resource.models.SubMesh"),d=cr.prototype,v.imps(d,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),d._getVertexBuffer=function(e){return 0===(e=void 0===e?0:e)?this._vertexBuffer:null},d._getIndexBuffer=function(){return this._indexBuffer},d._getStaticBatchBakedVertexs=function(e,t){var n,i,r=this._vertexBuffer,a=r.vertexDeclaration,o=a.getVertexElementByUsage(0).offset/4,s=a.getVertexElementByUsage(3).offset/4,l=t.meshRender.lightmapScaleOffset,h=0,_=0,u=0,d=0,c=0,f=0;if(l)if(n=a.getVertexElementByUsage(15))u=a.vertexStride/4,m=0<this._vertexCount?r.getData().slice(this._vertexStart*u,(this._vertexStart+this._vertexCount)*u):r.getData().slice(),d=n.offset/4;else for(var u=(f=a.vertexStride/4)+2,m=this._vertexCount?new Float32Array(this._vertexCount*(r.vertexDeclaration.vertexStride/4+2)):new Float32Array(r.vertexCount*(r.vertexDeclaration.vertexStride/4+2)),d=(c=a.getVertexElementByUsage(2).offset/4)+2,p=r.getData(),h=0,_=p.length/f;h<_;h++){for(var E=0,E=0<this._vertexCount?(this._vertexStart+h)*f:h*f,g=h*u,v=0,v=0;v<d;v++)m[g+v]=p[E+v];for(v=d;v<f;v++)m[g+v+2]=p[E+v]}else u=a.vertexStride/4,m=this._vertexCount?r.getData().slice(this._vertexStart*u,(this._vertexStart+this._vertexCount)*u):r.getData().slice();e?(e.worldMatrix.invert(a=cr._tempMatrix4x40),r=t.transform.worldMatrix,R.multiply(a,r,i=cr._tempMatrix4x41)):i=t.transform.worldMatrix;var T=cr._tempQuaternion0;for(i.decomposeTransRotScale(cr._tempVector30,T,cr._tempVector31),h=0,_=m.length/u;h<_;h++){var S=h*u+o,D=h*u+s;br.transformVector3ArrayToVector3ArrayCoordinate(m,S,i,m,S),br.transformVector3ArrayByQuat(m,D,T,m,D),l&&(S=h*u+d,n?br.transformLightingMapTexcoordByUV1Array(m,S,l,m,S):br.transformLightingMapTexcoordByUV0Array(p,h*f+c,l,m,S))}return m},d._getVertexBuffers=function(){return null},d._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},d._render=function(e){var t,n=0,i=e.renderElement;if(1<this._indexCount){var r=this._boneIndicesList.length;if(1<r){for(var a=0;a<r;a++)(t=i._skinAnimationDatas||this._skinAnimationDatas)&&(i._shaderValue.setValue(0,t[a]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),c.mainContext.drawElements(4,this._subIndexBufferCount[a],5123,2*this._subIndexBufferStart[a]);T.drawCall+=r}else(t=i._skinAnimationDatas||this._skinAnimationDatas)&&(i._shaderValue.setValue(0,t[0]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),c.mainContext.drawElements(4,this._indexCount,5123,2*this._indexStart),T.drawCall++;n=this._indexCount}else n=this._indexBuffer.indexCount,(t=i._skinAnimationDatas||this._skinAnimationDatas)&&(i._shaderValue.setValue(0,t[0]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),c.mainContext.drawElements(4,n,5123,0),T.drawCall++;T.trianglesFaces+=n/3},d.getIndices=function(){return 0<this._indexCount?this._indices:this._indexBuffer.getData()},d.dispose=function(){this._indexBuffer.destroy(),this._vertexBuffer.destroy(),this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._vertexBuffer=null,this._indexBuffer=null},n(0,d,"_vertexBufferCount",function(){return 1}),n(0,d,"triangleCount",function(){return this._indexBuffer.indexCount/3}),e(cr,["_tempVector30",function(){return this._tempVector30=new W},"_tempVector31",function(){return this._tempVector31=new W},"_tempQuaternion0",function(){return this._tempQuaternion0=new $i},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new R},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new R}]);var dr=cr;function cr(e){this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._indexInMesh=0,this._vertexBuffer=null,this._vertexStart=0,this._vertexCount=0,this._indexBuffer=null,this._indexStart=0,this._indexCount=0,this._indices=null,this._bufferUsage={},this._mesh=e,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[]}t(mr,"laya.d3.shader.ShaderDefines",null,"ShaderDefines$1"),mr.prototype.registerDefine=function(e){var t=Math.pow(2,this.defineCounter++);return this.defines[t]=e,t};var fr=mr;function mr(e){this.defineCounter=0,this.defines=null,e?(this.defineCounter=e.defineCounter,this.defines=e.defines.slice()):(this.defineCounter=0,this.defines=[])}t(Er,"laya.d3.shader.ShaderInit3D"),Er.__init__=function(){g._globalRegDefine("HIGHPRECISION",g.SHADERDEFINE_HIGHPRECISION),g._globalRegDefine("FOG",g.SHADERDEFINE_FOG),g._globalRegDefine("DIRECTIONLIGHT",g.SHADERDEFINE_DIRECTIONLIGHT),g._globalRegDefine("POINTLIGHT",g.SHADERDEFINE_POINTLIGHT),g._globalRegDefine("SPOTLIGHT",g.SHADERDEFINE_SPOTLIGHT),g._globalRegDefine("UV",g.SHADERDEFINE_UV0),g._globalRegDefine("COLOR",g.SHADERDEFINE_COLOR),g._globalRegDefine("UV1",g.SHADERDEFINE_UV1),g._globalRegDefine("CASTSHADOW",Tr.SHADERDEFINE_CAST_SHADOW),g._globalRegDefine("SHADOWMAP_PSSM1",Tr.SHADERDEFINE_SHADOW_PSSM1),g._globalRegDefine("SHADOWMAP_PSSM2",Tr.SHADERDEFINE_SHADOW_PSSM2),g._globalRegDefine("SHADOWMAP_PSSM3",Tr.SHADERDEFINE_SHADOW_PSSM3),g._globalRegDefine("SHADOWMAP_PCF_NO",Tr.SHADERDEFINE_SHADOW_PCF_NO),g._globalRegDefine("SHADOWMAP_PCF1",Tr.SHADERDEFINE_SHADOW_PCF1),g._globalRegDefine("SHADOWMAP_PCF2",Tr.SHADERDEFINE_SHADOW_PCF2),g._globalRegDefine("SHADOWMAP_PCF3",Tr.SHADERDEFINE_SHADOW_PCF3),g._globalRegDefine("DEPTHFOG",g.SAHDERDEFINE_DEPTHFOG),Ko.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n\tvec3 normalT = 2.0*normalMapSample - 1.0;\n\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent- dot(tangent, N)*N);\n\tvec3 B = cross(T, N);\n\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 ambinentColor,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec=-normalize(dirLight.Direction);\n\t\n\tamb=matAmb*ambinentColor;\n\t\n\tfloat  diffuseFactor=dot(lightVec, normal);\n\t\n\tif(diffuseFactor>0.0)\n\t{\n\t   vec3 v = reflect(-lightVec, normal);\n\t   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t   \n\t   dif = diffuseFactor * matDif * dirLight.Diffuse;\n\t   spec = specFactor * matSpe.rgb;\n\t}\n\t\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight,in vec3 ambinentColor, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec = poiLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > poiLight.Range )\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb*ambinentColor;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif( diffuseFactor > 0.0 )\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * poiLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb;\n\t}\n\n\tfloat attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 ambinentColor,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tamb = vec3(0.0);\n\tdif =vec3(0.0);\n\tspec= vec3(0.0);\n\tvec3 lightVec = spoLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > spoLight.Range)\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb*ambinentColor;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif(diffuseFactor > 0.0)\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * spoLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb;\n\t}\n\t\n\tfloat spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n\tfloat attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n\tamb *= spot;\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\n"),Ko.addInclude("Lighting.glsl","\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nstruct PointLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tfloat Range;\n};\n\nstruct SpotLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tvec3 Direction;\n\tfloat Spot;\n\tfloat Range;\n};\n\n// U3D中使用衰减纹理,此函数模拟并非正确\n//float U3DAttenuation(in vec3 L,in float invLightRadius)\n//{\n//\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\n//\tfRatio *= fRatio;\n//\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\n//} \n\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\nfloat BasicAttenuation(in vec3 L,in float invLightRadius)\n{\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius)); \t\n\treturn attenuation * attenuation;\n} \n\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\t\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius)\n{\n\tfloat attenuationFactor = 30.0;\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\n\tattenuation /= 1.0 - attenuationFactor;\n\treturn attenuation;\n} \n\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor)\n{\n    mediump vec3 h = normalize(viewDir-lightVec);\n    lowp float ln = max (0.0, dot (-lightVec,normal));\n    float nh = max (0.0, dot (h,normal));\n\tdiffuseColor=lightColor * ln;\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\n}\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec=normalize(light.Direction);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec,diffuseColor,specularColor);\n}\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range )\n\t//\treturn;\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec/length(lightVec),diffuseColor,specularColor);\n\tfloat attenuate = BasicAttenuation(lightVec, 1.0/light.Range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range )\n\t//\treturn;\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,normalLightVec,diffuseColor,specularColor);\n\tfloat spot = pow(max(dot(normalLightVec, normalize(light.Direction)), 0.0), light.Spot);\n\tfloat attenuate = spot*BasicAttenuation(lightVec, 1.0/light.Range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal)\n{\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\n\t\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent);\n\tvec3 B = normalize(binormal);\n\tmat3 TBN = mat3(T, B, N);\n\t\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n\n\n"),Ko.addInclude("ShadowHelper.glsl","uniform sampler2D u_shadowMap1;\nuniform sampler2D u_shadowMap2;\nuniform sampler2D u_shadowMap3;\nuniform vec2\t  u_shadowPCFoffset;\nuniform vec3     u_shadowPSSMDistance;\nvec4 packDepth(const in float depth)\n{\n\tconst vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n\tconst vec4 bitMask\t= vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n\tvec4 res = mod(depth*bitShift*vec4(255), vec4(256))/vec4(255);\n\tres -= res.xxyz * bitMask;\n\treturn res;\n}\nfloat unpackDepth(const in vec4 rgbaDepth)\n{\n\tconst vec4 bitShift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\nfloat tex2DPCF( sampler2D shadowMap,vec2 texcoord,vec2 invsize,float zRef )\n{\n\tvec2 texelpos =texcoord / invsize;\n\tvec2 lerps = fract( texelpos );\n\tfloat sourcevals[4];\n\tsourcevals[0] = float( unpackDepth(texture2D(shadowMap,texcoord)) > zRef );\n\tsourcevals[1] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x,0))) > zRef );\n\tsourcevals[2] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(0,invsize.y))) > zRef );\n\tsourcevals[3] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x, invsize.y) )) > zRef );\n\treturn mix( mix(sourcevals[0],sourcevals[2],lerps.y),mix(sourcevals[1],sourcevals[3],lerps.y),lerps.x );\n}\nfloat getShadowPSSM3( sampler2D shadowMap1,sampler2D shadowMap2,sampler2D shadowMap3,mat4 lightShadowVP[4],vec3 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\tnPSNum += int(posViewZ>pssmDistance.z);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\telse if( nPSNum == 2 )\n\t{\n\t\tlightVP = lightShadowVP[3];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t} \n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap3,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM2( sampler2D shadowMap1,sampler2D shadowMap2,mat4 lightShadowVP[4],vec3 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM1( sampler2D shadowMap1,vec4 lightMVPPos,vec3 pssmDistance,vec2 shadowPCFOffset,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tif( posViewZ < pssmDistance.x )\n\t{\n\t\tvec3 vText = lightMVPPos.xyz / lightMVPPos.w;\n\t\tfloat fMyZ = vText.z - zBias;\n\t\t/*\n\t\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\t\tbool bInFrustum = all( bInFrustumVec );\n\t\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\t\tbool bFrustumTest = all( bFrustumTestVec );\n\t\t*/\n\t\tif ( fMyZ <= 1.0 ) \n\t\t{\n\t\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,fMyZ );\n\t\t\tvalue = value/4.0;\n#endif\n#ifdef SHADOWMAP_PCF2\t\t\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF_NO\t\t\n\t\t\tvec4 color = texture2D( shadowMap1,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t\t}\n\t}\n\treturn value;\n}"),Ko.addInclude("WaveFunction.glsl","\nuniform vec2 u_WaveInfoD[20];\nuniform vec4 u_WaveInfo[20];\n\nuniform float TEXWAVE_UV_SCALE ;//= 20.0; //每texwidth像素代表的实际距离\n/**\n\t这里的计算都是\n*/\n\n/**\n* 计算一个波形\n*  开始计算的时候都按照z向上，最后输出的时候，颠倒一下。\n* @param tm {float} 毫秒\n*/\nvoid calcGerstnerWave(float curtm, vec3 pos, float deep, vec2 uvpos, out vec3 opos, out vec3 B, out vec3 T, out vec3 N, out float foamS){\n\tfloat tm = curtm/1000.;\n\topos = pos;\n\tvec3 wpos=vec3(0.);\t\t//累加的位置\n\tN=vec3(0.,0.,0.);\t//输出的法线初始化一下\n\tT=vec3(0.,0.,0.);\n\tB=vec3(0.,0.,0.);\n\tvec2 cD ;//= D;\n\t//float deepAtt = max(0.,min(deep,1.0));\n\t//A*=deepAtt; //TODO\n\t\n\tfor( int i=0; i<4; i++){\n\t\tcD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n\t\tfloat Q = u_WaveInfo[i].x;//wi.QorK;\n\t\tfloat A = u_WaveInfo[i].y;//wi.A;\n\t\tfloat W = u_WaveInfo[i].z;//wi.omega;\n\t\tfloat P = u_WaveInfo[i].w;//wi.phi;\n\t\tfloat dop = dot(cD,uvpos);\n\t\tfloat c = cos(dop*W - tm*P);//TODO 优化\n\t\tfloat s = sin(dop*W - tm*P);\n\t\tfloat AWs = A*W*s;\n\t\tfloat AWc = A*W*c;\n\t\tfloat _QxyAWs = -Q*cD.x*cD.y*AWs;\n\t\t\n\t\twpos += vec3(Q*A*cD.x*c,\n\t\t\t\t\tQ*A*cD.y*c,\n\t\t\t\t\tA*s);\n\t\tN += vec3(-cD.x*AWc,\n\t\t\t\t-cD.y*AWc,\n\t\t\t\tQ*AWs);//记得最后1-\n\t\tT += vec3(_QxyAWs,\n\t\t\t\tQ*cD.y*cD.y*AWs,//记得1-\n\t\t\t\tcD.y*AWc\n\t\t\t);\n\t\tB += vec3(Q*cD.x*cD.x*AWs,//记得1-\n\t\t\t\t_QxyAWs,\n\t\t\t\tcD.x*AWc\n\t\t\t);\n\t\t//float v1 = exp(-tan((dop*W - tm*P)/2.+1.07));//除2，+pi/2 这样正好能对齐\n#ifdef USE_FOAM\t\t\n\t\tfloat v1 = 0.5-sin((dop*W - tm*P)/1.+2.0)/2.;\n\t\tfoamS += pow(v1,9.)/4.;\n#endif\n\t}\n\tT.y=1.-T.y; B.x=1.-B.x;N.z=1.-N.z;\n\topos += vec3(wpos.x,wpos.z*min(deep/10.,1.),wpos.y);\n\t//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n\tT.xyz=T.xzy;\n\tB.xyz=B.xzy;\n\tN.xyz=N.xzy;\n}\n\n\nvoid calcWave(float curtm, vec2 uv, out vec3 B, out vec3 T, out vec3 N){\n\tfloat tm = curtm/1000.;\n\tN=vec3(0.,0.,0.);\t//输出的法线初始化一下\n\tvec2 uvpos = uv*TEXWAVE_UV_SCALE; //TODO 这个范围是什么 就是1？\n\tuvpos.y*=-1.;\n\tvec2 cD;// = D;\n\tconst int NumWaves = 4;\n\tfloat scale = 1./float(NumWaves);\n\tfor( int i=0; i<NumWaves; i++){\n\t\tcD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n\t\tfloat k = 1.5;//u_WaveInfo[i].x;//wi.QorK; TODO  不知道为什么，这个取u_WaveInfo[i].x，在mi3w上就会闪。测试发现实际值也传过来了，就是1.5\n\t\tfloat A = u_WaveInfo[i].y;//wi.A;\n\t\tfloat W = u_WaveInfo[i].z;//wi.omega;\n\t\tfloat P = u_WaveInfo[i].w;//wi.phi;\n\t\t\n\t\tfloat dop = dot(cD,uvpos);\n\t\tfloat c = cos(dop*W - tm*P);//TODO 优化\n\t\tfloat s = sin(dop*W - tm*P);\n\t\t/*\n\t\tfloat AWs = A*W*s;\n\t\tfloat AWc = A*W*c;\n\t\tfloat _QxyAWs = -Q*cD.x*cD.y*AWs;\n\t\t\n\t\tN += vec3(-cD.x*AWc,\n\t\t\t\t-cD.y*AWc,\n\t\t\t\tQ*AWs);//记得最后1-\n\t\t*/\n\t\tfloat kWAc = scale*c;//k*W*A*c;  为了提高精度，这里只保留sin，cos部分，实际使用的时候再乘回来。\n\t\t//float kWAc = k*W*A*c;  \n\t\tN += vec3(\n\t\t\t-kWAc*cD.x*pow((s+1.)/2.,k-1.),\n\t\t\t-kWAc*cD.y*pow((s+1.)/2.,k-1.),\n\t\t\t1.\n\t\t);\n\t}\n\t//N.z=1.-N.z;\n\t//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n\tN.xyz=N.xzy;\n}\n"),Ko.addInclude("BRDF.glsl","vec4 LayaAirBRDF(in vec3 diffuseColor, in vec3 specularColor, in float oneMinusReflectivity, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat perceptualRoughness = SmoothnessToPerceptualRoughness(smoothness);\n\tvec3 halfDir = SafeNormalize(viewDir - lightDir);\n\t\n\tfloat nv = abs(dot(normal, viewDir));\n\t\n\tfloat nl = clamp(dot(normal,   -lightDir),  0.0, 1.0);\n\tfloat nh = clamp(dot(normal,     halfDir),  0.0, 1.0);\n\tfloat lv = clamp(dot(lightDir,   viewDir),  0.0, 1.0);\n\tfloat lh = clamp(dot(lightDir,  -halfDir),  0.0, 1.0);\n\t\n\tfloat diffuseTerm = DisneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\n\t\n\tfloat roughness = PerceptualRoughnessToRoughness(perceptualRoughness);\n\t\n\t//#if UNITY_BRDF_GGX\n\tfloat V = SmithJointGGXVisibilityTerm(nl, nv, roughness);\n\tfloat D = GGXTerm(nh, roughness);\n\t\n\tfloat specularTerm = V * D * PI;\n\t\n\tspecularTerm = sqrt(max(0.0001, specularTerm));\n\tspecularTerm = max(0.0, specularTerm * nl);\n\t\n\tvec4 color;\n\tcolor.rgb = diffuseColor * (gi + lightColor * diffuseTerm) + specularTerm * lightColor * FresnelTerm (specularColor, lh);\n\t\n\tcolor.a = 1.0;\n\treturn color;\n}"),Ko.addInclude("PBRUtils.glsl","struct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nvec3 UnpackScaleNormal(in vec2 uv0)\n{\n\t#ifdef NORMALTEXTURE\n\t\tvec3 normalT;\n\t\tvec4 normalMapSample = texture2D(u_NormalTexture, uv0);\n\t\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\t\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\t\tnormalT.xy *= u_normalScale;\n\t\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\t\t\n\t\tvec3 T = normalize(v_Tangent);\n\t\tvec3 B = normalize(v_Binormal);\n\t\tvec3 N = normalize(v_Normal);\n\t\tmat3 TBN = mat3(T, B, N);\n\t\t\n\t\tvec3 bumpedNormal = TBN * normalize(normalT);\n\t\treturn bumpedNormal;\n\t#else\n\t\treturn normalize(v_Normal);\n\t#endif\n}\n\nvec4 DielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\n\nfloat PI = 3.14159265359;\n\nvec3 FresnelTerm (in vec3 F0, in float cosA)\n{\n\treturn F0 + (vec3(1.0) - F0) * pow(1.0 - cosA, 5.0);\n}\n\nfloat PerceptualRoughnessToRoughness(in float perceptualRoughness)\n{\n\treturn perceptualRoughness * perceptualRoughness;\n}\n\nfloat PerceptualRoughnessToSpecularPower(in float perceptualRoughness)\n{\n\tfloat m = PerceptualRoughnessToRoughness(perceptualRoughness);\n\tfloat sq = max(0.0001, m * m);\n\tfloat n = (2.0 / sq) - 2.0;\n\tn = max(n, 0.0001);\n\treturn n;\n}\n\nfloat RoughnessToPerceptualRoughness(in float roughness)\n{\n\treturn sqrt(roughness);\n}\n\nfloat SmoothnessToRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness) * (1.0 - smoothness);\n}\n\nfloat SmoothnessToPerceptualRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness);\n}\n\nvec3 SafeNormalize(in vec3 inVec)\n{\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\n\treturn inVec * (1.0 / sqrt(dp3));\n}\n\nfloat DisneyDiffuse(in float NdotV, in float NdotL, in float LdotH, in float perceptualRoughness)\n{\n\tfloat fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\n\tfloat lightScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotL,5.0));\n\tfloat viewScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotV,5.0));\n\n\treturn lightScatter * viewScatter;\n}\n\nfloat SmithJointGGXVisibilityTerm (float NdotL, float NdotV, float roughness)\n{\n\tfloat a = roughness;\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\n\n\treturn 0.5 / (lambdaV + lambdaL + 0.00001);\n}\n\nfloat GGXTerm (float NdotH, float roughness)\n{\n\tfloat a2 = roughness * roughness;\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0;\n\treturn 0.31830988618 * a2 / (d * d + 0.0000001);\n}\n\nfloat OneMinusReflectivityFromMetallic(in float metallic)\n{\n\tfloat oneMinusDielectricSpec = DielectricSpecularColor.a;\n\treturn oneMinusDielectricSpec - metallic * oneMinusDielectricSpec;\n}\n\nfloat SpecularStrength(vec3 specular)\n{\n    //(SHADER_TARGET < 30)return specular.r; \n    return max (max (specular.r, specular.g), specular.b);\n}\n\nvec3 DiffuseAndSpecularFromMetallic(in vec3 diffuseColor, in float metallic, out vec3 specularColor, out float oneMinusReflectivity)\n{\n\tspecularColor = mix(DielectricSpecularColor.rgb, diffuseColor, metallic);\n\toneMinusReflectivity = OneMinusReflectivityFromMetallic(metallic);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec3 EnergyConservationBetweenDiffuseAndSpecular(in vec3 diffuseColor, in vec3 specularColor, out float oneMinusReflectivity)\n{\n\toneMinusReflectivity = 1.0 - SpecularStrength(specularColor);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec4 Occlusion(in vec2 uv0){\n\t#ifdef OCCLUSIONTEXTURE\n\t\tvec4 occlusionTextureColor = texture2D(u_OcclusionTexture, uv0);\n\t\tfloat occ = occlusionTextureColor.g;\n\t\tfloat oneMinusT = 1.0 - u_occlusionStrength;\n\t\tfloat lerpOneTo = oneMinusT + occ * u_occlusionStrength;\n\t\treturn occlusionTextureColor * lerpOneTo;\n\t#else\n\t\treturn vec4(1.0);\n\t#endif\n}\n\nvec2 ParallaxOffset(in vec3 viewDir){\n\t#ifdef PARALLAXTEXTURE\n\t\tfloat h = texture2D(u_ParallaxTexture, v_Texcoord0).g;\n\t\th = h * u_parallaxScale - u_parallaxScale / 2.0;\n\t\tvec3 v = viewDir;\n\t\tv.z += 0.42;\n\t\tvec2 offset = h * (v.xy / v.z);\n\t\treturn v_Texcoord0 + offset;\n\t#else\n\t\treturn v_Texcoord0;\n\t#endif\n}\n\n"),Ko.addInclude("PBRStandardLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRStandardLight(in vec3 diffuseColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat oneMinusReflectivity;\n\tvec3 specularColor;\n\tdiffuseColor = DiffuseAndSpecularFromMetallic (diffuseColor, metallic, specularColor, oneMinusReflectivity);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\treturn color;\n}\n\nvec4 PBRStandardDiectionLight (in vec3 diffuseColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in vec3 gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn PBRStandardLight(diffuseColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec2 MetallicGloss(in float diffuseTextureAlpha, in vec2 uv0)\n{\n\tvec2 mg;\n\t\n\t#ifdef METALLICGLOSSTEXTURE\n\t\tvec4 metallicGlossTextureColor = texture2D(u_MetallicGlossTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tmg.r = metallicGlossTextureColor.r;\n\t\t\tmg.g = diffuseTextureAlpha;\n\t\t#else\n\t\t    mg = metallicGlossTextureColor.ra;\n\t\t#endif\n\t\tmg.g *= u_smoothnessScale;\n\t#else\n\t\tmg.r = u_metallic;\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tmg.g = diffuseTextureAlpha * u_smoothnessScale;\n\t\t#else\n\t\t\tmg.g = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n\treturn mg;\n}\n\n'),Ko.addInclude("PBRSpecularLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRSpecularLight(in vec3 diffuseColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat oneMinusReflectivity;\n\tdiffuseColor = EnergyConservationBetweenDiffuseAndSpecular (diffuseColor, specularColor, oneMinusReflectivity);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\treturn color;\n}\n\nvec4 PBRSpecularDiectionLight (in vec3 diffuseColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in vec3 gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn PBRSpecularLight(diffuseColor, specularColor, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec4 SpecularGloss(float diffuseTextureAlpha, in vec2 uv0)\n{\n    vec4 sg;\n\t\n\t#ifdef SPECULARTEXTURE\n\t\tvec4 specularTextureColor = texture2D(u_SpecularTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tsg.rgb = specularTextureColor.rgb;\n\t\t\tsg.a = diffuseTextureAlpha;\n\t\t#else\n\t\t\tsg = specularTextureColor;\n\t\t#endif\n\t\tsg.a *= u_smoothnessScale;\n\t#else\n\t\tsg.rgb = u_SpecularColor.rgb;\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tsg.a = diffuseTextureAlpha * u_smoothnessScale;\n\t\t#else\n\t\t\tsg.a = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n    return sg;\n}\n\n');var e={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},t={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_ReflectTexture:[5,1],u_AlphaTestValue:[0,1],u_DiffuseColor:[6,1],u_MaterialSpecular:[8,1],u_Shininess:[9,1],u_MaterialReflect:[10,1],u_TilingOffset:[11,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Color":[4,4],"u_DirectionLight.Direction":[3,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Color":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Color":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},n=Ko.nameKey.add("BLINNPHONG"),i='attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\n\tattribute vec2 a_Texcoord0;\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n\tattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\n#ifdef COLOR\n\tattribute vec4 a_Color;\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal; \n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_ViewDir; \n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\n\tattribute vec4 a_Tangent0;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position=skinTransform*a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0=a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position=skinTransform*a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tmat3 worldMat;\n\t\t#ifdef BONE\n\t\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\t#else\n\t\t\tworldMat=mat3(u_WorldMat);\n\t\t#endif  \n\t\tv_Normal=worldMat*a_Normal;//TODO:法线可以用"魔法"矩阵\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tv_Tangent=worldMat*a_Tangent0.xyz;\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t\t#endif\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\t\t#ifdef BONE\n\t\t\tv_PositionWorld=(u_WorldMat*position).xyz;\n\t\t#else\n\t\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\n\t#endif\n\n\t#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\t\tv_Texcoord0=a_Texcoord0;\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0+v_Texcoord0.y);\n\t\t#endif\n\t#endif\n\n\t#ifdef LIGHTMAP\n\t\t#ifdef SCALEOFFSETLIGHTINGMAPUV\n\t\t\t#ifdef UV1\n\t\t\t\tv_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t\t\t#else\n\t\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,a_Texcoord0.y-1.0)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t\t#endif \n\t\t#else\n\t\t\t#ifdef UV1\n\t\t\t\tv_LightMapUV=a_Texcoord1;\n\t\t\t#else\n\t\t\t\tv_LightMapUV=a_Texcoord0;\n\t\t\t#endif \n\t\t#endif \n\t#endif\n\n\t#ifdef COLOR\n\t\tv_Color=a_Color;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}',r='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nuniform vec4 u_DiffuseColor;\n\n#ifdef COLOR\n\tvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvarying vec3 v_ViewDir; \n#endif\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\n\tuniform samplerCube u_ReflectTexture;\n\tuniform vec3 u_MaterialReflect;\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform sampler2D u_LightMap;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialSpecular;\n\tuniform float u_Shininess;\n\t#ifdef SPECULARMAP \n\t\tuniform sampler2D u_SpecularTexture;\n\t#endif\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\tuniform sampler2D u_NormalTexture;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n\tvec4 mainColor=u_DiffuseColor;\n\t#ifdef DIFFUSEMAP\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\t\tmainColor=mainColor*difTexColor;\n\t#endif \n\t#ifdef COLOR\n\t\tmainColor=mainColor*v_Color;\n\t#endif \n    \n\t#ifdef ALPHATEST\n\t\tif(mainColor.a<u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tvec3 normal;\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\n\t\t#else\n\t\t\tnormal = normalize(v_Normal);\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 viewDir= normalize(v_ViewDir);\n\t\tvec3 diffuse = vec3(0.0);\n\t\tvec3 specular= vec3(0.0);\n\t\tvec3 dif,spe;\n\t\t#ifdef SPECULARMAP\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n\t\t#else\n\t\t\t#ifdef DIFFUSEMAP\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\n\t\t\t#else\n\t\t\t\tvec3 gloss=vec3(1.0);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\n\t\n\t#ifdef DIRECTIONLIGHT\n\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n \n\t#ifdef POINTLIGHT\n\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t#ifdef SPOTLIGHT\n\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t\n\tvec3 finalDiffuse;\n\t#ifdef LIGHTMAP\n\t\tfinalDiffuse=texture2D(u_LightMap, v_LightMapUV).rgb*2.0;\n\t\t//float exponent = texture2D(u_LightMap, v_LightMapUV).a;\n\t\t//finalDiffuse = texture2D(u_LightMap, v_LightMapUV).rgb;\n\t\t//float ratio = pow(2.0, exponent * 255.0 - (128.0 + 8.0));\n\t\t//finalDiffuse = finalDiffuse * 255.0 * ratio;\t\n\t\t//finalDiffuse = sqrt(finalDiffuse);\n\t#else\n\t\tfinalDiffuse=vec3(0.0);\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tfinalDiffuse+=diffuse;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor =vec4(mainColor.rgb*(u_AmbientColor + finalDiffuse)*shadowValue,mainColor.a);\n\t#else\n\t\tgl_FragColor =vec4(mainColor.rgb*(u_AmbientColor + finalDiffuse),mainColor.a);\n\t#endif\n\t\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t#ifdef RECEIVESHADOW\n\t\t\tgl_FragColor.rgb+=specular*shadowValue;\n\t\t#else\n\t\t\tgl_FragColor.rgb+=specular;\n\t\t#endif\n\t#endif\n\n\n\t#ifdef REFLECTMAP\n\t\tvec3 incident = -viewDir;\n\t\tvec3 reflectionVector = reflect(incident,normal);\n\t\tvec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n\t\tgl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n\t#endif\n\t  \n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t  main_normal();\n\t#endif  \n}\n\n',n=g.add(n,i,r,e,t),i=(zo.SHADERDEFINE_DIFFUSEMAP=n.registerMaterialDefine("DIFFUSEMAP"),zo.SHADERDEFINE_NORMALMAP=n.registerMaterialDefine("NORMALMAP"),zo.SHADERDEFINE_SPECULARMAP=n.registerMaterialDefine("SPECULARMAP"),zo.SHADERDEFINE_REFLECTMAP=n.registerMaterialDefine("REFLECTMAP"),zo.SHADERDEFINE_TILINGOFFSET=n.registerMaterialDefine("TILINGOFFSET"),zo.SHADERDEFINE_ADDTIVEFOG=n.registerMaterialDefine("ADDTIVEFOG"),e={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_TexcoordNext0:14,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},t={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_AmbientTexture:[5,1],u_ReflectTexture:[6,1],u_AlphaTestValue:[0,1],u_Albedo:[7,1],u_UVMatrix:[13,1],u_UVAge:[14,1],u_UVAniAge:[8,1],u_MaterialDiffuse:[10,1],u_MaterialAmbient:[9,1],u_MaterialSpecular:[11,1],u_MaterialReflect:[12,1],u_TilingOffset:[15,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},Ko.nameKey.add("SIMPLE")),r=(n=g.add(i,"attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#if defined(AMBIENTMAP)||(defined(LIGHTMAP)&&defined(UV1))\nattribute vec2 a_Texcoord1;\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec4 u_LightmapScaleOffset;\nvarying vec2 v_LightMapUV;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tvec4 position=skinTransform*a_Position;\n\tgl_Position = u_MvpMatrix * position;\n#else\n\tgl_Position = u_MvpMatrix * a_Position;\n#endif\n \n//TODO没考虑UV动画呢\n#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\tv_Texcoord0=a_Texcoord0;\n#endif\n\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tvec4 position=skinTransform*a_Position;\n\tgl_Position = u_MvpMatrix * position;\n#else\n\tgl_Position = u_MvpMatrix * a_Position;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t#else\n\t\tworldMat=mat3(u_WorldMat);\n\t#endif  \n\tv_Normal=worldMat*a_Normal;\n\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\tv_Tangent0=worldMat*a_Tangent0;\n\t#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\t#ifdef BONE\n\t\tv_PositionWorld=(u_WorldMat*position).xyz;\n\t#else\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\n\tv_Texcoord0=a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,v_Texcoord0.y+1.0);\n\t#endif\n\t#ifdef UVTRANSFORM\n\t\tv_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n\t#endif\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\n\t#ifdef SCALEOFFSETLIGHTINGMAPUV\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t\t#else\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,a_Texcoord0.y-1.0)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t#endif \n\t#else\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=a_Texcoord1;\n\t\t#else\n\t\t\tv_LightMapUV=a_Texcoord0;\n\t\t#endif \n\t#endif \n#endif\n\n#ifdef COLOR\n\tv_Color=a_Color;\n#endif\n\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.w;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t#endif\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\n\tmain_castShadow();\n#else\n\tmain_normal();\n#endif\n}",'#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#if   defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\nvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\nvarying vec2 v_LightMapUV;\n#endif\n#ifdef AMBIENTMAP\nuniform sampler2D u_AmbientTexture;\n#endif\n#ifdef LIGHTMAP\nuniform sampler2D u_LightMap;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP) \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#if defined(FOG)||defined(DEPTHFOG)\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||(defined(RECEIVESHADOW)&&(defined(SHADOWMAP_PSM2)||defined(SHADOWMAP_PSM3)))\nuniform vec3 u_CameraPos;\n#endif\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)\nvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n#if defined(DIFFUSEMAP)&&!defined(COLOR)\n\tgl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n#endif \n  \n#if defined(COLOR)&&!defined(DIFFUSEMAP)\n\tgl_FragColor=v_Color;\n#endif \n  \n#if defined(DIFFUSEMAP)&&defined(COLOR)\n\tvec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\tgl_FragColor=texColor*v_Color;\n#endif\n  \n#if !defined(DIFFUSEMAP)&&!defined(COLOR)\n\tgl_FragColor=vec4(1.0,1.0,1.0,1.0);\n#endif \n    \n#ifdef ALPHATEST\n\tif(gl_FragColor.a-u_AlphaTestValue<0.0)\n\t\tdiscard;\n#endif\n  \n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvec3 normal;\n    #if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n\t#else\n\t\tnormal = normalize(v_Normal);\n    #endif\n#endif\n\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\t\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef AMBIENTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n\t\t#endif\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n\t\t#endif\n\t#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_Albedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP)\n\t\tspecular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular*shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n\t#endif\n#endif\n  \n#ifdef REFLECTMAP\n\tvec3 incident = -toEye;\n\tvec3 reflectionVector = reflect(incident,normal);\n\tvec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n\tgl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n#endif\n  \n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t#ifdef ADDTIVEFOG\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t#else\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t#endif\n#endif\n#ifdef DEPTHFOG\n\tfloat lerpFact = (-v_PositionWorld.y-u_FogStart)/u_FogRange;\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\t\t\n\tmain_castShadow();\n#else\n  main_normal();\n#endif  \n}\n\n',e,t),as.SHADERDEFINE_DIFFUSEMAP=n.registerMaterialDefine("DIFFUSEMAP"),as.SHADERDEFINE_NORMALMAP=n.registerMaterialDefine("NORMALMAP"),as.SHADERDEFINE_SPECULARMAP=n.registerMaterialDefine("SPECULARMAP"),as.SHADERDEFINE_EMISSIVEMAP=n.registerMaterialDefine("EMISSIVEMAP"),as.SHADERDEFINE_AMBIENTMAP=n.registerMaterialDefine("AMBIENTMAP"),as.SHADERDEFINE_REFLECTMAP=n.registerMaterialDefine("REFLECTMAP"),as.SHADERDEFINE_UVTRANSFORM=n.registerMaterialDefine("UVTRANSFORM"),as.SHADERDEFINE_TILINGOFFSET=n.registerMaterialDefine("TILINGOFFSET"),as.SHADERDEFINE_ADDTIVEFOG=n.registerMaterialDefine("ADDTIVEFOG"),e={a_Position:0,a_Color:1},t={u_MvpMatrix:[1,2]},Ko.nameKey.add("LINE")),i=(g.add(r,"attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  v_Color=a_Color;\n}","#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\n\nvoid main()\n{\n  gl_FragColor=v_Color; \n}\n\n",e,t),e={a_position:0,a_normal:3,tangent:5,binormal:4,uv:2,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},t={u_Bones:[0,0],u_lodRect:[9,3],irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],u_aoObjPos:[14,1],texBaseColor:[1,1],texNormal:[2,1],texPbrInfo:[3,1],texPrefilterdEnv:[8,3],texHSNoise:[15,1],texPrefilterDiff:[7,3],u_AlphaTestValue:[0,1],texBRDFLUT:[4,1],u_UVAniAge:[5,1],u_roughness:[6,1],u_metaless:[7,1],u_UVMatrix:[8,1],u_UVAge:[9,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},Ko.nameKey.add("PBR")),r=(n=g.add(i,"\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\n#ifdef HAS_TANGENT\nattribute vec3 tangent;\nattribute vec3 binormal;\n#endif\nattribute vec2 uv;\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\n\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\nvoid main() {\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tgl_Position = mvp*skinTransform*vec4(a_position,1.);\n\tmat4 modelMat = modelMatrix*skinTransform;\n#else\n\tgl_Position = mvp*vec4(a_position,1.);\n\tmat4 modelMat = modelMatrix;\n#endif\t\n\tvWorldPos = modelMat*vec4(a_position,1.);\n\n#ifdef CASTSHADOW \n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tvUv = uv;\n\t#endif\t\n#else\n    vUv = uv;\n\tvWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n\t#ifdef HAS_TANGENT\n\tvWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n\tvWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n\t#endif\n    \n    vViewDir = (vWorldPos.xyz-cameraPosition);//这个不能normalize。否则无法线性差值了\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.z;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tv_lightMVPPos = u_lightShadowVP[0] * vWorldPos;\n\t#endif\n#endif\t\n#endif\n}\n",'//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\nvarying vec3 vViewDir;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n//预计算的贴图\nuniform sampler2D texPrefilterdEnv;\nuniform sampler2D texBRDFLUT;\nuniform sampler2D texPrefilterDiff;\n#ifdef HAS_PBRINFO\nuniform sampler2D texPbrInfo;   //Ao, Roughness, Metallic\n#endif\nuniform float u_hdrexposure;\nuniform float u_AlphaTestValue;\n\nuniform float u_roughness;\nuniform float u_metaless;\nconst float maxlv = 7.;\t//现在只支持512分辨率的环境贴图\nconst int nmaxlv = 9;//\n\t\t\t\t\t\t\t\nuniform mat4 irrad_mat_red;\nuniform mat4 irrad_mat_green;\nuniform mat4 irrad_mat_blue;\t\t\t\t\t\t\t\n\nvec3 speccontrib = vec3(0.);\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\nvec4 tex2dLod(sampler2D tex, float u, float v, float lod){\n\tvec2 uv = vec2(u,v);\n\tuv+=mod(gl_FragCoord.xy-vec2(0.5),2.0)*vec2(128.,0.);\n\treturn texture2D(tex,uv,lod-16.);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\nvec4 texPanoramaLod(sampler2D tex, const in vec3 dir, float lod){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn tex2dLod(tex,envu,envv,lod);\n}\n\n/*\n    计算sh光照。\n    使用level=2，所以需要9个系数。\n    https://cseweb.ucsd.edu/~ravir/papers/envmap/envmap.pdf\n*/\nfloat environment_exposure = 1.0;\nvec3 diff_sh9(vec3 dir){\n\tvec4 shDir = vec4(dir.x,-dir.z,dir.y,1.0);\n  return max(vec3(0.0), vec3(\n\tdot(shDir, irrad_mat_red * shDir),\n\tdot(shDir, irrad_mat_green * shDir),\n\tdot(shDir, irrad_mat_blue * shDir)\n\t)) * environment_exposure;\t\n}\n\n#ifdef HAS_TANGENT\nvec3 applyNormalTex( vec3 norm, vec3 surf_norm ) {\n    vec3 mapN = norm * 2.0 - 1.0;\n    //mapN.xy = normalScale * mapN.xy;\n    mat3 tsn = mat3( vWorldTangent, vWorldBinormal, surf_norm );\n    return normalize( tsn * mapN );\n}\n#endif\n\nvec4 pbrlight(vec3 normal, float rough, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tbasecolor.rgb = pow(basecolor.rgb,vec3(2.2));\n\tfloat metaless = 1.0; \t\n\tconst float ismetalinfov = (128./255.);\n\tif(basecolor.a>=ismetalinfov){//这时候表示金属度\n\t\tmetaless = (basecolor.a-ismetalinfov)*2.;\n\t\tbasecolor.a = 1.0;\n\t}else{\n\t\tmetaless = 0.;\n\t\tbasecolor.a = basecolor.a*2.0;\n\t}\n\t#ifdef FIX_METALESS\n\tmetaless = u_metaless;\n\t#endif\n\t#ifdef HAS_PBRINFO\t\n\tvec4 pbrinfo = texture2D(texPbrInfo, vUv);\n\tmetaless = pbrinfo.b;\n\trough = pbrinfo.g;\n\t#endif\n    const vec3 nonmetalF0 =vec3(0.02);\n    vec3 F0 =  mix(nonmetalF0, basecolor.rgb, metaless);\n\t\n    vec4 PrefilteredColor = texPanoramaLod(texPrefilterdEnv, R, rough*maxlv);\n    PrefilteredColor.rgb = _RGBEToRGB(PrefilteredColor);\n    vec4 EnvBRDF = texture2D(texBRDFLUT,vec2(rough , NoV));//TODO lod\n    vec2 rg = _RGBAToU16(EnvBRDF);    \n    speccontrib = (F0* rg.x + saturate( 50.0 * PrefilteredColor.g ) * rg.y);\n\tvec3 color_spec = PrefilteredColor.rgb*speccontrib;\n\t\n\tvec3 color_diff=diff_sh9(normal);\n\tvec3 outc =  color_diff*mix(basecolor.rgb,vec3(0.),metaless)*(vec3(1.0)-speccontrib)+color_spec;\n\t#ifdef HAS_PBRINFO\n\toutc*=pbrinfo.r;\n\t#endif\n\treturn vec4(outc, basecolor.a);\n}\n\nvec3 oldlight(vec4 normal, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tconst vec3 lightdir=normalize(vec3(1.,1.,0.));\n\tconst vec3 spcecol = vec3(1.,0.8,0.8);\n\tconst vec3 amb = vec3(0.5);\n\tvec3 diffv =  (vec3(saturate(dot(lightdir,normal.xyz)))+amb);\n\t//vec3 spec = spcecol* pow(saturate(dot(R,lightdir)),(1.-pbrinfo.g)*5.);\n\treturn diffv*basecolor.rgb;//+spec;\n}\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nvoid main() {\n#ifdef CASTSHADOW\n\tgl_FragColor=packDepth(gl_FragCoord.w);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(texBaseColor,vUv).w;\n\t\tif( alpha < u_AlphaTestValue ){\n\t\t\tdiscard;\n\t\t}\n\t#endif\n#else\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.0001);\n\t\t#endif\n\t#endif\t\n\t\n    vec3 normal =  normalize(vWorldNorm);\n\tvec4 normtex = texture2D( texNormal, vUv );\n\t#ifdef HAS_TANGENT\t\n\tnormal = applyNormalTex(normtex.xyz, normal);\n\t#endif\n    vec3 view   = -normalize(vViewDir);\n    float NoV = saturate(dot( view, normal ));\n    vec3 R = 2. * NoV * normal - view;\n\tfloat roughness = normtex.a;\n\t#ifdef FIX_ROUGHNESS\n\troughness = u_roughness;\n\t#endif\n\t\n\tvec4 pbrl = pbrlight(normal,roughness,NoV,R)*u_hdrexposure;\n    gl_FragColor.rgb =  pow(pbrl.rgb,vec3(0.45455));\n\t//gl_FragColor.rgb = oldlight(normtex,NoV,R);\n\t#ifdef RECEIVESHADOW\n\tgl_FragColor.rgb *= max(shadowValue,0.7);\n\t#endif\n\t\n    gl_FragColor.a = pbrl.a;\n\n#endif\n}\n',e,t),$o.SHADERDEFINE_FIX_METALESS=n.registerMaterialDefine("FIX_METALESS"),$o.SHADERDEFINE_FIX_ROUGHNESS=n.registerMaterialDefine("FIX_ROUGHNESS"),$o.SHADERDEFINE_HAS_TANGENT=n.registerMaterialDefine("HAS_TANGENT"),$o.SHADERDEFINE_HAS_PBRINFO=n.registerMaterialDefine("HAS_PBRINFO"),$o.SHADERDEFINE_USE_GROUNDTRUTH=n.registerMaterialDefine("USE_GROUNDTRUTH"),$o.SHADERDEFINE_TEST_CLIPZ=n.registerMaterialDefine("CLIPZ"),e={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},t={u_Bones:[0,0],u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlphaTestValue:[0,1],u_DiffuseColor:[7,1],u_EmissionColor:[8,1],u_DiffuseTexture:[1,1],u_NormalTexture:[3,1],u_ParallaxTexture:[4,1],u_MetallicGlossTexture:[2,1],u_OcclusionTexture:[5,1],u_EmissionTexture:[6,1],u_metallic:[9,1],u_smoothness:[10,1],u_smoothnessScale:[11,1],u_occlusionStrength:[13,1],u_normalScale:[14,1],u_parallaxScale:[15,1],u_TilingOffset:[17,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},Ko.nameKey.add("PBRStandard")),i=(n=g.add(r,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\tv_PositionWorld = (u_WorldMat * position).xyz;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t\tworldMat = mat3(u_WorldMat);\n\t\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\t#endif\n\t\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t#endif\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0 + v_Texcoord0.y);\n  \n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}",'#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\n\nuniform vec3 u_AmbientColor;\nuniform vec4 u_DiffuseColor;\n\n#ifdef DIFFUSETEXTURE\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n#ifdef METALLICGLOSSTEXTURE\n\tuniform sampler2D u_MetallicGlossTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\n#include "PBRStandardLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\tvec2 mg;\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 diffuseTextureColor = texture2D(u_DiffuseTexture, uv0);\n\t\tvec4 diffuseColor = diffuseTextureColor * u_DiffuseColor;\n\t\tmg = MetallicGloss(diffuseTextureColor.a, uv0);\n\t#else\n\t\tvec4 diffuseColor = u_DiffuseColor;\n\t\tmg = MetallicGloss(1.0, uv0);\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(diffuseColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\t\n\tgl_FragColor = diffuseColor;\n\t\n\tvec3 normal = UnpackScaleNormal(uv0);\n  \n\tvec3 gi =  u_AmbientColor * Occlusion(uv0).rgb;\n  \n\tvec4 color = PBRStandardDiectionLight(diffuseColor.rgb, mg.r, mg.g, normal, viewDir, u_DirectionLight, gi);\n\t\n\tcolor.a = diffuseColor.a;\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n',e,t),ns.SHADERDEFINE_DIFFUSETEXTURE=n.registerMaterialDefine("DIFFUSETEXTURE"),ns.SHADERDEFINE_METALLICGLOSSTEXTURE=n.registerMaterialDefine("METALLICGLOSSTEXTURE"),ns.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=n.registerMaterialDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),ns.SHADERDEFINE_NORMALTEXTURE=n.registerMaterialDefine("NORMALTEXTURE"),ns.SHADERDEFINE_PARALLAXTEXTURE=n.registerMaterialDefine("PARALLAXTEXTURE"),ns.SHADERDEFINE_OCCLUSIONTEXTURE=n.registerMaterialDefine("OCCLUSIONTEXTURE"),ns.SHADERDEFINE_EMISSION=n.registerMaterialDefine("EMISSION"),ns.SHADERDEFINE_EMISSIONTEXTURE=n.registerMaterialDefine("EMISSIONTEXTURE"),ns.SHADERDEFINE_TILINGOFFSET=n.registerMaterialDefine("TILINGOFFSET"),e={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},t={u_Bones:[0,0],u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlphaTestValue:[0,1],u_DiffuseColor:[7,1],u_SpecularColor:[8,1],u_EmissionColor:[9,1],u_DiffuseTexture:[1,1],u_NormalTexture:[3,1],u_ParallaxTexture:[4,1],u_SpecularTexture:[2,1],u_OcclusionTexture:[5,1],u_EmissionTexture:[6,1],u_smoothness:[10,1],u_smoothnessScale:[11,1],u_occlusionStrength:[13,1],u_normalScale:[14,1],u_parallaxScale:[15,1],u_TilingOffset:[17,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},Ko.nameKey.add("PBRSpecular")),r=(n=g.add(i,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\tv_PositionWorld = (u_WorldMat * position).xyz;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t\tworldMat = mat3(u_WorldMat);\n\t\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\t#endif\n\t\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t#endif\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0 + v_Texcoord0.y);\n  \n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}",'#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\n\nuniform vec3 u_AmbientColor;\nuniform vec4 u_DiffuseColor;\nuniform vec4 u_SpecularColor;\n\n#ifdef DIFFUSETEXTURE\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n#ifdef SPECULARTEXTURE\n\tuniform sampler2D u_SpecularTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\n#include "PBRSpecularLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\tvec4 sg;\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 diffuseTextureColor = texture2D(u_DiffuseTexture, uv0);\n\t\tvec4 diffuseColor = diffuseTextureColor * u_DiffuseColor;\n\t\tsg = SpecularGloss(diffuseTextureColor.a, uv0);\n\t#else\n\t\tvec4 diffuseColor = u_DiffuseColor;\n\t\tsg = SpecularGloss(1.0, uv0);\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(diffuseColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\tvec3 normal = UnpackScaleNormal(uv0);\n\t\n\tvec3 gi =  u_AmbientColor * Occlusion(uv0).rgb;\n\t\n\t//float a = (sg.r+sg.g+sg.b) / 3.0;\n  \n\tvec4 color = PBRSpecularDiectionLight(diffuseColor.rgb, sg.rgb, sg.a, normal,viewDir, u_DirectionLight, gi);\n\t\n\tcolor.a = diffuseColor.a;\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n',e,t),es.SHADERDEFINE_DIFFUSETEXTURE=n.registerMaterialDefine("DIFFUSETEXTURE"),es.SHADERDEFINE_SPECULARTEXTURE=n.registerMaterialDefine("SPECULARTEXTURE"),es.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=n.registerMaterialDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),es.SHADERDEFINE_NORMALTEXTURE=n.registerMaterialDefine("NORMALTEXTURE"),es.SHADERDEFINE_PARALLAXTEXTURE=n.registerMaterialDefine("PARALLAXTEXTURE"),es.SHADERDEFINE_OCCLUSIONTEXTURE=n.registerMaterialDefine("OCCLUSIONTEXTURE"),es.SHADERDEFINE_EMISSION=n.registerMaterialDefine("EMISSION"),es.SHADERDEFINE_EMISSIONTEXTURE=n.registerMaterialDefine("EMISSIONTEXTURE"),es.SHADERDEFINE_TILINGOFFSET=n.registerMaterialDefine("TILINGOFFSET"),e={a_position:0,a_normal:3,uv:2},t={irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],texBaseColor:[1,1],texNormal:[2,1],texSky:[11,1],texUnderWater:[3,1],texPrefilterdEnv:[8,3],texPrefilterDiff:[7,3],texWaterDisp:[4,1],texWaveDetail:[9,1],texDeepColor:[10,1],texWaterInfo:[16,1],texFoam:[17,1],GEOWAVE_UV_SCALE:[18,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_curTm:[8,1],u_scrsize:[15,1],u_WaveInfoD:[13,1],u_WaveInfo:[12,1],u_WaveMainDir:[14,1],u_DeepScale:[20,1],u_SeaColor:[19,1],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4]},Ko.nameKey.add("Water")),i=(n=g.add(r,'\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\nuniform float u_curTm;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n//uniform sampler2D texWaterDisp;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nuniform sampler2D texWaterInfo;\nvarying vec4 vWaterInfo;\nuniform float u_DeepScale;//texWaterInfo.r*vDeepScale\n#endif\nuniform float u_WaveMainDir;\t//主波方向\nuniform float GEOWAVE_UV_SCALE ;//= 100.0;\n\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\nvarying vec3 vDisp;\nvarying float fDeep;\nvarying mat2 matUVTrans;\nvarying float fFoam;\n\nconst float PI = 3.14159265358979323846264;\n\n#include "WaveFunction.glsl"\n\nvec2 getPosFromUV(vec2 uv){\n\treturn uv*50.;\n}\n\nvoid main() {\n\tvec3 pos = a_position;\n    vUv = uv;\n\t\n\t//vDisp = texture2D(texWaterDisp,uv).rgb;\n\t//vec3 disp = vDisp;\n\t\n\t//TODO 这里有个潜规则。\n\tfloat tt = pos.y; pos.y=pos.z; pos.z=-tt;\n\t\n\t#ifdef USE_VERTEX_DEEPINFO\n\tfDeep = -pos.y;\n\tpos.y=0.0;\n\t#else\n\tvWaterInfo = texture2D(texWaterInfo,uv);\n\tfDeep = vWaterInfo.r*u_DeepScale;\n\t#endif\n\t\n\t\n\t//计算波形\n\tmat4 modelMat = modelMatrix;\n\tvec3 opos, T,B,N;\n\tfloat foams=0.;\n\tvec2 uvpos = uv*GEOWAVE_UV_SCALE+vec2(modelMat[3][0],0.);//TODO 如果有旋转缩放怎么办\n\tcalcGerstnerWave(u_curTm, pos,fDeep, uvpos,opos,B,T,N,foams);\n\tfFoam = foams;\n\tgl_Position = mvp*vec4(opos,1.);\n\tvWorldPos = modelMat*vec4(opos,1.);\n\n\tvWorldNorm = normalize((modelMatrix*vec4(N,0.0)).xyz);\n\tvWorldTan = normalize((modelMatrix*vec4(T,0.0)).xyz);\n\tvWorldBin = normalize((modelMatrix*vec4(B,0.0)).xyz);\n    vViewDir = vWorldPos.xyz-cameraPosition; //这个不能取normalize，否则会引入非线性\n\t\n\tfloat s = sin(u_WaveMainDir);\n\tfloat c = cos(u_WaveMainDir);\n\tmatUVTrans = mat2(c,-s,s,c);\n}\n',"//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec3 vViewDir;//入射。pos-cam\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying float fDeep;\nvarying mat2 matUVTrans;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nvarying vec4 vWaterInfo;\n#endif\nmat3 matTBNOff;//\n\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n#ifdef CUBE_ENV\nuniform samplerCube texSky;\n#else\nuniform sampler2D texSky;\n#endif\nuniform sampler2D texUnderWater;\nuniform sampler2D texWaveDetail;\n//uniform sampler2D texDeepColor;\nuniform sampler2D texFoam;\nvarying float fFoam;\nuniform float u_curTm;\nuniform vec2 u_scrsize;\nuniform vec3 u_SeaColor;//\n\nconst int NumTexWaves=4;\nconst float Amp_over_L = 0.01;\n//const vec3 SEA_COLOR1 = vec3(0.0292,0.672,0.7467);//大洋\n//const vec3 SEA_COLOR2 = vec3(0,0.927,0.43);//近海\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\n/*\n\t各种 ToneMap\n*/\n//Reinhard\nvec3 ReinhardToneMapping(vec3 color, float adapted_lum) {\n    const float MIDDLE_GREY = 1.;\n    color *= MIDDLE_GREY / adapted_lum;\n    return color / (1.0 + color);\n}\n\n//CE2\nvec3 CEToneMapping(vec3 color, float adapted_lum){\n    return 1. - exp(-adapted_lum * color);\n}\n\n//UC2\nvec3 F1(vec3 x){\n\tconst float A = 0.22;\n\tconst float B = 0.30;\n\tconst float C = 0.10;\n\tconst float D = 0.20;\n\tconst float E = 0.01;\n\tconst float F = 0.30;\n \n\treturn ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;\n}\n\nvec3 Uncharted2ToneMapping(vec3 color, float adapted_lum){\n\tconst vec3 WHITE = vec3(11.2);\n\treturn F1(1.6 * adapted_lum * color) / F1(WHITE);\n}\n\n//ACES\nvec3 ACESToneMapping(vec3 color, float adapted_lum){\n\tconst float A = 2.51;\n\tconst float B = 0.03;\n\tconst float C = 2.43;\n\tconst float D = 0.59;\n\tconst float E = 0.14;\n\n\tcolor *= adapted_lum;\n\treturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\n/*\n\t与位于0点的测试棒的相交测试交点\n\t这个是瞎写的，只是为了测试\n*/\nbool hitClydiner(vec3 pos, vec3 dir, out vec3 hitpos, out vec3 hitnormal){\n\tconst float r = 0.5;\n\tfloat a = dir.x*dir.x+dir.z*dir.z;\n\tfloat b = 2.*dir.x*pos.x+2.*dir.z*pos.z;\n\tfloat c = pos.x*pos.x+pos.z*pos.z-r*r;\n\tfloat d = b*b-4.*a*c;\n\tif(d>=0.0){\n\t\tfloat t = (-b+sqrt(d))/2./a;\n\t\tt =min(t, (-b-sqrt(d))/2./a);\n\t\thitpos = pos+dir*t;\n\t\treturn true;\n\t}\n\t/*\n\tvec3 v1 = normalize(cross(dir,vec3(0.,1.,0.)));//公垂线\n\tfloat dist = dot(pos,v1);//最短距离\n\tif(abs(dist)<r){\n\t\treturn true;\n\t}\n\t*/\n\treturn false;\n}\n\n///* 根据散射公式来计算某个方向的颜色 *///\n//\nfloat phase_function(float costheta, float g, float g2){\n\treturn 1.5*( (1.0-g2) / (2.0+g2) ) * (1.0+costheta*costheta) / pow(1.0+g2-2.0*g*costheta, 1.5);\t\n}\n\nconst float _density = .2;\nconst vec3 _vLightDir=vec3(0.,-1.,0.);//必须是规格化的\nconst int _SAMPLENUM = 20;\nconst float _K1 = 1.0;\nconst float _g = -0.93;\n//\nvec3 calcScatter(vec3 start, vec3 dir, vec3 end){\n\tfloat len = length(end-start);\n\tfloat costheta = dot(dir,_vLightDir);\n\tfloat g2 = _g*_g;\n\tfloat K = _K1*len*_density*phase_function(costheta,_g,g2);\n\t//用分段的方式来积分\n\tfloat dlen = len/float(_SAMPLENUM);//距离平分\n\tfloat ddeep = (start.y-end.y)/float(_SAMPLENUM);//深度平分\n\tfloat sum=0.;\n\tfor( int i=0; i<_SAMPLENUM; i++){\n\t\tfloat fi = float(i);\n\t\tfloat v1 = exp(-_density*(dlen+ddeep)*fi);//TODO 应该可以用分析法计算出来\n\t\tsum += v1;\n\t}\n\treturn vec3(K*sum);\n}\n///* 根据散射公式来计算某个方向的亮度  END *///\n\nconst float cDeep = -2.;\t//假设水的深度\nvec3 getShuiDiColor(vec3 pos, vec3 dir, vec3 normal){\n\t//一个无限大的水底，黑白格纹理。纹理长度为1米\n\tfloat t = ( cDeep-pos.y )/dir.y;\n\tif(t<0.) return vec3(1.,0.,0.);//TEST\n\tbool bhit = false;\n\tvec3 hitpos;\n\tvec3 hitcolor;\n\tvec3 hn;\n\tif(hitClydiner(pos,dir,hitpos,hn) && hitpos.y>cDeep && hitpos.y<pos.y){\n\t\tbhit=true;\n\t\thitcolor = vec3(.8,.8,.8);\n\n\t}else\n\t{\n\t\thitpos = pos+dir*t;\n\t\tvec3 hp = floor(hitpos);\n\t\tfloat a = mod((hp.x+hp.z),2.);\n\t\thitcolor = (a<.9)?vec3(0.,0.,0.):vec3(1.,1.,1.);\n\t\t//hitcolor = texture2D(texUnderWater,hitpos.xz/10.).rgb;\n\t}\n\t\n\tfloat l = length(hitpos-pos);\n\t//return texture2D(texDeepColor,vec2(min(max(l/400.,0.),1.),0.5)).rgb;\n\t//return SEA_COLOR1*calcScatter(pos,dir,hitpos);\n\tfloat left = pow(0.8,l);//假设透过率为80%，则到达水底的时候的光强。\n\treturn mix(hitcolor,u_SeaColor,1.-left);\n}\n\n/*\n\tview已经normalize了\n*/\nvec3 getRefractColor(vec3 view,vec3 normal){\n\tvec3 T = refract(-view, normal, 0.7);\n\treturn getShuiDiColor(vWorldPos.xyz,T,normal); \n}\n\nvec4 calcWaterC(vec3 view, vec3 normal, float von, vec3 R, float rough){\n\t/*\n\t只有浪顶的法线向下，也就是波形形成了交叠的时候，才会这样，所以要通过参数控制避免出现这种情况，而不是在这里保护。\n\tif(dot(R,vec3(0.,1.,0.))<0.){\n\t\tR = -R;\n\t}\n\t*/\n\t//vec3 refr = getRefractColor(-view,normal);\n#ifdef USE_REFR_TEX\t\n\tvec3 refr = texture2D(texUnderWater, gl_FragCoord.xy/u_scrsize+normal.xz/8.).rgb;\n#else\n\tvec3 refr = u_SeaColor;\n#endif\n\tfloat F0=0.02;\n\t//菲涅尔，越大反射越强\n\tfloat f =  F0+(1.0-F0)*exp2((-5.55473*von-6.98316)*von);\n\t//float f = F0+(1.0-F0)*pow(1.-von,5.);\n\t//能看到水底的程度。反射剩余的*水中的衰减\n\t//float a = (1.-f)*(1.-deepk);\n#ifdef CUBE_ENV\n\tvec4 reflc = textureCube(texSky,R);\n#else\n\tvec4 reflc = texPanorama(texSky, R);\n#endif\n#ifdef HDR_ENV\n\tvec3 refl = _RGBEToRGB(reflc)*f;\n#else\n\tvec3 refl = reflc.rgb*f;\n#endif\n\t//return vec4(refl*(1.-rough),1.);\n\t\n\t//vec3 refl = reflc.rgb*f;\n\tvec3 final = mix(refr, u_SeaColor, min(fDeep/10.,1.))+refl*(max(0.,1.-rough));\n#ifdef HDR_ENV\n\tfinal = ACESToneMapping(final,1.);//TODO 这个要uniform传入\n#endif\n\treturn vec4(final,f);\n}\n\nvoid main() {\n    vec3 normal =  normalize(vWorldNorm);\n\t//如果uv=1为100米，希望每个细节纹理表示20米的小波形，则uv缩放是 100/20。细节纹理内部也要用这个值，即pos=uv*20\n\tvec2 ruv = matUVTrans*vUv;\n\tvec3 detailNorm = texture2D(texWaveDetail,fract(ruv*5.)).rgb*2.-vec3(1.);//TODO uv怎么算\n\tfloat texNormScale = 2.*PI*float(NumTexWaves)*Amp_over_L*2.5;\n\tdetailNorm *= vec3(texNormScale,1.,texNormScale);\n\t//旋转\n\t//细节纹理来自rendertarget，因此需要颠倒z\n\t\n\tmatTBNOff = mat3(matUVTrans[0][0],0.,matUVTrans[1][0],\n\t0.,1.,0.,\n\tmatUVTrans[0][1],0.,matUVTrans[1][1]\n\t);\n\t\n\t/*\n\tmatTBNOff = mat3(0.,0.,1.,\n\t0.,1.,0.,\n\t-1.,0.,0.\n\t);\n\t*/\n\n    mat3 tsn = mat3( vWorldBin, normal, vWorldTan);\t\n    //normal = normalize(tsn * matTBNOff * detailNorm);\n\tnormal = normalize(tsn * detailNorm); //这个应该更正确。因为本身方向就是根据uv算的，如果是静态图片才需要转换。\n\t//vec4 normtex = texture2D( texNormal, vUv );\n    vec3 view   = -normalize(vViewDir);//view 是指向camera的\n    float NoV = saturate(dot( view, normal ));\n    //vec3 R = 2. * NoV * normal - view;\n\t\n#ifdef USE_FOAM\t\n\tvec4 foamc = (texture2D(texFoam,vUv*50.)+texture2D(texFoam,vUv*20.))/2.;\n\tfloat nearcoast = 1.-min(fDeep/10.,1.);// 1.-vWaterInfo.r;\n\tfloat foams = (nearcoast/4.+fFoam)*2.*nearcoast;\n#else\n\tfloat foams =0.;\n#endif\n\t\n\tvec3 R = reflect(-view,normal);\n\tvec4 wc = calcWaterC(view, normal,NoV,R, foams);\n\n\tgl_FragColor.rgb = wc.rgb;//normalize(detailNorm).rrr;//((normal)+vec3(0.0))/1.;//normalize(normal).rgb;//texture2D(texWaveDetail,vUv).rgb;// fracColor * texture2D(texUnderWater, vUv*20.0).rgb;// vec3(1.0);//pbrl.rgb;\n    gl_FragColor.a = 1.0;//wc.a;\n#ifdef USE_FOAM\n\tgl_FragColor.rgb = mix(gl_FragColor.rgb,vec3(1.),foamc.a*foams);\n\tgl_FragColor.a = foamc.r;\n#endif\n\t//if(mod(vUv.x*100.,1.0)<0.02 || mod(vUv.y*100.,1.0)<0.02) gl_FragColor.rgb=vec3(0.5,.5,.5);\n\t//gl_FragColor.rgb = detailNorm;\n}\n",e,t),_s.SHADERDEFINE_CUBE_ENV=n.registerMaterialDefine("CUBE_ENV"),_s.SHADERDEFINE_HDR_ENV=n.registerMaterialDefine("HDR_ENV"),_s.SHADERDEFINE_SHOW_NORMAL=n.registerMaterialDefine("SHOW_NORMAL"),_s.SHADERDEFINE_USEVERTEXHEIGHT=n.registerMaterialDefine("USE_VERTEX_DEEPINFO"),_s.SHADERDEFINE_USE_FOAM=n.registerMaterialDefine("USE_FOAM"),_s.SHADERDEFINE_USE_REFRACT_TEX=n.registerMaterialDefine("USE_REFR_TEX"),e={a_CornerTextureCoordinate:17,a_MeshPosition:0,a_MeshColor:1,a_MeshTextureCoordinate:2,a_ShapePositionStartLifeTime:30,a_DirectionTime:32,a_StartColor:19,a_EndColor:23,a_StartSize:20,a_StartRotation0:22,a_StartSpeed:31,a_Random0:34,a_Random1:35,a_SimulationWorldPostion:36,a_SimulationWorldRotation:37},t={u_Tintcolor:[2,1],u_TilingOffset:[3,1],u_texture:[1,1],u_WorldPosition:[0,2],u_WorldRotation:[1,2],u_PositionScale:[4,2],u_SizeScale:[5,2],u_ScalingMode:[6,2],u_Gravity:[7,2],u_ThreeDStartRotation:[8,2],u_StretchedBillboardLengthScale:[9,2],u_StretchedBillboardSpeedScale:[10,2],u_SimulationSpace:[11,2],u_CurrentTime:[12,2],u_ColorOverLifeGradientAlphas:[22,2],u_ColorOverLifeGradientColors:[23,2],u_MaxColorOverLifeGradientAlphas:[24,2],u_MaxColorOverLifeGradientColors:[25,2],u_VOLVelocityConst:[13,2],u_VOLVelocityGradientX:[14,2],u_VOLVelocityGradientY:[15,2],u_VOLVelocityGradientZ:[16,2],u_VOLVelocityConstMax:[17,2],u_VOLVelocityGradientMaxX:[18,2],u_VOLVelocityGradientMaxY:[19,2],u_VOLVelocityGradientMaxZ:[20,2],u_VOLSpaceType:[21,2],u_SOLSizeGradient:[26,2],u_SOLSizeGradientX:[27,2],u_SOLSizeGradientY:[28,2],u_SOLSizeGradientZ:[29,2],u_SOLSizeGradientMax:[30,2],u_SOLSizeGradientMaxX:[31,2],u_SOLSizeGradientMaxY:[32,2],u_SOLSizeGradientMaxZ:[33,2],u_ROLAngularVelocityConst:[34,2],u_ROLAngularVelocityConstSeprarate:[35,2],u_ROLAngularVelocityGradient:[36,2],u_ROLAngularVelocityGradientX:[37,2],u_ROLAngularVelocityGradientY:[38,2],u_ROLAngularVelocityGradientZ:[39,2],u_ROLAngularVelocityGradientW:[40,2],u_ROLAngularVelocityConstMax:[41,2],u_ROLAngularVelocityConstMaxSeprarate:[42,2],u_ROLAngularVelocityGradientMax:[43,2],u_ROLAngularVelocityGradientMaxX:[44,2],u_ROLAngularVelocityGradientMaxY:[45,2],u_ROLAngularVelocityGradientMaxZ:[46,2],u_ROLAngularVelocityGradientMaxW:[47,2],u_TSACycles:[48,2],u_TSASubUVLength:[49,2],u_TSAGradientUVs:[50,2],u_TSAMaxGradientUVs:[51,2],u_CameraPosition:[0,3],u_CameraDirection:[5,3],u_CameraUp:[6,3],u_View:[1,3],u_Projection:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4]},Ko.nameKey.add("PARTICLESHURIKEN")),r=(n=g.add(i,"#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\tattribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n\tattribute vec3 a_MeshPosition;\n\tattribute vec4 a_MeshColor;\n\tattribute vec2 a_MeshTextureCoordinate;\n\tvarying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n\tvarying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n\tuniform vec3 u_CameraPosition;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientW[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n\tfloat halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n\tfloat halfYaw = rot.y * 0.5;\n\n\tfloat sinRoll = sin(halfRoll);\n\tfloat cosRoll = cos(halfRoll);\n\tfloat sinPitch = sin(halfPitch);\n\tfloat cosPitch = cos(halfPitch);\n\tfloat sinYaw = sin(halfYaw);\n\tfloat cosYaw = cos(halfYaw);\n\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n\tfloat halfAngle = angle * 0.5;\n\tfloat sin = sin(halfAngle);\n\t\n\tfloat quaX = axis.x * sin;\n\tfloat quaY = axis.y * sin;\n\tfloat quaZ = axis.z * sin;\n\tfloat quaW = cos(halfAngle);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n\t  else\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n\t  else\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n\t else\n\t   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\n\tvec3 lifeVelocity;\n\tif(normalizedAge<1.0){ \n\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n\t#endif \n\tvec3 gravityVelocity=u_Gravity*age;\n\t\n\tvec4 worldRotation;\n\tif(u_SimulationSpace==0)\n\t\tworldRotation=a_SimulationWorldRotation;\n\telse\n\t\tworldRotation=u_WorldRotation;\n\t\n\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\tfloat c = cos(rot);\n\t\t\t\tfloat s = sin(rot);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat c = cos(a_StartRotation0.x);\n\t\t\t\tfloat s = sin(a_StartRotation0.x);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\tvec3 velocity;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t    if(u_VOLSpaceType==0)\n\t\t  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n\t    else\n\t\t  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n\t    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif\t\n\t\tvec3 cameraUpVector = normalize(velocity);\n\t\tvec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n\t\t\n\t\tsideVector=u_SizeScale.xzy*sideVector;\n\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n\t\t\n\t    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\n\t    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t    corner=rotaionZHalfPI*corner;\n\t    corner.y=corner.y-abs(corner.y);\n\t\t\n\t    float speed=length(velocity);//TODO:\n\t    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,1.0);\n\t    const vec3 sideVector = vec3(-1.0,0.0,0.0);\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n\t    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,-computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\t#ifdef ROTATIONOVERLIFETIME\n\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t\t\t\t//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\n\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,a_StartRotation0.z), age,normalizedAge);\n\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\n\t\t\t\t#endif\t\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\n\t\t\t\t\t#else\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t}\n\t\t#endif\n\t\tv_MeshColor=a_MeshColor;\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n\t#ifdef DIFFUSEMAP\n\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n\t\t#endif\n\t\t#ifdef RENDERMODE_MESH\n\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n\t\t#endif\n\t\t\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset.xy+vec2(u_TilingOffset.z,-u_TilingOffset.w);//需要特殊处理\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n\t\t#endif\n\t#endif\n    v_Discard=0.0;\n\t  \n\t#ifdef FOG\n\t\tv_PositionWorld=center;\n\t#endif\n   }\n   else\n\t{\n\t\tv_Discard=1.0;\n\t}\n}\n\n","#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#ifdef RENDERMODE_MESH\n\tvarying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n\tuniform vec3 u_CameraPosition;\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\nvoid main()\n{\t\n\t#ifdef RENDERMODE_MESH\n\t\tgl_FragColor=v_MeshColor;\n\t#else\n\t\tgl_FragColor=vec4(1.0);\t\n\t#endif\n\t\t\n\t#ifdef DIFFUSEMAP\n\t\tif(v_Discard!=0.0)\n\t\t\tdiscard;\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n\t\t#endif\n\t#else\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=v_Color;\n\t\t#endif\n\t#endif\n\t\n\t#ifdef FOG\n\t\tvec3 toEye=u_CameraPosition-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t\t\n\t\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}",e,t),ms.SHADERDEFINE_DIFFUSEMAP=n.registerMaterialDefine("DIFFUSEMAP"),ms.SHADERDEFINE_TINTCOLOR=n.registerMaterialDefine("TINTCOLOR"),ms.SHADERDEFINE_ADDTIVEFOG=n.registerMaterialDefine("ADDTIVEFOG"),ms.SHADERDEFINE_TILINGOFFSET=n.registerMaterialDefine("TILINGOFFSET"),V.SHADERDEFINE_RENDERMODE_BILLBOARD=n.registerSpriteDefine("SPHERHBILLBOARD"),V.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=n.registerSpriteDefine("STRETCHEDBILLBOARD"),V.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=n.registerSpriteDefine("HORIZONTALBILLBOARD"),V.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=n.registerSpriteDefine("VERTICALBILLBOARD"),V.SHADERDEFINE_COLOROVERLIFETIME=n.registerSpriteDefine("COLOROVERLIFETIME"),V.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=n.registerSpriteDefine("RANDOMCOLOROVERLIFETIME"),V.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=n.registerSpriteDefine("VELOCITYOVERLIFETIMECONSTANT"),V.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=n.registerSpriteDefine("VELOCITYOVERLIFETIMECURVE"),V.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=n.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),V.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=n.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),V.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=n.registerSpriteDefine("TEXTURESHEETANIMATIONCURVE"),V.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=n.registerSpriteDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),V.SHADERDEFINE_ROTATIONOVERLIFETIME=n.registerSpriteDefine("ROTATIONOVERLIFETIME"),V.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=n.registerSpriteDefine("ROTATIONOVERLIFETIMESEPERATE"),V.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=n.registerSpriteDefine("ROTATIONOVERLIFETIMECONSTANT"),V.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=n.registerSpriteDefine("ROTATIONOVERLIFETIMECURVE"),V.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=n.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),V.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=n.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),V.SHADERDEFINE_SIZEOVERLIFETIMECURVE=n.registerSpriteDefine("SIZEOVERLIFETIMECURVE"),V.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=n.registerSpriteDefine("SIZEOVERLIFETIMECURVESEPERATE"),V.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=n.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVES"),V.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=n.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),V.SHADERDEFINE_RENDERMODE_MESH=n.registerSpriteDefine("RENDERMODE_MESH"),V.SHADERDEFINE_SHAPE=n.registerSpriteDefine("SHAPE"),e={a_Position:0,a_Texcoord0:2,a_Time:33},t={u_Texture:[1,1],u_Albedo:[2,1],u_Color:[3,1],u_CurrentTime:[2,2],u_Duration:[3,2],u_MvpMatrix:[1,2]},Ko.nameKey.add("GLITTER")),i=(n=g.add(r,"attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n","#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\t\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor=gl_FragColor*u_Albedo;\n}\n\n",e,t),e={a_Position:0},t={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_CubeTexture:[3,1],u_MvpMatrix:[4,3]},Ko.nameKey.add("SkyBox")),r=(g.add(i,"attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord=a_Position.xyz;\n}\n","#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform samplerCube u_CubeTexture;\n\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(textureCube(u_CubeTexture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",e,t),e={a_Position:0,a_Texcoord0:2},t={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_texture:[3,1],u_MvpMatrix:[4,3]},Ko.nameKey.add("SkyDome")),n=(g.add(r,"attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord = a_Texcoord0;\n}\n","#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform sampler2D u_texture;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(texture2D(u_texture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",e,t),e={a_Position:0,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15},t={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_NormalTexture:[1,1],u_DiffuseTexture1:[2,1],u_DiffuseTexture2:[3,1],u_DiffuseTexture3:[4,1],u_DiffuseTexture4:[5,1],u_DiffuseScale1:[6,1],u_DiffuseScale2:[7,1],u_DiffuseScale3:[8,1],u_DiffuseScale4:[9,1],u_MaterialDiffuse:[11,1],u_MaterialAmbient:[10,1],u_MaterialSpecular:[12,1],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},Ko.nameKey.add("Terrain")),i=g.add(n,"attribute vec4 a_Position;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nuniform mat4 u_MvpMatrix;\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\tv_Texcoord0=a_Texcoord0;\n\tv_Texcoord1=a_Texcoord1;\n\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tv_Normal=a_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n#endif\n\n#ifdef LIGHTMAP\n\t//这个地方使用a_Normal 并不是真的代表normal，其实凑巧法线图的uv正好是符合 light_Map的UV\n\tv_LightMapUV=vec2(a_Normal.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Normal.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n#endif\n\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.w;\n\t#ifdef SHADOWMAP_PSSM1\n\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t#endif\n#endif\n\n}",'#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialDiffuse;\n\tuniform vec4 u_MaterialSpecular;\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\nuniform sampler2D u_NormalTexture;\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform vec2 u_DiffuseScale1;\nuniform vec2 u_DiffuseScale2;\nuniform vec2 u_DiffuseScale3;\nuniform vec2 u_DiffuseScale4;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n#ifdef DETAIL_NUM1\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz;\n#endif\n#ifdef DETAIL_NUM2\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-splatAlpha.r) + color2.xyz * splatAlpha.r;\n#endif\n#ifdef DETAIL_NUM3\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g)) + color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g;\n#endif\n#ifdef DETAIL_NUM4\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord1/u_DiffuseScale4);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g+splatAlpha.b))+ color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g + color4.xyz * splatAlpha.b;\n#endif\n\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = texture2D(u_NormalTexture,v_Normal.xy).xyz;\n\tnormal = normal*2.0 - vec3(1.0);\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t\t#endif\n\t#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n',e,t),r=(ss.SHADERDEFINE_DETAIL_NUM1=i.registerMaterialDefine("DETAIL_NUM1"),ss.SHADERDEFINE_DETAIL_NUM2=i.registerMaterialDefine("DETAIL_NUM2"),ss.SHADERDEFINE_DETAIL_NUM4=i.registerMaterialDefine("DETAIL_NUM4"),ss.SHADERDEFINE_DETAIL_NUM3=i.registerMaterialDefine("DETAIL_NUM3"),e={a_Position:0,a_Normal:3,a_Texcoord0:2},t={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_DiffuseTexture1:[1,1],u_DiffuseTexture2:[2,1],u_DiffuseTexture3:[3,1],u_DiffuseTexture4:[4,1],u_DiffuseTexture5:[5,1],u_DiffuseScaleOffset1:[6,1],u_DiffuseScaleOffset2:[7,1],u_DiffuseScaleOffset3:[8,1],u_DiffuseScaleOffset4:[9,1],u_DiffuseScaleOffset5:[10,1],u_MaterialAlbedo:[14,1],u_MaterialDiffuse:[12,1],u_MaterialAmbient:[11,1],u_MaterialSpecular:[13,1],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},Ko.nameKey.add("ExtendTerrain")),n=g.add(r,"attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform vec4 u_LightmapScaleOffset;\n#endif\n\n#ifdef RECEIVESHADOW\n\tvarying float v_posViewZ;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n#endif\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n  \n\tv_Texcoord0 = a_Texcoord0;\n  \n\t#ifdef LIGHTMAP\n\t\tv_LightMapUV = vec2(a_Texcoord0.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Texcoord0.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_Normal = a_Normal;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}",'#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tuniform vec3 u_MaterialDiffuse;\n\tuniform vec4 u_MaterialSpecular;\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\nuniform vec3 u_MaterialAmbient;\nuniform vec4 u_MaterialAlbedo;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n\t#ifdef ExtendTerrain_DETAIL_NUM1\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM2\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM3\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM4\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM5\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n\t#endif\n\t\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = v_Normal;\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t#else\n\t\t#if defined(RECEIVESHADOW)\t\t\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t\t//vec3 tColor= u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue + mix(vec3(0.15,0.15,0.15),vec3(0.0),shadowValue);\n\t\t\t//gl_FragColor.rgb*=tColor;\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t\t#endif\n\t#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_MaterialAlbedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor = vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n',e,t),i=(n.addSpriteDefines(cl.shaderDefines),n.addMaterialDefines(ko.shaderDefines),e={a_Position:0,a_OffsetVector:41,a_Texcoord0X:38,a_Texcoord0Y:40,a_BirthTime:33},t={u_MvpMatrix:[1,2],u_VMatrix:[1,3],u_PMatrix:[2,3],u_TilingOffset:[3,1],u_MainTexture:[1,1],u_MainColor:[2,1],u_CurTime:[3,2],u_LifeTime:[4,2],u_WidthCurve:[5,2],u_WidthCurveKeyLength:[6,2],u_GradientColorkey:[7,2],u_GradientAlphakey:[8,2]},Ko.nameKey.add("Trail")),r=g.add(i,"attribute vec3 a_Position;\nattribute vec3 a_OffsetVector;\nattribute vec4 a_Color;\nattribute float a_Texcoord0X;\nattribute float a_Texcoord0Y;\nattribute float a_BirthTime;\n\nuniform mat4 u_VMatrix;\nuniform mat4 u_PMatrix;\n\nuniform vec4 u_TilingOffset;\n\nuniform float u_CurTime;\nuniform float u_LifeTime;\nuniform vec4 u_WidthCurve[10];\nuniform int u_WidthCurveKeyLength;\n\nuniform vec4 u_GradientColorkey[10];\nuniform vec2 u_GradientAlphakey[10];\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\n{\n\tfloat t2 = t * t;\n\tfloat t3 = t2 * t;\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\n\tfloat b = t3 - 2.0 * t2 + t;\n\tfloat c = t3 - t2;\n\tfloat d = -2.0 * t3 + 3.0 * t2;\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\n}\n\nfloat getCurWidth(in float normalizeTime)\n{\n\tif(normalizeTime == 0.0){\n\t\treturn u_WidthCurve[0].w;\n\t}\n\telse if(normalizeTime >= 1.0){\n\t\treturn u_WidthCurve[u_WidthCurveKeyLength - 1].w;\n\t}\n\telse{\n\t\tfor(int i = 0; i < 10; i ++ )\n\t\t{\n\t\t\tif(normalizeTime == u_WidthCurve[i].x)\n\t\t\t{\n\t\t\t\treturn u_WidthCurve[i].w;\n\t\t\t}\n\t\t\t\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\n\t\t\t{\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\n\t\t\t\tfloat outTangent = lastFrame.z;\n\t\t\t\tfloat inTangent = nextFrame.y;\n\t\t\t\tfloat value1 = lastFrame.w;\n\t\t\t\tfloat value2 = nextFrame.w;\n\t\t\t\treturn hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\n\t\t\t}\n\t\t}\t\n\t}\n}\t\n\nvec4 getColorFromGradientByBlend(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tfloat colorKey = gradientColor.w;\n\t\tif(colorKey >= normalizeTime)\n\t\t{\n\t\t\tvec4 lastGradientColor = gradientColors[i-1];\n\t\t\tfloat lastColorKey = lastGradientColor.w;\n\t\t\tfloat age = (normalizeTime - lastColorKey) / (colorKey - lastColorKey);\n\t\t\tcolor.rgb = mix(gradientColors[i-1].xyz, gradientColor.xyz, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tfloat alphaKey = gradientAlpha.y;\n\t\tif(alphaKey >= normalizeTime)\n\t\t{\n\t\t\tvec2 lastGradientAlpha = gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey = lastGradientAlpha.y;\n\t\t\tfloat age = (normalizeTime - lastAlphaKey) / (alphaKey - lastAlphaKey);\n\t\t\tcolor.a = mix(lastGradientAlpha.x, gradientAlpha.x, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvec4 getColorFromGradientByFixed(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tif(gradientColor.w >= normalizeTime)\n\t\t{\n\t\t\tcolor.rgb = gradientColor.xyz;\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tif(gradientAlpha.y >= normalizeTime)\n\t\t{\n\t\t\tcolor.a = gradientAlpha.x;\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvoid main()\n{\n\tfloat normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\n\t\n\tgl_Position = u_PMatrix * u_VMatrix * vec4(a_Position + a_OffsetVector * getCurWidth(normalizeTime),1.0);\n\t\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0 = (vec2(a_Texcoord0X, a_Texcoord0Y) * u_TilingOffset.xy) + u_TilingOffset.zw;\n\t#else\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\n\t#endif\n\t\n\t#ifdef GRADIENTMODE_BLEND\n\t\tv_Color = getColorFromGradientByBlend(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n\t#else\n\t\tv_Color = getColorFromGradientByFixed(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n\t#endif\n}\n\n\n\n","#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_MainTexture;\nuniform vec4 u_MainColor;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nvoid main()\n{\t\n\tvec4 color = 2.0 * u_MainColor * v_Color;\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n\t\tcolor *= mainTextureColor;\n\t#endif\n\tgl_FragColor = color;\n}\n\n",e,t);vs.SHADERDEFINE_DIFFUSETEXTURE=r.registerMaterialDefine("DIFFUSETEXTURE"),vs.SHADERDEFINE_TILINGOFFSET=r.registerSpriteDefine("TILINGOFFSET"),Wl.SHADERDEFINE_GRADIENTMODE_BLEND=r.registerSpriteDefine("GRADIENTMODE_BLEND")};var pr=Er;function Er(){}t(vr,"laya.d3.shader.ValusArray"),(d=vr.prototype).setValue=function(e,t){this._data[e]=t},n(0,d,"data",function(){return this._data});var gr=vr;function vr(){this._data=null,this._data=[]}t(Sr,"laya.d3.shadowMap.ParallelSplitShadowMap"),(d=Sr.prototype).setInfo=function(e,t,n,i,r,a){3<r&&(this._numberOfPSSM=3),this._scene=e,this._maxDistance=t,this.PSSMNum=r,this._globalParallelLightDir=n,this._ratioOfDistance=1/this._numberOfPSSM;for(var o=0;o<this._spiltDistance.length;o++)this._spiltDistance[o]=0;this._shadowMapTextureSize=i,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this.setPCFType(a),this._statesDirty=!0},d.setPCFType=function(e){switch(this._PCFType=e,this._PCFType){case 0:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 1:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 2:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 3:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2)}},d.getPCFType=function(){return this._PCFType},d.setFarDistance=function(e){this._maxDistance!=e&&(this._maxDistance=e,this._statesDirty=!0)},d.getFarDistance=function(){return this._maxDistance},d._setGlobalParallelLightDir=function(e){this._globalParallelLightDir=e},d.getGlobalParallelLightDir=function(){return this._globalParallelLightDir},d.getCurrentPSSM=function(){return this._currentPSSM},d.getLightCamera=function(e){return this._lightCameras[e]},d._beginSampler=function(e,t){if(e<0||e>this._numberOfPSSM)throw new Error("ParallelSplitShadowMap: beginSample invalid index");this._currentPSSM=e,this._update(t)},d.endSampler=function(e){this._currentPSSM=-1},d._calcAllLightCameraInfo=function(e){if(1===this._numberOfPSSM)this._beginSampler(0,e),this.endSampler(e);else for(var t=0,n=this._numberOfPSSM+1;t<n;t++)this._beginSampler(t,e),this.endSampler(e)},d._recalculate=function(e,t,n){this._calcSplitDistance(e),this._calcBoundingBox(t,n),this._rebuildRenderInfo()},d._update=function(e){var t=e.nearPlane,n=e.fieldOfView,i=e.aspectRatio;!this._statesDirty&&this.lastNearPlane===t&&this.lastFieldOfView===n&&this.lastAspectRatio===i||(this._recalculate(t,n,i),this._uploadShaderValue(),this._statesDirty=!1,this.lastNearPlane=t,this.lastFieldOfView=n,this.lastAspectRatio=i),this._calcLightViewProject(e)},d._uploadShaderValue=function(){var e=this._scene;switch(this._numberOfPSSM){case 1:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 2:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 3:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2)}var t=e._shaderValues;switch(t.setValue(15,this._shaderValueDistance.elements),t.setValue(16,this._shaderValueLightVP),t.setValue(17,this._shadowPCFOffset.elements),this._numberOfPSSM){case 3:t.setValue(18,this.getRenderTarget(1)),t.setValue(19,this.getRenderTarget(2)),t.setValue(20,this.getRenderTarget(3));break;case 2:t.setValue(18,this.getRenderTarget(1)),t.setValue(19,this.getRenderTarget(2));break;case 1:t.setValue(18,this.getRenderTarget(1))}},d._calcSplitDistance=function(e){for(var t=this._maxDistance,n=1/this._numberOfPSSM,i=0,i=0;i<=this._numberOfPSSM;i++)this._uniformDistance[i]=e+(t-e)*i*n;var r=t/e;for(i=0;i<=this._numberOfPSSM;i++){var a=Math.pow(r,i*n);this._logDistance[i]=e*a}for(i=0;i<=this._numberOfPSSM;i++)this._spiltDistance[i]=this._uniformDistance[i]*this._ratioOfDistance+this._logDistance[i]*(1-this._ratioOfDistance);this._shaderValueDistance.x=this._spiltDistance[1],this._shaderValueDistance.y=this._spiltDistance[2],this._shaderValueDistance.z=this._spiltDistance[3]},d._calcBoundingBox=function(e,t){for(var n,i,r,a,o=Math.tan(3.1415926*e/180/2),s=0,s=0;s<=this._numberOfPSSM;s++){var l,h,_=this._spiltDistance[s],u=this._frustumPos[4*s+0].elements;u[0]=-(h=(l=_*o)*t),u[1]=-l,u[2]=-_,(u=this._frustumPos[4*s+1].elements)[0]=h,u[1]=-l,u[2]=-_,(u=this._frustumPos[4*s+2].elements)[0]=-h,u[1]=l,u[2]=-_,(u=this._frustumPos[4*s+3].elements)[0]=h,u[1]=l,u[2]=-_,(u=this._dimension[s].elements)[0]=h,u[1]=l}for(s=1;s<=this._numberOfPSSM;s++)n=this._dimension[s].elements,(i=this._boundingBox[s].min.elements)[0]=-n[0],i[1]=-n[1],i[2]=-this._spiltDistance[s],(r=this._boundingBox[s].max.elements)[0]=n[0],r[1]=n[1],r[2]=-this._spiltDistance[s-1],(a=this._boundingSphere[s].center.elements)[0]=.5*(i[0]+r[0]),a[1]=.5*(i[1]+r[1]),a[2]=.5*(i[2]+r[2]),this._boundingSphere[s].radius=.5*Math.sqrt(Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2)+Math.pow(r[2]-i[2],2));i=this._boundingBox[0].min.elements,n=this._dimension[this._numberOfPSSM].elements,i[0]=-n[0],i[1]=-n[1],i[2]=-this._spiltDistance[this._numberOfPSSM],(r=this._boundingBox[0].max.elements)[0]=n[0],r[1]=n[1],r[2]=-this._spiltDistance[0],(a=this._boundingSphere[0].center.elements)[0]=.5*(i[0]+r[0]),a[1]=.5*(i[1]+r[1]),a[2]=.5*(i[2]+r[2]),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2)+Math.pow(r[2]-i[2],2))},d.calcSplitFrustum=function(e){0<this._currentPSSM?R.createPerspective(3.1416*e.fieldOfView/180,e.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):R.createPerspective(3.1416*e.fieldOfView/180,e.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._numberOfPSSM],this._tempMatrix44),R.multiply(this._tempMatrix44,e.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44},d._rebuildRenderInfo=function(){var e=this._numberOfPSSM+1,t=0;if(null==this._renderTarget)for(this._renderTarget=w(e),this._renderTarget[0]=null,t=1;t<e;t++)this._renderTarget[t]=new qs(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else if(this._renderTarget.length!=e)for(this.disposeAllRenderTarget(),this._renderTarget.length=e,this._renderTarget[0]=null,t=1;t<e;t++)this._renderTarget[t]=new qs(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else for(t=1;t<e;t++)null!=this._renderTarget[t]&&this._renderTarget[t].width==this._shadowMapTextureSize&&this._renderTarget[t].height==this._shadowMapTextureSize||(null!=this._renderTarget[t]&&this._renderTarget[t].destroy(),this._renderTarget[t]=new qs(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728));if(null==this._lightCulling||this._lightCulling.length!=e)for(this._lightCulling?this._lightCulling.length=e:this._lightCulling=w(e),t=0;t<this._lightCulling.length;t++)this._lightCulling[t]=new Ui(R.DEFAULT);if(null==this._lightVPMatrix||this._lightVPMatrix.length!=e)for(this._lightVPMatrix?this._lightVPMatrix.length=e:this._lightVPMatrix=w(e),t=0;t<this._lightVPMatrix.length;t++)this._lightVPMatrix[t]=new R;if(null==this._lightCameras||this._lightCameras.length!=e)for(this._lightCameras?this._lightCameras.length=e:this._lightCameras=w(e),t=0;t<this._lightCameras.length;t++)this._lightCameras[t]=new Rl,this._lightCameras[t].name="lightCamera"+t;if(null==this._shadowQuenes||this._shadowQuenes.length!=this._numberOfPSSM)for(this._shadowQuenes?this._shadowQuenes.length=this._numberOfPSSM:this._shadowQuenes=w(this._numberOfPSSM),t=0;t<this._shadowQuenes.length;t++)this._shadowQuenes[t]=new _t(this._scene);if(null==this._shaderValueVPs||this._shaderValueVPs.length!=e)for(this._shaderValueVPs?this._shaderValueVPs.length=e:this._shaderValueVPs=w(e),this._shaderValueLightVP=new Float32Array(16*e),t=0;t<e;t++)this._shaderValueVPs[t]=new Float32Array(this._shaderValueLightVP.buffer,64*t)},d._calcLightViewProject=function(e){var t=this._boundingSphere[this._currentPSSM],n=e.transform.worldMatrix,i=(t.radius,t.center.cloneTo(this._tempLookAt3),W.transformV3ToV4(this._tempLookAt3,n,this._tempLookAt4),this._tempLookAt3.elements),r=this._tempLookAt4.elements,i=(i[0]=r[0],i[1]=r[1],i[2]=r[2],this._tempLightUp.elements),r=e.forward.elements,e=(i[0]=r[0],i[1]=1,i[2]=r[2],W.normalize(this._tempLightUp,this._tempLightUp),W.scale(this._globalParallelLightDir,4*t.radius,this._tempPos),W.subtract(this._tempLookAt3,this._tempPos,this._tempPos),this._lightCameras[this._currentPSSM]),a=(e.transform.position=this._tempPos,e.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),this._tempMax.elements),o=this._tempMin.elements,s=(a[0]=a[1]=a[2]=-1e5,a[3]=1,o[0]=o[1]=o[2]=1e5,o[3]=1,R.multiply(e.viewMatrix,n,this._tempMatrix44),this._tempValue.elements),l=[];l.length=8,this._boundingBox[this._currentPSSM].getCorners(l);for(var h=0;h<8;h++){var _=l[h].elements;s[0]=_[0],s[1]=_[1],s[2]=_[2],s[3]=1,P.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),o[0]=(s[0]<o[0]?s:o)[0],o[1]=(s[1]<o[1]?s:o)[1],o[2]=(s[2]<o[2]?s:o)[2],a[0]=(s[0]>a[0]?s:a)[0],a[1]=(s[1]>a[1]?s:a)[1],a[2]=(s[2]>a[2]?s:a)[2]}P.add(this._tempMax,this._tempMin,this._tempValue),s[0]*=.5,s[1]*=.5,s[2]*=.5,s[3]=1,P.transformByM4x4(this._tempValue,e.transform.worldMatrix,this._tempValue);i=Math.abs(-this._tempMax.z),r=i>this._maxDistance?i:this._maxDistance,W.scale(this._globalParallelLightDir,r,this._tempPos),t=this._tempPos.elements;t[0]=s[0]-t[0],t[1]=s[1]-t[1],t[2]=s[2]-t[2],e.transform.position=this._tempPos,e.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),R.createOrthoOffCenterRH(o[0],a[0],o[1],a[1],1,r+.5*(a[2]-o[2]),e.projectionMatrix),e.projectionViewMatrix.cloneTo(this._lightVPMatrix[this._currentPSSM]),this._lightCulling[this._currentPSSM].matrix=this._lightVPMatrix[this._currentPSSM],Sr.multiplyMatrixOutFloat32Array(this._tempScaleMatrix44,this._lightVPMatrix[this._currentPSSM],this._shaderValueVPs[this._currentPSSM])},d.getLightFrustumCulling=function(e){return this._lightCulling[e]},d.getSplitFrustumCulling=function(){return this._splitFrustumCulling},d.getSplitDistance=function(e){return this._spiltDistance[e]},d.setShadowMapTextureSize=function(e){e!==this._shadowMapTextureSize&&(this._shadowMapTextureSize=e,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this._statesDirty=!0)},d.getShadowMapTextureSize=function(){return this._shadowMapTextureSize},d.beginRenderTarget=function(e){this._renderTarget[e].start()},d.endRenderTarget=function(e){this._renderTarget[e].end()},d.getRenderTarget=function(e){return this._renderTarget[e]},d.disposeAllRenderTarget=function(){for(var e=0,t=this._numberOfPSSM+1;e<t;e++)this._renderTarget[e]&&(this._renderTarget[e].destroy(),this._renderTarget[e]=null)},n(0,d,"PSSMNum",function(){return this._numberOfPSSM},function(e){this._numberOfPSSM!=(e=(e=0<e?e:1)<=3?e:3)&&(this._numberOfPSSM=e,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0)}),Sr.multiplyMatrixOutFloat32Array=function(e,t,n){for(var i,r,a,o,s=e.elements,l=t.elements,h=0;h<4;h++)i=s[h],r=s[h+4],a=s[h+8],o=s[h+12],n[h]=i*l[0]+r*l[1]+a*l[2]+o*l[3],n[h+4]=i*l[4]+r*l[5]+a*l[6]+o*l[7],n[h+8]=i*l[8]+r*l[9]+a*l[10]+o*l[11],n[h+12]=i*l[12]+r*l[13]+a*l[14]+o*l[15]},Sr.SHADERDEFINE_RECEIVE_SHADOW=1,Sr.SHADERDEFINE_CAST_SHADOW=512,Sr.SHADERDEFINE_SHADOW_PSSM1=1024,Sr.SHADERDEFINE_SHADOW_PSSM2=2048,Sr.SHADERDEFINE_SHADOW_PSSM3=4096,Sr.SHADERDEFINE_SHADOW_PCF_NO=8192,Sr.SHADERDEFINE_SHADOW_PCF1=16384,Sr.SHADERDEFINE_SHADOW_PCF2=32768,Sr.SHADERDEFINE_SHADOW_PCF3=65536,Sr.MAX_PSSM_COUNT=3;var Tr=Sr;function Sr(){this._currentPSSM=-1,this._numberOfPSSM=3,this._maxDistance=200,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0,this._lightCulling=null,this._renderTarget=null,this._lightVPMatrix=null,this._lightCameras=null,this._shadowQuenes=null,this._shadowMapTextureSize=1024,this._scene=null,this._PCFType=0,this._shaderValueLightVP=null,this._shaderValueVPs=null,this._spiltDistance=new Array(4),this._globalParallelLightDir=new W(0,-1,0),this._boundingSphere=new Array(4),this._boundingBox=new Array(4),this._frustumPos=new Array(16),this._uniformDistance=new Array(4),this._logDistance=new Array(4),this._dimension=new Array(4),this._tempLookAt3=new W,this._tempLookAt4=new P,this._tempValue=new P,this._tempPos=new W,this._tempLightUp=new W,this._tempMin=new P,this._tempMax=new P,this._tempMatrix44=new R,this._splitFrustumCulling=new Ui(R.DEFAULT),this._tempScaleMatrix44=new R,this._shadowPCFOffset=new ar(1/1024,1/1024),this._shaderValueDistance=new P;for(var e=0,e=0;e<this._spiltDistance.length;e++)this._spiltDistance[e]=0;for(e=0;e<this._dimension.length;e++)this._dimension[e]=new ar;for(e=0;e<this._frustumPos.length;e++)this._frustumPos[e]=new W;for(e=0;e<this._boundingBox.length;e++)this._boundingBox[e]=new bi(new W,new W);for(e=0;e<this._boundingSphere.length;e++)this._boundingSphere[e]=new Gi(new W,0);R.createScaling(new W(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5}t(S,"laya.d3.terrain.TerrainLeaf"),(d=S.prototype).calcVertextNorml=function(e,t,n,i,r,a){var o=0,s=0,s=-1*S.getHeightFromTerrainHeightData(e-1,t-1,n,i,r);s=(s=(s=(s=(s+=-1*S.getHeightFromTerrainHeightData(e-1,t,n,i,r))+-1*S.getHeightFromTerrainHeightData(e-1,t+1,n,i,r))+ +S.getHeightFromTerrainHeightData(e+1,t-1,n,i,r))+ +S.getHeightFromTerrainHeightData(e+1,t,n,i,r))+ +S.getHeightFromTerrainHeightData(e+1,t+1,n,i,r),o=-1*S.getHeightFromTerrainHeightData(e-1,t-1,n,i,r),o=(o=(o=(o=(o+=-1*S.getHeightFromTerrainHeightData(e,t-1,n,i,r))+-1*S.getHeightFromTerrainHeightData(e+1,t-1,n,i,r))+ +S.getHeightFromTerrainHeightData(e-1,t+1,n,i,r))+ +S.getHeightFromTerrainHeightData(e,t+1,n,i,r))+ +S.getHeightFromTerrainHeightData(e+1,t+1,n,i,r),a.x=-s,a.y=6,a.z=-o,W.normalize(a,a)},d.calcVertextNormlUV=function(e,t,n,i,r){r.x=e/n,r.y=t/i,r.z=t/i},d.calcVertextBuffer=function(e,t,n,i,r,a,o,s,l,h,_,u){1!=u||S.__ADAPT_MATRIX__||(S.__ADAPT_MATRIX__=new R,u=new R,R.createRotationY(Math.PI,S.__ADAPT_MATRIX__),R.createTranslate(new W(0,0,(_-1)*r),u),R.multiply(u,S.__ADAPT_MATRIX__,S.__ADAPT_MATRIX__),S.__ADAPT_MATRIX_INV__=new R,S.__ADAPT_MATRIX__.invert(S.__ADAPT_MATRIX_INV__)),this._gridSize=r,this._beginGridX=e*S.CHUNK_GRID_NUM+n,this._beginGridZ=t*S.CHUNK_GRID_NUM+i;for(var d=o*s,c=2147483647,f=-2147483648,m=new W,p=0,E=S.LEAF_GRID_NUM+1;p<E;p++)for(var g=0,v=S.LEAF_GRID_NUM+1;g<v;g++)S.__VECTOR3__.x=(this._beginGridX+g)*this._gridSize,S.__VECTOR3__.z=(this._beginGridZ+p)*this._gridSize,S.__VECTOR3__.y=l[(this._beginGridZ+p)*h+(this._beginGridX+g)],c=S.__VECTOR3__.y<c?S.__VECTOR3__.y:c,f=S.__VECTOR3__.y>f?S.__VECTOR3__.y:f,S.__ADAPT_MATRIX__&&W.transformV3ToV3(S.__VECTOR3__,S.__ADAPT_MATRIX__,S.__VECTOR3__),a[d]=S.__VECTOR3__.x,a[++d]=S.__VECTOR3__.y,a[++d]=S.__VECTOR3__.z,d++,this.calcVertextNormlUV(this._beginGridX+g,this._beginGridZ+p,h,_,m),a[d]=m.x,a[++d]=m.y,a[++d]=m.z,a[++d]=(n+g)/S.CHUNK_GRID_NUM,a[++d]=(i+p)/S.CHUNK_GRID_NUM,a[++d]=this._beginGridX+g,a[++d]=this._beginGridZ+p,d++;this._sizeOfY=new ar(c-1,f+1),this.calcLODErrors(l,h,_),this.calcOriginalBoudingBoxAndSphere()},d.calcSkirtVertextBuffer=function(e,t,n,i,r,a,o,s,l,h,_){this._gridSize=r,this._beginGridX=e*S.CHUNK_GRID_NUM+n,this._beginGridZ=t*S.CHUNK_GRID_NUM+i;for(var u=o*s,d=0,c=0,f=S.LEAF_GRID_NUM+1,m=new W,p=0,E=0,d=0;d<2;d++)for(c=0;c<f;c++)S.__VECTOR3__.x=(this._beginGridX+c)*this._gridSize,S.__VECTOR3__.y=1==d?l[this._beginGridZ*h+(this._beginGridX+c)]:-this._gridSize,S.__VECTOR3__.z=(this._beginGridZ+0)*this._gridSize,S.__ADAPT_MATRIX__&&W.transformV3ToV3(S.__VECTOR3__,S.__ADAPT_MATRIX__,S.__VECTOR3__),a[u]=S.__VECTOR3__.x,a[++u]=S.__VECTOR3__.y,a[++u]=S.__VECTOR3__.z,u++,p=0==d?this._beginGridZ-1:this._beginGridZ,this.calcVertextNormlUV(this._beginGridX+c,p,h,_,m),a[u]=m.x,a[++u]=m.y,a[++u]=m.z,a[++u]=(n+c)/S.CHUNK_GRID_NUM,a[++u]=(i+0)/S.CHUNK_GRID_NUM,a[++u]=this._beginGridX+c,a[++u]=p,u++;for(d=0;d<2;d++)for(c=0;c<f;c++)S.__VECTOR3__.x=(this._beginGridX+c)*this._gridSize,S.__VECTOR3__.y=0==d?l[(this._beginGridZ+S.LEAF_GRID_NUM)*h+(this._beginGridX+c)]:-this._gridSize,S.__VECTOR3__.z=(this._beginGridZ+S.LEAF_GRID_NUM)*this._gridSize,S.__ADAPT_MATRIX__&&W.transformV3ToV3(S.__VECTOR3__,S.__ADAPT_MATRIX__,S.__VECTOR3__),a[u]=S.__VECTOR3__.x,a[++u]=S.__VECTOR3__.y,a[++u]=S.__VECTOR3__.z,u++,p=0==d?this._beginGridZ+S.LEAF_GRID_NUM:this._beginGridZ+S.LEAF_GRID_NUM+1,this.calcVertextNormlUV(this._beginGridX+c,p,h,_,m),a[u]=m.x,a[++u]=m.y,a[++u]=m.z,a[++u]=(n+c)/S.CHUNK_GRID_NUM,a[++u]=(i+S.LEAF_GRID_NUM)/S.CHUNK_GRID_NUM,a[++u]=this._beginGridX+c,a[++u]=p,u++;for(d=0;d<2;d++)for(c=0;c<f;c++)S.__VECTOR3__.x=(this._beginGridX+0)*this._gridSize,S.__VECTOR3__.y=0==d?l[(this._beginGridZ+c)*h+(this._beginGridX+0)]:-this._gridSize,S.__VECTOR3__.z=(this._beginGridZ+c)*this._gridSize,S.__ADAPT_MATRIX__&&W.transformV3ToV3(S.__VECTOR3__,S.__ADAPT_MATRIX__,S.__VECTOR3__),a[u]=S.__VECTOR3__.x,a[++u]=S.__VECTOR3__.y,a[++u]=S.__VECTOR3__.z,u++,E=0==d?this._beginGridX:this._beginGridX-1,this.calcVertextNormlUV(E,this._beginGridZ+c,h,_,m),a[u]=m.x,a[++u]=m.y,a[++u]=m.z,a[++u]=(n+0)/S.CHUNK_GRID_NUM,a[++u]=(i+c)/S.CHUNK_GRID_NUM,a[++u]=E,a[++u]=this._beginGridZ+c,u++;for(d=0;d<2;d++)for(c=0;c<f;c++)S.__VECTOR3__.x=(this._beginGridX+S.LEAF_GRID_NUM)*this._gridSize,S.__VECTOR3__.y=1==d?l[(this._beginGridZ+c)*h+(this._beginGridX+S.LEAF_GRID_NUM)]:-this._gridSize,S.__VECTOR3__.z=(this._beginGridZ+c)*this._gridSize,S.__ADAPT_MATRIX__&&W.transformV3ToV3(S.__VECTOR3__,S.__ADAPT_MATRIX__,S.__VECTOR3__),a[u]=S.__VECTOR3__.x,a[++u]=S.__VECTOR3__.y,a[++u]=S.__VECTOR3__.z,u++,E=0==d?this._beginGridX+S.LEAF_GRID_NUM+1:this._beginGridX+S.LEAF_GRID_NUM,this.calcVertextNormlUV(E,this._beginGridZ+c,h,_,m),a[u]=m.x,a[++u]=m.y,a[++u]=m.z,a[++u]=(n+S.LEAF_GRID_NUM)/S.CHUNK_GRID_NUM,a[++u]=(i+c)/S.CHUNK_GRID_NUM,a[++u]=E,a[++u]=this._beginGridZ+c,u++},d.calcOriginalBoudingBoxAndSphere=function(){var e=new W(this._beginGridX*this._gridSize,this._sizeOfY.x,this._beginGridZ*this._gridSize),t=new W((this._beginGridX+S.LEAF_GRID_NUM)*this._gridSize,this._sizeOfY.y,(this._beginGridZ+S.LEAF_GRID_NUM)*this._gridSize),n=(S.__ADAPT_MATRIX__&&(W.transformV3ToV3(e,S.__ADAPT_MATRIX__,e),W.transformV3ToV3(t,S.__ADAPT_MATRIX__,t)),this._originalBoundingBox=new bi(e,t),new W),t=(W.subtract(t,e,n),W.scale(n,.5,n),new W);W.add(e,n,t),this._originalBoundingSphere=new Gi(t,W.scalarLength(n)),this._originalBoundingBoxCorners=w(8,null),this._originalBoundingBox.getCorners(this._originalBoundingBoxCorners),this._boundingBox=new bi(new W(-.5,-.5,-.5),new W(.5,.5,.5)),this._boundingSphere=new Gi(new W(0,0,0),1)},d.calcLeafBoudingBox=function(e){for(var t=0;t<8;t++)W.transformCoordinate(this._originalBoundingBoxCorners[t],e,Xr._tempBoundBoxCorners[t]);bi.createfromPoints(Xr._tempBoundBoxCorners,this._boundingBox)},d.calcLeafBoudingSphere=function(e,t){W.transformCoordinate(this._originalBoundingSphere.center,e,this._boundingSphere.center),this._boundingSphere.radius=this._originalBoundingSphere.radius*t},d.calcLODErrors=function(e,t,n){this._LODError=new Float32Array(S._maxLODLevel+1);for(var i=1,r=0,a=S._maxLODLevel+1;r<a;r++){for(var o=0,s=0,l=S.LEAF_GRID_NUM;s<l;s+=i)for(var h=0,_=S.LEAF_GRID_NUM;h<_;h+=i)for(var u=e[(this._beginGridZ+s)*t+(this._beginGridX+h)],d=e[(this._beginGridZ+s)*t+(this._beginGridX+h)+i],c=e[(this._beginGridZ+s+i)*t+(this._beginGridX+h)],f=e[(this._beginGridZ+s+i)*t+(this._beginGridX+h)+i],m=0;m<i;m++)for(var p=m/i,E=0;E<i;E++)var g=E/i,v=e[(this._beginGridZ+s+m)*t+(this._beginGridX+h)+E],g=Math.abs((g+p<=1?u+(d-u)*g+(c-u)*p:f+(c-f)*(1-g)+(d-f)*(1-p))-v),o=Math.max(o,g);i*=2,this._LODError[r]=o}},d.determineLod=function(e,t,n,i){var r=W.distance(e,this._boundingSphere.center),e=S._maxLODLevel;if(!i){if(this._lastDistanceToEye==r)return this._currentLODLevel;this._lastDistanceToEye>r&&(e=this._currentLODLevel)}for(var a=e;1<=a;a--)if(pl.LOD_DISTANCE_FACTOR*this._LODError[a]/r*t<n){this._currentLODLevel=a;break}return this._lastDistanceToEye=r,this._currentLODLevel},S.__init__=function(){if(!S._bInit){for(var e=S.CHUNK_GRID_NUM/S.LEAF_GRID_NUM*(S.CHUNK_GRID_NUM/S.LEAF_GRID_NUM),t=(S._planeLODIndex=w(e),0),n=0,i=0,r=0,a=0,o=0,s=null,l=null,t=0;t<e;t++)S._planeLODIndex[t]=new Array(S._maxLODLevel+1);for(t=0,r=S._maxLODLevel+1;t<r;t++)S._planeLODIndex[0][t]=S.calcPlaneLODIndex(t);for(t=1;t<e;t++)for(o=t*S.LEAF_PLANE_VERTEXT_COUNT,n=0,a=S._maxLODLevel+1;n<a;n++){for(s=S._planeLODIndex[0][n],l=new Uint16Array(s.length),i=0;i<s.length;i++)l[i]=s[i]+o;S._planeLODIndex[t][n]=l}for(S._skirtLODIndex=w(e),t=0;t<e;t++)S._skirtLODIndex[t]=new Array(S._maxLODLevel+1);for(t=0,r=S._maxLODLevel+1;t<r;t++)S._skirtLODIndex[0][t]=S.calcSkirtLODIndex(t);for(t=1;t<e;t++)for(o=t*S.LEAF_SKIRT_VERTEXT_COUNT,n=0,a=S._maxLODLevel+1;n<a;n++){for(s=S._skirtLODIndex[0][n],l=new Uint16Array(s.length),i=0;i<s.length;i++)l[i]=s[i]+o;S._skirtLODIndex[t][n]=l}S._bInit=!0}},S.getPlaneLODIndex=function(e,t){return S._planeLODIndex[e][t]},S.getSkirtLODIndex=function(e,t){return S._skirtLODIndex[e][t]},S.calcPlaneLODIndex=function(e){S._maxLODLevel<e&&(e=S._maxLODLevel);for(var t=S.LEAF_GRID_NUM+1,n=0,i=null,e=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,e),i=new Uint16Array(e*e*6),r=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/e,a=0;a<S.LEAF_GRID_NUM;a+=r)for(var o=0;o<S.LEAF_GRID_NUM;o+=r)i[n]=(a+r)*t+o,i[++n]=a*t+o,i[++n]=a*t+o+r,i[++n]=a*t+o+r,i[++n]=(a+r)*t+o+r,i[++n]=(a+r)*t+o,n++;return i},S.calcSkirtLODIndex=function(e){S._maxLODLevel<e&&(e=S._maxLODLevel);for(var t=S.CHUNK_GRID_NUM/S.LEAF_GRID_NUM*(S.CHUNK_GRID_NUM/S.LEAF_GRID_NUM)*S.LEAF_PLANE_VERTEXT_COUNT,n=S.LEAF_GRID_NUM+1,i=0,r=null,e=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,e),r=new Uint16Array(4*e*6),a=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/e,o=0;o<4;o++){for(var s=0;s<S.LEAF_GRID_NUM;s+=a)r[i]=t+n+s,r[++i]=t+s,r[++i]=t+s+a,r[++i]=t+s+a,r[++i]=t+n+s+a,r[++i]=t+n+s,i++;t+=2*n}return r},S.getHeightFromTerrainHeightData=function(e,t,n,i,r){return n[(t=r<=(t=t<0?0:t)?r-1:t)*i+(e=i<=(e=e<0?0:e)?i-1:e)]},S.CHUNK_GRID_NUM=64,S.LEAF_GRID_NUM=32,S.__ADAPT_MATRIX__=null,S.__ADAPT_MATRIX_INV__=null,S._planeLODIndex=null,S._skirtLODIndex=null,S._bInit=!1,e(S,["LEAF_PLANE_VERTEXT_COUNT",function(){return this.LEAF_PLANE_VERTEXT_COUNT=(S.LEAF_GRID_NUM+1)*(S.LEAF_GRID_NUM+1)},"LEAF_SKIRT_VERTEXT_COUNT",function(){return this.LEAF_SKIRT_VERTEXT_COUNT=2*(S.LEAF_GRID_NUM+1)*4},"LEAF_VERTEXT_COUNT",function(){return this.LEAF_VERTEXT_COUNT=S.LEAF_PLANE_VERTEXT_COUNT+S.LEAF_SKIRT_VERTEXT_COUNT},"LEAF_PLANE_MAX_INDEX_COUNT",function(){return this.LEAF_PLANE_MAX_INDEX_COUNT=S.LEAF_GRID_NUM*S.LEAF_GRID_NUM*6},"LEAF_SKIRT_MAX_INDEX_COUNT",function(){return this.LEAF_SKIRT_MAX_INDEX_COUNT=4*S.LEAF_GRID_NUM*6},"LEAF_MAX_INDEX_COUNT",function(){return this.LEAF_MAX_INDEX_COUNT=S.LEAF_PLANE_MAX_INDEX_COUNT+S.LEAF_SKIRT_MAX_INDEX_COUNT},"__VECTOR3__",function(){return this.__VECTOR3__=new W},"_maxLODLevel",function(){return this._maxLODLevel=Math.log2(S.LEAF_GRID_NUM)}]);var Dr=S;function S(){this._boundingSphere=null,this._boundingBox=null,this._sizeOfY=null,this._currentLODLevel=0,this._lastDistanceToEye=NaN,this._originalBoundingSphere=null,this._originalBoundingBox=null,this._originalBoundingBoxCorners=null,this._bUseStrip=!1,this._gridSize=NaN,this._beginGridX=0,this._beginGridZ=0,this._LODError=null,S.__init__(),this._currentLODLevel=0}t(Mr,"laya.d3.terrain.unit.ChunkInfo");var xr=Mr;function Mr(){this.alphaMap=null,this.detailID=null,this.normalMap=null}t(Ir,"laya.d3.terrain.unit.DetailTextureInfo");var Rr=Ir;function Ir(){this.diffuseTexture=null,this.normalTexture=null,this.scale=null,this.offset=null}t(Cr,"laya.d3.terrain.unit.MaterialInfo");var Ar=Cr;function Cr(){this.ambientColor=null,this.diffuseColor=null,this.specularColor=null}t(Or,"laya.d3.utils.Physics"),Or.__init__=function(){Or._layerCollsionMatrix.length=31;for(var e=0;e<31;e++){var t=[],n=31-e;t.length=n;for(var i=0;i<n;i++)t[i]=i===n-1;Or._layerCollsionMatrix[e]=t}},Or.setLayerCollision=function(e,t,n){Or._layerCollsionMatrix[e.number][30-t.number]=n},Or.getLayerCollision=function(e,t){return Or._layerCollsionMatrix[e.number][30-t.number]},Or.setColliderCollision=function(e,t,n){n?(delete e._ignoreCollisonMap[t.id],delete t._ignoreCollisonMap[e.id]):(e._ignoreCollisonMap[t.id]=t)._ignoreCollisonMap[e.id]=e},Or.getIColliderCollision=function(e,t){return!!e._ignoreCollisonMap[t.id]},Or.rayCast=function(e,t,n,i){void 0===n&&(n=179e306),void 0===i&&(i=0),Or._outHitAllInfo.length=0;for(var r=Se.getLayerByNumber(i)._colliders,a=0,o=r.length;a<o;a++){var s=r[a];s.enable&&(s.raycast(e,Or._outHitInfo,n),-1!==Or._outHitInfo.distance)&&Or._outHitInfo.distance<=n&&(s=new Lr,Or._outHitInfo.cloneTo(s),Or._outHitAllInfo.push(s))}if(0==Or._outHitAllInfo.length)t.sprite3D=null,t.distance=-1;else{for(var l=Number.MAX_VALUE,h=0,_=0;_<Or._outHitAllInfo.length;_++)Or._outHitAllInfo[_].distance<l&&(l=Or._outHitAllInfo[_].distance,h=_);Or._outHitAllInfo[h].cloneTo(t)}},Or.rayCastAll=function(e,t,n,i){void 0===n&&(n=179e306),void 0===i&&(i=0),t.length=0;for(var r=Se.getLayerByNumber(i)._colliders,a=0,o=r.length;a<o;a++){var s=r[a];s.enable&&(Or._outHitInfo.distance=-1,Or._outHitInfo.sprite3D=null,s.raycast(e,Or._outHitInfo,n),-1!==Or._outHitInfo.distance)&&Or._outHitInfo.distance<=n&&(s=new Lr,Or._outHitInfo.cloneTo(s),t.push(s))}},Or._outHitAllInfo=[],Or._layerCollsionMatrix=[],e(Or,["_outHitInfo",function(){return this._outHitInfo=new Lr},"collisionManager",function(){return this.collisionManager=new qr},"gravity",function(){return this.gravity=new W(0,-9.81,0)}]);var yr=Or;function Or(){}t(Vr,"laya.d3.utils.Picker"),Vr.calculateCursorRay=function(e,t,n,i,r,a){var o=e.elements[0],e=e.elements[1],s=Vr._tempVector30,l=s.elements,l=(l[0]=o,l[1]=e,l[2]=t.minDepth,Vr._tempVector31),h=l.elements,o=(h[0]=o,h[1]=e,h[2]=t.maxDepth,a.origin),e=Vr._tempVector32,h=(t.unprojectFromWVP(s,n,i,r,o),t.unprojectFromWVP(l,n,i,r,e),a.direction.elements);h[0]=e.x-o.x,h[1]=e.y-o.y,h[2]=e.z-o.z,W.normalize(a.direction,a.direction)},Vr.rayIntersectsPositionsAndIndices=function(e,t,n,i,r){for(var a,o,s,l,h=n.vertexStride/4,_=n.getVertexElementByUsage(0).offset/4,u=Number.MAX_VALUE,d=-1,c=-1,f=-1,m=0;m<i.length;m+=3){var p=Vr._tempVector35,E=p.elements,g=i[m]*h,v=g+_,E=(E[0]=t[v],E[1]=t[1+v],E[2]=t[2+v],Vr._tempVector36),v=E.elements,T=i[m+1]*h,S=T+_,v=(v[0]=t[S],v[1]=t[1+S],v[2]=t[2+S],Vr._tempVector37),S=v.elements,D=i[m+2]*h,x=D+_,S=(S[0]=t[x],S[1]=t[1+x],S[2]=t[2+x],laya.d3.utils.Picker.rayIntersectsTriangle(e,p,E,v));!isNaN(S)&&S<u&&(u=S,d=g,c=T,f=D)}return u!==Number.MAX_VALUE?(r.distance=u,W.scale(e.direction,u,r.position),W.add(e.origin,r.position,r.position),a=(s=r.trianglePositions)[0],l=s[1],s=s[2],a=a.elements,l=l.elements,s=s.elements,a[0]=t[o=d+_],a[1]=t[o+1],a[2]=t[o+2],l[0]=t[a=c+_],l[1]=t[a+1],l[2]=t[a+2],s[0]=t[o=f+_],s[1]=t[o+1],s[2]=t[o+2],(l=n.getVertexElementByUsage(3))&&(a=l.offset/4,o=(s=r.triangleNormals)[0],n=s[1],l=s[2],s=o.elements,o=n.elements,n=l.elements,s[0]=t[l=d+a],s[1]=t[l+1],s[2]=t[l+2],o[0]=t[s=c+a],o[1]=t[s+1],o[2]=t[s+2],n[0]=t[l=f+a],n[1]=t[l+1],n[2]=t[l+2]),!0):(r.position.toDefault(),r.distance=Number.MAX_VALUE,r.trianglePositions[0].toDefault(),r.trianglePositions[1].toDefault(),r.trianglePositions[2].toDefault(),r.triangleNormals[0].toDefault(),r.triangleNormals[1].toDefault(),r.triangleNormals[2].toDefault(),!1)},Vr.rayIntersectsTriangle=function(e,t,n,i){var r=Vr._tempVector30,a=Vr._tempVector31,n=(W.subtract(n,t,r),W.subtract(i,t,a),Vr._tempVector32);return W.cross(e.direction,a,n),(i=W.dot(r,n))>-Number.MIN_VALUE&&i<Number.MIN_VALUE||(i=1/i,W.subtract(e.origin,t,t=Vr._tempVector33),n=W.dot(t,n),(n*=i)<0)||1<n||(W.cross(t,r,t=Vr._tempVector34),r=W.dot(e.direction,t),(r*=i)<0)||1<n+r||(e=W.dot(a,t),(e*=i)<0)?Number.NaN:e},e(Vr,["_tempVector30",function(){return this._tempVector30=new W},"_tempVector31",function(){return this._tempVector31=new W},"_tempVector32",function(){return this._tempVector32=new W},"_tempVector33",function(){return this._tempVector33=new W},"_tempVector34",function(){return this._tempVector34=new W},"_tempVector35",function(){return this._tempVector35=new W},"_tempVector36",function(){return this._tempVector36=new W},"_tempVector37",function(){return this._tempVector37=new W}]);var Nr=Vr;function Vr(){}t(wr,"laya.d3.utils.RaycastHit"),wr.prototype.cloneTo=function(e){e.distance=this.distance,this.trianglePositions[0].cloneTo(e.trianglePositions[0]),this.trianglePositions[1].cloneTo(e.trianglePositions[1]),this.trianglePositions[2].cloneTo(e.trianglePositions[2]),this.triangleNormals[0].cloneTo(e.triangleNormals[0]),this.triangleNormals[1].cloneTo(e.triangleNormals[1]),this.triangleNormals[2].cloneTo(e.triangleNormals[2]),this.position.cloneTo(e.position),e.sprite3D=this.sprite3D};var Lr=wr;function wr(){this.distance=NaN,this.trianglePositions=null,this.triangleNormals=null,this.position=null,this.sprite3D=null,this.distance=-1,this.trianglePositions=[new W,new W,new W],this.trianglePositions.length=3,this.triangleNormals=[new W,new W,new W],this.triangleNormals.length=3,this.position=new W}t(Pr,"laya.d3.utils.Size"),n(0,d=Pr.prototype,"width",function(){return-1===this._width?dt.clientWidth:this._width}),n(0,d,"height",function(){return-1===this._height?dt.clientHeight:this._height}),n(1,Pr,"fullScreen",function(){return new Pr(-1,-1)});var Fr=Pr;function Pr(e,t){this._width=0,this._height=0,this._width=e,this._height=t}t(Br,"laya.d3.utils.Utils3D"),Br._rotationTransformScaleSkinAnimation=function(e,t,n,i,r,a,o,s,l,h,_,u){var d,c,f,m,p,E=Br._tempArray16_0,g=Br._tempArray16_1,v=Br._tempArray16_2,T=i+i,S=r+r,D=a+a,i=i*T,x=r*T,r=r*S,M=a*T,R=a*S,a=a*D,T=o*T,S=o*S,o=o*D;for(E[15]=1,E[0]=1-r-a,E[1]=x+o,E[2]=M-S,E[4]=x-o,E[5]=1-i-a,E[6]=R+T,E[8]=M+S,E[9]=R-T,E[10]=1-i-r,g[15]=1,g[0]=s,g[5]=l,g[10]=h,d=0;d<4;d++)c=E[d],f=E[d+4],m=E[d+8],p=E[d+12],v[d]=c,v[d+4]=f,v[d+8]=m,v[d+12]=c*e+f*t+m*n+p;for(d=0;d<4;d++)c=v[d],f=v[d+4],m=v[d+8],p=v[d+12],_[d+u]=c*g[0]+f*g[1]+m*g[2]+p*g[3],_[d+u+4]=c*g[4]+f*g[5]+m*g[6]+p*g[7],_[d+u+8]=c*g[8]+f*g[9]+m*g[10]+p*g[11],_[d+u+12]=c*g[12]+f*g[13]+m*g[14]+p*g[15]},Br._createNodeByJson=function(e,t,n,i){if(!n)switch(t.type){case"Sprite3D":n=new Uo;break;case"MeshSprite3D":n=new Fl;break;case"SkinnedMeshSprite3D":n=new Ul;break;case"ShuriKenParticle3D":n=new V;break;case"TrailSprite3D":n=new Wl;break;case"Terrain":n=new pl;break;case"Camera":n=new Rl;break;case"DirectionLight":n=new Ol;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var r=t.props;if(r)for(var a in r)n[a]=r[a];var o=t.customProps,s=(o&&(n instanceof laya.d3.core.Sprite3D?(n._parseBaseCustomProps(o),n._parseCustomProps(e,i,o,t),n._parseCustomComponent(e,i,t.components)):n._parseCustomProps(e,i,o,t)),t.child);if(s)for(var l=0,h=s.length;l<h;l++){var _=Br._createNodeByJson(e,s[l],null,i);n.addChild(_)}return n},Br._computeBoneAndAnimationDatasByBindPoseMatrxix=function(e,t,n,i,r,a){for(var o,s=0,l=0,h=e.length,_=0;_<h;s+=e[_].keyframeWidth,l+=16,_++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[s+0],t[s+1],t[s+2],t[s+3],t[s+4],t[s+5],t[s+6],t[s+7],t[s+8],t[s+9],i,l),0!=_&&(o=16*e[_].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,o,i,l,i,l));var u=n.length;for(_=0;_<u;_++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,16*a[_],n[_],r,16*_)},Br._computeAnimationDatasByArrayAndMatrixFast=function(e,t,n,i){for(var r=0,a=e.length;r<a;r++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(t,16*i[r],e[r],n,16*r)},Br._computeBoneAndAnimationDatasByBindPoseMatrxixOld=function(e,t,n,i,r){for(var a,o=0,s=0,l=e.length,h=0;h<l;o+=e[h].keyframeWidth,s+=16,h++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[o+7],t[o+8],t[o+9],t[o+3],t[o+4],t[o+5],t[o+6],t[o+0],t[o+1],t[o+2],i,s),0!=h&&(a=16*e[h].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,a,i,s,i,s));var _=n.length;for(h=0;h<_;h++){var u=16*h;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,u,n[h],r,u)}},Br._computeAnimationDatasByArrayAndMatrixFastOld=function(e,t,n){for(var i=e.length,r=0;r<i;r++){var a=16*r;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(t,a,e[r],n,a)}},Br._computeRootAnimationData=function(e,t,n){for(var i=0,r=0,a=0,o=e.length;i<o;r+=e[i].keyframeWidth,a+=16,i++)laya.d3.utils.Utils3D.createAffineTransformationArray(t[r+0],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5],t[r+6],t[r+7],t[r+8],t[r+9],n,a)},Br.transformVector3ArrayByQuat=function(e,t,n,i,r){var n=n.elements,a=e[t],o=e[t+1],e=e[t+2],t=n[0],s=n[1],l=n[2],n=n[3],h=n*a+s*e-l*o,_=n*o+l*a-t*e,u=n*e+t*o-s*a,a=-t*a-s*o-l*e;i[r]=h*n+a*-t+_*-l-u*-s,i[r+1]=_*n+a*-s+u*-t-h*-l,i[r+2]=u*n+a*-l+h*-s-_*-t},Br.mulMatrixByArray=function(e,t,n,i,r,a){var o,s,l,h,_;if(r===n){for(n=Br._tempArray16_3,o=0;o<16;++o)n[o]=r[a+o];i=0}for(o=0;o<4;o++)s=e[t+o],l=e[t+o+4],h=e[t+o+8],_=e[t+o+12],r[a+o]=s*n[i+0]+l*n[i+1]+h*n[i+2]+_*n[i+3],r[a+o+4]=s*n[i+4]+l*n[i+5]+h*n[i+6]+_*n[i+7],r[a+o+8]=s*n[i+8]+l*n[i+9]+h*n[i+10]+_*n[i+11],r[a+o+12]=s*n[i+12]+l*n[i+13]+h*n[i+14]+_*n[i+15]},Br.mulMatrixByArrayFast=function(e,t,n,i,r,a){for(var o,s,l,h,_=0;_<4;_++)o=e[t+_],s=e[t+_+4],l=e[t+_+8],h=e[t+_+12],r[a+_]=o*n[i+0]+s*n[i+1]+l*n[i+2]+h*n[i+3],r[a+_+4]=o*n[i+4]+s*n[i+5]+l*n[i+6]+h*n[i+7],r[a+_+8]=o*n[i+8]+s*n[i+9]+l*n[i+10]+h*n[i+11],r[a+_+12]=o*n[i+12]+s*n[i+13]+l*n[i+14]+h*n[i+15]},Br.mulMatrixByArrayAndMatrixFast=function(e,t,n,i,r){for(var a,o,s,l,n=n.elements,h=n[0],_=n[1],u=n[2],d=n[3],c=n[4],f=n[5],m=n[6],p=n[7],E=n[8],g=n[9],v=n[10],T=n[11],S=n[12],D=n[13],x=n[14],M=n[15],R=t,I=t+4,A=t+8,C=t+12,y=r,O=r+4,N=r+8,V=r+12,L=0;L<4;L++)a=e[R+L],o=e[I+L],s=e[A+L],l=e[C+L],i[y+L]=a*h+o*_+s*u+l*d,i[O+L]=a*c+o*f+s*m+l*p,i[N+L]=a*E+o*g+s*v+l*T,i[V+L]=a*S+o*D+s*x+l*M},Br.createAffineTransformationArray=function(e,t,n,i,r,a,o,s,l,h,_,u){var d=i+i,c=r+r,f=a+a,m=i*d,p=i*c,i=i*f,E=r*c,r=r*f,a=a*f,d=o*d,c=o*c,o=o*f;_[u+0]=(1-(E+a))*s,_[u+1]=(p+o)*s,_[u+2]=(i-c)*s,_[u+3]=0,_[u+4]=(p-o)*l,_[u+5]=(1-(m+a))*l,_[u+6]=(r+d)*l,_[u+7]=0,_[u+8]=(i+c)*h,_[u+9]=(r-d)*h,_[u+10]=(1-(m+E))*h,_[u+11]=0,_[u+12]=e,_[u+13]=t,_[u+14]=n,_[u+15]=1},Br.transformVector3ArrayToVector3ArrayCoordinate=function(e,t,n,i,r){var a=Br._tempArray4_0,o=e[t+0],s=e[t+1],e=e[t+2],t=n.elements;a[0]=o*t[0]+s*t[4]+e*t[8]+t[12],a[1]=o*t[1]+s*t[5]+e*t[9]+t[13],a[2]=o*t[2]+s*t[6]+e*t[10]+t[14],a[3]=1/(o*t[3]+s*t[7]+e*t[11]+t[15]),i[r+0]=a[0]*a[3],i[r+1]=a[1]*a[3],i[r+2]=a[2]*a[3]},Br.transformLightingMapTexcoordByUV0Array=function(e,t,n,i,r){n=n.elements;i[r+0]=e[t+0]*n[0]+n[2],i[r+1]=(e[t+1]-1)*n[1]+n[3]},Br.transformLightingMapTexcoordByUV1Array=function(e,t,n,i,r){n=n.elements;i[r+0]=e[t+0]*n[0]+n[2],i[r+1]=1+e[t+1]*n[1]+n[3]},Br.getURLVerion=function(e){var t=e.indexOf("?");return 0<=t?e.substr(t):null},Br._quaternionCreateFromYawPitchRollArray=function(e,t,n,i){var n=.5*n,t=.5*t,e=.5*e,r=Math.sin(n),n=Math.cos(n),a=Math.sin(t),t=Math.cos(t),o=Math.sin(e),e=Math.cos(e);i[0]=e*a*n+o*t*r,i[1]=o*t*n-e*a*r,i[2]=e*t*r-o*a*n,i[3]=e*t*n+o*a*r},Br._createAffineTransformationArray=function(e,t,n,i){var r=t[0],a=t[1],o=t[2],t=t[3],s=r+r,l=a+a,h=o+o,_=r*s,u=r*l,r=r*h,d=a*l,a=a*h,o=o*h,s=t*s,l=t*l,t=t*h,h=n[0],c=n[1],n=n[2];i[0]=(1-(d+o))*h,i[1]=(u+t)*h,i[2]=(r-l)*h,i[3]=0,i[4]=(u-t)*c,i[5]=(1-(_+o))*c,i[6]=(a+s)*c,i[7]=0,i[8]=(r+l)*n,i[9]=(a-s)*n,i[10]=(1-(_+d))*n,i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1},Br._mulMatrixArray=function(e,t,n,i){for(var r,a,o,s,t=t.elements,l=t[0],h=t[1],_=t[2],u=t[3],d=t[4],c=t[5],f=t[6],m=t[7],p=t[8],E=t[9],g=t[10],v=t[11],T=t[12],S=t[13],D=t[14],x=t[15],M=i,R=i+4,I=i+8,A=i+12,C=0;C<4;C++)r=e[C],a=e[C+4],o=e[C+8],s=e[C+12],n[M+C]=r*l+a*h+o*_+s*u,n[R+C]=r*d+a*c+o*f+s*m,n[I+C]=r*p+a*E+o*g+s*v,n[A+C]=r*T+a*S+o*D+s*x},Br.getYawPitchRoll=function(e,t){Br.transformQuat(W.ForwardRH,e,$i.TEMPVector31),Br.transformQuat(W.Up,e,$i.TEMPVector32);var e=$i.TEMPVector32.elements,n=(Br.angleTo(W.ZERO,$i.TEMPVector31,$i.TEMPVector33),$i.TEMPVector33.elements);n[0]==Math.PI/2?(n[1]=Br.arcTanAngle(e[2],e[0]),n[2]=0):n[0]==-Math.PI/2?(n[1]=Br.arcTanAngle(-e[2],-e[0]),n[2]=0):(R.createRotationY(-n[1],$i.TEMPMatrix0),R.createRotationX(-n[0],$i.TEMPMatrix1),W.transformCoordinate($i.TEMPVector32,$i.TEMPMatrix0,$i.TEMPVector32),W.transformCoordinate($i.TEMPVector32,$i.TEMPMatrix1,$i.TEMPVector32),n[2]=Br.arcTanAngle(e[1],-e[0])),n[1]<=-Math.PI&&(n[1]=Math.PI),n[2]<=-Math.PI&&(n[2]=Math.PI),n[1]>=Math.PI&&n[2]>=Math.PI&&(n[1]=0,n[2]=0,n[0]=Math.PI-n[0]),t[0]=n[1],t[1]=n[0],t[2]=n[2]},Br.arcTanAngle=function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:0<e?Math.atan(t/e):e<0?0<t?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0},Br.angleTo=function(e,t,n){W.subtract(t,e,$i.TEMPVector30),W.normalize($i.TEMPVector30,$i.TEMPVector30),n.elements[0]=Math.asin($i.TEMPVector30.y),n.elements[1]=Br.arcTanAngle(-$i.TEMPVector30.z,-$i.TEMPVector30.x)},Br.transformQuat=function(e,t,n){var n=n.elements,e=e.elements,i=e[0],r=e[1],e=e[2],a=t[0],o=t[1],s=t[2],t=t[3],l=t*i+o*e-s*r,h=t*r+s*i-a*e,_=t*e+a*r-o*i,i=-a*i-o*r-s*e;n[0]=l*t+i*-a+h*-s-_*-o,n[1]=h*t+i*-o+_*-a-l*-s,n[2]=_*t+i*-s+l*-o-h*-a},Br.quaterionNormalize=function(e,t){var n=e[0],i=e[1],r=e[2],e=e[3],a=n*n+i*i+r*r+e*e;0<a&&(a=1/Math.sqrt(a),t[0]=n*a,t[1]=i*a,t[2]=r*a,t[3]=e*a)},Br.matrix4x4MultiplyFFF=function(e,t,n){var i,r,a,o,s;if(n===t)for(t=new Float32Array(16),i=0;i<16;++i)t[i]=n[i];for(i=0;i<4;i++)r=e[i],a=e[i+4],o=e[i+8],s=e[i+12],n[i]=r*t[0]+a*t[1]+o*t[2]+s*t[3],n[i+4]=r*t[4]+a*t[5]+o*t[6]+s*t[7],n[i+8]=r*t[8]+a*t[9]+o*t[10]+s*t[11],n[i+12]=r*t[12]+a*t[13]+o*t[14]+s*t[15]},Br.matrix4x4MultiplyMFM=function(e,t,n){Br.matrix4x4MultiplyFFF(e.elements,t,n.elements)},e(Br,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}},"_tempVector3_0",function(){return this._tempVector3_0=new W},"_tempVector3_1",function(){return this._tempVector3_1=new W},"_tempVector3_2",function(){return this._tempVector3_2=new W},"_tempVector3_3",function(){return this._tempVector3_3=new W},"_tempVector3_4",function(){return this._tempVector3_4=new W},"_tempVector3_5",function(){return this._tempVector3_5=new W},"_tempVector3_6",function(){return this._tempVector3_6=new W},"_tempArray4_0",function(){return this._tempArray4_0=new Float32Array(4)},"_tempArray16_0",function(){return this._tempArray16_0=new Float32Array(16)},"_tempArray16_1",function(){return this._tempArray16_1=new Float32Array(16)},"_tempArray16_2",function(){return this._tempArray16_2=new Float32Array(16)},"_tempArray16_3",function(){return this._tempArray16_3=new Float32Array(16)}]);var br=Br;function Br(){}t(I,"Laya3D"),I._cancelLoadByUrl=function(e){v.loader.cancelLoadByUrl(e),I._innerFirstLevelLoaderManager.cancelLoadByUrl(e),I._innerSecondLevelLoaderManager.cancelLoadByUrl(e),I._innerThirdLevelLoaderManager.cancelLoadByUrl(e),I._innerFourthLevelLoaderManager.cancelLoadByUrl(e)},I._changeWebGLSize=function(e,t){c.onStageResize(e,t),dt.clientWidth=e,dt.clientHeight=t},I.__init__=function(){var e=q.createMap;e.lh=[Uo,"SPRITE3DHIERARCHY"],e.ls=[bo,"SPRITE3DHIERARCHY"],e.lm=[js,"MESH"],e.lmat=[as,"MATERIAL"],e.lpbr=[$o,"MATERIAL"],e.ltc=[rl,"TEXTURECUBE"],e.jpg=[nl,"nativeimage"],e.jpeg=[nl,"nativeimage"],e.png=[nl,"nativeimage"],e.pkm=[nl,"arraybuffer"],e.lsani=[B,"arraybuffer"],e.lrani=[B,"arraybuffer"],e.raw=[Xs,"arraybuffer"],e.mipmaps=[Xs,"arraybuffer"],e.thdata=[ba,"arraybuffer"],e.lt=[Ua,"TERRAIN"],e.lani=[Aa,"arraybuffer"],e.lav=[ya,"json"],e.ani=[B,"arraybuffer"],K.parserMap.SPRITE3DHIERARCHY=I._loadHierarchy,K.parserMap.MESH=I._loadMesh,K.parserMap.MATERIAL=I._loadMaterial,K.parserMap.TEXTURECUBE=I._loadTextureCube,K.parserMap.TERRAIN=I._loadTerrain,I._innerFirstLevelLoaderManager.on("error",null,I._eventLoadManagerError),I._innerSecondLevelLoaderManager.on("error",null,I._eventLoadManagerError),I._innerThirdLevelLoaderManager.on("error",null,I._eventLoadManagerError),I._innerFourthLevelLoaderManager.on("error",null,I._eventLoadManagerError)},I.READ_BLOCK=function(){return I._readData.pos+=4,!0},I.READ_DATA=function(){return I._DATA.offset=I._readData.getUint32(),I._DATA.size=I._readData.getUint32(),!0},I.READ_STRINGS=function(){var e=[],t={offset:0,size:0};t.offset=I._readData.getUint16(),t.size=I._readData.getUint16(),I._readData.pos;I._readData.pos=t.offset+I._DATA.offset;for(var n=0;n<t.size;n++){var i=I._readData.readUTFString();-1===i.lastIndexOf(".lmat")&&-1===i.lastIndexOf(".lpbr")||e.push(i)}return e},I.formatRelativePath=function(e,t){var n;if("."===t.charAt(0)){for(var i,r=(e+t).split("/"),a=0,o=r.length;a<o;a++)".."==r[a]&&0<(i=a-1)&&".."!==r[i]&&(r.splice(i,2),a-=2);n=r.join("/")}else n=e+t;return n=null!=re.customFormat?re.customFormat(n,null):n},I._eventLoadManagerError=function(e){v.loader.event("error",e)},I._addHierarchyInnerUrls=function(e,t,n,i,r,a){i=I.formatRelativePath(i,r);n&&(i+=n),e.push({url:i,clas:a}),t[r]=i},I._getSprite3DHierarchyInnerUrls=function(e,t,n,i,r,a,o){var s=0,l=0;switch(e.type){case"Scene":for(var h=e.customProps.lightmaps,s=0,l=h.length;s<l;s++){var _=h[s].replace(".exr",".png");I._addHierarchyInnerUrls(i,r,a,o,_,nl)}break;case"MeshSprite3D":case"TrailSprite3D":case"LineSprite3D":case"SkinnedMeshSprite3D":if(e.instanceParams)(p=e.instanceParams.loadPath)&&I._addHierarchyInnerUrls(t,r,a,o,p,js);else{(p=(m=e.customProps).meshPath)&&I._addHierarchyInnerUrls(t,r,a,o,p,js);var u=m.materials;if(u)for(s=0,l=u.length;s<l;s++){var d=u[s],c=d.type.split("."),f=z.window;if(c.forEach(function(e){f=f[e]}),"function"!=typeof f)throw"_getSprite3DHierarchyInnerUrls 错误: "+d.type+" 不是类";I._addHierarchyInnerUrls(n,r,a,o,d.path,f)}}break;case"ShuriKenParticle3D":var m,p=(m=e.customProps).meshPath,p=(p&&I._addHierarchyInnerUrls(t,r,a,o,p,js),m.material);p?(c=p.type.split("."),f=z.window,c.forEach(function(e){f=f[e]}),I._addHierarchyInnerUrls(n,r,a,o,p.path,f)):(p=m.materialPath)?I._addHierarchyInnerUrls(n,r,a,o,p,ms):(p=m.texturePath)&&I._addHierarchyInnerUrls(i,r,a,o,p,nl);break;case"Terrain":I._addHierarchyInnerUrls(i,r,a,o,e.customProps.dataPath,Ua)}var E,g=e.components;for(E in g){var v=g[E];if("Animator"===E){var T=v.avatarPath,S=(T?I._addHierarchyInnerUrls(i,r,a,o,T,ya):(T=v.avatar)&&I._addHierarchyInnerUrls(i,r,a,o,T.path,ya),v.clipPaths);for(s=0,l=S.length;s<l;s++)I._addHierarchyInnerUrls(i,r,a,o,S[s],Aa)}}var D=e.child;for(s=0,l=D.length;s<l;s++)I._getSprite3DHierarchyInnerUrls(D[s],t,n,i,r,a,o)},I._loadHierarchy=function(e){e.on("loaded",null,I._onHierarchylhLoaded,[e,e._class._getGroup()]),e.load(e.url,"json",!1,null,!0)},I._onHierarchylhLoaded=function(e,t,n){var i,r,a,o,s,l,h,_;e._class.destroyed?e.endLoad():(s=e.url,_=br.getURLVerion(s),s=re.getPath(s),I._getSprite3DHierarchyInnerUrls(n,i=[],r=[],a=[],o={},_,s),I._onProcessChange(e,0,l=1/(s=(_=i.length+r.length+a.length)+1),1),0<a.length?(_=j.create(null,I._onProcessChange,[e,l,h=_/s],!1),I._innerFourthLevelLoaderManager.create(a,j.create(null,I._onHierarchyInnerForthLevResouLoaded,[e,t,_,n,o,i,r,l+h*a.length,h]),_,null,null,1,!0,t)):I._onHierarchyInnerForthLevResouLoaded(e,t,null,n,o,i,r,l,h))},I._onHierarchyInnerForthLevResouLoaded=function(e,t,n,i,r,a,o,s,l){var h;e._class.destroyed?e.endLoad():(n&&n.recover(),0<o.length?(h=j.create(null,I._onProcessChange,[e,s,l],!1),I._innerSecondLevelLoaderManager.create(o,j.create(null,I._onHierarchyInnerSecondLevResouLoaded,[e,t,h,i,r,a,s+l*o.length,l]),n,null,null,1,!0,t)):I._onHierarchyInnerSecondLevResouLoaded(e,t,null,i,r,a,s,l))},I._onHierarchyInnerSecondLevResouLoaded=function(e,t,n,i,r,a,o,s){e._class.destroyed?e.endLoad():(n&&n.recover(),0<a.length?(o=j.create(null,I._onProcessChange,[e,o,s],!1),I._innerFirstLevelLoaderManager.create(a,j.create(null,I._onHierarchyInnerFirstLevResouLoaded,[e,o,i,r]),n,null,null,1,!0,t)):I._onHierarchyInnerFirstLevResouLoaded(e,null,i,r))},I._onHierarchyInnerFirstLevResouLoaded=function(e,t,n,i){t&&t.recover(),e.endLoad([n,i])},I._loadTerrain=function(e){e.on("loaded",null,I._onTerrainLtLoaded,[e,e._class._getGroup()]),e.load(e.url,"json",!1,null,!0)},I._onTerrainLtLoaded=function(e,t,n){if(e._class.destroyed)e.endLoad();else{for(var i=e.url,r=br.getURLVerion(i),a=re.getPath(i),o=[],s={},l=0,h=0,i=n.heightData,_=i.url,u=(m=I.formatRelativePath(a,_),r&&(m+=r),_=s[_]=m,n.detailTexture),l=0,h=u.length;l<h;l++)o.push({url:u[l].diffuse});var d=n.normalMap;for(l=0,h=d.length;l<h;l++)o.push({url:d[l]});var c=n.alphaMap;for(l=0,h=c.length;l<h;l++)o.push({url:c[l],params:[!1,!1,6408,!0]});for(l=0,h=o.length;l<h;l++){var f=o[l].url,m=I.formatRelativePath(a,f);r&&(m+=r),o[l].url=m,s[f]=m}var p=o.length,E=p+2,g=1/E,v=(I._onProcessChange(e,0,g,1),{heightMapLoaded:!1,texturesLoaded:!1}),T=j.create(null,I._onProcessChange,[e,g,g],!1),_=(I._innerFourthLevelLoaderManager.create(_,j.create(null,I._onTerrainHeightMapLoaded,[e,T,n,s,v]),T,null,[i.numX,i.numZ,i.bitType,i.value],1,!0,t),j.create(null,I._onProcessChange,[e,2*g,p/E],!1));I._innerFourthLevelLoaderManager.create(o,j.create(null,I._onTerrainTexturesLoaded,[e,_,n,s,v]),_,null,null,1,!0,t)}},I._onTerrainHeightMapLoaded=function(e,t,n,i,r){r.heightMapLoaded=!0,r.texturesLoaded&&(e.endLoad([n,i]),t.recover())},I._onTerrainTexturesLoaded=function(e,t,n,i,r){r.texturesLoaded=!0,r.heightMapLoaded&&(e.endLoad([n,i]),t.recover())},I._loadMesh=function(e){e.on("loaded",null,I._onMeshLmLoaded,[e,e._class._getGroup()]),e.load(e.url,"arraybuffer",!1,null,!0)},I._onMeshLmLoaded=function(e,t,n){if(e._class.destroyed)e.endLoad();else{var i,r,a=e.url,o=br.getURLVerion(a),s=re.getPath(a),l={},h=0;switch((I._readData=new X(n)).pos=0,I._readData.readUTFString()){case"LAYAMODEL:02":case"LAYAMODEL:03":case"LAYAMODEL:0301":var _=I._readData.getUint32(),u=(I._readData.pos=I._readData.pos+4,d=I._readData.getUint16(),I._readData.pos=I._readData.pos+8*d,I._readData.getUint32()),d=I._readData.getUint16();for(I._readData.pos=_+u,i=[],h=0;h<d;h++){var c=I._readData.readUTFString();-1!==c.lastIndexOf(".lmat")&&i.push(c)}break;default:for(I.READ_BLOCK(),h=0;h<2;h++){var f=I._readData.getUint16(),m=I._strings[f],p=I["READ_"+m];if(null==p)throw new Error("model file err,no this function:"+f+" "+m);1===h?i=p.call():p.call()}}for(h=0,r=i.length;h<r;h++){var E=i[h],g=I.formatRelativePath(s,E);o&&(g+=o),i[h]=g,l[E]=g}0<i.length?(I._onProcessChange(e,0,.5,1),a=j.create(null,I._onProcessChange,[e,.5,.5],!1),I._innerSecondLevelLoaderManager.create(i,j.create(null,I._onMeshMateialLoaded,[e,a,n,l]),a,null,null,1,!0,t)):e.endLoad([n,l])}},I._onMeshMateialLoaded=function(e,t,n,i){e.endLoad([n,i]),t.recover()},I._getMaterialTexturePath=function(e,t,n){var i=e.length-4;return e.indexOf(".dds")!=i&&e.indexOf(".tga")!=i&&e.indexOf(".exr")!=i&&e.indexOf(".DDS")!=i&&e.indexOf(".TGA")!=i&&e.indexOf(".EXR")!=i||(e=e.substr(0,i)+".png"),e=I.formatRelativePath(n,e),t&&(e+=t),e},I._loadMaterial=function(e){e.on("loaded",null,I._onMaterilLmatLoaded,[e,e._class._getGroup()]),e.load(e.url,"json",!1,null,!0)},I._onMaterilLmatLoaded=function(e,t,n){if(e._class.destroyed)e.endLoad();else{var i,r=e.url,a=br.getURLVerion(r),o=re.getPath(r),s=[],l={},r=n.customProps,h=n.version;if(h)switch(h){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":for(var _=n.props.textures,u=0,d=_.length;u<d;u++){var c,f=_[u],m=f.path;m&&(c=m.length-4,m.indexOf(".exr")!=c&&m.indexOf(".EXR")!=c||(m=m.substr(0,c)+".png"),i=I.formatRelativePath(o,m),a&&(i+=a),s.push({url:i,params:f.params}),l[m]=i)}break;default:throw new Error("Laya3D:unkonwn version.")}else{var h=r.diffuseTexture.texture2D;h&&(i=I._getMaterialTexturePath(h,a,o),s.push(i),l[h]=i),r.normalTexture&&(h=r.normalTexture.texture2D)&&(i=I._getMaterialTexturePath(h,a,o),s.push(i),l[h]=i),r.specularTexture&&(h=r.specularTexture.texture2D)&&(i=I._getMaterialTexturePath(h,a,o),s.push(i),l[h]=i),r.emissiveTexture&&(h=r.emissiveTexture.texture2D)&&(i=I._getMaterialTexturePath(h,a,o),s.push(i),l[h]=i),r.ambientTexture&&(h=r.ambientTexture.texture2D)&&(i=I._getMaterialTexturePath(h,a,o),s.push(i),l[h]=i),r.reflectTexture&&(h=r.reflectTexture.texture2D)&&(i=I._getMaterialTexturePath(h,a,o),s.push(i),l[h]=i)}var r=s.length,h=r+1,p=1/h;I._onProcessChange(e,0,p,1),0<r?(p=j.create(null,I._onProcessChange,[e,p,r/h],!1),I._innerFourthLevelLoaderManager.create(s,j.create(null,I._onMateialTexturesLoaded,[e,p,n,l]),p,nl,null,1,!0,t)):I._onMateialTexturesLoaded(e,null,n,null)}},I._onMateialTexturesLoaded=function(e,t,n,i){e.endLoad([n,i]),t&&t.recover()},I._loadTextureCube=function(e){e.on("loaded",null,I._onTextureCubeLtcLoaded,[e]),e.load(e.url,"json",!1,null,!0)},I._onTextureCubeLtcLoaded=function(e,t){var n;e._class.destroyed?e.endLoad():(n=re.getPath(e.url),n=[I.formatRelativePath(n,t.px),I.formatRelativePath(n,t.nx),I.formatRelativePath(n,t.py),I.formatRelativePath(n,t.ny),I.formatRelativePath(n,t.pz),I.formatRelativePath(n,t.nz)],I._onProcessChange(e,0,1/7,1),t=j.create(null,I._onProcessChange,[e,1/7,6/7],!1),I._innerFourthLevelLoaderManager.load(n,j.create(null,I._onTextureCubeImagesLoaded,[e,n,t]),t,"nativeimage"))},I._onTextureCubeImagesLoaded=function(e,t,n){var i=[];i.length=6;for(var r=0;r<6;r++){var a=t[r];i[r]=K.getRes(a),K.clearRes(a)}e.endLoad(i),n.recover()},I._onProcessChange=function(e,t,n,i){(i=t+i*n)<1&&e.event("progress",i)},I.init=function(e,t,n,i,r,a){void 0===n&&(n=!1),void 0===i&&(i=!1),void 0===r&&(r=!0),void 0===a&&(a=!0),I._isinit||(I._isinit=!0,te.update3DLoop=function(){qr._triggerCollision()},te.cancelLoadByUrl=function(e){I._cancelLoadByUrl(e)},Z.isAntialias=n,Z.isAlpha=i,Z.premultipliedAlpha=r,Z.isStencil=a,c.enable()?(te.changeWebGLSize=I._changeWebGLSize,J.is3DMode=!0,v.init(e,t),Se.__init__(),yr.__init__(),ko.__init__(),pr.__init__(),Fl.__init__(),de.__init__(),I.__init__(),H.maxTextureCount=2,(I.debugMode||ft.debugMode)&&(I._debugPhasorSprite=new ot)):alert("Laya3D init error,must support webGL!"))},I.HIERARCHY="SPRITE3DHIERARCHY",I.MESH="MESH",I.MATERIAL="MATERIAL",I.PBRMATERIAL="PBRMTL",I.TEXTURECUBE="TEXTURECUBE",I.TERRAIN="TERRAIN",I._readData=null,I._debugPhasorSprite=null,I.debugMode=!1,I._isinit=!1,e(I,["_DATA",function(){return this._DATA={offset:0,size:0}},"_strings",function(){return this._strings=["BLOCK","DATA","STRINGS"]},"_innerFirstLevelLoaderManager",function(){return this._innerFirstLevelLoaderManager=new q},"_innerSecondLevelLoaderManager",function(){return this._innerSecondLevelLoaderManager=new q},"_innerThirdLevelLoaderManager",function(){return this._innerThirdLevelLoaderManager=new q},"_innerFourthLevelLoaderManager",function(){return this._innerFourthLevelLoaderManager=new q}]);var Ur=I;function I(){}t(Gr,"laya.d3.animation.AnimationTransform3D",i),(d=Gr.prototype)._getlocalMatrix=function(){return this._localUpdate&&(br._createAffineTransformationArray(this._localPosition,this._localRotation,this._localScale,this._localMatrix),this._localUpdate=!1),this._localMatrix},d._onWorldTransform=function(){if(!this._worldUpdate){this._worldUpdate=!0;for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldTransform()}},d._setWorldMatrixAndUpdate=function(e){if(this._worldMatrix=e,null==this._parent)throw new Error("don't need to set worldMatrix to root Node.");if(null==this._parent._parent)for(var t=this._getlocalMatrix(),n=0;n<16;++n)this._worldMatrix[n]=t[n];else br.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);this._worldUpdate=!1},d._setWorldMatrixNoUpdate=function(e){this._worldMatrix=e},d._setWorldMatrixIgnoreUpdate=function(e){this._worldMatrix=e,this._worldUpdate=!1},d.getLocalPosition=function(){return this._localPosition},d.setLocalPosition=function(e){var t,n,i;this._parent?(this._localPosition=e,this._localUpdate=!0,this._onWorldTransform()):(t=this._entity.owner._transform,(i=(n=this._entity.localPosition).elements)[0]=e[0],i[1]=e[1],i[2]=e[2],t.localPosition=n)},d.getLocalRotation=function(){var e;return this._localQuaternionUpdate&&(e=this._localRotationEuler,br._quaternionCreateFromYawPitchRollArray(e[1]/Gr._angleToRandin,e[0]/Gr._angleToRandin,e[2]/Gr._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1),this._localRotation},d.setLocalRotation=function(e){var t,n,i;this._parent?(this._localRotation=e,br.quaterionNormalize(this._localRotation,this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform()):(t=this._entity.owner._transform,(i=(n=this._entity.localRotation).elements)[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],t.localRotation=n)},d.getLocalScale=function(){return this._localScale},d.setLocalScale=function(e){var t,n,i;this._parent?(this._localScale=e,this._localUpdate=!0,this._onWorldTransform()):(t=this._entity.owner._transform,(i=(n=this._entity.localScale).elements)[0]=e[0],i[1]=e[1],i[2]=e[2],t.localScale=n)},d.getLocalRotationEuler=function(){var e,t;return this._locaEulerlUpdate&&(br.getYawPitchRoll(this._localRotation,Gr._tempVector3),(t=this._localRotationEuler)[0]=(e=Gr._tempVector3)[1]*Gr._angleToRandin,t[1]=e[0]*Gr._angleToRandin,t[2]=e[2]*Gr._angleToRandin,this._locaEulerlUpdate=!1),this._localRotationEuler},d.setLocalRotationEuler=function(e){var t,n,i;this._parent?(br._quaternionCreateFromYawPitchRollArray(e[1]/Gr._angleToRandin,e[0]/Gr._angleToRandin,e[2]/Gr._angleToRandin,this._localRotation),this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform()):(t=this._entity.owner._transform,(i=(n=this._entity.localRotationEuler).elements)[0]=e[0],i[1]=e[1],i[2]=e[2],t.localRotationEuler=n)},d.getWorldMatrix=function(){if(this._worldUpdate){if(null!=this._parent._parent)br.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else for(var e=this._getlocalMatrix(),t=0;t<16;++t)this._worldMatrix[t]=e[t];this._worldUpdate=!1}return this._worldMatrix},d.setParent=function(e){var t,n;this._parent!==e&&(this._parent&&(n=(t=this._parent._childs).indexOf(this),t.splice(n,1)),e&&(e._childs.push(this),e)&&this._onWorldTransform(),this._parent=e)},e(Gr,["_tempVector3",function(){return this._tempVector3=new Float32Array(3)},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI}]);var Hr=Gr;function Gr(e){Gr.__super.call(this),this._owner=e,this._childs=[],this._localMatrix=new Float32Array(16),this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0}t(zr,"laya.d3.component.Component3D",i),d=zr.prototype,v.imps(d,{"laya.d3.core.render.IUpdate":!0,"laya.resource.IDestroy":!0}),d._initialize=function(e){this._owner=e,this._enable=!0,this.started=!1,this._load(e)},d._destroy=function(){this._unload(this._owner),this._owner=null,this._destroyed=!0},d._load=function(e){},d._start=function(e){},d._update=function(e){},d._lateUpdate=function(e){},d._preRenderUpdate=function(e){},d._postRenderUpdate=function(e){},d._unload=function(e){this.offAll()},d._cloneTo=function(e){},n(0,d,"id",function(){return this._id}),n(0,d,"destroyed",function(){return this._destroyed}),n(0,d,"owner",function(){return this._owner}),n(0,d,"enable",function(){return this._enable},function(e){this._enable!==e&&(this._enable=e,this.event("enablechanged",this._enable))}),n(0,d,"isSingleton",function(){return zr._isSingleton}),zr._isSingleton=!0,zr._uniqueIDCounter=1;var d=zr;function zr(){this._destroyed=!1,this._id=0,this._enable=!1,this._owner=null,this.started=!1,zr.__super.call(this),this._destroyed=!1,this._id=zr._uniqueIDCounter,zr._uniqueIDCounter++}t(kr,"laya.d3.core.GeometryFilter",i),D=kr.prototype,v.imps(D,{"laya.resource.IDestroy":!0}),D._destroy=function(){this.offAll(),this._destroyed=!0},n(0,D,"_isAsyncLoaded",function(){return!0}),n(0,D,"_originalBoundingBoxCorners",function(){throw new Error("BaseRender: must override it.")}),n(0,D,"_originalBoundingSphere",function(){throw new Error("BaseRender: must override it.")}),n(0,D,"_originalBoundingBox",function(){throw new Error("BaseRender: must override it.")}),n(0,D,"destroyed",function(){return this._destroyed});var Wr=kr;function kr(){this._destroyed=!1,kr.__super.call(this),this._destroyed=!1}t(Yr,"laya.d3.core.render.BaseRender",i),D=Yr.prototype,v.imps(D,{"laya.resource.IDestroy":!0}),D._changeMaterialReference=function(e,t){e&&e._removeReference(),t._addReference()},D._getInstanceMaterial=function(e,t){var n=new e.constructor;return e.cloneTo(n),n.name=n.name+"(Instance)",this._materialsInstance[t]=!0,this._changeMaterialReference(this._materials[t],n),this._materials[t]=n},D._setShaderValuelightMap=function(e){this._setShaderValueTexture(3,e)},D._onWorldMatNeedChange=function(){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0},D._renderRenderableBoundBox=function(){var e=Ur._debugPhasorSprite,t=this.boundingBox,n=Yr._tempBoundBoxCorners;t.getCorners(n),e.line(n[0],Yr._greenColor,n[1],Yr._greenColor),e.line(n[2],Yr._greenColor,n[3],Yr._greenColor),e.line(n[4],Yr._greenColor,n[5],Yr._greenColor),e.line(n[6],Yr._greenColor,n[7],Yr._greenColor),e.line(n[0],Yr._greenColor,n[3],Yr._greenColor),e.line(n[1],Yr._greenColor,n[2],Yr._greenColor),e.line(n[2],Yr._greenColor,n[6],Yr._greenColor),e.line(n[3],Yr._greenColor,n[7],Yr._greenColor),e.line(n[0],Yr._greenColor,n[4],Yr._greenColor),e.line(n[1],Yr._greenColor,n[5],Yr._greenColor),e.line(n[4],Yr._greenColor,n[7],Yr._greenColor),e.line(n[5],Yr._greenColor,n[6],Yr._greenColor)},D._calculateBoundingSphere=function(){throw"BaseRender: must override it."},D._calculateBoundingBox=function(){throw"BaseRender: must override it."},D._setShaderValueTexture=function(e,t){this._owner._shaderValues.setValue(e,t)},D._setShaderValueMatrix4x4=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},D._setShaderValueColor=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},D._setShaderValueBuffer=function(e,t){this._owner._shaderValues.setValue(e,t)},D._setShaderValueInt=function(e,t){this._owner._shaderValues.setValue(e,t)},D._setShaderValueBool=function(e,t){this._owner._shaderValues.setValue(e,t)},D._setShaderValueNumber=function(e,t){this._owner._shaderValues.setValue(e,t)},D._setShaderValueVector2=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},D._addShaderDefine=function(e){this._owner._shaderDefineValue|=e},D._removeShaderDefine=function(e){this._owner._shaderDefineValue&=~e},D._renderUpdate=function(e){return!0},D._applyLightMapParams=function(){var e;0<=this._lightmapIndex&&(e=this._owner.scene)&&(e=e.getlightmaps()[this._lightmapIndex])?(this._addShaderDefine(cl.SAHDERDEFINE_LIGHTMAP),e.loaded?this._setShaderValuelightMap(e):e.once("loaded",this,this._setShaderValuelightMap)):this._removeShaderDefine(cl.SAHDERDEFINE_LIGHTMAP)},D._updateOctreeNode=function(){var e=this._treeNode;e&&this._octreeNodeNeedChange&&(e.updateObject(this),this._octreeNodeNeedChange=!1)},D._destroy=function(){this.offAll();for(var e=0,t=0,e=0,t=this._renderElements.length;e<t;e++)this._renderElements[e]._destroy();for(e=0,t=this._materials.length;e<t;e++)this._materials[e]._removeReference();this._renderElements=null,this._owner=null,this._materials=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphere=null,this._lightmapScaleOffset=null,this._destroyed=!0},n(0,D,"boundingSphere",function(){return this._boundingSphereNeedChange&&(this._calculateBoundingSphere(),this._boundingSphereNeedChange=!1),this._boundingSphere}),n(0,D,"id",function(){return this._id}),n(0,D,"material",function(){var e=this._materials[0];return e&&!this._materialsInstance[0]&&(e=this._getInstanceMaterial(e,0),this.event("materialchanged",[this,0,e])),this._materials[0]},function(e){this.sharedMaterial=e}),n(0,D,"sharedMaterial",function(){return this._materials[0]},function(e){var t=this._materials[0];t!==e&&(this._materials[0]=e,this._materialsInstance[0]=!1,this._changeMaterialReference(t,e),this.event("materialchanged",[this,0,e]))}),n(0,D,"lightmapIndex",function(){return this._lightmapIndex},function(e){this._lightmapIndex=e,this._applyLightMapParams()}),n(0,D,"lightmapScaleOffset",function(){return this._lightmapScaleOffset},function(e){this._lightmapScaleOffset=e,this._setShaderValueColor(2,e),this._addShaderDefine(cl.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV)}),n(0,D,"enable",function(){return this._enable},function(e){this._enable=e,this.event("enablechanged",[this,e])}),n(0,D,"materials",function(){for(var e,t=0,n=this._materials.length;t<n;t++)this._materialsInstance[t]||(e=this._getInstanceMaterial(this._materials[t],t),this.event("materialchanged",[this,t,e]));return this._materials.slice()},function(e){this.sharedMaterials=e}),n(0,D,"sharedMaterials",function(){return this._materials.slice()},function(e){if(!e)throw new Error("MeshRender: shadredMaterials value can't be null.");var t=e.length;this._materialsInstance.length=t;for(var n=0;n<t;n++){var i=this._materials[n];i!==e[n]&&(this._materialsInstance[n]=!1,this._changeMaterialReference(i,e[n]),this.event("materialchanged",[this,n,e[n]]))}this._materials=e}),n(0,D,"boundingBox",function(){return this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox}),n(0,D,"boundingBoxCenter",function(){var e;return this._boundingBoxCenterNeedChange&&(e=this.boundingBox,W.add(e.min,e.max,this._boundingBoxCenter),W.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenterNeedChange=!1),this._boundingBoxCenter}),n(0,D,"receiveShadow",function(){return this._receiveShadow},function(e){this._receiveShadow!==e&&((this._receiveShadow=e)?this._addShaderDefine(Tr.SHADERDEFINE_RECEIVE_SHADOW):this._removeShaderDefine(Tr.SHADERDEFINE_RECEIVE_SHADOW))}),n(0,D,"destroyed",function(){return this._destroyed}),Yr._uniqueIDCounter=0,e(Yr,["_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new W,new W,new W,new W,new W,new W,new W,new W]},"_greenColor",function(){return this._greenColor=new P(0,1,0,1)}]);var Xr=Yr;function Yr(e){Yr.__super.call(this),this._id=++Yr._uniqueIDCounter,this._indexInSceneFrustumCullingObjects=-1,this._boundingBox=new bi(new W,new W),this._boundingBoxCenter=new W,this._boundingSphere=new Gi(new W,0),this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0,this._materials=[],this._renderElements=[],this._isPartOfStaticBatch=!1,this._destroyed=!1,this._owner=e,this._enable=!0,this._materialsInstance=[],this.lightmapIndex=-1,this.castShadow=!1,this.receiveShadow=!1,this.sortingFudge=0,this._owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatNeedChange)}t(jr,"laya.d3.core.Transform3D",i),(D=jr.prototype)._updateLocalMatrix=function(){var e,t,n,i;!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?R.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix):(W.multiply(this.pivot,this._localScale,i=jr._tempVector30),W.subtract(i,this.pivot,e=jr._tempVector31),n=this.localRotation,W.transformQuat(i,n,t=jr._tempVector32),W.subtract(t,i,t),W.subtract(this._localPosition,e,i=jr._tempVector33),W.subtract(i,t,i),R.createAffineTransformation(i,n,this._localScale,this._localMatrix))},D._onWorldPositionRotationTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._rotationUpdate){this._worldUpdate=this._positionUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionRotationTransform()}},D._onWorldPositionScaleTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._scaleUpdate){this._worldUpdate=this._positionUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionScaleTransform()}},D._onWorldPositionTransform=function(){if(!this._worldUpdate||!this._positionUpdate){this._worldUpdate=this._positionUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionTransform()}},D._onWorldRotationTransform=function(){if(!this._worldUpdate||!this._rotationUpdate){this._worldUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionRotationTransform()}},D._onWorldScaleTransform=function(){if(!this._worldUpdate||!this._scaleUpdate){this._worldUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionScaleTransform()}},D._onWorldTransform=function(){if(!(this._worldUpdate&&this._positionUpdate&&this._rotationUpdate&&this._scaleUpdate)){this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldTransform()}},D.translate=function(e,t){(t=void 0===t?!0:t)?(R.createFromQuaternion(this.localRotation,jr._tempMatrix0),W.transformCoordinate(e,jr._tempMatrix0,jr._tempVector30),W.add(this.localPosition,jr._tempVector30,this._localPosition),this.localPosition=this._localPosition):(W.add(this.position,e,this._position),this.position=this._position)},D.rotate=function(e,t,n){void 0===t&&(t=!0),n=(n=void 0===n?!0:n)?e:(W.scale(e,Math.PI/180,jr._tempVector30),jr._tempVector30),$i.createFromYawPitchRoll(n.y,n.x,n.z,jr._tempQuaternion0),t?($i.multiply(this._localRotation,jr._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):($i.multiply(jr._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},D.lookAt=function(e,t,n){var i,r=e.elements;(n=void 0===n?!1:n)?(i=this._localPosition.elements,Math.abs(i[0]-r[0])<M.zeroTolerance&&Math.abs(i[1]-r[1])<M.zeroTolerance&&Math.abs(i[2]-r[2])<M.zeroTolerance||($i.lookAt(this._localPosition,e,t,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation)):(i=(n=this.position).elements,Math.abs(i[0]-r[0])<M.zeroTolerance&&Math.abs(i[1]-r[1])<M.zeroTolerance&&Math.abs(i[2]-r[2])<M.zeroTolerance||($i.lookAt(n,e,t,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation))},n(0,D,"_isFrontFaceInvert",function(){var e=this.scale,t=e.x<0;return e.y<0&&(t=!t),t=e.z<0?!t:t}),n(0,D,"owner",function(){return this._owner}),n(0,D,"localRotation",function(){var e;return this._localQuaternionUpdate&&(e=this._localRotationEuler.elements,$i.createFromYawPitchRoll(e[1]/jr._angleToRandin,e[0]/jr._angleToRandin,e[2]/jr._angleToRandin,this._localRotation)),this._localRotation},function(e){this._localRotation=e,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),n(0,D,"worldMatrix",function(){return this._worldUpdate&&(null!=this._parent?R.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1),this._worldMatrix},function(e){null===this._parent?e.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),R.multiply(this._localMatrix,e,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix=e,this._worldUpdate=!1}),n(0,D,"worldNeedUpdate",function(){return this._worldUpdate}),n(0,D,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(e){this._localMatrix=e,this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._localUpdate=!1,this._onWorldTransform()}),n(0,D,"dummy",function(){return this._dummy},function(e){this._dummy!==e&&(this._dummy&&(this._dummy._entity=null),e&&(e._entity=this),this._dummy=e)}),n(0,D,"localPosition",function(){return this._localPosition},function(e){this._localPosition=e,this._localUpdate=!0,this._onWorldPositionTransform()}),n(0,D,"position",function(){var e;return this._positionUpdate&&(null!=this._parent?(e=this._parent.position,W.multiply(this._localPosition,this._parent.scale,jr._tempVector30),W.transformQuat(jr._tempVector30,this._parent.rotation,jr._tempVector30),W.add(e,jr._tempVector30,this._position)):this._localPosition.cloneTo(this._position),this._positionUpdate=!1),this._position},function(e){var t,n,i,r,a;null!=this._parent?(W.subtract(e,this._parent.position,this._localPosition),t=(i=this._parent.scale.elements)[0],n=i[1],i=i[2],1===t&&1===n&&1===i||((a=(r=jr._tempVector30).elements)[0]=1/t,a[1]=1/n,a[2]=1/i,W.multiply(this._localPosition,r,this._localPosition)),this._parent.rotation.invert(jr._tempQuaternion0),W.transformQuat(this._localPosition,jr._tempQuaternion0,this._localPosition)):e.cloneTo(this._localPosition),this.localPosition=this._localPosition,this._position=e,this._positionUpdate=!1}),n(0,D,"localScale",function(){return this._localScale},function(e){this._localScale=e,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldScaleTransform():this._onWorldPositionScaleTransform()}),n(0,D,"localRotationEuler",function(){var e,t;return this._locaEulerlUpdate&&(this._localRotation.getYawPitchRoll(jr._tempVector30),e=jr._tempVector30.elements,(t=this._localRotationEuler.elements)[0]=e[1]*jr._angleToRandin,t[1]=e[0]*jr._angleToRandin,t[2]=e[2]*jr._angleToRandin),this._localRotationEuler},function(e){this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),n(0,D,"rotation",function(){return this._rotationUpdate&&(null!=this._parent?$i.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._rotationUpdate=!1),this._rotation},function(e){null!=this._parent?(this._parent.rotation.invert(jr._tempQuaternion0),$i.multiply(e,jr._tempQuaternion0,this._localRotation)):e.cloneTo(this._localRotation),this.localRotation=this._localRotation,this._rotation=e,this._rotationUpdate=!1}),n(0,D,"scale",function(){return this._scaleUpdate&&(null!==this._parent?W.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scaleUpdate=!1),this._scale},function(e){var t,n;null!==this._parent?(t=this._parent.scale.elements,(n=jr._tempVector30.elements)[0]=1/t[0],n[1]=1/t[1],n[2]=1/t[2],W.multiply(e,jr._tempVector30,this._localScale)):e.cloneTo(this._localScale),this.localScale=this._localScale,this._scale=e,this._scaleUpdate=!1}),n(0,D,"rotationEuler",null,function(e){$i.createFromYawPitchRoll(e.y,e.x,e.z,this._rotation),this.rotation=this._rotation}),n(0,D,"forward",function(){var e=this.worldMatrix.elements;return this._forward.elements[0]=-e[8],this._forward.elements[1]=-e[9],this._forward.elements[2]=-e[10],this._forward}),n(0,D,"up",function(){var e=this.worldMatrix.elements;return this._up.elements[0]=e[4],this._up.elements[1]=e[5],this._up.elements[2]=e[6],this._up}),n(0,D,"right",function(){var e=this.worldMatrix.elements;return this._right.elements[0]=e[0],this._right.elements[1]=e[1],this._right.elements[2]=e[2],this._right}),n(0,D,"parent",function(){return this._parent},function(e){var t,n;this._parent!==e&&(this._parent&&(n=(t=this._parent._childs).indexOf(this),t.splice(n,1)),e&&(e._childs.push(this),e)&&this._onWorldTransform(),this._parent=e)}),e(jr,["_tempVector30",function(){return this._tempVector30=new W},"_tempVector31",function(){return this._tempVector31=new W},"_tempVector32",function(){return this._tempVector32=new W},"_tempVector33",function(){return this._tempVector33=new W},"_tempQuaternion0",function(){return this._tempQuaternion0=new $i},"_tempMatrix0",function(){return this._tempMatrix0=new R},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI}]);var Zr=jr;function jr(e){this._owner=null,this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this._parent=null,this._childs=null,this._dummy=null,this.pivot=null,jr.__super.call(this),this._localPosition=new W,this._localRotation=new $i(0,0,0,1),this._localScale=new W(1,1,1),this._localRotationEuler=new W,this._localMatrix=new R,this._position=new W,this._rotation=new $i(0,0,0,1),this._scale=new W(1,1,1),this._worldMatrix=new R,this._forward=new W,this._up=new W,this._right=new W,this._owner=e,this._childs=[]}t(Kr,"laya.d3.core.TransformUV",i),D=Kr.prototype,v.imps(D,{"laya.d3.core.IClone":!0}),D._updateMatrix=function(){Kr._tempOffsetV3.elements[0]=this._offset.x,Kr._tempOffsetV3.elements[1]=this._offset.y,$i.createFromYawPitchRoll(0,0,this._rotation,Kr._tempRotationQua),Kr._tempTitlingV3.elements[0]=this._tiling.x,Kr._tempTitlingV3.elements[1]=this._tiling.y,R.createAffineTransformation(Kr._tempOffsetV3,Kr._tempRotationQua,Kr._tempTitlingV3,this._matrix)},D.cloneTo=function(e){e._matrix=this._matrix.clone(),e._offset=this._offset.clone(),e._rotation=this._rotation,e._tiling=this._tiling.clone()},D.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,D,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),n(0,D,"tiling",function(){return this._tiling},function(e){this._tiling=e,this._matNeedUpdte=!0}),n(0,D,"offset",function(){return this._offset},function(e){this._offset=e,this._matNeedUpdte=!0}),n(0,D,"rotation",function(){return this._rotation},function(e){this._rotation=e,this._matNeedUpdte=!0}),e(Kr,["_tempOffsetV3",function(){return this._tempOffsetV3=new W(0,0,0)},"_tempRotationQua",function(){return this._tempRotationQua=new $i},"_tempTitlingV3",function(){return this._tempTitlingV3=new W(1,1,1)}]);function Kr(){this._rotation=0,this._matNeedUpdte=!1,Kr.__super.call(this),this._matrix=new R,this._offset=new ar,this._tiling=new ar(1,1)}t(Qr,"laya.d3.utils.CollisionManager",i),Qr._onTrigger=function(e,t,n,i,r){var a=0,o=0,s=e.id,l=t.id;if(!e._ignoreCollisonMap[l]){var h=yr.collisionManager,_=e._runtimeCollisonTestMap[l];if(null!=_)if(_)if(e._collisonTo(t))if(e._runtimeCollisonMap[l]){for(a=0,o=n.length;a<o;a++)n[a].onTriggerStay(t);for(a=0,o=i.length;a<o;a++)i[a].onTriggerStay(e);h.event("triggerstay",[e,t])}else{for(e._runtimeCollisonMap[l]=t,e._runtimeCollisonTestMap[l]=!1,t._runtimeCollisonMap[s]=e,r&&(t._runtimeCollisonTestMap[s]=!1),a=0,o=n.length;a<o;a++)n[a].onTriggerEnter(t);for(a=0,o=i.length;a<o;a++)i[a].onTriggerEnter(e);h.event("triggerenter",[e,t])}else{_=e._runtimeCollisonMap;if(_[l]){for(delete _[l],delete e._runtimeCollisonTestMap[l],delete t._runtimeCollisonMap[s],r&&delete t._runtimeCollisonTestMap[s],a=0,o=n.length;a<o;a++)n[a].onTriggerExit(t);for(a=0,o=i.length;a<o;a++)i[a].onTriggerExit(e);h.event("triggerexit",[e,t])}}else{for(a=0,o=n.length;a<o;a++)n[a].onTriggerStay(t);for(a=0,o=i.length;a<o;a++)i[a].onTriggerStay(e);h.event("triggerstay",[e,t])}else if(e._collisonTo(t)){for(e._runtimeCollisonMap[l]=t,e._runtimeCollisonTestMap[l]=!1,t._runtimeCollisonMap[s]=e,r&&(t._runtimeCollisonTestMap[s]=!1),a=0,o=n.length;a<o;a++)n[a].onTriggerEnter(t);for(a=0,o=i.length;a<o;a++)i[a].onTriggerEnter(e);h.event("triggerenter",[e,t])}}},Qr._triggerCollision=function(){for(var e=Se._collsionTestList,t=e.length,n=yr._layerCollsionMatrix,i=0;i<t;i++)for(var r=e[i],a=Se.getLayerByNumber(r),o=a._colliders,s=a._nonRigidbodyOffset,l=t-1;i<=l;l--){var h=e[l];if(n[r][30-h]){var _,u,d,c,f=0,m=0,p=0,E=Se.getLayerByNumber(h),g=E._colliders,v=E._nonRigidbodyOffset;if(a!==E){for(f=0;f<s;f++)if((u=o[f]).enable){for(c=u.owner._scripts,m=0,p=v;m<p;m++)(d=g[m]).enable&&Qr._onTrigger(u,d,c,d.owner._scripts,!0);for(m=v,p=g.length;m<p;m++)(d=g[m]).enable&&Qr._onTrigger(u,d,c,d.owner._scripts,!1)}for(f=s,_=o.length;f<_;f++)if((u=o[f]).enable)for(c=u.owner._scripts,m=0,p=E._nonRigidbodyOffset;m<p;m++)(d=g[m]).enable&&Qr._onTrigger(d,u,c,d.owner._scripts,!1)}else for(f=0;f<s;f++)if((u=o[f]).enable){for(c=u.owner._scripts,m=f+1,p=s;m<p;m++)(d=g[m]).enable&&Qr._onTrigger(u,d,c,d.owner._scripts,!0);for(m=s,p=o.length;m<p;m++)(d=g[m]).enable&&Qr._onTrigger(u,d,c,d.owner._scripts,!1)}}}};var qr=Qr;function Qr(){Qr.__super.call(this)}var $r;t(Jr,"laya.d3.core.glitter.SplineCurvePosition",$r=Ee),(D=Jr.prototype)._CalcVelocity=function(e,t,n){W.subtract(e,t,n),W.scale(n,.5,n)},D.Init=function(e,t,n,i){this._CalcVelocity(t,e,this._tempVector30),this._CalcVelocity(i,n,this._tempVector31),$r.prototype.Init.call(this,t,this._tempVector30,i,this._tempVector31)};function Jr(){Jr.__super.call(this)}t(na,"laya.d3.core.particleShuriKen.module.shape.BoxShape",ea=s),(i=na.prototype)._getShapeBoundBox=function(e){var t=e.min.elements,t=(t[0]=.5*-this.x,t[1]=.5*-this.y,t[2]=.5*-this.z,e.max.elements);t[0]=.5*this.x,t[1]=.5*this.y,t[2]=.5*this.z},i._getSpeedBoundBox=function(e){var t=e.min.elements,t=(t[0]=0,t[1]=0,t[2]=0,e.max.elements);t[0]=0,t[1]=1,t[2]=0},i.generatePositionAndDirection=function(e,t,n,i){var r=e.elements,a=t.elements;n?(n.seed=i[16],Ke._randomPointInsideHalfUnitBox(e,n),i[16]=n.seed):Ke._randomPointInsideHalfUnitBox(e),r[0]=this.x*r[0],r[1]=this.y*r[1],r[2]=this.z*r[2],this.randomDirection?n?(n.seed=i[17],Ke._randomPointUnitSphere(t,n),i[17]=n.seed):Ke._randomPointUnitSphere(t):(a[0]=0,a[1]=0,a[2]=1)},i.cloneTo=function(e){ea.prototype.cloneTo.call(this,e);e.x=this.x,e.y=this.y,e.z=this.z,e.randomDirection=this.randomDirection};var ea,ta=na;function na(){this.x=NaN,this.y=NaN,this.z=NaN,na.__super.call(this),this.x=1,this.y=1,this.z=1,this.randomDirection=!1}t(aa,"laya.d3.core.particleShuriKen.module.shape.CircleShape",ia=s),(D=aa.prototype)._getShapeBoundBox=function(e){var t=e.min.elements,t=(t[0]=t[2]=-this.radius,t[1]=0,e.max.elements);t[0]=t[2]=this.radius,t[1]=0},D._getSpeedBoundBox=function(e){var t=e.min.elements,t=(t[0]=t[1]=-1,t[2]=0,e.max.elements);t[0]=t[1]=1,t[2]=0},D.generatePositionAndDirection=function(e,t,n,i){var r=e.elements,a=aa._tempPositionPoint.elements;n?(n.seed=i[16],this.emitFromEdge?Ke._randomPointUnitArcCircle(this.arc,aa._tempPositionPoint,n):Ke._randomPointInsideUnitArcCircle(this.arc,aa._tempPositionPoint,n),i[16]=n.seed):this.emitFromEdge?Ke._randomPointUnitArcCircle(this.arc,aa._tempPositionPoint):Ke._randomPointInsideUnitArcCircle(this.arc,aa._tempPositionPoint),r[0]=-a[0],r[1]=a[1],r[2]=0,W.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],Ke._randomPointUnitSphere(t,n),i[17]=n.seed):Ke._randomPointUnitSphere(t):e.cloneTo(t)},D.cloneTo=function(e){ia.prototype.cloneTo.call(this,e);e.radius=this.radius,e.arc=this.arc,e.emitFromEdge=this.emitFromEdge,e.randomDirection=this.randomDirection},e(aa,["_tempPositionPoint",function(){return this._tempPositionPoint=new ar}]);var ia,ra=aa;function aa(){this.radius=NaN,this.arc=NaN,this.emitFromEdge=!1,aa.__super.call(this),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1,this.randomDirection=!1}t(la,"laya.d3.core.particleShuriKen.module.shape.ConeShape",oa=s),(i=la.prototype)._getShapeBoundBox=function(e){var t=this.radius+this.length*Math.sin(this.angle),n=this.length*Math.cos(this.angle),i=e.min.elements,i=(i[0]=i[1]=-t,i[2]=0,e.max.elements);i[0]=i[1]=t,i[2]=n},i._getSpeedBoundBox=function(e){var t=Math.sin(this.angle),n=e.min.elements,e=(n[0]=n[1]=-t,n[2]=0,e.max.elements);e[0]=n[1]=t,e[2]=1},i.generatePositionAndDirection=function(e,t,n,i){var r,a=e.elements,o=t.elements,s=la._tempPositionPoint.elements,l=NaN,h=NaN,_=Math.cos(this.angle),u=Math.sin(this.angle);switch(this.emitType){case 0:n?(n.seed=i[16],Ke._randomPointInsideUnitCircle(la._tempPositionPoint,n),i[16]=n.seed):Ke._randomPointInsideUnitCircle(la._tempPositionPoint),l=s[0],h=s[1],a[0]=l*this.radius,a[1]=h*this.radius,a[2]=0,this.randomDirection?(n?(n.seed=i[17],Ke._randomPointInsideUnitCircle(la._tempDirectionPoint,n),i[17]=n.seed):Ke._randomPointInsideUnitCircle(la._tempDirectionPoint),r=la._tempDirectionPoint.elements,o[0]=r[0]*u,o[1]=r[1]*u):(o[0]=l*u,o[1]=h*u),o[2]=_;break;case 1:n?(n.seed=i[16],Ke._randomPointUnitCircle(la._tempPositionPoint,n),i[16]=n.seed):Ke._randomPointUnitCircle(la._tempPositionPoint),l=s[0],h=s[1],a[0]=l*this.radius,a[1]=h*this.radius,a[2]=0,this.randomDirection?(n?(n.seed=i[17],Ke._randomPointInsideUnitCircle(la._tempDirectionPoint,n),i[17]=n.seed):Ke._randomPointInsideUnitCircle(la._tempDirectionPoint),r=la._tempDirectionPoint.elements,o[0]=r[0]*u,o[1]=r[1]*u):(o[0]=l*u,o[1]=h*u),o[2]=_;break;case 2:n?(n.seed=i[16],Ke._randomPointInsideUnitCircle(la._tempPositionPoint,n)):Ke._randomPointInsideUnitCircle(la._tempPositionPoint),l=s[0],h=s[1],a[0]=l*this.radius,a[1]=h*this.radius,o[a[2]=0]=l*u,o[1]=h*u,o[2]=_,W.normalize(t,t),n?(W.scale(t,this.length*n.getFloat(),t),i[16]=n.seed):W.scale(t,this.length*Math.random(),t),W.add(e,t,e),this.randomDirection&&(n?(n.seed=i[17],Ke._randomPointUnitSphere(t,n),i[17]=n.seed):Ke._randomPointUnitSphere(t));break;case 3:n?(n.seed=i[16],Ke._randomPointUnitCircle(la._tempPositionPoint,n)):Ke._randomPointUnitCircle(la._tempPositionPoint),l=s[0],h=s[1],a[0]=l*this.radius,a[1]=h*this.radius,o[a[2]=0]=l*u,o[1]=h*u,o[2]=_,W.normalize(t,t),n?(W.scale(t,this.length*n.getFloat(),t),i[16]=n.seed):W.scale(t,this.length*Math.random(),t),W.add(e,t,e),this.randomDirection&&(n?(n.seed=i[17],Ke._randomPointUnitSphere(t,n),i[17]=n.seed):Ke._randomPointUnitSphere(t));break;default:throw new Error("ConeShape:emitType is invalid.")}},i.cloneTo=function(e){oa.prototype.cloneTo.call(this,e);e.angle=this.angle,e.radius=this.radius,e.length=this.length,e.emitType=this.emitType,e.randomDirection=this.randomDirection},e(la,["_tempPositionPoint",function(){return this._tempPositionPoint=new ar},"_tempDirectionPoint",function(){return this._tempDirectionPoint=new ar}]);var oa,sa=la;function la(){this.angle=NaN,this.radius=NaN,this.length=NaN,this.emitType=0,la.__super.call(this),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0,this.randomDirection=!1}t(ua,"laya.d3.core.particleShuriKen.module.shape.HemisphereShape",ha=s),(D=ua.prototype)._getShapeBoundBox=function(e){var t=e.min.elements,t=(t[0]=t[1]=t[2]=-this.radius,e.max.elements);t[0]=t[1]=this.radius,t[2]=0},D._getSpeedBoundBox=function(e){var t=e.min.elements,t=(t[0]=t[1]=-1,t[2]=0,e.max.elements);t[0]=t[1]=t[2]=1},D.generatePositionAndDirection=function(e,t,n,i){var r=e.elements,a=(n?(n.seed=i[16],this.emitFromShell?Ke._randomPointUnitSphere(e,n):Ke._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?Ke._randomPointUnitSphere(e):Ke._randomPointInsideUnitSphere(e),W.scale(e,this.radius,e),r[2]);a<0&&(r[2]=-1*a),this.randomDirection?n?(n.seed=i[17],Ke._randomPointUnitSphere(t,n),i[17]=n.seed):Ke._randomPointUnitSphere(t):e.cloneTo(t)},D.cloneTo=function(e){ha.prototype.cloneTo.call(this,e);e.radius=this.radius,e.emitFromShell=this.emitFromShell,e.randomDirection=this.randomDirection};var ha,_a=ua;function ua(){this.radius=NaN,this.emitFromShell=!1,ua.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}t(fa,"laya.d3.core.particleShuriKen.module.shape.SphereShape",da=s),(i=fa.prototype)._getShapeBoundBox=function(e){var t=e.min.elements,t=(t[0]=t[1]=t[2]=-this.radius,e.max.elements);t[0]=t[1]=t[2]=this.radius},i._getSpeedBoundBox=function(e){var t=e.min.elements,t=(t[0]=t[1]=t[2]=-1,e.max.elements);t[0]=t[1]=t[2]=1},i.generatePositionAndDirection=function(e,t,n,i){n?(n.seed=i[16],this.emitFromShell?Ke._randomPointUnitSphere(e,n):Ke._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?Ke._randomPointUnitSphere(e):Ke._randomPointInsideUnitSphere(e),W.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],Ke._randomPointUnitSphere(t,n),i[17]=n.seed):Ke._randomPointUnitSphere(t):e.cloneTo(t)},i.cloneTo=function(e){da.prototype.cloneTo.call(this,e);e.radius=this.radius,e.emitFromShell=this.emitFromShell,e.randomDirection=this.randomDirection};var da,ca=fa;function fa(){this.radius=NaN,this.emitFromShell=!1,fa.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}t(pa,"laya.d3.core.render.SubMeshRenderElement",lt);var ma=pa;function pa(){this._batchIndexStart=0,this._batchIndexEnd=0,this._skinAnimationDatas=null,pa.__super.call(this)}t(Ea,"laya.d3.shader.ShaderCompile3D",ne),(D=Ea.prototype)._definesToNameDic=function(e,t){for(var n,i,r={},a=0;a<32&&!(e<(n=1<<a));a++)e&n&&(i=t[n])&&(r[i]="");return r},D.withCompile=function(e,t,n){var i,r=this.sharders[e];if(r)if(i=r[t]){if(c=i[n])return c}else i=r[t]=[];else i=(r=this.sharders[e]=[])[t]=[];var a,r=this._definesToNameDic(e,Ea._globalInt2name),o=this._definesToNameDic(t,this._spriteInt2name),s=this._definesToNameDic(n,this._materialInt2name);if(laya.d3.shader.ShaderCompile3D.debugMode){var l="";for(a in r)l+=a+" ";var h="";for(a in o)h+=a+" ";var _="";for(a in s)_+=a+" ";console.log("ShaderCompile3DDebugMode---(Name:"+Ko.nameKey.getName(this._name)+" PublicDefine:"+e+" SpriteDefine:"+t+" MaterialDefine:"+n+" PublicDefineGroup:"+l+" SpriteDefineGroup:"+h+"MaterialDefineGroup: "+_+")---ShaderCompile3DDebugMode")}var u={},d="";if(r)for(a in r)d+="#define "+a+"\n",u[a]=!0;if(o)for(a in o)d+="#define "+a+"\n",u[a]=!0;if(s)for(a in s)d+="#define "+a+"\n",u[a]=!0;var e=this._VS.toscript(u,[]),t=this._PS.toscript(u,[]),c=Ko.create(d+e.join("\n"),d+t.join("\n"),this._attributeMap,this._sceneUniformMap,this._cameraUniformMap,this._spriteUniformMap,this._materialUniformMap,this._renderElementUniformMap);return i[n]=c},D.precompileShaderWithShaderDefine=function(e,t,n){this.withCompile(e,t,n)},D.addMaterialDefines=function(e){var t,n=e.defines;for(t in n){var i=n[t],r=parseInt(t);this._materialInt2name[r]=i,this._materialName2Int[i]=r}},D.addSpriteDefines=function(e){var t,n=e.defines;for(t in n){var i=n[t],r=parseInt(t);this._spriteInt2name[r]=i,this._spriteName2Int[i]=r}},D.getMaterialDefineByName=function(e){return this._materialName2Int[e]},D.registerMaterialDefine=function(e){var t=Math.pow(2,this._materialDefineCounter++);return this._materialInt2name[t]=e,this._materialName2Int[e]=t},D.registerSpriteDefine=function(e){var t=Math.pow(2,this._spriteDefineCounter++);return this._spriteInt2name[t]=e,this._spriteName2Int[e]=t},Ea._globalRegDefine=function(e,t){Ea._globalInt2name[t]=e},Ea.add=function(e,t,n,i,r){return laya.d3.shader.ShaderCompile3D._preCompileShader[e]=new Ea(e,t,n,i,r,ne.includes)},Ea.get=function(e){return laya.d3.shader.ShaderCompile3D._preCompileShader[Ko.nameKey.getID(e)]},Ea._preCompileShader={},Ea._globalInt2name=[],Ea.debugMode=!1,Ea.SHADERDEFINE_HIGHPRECISION=1,Ea.SHADERDEFINE_FOG=4,Ea.SHADERDEFINE_DIRECTIONLIGHT=8,Ea.SHADERDEFINE_POINTLIGHT=16,Ea.SHADERDEFINE_SPOTLIGHT=32,Ea.SHADERDEFINE_UV0=64,Ea.SHADERDEFINE_COLOR=128,Ea.SHADERDEFINE_UV1=256,Ea.SAHDERDEFINE_DEPTHFOG=131072;var g=Ea;function Ea(e,t,n,i,r,a){this._name=NaN,this._attributeMap=null,this._renderElementUniformMap=null,this._materialUniformMap=null,this._spriteUniformMap=null,this._cameraUniformMap=null,this._sceneUniformMap=null,this.sharders=null,this._spriteDefineCounter=3,this._spriteInt2name=[],this._spriteName2Int={},this._materialDefineCounter=1,this._materialInt2name=[],this._materialName2Int={},this._conchShader=null,this._name=e,this._renderElementUniformMap={},this._materialUniformMap={},this._spriteUniformMap={},this._cameraUniformMap={},this._sceneUniformMap={},this.sharders=[],this._spriteInt2name[Tr.SHADERDEFINE_RECEIVE_SHADOW]="RECEIVESHADOW",this._spriteInt2name[cl.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV]="SCALEOFFSETLIGHTINGMAPUV",this._spriteInt2name[cl.SAHDERDEFINE_LIGHTMAP]="LIGHTMAP",this._spriteInt2name[Ul.SHADERDEFINE_BONE]="BONE",this._materialInt2name[Va.SHADERDEFINE_ALPHATEST]="ALPHATEST";Ea.__super.call(this,e,t,n,null,{}),this._attributeMap=i;for(var o in r){var s=r[o];switch(s[1]){case 0:this._renderElementUniformMap[o]=s[0];break;case 1:this._materialUniformMap[o]=s[0];break;case 2:this._spriteUniformMap[o]=s[0];break;case 3:this._cameraUniformMap[o]=s[0];break;case 4:this._sceneUniformMap[o]=s[0];break;default:throw new Error("ShaderCompile3D: period is unkonw.")}}}t(va,"laya.d3.graphics.MeshSprite3DStaticBatchManager",Yt),(s=va.prototype)._getStaticBatch=function(e,t,n,i){var r,i=e?e.id.toString()+n.id.toString()+t.id.toString()+i.toString():n.id.toString()+t.id.toString()+i.toString();return this._staticBatches[i]?r=this._staticBatches[i]:this._staticBatches[i]=r=new Ta(i,this,e,t,n),r},s._initStaticBatchs=function(e){this._initBatchRenderElements.sort(va._sortPrepareStaticBatch);for(var t,n,i,r=!1,a=0,o=0,s=this._initBatchRenderElements.length;o<s;o++){var l,h,_,u,d=this._initBatchRenderElements[o],c=d.renderObj._getVertexBuffer(0);d._sprite3D;n===c.vertexDeclaration&&t===d._material?r?i._addCombineBatchRenderObjTest(d)?(l=d._staticBatch)!==i&&(l&&l._deleteCombineBatchRenderObj(d),i._addCombineBatchRenderObj(d)):(r=!1,a++):(_=(h=this._initBatchRenderElements[o-1]).renderObj,u=d.renderObj,r=!(65535<_._getVertexBuffer().vertexCount+u._getVertexBuffer().vertexCount||(i=this._getStaticBatch(e,n,t,a),(l=h._staticBatch)!==i&&(l&&l._deleteCombineBatchRenderObj(h),i._addCombineBatchRenderObj(h)),(l=d._staticBatch)!==i&&(l&&l._deleteCombineBatchRenderObj(d),i._addCombineBatchRenderObj(d)),0))):(r=!1,a=0),t=d._material,n=c.vertexDeclaration}},va._sortPrepareStaticBatch=function(e,t){var n=e._render,i=t._render,r=n.lightmapIndex-i.lightmapIndex;return 0==r?0==(n=n.receiveShadow-i.receiveShadow)?0==(i=e._mainSortID-t._mainSortID)?e.renderObj.triangleCount-t.renderObj.triangleCount:i:n:r};var ga=va;function va(){va.__super.call(this)}t(Sa,"laya.d3.graphics.SubMeshStaticBatch",l),(i=Sa.prototype)._compareBatchRenderElement=function(e,t){return e._batchIndexStart>t._batchIndexStart},i._addCombineBatchRenderObjTest=function(e){var t=e.renderObj._vertexCount;return!(65535<(0<t?this._currentCombineVertexCount+t:this._currentCombineVertexCount+e.renderObj._getVertexBuffer().vertexCount))},i._addCombineBatchRenderObj=function(e){var t=e.renderObj,n=t._vertexCount;this._initBatchRenderElements.push(e),e._staticBatch=this,0<n?(this._currentCombineIndexCount+=t._indexCount,this._currentCombineVertexCount+=n):(this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount),this._needFinishCombine=!0},i._deleteCombineBatchRenderObj=function(e){var t=e.renderObj,n=this._initBatchRenderElements.indexOf(e);-1!==n&&(this._initBatchRenderElements.splice(n,1),e._staticBatch=null,0<(n=t._vertexCount)?(this._currentCombineIndexCount=this._currentCombineIndexCount-t._indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-n):(this._currentCombineIndexCount=this._currentCombineIndexCount-t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-t._getVertexBuffer().vertexCount),this._needFinishCombine=!0)},i._finishInit=function(){if(this._needFinishCombine){var e=0,t=0,n=((0<=this._initBatchRenderElements[0]._sprite3D._render.lightmapIndex||this._material instanceof laya.d3.core.material.StandardMaterial&&this._material.ambientTexture)&&(this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration)),new Float32Array(this._vertexDeclaration.vertexStride/4*this._currentCombineVertexCount)),i=new Uint16Array(this._currentCombineIndexCount);this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy()),this._vertexBuffer=Es.create(this._vertexDeclaration,this._currentCombineVertexCount,35044),this._indexBuffer=ds.create("ushort",this._currentCombineIndexCount,35044);for(var r=0,a=this._initBatchRenderElements.length;r<a;r++){var o=this._initBatchRenderElements[r],s=o.renderObj,l=s._getStaticBatchBakedVertexs(this._rootOwner?this._rootOwner._transform:null,o._sprite3D),h=s.getIndices(),_=o._sprite3D.transform._isFrontFaceInvert,u=e/(this._vertexDeclaration.vertexStride/4)-s._vertexStart,s=t,d=s+h.length,c=(o._batchIndexStart=s,o._batchIndexEnd=d,i.set(h,t),0);if(_)for(c=s;c<d;c+=3){i[c]=u+i[c];var f=i[c+1],m=i[c+2];i[c+1]=u+m,i[c+2]=u+f}else for(c=s;c<d;c+=3)i[c]=u+i[c],i[c+1]=u+i[c+1],i[c+2]=u+i[c+2];t+=h.length,n.set(l,e),e+=l.length}this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this._needFinishCombine=!1}},i._getCombineRenderElementFromPool=function(){return this._combineRenderElementPool[this._combineRenderElementPoolIndex++]||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=new ma)},i._getRenderElement=function(e,t,n){for(var i=this._batchRenderElements.length,r=!0,a=0;a<i;a++){var o,s,l,h,_,u,d,c=(o=this._batchRenderElements[a])._sprite3D._render;(r=0!==a?(l=(h=this._batchRenderElements[a-1])._sprite3D._render).lightmapIndex!==c.lightmapIndex||l.receiveShadow!==c.receiveShadow||h._batchIndexEnd!==o._batchIndexStart:r)?((s=this._getCombineRenderElementFromPool()).renderObj=this,s._material=this._material,s._batchIndexStart=o._batchIndexStart,s._batchIndexEnd=o._batchIndexEnd,l=c.lightmapIndex,void 0===(u=(_=(_=this._batchOwnerIndices[h=l+1])||(this._batchOwnerIndices[h]=[]))[o._render.receiveShadow?1:0])?(_[c.receiveShadow?1:0]=this._batchOwners.length,(d=new Fl(null,"StaticBatchMeshSprite3D"))._scene=t,d._transform=this._rootOwner?this._rootOwner._transform:null,d._render.lightmapIndex=l,d._render.receiveShadow=o._render.receiveShadow,this._batchOwners.push(d)):d=this._batchOwners[u],d._render._renderUpdate(n),s._sprite3D=d,e.push(s)):s._batchIndexEnd=o._batchIndexEnd}},i._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},i._render=function(e){var e=e.renderElement,t=e._batchIndexStart,e=e._batchIndexEnd-t;c.mainContext.drawElements(4,e,5123,2*t),T.drawCall++,T.trianglesFaces+=e/3},i.dispose=function(){this._batchOwnerIndices=null,this._batchOwners=null,this._vertexDeclaration=null,this._vertexBuffer.destroy(),this._indexBuffer.destroy()},i._getVertexBuffer=function(e){return void 0===e&&(e=0),this._vertexBuffer};var Ta=Sa;function Sa(e,t,n,i,r){this._batchOwnerIndices=null,this._batchOwners=null,this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=null,this._vertexBuffer=null,this._indexBuffer=null,Sa.__super.call(this,e,t,n),this._batchOwnerIndices=[],this._batchOwners=[],this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=i,this._material=r}var Da;t(xa,"laya.d3.resource.models.SkyBox",Da=u),(D=xa.prototype)._getShader=function(e){e=e.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(e,0,0),this._shader},D.createResource=function(){this._numberVertices=36,this._numberIndices=36;var e=new Uint16Array(this._numberIndices),t=xa._vertexDeclaration.vertexStride/4,t=new Float32Array(this._numberVertices*t),n=new W(-.5,.5,.5),i=new W(-.5,-.5,.5),r=new W(.5,.5,.5),a=new W(.5,-.5,.5),o=new W(-.5,.5,-.5),s=new W(.5,.5,-.5),l=new W(-.5,-.5,-.5),h=new W(.5,-.5,-.5),_=this._addVertex(t,0,n);_=this._addVertex(t,_,i),_=this._addVertex(t,_,r),_=this._addVertex(t,_,i),_=this._addVertex(t,_,a),_=this._addVertex(t,_,r),_=this._addVertex(t,_,o),_=this._addVertex(t,_,s),_=this._addVertex(t,_,l),_=this._addVertex(t,_,l),_=this._addVertex(t,_,s),_=this._addVertex(t,_,h),_=this._addVertex(t,_,n),_=this._addVertex(t,_,s),_=this._addVertex(t,_,o),_=this._addVertex(t,_,n),_=this._addVertex(t,_,r),_=this._addVertex(t,_,s),_=this._addVertex(t,_,i),_=this._addVertex(t,_,l),_=this._addVertex(t,_,h),_=this._addVertex(t,_,i),_=this._addVertex(t,_,h),_=this._addVertex(t,_,a),_=this._addVertex(t,_,n),_=this._addVertex(t,_,l),_=this._addVertex(t,_,i),_=this._addVertex(t,_,o),_=this._addVertex(t,_,l),_=this._addVertex(t,_,n),_=this._addVertex(t,_,r),_=this._addVertex(t,_,a),_=this._addVertex(t,_,h),_=this._addVertex(t,_,s),_=this._addVertex(t,_,r),this._addVertex(t,_,h);for(var u=0;u<36;u++)e[u]=u;this._vertexBuffer=new Es(xa._vertexDeclaration,this._numberVertices,35044,!0),this._indexBuffer=new ds("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(t),this._indexBuffer.setData(e)},D._addVertex=function(e,t,n){n=n.elements;return e[t+0]=n[0],e[t+1]=n[1],e[t+2]=n[2],t+3},D.loadShaderParams=function(){this._sharderNameID=Ko.nameKey.getID("SkyBox"),this._shaderCompile=g._preCompileShader[this._sharderNameID]},D._render=function(e){this._textureCube&&this._textureCube.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e),this._shader.bind(),e.camera.transform.worldMatrix.cloneTo(xa._tempMatrix4x40),xa._tempMatrix4x40.transpose(),R.multiply(e._projectionMatrix,xa._tempMatrix4x40,xa._tempMatrix4x41),e.camera._shaderValues.setValue(4,xa._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(e.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.textureCube),this._shader.uploadAttributes(xa._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),c.mainContext.drawElements(4,36,5123,0),T.trianglesFaces+=12,T.drawCall++)},D.destroy=function(){Da.prototype.destroy.call(this),this._textureCube&&(this._textureCube._removeReference(),this._textureCube=null)},n(0,D,"textureCube",function(){return this._textureCube},function(e){this._textureCube!==e&&(this._textureCube&&this._textureCube._removeReference(),this._textureCube=e)&&e._addReference()}),xa._nameNumber=1,e(xa,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new R},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new R},"_vertexDeclaration",function(){return this._vertexDeclaration=new h(12,[new _(0,"vector3",0)])}]);function xa(){xa.__super.call(this),xa._nameNumber++,this.loadShaderParams(),this.createResource(),this.alphaBlending=1,this.colorIntensity=1}var Ma;t(Ra,"laya.d3.resource.models.SkyDome",Ma=u),(s=Ra.prototype)._getShader=function(e){e=e.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(e,0,0),this._shader},s.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),t=Ra._vertexDeclaration.vertexStride/4,n=new Float32Array(this._numberVertices*t),i=Math.PI/this._stacks,r=2*Math.PI/this._slices,a=0,o=0,s=0,l=0;l<this._stacks+1;l++)for(var h=Math.sin(l*i),_=Math.cos(l*i),u=0;u<this._slices+1;u++){var d=h*Math.sin(u*r),c=h*Math.cos(u*r);n[o+0]=d*this._radius,n[o+1]=_*this._radius,n[o+2]=c*this._radius,n[o+3]=.75-u/this._slices,n[o+4]=l/this._stacks,o+=t,l!=this._stacks-1&&(e[s++]=a+1,e[s++]=a,e[s++]=a+(this._slices+1),e[s++]=a+(this._slices+1),e[s++]=a,e[s++]=a+this._slices,a++)}this._vertexBuffer=new Es(Ra._vertexDeclaration,this._numberVertices,35044),this._indexBuffer=new ds("ushort",this._numberIndices,35044),this._vertexBuffer.setData(n),this._indexBuffer.setData(e)},s.loadShaderParams=function(){this._sharderNameID=Ko.nameKey.getID("SkyDome"),this._shaderCompile=g._preCompileShader[this._sharderNameID]},s._render=function(e){this._texture&&this._texture.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e),this._shader.bind(),e.camera.transform.worldMatrix.cloneTo(Ra._tempMatrix4x40),Ra._tempMatrix4x40.transpose(),R.multiply(e._projectionMatrix,Ra._tempMatrix4x40,Ra._tempMatrix4x41),e.camera._shaderValues.setValue(4,Ra._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(e.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.texture),this._shader.uploadAttributes(Ra._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),c.mainContext.drawElements(4,this._indexBuffer.indexCount,5123,0),T.trianglesFaces+=this._numberIndices/3,T.drawCall++)},s.onEnvDescLoaded=function(e){var t="",n=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\")),n=(0<n&&(t=e.substr(0,n+1)),v.loader.getRes(e)),e=(null!=n.ev&&this.__ownerCamera?this.__ownerCamera._shaderValues.setValue(13,Math.pow(2,n.ev)):this.__ownerCamera._shaderValues.setValue(13,Math.pow(2,0)),this.texture=nl.load(t+n.skytex),this.environmentSpecular=Xs.load(t+n.prefiltedEnv),new Float32Array(n.IrradianceMat));this.envDiffuseSHRed=e.slice(0,16),this.envDiffuseSHGreen=e.slice(16,32),this.envDiffuseSHBlue=e.slice(32,48)},s.loadEnvInfo=function(e){v.loader.load(e,j.create(this,this.onEnvDescLoaded,[e]))},s.destroy=function(){Ma.prototype.destroy.call(this),this._texture&&(this._texture._removeReference(),this._texture=null)},n(0,s,"texture",function(){return this._texture},function(e){this._texture!==e&&(this._texture&&this._texture._removeReference(),this._texture=e)&&e._addReference()}),Ra._nameNumber=1,e(Ra,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new R},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new R},"_vertexDeclaration",function(){return this._vertexDeclaration=new h(20,[new _(0,"vector3",0),new _(12,"vector2",2)])}]);function Ra(){this._stacks=16,this._slices=16,this._radius=1,Ra.__super.call(this),Ra._nameNumber++,this.loadShaderParams(),this.recreateResource(),this.alphaBlending=1,this.colorIntensity=1}t(Ia,"laya.d3.core.ComponentNode",$),(l=Ia.prototype).addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1===n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");n=Y.getInstance(e);return t.push(this._components.length),this._components.push(n),n instanceof laya.d3.component.Script&&this._scripts.push(n),n._initialize(this),n},l._removeComponent=function(e,t){var n=this._typeComponentsIndices[e],i=n[t],r=this._components[i];this._components.splice(i,1),r instanceof laya.d3.component.Script&&this._scripts.splice(this._scripts.indexOf(r),1),n.splice(t,1),0===n.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1));for(var a=0,o=this._componentsMap.length;a<o;a++)for(var s=(n=this._typeComponentsIndices[a]).length-1;0<=s;s--){var l=n[s];if(!(i<l))break;n[s]=--l}r._destroy()},l.getComponentByType=function(e,t){void 0===t&&(t=0);e=this._componentsMap.indexOf(e);return-1===e?null:this._components[this._typeComponentsIndices[e][t]]},l.getComponentsByType=function(e,t){e=this._componentsMap.indexOf(e);if(-1===e)t.length=0;else{var n=this._typeComponentsIndices[e],i=n.length;t.length=i;for(var r=0;r<i;r++)t[r]=this._components[n[r]]}},l.getComponentByIndex=function(e){return this._components[e]},l.removeComponentByType=function(e,t){void 0===t&&(t=0);e=this._componentsMap.indexOf(e);-1!==e&&this._removeComponent(e,t)},l.removeComponentsByType=function(e){var t=this._componentsMap.indexOf(e);if(-1!==t)for(var n=this._typeComponentsIndices[t],i=0,r=n.length;i<r;n.length<r?r--:i++)this._removeComponent(t,i)},l.removeAllComponent=function(){for(var e=0,t=this._componentsMap.length;e<t;this._componentsMap.length<t?t--:e++)this.removeComponentsByType(this._componentsMap[e])},l._updateComponents=function(e){for(var t=0,n=this._components.length;t<n;t++){var i=this._components[t];i.started||(i._start(e),i.started=!0),i.enable&&i._update(e)}},l._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];n.started||(n._start(e),n.started=!0),n.enable&&n._lateUpdate(e)}},l._preRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];n.started||(n._start(e),n.started=!0),n.enable&&n._preRenderUpdate(e)}},l._postRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];n.started||(n._start(e),n.started=!0),n.enable&&n._postRenderUpdate(e)}};i=Ia;function Ia(){this._componentsMap=null,this._typeComponentsIndices=null,this._components=null,this._scripts=null,Ia.__super.call(this),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[],this._scripts=[]}t(Ca,"laya.d3.animation.AnimationClip",r),(D=Ca.prototype).duration=function(){return this._duration},D._hermiteInterpolate=function(e,t,n,i){for(var r=e.data,a=e.outTangent,e=e.next,o=e.data,s=e.inTangent,l=!1,h=NaN,_=NaN,u=NaN,d=NaN,c=0,f=i.length;c<f;c++){var m,p,E=a[c],g=s[c];Number.isFinite(E)&&Number.isFinite(g)?(l||(h=2*(p=(m=t*t)*t)-3*m+1,_=p-2*m+t,u=p-m,d=-2*p+3*m,l=!0),i[c]=h*r[c]+_*E*n+u*g*n+d*o[c]):i[c]=r[c]}},D._getFullKeyframeIndicesWithCache=function(e){return this._fullKeyframeIndicesCache[e]},D._cacheFullKeyframeIndices=function(e,t){this._fullKeyframeIndicesCache[e]=t},D._getAnimationDataWithCache=function(e,t){e=this._animationDatasCache[e];return e?e[t]:null},D._cacheAnimationData=function(e,t,n){(this._animationDatasCache[e]||(this._animationDatasCache[e]=[]))[t]=n},D._getAvatarDataWithCache=function(e,t,n){var e=this._avatarDatasCache[e.id];return e&&(e=e[t])?e[n]:null},D._cacheAvatarData=function(e,t,n,i){e=this._avatarDatasCache[e.id]||(this._avatarDatasCache[e.id]=[]);(e[t]||(e[t]=[]))[n]=i},D._evaluateAnimationlDatasCacheMode=function(e,t,n,i,r){for(var a=0,o=0,s=0,l=(r||this._nodes).length;s<l;s++){var h=r?r[s]:s,_=this._nodes[h],u=_._cacheProperty;if(e[h]){var d,c=t[h],f=c[n.currentFrameIndex],m=0;if(-1!==f){var p=_.keyFrames[f];if(p.next){r&&!u?d=(d=i[h])||(i[h]=new Float32Array(_.keyFrameWidth)):(d=new Float32Array(_.keyFrameWidth),i[s]=d);var E=NaN,g=p.duration,E=0!==g?(n.currentFrameTime-p.startTime)/g:0;this._hermiteInterpolate(p,E,g,d)}else{if(r&&!u)d=(d=i[h])||(i[h]=new Float32Array(_.keyFrameWidth));else{if(-1!==(m=n._lastFrameIndex)&&c[m]===f)continue;d=new Float32Array(_.keyFrameWidth),i[s]=d}for(var v=p.data,a=0,o=d.length;a<o;a++)d[a]=v[a]}}else{if(r&&!u)d=(d=i[h])||(i[h]=new Float32Array(_.keyFrameWidth));else{if(-1!==(m=n._lastFrameIndex)&&c[m]===f)continue;d=new Float32Array(_.keyFrameWidth),i[s]=d}var T=_.keyFrames[0].data;for(a=0,o=d.length;a<o;a++)d[a]=T[a]}}}},D._evaluateAnimationlDatasRealTime=function(e,t,n,i){var r=0,a=0,o=this._nodes;if(!this._realTimeCurrentFrameIndexes){for(this._realTimeCurrentFrameIndexes=new Int32Array(o.length),r=0,a=o.length;r<a;r++)this._realTimeCurrentFrameIndexes[r]=-1;this._realTimeCurrentTimes=new Float32Array(o.length)}for(r=0,a=(i||this._nodes).length;r<a;r++){for(var s=i?i[r]:r,l=o[s],h=(t<this._realTimeCurrentTimes[s]&&(this._realTimeCurrentFrameIndexes[s]=-1),this._realTimeCurrentTimes[s]=t,this._realTimeCurrentFrameIndexes[s]+1),_=l.keyFrames,u=_.length;h<u;){if(_[h].startTime>t){this._realTimeCurrentFrameIndexes[s]=h-1;break}h++}h===u&&(this._realTimeCurrentFrameIndexes[s]=u-1);var d=0,c=0,f=(f=n[s])||(n[s]=new Float32Array(l.keyFrameWidth)),m=_[this._realTimeCurrentFrameIndexes[s]];if(m)if(m.next){var p=m.duration,E=NaN,E=0!==p?(t-m.startTime)/p:0;this._hermiteInterpolate(m,E,p,f)}else for(var g=m.data,d=0,c=f.length;d<c;d++)f[d]=g[d];else{var v=l.keyFrames[0].data;for(d=0,c=f.length;d<c;d++)f[d]=v[d]}E=e[s];E&&(i?de._propertySetFuncs[l.propertyNameID](E,null,f):de._propertySetFuncs[l.propertyNameID](null,E,f))}},D._binarySearchEventIndex=function(e){for(var t=0,n=this._animationEvents.length-1;t<=n;){var i=Math.floor((t+n)/2),r=this._animationEvents[i].time;if(r==e)return i;e<r?n=i-1:t=i+1}return t},D.addEvent=function(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)},D.onAsynLoaded=function(e,t,n){var i=new X(t);switch(this._version=i.readUTFString(),this._version){case"LAYAANIMATION:01":oe.parse(this,i);break;case"LAYAANIMATION:02":le.parse(this,i)}this.completeCreate(),this._endLoaded()},D.disposeResource=function(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyMap=null,this._publicClipDatas=null},Ca.load=function(e){return v.loader.create(e,null,null,Ca)};var Aa=Ca;function Ca(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyMap=null,this._duration=NaN,this._frameRate=0,this._animationEvents=null,this._publicClipDatas=null,this.islooping=!1,Ca.__super.call(this),this._fullKeyframeIndicesCache={},this._animationDatasCache=[],this._avatarDatasCache=[],this._skinnedDatasCache=[],this._animationEvents=[]}t(Oa,"laya.d3.core.Avatar",r),u=Oa.prototype,v.imps(u,{"laya.d3.core.IClone":!0}),u._initCloneToAnimator=function(e,t){t._avatarNodeMap[e.name]=e,t._avatarNodes.push(e);for(var n=0,i=e.getChildCount();n<i;n++)this._initCloneToAnimator(e.getChildByIndex(n),t)},u._parseNode=function(e,t){for(var n,i=e.props.name,r=(t.name=i,t._parent&&(i=e.customProps,(n=t.transform)._localRotationEuler=new Float32Array(3),n.setLocalPosition(new Float32Array(i.translate)),n.setLocalRotation(new Float32Array(i.rotation)),n.setLocalScale(new Float32Array(i.scale)),n._setWorldMatrixAndUpdate(new Float32Array(16))),e.child),a=0,o=r.length;a<o;a++){var s=r[a],l=new de;t.addChild(l),this._parseNode(s,l)}},u.onAsynLoaded=function(e,t,n){var i;this._rootNode=new de,t.version?(this._version=t.version,(i=t.rootNode)&&this._parseNode(i,this._rootNode)):this._parseNode(t,this._rootNode),this._endLoaded()},u._cloneDatasToAnimator=function(e){var t=this._rootNode.clone();t.transform._setWorldMatrixIgnoreUpdate(null);e._avatarNodeMap={},e._avatarNodes=[],this._initCloneToAnimator(t,e)},u.cloneTo=function(e){var t=this._rootNode.clone();e._rootNode=t},u.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},Oa.load=function(e){return v.loader.create(e,null,null,Oa)};var ya=Oa;function Oa(){Oa.__super.call(this)}t(La,"laya.d3.core.material.BaseMaterial",Na=r),s=La.prototype,v.imps(s,{"laya.d3.core.IClone":!0}),s._addShaderDefine=function(e){this._shaderDefineValue|=e},s._removeShaderDefine=function(e){this._shaderDefineValue&=~e},s._addDisablePublicShaderDefine=function(e){this._disablePublicShaderDefine|=e},s._removeDisablePublicShaderDefine=function(e){this._disablePublicShaderDefine&=~e},s._setBuffer=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t},s._getBuffer=function(e){return this._values[e]},s._setMatrix4x4=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t},s._getMatrix4x4=function(e){return this._values[e]},s._setInt=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t},s._getInt=function(e){return this._values[e]},s._setNumber=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t},s._getNumber=function(e){return this._values[e]},s._setBool=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t},s._getBool=function(e){return this._values[e]},s._setVector2=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t},s._getVector2=function(e){return this._values[e]},s._setColor=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t},s._getColor=function(e){return this._values[e]},s._setTexture=function(e,t){var n=this._values[e];this._values[e]=t,this._shaderValues.setValue(e,t),0<this.referenceCount&&(n&&n._removeReference(),t)&&t._addReference()},s._getTexture=function(e){return this._values[e]},s._upload=function(){this._shader.uploadMaterialUniforms(this._shaderValues.data)},s._getShader=function(e,t,n){e=(e|t)&~this._disablePublicShaderDefine;return this._shader=this._shaderCompile.withCompile(e,n,this._shaderDefineValue),this._shader},s._setRenderStateBlendDepth=function(){var e=c.mainContext;switch(f.setDepthMask(e,this.depthWrite),0===this.depthTest?f.setDepthTest(e,!1):(f.setDepthTest(e,!0),f.setDepthFunc(e,this.depthTest)),this.blend){case 0:f.setBlend(e,!1);break;case 1:f.setBlend(e,!0),f.setBlendFunc(e,this.srcBlend,this.dstBlend);break;case 2:f.setBlend(e,!0)}},s._setRenderStateFrontFace=function(e,t){var n=c.mainContext,i=0;switch(this.cull){case 0:f.setCullFace(n,!1);break;case 1:f.setCullFace(n,!0),i=e?t&&t._isFrontFaceInvert?2305:2304:t&&t._isFrontFaceInvert?2304:2305,f.setFrontFace(n,i);break;case 2:f.setCullFace(n,!0),i=e?t&&t._isFrontFaceInvert?2304:2305:t&&t._isFrontFaceInvert?2305:2304,f.setFrontFace(n,i)}},s.onAsynLoaded=function(e,t,n){var i=t[0],r=t[1];switch(i.version){case"LAYAMATERIAL:01":var a,o=0,s=0,l=i.props;for(a in l)switch(a){case"vectors":for(var h=l[a],o=0,s=h.length;o<s;o++){var _=h[o],u=_.value;switch(u.length){case 2:this[_.name]=new ar(u[0],u[1]);break;case 3:this[_.name]=new W(u[0],u[1],u[2]);break;case 4:this[_.name]=new P(u[0],u[1],u[2],u[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var d=l[a];for(o=0,s=d.length;o<s;o++){var c=d[o],f=c.path;f&&(this[c.name]=K.getRes(r[f]))}break;case"defines":var m=l[a];for(o=0,s=m.length;o<s;o++){var p=this._shaderCompile.getMaterialDefineByName(m[o]);this._addShaderDefine(p)}break;case"cull":case"blend":case"srcBlend":case"dstBlend":case"depthWrite":this[a]=l[a];break;case"renderQueue":switch(l[a]){case 1:this.renderQueue=2e3;break;case 2:this.renderQueue=3e3}break;default:this[a]=l[a]}break;case"LAYAMATERIAL:02":for(a in l=i.props)switch(a){case"vectors":for(o=0,s=(h=l[a]).length;o<s;o++)switch((u=(_=h[o]).value).length){case 2:this[_.name]=new ar(u[0],u[1]);break;case 3:this[_.name]=new W(u[0],u[1],u[2]);break;case 4:this[_.name]=new P(u[0],u[1],u[2],u[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}break;case"textures":for(o=0,s=(d=l[a]).length;o<s;o++)(f=(c=d[o]).path)&&(this[c.name]=K.getRes(r[f]));break;case"defines":for(o=0,s=(m=l[a]).length;o<s;o++)p=this._shaderCompile.getMaterialDefineByName(m[o]),this._addShaderDefine(p);break;default:this[a]=l[a]}break;default:throw new Error("BaseMaterial:unkonwn version.")}this._endLoaded()},s._addReference=function(){Na.prototype._addReference.call(this);for(var e=0,t=this._values.length;e<t;e++){var n=this._values[e];n&&n instanceof laya.d3.resource.BaseTexture&&n._addReference()}},s._removeReference=function(){Na.prototype._removeReference.call(this);for(var e=0,t=this._values.length;e<t;e++){var n=this._values[e];n&&n instanceof laya.d3.resource.BaseTexture&&n._removeReference()}},s.disposeResource=function(){this.blendConstColor=null,this._shader=null,this._shaderValues=null;for(var e=0,t=this._values.length;e<t;e++){var n=this._values[e];n&&n instanceof laya.d3.resource.BaseTexture&&n._removeReference()}this._values=null},s.setShaderName=function(e){e=Ko.nameKey.getID(e);if(-1===e)throw new Error("BaseMaterial: unknown shader name.");this._shaderCompile=g._preCompileShader[e]},s.cloneTo=function(e){e.name=this.name,e.cull=this.cull,e.blend=this.blend,e.srcBlend=this.srcBlend,e.dstBlend=this.dstBlend,e.srcBlendRGB=this.srcBlendRGB,e.dstBlendRGB=this.dstBlendRGB,e.srcBlendAlpha=this.srcBlendAlpha,e.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(e.blendConstColor),e.blendEquation=this.blendEquation,e.blendEquationRGB=this.blendEquationRGB,e.blendEquationAlpha=this.blendEquationAlpha,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.renderQueue=this.renderQueue,e._shader=this._shader,e._disablePublicShaderDefine=this._disablePublicShaderDefine,e._shaderDefineValue=this._shaderDefineValue;for(var t=0,n=e._shaderValues,i=(e._shaderValues.data.length=this._shaderValues.data.length,this._values.length),r=e._values,t=0,a=r.length=i;t<a;t++){var o,s,l=this._values[t];l&&("number"==typeof l||"boolean"==typeof l?(r[t]=l,n.data[t]=l):l instanceof laya.d3.math.Vector2?(o=r[t]||(r[t]=new ar),l.cloneTo(o),n.data[t]=o.elements):l instanceof laya.d3.math.Vector3?(o=r[t]||(r[t]=new W),l.cloneTo(o),n.data[t]=o.elements):l instanceof laya.d3.math.Vector4?(s=r[t]||(r[t]=new P),l.cloneTo(s),n.data[t]=s.elements):l instanceof laya.d3.math.Matrix4x4?(s=r[t]||(r[t]=new R),l.cloneTo(s),n.data[t]=s.elements):l instanceof laya.d3.resource.BaseTexture&&(r[t]=l,n.data[t]=l))}},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n(0,s,"alphaTestValue",function(){return this._getNumber(0)},function(e){this._setNumber(0,e)}),n(0,s,"alphaTest",function(){return this._alphaTest},function(e){(this._alphaTest=e)?this._addShaderDefine(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST):this._removeShaderDefine(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST)}),La.__init__=function(){La.SHADERDEFINE_ALPHATEST=La.shaderDefines.registerDefine("ALPHATEST")},La.RENDERQUEUE_OPAQUE=2e3,La.RENDERQUEUE_ALPHATEST=2450,La.RENDERQUEUE_TRANSPARENT=3e3,La.CULL_NONE=0,La.CULL_FRONT=1,La.CULL_BACK=2,La.BLEND_DISABLE=0,La.BLEND_ENABLE_ALL=1,La.BLEND_ENABLE_SEPERATE=2,La.BLENDPARAM_ZERO=0,La.BLENDPARAM_ONE=1,La.BLENDPARAM_SRC_COLOR=768,La.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,La.BLENDPARAM_DST_COLOR=774,La.BLENDPARAM_ONE_MINUS_DST_COLOR=775,La.BLENDPARAM_SRC_ALPHA=770,La.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,La.BLENDPARAM_DST_ALPHA=772,La.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,La.BLENDPARAM_SRC_ALPHA_SATURATE=776,La.BLENDEQUATION_ADD=0,La.BLENDEQUATION_SUBTRACT=1,La.BLENDEQUATION_REVERSE_SUBTRACT=2,La.DEPTHTEST_OFF=0,La.DEPTHTEST_NEVER=512,La.DEPTHTEST_LESS=513,La.DEPTHTEST_EQUAL=514,La.DEPTHTEST_LEQUAL=515,La.DEPTHTEST_GREATER=516,La.DEPTHTEST_NOTEQUAL=517,La.DEPTHTEST_GEQUAL=518,La.DEPTHTEST_ALWAYS=519,La.SHADERDEFINE_ALPHATEST=1,La.ALPHATESTVALUE=0,e(La,["shaderDefines",function(){return this.shaderDefines=new fr}]);var Na,Va=La;function La(){La.__super.call(this),this._shaderDefineValue=0,this._disablePublicShaderDefine=0,this._shaderValues=new gr,this._values=[],this.renderQueue=2e3,this._alphaTest=!1,this.cull=2,this.blend=0,this.srcBlend=1,this.dstBlend=0,this.srcBlendRGB=1,this.dstBlendRGB=0,this.srcBlendAlpha=1,this.dstBlendAlpha=0,this.blendConstColor=new P(1,1,1,1),this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=513,this.depthWrite=!0}t(Fa,"laya.d3.resource.BaseTexture",r),n(0,l=Fa.prototype,"width",function(){return this._width}),n(0,l,"repeat",function(){return this._repeat},function(e){this._repeat!==e&&(this._repeat=e,this._source)&&(e=c.mainContext,f.bindTexture(e,this._type,this._source),U.isPOT(this._width,this._height)&&this._repeat?(e.texParameteri(this._type,10242,10497),e.texParameteri(this._type,10243,10497)):(e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)))}),n(0,l,"height",function(){return this._height}),n(0,l,"magFifter",function(){return this._magFifter},function(e){(this._magFifter=e)!=this._magFifter&&this._conchTexture&&this._conchTexture.setMaxFifter(e)}),n(0,l,"wrapModeV",function(){return this._wrapModeV}),n(0,l,"size",function(){return this._size}),n(0,l,"wrapModeU",function(){return this._wrapModeU}),n(0,l,"mipmap",function(){return this._mipmap},function(e){this._mipmap=e,this._mipmap!=e&&this._conchTexture&&this._conchTexture.setMipMap(e)}),n(0,l,"minFifter",function(){return this._minFifter},function(e){this._minFifter=e,this._minFifter!=e&&this._conchTexture&&this._conchTexture.setMinFifter(e)}),n(0,l,"format",function(){return this._format}),n(0,l,"source",function(){return this.activeResource(),this._source}),n(0,l,"defaulteTexture",function(){return $s.grayTexture}),Fa.WARPMODE_REPEAT=0,Fa.WARPMODE_CLAMP=1;var wa=Fa;function Fa(){this._type=0,this._width=0,this._height=0,this._size=null,this._repeat=!1,this._mipmap=!1,this._minFifter=0,this._magFifter=0,this._format=0,this._source=null,this._conchTexture=null,this._wrapModeU=0,this._wrapModeV=0,Fa.__super.call(this),this._repeat=!0,this.mipmap=!0,this.minFifter=-1,this.magFifter=-1}t(Pa,"laya.d3.resource.models.BaseMesh",r),(D=Pa.prototype)._getPositions=function(){throw new Error("未Override,请重载该属性！")},D._generateBoundingObject=function(){this._boundingSphere=new Gi(new W,0),Gi.createfromPoints(this._positions,this._boundingSphere),this._boundingBox=new bi(new W,new W),bi.createfromPoints(this._positions,this._boundingBox),this._boundingBox.getCorners(this._boundingBoxCorners)},D.getRenderElementsCount=function(){throw new Error("未Override,请重载该属性！")},D.getRenderElement=function(e){throw new Error("未Override,请重载该属性！")},n(0,D,"subMeshCount",function(){return this._subMeshCount}),n(0,D,"boundingBox",function(){return this._boundingBox}),n(0,D,"boundingBoxCorners",function(){return this._boundingBoxCorners}),n(0,D,"boundingSphere",function(){return this._boundingSphere});u=Pa;function Pa(){this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,this._positions=null,Pa.__super.call(this),this._boundingBoxCorners=w(8,null)}t(Ba,"laya.d3.terrain.TerrainHeightData",r),Ba.prototype.onAsynLoaded=function(e,t,n){this._width=n[0],this._height=n[1],this._bitType=n[2],this._value=n[3];var i,r=NaN;8==this._bitType?(i=new Uint8Array(t),r=1/255):16==this._bitType&&(i=new Int16Array(t),r=1/32766),this._terrainHeightData=new Float32Array(this._height*this._width);for(var a=0,o=this._height*this._width;a<o;a++)this._terrainHeightData[a]=i[a]*r*this._value/2;this._endLoaded()},Ba.load=function(e,t,n,i,r){return v.loader.create(e,null,null,Ba,[t,n,i,r],1,!1)};var ba=Ba;function Ba(){this._terrainHeightData=null,this._width=0,this._height=0,this._bitType=0,this._value=NaN,Ba.__super.call(this)}t(Ha,"laya.d3.terrain.TerrainRes",r),(s=Ha.prototype).parseData=function(e){var t=e[0],n=e[1];if(this._version=t.version,1==this._version){this._cameraCoordinateInverse=t.cameraCoordinateInverse,this._gridSize=t.gridSize,this._chunkNumX=t.chunkNumX,this._chunkNumZ=t.chunkNumZ;var i,e=t.heightData,r=(this._heightDataX=e.numX,this._heightDataZ=e.numZ,this._heightDataBitType=e.bitType,this._heightDataValue=e.value,this._heightDataUrl=n[e.url],this._materialInfo=new Ar,t.material&&(e=t.material.ambient,l=t.material.diffuse,i=t.material.specular,this._materialInfo.ambientColor=new W(e[0],e[1],e[2]),this._materialInfo.diffuseColor=new W(l[0],l[1],l[2]),this._materialInfo.specularColor=new P(i[0],i[1],i[2],i[3])),t.detailTexture);this._detailTextureInfos=w(r.length);for(var a=0;a<r.length;a++){var o=r[a],s=new Rr;s.diffuseTexture=n[o.diffuse],s.normalTexture=o.normal?n[o.normal]:null,o.scale?s.scale=new ar(o.scale[0],o.scale[1]):s.scale=new ar(1,1),o.offset?s.offset=new ar(o.offset[0],o.offset[1]):s.offset=new ar(0,0),this._detailTextureInfos[a]=s}e=t.alphaMap;for(this._alphaMaps=w(e.length),a=0;a<this._alphaMaps.length;a++)this._alphaMaps[a]=t.alphaMap[a];var l=t.normalMap;for(this._normalMaps=w(l.length),a=0;a<this._normalMaps.length;a++)this._normalMaps[a]=t.normalMap[a];var h=t.chunkInfo;if(this._chunkNumX*this._chunkNumZ!=h.length)return alert("terrain data error"),!1;for(this._chunkInfos=w(h.length),a=0;a<h.length;a++){var _=h[a],u=new xr,d=_.alphaMap.length,c=_.detailID.length;if(d!=c)return alert("terrain chunk data error"),!1;u.alphaMap=w(d),u.detailID=w(c),u.normalMap=n[this._normalMaps[_.normalMap]];for(var f=0;f<d;f++){u.alphaMap[f]=n[this._alphaMaps[_.alphaMap[f]]];var m=_.detailID[f],p=m.length;u.detailID[f]=new Uint8Array(p);for(var E=0;E<p;E++)u.detailID[f][E]=m[E]}this._chunkInfos[a]=u}this._heightData=K.getRes(this._heightDataUrl),this.onLoadTerrainComplete(this._heightData)}return!0},s.onLoadTerrainComplete=function(e){this._endLoaded()},s.onAsynLoaded=function(e,t,n){this.parseData(t)},Ha.load=function(e){return v.loader.create(e,null,null,Ha,null,1,!1)};var Ua=Ha;function Ha(){this._version=NaN,this._cameraCoordinateInverse=!1,this._gridSize=NaN,this._chunkNumX=0,this._chunkNumZ=0,this._heightDataX=0,this._heightDataZ=0,this._heightDataBitType=0,this._heightDataValue=NaN,this._heightDataUrl=null,this._detailTextureInfos=null,this._chunkInfos=null,this._heightData=null,this._materialInfo=null,this._alphaMaps=null,this._normalMaps=null,Ha.__super.call(this)}t(za,"laya.d3.component.animation.KeyframeAnimations",Ga=d),(l=za.prototype)._updateAnimtionPlayer=function(){this._player._update(v.timer.delta)},l._addUpdatePlayerToTimer=function(){v.timer.frameLoop(1,this,this._updateAnimtionPlayer)},l._removeUpdatePlayerToTimer=function(){v.timer.clear(this,this._updateAnimtionPlayer)},l._onOwnerActiveHierarchyChanged=function(e){this._owner.displayedInStage&&(e?this._addUpdatePlayerToTimer():this._removeUpdatePlayerToTimer())},l._load=function(e){e.activeInHierarchy&&this._addUpdatePlayerToTimer(),e.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)},l._unload=function(e){Ga.prototype._unload.call(this,e),e.activeInHierarchy&&this._removeUpdatePlayerToTimer(),e.off("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._player._destroy(),this._player=null,this._templet=null},n(0,l,"url",null,function(e){console.log("Warning: discard property,please use templet property instead.");e=v.loader.create(e,null,null,B);this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this.event("animationchanged",this))}),n(0,l,"player",function(){return this._player}),n(0,l,"templet",function(){return this._templet},function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this.event("animationchanged",this))}),n(0,l,"currentFrameIndex",function(){return this._player.currentKeyframeIndex}),n(0,l,"currentAnimationClipIndex",function(){return this._player.currentAnimationClipIndex}),n(0,l,"nodeCount",function(){return this._templet.getNodeCount(this._player.currentAnimationClipIndex)});var Ga,D=za;function za(){this._player=null,this._templet=null,za.__super.call(this),this._player=new F}t(Xa,"laya.d3.component.Animator",Wa=d),r=Xa.prototype,v.imps(r,{"laya.resource.IDestroy":!0}),r._getAvatarOwnersByClip=function(e){var t=this._clips[e]._nodes,n=t.length,i=this._cacheNodesAvatarOwners[e],r=(i.length=n,this._cacheNodesDefaultlValues[e]);r.length=n;for(var a=0;a<n;a++){for(var o=this._avatarNodes[0],s=t[a],l=s.path,h=0,_=l.length;h<_;h++){var u=l[h];if(""===u)break;if(!(o=o.getChildByName(u)))break}if(o){i[a]=o;var d=de._propertyGetFuncs[s.propertyNameID](o);if(d){var c=new Float32Array(s.keyFrameWidth);for(r[a]=c,h=0,_=d.length;h<_;h++)c[h]=d[h]}}}},r._handleSpriteOwnersByClip=function(e){var t=this._clips[e]._nodes,n=t.length,i=this._cacheNodesSpriteOwners[e],r=(i.length=n,this._cacheNodesDefaultlValues[e]);r.length=n;for(var a=0;a<n;a++){for(var o=this._owner,s=t[a],l=s.path,h=0,_=0,h=0,_=l.length;h<_;h++){var u=l[h];if(""===u)break;if(!(o=o.getChildByName(u)))break}if(o){i[a]=o;var d=de._propertyGetFuncs[s.propertyNameID](null,o);if(d){var c=new Float32Array(s.keyFrameWidth);for(r[a]=c,h=0,_=d.length;h<_;h++)c[h]=d[h]}}}},r._offClipAndAvatarRelateEvent=function(e,t){e.loaded?t.loaded||t.off("loaded",this,this._getAvatarOwnersByClip):e.off("loaded",this,this._getAvatarOwnersAndInitDatasAsync)},r._getAvatarOwnersByClipAsync=function(e,t){t.loaded?this._getAvatarOwnersByClip(e):t.once("loaded",this,this._getAvatarOwnersByClip,[e])},r._offGetSpriteOwnersByClipAsyncEvent=function(e){e.loaded||e.off("loaded",this,this._getSpriteOwnersByClipAsync)},r._getSpriteOwnersByClipAsync=function(e,t){t.loaded?this._handleSpriteOwnersByClip(e):t.once("loaded",this,this._handleSpriteOwnersByClip,[e])},r._getAvatarOwnersAndInitDatasAsync=function(){for(var e=0,t=this._clips.length;e<t;e++)this._getAvatarOwnersByClipAsync(e,this._clips[e]);for(this._avatar._cloneDatasToAnimator(this),e=0,t=this._avatarNodes.length;e<t;e++)this._checkAnimationNode(this._avatarNodes[e],this._owner)},r._offGetClipCacheFullKeyframeIndicesEvent=function(e){e.loaded||e.off("loaded",this,this._computeCacheFullKeyframeIndices)},r._computeCacheFullKeyframeIndices=function(e){var t=this._clips[e],n=this._cacheFrameRateInterval*this._cachePlayRate;if(i=t._getFullKeyframeIndicesWithCache(n))this._cacheFullFrames[e]=i;else{for(var i=this._cacheFullFrames[e]=[],r=t._nodes,a=r.length,o=(i.length=a,Math.ceil(t._duration/n-1e-5)+1),s=0;s<a;s++){for(var l=r[s],h=new Int32Array(o),_=(h.fill(-1),l.keyFrames),u=0,d=_.length;u<d;u++)for(var c=_[u],f=c.startTime,m=f+c.duration;f<=m;)h[Math.ceil(f/n-1e-5)]=u,f+=n;i[s]=h}t._cacheFullKeyframeIndices(n,i)}},r._updateAnimtionPlayer=function(){this._updatePlayer(v.timer.delta/1e3)},r._onOwnerActiveHierarchyChanged=function(){this._owner.activeInHierarchy?(v.timer.frameLoop(1,this,this._updateAnimtionPlayer),this.playOnWake&&this.clip&&this.play()):(0!==this.playState&&(this._stoped=!0),v.timer.clear(this,this._updateAnimtionPlayer))},r._eventScript=function(e,t){for(var n=this._currentPlayClip._animationEvents,i=n.length;this._playEventIndex<i;this._playEventIndex++){var r=n[this._playEventIndex],a=r.time;if(!(e<=a&&a<t))break;for(var o=this._owner._scripts,s=0,l=o.length;s<l;s++){var h=o[s],_=h[r.eventName];_&&_.apply(h,r.params)}}},r._setPlayParams=function(e,t){var n=this._currentTime;this._currentTime=e,this._currentFrameIndex=Math.max(Math.floor(this.currentPlayTime/t-1e-5),0),this._currentFrameTime=this._currentFrameIndex*t,this._eventScript(n,e)},r._setPlayParamsWhenStop=function(e,t){var n=this._currentTime;this._currentTime=e,this._currentFrameIndex=Math.max(Math.floor(e/t-1e-5),0),this._currentFrameTime=this._currentFrameIndex*t,this._eventScript(n,e),this._currentPlayClip=null},r._revertKeyframeNodes=function(e,t){var n=this._cacheNodesDefaultlValues[t],i=e._nodes;if(this._avatar)for(var r=this._cacheNodesAvatarOwners[t],a=0,o=r.length;a<o;a++){var s=r[a];s&&de._propertySetFuncs[i[a].propertyNameID](s,null,n[a])}else for(var l=this._cacheNodesSpriteOwners[t],a=0,o=l.length;a<o;a++){var h=l[a];h&&de._propertySetFuncs[i[a].propertyNameID](null,h,n[a])}},r._onAnimationStop=function(){var e=0,t=0,n=(this._lastFrameIndex=-1,this._currentPlayClip._nodes);if(this._avatar)for(var i=this._cacheNodesAvatarOwners[this._currentPlayClipIndex],e=0,t=i.length;e<t;e++){var r,a,o=i[e],s=(a=(r=n[e]).keyFrames)[a.length-1].data;o&&de._propertySetFuncs[r.propertyNameID](o,null,s)}else{var l=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];for(e=0,t=l.length;e<t;e++){var h=l[e];s=(a=(r=n[e]).keyFrames)[a.length-1].data,h&&de._propertySetFuncs[r.propertyNameID](null,h,s)}}},r._setAnimationClipPropertyToAnimationNode=function(e,t,n){for(var i=0,r=t.length;i<r;i++){var a,o=t[i],s=e[o];s&&(a=this._currentPlayClip._nodes[o],o=n[o])&&de._propertySetFuncs[a.propertyNameID](s,null,o)}},r._setAnimationClipPropertyToSprite3D=function(e,t){for(var n=0,i=e.length;n<i;n++){var r,a,o=e[n];o&&(r=this._currentPlayClip._nodes[n],a=t[n])&&de._propertySetFuncs[r.propertyNameID](null,o,a)}},r._handleSpriteOwnersBySprite=function(e,t,n,i){var r=this._clips[e],n=n.join("/"),a=r._nodesMap[n];if(a)for(var o=this._cacheNodesSpriteOwners[e],s=r._nodes,l=this._cacheNodesDefaultlValues[e],h=0,_=a.length;h<_;h++){var u=a[h],d=s.indexOf(u);if(t){o[d]=i;var c=de._propertyGetFuncs[u.propertyNameID](null,i);if(c){var f=l[d];f||(l[d]=f=new Float32Array(u.keyFrameWidth));for(var m=0,p=c.length;m<p;m++)f[m]=c[m]}}else o[d]=null}},r._evaluateAvatarNodesCacheMode=function(e,t,n,i,r){t._evaluateAnimationlDatasCacheMode(e,this._cacheFullFrames[this._currentPlayClipIndex],this,n,r),this._setAnimationClipPropertyToAnimationNode(e,r,n);for(var a=0,o=this._avatarNodes.length;a<o;a++){var s,l=this._avatarNodes[a].transform;l._worldUpdate?(s=new Float32Array(16),i[a]=s,l._setWorldMatrixAndUpdate(s)):(s=l.getWorldMatrix(),i[a]=s||Xa.deafaultMatrix)}},r._evaluateAvatarNodesRealTime=function(e,t,n,i,r){t._evaluateAnimationlDatasRealTime(e,this.currentPlayTime,n,r),this._setAnimationClipPropertyToAnimationNode(e,r,n);for(var a=0,o=this._avatarNodes.length;a<o;a++){var s=this._avatarNodes[a].transform;s._worldUpdate?s._setWorldMatrixNoUpdate(i[a]):i[a]=Xa.deafaultMatrix}},r._updateAvatarNodesToSpriteCacheMode=function(e,t){for(var n=0,i=this._cacheSpriteToNodesMap.length;n<i;n++){var r,a=this._cacheSpriteToNodesMap[n],o=t[a];o!==Xa.deafaultMatrix&&(r=(a=this._avatarNodes[a].transform._entity).worldMatrix,br.matrix4x4MultiplyMFM(this._owner._transform.worldMatrix,o,r),a.worldMatrix=r)}},r._updateAvatarNodesToSpriteRealTime=function(){for(var e=0,t=this._cacheSpriteToNodesMap.length;e<t;e++){var n,i=this._avatarNodes[this._cacheSpriteToNodesMap[e]],r=i.transform._entity,i=i.transform;i._worldUpdate&&(i._setWorldMatrixAndUpdate(i=Xa._tempMatrix4x40),n=r.worldMatrix,br.matrix4x4MultiplyMFM(this._owner._transform.worldMatrix,i,n),r.worldMatrix=n)}},r._updatePlayer=function(e){if(null!=this._currentPlayClip&&!this._stoped&&this._currentPlayClip.loaded){var t=this._cacheFrameRateInterval*this._cachePlayRate,n=0,e=(this._startUpdateLoopCount!==T.loopCount&&(n=e*this.playbackRate,this._elapsedPlaybackTime+=n),this._currentPlayClip._frameRate),i=this._playStartFrames[this._currentPlayClipIndex]/e,r=Math.min(this._playEndFrames[this._currentPlayClipIndex]/e,this._currentPlayClip._duration)-i;if(!this._currentPlayClip.islooping&&this._elapsedPlaybackTime>=r)this._onAnimationStop(),this._setPlayParamsWhenStop(r,t),this.event("stopped");else if(n+=this._currentTime,0<r)if(r<=n)for(;(n-=r)<r&&(this._setPlayParams(n,t),this.event("complete")),this._playEventIndex=0,this._eventScript(0,n),r<=n;);else this._setPlayParams(n,t);else this._currentTime=this._currentFrameTime=this._currentFrameIndex=this._playEventIndex=0,this.event("complete")}},r._update=function(e){var t=this._currentPlayClip;if(2===this.playState&&t&&t.loaded){var n=this.playbackRate*v.timer.scale,i=this._cachePlayRate,n=(this._canCache=this.isCache&&i<=n,-1);if(this._canCache){if(n=this._currentFrameIndex,this._lastFrameIndex===n)return;var r,a,o,s=t._getAnimationDataWithCache(i,n);this._avatar?(r=this._cacheNodesAvatarOwners[this._currentPlayClipIndex],0<(o=(a=t._cachePropertyMap).length)&&(s||((s=[]).length=o,t._cacheAnimationData(i,n,s),t._evaluateAnimationlDatasCacheMode(r,this._cacheFullFrames[this._currentPlayClipIndex],this,s,a)),this._setAnimationClipPropertyToAnimationNode(r,a,s)),this._curAvatarNodeDatas=t._getAvatarDataWithCache(this._avatar,this._cachePlayRate,n),this._curAvatarNodeDatas||(this._curAvatarNodeDatas=[],this._curAvatarNodeDatas.length=this._avatarNodes.length,t._cacheAvatarData(this._avatar,this._cachePlayRate,n,this._curAvatarNodeDatas),this._evaluateAvatarNodesCacheMode(r,t,t._publicClipDatas,this._curAvatarNodeDatas,t._unCachePropertyMap)),this._updateAvatarNodesToSpriteCacheMode(t,this._curAvatarNodeDatas)):(o=this._cacheNodesSpriteOwners[this._currentPlayClipIndex],s||((s=[]).length=this._currentPlayClip._nodes.length,t._evaluateAnimationlDatasCacheMode(o,this._cacheFullFrames[this._currentPlayClipIndex],this,s,null),t._cacheAnimationData(i,n,s)),this._setAnimationClipPropertyToSprite3D(o,s))}else if(s=t._publicClipDatas,this._avatar){if(t._evaluateAnimationlDatasRealTime(this._cacheNodesAvatarOwners[this._currentPlayClipIndex],this.currentPlayTime,s,t._cachePropertyMap),!this._publicAvatarNodeDatas){this._publicAvatarNodeDatas=[];var l=this._avatarNodes.length;this._publicAvatarNodeDatas.length=l;for(var h=1;h<l;h++)this._publicAvatarNodeDatas[h]=new Float32Array(16)}this._curAvatarNodeDatas=this._publicAvatarNodeDatas,this._evaluateAvatarNodesRealTime(this._cacheNodesAvatarOwners[this._currentPlayClipIndex],t,s,this._curAvatarNodeDatas,t._unCachePropertyMap),this._updateAvatarNodesToSpriteRealTime()}else t._evaluateAnimationlDatasRealTime(this._cacheNodesSpriteOwners[this._currentPlayClipIndex],this.currentPlayTime,s,null);this._lastFrameIndex=n}},r._checkAnimationNode=function(e,t){e.name!==t.name||t._transform.dummy||t._isLinkSpriteToAnimationNode(this,e,!0);for(var n=0,i=t._childs.length;n<i;n++)this._checkAnimationNode(e,t.getChildAt(n))},r._load=function(e){e.activeInHierarchy&&v.timer.frameLoop(1,this,this._updateAnimtionPlayer),this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)},r._unload=function(e){Wa.prototype._unload.call(this,e),e.activeInHierarchy&&v.timer.clear(this,this._updateAnimtionPlayer),this._owner.off("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._curAvatarNodeDatas=null},r._destroy=function(){Wa.prototype._destroy.call(this);for(var e=0,t=this._clips.length;e<t;e++)this._clips[e]._removeReference();this._currentPlayClip=null,this._clipNames=null,this._cacheNodesSpriteOwners=null,this._cacheNodesAvatarOwners=null,this._cacheNodesDefaultlValues=null,this._clips=null,this._cacheFullFrames=null},r._cloneTo=function(e){for(var t=e,n=(t.avatar=this.avatar,this._clips.length,0),i=this._clips.length;n<i;n++)t.addClip(this._clips[n]);if(this.clip&&(t.clip=this.clip),this._linkSpritesData)for(var r in t._linkSpritesData={},this._linkSpritesData)t._linkSpritesData[r]=this._linkSpritesData[r].slice()},r.addClip=function(e,t,n,i){void 0===n&&(n=0),void 0===i&&(i=4294967295),t=t||e.name;var r=this._clipNames.indexOf(t);if(-1!==r){if(this._clips[r]!==e)throw new Error("Animation:this playName has exist with another clip.")}else{this._clips.indexOf(e);if(n<0||i<0)throw new Error("Animator:startFrame and endFrame must large than zero.");if(i<n)throw new Error("Animator:startFrame must less than endFrame.");this._clipNames.push(t),this._clips.push(e),this._playStartFrames.push(n),this._playEndFrames.push(i),this._cacheNodesSpriteOwners.push([]),this._cacheNodesAvatarOwners.push([]),this._cacheNodesDefaultlValues.push([]),this._publicClipsDatas.push([]),e._addReference(),r=this._clips.length-1,this._avatar?this._avatar.loaded?this._getAvatarOwnersByClipAsync(r,e):this._avatar.once("loaded",this,this._getAvatarOwnersByClipAsync,[r,e]):this._getSpriteOwnersByClipAsync(r,e),e.loaded?this._computeCacheFullKeyframeIndices(r):e.once("loaded",this,this._computeCacheFullKeyframeIndices,[r])}},r.removeClip=function(e){var t=this._clips.indexOf(e);-1!==t&&(this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,e):this._offGetSpriteOwnersByClipAsyncEvent(e),this._offGetClipCacheFullKeyframeIndicesEvent(e),this._clipNames.splice(t,1),this._clips.splice(t,1),this._playStartFrames.splice(t,1),this._playEndFrames.splice(t,1),this._cacheNodesSpriteOwners.splice(t,1),this._cacheNodesAvatarOwners.splice(t,1),this._cacheNodesDefaultlValues.splice(t,1),this._publicClipsDatas.splice(t,1),e._removeReference())},r.removeClipByName=function(e){var t,e=this._clipNames.indexOf(e);-1!==e&&(t=this._clips[e],this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,t):this._offGetSpriteOwnersByClipAsyncEvent(t),this._offGetClipCacheFullKeyframeIndicesEvent(t),this._clipNames.splice(e,1),this._clips.splice(e,1),this._playStartFrames.splice(e,1),this._playEndFrames.splice(e,1),this._cacheNodesSpriteOwners.splice(e,1),this._cacheNodesAvatarOwners.splice(e,1),this._cacheNodesDefaultlValues.splice(e,1),this._publicClipsDatas.splice(e,1))},r.getClip=function(e){e=this._clipNames.indexOf(e);return-1!==e?this._clips[e]:null},r.getClipCount=function(){return this._clips.length},r.play=function(e,t){if(void 0===t&&(t=1),!e&&-1==this._defaultClipIndex)throw new Error("Animator:must have  default clip value,please set clip property.");e?(this._currentPlayClipIndex=this._clipNames.indexOf(e),this._currentPlayClip=this._clips[this._currentPlayClipIndex]):(this._currentPlayClipIndex=this._defaultClipIndex,this._currentPlayClip=this._clips[this._defaultClipIndex]),this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this._playEventIndex=0,this.playbackRate=t,this._stoped=!1,this._currentFrameIndex=0,this._startUpdateLoopCount=T.loopCount,this._lastPlayAnimationClip&&this._lastPlayAnimationClip!==this._currentPlayClip&&this._revertKeyframeNodes(this._lastPlayAnimationClip,this._lastPlayAnimationClipIndex),this._updatePlayer(0),this._lastPlayAnimationClip=this._currentPlayClip,this._lastPlayAnimationClipIndex=this._currentPlayClipIndex},r.stop=function(){0!==this.playState&&(this._stoped=!0,this.event("stopped"))},r._getLinkSpritePath=function(e,t){t.unshift(e.name);e=e._parent;e._hierarchyAnimator===this?this._getLinkSpritePath(e,t):t.shift()},r.linkSprite3DToAvatarNode=function(e,t){var n,i;if(t._hierarchyAnimator===this)return!!this._avatar&&!!(n=this._avatarNodeMap[e])&&(this._linkSpritesData=this._linkSpritesData||{},this._getLinkSpritePath(t,i=[]),this._linkSpritesData[e]=i,t._isLinkSpriteToAnimationNode(this,n,!0),!0);throw"Animator:sprite3D must belong to this Animator"},r.unLinkSprite3DToAvatarNode=function(e){var t;return!!this._avatar&&!!(t=e.transform.dummy)&&(t=this._avatarNodeMap[t._owner.name],e._isLinkSpriteToAnimationNode(this,t,!1),!0)},n(0,r,"playState",function(){return null==this._currentPlayClip||this._stoped?0:2}),n(0,r,"avatar",function(){return this._avatar},function(e){if(this._avatar!==e){for(var t=this._avatar,n=(this._avatar=e,this._clips.length),i=0;i<n;i++)this._offClipAndAvatarRelateEvent(t,this._clips[i]);e&&(e.loaded?this._getAvatarOwnersAndInitDatasAsync():e.once("loaded",this,this._getAvatarOwnersAndInitDatasAsync))}}),n(0,r,"cacheFrameRate",function(){return this._cacheFrameRate},function(e){if(this._cacheFrameRate!==e){this._cacheFrameRate=e,this._cacheFrameRateInterval=1/this._cacheFrameRate;for(var t=0,n=this._clips.length;t<n;t++)this._clips[t].loaded&&this._computeCacheFullKeyframeIndices(t)}}),n(0,r,"clip",function(){return this._clips[this._defaultClipIndex]},function(e){var t=e?this._clips.indexOf(e):-1;this._defaultClipIndex!==t&&(-1!==this._defaultClipIndex&&this.removeClip(this._clips[this._defaultClipIndex]),-1!==t&&this.addClip(e,e.name),this._defaultClipIndex=t)}),n(0,r,"currentFrameIndex",function(){return this._currentFrameIndex}),n(0,r,"cachePlayRate",function(){return this._cachePlayRate},function(e){if(this._cachePlayRate!==e){this._cachePlayRate=e;for(var t=0,n=this._clips.length;t<n;t++)this._clips[t].loaded&&this._computeCacheFullKeyframeIndices(t)}}),n(0,r,"currentFrameTime",function(){return this._currentFrameTime}),n(0,r,"currentPlayClip",function(){return this._currentPlayClip}),n(0,r,"currentPlayTime",function(){return this._currentTime+this._playStartFrames[this._currentPlayClipIndex]/this._currentPlayClip._frameRate}),n(0,r,"playbackTime",null,function(e){var t;null!=this._currentPlayClip&&this._currentPlayClip&&this._currentPlayClip.loaded&&(this._startUpdateLoopCount=T.loopCount,t=this._cacheFrameRateInterval*this._cachePlayRate,this._currentTime=e,this._currentFrameIndex=Math.floor(this.currentPlayTime/t),this._currentFrameTime=this._currentFrameIndex*t)}),n(0,r,"paused",function(){return this._stoped},function(e){(this._stoped=e)&&this.event("paused")}),e(Xa,["deafaultMatrix",function(){return this.deafaultMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Float32Array(16)}]);var Wa,ka=Xa;function Xa(){Xa.__super.call(this),this._clipNames=[],this._clips=[],this._playStartFrames=[],this._playEndFrames=[],this._cacheNodesSpriteOwners=[],this._cacheNodesAvatarOwners=[],this._cacheNodesDefaultlValues=[],this._cacheNodesToSpriteMap=[],this._cacheSpriteToNodesMap=[],this._cacheFullFrames=[],this._publicClipsDatas=[],this._playEventIndex=-1,this._updateTransformPropertyLoopCount=-1,this._lastFrameIndex=-1,this._defaultClipIndex=-1,this._cachePlayRate=1,this._currentPlayClip=null,this._currentFrameIndex=-1,this._currentTime=0,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this.isCache=!0,this.cacheFrameRate=60,this.playbackRate=1,this.playOnWake=!0}var Ya;t(Za,"laya.d3.component.AttachPoint",Ya=d),(s=Za.prototype)._load=function(e){Ya.prototype._load.call(this,e),this._attachSkeleton=e.getComponentByType(bs)},s._update=function(e){if(this._attachSkeleton&&!this._attachSkeleton.destroyed&&0!==this._attachSkeleton.player.state&&this._attachSkeleton.curBonesDatas){for(var t=this._attachSkeleton.player,n=this._attachSkeleton.templet,i=(this.matrixs.length=this.attachBones.length,this._attachSkeleton.curBonesDatas),r=this.owner.transform.worldMatrix,a=0,o=this.attachBones.length;a<o;a++){for(var s=16*n.getNodeIndexWithName(t.currentAnimationClipIndex,this.attachBones[a]),l=this.matrixs[a],h=(l=l||(this.matrixs[a]=new R)).elements,_=0;_<16;_++)h[_]=i[s+_];R.multiply(r,l,l)}this.event("complete")}};function Za(){this._attachSkeleton=null,this._extenData=null,this.attachBones=null,this.matrixs=null,Za.__super.call(this),this.attachBones=[],this.matrixs=[]}t(ja,"laya.d3.component.physics.Collider",l=d),(r=ja.prototype)._clearCollsionMap=function(){for(var e in this._runtimeCollisonMap){e=this._runtimeCollisonMap[e],e=(delete e._runtimeCollisonMap[this.id],e._isRigidbody&&delete e._runtimeCollisonTestMap[this.id],e.id);delete this._runtimeCollisonMap[e],this._isRigidbody&&delete this._runtimeCollisonTestMap[e]}},r._unload=function(e){for(var t in this._runtimeCollisonMap){var n=this._runtimeCollisonMap[t];delete n._runtimeCollisonMap[this.id],n._isRigidbody&&delete n._runtimeCollisonTestMap[this.id],delete this._ignoreCollisonMap[t]._ignoreCollisonMap[this.id]}},r._setIsRigidbody=function(e){this._isRigidbody!==e&&(this._isRigidbody=e,(e=this._owner).displayedInStage)&&((e=e.layer)._removeCollider(this),e._addCollider(this))},r._getType=function(){return-1},r._collisonTo=function(e){return!1},r.raycast=function(e,t,n){throw void 0===n&&(n=179e306),new Error("Collider:Must override it.")},n(0,r,"enable",l.prototype._$get_enable,function(e){this._enable!==e&&(this._owner.displayedInStage&&!e&&this._clearCollsionMap(),this._enable=e,this.event("enablechanged",this._enable))}),n(0,r,"isSingleton",function(){return ja._isSingleton}),ja._isSingleton=!1;s=ja;function ja(){ja.__super.call(this),this._isRigidbody=!1,this._runtimeCollisonMap={},this._runtimeCollisonTestMap={},this._ignoreCollisonMap={},this.isTrigger=!0}t(qa,"laya.d3.component.Rigidbody",l=d),n(0,qa.prototype,"enable",l.prototype._$get_enable,function(e){if(this._enable!==e){for(var t=this._owner._colliders,n=0,i=t.length;n<i;n++){var r=t[n],a=(r._setIsRigidbody(e),r._runtimeCollisonMap),o=r._runtimeCollisonTestMap;if(!e)for(var s in a)delete o[s]}this._enable=e,this.event("enablechanged",this._enable)}});var Ka=qa;function qa(){qa.__super.call(this)}t(Qa,"laya.d3.component.Script",d),(r=Qa.prototype).onTriggerEnter=function(e){},r.onTriggerExit=function(e){},r.onTriggerStay=function(e){},n(0,r,"isSingleton",function(){return Qa._isSingleton}),Qa._isSingleton=!1;function Qa(){Qa.__super.call(this)}t(Ja,"laya.d3.core.GlitterRender",Xr),(l=Ja.prototype)._calculateBoundingBox=function(){var e=this._boundingBox.min.elements,e=(e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE,this._boundingBox.min.elements);e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},l._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},l._renderUpdate=function(e){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);e=this._owner.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,e),e=this._owner.templet;return this._setShaderValueNumber(3,e.lifeTime),this._setShaderValueNumber(2,e._currentTime),!0};var $a=Ja;function Ja(e){Ja.__super.call(this,e)}t(no,"laya.d3.core.MeshFilter",eo=Wr),(d=no.prototype)._sharedMeshLoaded=function(){this.event("loaded")},d._destroy=function(){eo.prototype._destroy.call(this),this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)},n(0,d,"sharedMesh",function(){return this._sharedMesh},function(e){var t=this._sharedMesh;t&&t._removeReference(),(this._sharedMesh=e)._addReference(),this.event("meshchanged",[this,t,e]),e.loaded||this._sharedMesh.once("loaded",this,this._sharedMeshLoaded)}),n(0,d,"_isAsyncLoaded",function(){return this._sharedMesh.loaded}),n(0,d,"_originalBoundingBoxCorners",function(){return this._sharedMesh.boundingBoxCorners}),n(0,d,"_originalBoundingSphere",function(){return this._sharedMesh.boundingSphere}),n(0,d,"_originalBoundingBox",function(){return this._sharedMesh.boundingBox});var eo,to=no;function no(e){this._owner=null,this._sharedMesh=null,no.__super.call(this),this._owner=e}t(ro,"laya.d3.core.MeshRender",Xr),(r=ro.prototype)._onMeshChanged=function(e,t,n){n.loaded?this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0:n.once("loaded",this,this._onMeshLoaed)},r._onMeshLoaed=function(e,t){this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0},r._calculateBoundingSphereByInitSphere=function(e){var t=NaN,n=this._owner.transform,i=n.scale.elements,r=Math.abs(i[0]),a=Math.abs(i[1]),i=Math.abs(i[2]),t=a<=r&&i<=r?r:i<=a?a:i;W.transformCoordinate(e.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*t},r._calculateBoundBoxByInitCorners=function(e){for(var t=this._owner.transform.worldMatrix,n=0;n<8;n++)W.transformCoordinate(e[n],t,Xr._tempBoundBoxCorners[n]);bi.createfromPoints(Xr._tempBoundBoxCorners,this._boundingBox)},r._calculateBoundingSphere=function(){var e=this._owner.meshFilter.sharedMesh;null==e||null==e.boundingSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(e.boundingSphere)},r._calculateBoundingBox=function(){var e=this._owner.meshFilter.sharedMesh;null==e||null==e.boundingBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(e.boundingBoxCorners)},r._renderUpdate=function(e){var t=this._owner.transform;return t?(this._setShaderValueMatrix4x4(0,t.worldMatrix),t=this._owner.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,t)):(this._setShaderValueMatrix4x4(0,R.DEFAULT),this._setShaderValueMatrix4x4(1,e)),Ur.debugMode&&this._renderRenderableBoundBox(),!0};var io=ro;function ro(e){ro.__super.call(this,e),e.meshFilter.on("meshchanged",this,this._onMeshChanged)}t(so,"laya.d3.core.particleShuriKen.ShurikenParticleSystem",ao=Wr),l=so.prototype,v.imps(l,{"laya.d3.core.render.IRenderable":!0,"laya.d3.core.IClone":!0}),l._getVertexBuffer=function(e){return 0===(e=void 0===e?0:e)?this._vertexBuffer:null},l._getIndexBuffer=function(){return this._indexBuffer},l._generateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},l._generateBoundingBox=function(){var e=this._owner.particleRender,t=this._boundingBox.min,n=this._boundingBox.max,i=0,r=0,a=NaN;switch(this.startLifetimeType){case 0:a=this.startLifetimeConstant;break;case 1:for(var P,a=-Number.MAX_VALUE,i=0,r=P.gradientCount;i<r;i++)a=Math.max(a,P.getValueByIndex(i));break;case 2:a=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:a=-Number.MAX_VALUE;var b;for(i=0,r=b.gradientCount;i<r;i++)a=Math.max(a,b.getValueByIndex(i));var B;for(i=0,r=B.gradientCount;i<r;i++)a=Math.max(a,B.getValueByIndex(i))}var o,s,l,h,_=NaN,u=NaN;switch(this.startSpeedType){case 0:_=u=this.startSpeedConstant;break;case 1:break;case 2:_=this.startLifetimeConstantMin,u=this.startLifetimeConstantMax}this._shape&&this._shape.enable||(o=s=W.ZERO,l=W.ZERO,h=W.UnitZ);var d,c=new W(l.x*_,l.y*_,l.z*_),f=new W(h.x*u,h.y*u,h.z*u);if(this._velocityOverLifetime&&this._velocityOverLifetime.enbale){var m=this._velocityOverLifetime.velocity;switch(m.type){case 0:m.constant;break;case 1:new W(m.gradientX.getAverageValue(),m.gradientY.getAverageValue(),m.gradientZ.getAverageValue());break;case 2:m.constantMin,m.constantMax;break;case 3:new W(m.gradientXMin.getAverageValue(),m.gradientYMin.getAverageValue(),m.gradientZMin.getAverageValue()),new W(m.gradientXMax.getAverageValue(),m.gradientYMax.getAverageValue(),m.gradientZMax.getAverageValue())}}var p,E,g=this._owner.transform,U=g.position,v=so._tempVector39,T=v.elements,S=e.renderMode;switch(this.scaleMode){case 0:var D=g.scale,x=D;T[0]=D.x,T[1]=D.z,T[2]=D.y,1===S&&(d=D);break;case 1:D=g.localScale;T[0]=(x=D).x,T[1]=D.z,T[2]=D.y,1===S&&(d=D);break;case 2:x=g.scale,(T[0]=T[1]=T[2]=1)===S&&(d=W.ONE)}switch(this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(p=new W(c.x*a,c.y*a,c.z*a),E=new W(f.x*a,f.y*a,f.z*a),2!=this.scaleMode?(W.add(o,p,t),W.multiply(x,t,t),W.add(s,E,n),W.multiply(x,n,n)):(W.multiply(x,o,t),W.add(t,p,t),W.multiply(x,s,n),W.add(n,E,n))),this.simulationSpace){case 0:break;case 1:W.add(t,U,t),W.add(n,U,n)}var M,R,I=NaN,A=NaN;switch(this.startSizeType){case 0:this.threeDStartSize?(I=Math.max(M.x,M.y),1===S&&(A=M.y)):(I=this.startSizeConstant,1===S&&(A=this.startSizeConstant));break;case 1:break;case 2:this.threeDStartSize?(I=Math.max(R.x,R.y),1===S&&(A=R.y)):(I=this.startSizeConstantMax,1===S&&(A=this.startSizeConstantMax))}this._sizeOverLifetime&&this._sizeOverLifetime.enbale&&(this._sizeOverLifetime.size,I*=this._sizeOverLifetime.size.getMaxSizeInGradient());var C=so._tempVector30,H=C.elements,y=NaN;switch(S){case 0:W.scale(v,I,C),W.subtract(t,C,t),W.add(n,C,n);break;case 1:var O=so._tempVector31,N=so._tempVector32,V=so._tempVector33,L=so._tempVector34,w=(this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(W.multiply(d,f,N),W.multiply(d,c,V)),A*e.stretchedBillboardLengthScale),F=W.scalarLength(N)*e.stretchedBillboardSpeedScale+w,w=W.scalarLength(V)*e.stretchedBillboardSpeedScale+w,G=so._tempVector35,z=so._tempVector36,N=(W.normalize(N,G),W.scale(G,F,L),W.subtract(E,L,L),W.normalize(V,z),W.scale(z,w,O),W.add(p,O,O),W.scale(v,I*so.halfKSqrtOf2,C),so._tempVector37),F=so._tempVector38;W.scale(G,.5,N),W.scale(z,.5,F),W.multiply(N,v,N),W.multiply(F,v,F),W.add(t,F,t),W.min(t,L,t),W.subtract(t,C,t),W.subtract(n,N,n),W.max(n,O,n),W.add(n,C,n);break;case 2:I*=Math.cos(.7853981633974483),H[0]=v.x*(y=.5*I),H[1]=v.z*y,W.subtract(t,C,t),W.add(n,C,n);break;case 3:I*=Math.cos(.7853981633974483),W.scale(v,y=.5*I,C),W.subtract(t,C,t),W.add(n,C,n)}this._boundingBox.getCorners(this._boundingBoxCorners)},l._updateEmission=function(){var e;v.stage.isVisibility&&this.isAlive&&(this._simulateUpdate?this._simulateUpdate=!1:(e=this._startUpdateLoopCount===T.loopCount||this._isPaused?0:v.timer.delta/1e3,e=Math.min(so._maxElapsedTime,e),this._updateParticles(e)))},l._updateParticles=function(e){4===this._ownerRender.renderMode&&!this._ownerRender.mesh||(this._currentTime+=e,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=e,this._totalDelayTime<this._playStartDelay)||this._emission.enbale&&this._isEmitting&&!this._isPaused&&this._advanceTime(e,this._currentTime)},l._updateParticlesSimulationRestart=function(e){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=e,this._emissionTime=0,this._totalDelayTime=0,(this._currentTime=e)<this._playStartDelay?this._totalDelayTime=e:this._emission.enbale&&this._advanceTime(e,e)},l._addUpdateEmissionToTimer=function(){v.timer.frameLoop(1,this,this._updateEmission)},l._removeUpdateEmissionToTimer=function(){v.timer.clear(this,this._updateEmission)},l._onOwnerActiveHierarchyChanged=function(e){this._owner.displayedInStage&&(e?this._addUpdateEmissionToTimer():this._removeUpdateEmissionToTimer())},l._retireActiveParticles=function(){for(;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,t=e+this._timeIndex;if(1e-4+(this._currentTime-this._vertices[t])<this._vertices[e+this._startLifeTimeIndex])break;this._vertices[t]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}},l._freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var e=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&e<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}},l._burst=function(e,t){for(var n=0,i=this._emission._bursts,r=i.length;this._burstsIndex<r;this._burstsIndex++){var a=i[this._burstsIndex],o=a.time;if(!(e<=o&&o<t))break;o=0;this.autoRandomSeed?o=Q.lerp(a.minCount,a.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],o=Q.lerp(a.minCount,a.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),n+=o}return n},l._advanceTime=function(e,t){var n=0,i=this._emissionTime,r=(this._emissionTime+=e,0);if(this._emissionTime>this.duration){if(!this.looping){for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;n<r;n++)this.emit(t);return this._isPlaying=!1,void this.stop()}r+=this._burst(i,this._emissionTime),this._emissionTime-=this.duration,this.event("complete"),this._burstsIndex=0,r+=this._burst(0,this._emissionTime)}else r+=this._burst(i,this._emissionTime);for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;n<r;n++)this.emit(t);e=this.emission.emissionRate;if(0<e){var a=1/e;for(this._frameRateTime+=a,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=t&&this.emit(this._frameRateTime);)this._frameRateTime+=a;this._frameRateTime=Math.floor(t/a)*a}},l._initBufferDatas=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy());var e=this._ownerRender,t=e.renderMode;if(-1!==t&&0<this.maxParticles){var n,i,r,a=0,o=0,s=0,e=e.mesh;if(4===t){if(e){if(1<e._vertexBuffers.length)throw new Error("ShurikenParticleSystem: submesh Count mesh be One or all subMeshes have the same vertexDeclaration.");this._floatCountPerVertex=(r=yi.vertexDeclaration).vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=e._vertexBuffers[0].vertexCount;var t=this._bufferMaxParticles*this._vertexStride,l=t%65535;if(1<Math.floor(t/65535)+1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");this._vertexBuffer=Es.create(r,l,35048),this._vertices=new Float32Array(this._floatCountPerVertex*l),this._indexStride=e._indexBuffer.indexCount;var h=e._indexBuffer.getData(),t=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=ds.create("ushort",t,35044),n=new Uint16Array(t),a=s=0;a<this._bufferMaxParticles;a++)for(var _=a*this._vertexStride,o=0,u=h.length;o<u;o++)n[s++]=_+h[o];this._indexBuffer.setData(n)}}else{for(this._floatCountPerVertex=(r=Ai.vertexDeclaration).vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,this._vertexBuffer=Es.create(r,this._bufferMaxParticles*this._vertexStride,35048),this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),a=0;a<this._bufferMaxParticles;a++)i=a*this._floatCountPerVertex*this._vertexStride,this._vertices[i]=-.5,this._vertices[1+i]=-.5,this._vertices[2+i]=0,this._vertices[3+i]=1,i+=this._floatCountPerVertex,this._vertices[i]=.5,this._vertices[i+1]=-.5,this._vertices[i+2]=1,this._vertices[i+3]=1,i+=this._floatCountPerVertex,this._vertices[i]=.5,this._vertices[i+1]=.5,this._vertices[i+2]=1,this._vertices[i+3]=0,i+=this._floatCountPerVertex,this._vertices[i]=-.5,this._vertices[i+1]=.5,this._vertices[i+2]=0,this._vertices[i+3]=0;for(this._indexStride=6,this._indexBuffer=ds.create("ushort",6*this._bufferMaxParticles,35044),n=new Uint16Array(6*this._bufferMaxParticles),a=0;a<this._bufferMaxParticles;a++){var s=6*a,d=a*this._vertexStride,c=2+d;n[s++]=d,n[s++]=c,n[s++]=1+d,n[s++]=d,n[s++]=3+d,n[s++]=c}this._indexBuffer.setData(n)}}},l._destroy=function(){ao.prototype._destroy.call(this),this._owner.activeInHierarchy&&this._removeUpdateEmissionToTimer(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission._destroy(),this._owner=null,this._vertices=null,this._vertexBuffer=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null},l.emit=function(e){var t,n,i=so._tempPosition,r=so._tempDirection;return this._shape&&this._shape.enable?this.autoRandomSeed?this._shape.generatePositionAndDirection(i,r):this._shape.generatePositionAndDirection(i,r,this._rand,this._randomSeeds):(t=i.elements,(n=r.elements)[t[0]=t[1]=t[2]=0]=n[1]=0,n[2]=1),this.addParticle(i,r,e)},l.addParticle=function(e,t,n){W.normalize(t,t);var i=this._firstFreeElement+1;if((i=i>=this._bufferMaxParticles?0:i)===this._firstRetiredElement)return!1;at.create(this,this._ownerRender,this._owner.transform);var r=this._currentTime-n;if(!(r>=at.startLifeTime)){var a,o=NaN,s=NaN,l=NaN,h=NaN,_=NaN,u=NaN,d=NaN,c=this._velocityOverLifetime&&this._velocityOverLifetime.enbale,f=(c&&(2===(r=this._velocityOverLifetime.velocity.type)||3===r)?this.autoRandomSeed?(o=Math.random(),s=Math.random(),l=Math.random()):(this._rand.seed=this._randomSeeds[9],o=this._rand.getFloat(),s=this._rand.getFloat(),l=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):c=!1,this._colorOverLifetime&&this._colorOverLifetime.enbale),m=(f&&3===this._colorOverLifetime.color.type?this.autoRandomSeed?h=Math.random():(this._rand.seed=this._randomSeeds[10],h=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):f=!1,this._sizeOverLifetime&&this._sizeOverLifetime.enbale),p=(m&&3===this._sizeOverLifetime.size.type?this.autoRandomSeed?_=Math.random():(this._rand.seed=this._randomSeeds[11],_=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):m=!1,this._rotationOverLifetime&&this._rotationOverLifetime.enbale),E=(p&&(2===(r=this._rotationOverLifetime.angularVelocity.type)||3===r)?this.autoRandomSeed?u=Math.random():(this._rand.seed=this._randomSeeds[12],u=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):p=!1,this._textureSheetAnimation&&this._textureSheetAnimation.enable),r=(E&&3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?d=Math.random():(this._rand.seed=this._randomSeeds[15],d=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):E=!1,this._firstFreeElement*this._floatCountPerVertex*this._vertexStride),g=at.startUVInfo[0],v=at.startUVInfo[1],T=at.startUVInfo[2],S=at.startUVInfo[3],D=e.elements,x=t.elements,M=0,R=0,I=0,A=0,C=0,y=this._ownerRender;4===y.renderMode?(a=(e=y.mesh._vertexBuffers[0]).getData(),R=(t=e.vertexDeclaration).getVertexElementByUsage(0).offset/4,I=(e=t.getVertexElementByUsage(1))?e.offset/4:-1,A=(e=t.getVertexElementByUsage(2))?e.offset/4:-1,M=t.vertexStride/4,C=0):(this._vertices[2+r]=T,this._vertices[3+r]=S+v,e=r+this._floatCountPerVertex,this._vertices[e+2]=T+g,this._vertices[e+3]=S+v,t=e+this._floatCountPerVertex,this._vertices[t+2]=T+g,this._vertices[t+3]=S,e=t+this._floatCountPerVertex,this._vertices[e+2]=T,this._vertices[e+3]=S);for(var O=r,N=r+this._floatCountPerVertex*this._vertexStride;O<N;O+=this._floatCountPerVertex){var V,L,w=0;switch(4===y.renderMode?(w=O,L=(V=M*C++)+R,this._vertices[w++]=a[L++],this._vertices[w++]=a[L++],this._vertices[w++]=a[L],-1===I?(this._vertices[w++]=1,this._vertices[w++]=1,this._vertices[w++]=1,this._vertices[w++]=1):(L=V+I,this._vertices[w++]=a[L++],this._vertices[w++]=a[L++],this._vertices[w++]=a[L++],this._vertices[w++]=a[L]),-1===A?(this._vertices[w++]=0,this._vertices[w++]=0):(L=V+A,this._vertices[w++]=T+a[L++]*g,this._vertices[w++]=S+a[L]*v)):w=O+4,this._vertices[w++]=D[0],this._vertices[w++]=D[1],this._vertices[w++]=D[2],this._vertices[w++]=at.startLifeTime,this._vertices[w++]=x[0],this._vertices[w++]=x[1],this._vertices[w++]=x[2],this._vertices[w++]=n,this._vertices[w++]=at.startColor[0],this._vertices[w++]=at.startColor[1],this._vertices[w++]=at.startColor[2],this._vertices[w++]=at.startColor[3],this._vertices[w++]=at.startSize[0],this._vertices[w++]=at.startSize[1],this._vertices[w++]=at.startSize[2],this._vertices[w++]=at.startRotation[0],this._vertices[w++]=at.startRotation[1],this._vertices[w++]=at.startRotation[2],this._vertices[w++]=at.startSpeed,f&&(this._vertices[w+1]=h),m&&(this._vertices[w+2]=_),p&&(this._vertices[w+3]=u),E&&(this._vertices[w+4]=d),c&&(this._vertices[w+5]=o,this._vertices[w+6]=s,this._vertices[w+7]=l),this.simulationSpace){case 0:w+=8,this._vertices[w++]=at.simulationWorldPostion[0],this._vertices[w++]=at.simulationWorldPostion[1],this._vertices[w++]=at.simulationWorldPostion[2],this._vertices[w++]=at.simulationWorldRotation[0],this._vertices[w++]=at.simulationWorldRotation[1],this._vertices[w++]=at.simulationWorldRotation[2],this._vertices[w++]=at.simulationWorldRotation[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}this._firstFreeElement=i}return!0},l.addNewParticlesToVertexBuffer=function(){var e=0;this._firstNewElement<this._firstFreeElement?(e=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,(this._firstFreeElement-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex)):(e=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,(this._bufferMaxParticles-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex),0<this._firstFreeElement&&this._vertexBuffer.setData(this._vertices,0,0,this._firstFreeElement*this._vertexStride*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},l._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),!0)},l._render=function(e){var t=0,n=c.mainContext;this._firstActiveElement<this._firstFreeElement?(t=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,n.drawElements(4,t,5123,2*this._firstActiveElement*this._indexStride),T.trianglesFaces+=t/3,T.drawCall++):(t=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,n.drawElements(4,t,5123,2*this._firstActiveElement*this._indexStride),T.trianglesFaces+=t/3,T.drawCall++,0<this._firstFreeElement&&(t=this._firstFreeElement*this._indexStride,n.drawElements(4,t,5123,0),T.trianglesFaces+=t/3,T.drawCall++))},l.play=function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var e=0,t=this._randomSeeds.length;e<t;e++)this._randomSeeds[e]=this.randomSeed[0]+so._RANDOMOFFSET[e];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=Q.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=Q.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=T.loopCount,this.event("played")},l.pause=function(){this._isPaused=!0,this.event("paused")},l.simulate=function(e,t){void 0===t&&(t=!0),this._simulateUpdate=!0,t?this._updateParticlesSimulationRestart(e):(this._isPaused=!1,this._updateParticles(e)),this.pause()},l.stop=function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0,this.event("stopped")},l.cloneTo=function(e){e.duration=this.duration,e.looping=this.looping,e.prewarm=this.prewarm,e.startDelayType=this.startDelayType,e.startDelay=this.startDelay,e.startDelayMin=this.startDelayMin,e.startDelayMax=this.startDelayMax,e._maxStartLifetime=this._maxStartLifetime,e.startLifetimeType=this.startLifetimeType,e.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(e.startLifeTimeGradient),e.startLifetimeConstantMin=this.startLifetimeConstantMin,e.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(e.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(e.startLifeTimeGradientMax),e.startSpeedType=this.startSpeedType,e.startSpeedConstant=this.startSpeedConstant,e.startSpeedConstantMin=this.startSpeedConstantMin,e.startSpeedConstantMax=this.startSpeedConstantMax,e.threeDStartSize=this.threeDStartSize,e.startSizeType=this.startSizeType,e.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(e.startSizeConstantSeparate),e.startSizeConstantMin=this.startSizeConstantMin,e.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(e.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(e.startSizeConstantMaxSeparate),e.threeDStartRotation=this.threeDStartRotation,e.startRotationType=this.startRotationType,e.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(e.startRotationConstantSeparate),e.startRotationConstantMin=this.startRotationConstantMin,e.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(e.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(e.startRotationConstantMaxSeparate),e.randomizeRotationDirection=this.randomizeRotationDirection,e.startColorType=this.startColorType,this.startColorConstant.cloneTo(e.startColorConstant),this.startColorConstantMin.cloneTo(e.startColorConstantMin),this.startColorConstantMax.cloneTo(e.startColorConstantMax),e.gravityModifier=this.gravityModifier,e.simulationSpace=this.simulationSpace,e.scaleMode=this.scaleMode,e.playOnAwake=this.playOnAwake,e.maxParticles=this.maxParticles,this._emission&&(e._emission=this._emission.clone()),this.shape&&(e.shape=this.shape.clone()),this.velocityOverLifetime&&(e.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(e.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(e.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(e.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(e.textureSheetAnimation=this.textureSheetAnimation.clone()),e.isPerformanceMode=this.isPerformanceMode,e._isEmitting=this._isEmitting,e._isPlaying=this._isPlaying,e._isPaused=this._isPaused,e._playStartDelay=this._playStartDelay,e._frameRateTime=this._frameRateTime,e._emissionTime=this._emissionTime,e._totalDelayTime=this._totalDelayTime,e._burstsIndex=this._burstsIndex},l.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},l._getVertexBuffers=function(){return null},n(0,l,"maxParticles",function(){return this._bufferMaxParticles-1},function(e){e+=1;e!==this._bufferMaxParticles&&(this._bufferMaxParticles=e,this._initBufferDatas())}),n(0,l,"isEmitting",function(){return this._isEmitting}),n(0,l,"isAlive",function(){return!!(this._isPlaying||0<this.aliveParticleCount)}),n(0,l,"shape",function(){return this._shape},function(e){this._shape!==e&&(e&&e.enable?this._ownerRender._addShaderDefine(V.SHADERDEFINE_SHAPE):this._ownerRender._removeShaderDefine(V.SHADERDEFINE_SHAPE),this._shape=e)}),n(0,l,"rotationOverLifetime",function(){return this._rotationOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.angularVelocity;if(!n)return;var i=n.separateAxes,r=n.type;if(e.enbale)switch(i?t._addShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):t._addShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIME),r){case 0:t._addShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:t._addShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:t._addShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:t._addShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIME),t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(r){case 0:i?t._setShaderValueColor(35,n.constantSeparate):t._setShaderValueNumber(34,n.constant);break;case 1:i?(t._setShaderValueBuffer(37,n.gradientX._elements),t._setShaderValueBuffer(38,n.gradientY._elements),t._setShaderValueBuffer(39,n.gradientZ._elements),t._setShaderValueBuffer(40,n.gradientW._elements)):t._setShaderValueBuffer(36,n.gradient._elements);break;case 2:i?(t._setShaderValueColor(35,n.constantMinSeparate),t._setShaderValueColor(42,n.constantMaxSeparate)):(t._setShaderValueNumber(34,n.constantMin),t._setShaderValueNumber(41,n.constantMax));break;case 3:i?(t._setShaderValueBuffer(37,n.gradientXMin._elements),t._setShaderValueBuffer(44,n.gradientXMax._elements),t._setShaderValueBuffer(38,n.gradientYMin._elements),t._setShaderValueBuffer(45,n.gradientYMax._elements),t._setShaderValueBuffer(39,n.gradientZMin._elements),t._setShaderValueBuffer(46,n.gradientZMax._elements),t._setShaderValueBuffer(40,n.gradientWMin._elements),t._setShaderValueBuffer(47,n.gradientWMax._elements)):(t._setShaderValueBuffer(36,n.gradientMin._elements),t._setShaderValueBuffer(43,n.gradientMax._elements))}}else t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIME),t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t._removeShaderDefine(V.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES),t._setShaderValueColor(35,null),t._setShaderValueColor(42,null),t._setShaderValueNumber(34,void 0),t._setShaderValueNumber(41,void 0),t._setShaderValueBuffer(37,null),t._setShaderValueBuffer(44,null),t._setShaderValueBuffer(38,null),t._setShaderValueBuffer(45,null),t._setShaderValueBuffer(39,null),t._setShaderValueBuffer(46,null),t._setShaderValueBuffer(40,null),t._setShaderValueBuffer(47,null),t._setShaderValueBuffer(36,null),t._setShaderValueBuffer(43,null);this._rotationOverLifetime=e}),n(0,l,"emission",function(){return this._emission}),n(0,l,"emissionTime",function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}),n(0,l,"aliveParticleCount",function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}),n(0,l,"isPlaying",function(){return this._isPlaying}),n(0,l,"isPaused",function(){return this._isPaused}),n(0,l,"startLifetimeType",function(){return this._startLifetimeType},function(e){var t=0,n=0;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;for(var i,t=0,n=i.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,i.getValueByIndex(t));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var r;for(t=0,n=r.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,r.getValueByIndex(t));var a;for(t=0,n=a.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(t))}this._startLifetimeType=e}),n(0,l,"_originalBoundingSphere",function(){return this._boundingSphere}),n(0,l,"startLifetimeConstant",function(){return this._startLifetimeConstant},function(e){0===this._startLifetimeType&&(this._maxStartLifetime=e),this._startLifetimeConstant=e}),n(0,l,"startLifetimeConstantMin",function(){return this._startLifetimeConstantMin},function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(e,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=e}),n(0,l,"startLifeTimeGradient",function(){return this._startLifeTimeGradient},function(e){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradient=e}),n(0,l,"startLifetimeConstantMax",function(){return this._startLifetimeConstantMax},function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,e)),this._startLifetimeConstantMax=e}),n(0,l,"startLifeTimeGradientMin",function(){return this._startLifeTimeGradientMin},function(e){if(3===this._startLifetimeType){var t=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t));for(t=0,n=this._startLifeTimeGradientMax.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(t))}this._startLifeTimeGradientMin=e}),n(0,l,"startLifeTimeGradientMax",function(){return this._startLifeTimeGradientMax},function(e){if(3===this._startLifetimeType){var t=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=this._startLifeTimeGradientMin.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(t));for(t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradientMax=e}),n(0,l,"velocityOverLifetime",function(){return this._velocityOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.velocity,i=n.type;if(e.enbale)switch(i){case 0:t._addShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:t._addShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:t._addShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:t._addShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else t._removeShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t._removeShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t._removeShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t._removeShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(i){case 0:t._setShaderValueColor(13,n.constant);break;case 1:t._setShaderValueBuffer(14,n.gradientX._elements),t._setShaderValueBuffer(15,n.gradientY._elements),t._setShaderValueBuffer(16,n.gradientZ._elements);break;case 2:t._setShaderValueColor(13,n.constantMin),t._setShaderValueColor(17,n.constantMax);break;case 3:t._setShaderValueBuffer(14,n.gradientXMin._elements),t._setShaderValueBuffer(18,n.gradientXMax._elements),t._setShaderValueBuffer(15,n.gradientYMin._elements),t._setShaderValueBuffer(19,n.gradientYMax._elements),t._setShaderValueBuffer(16,n.gradientZMin._elements),t._setShaderValueBuffer(20,n.gradientZMax._elements)}t._setShaderValueInt(21,e.space)}else t._removeShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t._removeShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t._removeShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t._removeShaderDefine(V.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE),t._setShaderValueColor(13,null),t._setShaderValueBuffer(14,null),t._setShaderValueBuffer(15,null),t._setShaderValueBuffer(16,null),t._setShaderValueColor(13,null),t._setShaderValueColor(17,null),t._setShaderValueBuffer(14,null),t._setShaderValueBuffer(18,null),t._setShaderValueBuffer(15,null),t._setShaderValueBuffer(19,null),t._setShaderValueBuffer(16,null),t._setShaderValueBuffer(20,null),t._setShaderValueInt(21,void 0);this._velocityOverLifetime=e}),n(0,l,"colorOverLifetime",function(){return this._colorOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.color;if(e.enbale)switch(n.type){case 1:t._addShaderDefine(V.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:t._addShaderDefine(V.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else t._removeShaderDefine(V.SHADERDEFINE_COLOROVERLIFETIME),t._removeShaderDefine(V.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(n.type){case 1:var i=n.gradient;t._setShaderValueBuffer(22,i._alphaElements),t._setShaderValueBuffer(23,i._rgbElements);break;case 3:var r=n.gradientMin,a=n.gradientMax;t._setShaderValueBuffer(22,r._alphaElements),t._setShaderValueBuffer(23,r._rgbElements),t._setShaderValueBuffer(24,a._alphaElements),t._setShaderValueBuffer(25,a._rgbElements)}}else t._removeShaderDefine(V.SHADERDEFINE_COLOROVERLIFETIME),t._removeShaderDefine(V.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),t._setShaderValueBuffer(22,i._alphaElements),t._setShaderValueBuffer(23,i._rgbElements),t._setShaderValueBuffer(22,r._alphaElements),t._setShaderValueBuffer(23,r._rgbElements),t._setShaderValueBuffer(24,a._alphaElements),t._setShaderValueBuffer(25,a._rgbElements);this._colorOverLifetime=e}),n(0,l,"sizeOverLifetime",function(){return this._sizeOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.size,i=n.separateAxes,r=n.type;if(e.enbale)switch(r){case 0:i?t._addShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):t._addShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:i?t._addShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):t._addShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else t._removeShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t._removeShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t._removeShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t._removeShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(r){case 0:i?(t._setShaderValueBuffer(27,n.gradientX._elements),t._setShaderValueBuffer(28,n.gradientY._elements),t._setShaderValueBuffer(29,n.gradientZ._elements)):t._setShaderValueBuffer(26,n.gradient._elements);break;case 2:i?(t._setShaderValueBuffer(27,n.gradientXMin._elements),t._setShaderValueBuffer(31,n.gradientXMax._elements),t._setShaderValueBuffer(28,n.gradientYMin._elements),t._setShaderValueBuffer(32,n.gradientYMax._elements),t._setShaderValueBuffer(29,n.gradientZMin._elements),t._setShaderValueBuffer(33,n.gradientZMax._elements)):(t._setShaderValueBuffer(26,n.gradientMin._elements),t._setShaderValueBuffer(30,n.gradientMax._elements))}}else t._removeShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t._removeShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t._removeShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t._removeShaderDefine(V.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE),t._setShaderValueBuffer(27,null),t._setShaderValueBuffer(31,null),t._setShaderValueBuffer(28,null),t._setShaderValueBuffer(32,null),t._setShaderValueBuffer(29,null),t._setShaderValueBuffer(33,null),t._setShaderValueBuffer(26,null),t._setShaderValueBuffer(30,null);this._sizeOverLifetime=e}),n(0,l,"textureSheetAnimation",function(){return this._textureSheetAnimation},function(e){var t=this._ownerRender;if(e){var n,i,r=e.frame,a=r.type;if(e.enable)switch(a){case 1:t._addShaderDefine(V.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:t._addShaderDefine(V.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE)}else t._removeShaderDefine(V.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t._removeShaderDefine(V.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);switch(1!==a&&3!==a||(t._setShaderValueInt(48,e.cycles),n=e.tiles,(i=this._uvLength.elements)[0]=1/n.x,i[1]=1/n.y,t._setShaderValueVector2(49,this._uvLength)),a){case 1:t._setShaderValueBuffer(50,r.frameOverTimeData._elements);break;case 3:t._setShaderValueBuffer(50,r.frameOverTimeDataMin._elements),t._setShaderValueBuffer(51,r.frameOverTimeDataMax._elements)}}else t._removeShaderDefine(V.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t._removeShaderDefine(V.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE),t._setShaderValueInt(48,void 0),t._setShaderValueVector2(49,null),t._setShaderValueBuffer(50,null),t._setShaderValueBuffer(51,null);this._textureSheetAnimation=e}),n(0,l,"_vertexBufferCount",function(){return 1}),n(0,l,"triangleCount",function(){return this._indexBuffer?this._indexBuffer.indexCount/3:0}),n(0,l,"_originalBoundingBox",function(){return this._boundingBox}),n(0,l,"_originalBoundingBoxCorners",function(){return this._boundingBoxCorners}),so.halfKSqrtOf2=.71,e(so,["_RANDOMOFFSET",function(){return this._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447])},"_maxElapsedTime",function(){return this._maxElapsedTime=1/3},"_tempVector30",function(){return this._tempVector30=new W},"_tempVector31",function(){return this._tempVector31=new W},"_tempVector32",function(){return this._tempVector32=new W},"_tempVector33",function(){return this._tempVector33=new W},"_tempVector34",function(){return this._tempVector34=new W},"_tempVector35",function(){return this._tempVector35=new W},"_tempVector36",function(){return this._tempVector36=new W},"_tempVector37",function(){return this._tempVector37=new W},"_tempVector38",function(){return this._tempVector38=new W},"_tempVector39",function(){return this._tempVector39=new W},"_tempPosition",function(){return this._tempPosition=new W},"_tempDirection",function(){return this._tempDirection=new W}]);var ao,oo=so;function so(e){so.__super.call(this),this._tempRotationMatrix=new R,this._uvLength=new ar,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._owner=e,this._ownerRender=e.particleRender,this._boundingBoxCorners=w(8,null),this._boundingSphere=new Gi(new W,Number.MAX_VALUE),this._boundingBox=new bi(new W(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new W(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),this._currentTime=0,this._isEmitting=!1,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameRateTime=0,this._emissionTime=0,this._totalDelayTime=0,this._simulateUpdate=!1,this._bufferMaxParticles=1,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this._startLifetimeType=0,this._startLifetimeConstant=5,this._startLifeTimeGradient=new Ue,this._startLifetimeConstantMin=0,this._startLifetimeConstantMax=5,this._startLifeTimeGradientMin=new Ue,this._startLifeTimeGradientMax=new Ue,this._maxStartLifetime=5,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new W(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new W(0,0,0),this.startSizeConstantMaxSeparate=new W(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new W(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new W(0,0,0),this.startRotationConstantMaxSeparate=new W(0,0,0),this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new P(1,1,1,1),this.startColorConstantMin=new P(1,1,1,1),this.startColorConstantMax=new P(1,1,1,1),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=0,this.playOnAwake=!0,this._rand=new er(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array(so._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._emission=new Ae,this._emission.enbale=!0,this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)}t(_o,"laya.d3.core.particleShuriKen.ShurikenParticleRender",lo=Xr),(d=_o.prototype)._calculateBoundingBox=function(){var e=this._boundingBox.min.elements,e=(e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE,this._boundingBox.min.elements);e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},d._calculateBoundingSphere=function(){var e=this._owner.particleSystem._boundingSphere,t=NaN,n=this._owner.transform,i=n.scale.elements,r=Math.abs(i[0]),a=Math.abs(i[1]),i=Math.abs(i[2]),t=a<=r&&i<=r?r:i<=a?a:i;W.transformCoordinate(e.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*t},d._renderUpdate=function(e){var t=this._owner.particleSystem;if(!v.stage.isVisibility||!t.isAlive)return!1;var n=this._owner.transform;switch(t.simulationSpace){case 0:break;case 1:this._setShaderValueColor(0,n.position),this._setShaderValueColor(1,n.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(t.scaleMode){case 0:var i=n.scale;this._setShaderValueColor(4,i),this._setShaderValueColor(5,i);break;case 1:i=n.localScale;this._setShaderValueColor(4,i),this._setShaderValueColor(5,i);break;case 2:this._setShaderValueColor(4,n.scale),this._setShaderValueColor(5,W.ONE)}var r=this._finalGravity.elements,a=yr.gravity.elements,o=t.gravityModifier;return r[0]=a[0]*o,r[1]=a[1]*o,r[2]=a[2]*o,this._setShaderValueBuffer(7,r),this._setShaderValueInt(11,t.simulationSpace),this._setShaderValueBool(8,t.threeDStartRotation),this._setShaderValueInt(6,t.scaleMode),this._setShaderValueInt(9,this.stretchedBillboardLengthScale),this._setShaderValueInt(10,this.stretchedBillboardSpeedScale),this._setShaderValueNumber(12,t._currentTime),Ur.debugMode&&this._renderRenderableBoundBox(),!0},d._destroy=function(){lo.prototype._destroy.call(this),this._mesh&&(this._mesh._removeReference(),this._mesh=null)},n(0,d,"boundingBox",function(){return this._owner.particleSystem.isAlive?(this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox):this._defaultBoundBox}),n(0,d,"renderMode",function(){return this._renderMode},function(e){if(this._renderMode!==e){switch(this._renderMode){case 0:this._removeShaderDefine(V.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._removeShaderDefine(V.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._removeShaderDefine(V.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._removeShaderDefine(V.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._removeShaderDefine(V.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=e){case 0:this._addShaderDefine(V.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._addShaderDefine(V.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._addShaderDefine(V.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._addShaderDefine(V.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._addShaderDefine(V.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}this._owner.particleSystem._initBufferDatas()}}),n(0,d,"mesh",function(){return this._mesh},function(e){this._mesh!==e&&(this._mesh&&this._mesh._removeReference(),(this._mesh=e)&&e._addReference(),this._owner.particleSystem._initBufferDatas())});var lo,ho=_o;function _o(e){this._finalGravity=new W,this._tempRotationMatrix=new R,_o.__super.call(this,e),this._defaultBoundBox=new bi(new W,new W),this._renderMode=-1,this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=1}t(fo,"laya.d3.core.trail.TrailFilter",uo=Wr),(r=fo.prototype).getRenderElementsCount=function(){return this._trailRenderElements.length},r.addRenderElement=function(){for(var e=0;e<this._trailRenderElements.length;e++)if(1==this._trailRenderElements[e]._isDead)return this._trailRenderElements[e].reActivate(),e;var t=new yt(this);return this._trailRenderElements.push(t),this._trailRenderElements.length-1},r.getRenderElement=function(e){return this._trailRenderElements[e]},r._update=function(e){this._curtime+=e.elapsedTime/1e3,this._owner._render._setShaderValueNumber(3,this._curtime),this._curSubTrailFinished&&(this._curSubTrailFinished=!1,this._trailRenderElementIndex=this.addRenderElement(),this.event("trailfilterchange",[this._trailRenderElementIndex,this._trailRenderElements[this._trailRenderElementIndex]]))},r.reset=function(){for(var e=0;e<this._trailRenderElements.length;e++)this._trailRenderElements[e].reActivate();this._isStart=!1,this._hasLifeSubTrail=!1,this._curSubTrailFinished=!1,this._curSubTrailFinishCurTime=0,this._trailTotalLength=0,this._trailSupplementLength=0,this._trailDeadLength=0},r._destroy=function(){uo.prototype._destroy.call(this);for(var e=0;e<this._trailRenderElements.length;e++)this._trailRenderElements[e]._destroy();this._trailRenderElements=null,this._widthCurve=null,this._colorGradient=null,this._curSubTrailFinishPosition=null,this._curSubTrailFinishDirection=null},n(0,r,"widthMultiplier",function(){return this._widthMultiplier},function(e){this._widthMultiplier=e}),n(0,r,"time",function(){return this._time},function(e){this._time=e,this._owner._render._setShaderValueNumber(4,e)}),n(0,r,"widthCurve",function(){return this._widthCurve},function(e){this._widthCurve=e;for(var t=new Float32Array(4*e.length),n=0,i=0,n=0,r=e.length;n<r;n++)t[i++]=e[n].time,t[i++]=e[n].inTangent,t[i++]=e[n].outTangent,t[i++]=e[n].value;this._owner._render._setShaderValueBuffer(5,t),this._owner._render._setShaderValueInt(6,e.length)}),n(0,r,"minVertexDistance",function(){return this._minVertexDistance},function(e){this._minVertexDistance=e}),n(0,r,"colorGradient",function(){return this._colorGradient},function(e){this._colorGradient=e,this._owner._render._setShaderValueBuffer(7,e._colorKeyData),this._owner._render._setShaderValueBuffer(8,e._alphaKeyData),0==e.mode?this._owner._render._addShaderDefine(Wl.SHADERDEFINE_GRADIENTMODE_BLEND):this._owner._render._removeShaderDefine(Wl.SHADERDEFINE_GRADIENTMODE_BLEND)}),n(0,r,"textureMode",function(){return this._textureMode},function(e){this._textureMode=e});var uo,co=fo;function fo(e){this._owner=null,this._trailRenderElements=null,this._minVertexDistance=NaN,this._widthMultiplier=NaN,this._time=NaN,this._widthCurve=null,this._colorGradient=null,this._textureMode=0,this._curtime=0,this._curSubTrailFinishCurTime=0,this._curSubTrailFinished=!1,this._hasLifeSubTrail=!1,this._trailTotalLength=0,this._trailSupplementLength=0,this._trailDeadLength=0,this._isStart=!1,this._trailRenderElementIndex=0,fo.__super.call(this),this._curSubTrailFinishPosition=new W,this._curSubTrailFinishDirection=new W,this._owner=e,this._trailRenderElements=[],this.addRenderElement()}t(po,"laya.d3.core.trail.TrailRenderer",Xr),(l=po.prototype)._calculateBoundingBox=function(){var e=this._boundingBox.min.elements,e=(e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE,this._boundingBox.min.elements);e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},l._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},l._renderUpdate=function(e){return!0};var mo=po;function po(e){po.__super.call(this,e)}t(A,"laya.d3.extension.domino.DominoFilter",Wr),(d=A.prototype).addDomino=function(e,t,n){void 0===e&&(e=W.ZERO),void 0===t&&(t=$i.DEFAULT),void 0===n&&(n=W.ZERO);var i,r=this._dominoRenderElements[this._dominoRenderElements.length-1];r._curDominoCount>=this.DominoRenderElementMaxDominoCount&&(i=this.addDominoRenderElement(),this.event("dominofilterchange",[i,this._dominoRenderElements[i]])),(r=this._dominoRenderElements[this._dominoRenderElements.length-1]).addDomino(e,t,n)},d.updateDomino=function(e,t,n,i){void 0===t&&(t=W.ZERO),void 0===n&&(n=$i.DEFAULT),void 0===i&&(i=W.ZERO);var r=Math.floor(e/this.DominoRenderElementMaxDominoCount),e=e%this.DominoRenderElementMaxDominoCount;this._dominoRenderElements[r].updateDomino(e,t,n,i)},d.updateDominos=function(e,t,n){var i,r=e+t-1,a=Math.floor(e/this.DominoRenderElementMaxDominoCount),o=Math.floor(r/this.DominoRenderElementMaxDominoCount),s=e%this.DominoRenderElementMaxDominoCount,l=r%this.DominoRenderElementMaxDominoCount,h=o-a+1;if(h<=1)(i=this._dominoRenderElements[a]).updateDominos(s,t,n);else for(var _,u=0,d=0,c=0,f=0;f<h;f++)i=this._dominoRenderElements[a+f],0==f?(d=this.DominoRenderElementMaxDominoCount-(u=s),_=n.slice(0,d),c+=d):f==h-1?(u=0,d=1+l,_=n.slice(c,n.length)):(u=0,d=this.DominoRenderElementMaxDominoCount,_=n.slice(c,c+this.DominoRenderElementMaxDominoCount),c+=this.DominoRenderElementMaxDominoCount),i.updateDominos(u,d,_)},d.addDominoRenderElement=function(){var e=new wt(this);return this._dominoRenderElements.push(e),this._dominoRenderElements.length-1},d.getDominoRenderElementsCount=function(){return this._dominoRenderElements.length},d.getRenderElement=function(e){return this._dominoRenderElements[e]},d._update=function(e){},d.initPositionsAndNormal=function(){0!=A._positions.length&&0!=A._normals.length||(A._positions.push(new W(-.5,.5,-.5)),A._positions.push(new W(.5,.5,-.5)),A._positions.push(new W(.5,.5,.5)),A._positions.push(new W(-.5,.5,.5)),A._positions.push(new W(-.5,-.5,-.5)),A._positions.push(new W(.5,-.5,-.5)),A._positions.push(new W(.5,-.5,.5)),A._positions.push(new W(-.5,-.5,.5)),A._positions.push(new W(-.5,.5,-.5)),A._positions.push(new W(-.5,.5,.5)),A._positions.push(new W(-.5,-.5,.5)),A._positions.push(new W(-.5,-.5,-.5)),A._positions.push(new W(.5,.5,-.5)),A._positions.push(new W(.5,.5,.5)),A._positions.push(new W(.5,-.5,.5)),A._positions.push(new W(.5,-.5,-.5)),A._positions.push(new W(-.5,.5,.5)),A._positions.push(new W(.5,.5,.5)),A._positions.push(new W(.5,-.5,.5)),A._positions.push(new W(-.5,-.5,.5)),A._positions.push(new W(-.5,.5,-.5)),A._positions.push(new W(.5,.5,-.5)),A._positions.push(new W(.5,-.5,-.5)),A._positions.push(new W(-.5,-.5,-.5)),A._normals.push(new W(0,1,0)),A._normals.push(new W(0,1,0)),A._normals.push(new W(0,1,0)),A._normals.push(new W(0,1,0)),A._normals.push(new W(0,-1,0)),A._normals.push(new W(0,-1,0)),A._normals.push(new W(0,-1,0)),A._normals.push(new W(0,-1,0)),A._normals.push(new W(-1,0,0)),A._normals.push(new W(-1,0,0)),A._normals.push(new W(-1,0,0)),A._normals.push(new W(-1,0,0)),A._normals.push(new W(1,0,0)),A._normals.push(new W(1,0,0)),A._normals.push(new W(1,0,0)),A._normals.push(new W(1,0,0)),A._normals.push(new W(0,0,1)),A._normals.push(new W(0,0,1)),A._normals.push(new W(0,0,1)),A._normals.push(new W(0,0,1)),A._normals.push(new W(0,0,-1)),A._normals.push(new W(0,0,-1)),A._normals.push(new W(0,0,-1)),A._normals.push(new W(0,0,-1)))},A._positions=[],A._normals=[];var Eo=A;function A(e){this._owner=null,this.dominoCount=0,this.DominoRenderElementMaxDominoCount=2e3,this._dominoRenderElements=null,A.__super.call(this),this.dominoPosition=[],this._owner=e,this.initPositionsAndNormal(),this._dominoRenderElements=[],this.addDominoRenderElement()}t(To,"laya.d3.extension.lineRender.LineFilter",go=Wr),r=To.prototype,v.imps(r,{"laya.d3.core.render.IRenderable":!0}),r.addPosition=function(e,t){var n=new W,e=(e.cloneTo(n),this._positions.push(n),new W);t.cloneTo(e),this._normals.push(e),this._updateVertexBuffer1(n),this._vertexCount+=2},r._updateVertexBuffer1=function(e){this._everyAddVerticeCount1=0,this._pointe=e.elements,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=1,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=0,this._vertexBuffer1.setData(this._vertices1,this._verticesIndex1,this._verticesIndex1,this._everyAddVerticeCount1),this._verticesIndex1+=this._everyAddVerticeCount1},r._updateVertexBuffer2=function(){this._verticesIndex2=0;for(var e=this._curFixedNum;e<this._positions.length;e++)0==e?(W.subtract(this._positions[1],this._positions[0],this._delVector3),W.cross(this._delVector3,this._normals[0],this._pointAtoBVector3),W.normalize(this._pointAtoBVector3,this._pointAtoBVector3),W.scale(this._pointAtoBVector3,this._widthMultiplier/2,this._pointAtoBVector3),this._everyToFirstDistance[e]=0,this._updateVertices2(this._positions[0],0)):(W.subtract(this._positions[e],this._positions[e-1],this._delVector3),W.cross(this._delVector3,this._normals[e],this._pointAtoBVector3),W.normalize(this._pointAtoBVector3,this._pointAtoBVector3),W.scale(this._pointAtoBVector3,this._widthMultiplier/2,this._pointAtoBVector3),this._delLength=W.scalarLength(this._delVector3),this._curTotalLength=this._everyToFirstDistance[e]=this._curTotalLength+this._delLength,this._updateVertices2(this._positions[e],e)),this._curFixedNum=e+1;this._vertexBuffer2.setData(this._vertices2,0,0,this._verticesIndex2)},r._updateVertexBuffer3=function(){for(var e,t,n=0,i=0,i=0,r=this._vertexCount/2;i<r;i++)e=this._everyToFirstDistance[i]/this._curTotalLength,t=this._everyToFirstDistance[i],this._vertices3[n++]=e,this._vertices3[n++]=t,this._vertices3[n++]=e,this._vertices3[n++]=t;this._vertexBuffer3.setData(this._vertices3,0,0,2*this._vertexCount)},r._beforeRender=function(e){return null==this._camera?(this._camera=e.camera,!1):0<this._vertexCount&&(this._updateVertexBuffer2(),this._updateVertexBuffer3(),!0)},r._render=function(e){c.mainContext.drawArrays(5,0,this._vertexCount),T.drawCall++},r._updateVertices2=function(e,t){this._everyAddVerticeCount2=0,this._pointAtoBVector3e=this._pointAtoBVector3.elements,this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=this._pointAtoBVector3e[0],this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=this._pointAtoBVector3e[1],this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=this._pointAtoBVector3e[2],this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=-this._pointAtoBVector3e[0],this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=-this._pointAtoBVector3e[1],this._vertices2[this._verticesIndex2+this._everyAddVerticeCount2++]=-this._pointAtoBVector3e[2],this._verticesIndex2+=this._everyAddVerticeCount2},r._initData=function(){this.useWorldSpace=!0,this.widthMultiplier=.02,this.textureMode=0;var e=[],t=new At,t=(t.time=0,t.inTangent=0,t.outTangent=0,t.value=1,e.push(t),new At),t=(t.time=1,t.inTangent=0,t.outTangent=0,t.value=1,e.push(t),this.widthCurve=e,new vt),e=(t.mode=0,[]),n=new xt,n=(n.time=0,n.color=Et.WHITE,e.push(n),new xt),n=(n.time=1,n.color=Et.WHITE,e.push(n),[]),i=new St,i=(i.time=0,i.alpha=1,n.push(i),new St);i.time=1,i.alpha=1,n.push(i),t.setKeys(e,n),this.colorGradient=t},r._update=function(e){},r._getVertexBuffer=function(e){return 0===(e=void 0===e?0:e)?this._vertexBuffer1:null},r._getVertexBuffers=function(){return this._vertexBuffers},r._getIndexBuffer=function(){return null},r._destroy=function(){go.prototype._destroy.call(this),this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._vertexBuffer3.destroy(),this._vertexBuffers=null,this._vertices1=null,this._vertices2=null,this._vertices3=null,this._owner=null,this._camera=null,this._widthCurve=null,this._colorGradient=null,this._positions=null,this._normals=null,this._firstPosition=null,this._delVector3=null,this._lastPosition=null,this._pointAtoBVector3=null,this._cameraToPointV3=null,this._delVector3=null,this._pointe=null,this._pointAtoBVector3e=null,this._curDirection=null,this._lastDirection=null,this._fixedDirection=null,this._everyToFirstDistance=null},n(0,r,"widthCurve",function(){return this._widthCurve},function(e){this._widthCurve=e;for(var t=new Float32Array(4*e.length),n=0,i=0,n=0,r=e.length;n<r;n++)t[i++]=e[n].time,t[i++]=e[n].inTangent,t[i++]=e[n].outTangent,t[i++]=e[n].value;this._owner._render._setShaderValueBuffer(3,t),this._owner._render._setShaderValueInt(4,e.length)}),n(0,r,"useWorldSpace",function(){return this._useWorldSpace},function(e){(this._useWorldSpace=e)?this._owner._render._addShaderDefine(jl.SHADERDEFINE_WORLDSPACE):this._owner._render._removeShaderDefine(jl.SHADERDEFINE_WORLDSPACE)}),n(0,r,"triangleCount",function(){return 0}),n(0,r,"widthMultiplier",function(){return this._widthMultiplier},function(e){this._widthMultiplier=e}),n(0,r,"colorGradient",function(){return this._colorGradient},function(e){this._colorGradient=e,this._owner._render._setShaderValueBuffer(5,e._colorKeyData),this._owner._render._setShaderValueBuffer(6,e._alphaKeyData),0==e.mode?this._owner._render._addShaderDefine(jl.SHADERDEFINE_GRADIENTMODE_BLEND):this._owner._render._removeShaderDefine(jl.SHADERDEFINE_GRADIENTMODE_BLEND)}),n(0,r,"textureMode",function(){return this._textureMode},function(e){0==(this._textureMode=e)?this._owner._render._addShaderDefine(jl.SHADERDEFINE_TEXTUREMODE_STRETCH):this._owner._render._removeShaderDefine(jl.SHADERDEFINE_TEXTUREMODE_STRETCH)}),n(0,r,"_vertexBufferCount",function(){return this._vertexBuffers.length});var go,vo=To;function To(e){this._owner=null,this._camera=null,this._useWorldSpace=!1,this._widthMultiplier=.02,this._widthCurve=null,this._colorGradient=null,this._textureMode=0,this._curFixedNum=0,this._vertexBuffers=null,this._maxVertexCount=512,this._vertexCount=0,this._vertices1=null,this._vertexBuffer1=null,this._verticesIndex1=0,this._everyAddVerticeCount1=0,this._floatCountPerVertices1=4,this._vertices2=null,this._vertexBuffer2=null,this._verticesIndex2=0,this._everyAddVerticeCount2=0,this._floatCountPerVertices2=3,this._vertices3=null,this._vertexBuffer3=null,this._verticesIndex3=0,this._everyAddVerticeCount3=0,this._floatCountPerVertices3=2,this._delLength=0,this._pointe=null,this._pointAtoBVector3e=null,this._everyToFirstDistance=null,this._curTotalLength=0,To.__super.call(this),this._positions=[],this._normals=[],this._firstPosition=new W,this._delVector3=new W,this._lastPosition=new W,this._pointAtoBVector3=new W,this._cameraToPointV3=new W,this._curDirection=new W,this._lastDirection=new W,this._fixedDirection=new W,this._owner=e,this._initData(),this._vertices1=new Float32Array(this._maxVertexCount*this._floatCountPerVertices1),this._vertices2=new Float32Array(this._maxVertexCount*this._floatCountPerVertices2),this._vertices3=new Float32Array(this._maxVertexCount*this._floatCountPerVertices3),this._vertexBuffer1=new Es(Bt.vertexDeclaration1,this._maxVertexCount,35044,!0),this._vertexBuffer2=new Es(Bt.vertexDeclaration2,this._maxVertexCount,35044,!0),this._vertexBuffer3=new Es(Bt.vertexDeclaration3,this._maxVertexCount,35044,!0),this._vertexBuffers=[],this._vertexBuffers.push(this._vertexBuffer1),this._vertexBuffers.push(this._vertexBuffer2),this._vertexBuffers.push(this._vertexBuffer3),this._everyToFirstDistance=new Float32Array(this._maxVertexCount/2)}t(Do,"laya.d3.extension.domino.DominoRenderer",Xr),(l=Do.prototype)._calculateBoundingBox=function(){var e=this._boundingBox.min.elements,e=(e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE,this._boundingBox.min.elements);e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},l._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},l._renderUpdate=function(e){var t=this._owner.transform;return t?(this._setShaderValueMatrix4x4(0,t.worldMatrix),t=this._owner.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,t)):(this._setShaderValueMatrix4x4(0,R.DEFAULT),this._setShaderValueMatrix4x4(1,e)),!0};var So=Do;function Do(e){Do.__super.call(this,e)}t(Mo,"laya.d3.extension.lineRender.LineRenderer",Xr),(d=Mo.prototype)._calculateBoundingBox=function(){var e=this._boundingBox.min.elements,e=(e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE,this._boundingBox.min.elements);e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},d._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},d._renderUpdate=function(e){var t=this._owner.transform;return t?(this._setShaderValueMatrix4x4(0,t.worldMatrix),t=this._owner.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,t)):(this._setShaderValueMatrix4x4(0,R.DEFAULT),this._setShaderValueMatrix4x4(1,e)),!0};var xo=Mo;function Mo(e){Mo.__super.call(this,e)}t(Ao,"laya.d3.resource.tempelet.GlitterTemplet",Ro=Wr),r=Ao.prototype,v.imps(r,{"laya.d3.core.render.IRenderable":!0}),r._getVertexBuffer=function(e){return 0===(e=void 0===e?0:e)?this._vertexBuffer:null},r._getIndexBuffer=function(){return null},r._initialize=function(){this._vertexBuffer=Es.create(Jt.vertexDeclaration,2*this.maxSegments,35048),this._vertices=new Float32Array(this.maxSegments*this._floatCountPerVertex*2)},r._onActiveHierarchyChanged=function(e){e||(this._numPositionMode=0,this._numPositionVelocityMode=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0)},r._updateTextureCoordinates=function(){this._firstActiveElement<this._firstFreeElement?this._updateSubTextureCoordinates(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this._updateSubTextureCoordinates(this._firstActiveElement,2*(this.maxSegments-this._firstActiveElement)),0<this._firstFreeElement&&this._updateSubTextureCoordinates(0,2*this._firstFreeElement))},r._updateSubTextureCoordinates=function(e,t){for(var n=2*e,i=0;i<t;i+=2){var r=n+i,a=r*this._floatCountPerVertex,r=(r+1)*this._floatCountPerVertex;this._vertices[3+a]=this._vertices[3+r]=(this._vertices[5+a]-this._currentTime)/this.lifeTime}},r._retireActiveGlitter=function(){for(var e=this.lifeTime,t=2*this._floatCountPerVertex;this._firstActiveElement!=this._firstNewElement;){var n=this._firstActiveElement*t+5;if(this._currentTime-this._vertices[n]<e)break;this._vertices[n]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.maxSegments&&(this._firstActiveElement=0)}},r._freeRetiredGlitter=function(){for(var e=2*this._floatCountPerVertex;this._firstRetiredElement!=this._firstActiveElement&&!(this._drawCounter-this._vertices[this._firstRetiredElement*e+5]<3);)this._firstRetiredElement++,this._firstRetiredElement>=this.maxSegments&&(this._firstRetiredElement=0)},r._calcVelocity=function(e,t,n){W.subtract(e,t,n),W.scale(n,.5,n)},r._addNewGlitterSegementToVertexBuffer=function(){var e=0;this._firstActiveElement<this._firstFreeElement?(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex)):(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this.maxSegments-this._firstActiveElement)*this._floatCountPerVertex),0<this._firstFreeElement&&this._vertexBuffer.setData(this._vertices,0,0,2*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},r._addGlitter=function(e,t,n){this._needPatch&&(this._needPatch=!1,this._addGlitter(this._lastPatchAddPos0,this._lastPatchAddPos1,this._lastPatchAddTime));for(var i=this._firstFreeElement+1,r=(i>=this.maxSegments&&(i=0,e.cloneTo(this._lastPatchAddPos0),t.cloneTo(this._lastPatchAddPos1),this._lastPatchAddTime=n,this._needPatch=!0),i===this._firstRetiredElement&&console.log("GlitterTemplet:current segement count have large than maxSegments,please adjust the  value of maxSegments or add Glitter Vertex Frequency."),e.elements),a=t.elements,o=0,s=this._firstFreeElement*this._floatCountPerVertex*2,o=0;o<3;o++)this._vertices[s+o]=r[o];this._vertices[3+s]=0,this._vertices[4+s]=0,this._vertices[5+s]=n;var l=s+this._floatCountPerVertex;for(o=0;o<3;o++)this._vertices[l+o]=a[o];this._vertices[l+3]=0,this._vertices[l+4]=1,this._vertices[l+5]=n,this._firstFreeElement=i},r._update=function(e){this._currentTime+=e/1e3,this._retireActiveGlitter(),this._freeRetiredGlitter(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this._updateTextureCoordinates()},r._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this._addNewGlitterSegementToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer.bindWithIndexBuffer(null),!0)},r._render=function(e){var t=0,n=c.mainContext;this._firstActiveElement<this._firstFreeElement?(t=2*(this._firstFreeElement-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,t),T.trianglesFaces+=t-2,T.drawCall++):(t=2*(this.maxSegments-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,t),T.trianglesFaces+=t-2,T.drawCall++,0<this._firstFreeElement&&(t=2*this._firstFreeElement,n.drawArrays(5,0,t),T.trianglesFaces+=t-2,T.drawCall++))},r.addVertexPosition=function(e,t){var n,i;this._owner.activeInHierarchy&&(this._numPositionMode<2?(0===this._numPositionMode?(e.cloneTo(this._posModeLastPosition0),t.cloneTo(this._posModeLastPosition1)):(e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)),this._numPositionMode++):(n=this._tempVector2,this._calcVelocity(e,this._posModeLastPosition0,n),i=this._tempVector3,this._calcVelocity(t,this._posModeLastPosition1,i),this.addVertexPositionVelocity(this._posModePosition0,n,this._posModePosition1,i),this._posModePosition0.cloneTo(this._posModeLastPosition0),this._posModePosition1.cloneTo(this._posModeLastPosition1),e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)))},r.addVertexPositionVelocity=function(e,t,n,i){if(this._owner.activeInHierarchy){if(0===this._numPositionVelocityMode)this._numPositionVelocityMode++;else{var r,a,o=this._tempVector0,s=(W.subtract(e,this._posVelModePosition0,o),W.scalarLength(o)),o=(W.subtract(n,this._posVelModePosition1,o),W.scalarLength(o));if(s<a&&o<a)return;if(1===(r=1+Math.floor(Math.max(s,o)/this.minInterpDistance)))this._addGlitter(e,n,this._currentTime);else{r=Math.min(r,this.maxSlerpCount),this.scLeft.Init(this._posVelModePosition0,this._posVelModeVelocity0,e,t),this.scRight.Init(this._posVelModePosition1,this._posVelModeVelocity1,n,i);for(var l=1/r,h=l,_=this._currentTime-this._lastTime,u=1;u<=r;u++){var d=this._tempVector0,c=(this.scLeft.Slerp(h,d),this._tempVector1),f=(this.scRight.Slerp(h,c),this._lastTime+_*u/r);this._addGlitter(d,c,f),h+=l}}}this._lastTime=this._currentTime,e.cloneTo(this._posVelModePosition0),t.cloneTo(this._posVelModeVelocity0),n.cloneTo(this._posVelModePosition1),i.cloneTo(this._posVelModeVelocity1)}},r._destroy=function(){Ro.prototype._destroy.call(this),this._tempVector0=null,this._tempVector1=null,this._tempVector2=null,this._tempVector3=null,this._owner=null,this._vertices=null,this._vertexBuffer.destroy(),this._vertexBuffer=null,this.scLeft=null,this.scRight=null,this._posModeLastPosition0=null,this._posModeLastPosition1=null,this._posModePosition0=null,this._posModePosition1=null,this._posVelModePosition0=null,this._posVelModeVelocity0=null,this._posVelModePosition1=null,this._posVelModeVelocity1=null,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null},r._getVertexBuffers=function(){return null},n(0,r,"maxSegments",function(){return this._maxSegments-1},function(e){e+=1;e!==this._maxSegments&&(this._maxSegments=e,this._vertexBuffer&&this._vertexBuffer.destroy(),this._initialize())}),n(0,r,"_vertexBufferCount",function(){return 1}),n(0,r,"triangleCount",function(){var e=0;return this._firstActiveElement<this._firstFreeElement?e=2*(this._firstFreeElement-this._firstActiveElement)-2:(e=2*(this.maxSegments-this._firstActiveElement)-2,e+=2*this._firstFreeElement-2),e}),n(0,r,"_originalBoundingSphere",function(){return v.superGet(Wr,this,"_originalBoundingSphere")}),n(0,r,"_originalBoundingBox",function(){return v.superGet(Wr,this,"_originalBoundingBox")});var Ro,Io=Ao;function Ao(e){this._floatCountPerVertex=6,this._owner=null,this._vertices=null,this._vertexBuffer=null,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=NaN,this._drawCounter=0,this.scLeft=null,this.scRight=null,this._numPositionMode=0,this._numPositionVelocityMode=0,this._lastTime=NaN,this._needPatch=!1,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null,this._lastPatchAddTime=NaN,this.lifeTime=NaN,this.minSegmentDistance=NaN,this.minInterpDistance=NaN,this.maxSlerpCount=0,this._maxSegments=0,Ao.__super.call(this),this._tempVector0=new W,this._tempVector1=new W,this._tempVector2=new W,this._tempVector3=new W,this._posModeLastPosition0=new W,this._posModeLastPosition1=new W,this._posModePosition0=new W,this._posModePosition1=new W,this._posVelModePosition0=new W,this._posVelModeVelocity0=new W,this._posVelModePosition1=new W,this._posVelModeVelocity1=new W,this._owner=e,this._lastTime=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,this._needPatch=!1,this._lastPatchAddPos0=new W,this._lastPatchAddPos1=new W,this.scLeft=new Ee,this.scRight=new Ee,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this._maxSegments=200,this._owner.on("activeinhierarchychanged",this,this._onActiveHierarchyChanged)}t(Oo,"laya.d3.terrain.TerrainFilter",Co=Wr),l=Oo.prototype,v.imps(l,{"laya.d3.core.render.IRenderable":!0}),l._destroy=function(){Co.prototype._destroy.call(this),this._owner=null,this._vertexBuffer&&this._vertexBuffer.destroy(),this._indexBuffer&&this._indexBuffer.destroy()},l.recreateResource=function(){this._currentNumberIndices=0,this._numberTriangle=0;for(var e=Dr.LEAF_VERTEXT_COUNT,t=Dr.LEAF_MAX_INDEX_COUNT,e=(this._numberVertices=e*this._leafNum,this._maxNumberIndices=t*this._leafNum,this._indexArrayBuffer=new Uint16Array(this._maxNumberIndices),xi.vertexDeclaration),n=e.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=Dr.CHUNK_GRID_NUM/Dr.LEAF_GRID_NUM,a=0,o=0,s=0,a=0;a<this._leafNum;a++)o=a%r,s=Math.floor(a/r),this._leafs[a].calcVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,o*Dr.LEAF_GRID_NUM,s*Dr.LEAF_GRID_NUM,this._gridSize,i,a*Dr.LEAF_PLANE_VERTEXT_COUNT,n,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight,this._cameraCoordinateInverse);for(a=0;a<this._leafNum;a++)o=a%r,s=Math.floor(a/r),this._leafs[a].calcSkirtVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,o*Dr.LEAF_GRID_NUM,s*Dr.LEAF_GRID_NUM,this._gridSize,i,this._leafNum*Dr.LEAF_PLANE_VERTEXT_COUNT+a*Dr.LEAF_SKIRT_VERTEXT_COUNT,n,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight);this.assembleIndexInit(),this._vertexBuffer=new Es(e,this._numberVertices,35044,!1),this._indexBuffer=new ds("ushort",this._maxNumberIndices,35044,!1),this._vertexBuffer.setData(i),this._indexBuffer.setData(this._indexArrayBuffer),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.calcOriginalBoudingBoxAndSphere()},l.setLODLevel=function(e){if(4==e.length){e=(e[0]+1<<24)+(e[1]+1<<16)+(e[2]+1<<8)+(e[3]+1);if(this._currentLOD==e)return!1;this._currentLOD=e}return!0},l.assembleIndexInit=function(){this._currentNumberIndices=0;for(var e=this._numberTriangle=0,t=0;t<this._leafNum;t++){var n=Dr.getPlaneLODIndex(t,0),i=(this._indexArrayBuffer.set(n,e),e+=n.length,Dr.getSkirtLODIndex(t,0));this._indexArrayBuffer.set(i,e),e+=i.length,this._currentNumberIndices+=n.length+i.length}this._numberTriangle=this._currentNumberIndices/3},l.isNeedAssemble=function(e,t){e=Math.min(e.viewport.width,e.viewport.height)/(2*Math.tan(Math.PI*e.fieldOfView/180));return this._perspectiveFactor!=e?(this._perspectiveFactor=e,1):this._LODTolerance!=pl.LOD_TOLERANCE_VALUE?(this._LODTolerance=pl.LOD_TOLERANCE_VALUE,1):0==W.equals(t,this._cameraPos)?(this._cameraPos.x=t.x,this._cameraPos.y=t.y,this._cameraPos.z=t.z,2):0},l.assembleIndex=function(e,t){var n=this.isNeedAssemble(e,t);if(0<n){for(var i=0;i<this._leafNum;i++)Oo._TEMP_ARRAY_BUFFER[i]=this._leafs[i].determineLod(t,this._perspectiveFactor,pl.LOD_TOLERANCE_VALUE,1==n);if(this.setLODLevel(Oo._TEMP_ARRAY_BUFFER)){this._currentNumberIndices=0;for(var r=this._numberTriangle=0,i=0;i<this._leafNum;i++){var a=Oo._TEMP_ARRAY_BUFFER[i],o=Dr.getPlaneLODIndex(i,a),a=(this._indexArrayBuffer.set(o,r),r+=o.length,Dr.getSkirtLODIndex(i,a));this._indexArrayBuffer.set(a,r),r+=a.length,this._currentNumberIndices+=o.length+a.length}return this._numberTriangle=this._currentNumberIndices/3,!0}}return!1},l.calcOriginalBoudingBoxAndSphere=function(){for(var e=new ar(2147483647,-2147483647),t=0;t<this._leafNum;t++)e.x=(this._leafs[t]._sizeOfY.x<e.x?this._leafs[t]._sizeOfY:e).x,e.y=(this._leafs[t]._sizeOfY.y>e.y?this._leafs[t]._sizeOfY:e).y;var n=new W(this._chunkOffsetX*Dr.CHUNK_GRID_NUM*this._gridSize,e.x,this._chunkOffsetZ*Dr.CHUNK_GRID_NUM*this._gridSize),i=new W((this._chunkOffsetX+1)*Dr.CHUNK_GRID_NUM*this._gridSize,e.y,(this._chunkOffsetZ+1)*Dr.CHUNK_GRID_NUM*this._gridSize),r=(Dr.__ADAPT_MATRIX__&&(W.transformV3ToV3(n,Dr.__ADAPT_MATRIX__,n),W.transformV3ToV3(i,Dr.__ADAPT_MATRIX__,i)),this._boundingBox=new bi(n,i),new W),i=(W.subtract(i,n,r),W.scale(r,.5,r),new W);W.add(n,r,i),this._boundingSphere=new Gi(i,W.scalarLength(r)),this._boundingBoxCorners=w(8,null),this._boundingBox.getCorners(this._boundingBoxCorners)},l.calcLeafBoudingBox=function(e){for(var t=0;t<this._leafNum;t++)this._leafs[t].calcLeafBoudingBox(e)},l.calcLeafBoudingSphere=function(e,t){for(var n=0;n<this._leafNum;n++)this._leafs[n].calcLeafBoudingSphere(e,t)},l._getVertexBuffer=function(e){return 0==(e=void 0===e?0:e)?this._vertexBuffer:null},l._getIndexBuffer=function(){return this._indexBuffer},l._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),0==e.renderElement._material.blend&&(e=e.camera,this.assembleIndex(e,e.position))&&this._indexBuffer.setData(this._indexArrayBuffer),!0},l._getVertexBuffers=function(){return null},l._render=function(e){c.mainContext.drawElements(pl.RENDER_LINE_MODEL?1:4,this._currentNumberIndices,5123,0),T.trianglesFaces+=this._numberTriangle,T.drawCall++},n(0,l,"_originalBoundingSphere",function(){return this._boundingSphere}),n(0,l,"_originalBoundingBox",function(){return this._boundingBox}),n(0,l,"_vertexBufferCount",function(){return this._numberVertices}),n(0,l,"triangleCount",function(){return this._numberTriangle}),e(Oo,["_TEMP_ARRAY_BUFFER",function(){return this._TEMP_ARRAY_BUFFER=new Uint32Array(Dr.CHUNK_GRID_NUM/Dr.LEAF_GRID_NUM*Dr.CHUNK_GRID_NUM/Dr.LEAF_GRID_NUM)}]);var Co,yo=Oo;function Oo(e,t,n,i,r,a,o,s){this._owner=null,this._gridSize=NaN,this.memorySize=0,this._numberVertices=0,this._maxNumberIndices=0,this._currentNumberIndices=0,this._numberTriangle=0,this._vertexBuffer=null,this._indexBuffer=null,this._boundingSphere=null,this._boundingBox=null,this._indexArrayBuffer=null,this._boundingBoxCorners=null,this._leafs=null,this._leafNum=0,this._terrainHeightData=null,this._terrainHeightDataWidth=0,this._terrainHeightDataHeight=0,this._chunkOffsetX=0,this._chunkOffsetZ=0,this._cameraCoordinateInverse=!1,this._cameraPos=null,this._currentLOD=0,this._perspectiveFactor=NaN,this._LODTolerance=0,Oo.__super.call(this),this._owner=e,this._cameraPos=new W,this._chunkOffsetX=t,this._chunkOffsetZ=n,this._gridSize=i,this._terrainHeightData=r,this._terrainHeightDataWidth=a,this._terrainHeightDataHeight=o,this._leafNum=Dr.CHUNK_GRID_NUM/Dr.LEAF_GRID_NUM*(Dr.CHUNK_GRID_NUM/Dr.LEAF_GRID_NUM),this._leafs=w(this._leafNum),this._cameraCoordinateInverse=s;for(var l=0;l<this._leafNum;l++)this._leafs[l]=new Dr;this.recreateResource()}t(Lo,"laya.d3.terrain.TerrainRender",No=Xr),(d=Lo.prototype)._calculateBoundingSphere=function(){var e,t,n,i,r=this._terrainSprite3DOwner.terrainFilter;null==r?this._boundingSphere.toDefault():(e=r._originalBoundingSphere,i=NaN,i=(n=(t=this._terrainSprite3DOwner.transform).scale).x>=n.y&&n.x>=n.z?n.x:n.y>=n.z?n.y:n.z,W.transformCoordinate(e.center,t.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*i,r.calcLeafBoudingSphere(t.worldMatrix,i))},d._calculateBoundingBox=function(){var e=this._terrainSprite3DOwner.terrainFilter;if(null==e)this._boundingBox.toDefault();else{for(var t=this._terrainSprite3DOwner.transform.worldMatrix,n=e._boundingBoxCorners,i=0;i<8;i++)W.transformCoordinate(n[i],t,Xr._tempBoundBoxCorners[i]);bi.createfromPoints(Xr._tempBoundBoxCorners,this._boundingBox),e.calcLeafBoudingBox(t)}},d._renderUpdate=function(e){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);e=this._owner.getProjectionViewWorldMatrix(e);return this._setShaderValueMatrix4x4(1,e),!0},d._destroy=function(){No.prototype._destroy.call(this),this._terrainSprite3DOwner=null};var No,Vo=Lo;function Lo(e){this._terrainSprite3DOwner=null,Lo.__super.call(this,e),this._terrainSprite3DOwner=e}var wo;t(Fo,"laya.d3.water.WaterRender",wo=Xr),(r=Fo.prototype)._calculateBoundingSphere=function(){},r._calculateBoundingBox=function(){},r._destroy=function(){wo.prototype._destroy.call(this)};function Fo(e){Fo.__super.call(this,e)}t(Bo,"laya.d3.core.scene.Scene",Po=a),l=Bo.prototype,v.imps(l,{"laya.webgl.submit.ISubmit":!0,"laya.resource.ICreateResource":!0}),l._setUrl=function(e){this._url=e},l._getGroup=function(){return this._group},l._setGroup=function(e){this._group=e},l._display=function(){v.stage._scenes.push(this),v.stage._scenes.sort(Bo._sortScenes);for(var e=0,t=this._childs.length;e<t;e++){var n=this._childs[e];n.active&&n._activeHierarchy()}},l._unDisplay=function(){var e=v.stage._scenes;e.splice(e.indexOf(this),1);for(var t=0,n=this._childs.length;t<n;t++){var i=this._childs[t];i.active&&i._inActiveHierarchy()}},l._addChild3D=function(e){e.transform._onWorldTransform(),e._setBelongScene(this),this.displayedInStage&&e.active&&e._activeHierarchy()},l._removeChild3D=function(e){e.transform.parent=null,this.displayedInStage&&e.active&&e._inActiveHierarchy(),e._setUnBelongScene()},l.initOctree=function(e,t,n,i,r){void 0===r&&(r=6),this.treeSize=new W(e,t,n),this.treeLevel=r,this.treeRoot=new ft(this,0),this.treeRoot.init(i,this.treeSize)},l._prepareUpdateToRenderState=function(e,t){t.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,t.scene=this},l._prepareSceneToRender=function(e){var t=this._lights.length;if(0<t)for(var n=0,i=0;i<t&&!(this._lights[i]._prepareToScene(e)&&++n>=this._enableLightCount);i++);},l._updateChilds=function(e){for(var t=0,n=this._childs.length;t<n;++t)this._childs[t]._update(e)},l._preRenderScene=function(e,t,n){var i,r=t._viewMatrix,a=t._projectionMatrix,o=t._projectionViewMatrix,s=0,l=t.camera;for(l.useOcclusionCulling?this.treeRoot?kt.renderObjectCullingOctree(n,this,l,r,a,o):kt.renderObjectCulling(n,this,l,r,a,o):kt.renderObjectCullingNoBoundFrustum(this,l,r,a,o),s=0,i=this._quenes.length;s<i;s++)this._quenes[s]&&this._quenes[s]._preRender(t)},l._clear=function(e,t){var n=t._viewport,i=t.camera,r=n.x,a=i.renderTargetSize.height-n.y-n.height,o=n.width,s=n.height,l=(e.viewport(r,a,o,s),256),h=i.renderTarget;switch(i.clearFlag){case 0:var _,u=i.clearColor;if(u&&(e.enable(3089),e.scissor(r,a,o,s),_=u.elements,e.clearColor(_[0],_[1],_[2],_[3]),l|=16384),h)switch(u||(l=16384),h.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l=l|256|1024}e.clear(l),u&&e.disable(3089);break;case 1:case 2:if(h)switch(l=16384,h.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l=l|256|1024}e.clear(l);break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}},l._renderScene=function(e,t){for(var n,i,r,a=t.camera,o=0,o=0;o<2;o++)(i=this._quenes[o])&&(a.renderTarget?i._render(t,!0):i._render(t,!1));for(1===a.clearFlag&&(r=a.sky)&&(f.setCullFace(e,!1),f.setDepthFunc(e,515),f.setDepthMask(e,!1),r._render(t),f.setDepthFunc(e,513),f.setDepthMask(e,!0)),o=2,n=this._quenes.length;o<n;o++)(i=this._quenes[o])&&(i._sortAlpha(t.camera.transform.position),a.renderTarget?i._render(t,!0):i._render(t,!1))},l._set3DRenderConfig=function(e){e.disable(3042),f._blend=!1,e.blendFunc(770,771),f._sFactor=770,f._dFactor=771,e.disable(2929),f._depthTest=!1,e.enable(2884),f._cullFace=!0,e.depthMask(1),f._depthMask=!0,e.frontFace(2304),f._frontFace=2304},l._set2DRenderConfig=function(e){f.setBlend(e,!0),f.setBlendFunc(e,1,771),f.setDepthTest(e,!1),f.setCullFace(e,!1),f.setDepthMask(e,!0),f.setFrontFace(e,2305),e.viewport(0,0,ee.width,ee.height)},l._parseCustomProps=function(e,t,n,i){var r=i.customProps.lightmaps,a=r.length,o=this._lightmaps;o.length=a;for(var s=0;s<a;s++)o[s]=K.getRes(t[r[s].replace(".exr",".png")]);this.setlightmaps(o);var l=i.customProps.ambientColor,l=(l&&(this.ambientColor=new W(l[0],l[1],l[2])),i.customProps.fogColor);l&&(this.fogColor=new W(l[0],l[1],l[2]))},l._addLight=function(e){this._lights.indexOf(e)<0&&this._lights.push(e)},l._removeLight=function(e){e=this._lights.indexOf(e);0<=e&&this._lights.splice(e,1)},l._updateScene=function(){var e=this._renderState;this._prepareUpdateToRenderState(c.mainContext,e),this._updateComponents(e),this._updateChilds(e),this._lateUpdateComponents(e),this._time+=e.elapsedTime/1e3,this._shaderValues.setValue(22,this._time)},l._updateSceneConch=function(){var e=this._renderState;this._prepareUpdateToRenderState(c.mainContext,e),this._updateComponents(e),this._lateUpdateComponents(e),this._prepareSceneToRender(e);for(var t=0,n=this._cameraPool.length;t<n;t++){var i=this._cameraPool[t];(e.camera=i)._prepareCameraToRender()}},l._preRenderShadow=function(e,t,n,i,r){this.treeRoot?kt.renderShadowObjectCullingOctree(this,t,n,i,r):kt.renderShadowObjectCulling(this,t,n,i,r);for(var a=0,o=n.length;a<o;a++)n[a]&&n[a]._preRender(e)},l._renderShadowMap=function(e,t,n){var i,r,a,o=this.parallelSplitShadowMaps[0],s=(o._calcAllLightCameraInfo(n),o.PSSMNum);if(this._preRenderShadow(t,o._lightCulling,o._shadowQuenes,o._lightVPMatrix[0],s),this.addShaderDefine(Tr.SHADERDEFINE_CAST_SHADOW),1<s)for(var l=0;l<s;l++)i=o.getRenderTarget(l+1),o.beginRenderTarget(l+1),e.clearColor(1,1,1,1),e.clear(16640),e.viewport(0,0,i.width,i.height),t.camera=a=o.getLightCamera(l),a._prepareCameraToRender(),a._prepareCameraViewProject(a.viewMatrix,a.projectionMatrix),t._projectionViewMatrix=o._lightVPMatrix[l+1],(r=o._shadowQuenes[l])._preRender(t),r._renderShadow(t,!1),o.endRenderTarget(l+1);else i=o.getRenderTarget(1),o.beginRenderTarget(1),e.clearColor(1,1,1,1),e.clear(16640),e.viewport(0,0,i.width,i.height),t.camera=a=o.getLightCamera(0),a._prepareCameraToRender(),a._prepareCameraViewProject(a.viewMatrix,a.projectionMatrix),t._projectionViewMatrix=o._lightVPMatrix[0],(r=o._shadowQuenes[0])._preRender(t),r._renderShadow(t,!0),o.endRenderTarget(1);this.removeShaderDefine(Tr.SHADERDEFINE_CAST_SHADOW)},l.addTreeNode=function(e){this.treeRoot.addTreeNode(e)},l.removeTreeNode=function(e){this.treeSize&&e._treeNode&&e._treeNode.removeObject(e)},l.setlightmaps=function(e){this._lightmaps=e;for(var t=0,n=this._renderableSprite3Ds.length;t<n;t++)this._renderableSprite3Ds[t]._render._applyLightMapParams()},l.getlightmaps=function(){return this._lightmaps},l.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e===this)return e;var n;if(e.zOrder&&this._set$P("hasZorder",!0),0<=t&&t<=this._childs.length)return e._parent===this?(n=this.getChildIndex(e),this._childs.splice(n,1),this._childs.splice(t,0,e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,t)),this._childChanged()):(e.parent&&e.parent.removeChild(e),this._childs===$.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(t,0,e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,t),(e.parent=this)._addChild3D(e)),e;throw new Error("appendChildAt:The index is out of bounds")},l.addChild=function(e){var t;if(e instanceof laya.d3.core.Sprite3D)return e&&!this.destroyed&&e!==this&&(e.zOrder&&this._set$P("hasZorder",!0),e._parent===this?(t=this.getChildIndex(e))!==this._childs.length-1&&(this._childs.splice(t,1),this._childs.push(e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,this._childs.length-1)),this._childChanged()):(e.parent&&e.parent.removeChild(e),this._childs===$.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,this._childs.length-1),(e.parent=this)._childChanged(),this._addChild3D(e))),e;throw new Error("Sprite3D:Node type must Sprite3D.")},l.removeChildAt=function(e){var t=this.getChildAt(e);return t&&(this._removeChild3D(t),this._childs.splice(e,1),this.conchModel&&this.conchModel.removeChild(t.conchModel),t.parent=null),t},l.removeChildren=function(e,t){if(void 0===e&&(e=0),void 0===t&&(t=2147483647),this._childs&&0<this._childs.length){var n,i=this._childs;0===e&&a<=t?(n=i,this._childs=$.ARRAY_EMPTY):n=i.splice(e,t-e);for(var r=0,a=n.length;r<a;r++)this._removeChild3D(n[r]),n[r].parent=null,this.conchModel&&this.conchModel.removeChild(n[r].conchModel)}return this},l.addFrustumCullingObject=function(e){this.treeRoot?this.addTreeNode(e):(this._cullingRendersLength===this._cullingRenders.length?this._cullingRenders.push(e):this._cullingRenders[this._cullingRendersLength]=e,e._indexInSceneFrustumCullingObjects=this._cullingRendersLength++)},l.removeFrustumCullingObject=function(e){var t,n;this.treeRoot?this.removeTreeNode(e):(this._cullingRendersLength--,(t=e._indexInSceneFrustumCullingObjects)!==this._cullingRendersLength&&(n=this._cullingRenders[this._cullingRendersLength],(this._cullingRenders[t]=n)._indexInSceneFrustumCullingObjects=t,e._indexInSceneFrustumCullingObjects=-1))},l.getRenderQueue=function(e){return e<3e3?this._quenes[1]||(this._quenes[1]=new _t(this)):this._quenes[2]||(this._quenes[2]=new _t(this))},l.addRenderQuene=function(){this._quenes[this._customRenderQueneIndex++]=new _t(this)},l.addShaderDefine=function(e){this._shaderDefineValue|=e},l.removeShaderDefine=function(e){this._shaderDefineValue&=~e},l.addScript=function(e){return this._addComponent(e)},l.getScriptByType=function(e,t){return this._getComponentByType(e,t=void 0===t?0:t)},l.getScriptsByType=function(e,t){this._getComponentsByType(e,t)},l.getScriptByIndex=function(e){return this._getComponentByIndex(e)},l.removeScriptByType=function(e,t){this._removeComponentByType(e,t=void 0===t?0:t)},l.removeScriptsByType=function(e){this._removeComponentByType(e)},l.removeAllScript=function(){this._removeAllComponent()},l.render=function(e,t,n){(J._context.ctx._renderKey=0)<this._childs.length&&e.addRenderObject(this)},l.renderSubmit=function(){var e,t=c.mainContext,n=this._renderState,i=(this._set3DRenderConfig(t),this._prepareSceneToRender(this._renderState),0),r=0;if(Ur.debugMode||ft.debugMode)for(i=0,r=this._cameraPool.length;i<r;i++)e=this._cameraPool[i],Ur._debugPhasorSprite.begin(1,e),e.activeInHierarchy&&e._renderCamera(t,n,this),Ur._debugPhasorSprite.end();else for(i=0,r=this._cameraPool.length;i<r;i++)(e=this._cameraPool[i]).activeInHierarchy&&e._renderCamera(t,n,this);return this._set2DRenderConfig(t),1},l.onAsynLoaded=function(e,t,n){var i=t[0];if("Scene"!==i.type)throw new Error("Scene: the .lh file root type must be Scene,please use other function to  load  this file.");t=t[1];br._createNodeByJson(this,i,this,t),this.event("hierarchyloaded",[this]),this.__loaded=!0},l.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(Po.prototype.destroy.call(this,e),this._renderState=null,this._lights=null,this._lightmaps=null,this._renderTargetTexture=null,this._shaderValues=null,this._cullingRenders=null,this._dynamicBatchManager=null,this._quenes=null,this._cameraPool=null,this._renderableSprite3Ds=null,this.treeRoot=null,this.treeSize=null,this.parallelSplitShadowMaps=null,this._typeComponentsIndices=null,this._components=null,K.clearRes(this.url),this.loaded)||Ur._cancelLoadByUrl(this.url)},l.getRenderType=function(){return 0},l.releaseRender=function(){},l._addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1===n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");n=Y.getInstance(e);t.push(this._components.length),this._components.push(n);return n._initialize(this),n},l._removeComponent=function(e,t){var n=this._typeComponentsIndices[e],i=n[t],r=this._components[i];this._components.splice(i,1),n.splice(t,1),0===n.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1));for(var a=0,o=this._componentsMap.length;a<o;a++)for(var s=(n=this._typeComponentsIndices[a]).length-1;0<=s;s--){var l=n[s];if(!(i<l))break;n[s]=--l}r._destroy()},l._getComponentByType=function(e,t){void 0===t&&(t=0);e=this._componentsMap.indexOf(e);return-1===e?null:this._components[this._typeComponentsIndices[e][t]]},l._getComponentsByType=function(e,t){e=this._componentsMap.indexOf(e);if(-1===e)t.length=0;else{var n=this._typeComponentsIndices[e],i=n.length;t.length=i;for(var r=0;r<i;r++)t[r]=this._components[n[r]]}},l._getComponentByIndex=function(e){return this._components[e]},l._removeComponentByType=function(e,t){void 0===t&&(t=0);e=this._componentsMap.indexOf(e);-1!==e&&this._removeComponent(e,t)},l._removeComponentsByType=function(e){var t=this._componentsMap.indexOf(e);if(-1!==t)for(var n=this._typeComponentsIndices[t],i=0,r=n.length;i<r;n.length<r?r--:i++)this._removeComponent(t,i)},l._removeAllComponent=function(){for(var e=0,t=this._componentsMap.length;e<t;this._componentsMap.length<t?t--:e++)this._removeComponentsByType(this._componentsMap[e])},l._updateComponents=function(e){for(var t=0,n=this._components.length;t<n;t++){var i=this._components[t];i.started||(i._start(e),i.started=!0),i.enable&&i._update(e)}},l._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];n.started||(n._start(e),n.started=!0),n.enable&&n._lateUpdate(e)}},l._preRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];n.started||(n._start(e),n.started=!0),n.enable&&n._preRenderUpdate(e)}},l._postRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];n.started||(n._start(e),n.started=!0),n.enable&&n._postRenderUpdate(e)}},n(0,l,"_loaded",null,function(e){this.__loaded=e}),n(0,l,"fogColor",function(){return this._fogColor},function(e){this._fogColor=e,this._shaderValues.setValue(0,e.elements)}),n(0,l,"enableFog",function(){return this._enableFog},function(e){this._enableFog!==e&&((this._enableFog=e)?(this.addShaderDefine(g.SHADERDEFINE_FOG),this.removeShaderDefine(g.SAHDERDEFINE_DEPTHFOG)):this.removeShaderDefine(g.SHADERDEFINE_FOG))}),n(0,l,"url",function(){return this._url}),n(0,l,"loaded",function(){return this.__loaded}),n(0,l,"enableDepthFog",function(){return this._enableDepthFog},function(e){this._enableDepthFog!=e&&((this._enableDepthFog=e)?(this.addShaderDefine(g.SAHDERDEFINE_DEPTHFOG),this.removeShaderDefine(g.SHADERDEFINE_FOG)):this.removeShaderDefine(g.SAHDERDEFINE_DEPTHFOG))}),n(0,l,"fogStart",function(){return this._fogStart},function(e){this._fogStart=e,this._shaderValues.setValue(1,e)}),n(0,l,"fogRange",function(){return this._fogRange},function(e){this._fogRange=e,this._shaderValues.setValue(2,e)}),n(0,l,"ambientColor",function(){return this._ambientColor},function(e){this._ambientColor=e,this._shaderValues.setValue(21,e.elements)}),n(0,l,"scene",function(){return this}),n(0,l,"renderableSprite3Ds",function(){return this._renderableSprite3Ds.slice()}),Bo._sortScenes=function(e,t){var n;return e.parent===v.stage&&t.parent===v.stage?(n=v.stage._childs).indexOf(e)-n.indexOf(t):e.parent!==v.stage&&t.parent!==v.stage?Bo._sortScenes(e.parent,t.parent):e.parent===v.stage?-1:1},Bo.load=function(e){return v.loader.create(e,null,null,Bo)},Bo.FOGCOLOR=0,Bo.FOGSTART=1,Bo.FOGRANGE=2,Bo.LIGHTDIRECTION=3,Bo.LIGHTDIRCOLOR=4,Bo.POINTLIGHTPOS=5,Bo.POINTLIGHTRANGE=6,Bo.POINTLIGHTATTENUATION=7,Bo.POINTLIGHTCOLOR=8,Bo.SPOTLIGHTPOS=9,Bo.SPOTLIGHTDIRECTION=10,Bo.SPOTLIGHTSPOT=11,Bo.SPOTLIGHTRANGE=12,Bo.SPOTLIGHTATTENUATION=13,Bo.SPOTLIGHTCOLOR=14,Bo.SHADOWDISTANCE=15,Bo.SHADOWLIGHTVIEWPROJECT=16,Bo.SHADOWMAPPCFOFFSET=17,Bo.SHADOWMAPTEXTURE1=18,Bo.SHADOWMAPTEXTURE2=19,Bo.SHADOWMAPTEXTURE3=20,Bo.AMBIENTCOLOR=21,Bo.TIME=22;var Po,bo=Bo;function Bo(){this._time=0,this._enableLightCount=3,this._customRenderQueneIndex=11,this.enableLight=!0,Bo.__super.call(this),this._renderState=new dt,this._lights=[],this._quenes=[],this._cameraPool=[],this._renderableSprite3Ds=[],this.__loaded=!0,this._lightmaps=[],this._shaderValues=new gr,this.parallelSplitShadowMaps=[],this._dynamicBatchManager=new zt,this._cullingRenders=[],this._cullingRendersLength=0,this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new W(.7,.7,.7),this.ambientColor=new W(.212,.227,.259),c.shaderHighPrecision&&this.addShaderDefine(g.SHADERDEFINE_HIGHPRECISION),this.on("display",this,this._display),this.on("undisplay",this,this._unDisplay),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[]}t(Ho,"laya.d3.core.Sprite3D",i),d=Ho.prototype,v.imps(d,{"laya.d3.core.render.IUpdate":!0,"laya.resource.ICreateResource":!0,"laya.d3.core.IClone":!0}),d._setUrl=function(e){this._url=e},d._getGroup=function(){return this._group},d._setGroup=function(e){this._group=e},d._addChild3D=function(e){e.transform.parent=this.transform,this._hierarchyAnimator&&(e._hierarchyAnimator||e._setHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(e,!0,[e.name])),this._scene&&(e._setBelongScene(this._scene),this._activeInHierarchy)&&e._active&&e._activeHierarchy()},d._removeChild3D=function(e){e.transform.parent=null,this._scene&&(this._activeInHierarchy&&e._active&&e._inActiveHierarchy(),e._setUnBelongScene()),this._hierarchyAnimator&&(e._hierarchyAnimator==this._hierarchyAnimator&&e._clearHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(e,!1,[e.name]))},d._parseBaseCustomProps=function(e){var t=this.transform.localPosition,t=(t.fromArray(e.translate),this.transform.localPosition=t,this.transform.localRotation),t=(t.fromArray(e.rotation),this.transform.localRotation=t,this.transform.localScale),t=(t.fromArray(e.scale),this.transform.localScale=t,e.layer);null!=t&&(this.layer=Se.getLayerByNumber(t))},d._parseCustomComponent=function(e,t,n){for(var i in n){var r=n[i];switch(i){case"Animator":for(var a=this.addComponent(ka),o=(r.avatarPath?a.avatar=K.getRes(t[r.avatarPath]):(h=r.avatar)&&(a.avatar=K.getRes(t[h.path]),h=h.linkSprites)&&e.once("hierarchyloaded",this,this._onRootNodeHierarchyLoaded,[a,h]),r.clipPaths),s=o.length,l=0;l<s;l++)a.addClip(K.getRes(t[o[l]]));a.clip=K.getRes(t[o[0]]);var h=r.playOnWake;void 0!==h&&(a.playOnWake=h);break;case"Rigidbody":this.addComponent(Ka);break;case"SphereCollider":var _=this.addComponent(Ws),u=(_.isTrigger=r.isTrigger,_.center);u.fromArray(r.center),_.center=u,_.radius=r.radius;break;case"BoxCollider":u=this.addComponent(Us),_=(u.isTrigger=r.isTrigger,u.center.fromArray(r.center),u.size);_.fromArray(r.size),u.size=_;break;case"MeshCollider":this.addComponent(Gs)}}},d._onRootNodeHierarchyLoaded=function(e,t){for(var n in t){for(var i=this,r=t[n],a=0,o=r.length;a<o;a++){var s=r[a];if(""===s)break;if(!(i=i.getChildByName(s)))break}i&&e.linkSprite3DToAvatarNode(n,i)}},d._setHierarchyAnimator=function(e,t){this._changeHierarchyAnimator(e);for(var n=0,i=this._childs.length;n<i;n++){var r=this._childs[n];r._hierarchyAnimator==t&&r._setHierarchyAnimator(e,t)}},d._clearHierarchyAnimator=function(e,t){this._changeHierarchyAnimator(t);for(var n=0,i=this._childs.length;n<i;n++){var r=this._childs[n];r._hierarchyAnimator==e&&r._clearHierarchyAnimator(e,t)}},d._getAnimatorToLinkSprite3D=function(e,t,n){var i=this.getComponentByType(ka);i&&(i.avatar?i.avatar._version||e._setAnimatorToLinkAvatar(i,t):e._setAnimatorToLinkSprite3DNoAvatar(i,t,n)),this._parent&&this._parent instanceof laya.d3.core.Sprite3D&&(n.unshift(this._parent.name),(i=this._parent)._hierarchyAnimator)&&i._getAnimatorToLinkSprite3D(e,t,n)},d._setAnimatorToLinkSprite3DNoAvatar=function(e,t,n){for(var i=0,r=0,i=0,r=e.getClipCount();i<r;i++)e._handleSpriteOwnersBySprite(i,t,n,this);for(i=0,r=this._childs.length;i<r;i++){var a=this._childs[i],o=n.length;n.push(a.name),a._setAnimatorToLinkSprite3DNoAvatar(e,t,n),n.splice(o,1)}},d._changeHierarchyAnimator=function(e){this._hierarchyAnimator=e},d._isLinkSpriteToAnimationNode=function(e,t,n){var i=e._avatarNodes.indexOf(t),r=e._cacheSpriteToNodesMap;n?(this._transform.dummy=t.transform,e._cacheNodesToSpriteMap[i]=r.length,r.push(i)):(this._transform.dummy=null,n=e._cacheNodesToSpriteMap[i],e._cacheNodesToSpriteMap[i]=null,r.splice(n,1))},d._setBelongScene=function(e){this._scene=e;for(var t=0,n=this._childs.length;t<n;t++)this._childs[t]._setBelongScene(e)},d._setUnBelongScene=function(){this._scene=null;for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._setUnBelongScene()},d._activeHierarchy=function(){var e=0,t=0;for(this._activeInHierarchy=!0,this._addSelfRenderObjects(),e=0,t=this._colliders.length;e<t;e++)this._layer._addCollider(this._colliders[e]);for(this.event("activeinhierarchychanged",!0),e=0,t=this._childs.length;e<t;e++){var n=this._childs[e];n._active&&n._activeHierarchy()}},d._inActiveHierarchy=function(){var e=0,t=0;for(this._activeInHierarchy=!1,this._clearSelfRenderObjects(),e=0,t=this._colliders.length;e<t;e++){var n=this._colliders[e];n._clearCollsionMap(),this._layer._removeCollider(n)}for(this.event("activeinhierarchychanged",!1),e=0,t=this._childs.length;e<t;e++){var i=this._childs[e];i._active&&i._inActiveHierarchy()}},d.addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1===n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");n=Y.getInstance(e);if(t.push(this._components.length),this._components.push(n),n instanceof laya.d3.component.physics.Collider)this.getComponentByType(Ka)&&(n._isRigidbody=!0),this._activeInHierarchy&&this._layer._addCollider(n),this._colliders.push(n);else if(n instanceof laya.d3.component.Animator){e=n;this._setHierarchyAnimator(e,this._parent?this._parent._hierarchyAnimator:null),this._setAnimatorToLinkSprite3DNoAvatar(e,!0,[])}else if(n instanceof laya.d3.component.Rigidbody)for(var i=0,r=this._colliders.length;i<r;i++)this._colliders[i]._setIsRigidbody(!0);return n instanceof laya.d3.component.Script&&this._scripts.push(n),n._initialize(this),n},d._removeComponent=function(e,t){var n=0,i=0,r=this._typeComponentsIndices[e],a=r[t],o=this._components[a];if(o instanceof laya.d3.component.physics.Collider){var s=o;this._activeInHierarchy&&this._layer._removeCollider(s),this._colliders.splice(this._colliders.indexOf(s),1)}else if(o instanceof laya.d3.component.Animator)this._clearHierarchyAnimator(o,this._parent?this._parent._hierarchyAnimator:null);else if(o instanceof laya.d3.component.Rigidbody)for(n=0,i=this._colliders.length;n<i;n++){var l,h=this._colliders[n],_=(h._setIsRigidbody(!1),h._runtimeCollisonMap),u=h._runtimeCollisonTestMap;for(l in _)delete u[l]}for(this._components.splice(a,1),o instanceof laya.d3.component.Script&&this._scripts.splice(this._scripts.indexOf(o),1),r.splice(t,1),0===r.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1)),n=0,i=this._componentsMap.length;n<i;n++)for(var d=(r=this._typeComponentsIndices[n]).length-1;0<=d;d--){var c=r[d];if(!(a<c))break;r[d]=--c}o._destroy()},d._clearSelfRenderObjects=function(){},d._addSelfRenderObjects=function(){},d._parseCustomProps=function(e,t,n,i){},d._updateChilds=function(e){var t=this._childs.length;if(0!==t)for(var n=0;n<t;++n)this._childs[n]._update(e)},d._getSortID=function(e,t){return 1e3*t.id+e._getVertexBuffer().vertexDeclaration.id},d._update=function(e){(e.owner=this)._activeInHierarchy&&(this._updateComponents(e),this._lateUpdateComponents(e),T.spriteCount++,this._childs.length)&&this._updateChilds(e)},d.getProjectionViewWorldMatrix=function(e){return R.multiply(e,this.transform.worldMatrix,this._projectionViewWorldMatrix),this._projectionViewWorldMatrix},d.loadHierarchy=function(e){this.addChild(laya.d3.core.Sprite3D.load(e))},d.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e===this)return e;var n;if(e.zOrder&&this._set$P("hasZorder",!0),0<=t&&t<=this._childs.length)return e._parent===this?(n=this.getChildIndex(e),this._childs.splice(n,1),this._childs.splice(t,0,e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,t)),this._childChanged()):(e.parent&&e.parent.removeChild(e),this._childs===$.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(t,0,e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,t),(e.parent=this)._addChild3D(e)),e;throw new Error("appendChildAt:The index is out of bounds")},d.addChild=function(e){var t;if(e instanceof laya.d3.core.Sprite3D)return e&&!this.destroyed&&e!==this&&(e.zOrder&&this._set$P("hasZorder",!0),e._parent===this?(t=this.getChildIndex(e))!==this._childs.length-1&&(this._childs.splice(t,1),this._childs.push(e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,this._childs.length-1)),this._childChanged()):(e.parent&&e.parent.removeChild(e),this._childs===$.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,this._childs.length-1),(e.parent=this)._childChanged(),this._addChild3D(e))),e;throw new Error("Sprite3D:Node type must Sprite3D.")},d.removeChildAt=function(e){var t=this.getChildAt(e);return t&&(this._removeChild3D(t),this._childs.splice(e,1),this.conchModel&&this.conchModel.removeChild(t.conchModel),t.parent=null),t},d.removeChildren=function(e,t){if(void 0===e&&(e=0),void 0===t&&(t=2147483647),this._childs&&0<this._childs.length){var n,i=this._childs;0===e&&a<=t?(n=i,this._childs=$.ARRAY_EMPTY):n=i.splice(e,t-e);for(var r=0,a=n.length;r<a;r++)this._removeChild3D(n[r]),n[r].parent=null,this.conchModel&&this.conchModel.removeChild(n[r].conchModel)}return this},d.onAsynLoaded=function(e,t,n){var i=t[0];if("Sprite3D"!==i.type)throw new Error("Sprite3D: The .lh file root type must be Sprite3D,please use other function to  load  this file.");t=t[1];br._createNodeByJson(this,i,this,t),this.event("hierarchyloaded",[this]),this.__loaded=!0},d.cloneTo=function(e){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");for(var t=e,e=(t.name=this.name,t._destroyed=this._destroyed,t.timer=this.timer,t._$P=this._$P,t.active=this._active,t.transform.localPosition),e=(this.transform.localPosition.cloneTo(e),t.transform.localPosition=e,t.transform.localRotation),e=(this.transform.localRotation.cloneTo(e),t.transform.localRotation=e,t.transform.localScale),n=(this.transform.localScale.cloneTo(e),t.transform.localScale=e,t.isStatic=this.isStatic,0),i=0,n=0,i=this._componentsMap.length;n<i;n++){var r=t.addComponent(this._componentsMap[n]);this._components[n]._cloneTo(r)}for(n=0,i=this._childs.length;n<i;n++)t.addChild(this._childs[n].clone());var a=t.getComponentByType(ka);if(a){var o=a._linkSpritesData;if(o)for(var s in o){for(var l=o[s],h=t,_=0,u=l.length;_<u&&(h=h.getChildByName(l[_]));_++);h&&(s=a._avatarNodeMap[s],h._isLinkSpriteToAnimationNode(a,s,!0))}}},d.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},d.destroy=function(e){if(void 0===e&&(e=!0),!this.destroyed){laya.display.Node.prototype.destroy.call(this,e);for(var t=0,t=0,n=this._components.length;t<n;t++)this._components[t]._destroy();this._components=null,this._componentsMap=null,this._typeComponentsIndices=null,this._transform=null,this._colliders=null,K.clearRes(this.url),this.loaded||Ur._cancelLoadByUrl(this.url)}},d._handleSpriteToAvatar=function(e,t){e._avatarNodes;var n=e._avatarNodeMap[this.name];n&&n.name===this.name&&!this._transform.dummy&&this._isLinkSpriteToAnimationNode(e,n,t)},d._setAnimatorToLinkAvatar=function(e,t){this._handleSpriteToAvatar(e,t);for(var n=0,i=this._childs.length;n<i;n++)this._childs[n]._setAnimatorToLinkAvatar(e,t)},n(0,d,"activeInHierarchy",function(){return this._activeInHierarchy}),n(0,d,"_loaded",null,function(e){this.__loaded=e}),n(0,d,"active",function(){return this._active},function(e){this._active!==e&&(this._active=e,this._parent)&&(this._parent===this._scene&&this._parent.displayedInStage||this._parent._activeInHierarchy)&&(e?this._activeHierarchy():this._inActiveHierarchy())}),n(0,d,"componentsCount",function(){return this._components.length}),n(0,d,"loaded",function(){return this.__loaded}),n(0,d,"id",function(){return this._id}),n(0,d,"url",function(){return this._url}),n(0,d,"layer",function(){return this._layer},function(e){if(this._layer!==e){if(!e)throw new Error("Layer value can be null.");if(this._activeInHierarchy){var t=0,n=this._colliders.length;if(this._layer)for(t=0;t<n;t++)this._layer._removeCollider(this._colliders[t]);for(t=0;t<n;t++)e._addCollider(this._colliders[t])}this._layer=e,this.event("layerchanged",e)}}),n(0,d,"scene",function(){return this._scene}),n(0,d,"transform",function(){return this._transform}),Ho.instantiate=function(e,t,n,i,r){void 0===n&&(n=!0);var a=e.clone(),t=(t&&t.addChild(a),a.transform);return n?(n=t.worldMatrix,e.transform.worldMatrix.cloneTo(n),t.worldMatrix=n):(i&&(t.position=i),r&&(t.rotation=r)),a},Ho.load=function(e){return v.loader.create(e,null,null,Ho)},Ho.WORLDMATRIX=0,Ho.MVPMATRIX=1,Ho._uniqueIDCounter=0,Ho._nameNumberCounter=0;var Uo=Ho;function Ho(e){Ho.__super.call(this),this.__loaded=!0,this._projectionViewWorldUpdateLoopCount=-1,this._activeInHierarchy=!1,this._projectionViewWorldMatrix=new R,this._shaderValues=new gr,this._colliders=[],this._id=++Ho._uniqueIDCounter,this._transform=new Zr(this),this.name=e||"Sprite3D-"+Ho._nameNumberCounter++,this.layer=Se.currentCreationLayer,this.active=!0}t(Wo,"laya.d3.core.material.BlinnPhongMaterial",Go=Va),(r=Wo.prototype).disableLight=function(){this._addDisablePublicShaderDefine(g.SHADERDEFINE_POINTLIGHT|g.SHADERDEFINE_SPOTLIGHT|g.SHADERDEFINE_DIRECTIONLIGHT)},r.disableFog=function(){this._addDisablePublicShaderDefine(g.SHADERDEFINE_FOG)},r.cloneTo=function(e){Go.prototype.cloneTo.call(this,e);e._enableLighting=this._enableLighting,e._albedoIntensity=this._albedoIntensity,this._albedoColor.cloneTo(e._albedoColor)},n(0,r,"renderMode",null,function(e){switch(e){case 0:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this.depthTest=513,this._removeShaderDefine(Wo.SHADERDEFINE_ADDTIVEFOG);break;case 1:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=2e3,this.alphaTest=!0,this.depthTest=513,this._removeShaderDefine(Wo.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this.depthTest=513,this._removeShaderDefine(Wo.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this.depthTest=513,this._addShaderDefine(Wo.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),n(0,r,"normalTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,e)}),n(0,r,"reflectColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),n(0,r,"tilingOffset",function(){return this._getColor(11)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET),this._setColor(11,e)}),n(0,r,"specularColor",function(){return this._getColor(8)},function(e){this._setColor(8,e)}),n(0,r,"albedoColor",function(){return this._albedoColor},function(e){var t=this._getColor(6);P.scale(e,this._albedoIntensity,t),this._albedoColor=e}),n(0,r,"albedoIntensity",function(){return this._albedoIntensity},function(e){var t;this._albedoIntensity!==e&&(t=this._getColor(6),P.scale(this._albedoColor,e,t),this._albedoIntensity=e)}),n(0,r,"albedoTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),n(0,r,"shininess",function(){return this._getNumber(9)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(9,e)}),n(0,r,"specularTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,e)}),n(0,r,"reflectTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(5,e)}),n(0,r,"enableLighting",function(){return this._enableLighting},function(e){this._enableLighting!==e&&(e?this._removeDisablePublicShaderDefine(g.SHADERDEFINE_POINTLIGHT|g.SHADERDEFINE_SPOTLIGHT|g.SHADERDEFINE_DIRECTIONLIGHT):this._addDisablePublicShaderDefine(g.SHADERDEFINE_POINTLIGHT|g.SHADERDEFINE_SPOTLIGHT|g.SHADERDEFINE_DIRECTIONLIGHT),this._enableLighting=e)}),Wo.__init__=function(){Wo.SHADERDEFINE_DIFFUSEMAP=Wo.shaderDefines.registerDefine("DIFFUSEMAP"),Wo.SHADERDEFINE_NORMALMAP=Wo.shaderDefines.registerDefine("NORMALMAP"),Wo.SHADERDEFINE_SPECULARMAP=Wo.shaderDefines.registerDefine("SPECULARMAP"),Wo.SHADERDEFINE_REFLECTMAP=Wo.shaderDefines.registerDefine("REFLECTMAP"),Wo.SHADERDEFINE_TILINGOFFSET=Wo.shaderDefines.registerDefine("TILINGOFFSET"),Wo.SHADERDEFINE_ADDTIVEFOG=Wo.shaderDefines.registerDefine("ADDTIVEFOG")},Wo.load=function(e){return v.loader.create(e,null,null,Wo)},Wo.SPECULARSOURCE_DIFFUSEMAPALPHA=0,Wo.SPECULARSOURCE_SPECULARMAP=0,Wo.RENDERMODE_OPAQUE=0,Wo.RENDERMODE_CUTOUT=1,Wo.RENDERMODE_TRANSPARENT=2,Wo.RENDERMODE_ADDTIVE=3,Wo.SHADERDEFINE_DIFFUSEMAP=0,Wo.SHADERDEFINE_NORMALMAP=0,Wo.SHADERDEFINE_SPECULARMAP=0,Wo.SHADERDEFINE_REFLECTMAP=0,Wo.SHADERDEFINE_TILINGOFFSET=0,Wo.SHADERDEFINE_ADDTIVEFOG=0,Wo.ALBEDOTEXTURE=1,Wo.NORMALTEXTURE=2,Wo.SPECULARTEXTURE=3,Wo.EMISSIVETEXTURE=4,Wo.REFLECTTEXTURE=5,Wo.ALBEDOCOLOR=6,Wo.MATERIALSPECULAR=8,Wo.SHININESS=9,Wo.MATERIALREFLECT=10,Wo.TILINGOFFSET=11,e(Wo,["defaultMaterial",function(){return this.defaultMaterial=new Wo},"shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var Go,zo=Wo;function Wo(){Wo.__super.call(this),this.setShaderName("BLINNPHONG"),this._albedoIntensity=1,this._albedoColor=new P(1,1,1,1),this._setColor(6,new P(1,1,1,1)),this._setColor(8,new W(1,1,1)),this._setNumber(9,.078125),this._setColor(10,new W(1,1,1)),this._setNumber(0,.5),this._setColor(11,new P(1,1,0,0)),this._enableLighting=!0,this.renderMode=0}t(Xo,"laya.d3.core.material.ExtendTerrainMaterial",Va),(a=Xo.prototype)._setDetailNum=function(e){switch(e){case 1:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4)}},a.disableLight=function(){this._addDisablePublicShaderDefine(g.SHADERDEFINE_POINTLIGHT|g.SHADERDEFINE_SPOTLIGHT|g.SHADERDEFINE_DIRECTIONLIGHT)},n(0,a,"diffuseScaleOffset2",null,function(e){this._setColor(7,e)}),n(0,a,"splatAlphaTexture",function(){return this._getTexture(0)},function(e){this._setTexture(0,e)}),n(0,a,"diffuseScaleOffset3",null,function(e){this._setColor(8,e)}),n(0,a,"diffuseTexture1",null,function(e){this._setTexture(1,e),this._setDetailNum(1)}),n(0,a,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=2e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthTest=515;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),n(0,a,"diffuseTexture2",function(){return this._getTexture(2)},function(e){this._setTexture(2,e),this._setDetailNum(2)}),n(0,a,"diffuseScaleOffset1",null,function(e){this._setColor(6,e)}),n(0,a,"diffuseTexture3",function(){return this._getTexture(3)},function(e){this._setTexture(3,e),this._setDetailNum(3)}),n(0,a,"diffuseTexture4",function(){return this._getTexture(4)},function(e){this._setTexture(4,e),this._setDetailNum(4)}),n(0,a,"diffuseTexture5",function(){return this._getTexture(5)},function(e){this._setTexture(5,e),this._setDetailNum(5)}),n(0,a,"diffuseScaleOffset4",null,function(e){this._setColor(9,e)}),n(0,a,"diffuseScaleOffset5",null,function(e){this._setColor(10,e)}),n(0,a,"albedo",function(){return this._getColor(14)},function(e){this._setColor(14,e)}),n(0,a,"ambientColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),n(0,a,"diffuseColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),n(0,a,"specularColor",function(){return this._getColor(13)},function(e){this._setColor(13,e)}),Xo.__init__=function(){Xo.SHADERDEFINE_DETAIL_NUM1=Xo.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM1"),Xo.SHADERDEFINE_DETAIL_NUM2=Xo.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM2"),Xo.SHADERDEFINE_DETAIL_NUM3=Xo.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM3"),Xo.SHADERDEFINE_DETAIL_NUM4=Xo.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM4"),Xo.SHADERDEFINE_DETAIL_NUM5=Xo.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM5")},Xo.RENDERMODE_OPAQUE=1,Xo.RENDERMODE_TRANSPARENT=2,Xo.SPLATALPHATEXTURE=0,Xo.DIFFUSETEXTURE1=1,Xo.DIFFUSETEXTURE2=2,Xo.DIFFUSETEXTURE3=3,Xo.DIFFUSETEXTURE4=4,Xo.DIFFUSETEXTURE5=5,Xo.DIFFUSESCALEOFFSET1=6,Xo.DIFFUSESCALEOFFSET2=7,Xo.DIFFUSESCALEOFFSET3=8,Xo.DIFFUSESCALEOFFSET4=9,Xo.DIFFUSESCALEOFFSET5=10,Xo.MATERIALAMBIENT=11,Xo.MATERIALDIFFUSE=12,Xo.MATERIALSPECULAR=13,Xo.MATERIALALBEDO=14,Xo.SHADERDEFINE_DETAIL_NUM1=0,Xo.SHADERDEFINE_DETAIL_NUM2=0,Xo.SHADERDEFINE_DETAIL_NUM3=0,Xo.SHADERDEFINE_DETAIL_NUM4=0,Xo.SHADERDEFINE_DETAIL_NUM5=0,e(Xo,["shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var ko=Xo;function Xo(){Xo.__super.call(this),this.setShaderName("ExtendTerrain"),this.renderMode=1}t(jo,"laya.d3.core.material.GlitterMaterial",Yo=Va),(l=jo.prototype).setShaderName=function(e){Yo.prototype.setShaderName.call(this,e)},n(0,l,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0;break;case 2:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0;break;case 13:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 14:this.renderQueue=3e3,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 15:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 16:this.renderQueue=3e3,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 5:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 6:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 7:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 8:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 9:this.renderQueue=3e3,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 10:this.renderQueue=3e3,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 11:this.renderQueue=3e3,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 12:this.renderQueue=3e3,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),n(0,l,"diffuseTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),n(0,l,"albedo",function(){return this._getColor(2)},function(e){this._setColor(2,e)}),n(0,l,"color",function(){return this._getColor(3)},function(e){this._setColor(3,e)}),jo.load=function(e){return v.loader.create(e,null,null,jo)},jo.RENDERMODE_OPAQUE=1,jo.RENDERMODE_OPAQUEDOUBLEFACE=2,jo.RENDERMODE_TRANSPARENT=13,jo.RENDERMODE_TRANSPARENTDOUBLEFACE=14,jo.RENDERMODE_ADDTIVE=15,jo.RENDERMODE_ADDTIVEDOUBLEFACE=16,jo.RENDERMODE_DEPTHREAD_TRANSPARENT=5,jo.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,jo.RENDERMODE_DEPTHREAD_ADDTIVE=7,jo.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,jo.RENDERMODE_NONDEPTH_TRANSPARENT=9,jo.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,jo.RENDERMODE_NONDEPTH_ADDTIVE=11,jo.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,jo.DIFFUSETEXTURE=1,jo.ALBEDO=2,jo.UNICOLOR=3,e(jo,["defaultMaterial",function(){return this.defaultMaterial=new jo}]);var Yo,Zo=jo;function jo(){jo.__super.call(this),this.setShaderName("GLITTER"),this.renderMode=1,this._setColor(3,new P(1,1,1,1)),this._setColor(2,new P(1,1,1,1))}t(qo,"laya.d3.shader.Shader3D",G),(i=qo.prototype).recreateResource=function(){this._compile(),this.completeCreate(),this.memorySize=0},i.disposeResource=function(){c.mainContext.deleteShader(this._vshader),c.mainContext.deleteShader(this._pshader),c.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._attributeParams=null,this._uniformParams=null,this.memorySize=0,this._curActTexIndex=0},i._compile=function(){if(this._vs&&this._ps&&!this._attributeParams&&!this._uniformParams){this._reCompile=!0,this._attributeParams=[],this._uniformParams=[];var e=[this._vs,this._ps],t=c.mainContext;if(this._program=t.createProgram(),this._vshader=qo._createShader(t,e[0],35633),this._pshader=qo._createShader(t,e[1],35632),t.attachShader(this._program,this._vshader),t.attachShader(this._program,this._pshader),t.linkProgram(this._program),!J.isConchApp&&g.debugMode&&!t.getProgramParameter(this._program,35714))throw t.getProgramInfoLog(this._program);for(var n=0,i=0,r=0,r=J.isConchApp?t.getProgramParameterEx(this._vs,this._ps,"",35721):t.getProgramParameter(this._program,35721),n=0;n<r;n++){var a=null,o={vartype:"attribute",ivartype:0,attrib:a=J.isConchApp?t.getActiveAttribEx(this._vs,this._ps,"",n):t.getActiveAttrib(this._program,n),location:t.getAttribLocation(this._program,a.name),name:a.name,type:a.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0};this._attributeParams.push(o)}var s=0,s=J.isConchApp?t.getProgramParameterEx(this._vs,this._ps,"",35718):t.getProgramParameter(this._program,35718);for(n=0;n<s;n++){var l=null,l=J.isConchApp?t.getActiveUniformEx(this._vs,this._ps,"",n):t.getActiveUniform(this._program,n);0<(o={vartype:"uniform",ivartype:1,attrib:a,location:t.getUniformLocation(this._program,l.name),name:l.name,type:l.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0}).name.indexOf("[0]")&&(o.name=o.name.substr(0,o.name.length-3),o.isArray=!0,o.location=t.getUniformLocation(this._program,o.name)),this._uniformParams.push(o)}for(n=0,i=this._attributeParams.length;n<i;n++)(o=this._attributeParams[n]).indexOfParams=n,o.index=1,o.value=[o.location,null],o.codename=o.name,o.name=null!=this._attributeMap[o.codename]?this._attributeMap[o.codename]:o.codename,this._attributeParamsMap.push(o.name),this._attributeParamsMap.push(o),o._this=this,o.uploadedValue=[],o.fun=this._attribute;for(n=0,i=this._uniformParams.length;n<i;n++)switch((o=this._uniformParams[n]).indexOfParams=n,o.index=1,o.value=[o.location,null],o.codename=o.name,null!=this._sceneUniformMap[o.codename]?(o.name=this._sceneUniformMap[o.codename],this._sceneUniformParamsMap.push(o.name),this._sceneUniformParamsMap.push(o)):null!=this._cameraUniformMap[o.codename]?(o.name=this._cameraUniformMap[o.codename],this._cameraUniformParamsMap.push(o.name),this._cameraUniformParamsMap.push(o)):null!=this._spriteUniformMap[o.codename]?(o.name=this._spriteUniformMap[o.codename],this._spriteUniformParamsMap.push(o.name),this._spriteUniformParamsMap.push(o)):null!=this._materialUniformMap[o.codename]?(o.name=this._materialUniformMap[o.codename],this._materialUniformParamsMap.push(o.name),this._materialUniformParamsMap.push(o)):null!=this._renderElementUniformMap[o.codename]?(o.name=this._renderElementUniformMap[o.codename],this._renderElementUniformParamsMap.push(o.name),this._renderElementUniformParamsMap.push(o)):console.log("Shader:can't find uinform name:"+o.codename+" in shader file."),o._this=this,o.uploadedValue=[],o.type){case 5124:o.fun=o.isArray?this._uniform1iv:this._uniform1i;break;case 5126:o.fun=o.isArray?this._uniform1fv:this._uniform1f;break;case 35664:o.fun=o.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:o.fun=o.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:o.fun=o.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:o.fun=this._uniform_sampler2D;break;case 35680:o.fun=this._uniform_samplerCube;break;case 35676:o.fun=this._uniformMatrix4fv;break;case 35670:o.fun=this._uniform1i;break;case 35674:o.fun=this._uinformMatrix2fv;break;case 35675:o.fun=this._uinformMatrix3fv;break;default:throw new Error("compile shader err!")}}},i._attribute=function(e,t){var n=c.mainContext,i=k._enableAtributes,e=e.location;return i[e]||n.enableVertexAttribArray(e),n.vertexAttribPointer(e,t[0],t[1],t[2],t[3],t[4]),i[e]=k._bindVertexBuffer,1},i._uniform1f=function(e,t){var n=e.uploadedValue;return n[0]!==t?(c.mainContext.uniform1f(e.location,n[0]=t),1):0},i._uniform1fv=function(e,t){var n;return t.length<4?(n=e.uploadedValue)[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(c.mainContext.uniform1fv(e.location,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],1):0:(c.mainContext.uniform1fv(e.location,t),1)},i._uniform_vec2=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]?(c.mainContext.uniform2f(e.location,n[0]=t[0],n[1]=t[1]),1):0},i._uniform_vec2v=function(e,t){var n;return t.length<2?(n=e.uploadedValue)[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(c.mainContext.uniform2fv(e.location,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],1):0:(c.mainContext.uniform2fv(e.location,t),1)},i._uniform_vec3=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]?(c.mainContext.uniform3f(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2]),1):0},i._uniform_vec3v=function(e,t){return c.mainContext.uniform3fv(e.location,t),1},i._uniform_vec4=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(c.mainContext.uniform4f(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]),1):0},i._uniform_vec4v=function(e,t){return c.mainContext.uniform4fv(e.location,t),1},i._uniformMatrix2fv=function(e,t){return c.mainContext.uniformMatrix2fv(e.location,!1,t),1},i._uniformMatrix3fv=function(e,t){return c.mainContext.uniformMatrix3fv(e.location,!1,t),1},i._uniformMatrix4fv=function(e,t){return c.mainContext.uniformMatrix4fv(e.location,!1,t),1},i._uinformMatrix2fv=function(e,t){return c.mainContext.uniformMatrix2fv(e.location,!1,t),1},i._uinformMatrix3fv=function(e,t){return c.mainContext.uniformMatrix3fv(e.location,!1,t),1},i._uniform1i=function(e,t){var n=e.uploadedValue;return n[0]!==t?(c.mainContext.uniform1i(e.location,n[0]=t),1):0},i._uniform1iv=function(e,t){return c.mainContext.uniform1iv(e.location,t),1},i._uniform_ivec2=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]?(c.mainContext.uniform2i(e.location,n[0]=t[0],n[1]=t[1]),1):0},i._uniform_ivec2v=function(e,t){return c.mainContext.uniform2iv(e.location,t),1},i._uniform_vec3i=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]?(c.mainContext.uniform3i(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2]),1):0},i._uniform_vec3vi=function(e,t){return c.mainContext.uniform3iv(e.location,t),1},i._uniform_vec4i=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(c.mainContext.uniform4i(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]),1):0},i._uniform_vec4vi=function(e,t){return c.mainContext.uniform4iv(e.location,t),1},i._uniform_sampler2D=function(e,t){var t=t.source||t.defaulteTexture.source,n=c.mainContext,i=e.uploadedValue;if(null!=i[0])return n.activeTexture(qo._TEXTURES[i[0]]),t&&f.bindTexture(n,3553,t),0;if(7<this._curActTexIndex)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return i[0]=this._curActTexIndex,n.uniform1i(e.location,this._curActTexIndex),n.activeTexture(qo._TEXTURES[this._curActTexIndex]),t&&f.bindTexture(n,3553,t),this._curActTexIndex++,1},i._uniform_samplerCube=function(e,t){var t=t.source||t.defaulteTexture.source,n=c.mainContext,i=e.uploadedValue;if(null!=i[0])return n.activeTexture(qo._TEXTURES[i[0]]),t?f.bindTexture(n,34067,t):f.bindTexture(n,34067,el.grayTexture.source),0;if(7<this._curActTexIndex)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return i[0]=this._curActTexIndex,n.uniform1i(e.location,this._curActTexIndex),n.activeTexture(qo._TEXTURES[this._curActTexIndex]),t?f.bindTexture(n,34067,t):f.bindTexture(n,34067,el.grayTexture.source),this._curActTexIndex++,1},i._noSetValue=function(e){console.log("no....:"+e.name)},i.bind=function(){return G.activeShader=this,(G.bindShader=this).activeResource(),f.UseProgram(this._program)},i.uploadAttributes=function(e,t){for(var n,i,r=0,a=0,o=this._attributeParamsMap.length;a<o;a+=2)i=this._attributeParamsMap[a+1],null!=(n=e[this._attributeParamsMap[a]])&&(t&&t[i.name]&&t[i.name].bind(),r+=i.fun.call(this,i,n));T.shaderCall+=r},i.uploadAttributesX=function(e,t){for(var n,i,r=0,a=0,o=this._attributeParamsMap.length;a<o;a+=2)i=this._attributeParamsMap[a+1],null!=(n=e[this._attributeParamsMap[a]])&&(t._bind(),r+=i.fun.call(this,i,n));T.shaderCall+=r},i.uploadSceneUniforms=function(e){for(var t,n,i=0,r=0,a=this._sceneUniformParamsMap.length;r<a;r+=2)n=this._sceneUniformParamsMap[r+1],null!=(t=e[this._sceneUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));T.shaderCall+=i},i.uploadCameraUniforms=function(e){for(var t,n,i=0,r=0,a=this._cameraUniformParamsMap.length;r<a;r+=2)n=this._cameraUniformParamsMap[r+1],null!=(t=e[this._cameraUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));T.shaderCall+=i},i.uploadSpriteUniforms=function(e){for(var t,n,i=0,r=0,a=this._spriteUniformParamsMap.length;r<a;r+=2)n=this._spriteUniformParamsMap[r+1],null!=(t=e[this._spriteUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));T.shaderCall+=i},i.uploadMaterialUniforms=function(e){for(var t,n,i=0,r=0,a=this._materialUniformParamsMap.length;r<a;r+=2)n=this._materialUniformParamsMap[r+1],null!=(t=e[this._materialUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));T.shaderCall+=i},i.uploadRenderElementUniforms=function(e){for(var t,n,i=0,r=0,a=this._renderElementUniformParamsMap.length;r<a;r+=2)n=this._renderElementUniformParamsMap[r+1],null!=(t=e[this._renderElementUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));T.shaderCall+=i},qo.create=function(e,t,n,i,r,a,o,s){return new qo(e,t,n,i,r,a,o,s)},qo.addInclude=function(e,t){ne.addInclude(e,t)},qo._createShader=function(e,t,n){n=e.createShader(n);if(e.shaderSource(n,t),e.compileShader(n),g.debugMode&&!e.getShaderParameter(n,35713))throw e.getShaderInfoLog(n);return n},qo.PERIOD_RENDERELEMENT=0,qo.PERIOD_MATERIAL=1,qo.PERIOD_SPRITE=2,qo.PERIOD_CAMERA=3,qo.PERIOD_SCENE=4,qo._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,33991],qo._count=0,e(qo,["shaderParamsMap",function(){return this.shaderParamsMap={float:5126,int:5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}},"nameKey",function(){return this.nameKey=new ie}]);var Ko=qo;function qo(e,t,n,i,r,a,o,s){if(this._curActTexIndex=0,this._program=null,this._attributeParams=null,this._uniformParams=null,this._attributeParamsMap=[],this._sceneUniformParamsMap=[],this._cameraUniformParamsMap=[],this._spriteUniformParamsMap=[],this._materialUniformParamsMap=[],this._renderElementUniformParamsMap=[],qo.__super.call(this),!e||!t)throw"Shader Error";this._id=++qo._count,this._vs=e,this._ps=t,this._attributeMap=n,this._sceneUniformMap=i,this._cameraUniformMap=r,this._spriteUniformMap=a,this._materialUniformMap=o,this._renderElementUniformMap=s,this.recreateResource()}t(Jo,"laya.d3.core.material.PBRMaterial",Qo=Va),(d=Jo.prototype).disableLight=function(){this._addDisablePublicShaderDefine(g.SHADERDEFINE_POINTLIGHT|g.SHADERDEFINE_SPOTLIGHT|g.SHADERDEFINE_DIRECTIONLIGHT)},d.disableFog=function(){this._addDisablePublicShaderDefine(g.SHADERDEFINE_FOG)},d.onAsynLoaded=function(e,t,n){Qo.prototype.onAsynLoaded.call(this,e,t,n)},d.radicalInverse_VdC=function(e){var t=new Uint32Array(1);return t[0]=(16711935&(e=(252645135&(e=(858993459&(e=(1431655765&(e=e<<16|e>>>16))<<1|(2863311530&e)>>>1))<<2|(3435973836&e)>>>2))<<4|(4042322160&e)>>>4))<<8|(4278255360&e)>>>8,2.3283064365386963e-10*t[0]},d.createHammersleyTex=function(e,t){for(var n=new Uint8Array(e*t*4),i=0,r=0,r=0;r<e*t;r++){var a=this.radicalInverse_VdC(r);n[i++]=255*a,n[i++]=0,n[i++]=0,n[i++]=255}return n},n(0,d,"normalTexture",function(){return this._getTexture(2)},function(e){this._setTexture(2,e)}),n(0,d,"has_tangent",null,function(e){this._addShaderDefine(Jo.SHADERDEFINE_HAS_TANGENT)}),n(0,d,"roughness",function(){return this._getNumber(6)},function(e){this._setNumber(6,e),this._addShaderDefine(Jo.SHADERDEFINE_FIX_ROUGHNESS)}),n(0,d,"metaless",function(){return this._getNumber(7)},function(e){this._setNumber(7,e),this._addShaderDefine(Jo.SHADERDEFINE_FIX_METALESS)}),n(0,d,"pbrlutTexture",function(){return this._getTexture(4)},function(e){this._setTexture(4,e)}),n(0,d,"use_groundtruth",null,function(e){e?(this._addShaderDefine(Jo.SHADERDEFINE_USE_GROUNDTRUTH),laya.d3.core.material.PBRMaterial.HammersleyNoiseTex||(e=this.createHammersleyTex(32,32),laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=Xs.create(e.buffer,32,32,9728,9728,!1)),this._setTexture(15,Jo.HammersleyNoiseTex)):(laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=null,this._removeShaderDefine(Jo.SHADERDEFINE_USE_GROUNDTRUTH))}),n(0,d,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e,this._setMatrix4x4(8,e.matrix),this._conchMaterial&&this._conchMaterial.setShaderValue(8,e.matrix.elements,0)}),n(0,d,"diffuseTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),n(0,d,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=2e3;break;case 13:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),n(0,d,"pbrInfoTexture",function(){return this._getTexture(3)},function(e){this._setTexture(3,e),this._addShaderDefine(Jo.SHADERDEFINE_HAS_PBRINFO)}),n(0,d,"testClipZ",null,function(e){this._addShaderDefine(Jo.SHADERDEFINE_TEST_CLIPZ)}),Jo.__init__=function(){Jo.SHADERDEFINE_FIX_METALESS=Jo.shaderDefines.registerDefine("FIX_METALESS"),Jo.SHADERDEFINE_FIX_ROUGHNESS=Jo.shaderDefines.registerDefine("FIX_ROUGHNESS"),Jo.SHADERDEFINE_HAS_TANGENT=Jo.shaderDefines.registerDefine("HAS_TANGENT"),Jo.SHADERDEFINE_HAS_PBRINFO=Jo.shaderDefines.registerDefine("HAS_PBRINFO"),Jo.SHADERDEFINE_USE_GROUNDTRUTH=Jo.shaderDefines.registerDefine("USE_GROUNDTRUTH"),Jo.SHADERDEFINE_TEST_CLIPZ=Jo.shaderDefines.registerDefine("CLIPZ")},Jo.load=function(e){return v.loader.create(e,null,null,Jo)},Jo.DIFFUSETEXTURE=1,Jo.NORMALTEXTURE=2,Jo.PBRINFOTEXTURE=3,Jo.PBRLUTTEXTURE=4,Jo.UVANIAGE=5,Jo.MATERIALROUGHNESS=6,Jo.MATERIALMETALESS=7,Jo.UVMATRIX=8,Jo.UVAGE=9,Jo.AOOBJPOS=14,Jo.HSNOISETEXTURE=15,Jo.SHADERDEFINE_FIX_ROUGHNESS=0,Jo.SHADERDEFINE_FIX_METALESS=0,Jo.SHADERDEFINE_HAS_TANGENT=0,Jo.SHADERDEFINE_TEST_CLIPZ=0,Jo.SHADERDEFINE_HAS_PBRINFO=0,Jo.SHADERDEFINE_USE_GROUNDTRUTH=0,Jo.RENDERMODE_OPAQUE=1,Jo.RENDERMODE_OPAQUEDOUBLEFACE=2,Jo.RENDERMODE_CUTOUT=3,Jo.RENDERMODE_CUTOUTDOUBLEFACE=4,Jo.RENDERMODE_TRANSPARENT=13,Jo.pbrlutTex=null,Jo.HammersleyNoiseTex=null,e(Jo,["defaultMaterial",function(){return this.defaultMaterial=new Jo},"shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var Qo,$o=Jo;function Jo(){if(this._transformUV=null,Jo.__super.call(this),!laya.d3.core.material.PBRMaterial.pbrlutTex){var e=z.window.__pbrlutdata;if(!e)throw alert("no pbr lutdata, need pbrlut.js"),"no pbr lutdata, need pbrlut.js";e=Xs.create(new Uint32Array(e).buffer,256,256,9728,9728,!1);laya.d3.core.material.PBRMaterial.pbrlutTex=e}this._setTexture(4,laya.d3.core.material.PBRMaterial.pbrlutTex),this.setShaderName("PBR"),this._setNumber(0,.5),this.use_groundtruth=!1}t(ts,"laya.d3.core.material.PBRSpecularMaterial",Va),n(0,r=ts.prototype,"albedoColor",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),n(0,r,"specularTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE),this._setTexture(2,e)}),n(0,r,"albedoTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,e)}),n(0,r,"occlusionTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._setTexture(5,e)}),n(0,r,"normalTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE),this._setTexture(3,e)}),n(0,r,"parallaxTexture",function(){return this._getTexture(4)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._setTexture(4,e)}),n(0,r,"emissionColor",function(){return this._getColor(9)},function(e){this._setColor(9,e)}),n(0,r,"normalTextureScale",function(){return this._getNumber(14)},function(e){this._setNumber(14,e)}),n(0,r,"parallaxTextureScale",function(){return this._getNumber(15)},function(e){e=Math.max(.005,Math.min(.08,e)),this._setNumber(15,e)}),n(0,r,"occlusionTextureStrength",function(){return this._getNumber(13)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(13,e)}),n(0,r,"specularColor",function(){return this._getColor(8)},function(e){this._setColor(8,e)}),n(0,r,"smoothness",function(){return this._getNumber(10)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(10,e)}),n(0,r,"smoothnessTextureScale",function(){return this._getNumber(11)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(11,e)}),n(0,r,"smoothnessSource",function(){return this._getNumber(12)},function(e){1==e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA):(this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA),e=0),this._setNumber(12,e)}),n(0,r,"enableEmission",function(){return this._getBool(16)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSION):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSION),this._setBool(16,e)}),n(0,r,"emissionTexture",function(){return this._getTexture(6)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._setTexture(6,e)}),n(0,r,"tilingOffset",function(){return this._getColor(17)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET),this._setColor(17,e)}),ts.__init__=function(){ts.SHADERDEFINE_DIFFUSETEXTURE=ts.shaderDefines.registerDefine("DIFFUSETEXTURE"),ts.SHADERDEFINE_SPECULARTEXTURE=ts.shaderDefines.registerDefine("SPECULARTEXTURE"),ts.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=ts.shaderDefines.registerDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),ts.SHADERDEFINE_NORMALTEXTURE=ts.shaderDefines.registerDefine("NORMALTEXTURE"),ts.SHADERDEFINE_PARALLAXTEXTURE=ts.shaderDefines.registerDefine("PARALLAXTEXTURE"),ts.SHADERDEFINE_OCCLUSIONTEXTURE=ts.shaderDefines.registerDefine("OCCLUSIONTEXTURE"),ts.SHADERDEFINE_EMISSION=ts.shaderDefines.registerDefine("EMISSION"),ts.SHADERDEFINE_EMISSIONTEXTURE=ts.shaderDefines.registerDefine("EMISSIONTEXTURE"),ts.SHADERDEFINE_TILINGOFFSET=ts.shaderDefines.registerDefine("TILINGOFFSET")},ts.SmoothnessSource_MetallicGlossTexture_Alpha=0,ts.SmoothnessSource_DiffuseTexture_Alpha=1,ts.SHADERDEFINE_DIFFUSETEXTURE=0,ts.SHADERDEFINE_NORMALTEXTURE=0,ts.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=0,ts.SHADERDEFINE_SPECULARTEXTURE=0,ts.SHADERDEFINE_OCCLUSIONTEXTURE=0,ts.SHADERDEFINE_PARALLAXTEXTURE=0,ts.SHADERDEFINE_EMISSION=0,ts.SHADERDEFINE_EMISSIONTEXTURE=0,ts.SHADERDEFINE_TILINGOFFSET=0,ts.DIFFUSETEXTURE=1,ts.SPECULARTEXTURE=2,ts.NORMALTEXTURE=3,ts.PARALLAXTEXTURE=4,ts.OCCLUSIONTEXTURE=5,ts.EMISSIONTEXTURE=6,ts.DIFFUSECOLOR=7,ts.SPECULARCOLOR=8,ts.EMISSIONCOLOR=9,ts.SMOOTHNESS=10,ts.SMOOTHNESSSCALE=11,ts.SMOOTHNESSSOURCE=12,ts.OCCLUSIONSTRENGTH=13,ts.NORMALSCALE=14,ts.PARALLAXSCALE=15,ts.ENABLEEMISSION=16,ts.TILINGOFFSET=17,e(ts,["shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var es=ts;function ts(){ts.__super.call(this),this.setShaderName("PBRSpecular"),this._setColor(7,new P(1,1,1,1)),this._setColor(9,new P(0,0,0,0)),this._setColor(8,new P(.2,.2,.2,.2)),this._setNumber(10,.5),this._setNumber(11,1),this._setNumber(12,0),this._setNumber(13,1),this._setNumber(14,1),this._setNumber(15,.001),this._setBool(16,!1),this._setNumber(0,.5)}t(is,"laya.d3.core.material.PBRStandardMaterial",Va),n(0,a=is.prototype,"albedoColor",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),n(0,a,"albedoTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,e)}),n(0,a,"enableEmission",function(){return this._getBool(16)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION),this._setBool(16,e)}),n(0,a,"metallicGlossTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE),this._setTexture(2,e)}),n(0,a,"occlusionTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._setTexture(5,e)}),n(0,a,"normalTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE),this._setTexture(3,e)}),n(0,a,"parallaxTexture",function(){return this._getTexture(4)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._setTexture(4,e)}),n(0,a,"emissionColor",function(){return this._getColor(8)},function(e){this._setColor(8,e)}),n(0,a,"normalTextureScale",function(){return this._getNumber(14)},function(e){this._setNumber(14,e)}),n(0,a,"parallaxTextureScale",function(){return this._getNumber(15)},function(e){e=Math.max(.005,Math.min(.08,e)),this._setNumber(15,e)}),n(0,a,"occlusionTextureStrength",function(){return this._getNumber(13)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(13,e)}),n(0,a,"metallic",function(){return this._getNumber(9)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(9,e)}),n(0,a,"smoothness",function(){return this._getNumber(10)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(10,e)}),n(0,a,"smoothnessTextureScale",function(){return this._getNumber(11)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(11,e)}),n(0,a,"smoothnessSource",function(){return this._getNumber(12)},function(e){1==e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA):(this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA),e=0),this._setNumber(12,e)}),n(0,a,"emissionTexture",function(){return this._getTexture(6)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._setTexture(6,e)}),n(0,a,"tilingOffset",function(){return this._getColor(17)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET),this._setColor(17,e)}),is.__init__=function(){is.SHADERDEFINE_DIFFUSETEXTURE=is.shaderDefines.registerDefine("DIFFUSETEXTURE"),is.SHADERDEFINE_METALLICGLOSSTEXTURE=is.shaderDefines.registerDefine("METALLICGLOSSTEXTURE"),is.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=is.shaderDefines.registerDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),is.SHADERDEFINE_NORMALTEXTURE=is.shaderDefines.registerDefine("NORMALTEXTURE"),is.SHADERDEFINE_PARALLAXTEXTURE=is.shaderDefines.registerDefine("PARALLAXTEXTURE"),is.SHADERDEFINE_OCCLUSIONTEXTURE=is.shaderDefines.registerDefine("OCCLUSIONTEXTURE"),is.SHADERDEFINE_EMISSION=is.shaderDefines.registerDefine("EMISSION"),is.SHADERDEFINE_EMISSIONTEXTURE=is.shaderDefines.registerDefine("EMISSIONTEXTURE"),is.SHADERDEFINE_TILINGOFFSET=is.shaderDefines.registerDefine("TILINGOFFSET")},is.SmoothnessSource_MetallicGlossTexture_Alpha=0,is.SmoothnessSource_DiffuseTexture_Alpha=1,is.SHADERDEFINE_DIFFUSETEXTURE=0,is.SHADERDEFINE_NORMALTEXTURE=0,is.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=0,is.SHADERDEFINE_METALLICGLOSSTEXTURE=0,is.SHADERDEFINE_OCCLUSIONTEXTURE=0,is.SHADERDEFINE_PARALLAXTEXTURE=0,is.SHADERDEFINE_EMISSION=0,is.SHADERDEFINE_EMISSIONTEXTURE=0,is.SHADERDEFINE_TILINGOFFSET=0,is.DIFFUSETEXTURE=1,is.METALLICGLOSSTEXTURE=2,is.NORMALTEXTURE=3,is.PARALLAXTEXTURE=4,is.OCCLUSIONTEXTURE=5,is.EMISSIONTEXTURE=6,is.DIFFUSECOLOR=7,is.EMISSIONCOLOR=8,is.METALLIC=9,is.SMOOTHNESS=10,is.SMOOTHNESSSCALE=11,is.SMOOTHNESSSOURCE=12,is.OCCLUSIONSTRENGTH=13,is.NORMALSCALE=14,is.PARALLAXSCALE=15,is.ENABLEEMISSION=16,is.TILINGOFFSET=17,e(is,["shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var ns=is;function is(){is.__super.call(this),this.setShaderName("PBRStandard"),this._setColor(7,new P(1,1,1,1)),this._setColor(8,new P(0,0,0,0)),this._setNumber(9,0),this._setNumber(10,.5),this._setNumber(11,1),this._setNumber(12,0),this._setNumber(13,1),this._setNumber(14,1),this._setNumber(15,.001),this._setBool(16,!1),this._setNumber(0,.5)}t(C,"laya.d3.core.material.StandardMaterial",rs=Va),(l=C.prototype).disableLight=function(){this._addDisablePublicShaderDefine(g.SHADERDEFINE_POINTLIGHT|g.SHADERDEFINE_SPOTLIGHT|g.SHADERDEFINE_DIRECTIONLIGHT)},l.disableFog=function(){this._addDisablePublicShaderDefine(g.SHADERDEFINE_FOG)},l.onAsynLoaded=function(e,t,n){var i=t[0];if(i.version)rs.prototype.onAsynLoaded.call(this,e,t,n);else{var r,e=t[1],a=i.props;for(r in a)this[r]=a[r];C._parseStandardMaterial(e,this,i),this._endLoaded()}},l.cloneTo=function(e){rs.prototype.cloneTo.call(this,e);this._transformUV&&(e._transformUV=this._transformUV.clone())},n(0,l,"ambientColor",function(){return this._getColor(9)},function(e){this._setColor(9,e)}),n(0,l,"ambientTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP),this._setTexture(5,e)}),n(0,l,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=2e3,this.alphaTest=!0,this._removeShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=3e3,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=3e3,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=3e3,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=3e3,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=3e3,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=3e3,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(C.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),n(0,l,"reflectColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),n(0,l,"tilingOffset",function(){return this._getColor(15)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET),this._setColor(15,e)}),n(0,l,"albedo",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),n(0,l,"diffuseColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),n(0,l,"albedoColor",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),n(0,l,"specularColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),n(0,l,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),n(0,l,"normalTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,e)}),n(0,l,"specularTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,e)}),n(0,l,"emissiveTexture",function(){return this._getTexture(4)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP),this._setTexture(4,e)}),n(0,l,"reflectTexture",function(){return this._getTexture(6)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(6,e)}),n(0,l,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e,this._setMatrix4x4(13,e.matrix),e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM),this._conchMaterial&&this._conchMaterial.setShaderValue(13,e.matrix.elements,0)}),C.__init__=function(){C.SHADERDEFINE_DIFFUSEMAP=C.shaderDefines.registerDefine("DIFFUSEMAP"),C.SHADERDEFINE_NORMALMAP=C.shaderDefines.registerDefine("NORMALMAP"),C.SHADERDEFINE_SPECULARMAP=C.shaderDefines.registerDefine("SPECULARMAP"),C.SHADERDEFINE_EMISSIVEMAP=C.shaderDefines.registerDefine("EMISSIVEMAP"),C.SHADERDEFINE_AMBIENTMAP=C.shaderDefines.registerDefine("AMBIENTMAP"),C.SHADERDEFINE_REFLECTMAP=C.shaderDefines.registerDefine("REFLECTMAP"),C.SHADERDEFINE_UVTRANSFORM=C.shaderDefines.registerDefine("UVTRANSFORM"),C.SHADERDEFINE_TILINGOFFSET=C.shaderDefines.registerDefine("TILINGOFFSET"),C.SHADERDEFINE_ADDTIVEFOG=C.shaderDefines.registerDefine("ADDTIVEFOG")},C.load=function(e){return v.loader.create(e,null,null,C)},C._parseStandardMaterial=function(e,t,n){var n=n.customProps,i=n.ambientColor,i=(t.ambientColor=new W(i[0],i[1],i[2]),n.diffuseColor),i=(t.diffuseColor=new W(i[0],i[1],i[2]),n.specularColor),i=(t.specularColor=new P(i[0],i[1],i[2],i[3]),n.reflectColor),i=(t.reflectColor=new W(i[0],i[1],i[2]),n.albedoColor),i=(i&&(t.albedo=new P(i[0],i[1],i[2],i[3])),n.diffuseTexture.texture2D),i=(i&&(t.diffuseTexture=K.getRes(e[i])),n.normalTexture.texture2D),i=(i&&(t.normalTexture=K.getRes(e[i])),n.specularTexture.texture2D),i=(i&&(t.specularTexture=K.getRes(e[i])),n.emissiveTexture.texture2D),i=(i&&(t.emissiveTexture=K.getRes(e[i])),n.ambientTexture.texture2D),i=(i&&(t.ambientTexture=K.getRes(e[i])),n.reflectTexture.texture2D);i&&(t.reflectTexture=K.getRes(e[i]))},C.RENDERMODE_OPAQUE=1,C.RENDERMODE_OPAQUEDOUBLEFACE=2,C.RENDERMODE_CUTOUT=3,C.RENDERMODE_CUTOUTDOUBLEFACE=4,C.RENDERMODE_TRANSPARENT=13,C.RENDERMODE_TRANSPARENTDOUBLEFACE=14,C.RENDERMODE_ADDTIVE=15,C.RENDERMODE_ADDTIVEDOUBLEFACE=16,C.RENDERMODE_DEPTHREAD_TRANSPARENT=5,C.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,C.RENDERMODE_DEPTHREAD_ADDTIVE=7,C.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,C.RENDERMODE_NONDEPTH_TRANSPARENT=9,C.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,C.RENDERMODE_NONDEPTH_ADDTIVE=11,C.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,C.SHADERDEFINE_DIFFUSEMAP=0,C.SHADERDEFINE_NORMALMAP=0,C.SHADERDEFINE_SPECULARMAP=0,C.SHADERDEFINE_EMISSIVEMAP=0,C.SHADERDEFINE_AMBIENTMAP=0,C.SHADERDEFINE_REFLECTMAP=0,C.SHADERDEFINE_UVTRANSFORM=0,C.SHADERDEFINE_TILINGOFFSET=0,C.SHADERDEFINE_ADDTIVEFOG=0,C.DIFFUSETEXTURE=1,C.NORMALTEXTURE=2,C.SPECULARTEXTURE=3,C.EMISSIVETEXTURE=4,C.AMBIENTTEXTURE=5,C.REFLECTTEXTURE=6,C.ALBEDO=7,C.UVANIAGE=8,C.MATERIALAMBIENT=9,C.MATERIALDIFFUSE=10,C.MATERIALSPECULAR=11,C.MATERIALREFLECT=12,C.UVMATRIX=13,C.UVAGE=14,C.TILINGOFFSET=15,e(C,["defaultMaterial",function(){return this.defaultMaterial=new C},"shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var rs,as=C;function C(){this._transformUV=null,C.__super.call(this),this.setShaderName("SIMPLE"),this._setColor(9,new W(.6,.6,.6)),this._setColor(10,new W(1,1,1)),this._setColor(11,new P(1,1,1,8)),this._setColor(12,new W(1,1,1)),this._setColor(7,new P(1,1,1,1)),this._setNumber(0,.5),this._setColor(15,new P(1,1,0,0)),this.renderMode=1}t(ls,"laya.d3.core.material.TerrainMaterial",os=Va),(i=ls.prototype).setDiffuseScale1=function(e,t){this._diffuseScale1.x=e,this._diffuseScale1.y=t,this._setColor(6,this._diffuseScale1)},i.setDiffuseScale2=function(e,t){this._diffuseScale2.x=e,this._diffuseScale2.y=t,this._setColor(7,this._diffuseScale2)},i.setDiffuseScale3=function(e,t){this._diffuseScale3.x=e,this._diffuseScale3.y=t,this._setColor(8,this._diffuseScale3)},i.setDiffuseScale4=function(e,t){this._diffuseScale4.x=e,this._diffuseScale4.y=t,this._setColor(9,this._diffuseScale4)},i.setDetailNum=function(e){switch(e){case 1:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 2:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 3:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 4:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3)}},i.disableLight=function(){this._addDisablePublicShaderDefine(g.SHADERDEFINE_POINTLIGHT|g.SHADERDEFINE_SPOTLIGHT|g.SHADERDEFINE_DIRECTIONLIGHT)},i.setShaderName=function(e){os.prototype.setShaderName.call(this,e)},n(0,i,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=2e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthTest=515;break;default:throw new Error("TerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),n(0,i,"diffuseTexture2",function(){return this._getTexture(3)},function(e){this._setTexture(3,e)}),n(0,i,"ambientColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),n(0,i,"diffuseTexture4",function(){return this._getTexture(5)},function(e){this._setTexture(5,e)}),n(0,i,"diffuseColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),n(0,i,"diffuseTexture1",function(){return this._getTexture(2)},function(e){this._setTexture(2,e)}),n(0,i,"specularColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),n(0,i,"diffuseTexture3",function(){return this._getTexture(4)},function(e){this._setTexture(4,e)}),n(0,i,"splatAlphaTexture",function(){return this._getTexture(0)},function(e){this._setTexture(0,e)}),n(0,i,"normalTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),ls.__init__=function(){ls.SHADERDEFINE_DETAIL_NUM1=ls.shaderDefines.registerDefine("DETAIL_NUM1"),ls.SHADERDEFINE_DETAIL_NUM2=ls.shaderDefines.registerDefine("DETAIL_NUM2"),ls.SHADERDEFINE_DETAIL_NUM4=ls.shaderDefines.registerDefine("DETAIL_NUM4"),ls.SHADERDEFINE_DETAIL_NUM3=ls.shaderDefines.registerDefine("DETAIL_NUM3")},ls.load=function(e){return v.loader.create(e,null,null,ls)},ls.RENDERMODE_OPAQUE=1,ls.RENDERMODE_TRANSPARENT=2,ls.SPLATALPHATEXTURE=0,ls.NORMALTEXTURE=1,ls.DIFFUSETEXTURE1=2,ls.DIFFUSETEXTURE2=3,ls.DIFFUSETEXTURE3=4,ls.DIFFUSETEXTURE4=5,ls.DIFFUSESCALE1=6,ls.DIFFUSESCALE2=7,ls.DIFFUSESCALE3=8,ls.DIFFUSESCALE4=9,ls.MATERIALAMBIENT=10,ls.MATERIALDIFFUSE=11,ls.MATERIALSPECULAR=12,ls.SHADERDEFINE_DETAIL_NUM1=0,ls.SHADERDEFINE_DETAIL_NUM2=0,ls.SHADERDEFINE_DETAIL_NUM3=0,ls.SHADERDEFINE_DETAIL_NUM4=0,e(ls,["defaultMaterial",function(){return this.defaultMaterial=new ls},"shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var os,ss=ls;function ls(){this._diffuseScale1=null,this._diffuseScale2=null,this._diffuseScale3=null,this._diffuseScale4=null,ls.__super.call(this),this.setShaderName("Terrain"),this.renderMode=1,this._diffuseScale1=new ar,this._diffuseScale2=new ar,this._diffuseScale3=new ar,this._diffuseScale4=new ar,this.ambientColor=new W(.6,.6,.6),this.diffuseColor=new W(1,1,1),this.specularColor=new P(.2,.2,.2,32)}t(O,"laya.d3.core.material.WaterMaterial",hs=Va),(d=O.prototype).disableFog=function(){this._addDisablePublicShaderDefine(g.SHADERDEFINE_FOG)},d.onAsynLoaded=function(e,t,n){hs.prototype.onAsynLoaded.call(this,e,t,n)},n(0,d,"diffuseTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),n(0,d,"normalTexture",function(){return this._getTexture(2)},function(e){this._setTexture(2,e)}),n(0,d,"underWaterTexture",function(){return this._getTexture(3)},function(e){this._setTexture(3,e)}),n(0,d,"deepColorTexture",function(){return this._getTexture(10)},function(e){this._setTexture(10,e)}),n(0,d,"useFoam",null,function(e){e?this._addShaderDefine(O.SHADERDEFINE_USE_FOAM):this._removeShaderDefine(O.SHADERDEFINE_USE_FOAM)}),n(0,d,"skyTexture",function(){return this._getTexture(11)},function(e){this._setTexture(11,e)}),n(0,d,"deepScale",function(){return this._getNumber(20)},function(e){this._setNumber(20,e)}),n(0,d,"detailTexture",function(){return this._getTexture(9)},function(e){this._setTexture(9,e)}),n(0,d,"foamTexture",function(){return this._getTexture(17)},function(e){this._setTexture(17,e)}),n(0,d,"waterInfoTexture",function(){return this._getTexture(16)},function(e){this._setTexture(16,e)}),n(0,d,"vertexDispTexture",function(){return this._getTexture(4)},function(e){this._setTexture(4,e)}),n(0,d,"currentTm",function(){return this._getNumber(8)},function(e){this._setNumber(8,e)}),n(0,d,"waveInfo",function(){return this._getBuffer(12)},function(e){this._setBuffer(12,e)}),n(0,d,"waveInfoD",function(){return this._getBuffer(13)},function(e){this._setBuffer(13,e)}),n(0,d,"waveMainDir",function(){return this._getNumber(14)},function(e){this._setNumber(14,e*Math.PI/180)}),n(0,d,"geoWaveUVScale",function(){return this._getNumber(18)},function(e){this._setNumber(18,e)}),n(0,d,"windSpeed",function(){return 0},function(e){}),n(0,d,"scrsize",null,function(e){this._setBuffer(15,e)}),n(0,d,"seaColor",function(){return this._getBuffer(19)},function(e){this._setBuffer(19,e)}),n(0,d,"useVertexDeep",function(){return this._useVertexDeep},function(e){(this._useVertexDeep=e)?this._addShaderDefine(O.SHADERDEFINE_USEVERTEXHEIGHT):this._removeShaderDefine(O.SHADERDEFINE_USEVERTEXHEIGHT)}),n(0,d,"windDir",function(){return 0},function(e){}),n(0,d,"useRefractTexture",null,function(e){e?this._addShaderDefine(O.SHADERDEFINE_USE_REFRACT_TEX):this._removeShaderDefine(O.SHADERDEFINE_USE_REFRACT_TEX)}),n(0,d,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=2e3;break;case 13:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),O.__init__=function(){O.SHADERDEFINE_CUBE_ENV=O.shaderDefines.registerDefine("CUBE_ENV"),O.SHADERDEFINE_HDR_ENV=O.shaderDefines.registerDefine("HDR_ENV"),O.SHADERDEFINE_SHOW_NORMAL=O.shaderDefines.registerDefine("SHOW_NORMAL"),O.SHADERDEFINE_USEVERTEXHEIGHT=O.shaderDefines.registerDefine("USE_VERTEX_DEEPINFO"),O.SHADERDEFINE_USE_FOAM=O.shaderDefines.registerDefine("USE_FOAM"),O.SHADERDEFINE_USE_REFRACT_TEX=O.shaderDefines.registerDefine("USE_REFR_TEX")},O.load=function(e){return v.loader.create(e,null,null,O)},O.DIFFUSETEXTURE=1,O.NORMALTEXTURE=2,O.UNDERWATERTEXTURE=3,O.VERTEXDISPTEXTURE=4,O.UVANIAGE=5,O.UVMATRIX=6,O.UVAGE=7,O.CURTM=8,O.DETAILTEXTURE=9,O.DEEPCOLORTEXTURE=10,O.SKYTEXTURE=11,O.WAVEINFO=12,O.WAVEINFOD=13,O.WAVEMAINDIR=14,O.SCRSIZE=15,O.WATERINFO=16,O.FOAMTEXTURE=17,O.GEOWAVE_UV_SCALE=18,O.SEA_COLOR=19,O.WAVEINFODEEPSCALE=20,O.SHADERDEFINE_SHOW_NORMAL=0,O.SHADERDEFINE_CUBE_ENV=0,O.SHADERDEFINE_HDR_ENV=0,O.SHADERDEFINE_USE_FOAM=0,O.SHADERDEFINE_USE_REFRACT_TEX=0,O.SHADERDEFINE_USEVERTEXHEIGHT=0,O.RENDERMODE_OPAQUE=1,O.RENDERMODE_OPAQUEDOUBLEFACE=2,O.RENDERMODE_CUTOUT=3,O.RENDERMODE_CUTOUTDOUBLEFACE=4,O.RENDERMODE_TRANSPARENT=13,e(O,["defaultMaterial",function(){return this.defaultMaterial=new O},"shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var hs,_s=O;function O(){this._useVertexDeep=!1,O.__super.call(this),this.setShaderName("Water")}t(cs,"laya.d3.graphics.IndexBuffer3D",us=k),(r=cs.prototype).setData=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295);var r=0;if("ushort"==this._indexType?(r=2,0===n&&4294967295===i||(e=new Uint16Array(e.buffer,n*r,i))):"ubyte"==this._indexType&&(r=1,0===n&&4294967295===i||(e=new Uint8Array(e.buffer,n*r,i))),this._bind(),k._gl.bufferSubData(this._bufferType,t*r,e),this._canRead)if(0!==t||0!==n||4294967295!==i){r=this._buffer.length-t;r<i&&(i=r);for(var a=0;a<i;a++)this._buffer[t+a]=e[a]}else this._buffer=e},r.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},r.disposeResource=function(){us.prototype.disposeResource.call(this),this._buffer=null,this.memorySize=0},n(0,r,"indexType",function(){return this._indexType}),n(0,r,"indexTypeByteCount",function(){return this._indexTypeByteCount}),n(0,r,"indexCount",function(){return this._indexCount}),n(0,r,"canRead",function(){return this._canRead}),cs.INDEXTYPE_UBYTE="ubyte",cs.INDEXTYPE_USHORT="ushort",cs.create=function(e,t,n,i){return new cs(e,t,n=void 0===n?35044:n,i=void 0===i?!1:i)};var us,ds=cs;function cs(e,t,n,i){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===n&&(n=35044),void 0===i&&(i=!1),cs.__super.call(this),this._indexType=e,this._indexCount=t,this._bufferUsage=n,this._bufferType=34963,this._canRead=i;if("ushort"==e)this._indexTypeByteCount=2;else{if("ubyte"!=e)throw new Error("unidentification index type.");this._indexTypeByteCount=1}n=this._indexTypeByteCount*t,this._byteLength=n,this._bind(),k._gl.bufferData(this._bufferType,n,this._bufferUsage),i?("ushort"==e?this._buffer=new Uint16Array(t):"ubyte"==e&&(this._buffer=new Uint8Array(t)),this.memorySize=2*n):this.memorySize=n}t(N,"laya.d3.core.particleShuriKen.ShurikenParticleMaterial",fs=Va),(a=N.prototype).onAsynLoaded=function(e,t,n){var i=t[0];if(i.version)fs.prototype.onAsynLoaded.call(this,e,t,n);else{var r,e=t[1],a=i.props;for(r in a)this[r]=a[r];N._parseShurikenParticleMaterial(e,this,i),this._endLoaded()}},n(0,a,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=2e3,this.alphaTest=!0,this._removeShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=3e3,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=3e3,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=3e3,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=3e3,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=3e3,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=3e3,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(N.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),n(0,a,"tintColor",function(){return this._getColor(2)},function(e){e?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._setColor(2,e)}),n(0,a,"tilingOffset",function(){return this._getColor(3)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET),this._setColor(3,e)}),n(0,a,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),N.__init__=function(){N.SHADERDEFINE_DIFFUSEMAP=N.shaderDefines.registerDefine("DIFFUSEMAP"),N.SHADERDEFINE_TINTCOLOR=N.shaderDefines.registerDefine("TINTCOLOR"),N.SHADERDEFINE_ADDTIVEFOG=N.shaderDefines.registerDefine("ADDTIVEFOG"),N.SHADERDEFINE_TILINGOFFSET=N.shaderDefines.registerDefine("TILINGOFFSET")},N.load=function(e){return v.loader.create(e,null,null,N)},N._parseShurikenParticleMaterial=function(e,t,n){var n=n.customProps,i=n.diffuseTexture.texture2D,e=(i&&(t.diffuseTexture=K.getRes(e[i])),n.tintColor);e&&(t.tintColor=new P(e[0],e[1],e[2],e[3]))},N.RENDERMODE_OPAQUE=1,N.RENDERMODE_OPAQUEDOUBLEFACE=2,N.RENDERMODE_CUTOUT=3,N.RENDERMODE_CUTOUTDOUBLEFACE=4,N.RENDERMODE_TRANSPARENT=13,N.RENDERMODE_TRANSPARENTDOUBLEFACE=14,N.RENDERMODE_ADDTIVE=15,N.RENDERMODE_ADDTIVEDOUBLEFACE=16,N.RENDERMODE_DEPTHREAD_TRANSPARENT=5,N.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,N.RENDERMODE_DEPTHREAD_ADDTIVE=7,N.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,N.RENDERMODE_NONDEPTH_TRANSPARENT=9,N.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,N.RENDERMODE_NONDEPTH_ADDTIVE=11,N.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,N.SHADERDEFINE_DIFFUSEMAP=0,N.SHADERDEFINE_TINTCOLOR=0,N.SHADERDEFINE_TILINGOFFSET=0,N.SHADERDEFINE_ADDTIVEFOG=0,N.DIFFUSETEXTURE=1,N.TINTCOLOR=2,N.TILINGOFFSET=3,e(N,["defaultMaterial",function(){return this.defaultMaterial=new N},"shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var fs,ms=N;function N(){N.__super.call(this),this.setShaderName("PARTICLESHURIKEN"),this.renderMode=6}t(gs,"laya.d3.graphics.VertexBuffer3D",ps=k),(l=gs.prototype).bindWithIndexBuffer=function(e){e&&e._bind(),this._bind()},l.setData=function(e,t,n,i){if(void 0===t&&(t=0),void 0===i&&(i=4294967295),0===(n=void 0===n?0:n)&&4294967295===i||(e=new Float32Array(e.buffer,4*n,i)),this._bind(),k._gl.bufferSubData(this._bufferType,4*t,e),this._canRead)if(0!==t||0!==n||4294967295!==i){n=this._buffer.length-t;n<i&&(i=n);for(var r=0;r<i;r++)this._buffer[t+r]=e[r]}else this._buffer=e},l.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},l.disposeResource=function(){for(var e=c.mainContext,t=this._vertexDeclaration.getVertexElements(),n=k._enableAtributes,i=0,r=t.length;i<r;i++)n[i]===this._glBuffer&&(e.disableVertexAttribArray(i),n[i]=null);ps.prototype.disposeResource.call(this),this._buffer=null,this._vertexDeclaration=null,this.memorySize=0},n(0,l,"vertexDeclaration",function(){return this._vertexDeclaration}),n(0,l,"vertexCount",function(){return this._vertexCount}),n(0,l,"canRead",function(){return this._canRead}),gs.create=function(e,t,n,i){return new gs(e,t,n=void 0===n?35044:n,i=void 0===i?!1:i)};var ps,Es=gs;function gs(e,t,n,i){this._vertexDeclaration=null,this._vertexCount=0,this._canRead=!1,void 0===i&&(i=!1),gs.__super.call(this),this._vertexDeclaration=e,this._vertexCount=t,this._bufferUsage=n,this._bufferType=34962,this._canRead=i,this.memorySize=this._byteLength=this._vertexDeclaration.vertexStride*t,this._bind(),k._gl.bufferData(this._bufferType,this._byteLength,this._bufferUsage),i&&(this._buffer=new Float32Array(this._byteLength/4))}t(Ts,"laya.d3.core.trail.TrailMaterial",Va),n(0,i=Ts.prototype,"tintColor",function(){return this._getColor(2)},function(e){this._setColor(2,e)}),n(0,i,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,e)}),n(0,i,"tilingOffset",function(){return this._getColor(3)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET),this._setColor(3,e)}),Ts.__init__=function(){Ts.SHADERDEFINE_DIFFUSETEXTURE=Ts.shaderDefines.registerDefine("DIFFUSETEXTURE"),Ts.SHADERDEFINE_TILINGOFFSET=Ts.shaderDefines.registerDefine("TILINGOFFSET")},Ts.load=function(e){return v.loader.create(e,null,null,Ts)},Ts.SHADERDEFINE_DIFFUSETEXTURE=0,Ts.SHADERDEFINE_TILINGOFFSET=0,Ts.DIFFUSETEXTURE=1,Ts.TINTCOLOR=2,Ts.TILINGOFFSET=3,e(Ts,["defaultMaterial",function(){return this.defaultMaterial=new Ts},"shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var vs=Ts;function Ts(){Ts.__super.call(this),this.setShaderName("Trail"),this._setColor(2,new P(1,1,1,1))}t(Ss,"laya.d3.extension.cartoonRender.CartoonMaterial",Va),n(0,d=Ss.prototype,"specularTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_SPECULARTEXTURE):this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_SPECULARTEXTURE),this._setTexture(2,e)}),n(0,d,"albedoTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._setTexture(1,e)}),n(0,d,"shadowColor",function(){return this._getColor(5)},function(e){this._setColor(5,e)}),n(0,d,"shadowIntensity",function(){return this._getNumber(7)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(7,e)}),n(0,d,"shadowRange",function(){return this._getNumber(6)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(6,e)}),n(0,d,"tilingOffset",function(){return this._getColor(4)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET),this._setColor(4,e)}),n(0,d,"specularRange",function(){return this._getNumber(8)},function(e){e=Math.max(.9,Math.min(1,e)),this._setNumber(8,e)}),n(0,d,"specularIntensity",function(){return this._getNumber(9)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(9,e)}),Ss.__init__=function(){Ss.SHADERDEFINE_ALBEDOTEXTURE=Ss.shaderDefines.registerDefine("DIFFUSETEXTURE"),Ss.SHADERDEFINE_SPECULARTEXTURE=Ss.shaderDefines.registerDefine("SPECULARTEXTURE")},Ss.initShader=function(){var e=Ko.nameKey.add("CartoonShader"),e=g.add(e,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_PositionWorld;\nvarying vec3 v_ViewDir;\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\t\n\tmat3 worldMat = mat3(u_WorldMat);\n\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\tv_Normal = worldMat * a_Normal;\n\tv_Texcoord0 = a_Texcoord0;\n\t\n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_PositionWorld;\nvarying vec3 v_ViewDir;\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n\n#ifdef SPECULARTEXTURE\n\tuniform sampler2D u_SpecularTexture;\n#endif\n\nuniform vec4 u_ShadowColor;\nuniform float u_ShadowRange;\nuniform float u_ShadowIntensity;\nuniform float u_SpecularRange;\nuniform float u_SpecularIntensity;\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main()\n{\n\tvec3 normal = normalize(v_Normal);\n\tvec3 viewdir = normalize(v_ViewDir);\n\tvec3 lightDir = normalize(u_DirectionLight.Direction);\n\t\n\tvec4 albedoTextureColor = vec4(1.0);\n\t#ifdef ALBEDOTEXTURE\n\t\talbedoTextureColor = texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t\n\tvec4 specularTextureColor = vec4(1.0); \n\t#ifdef SPECULARTEXTURE\n\t\tspecularTextureColor = texture2D(u_SpecularTexture, v_Texcoord0);\n\t#endif\n\t\n\tspecularTextureColor = specularTextureColor;\n\t\n\t//specularTextureColor = vec4(1.0, 1.0, 1.0, 1.0);\n\t\n\tfloat specTexColorG = specularTextureColor.g;\n\t\n\t//Overlay BlendMode 叠加\n\tvec3 albedoColor;\n\talbedoColor.r = albedoTextureColor.r > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.r) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.r * specTexColorG;\n\talbedoColor.g = albedoTextureColor.g > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.g) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.g * specTexColorG;\n\talbedoColor.b = albedoTextureColor.b > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.b) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.b * specTexColorG;\n\t\n\talbedoColor = clamp(albedoColor, 0.0, 1.0);\n\t\n\tfloat nl = max(dot(normal, -lightDir), 0.0);\n\t\n\tfloat shadowValue = nl + specTexColorG - 0.5;\n\tfloat shadow = step(shadowValue, u_ShadowRange);\n\tif(u_ShadowRange > (shadowValue + 0.01))\n\t\tshadow = 1.0;\n\telse if(u_ShadowRange < (shadowValue - 0.01))\n\t\tshadow = 0.0;\n\telse\n\t\tshadow = (u_ShadowRange - (shadowValue - 0.01)) / 0.02;\n\t\t\n\tshadow = clamp(shadow, 0.0, 1.0);\n\t\n\t//specularTextureColor.r 影响高光范围\n\tfloat specular = step(u_SpecularRange, clamp(pow(nl, specularTextureColor.r), 0.0, 1.0));\n\t//specularTextureColor.b 影响高光强度\n\tspecular = step(0.1, specular * specularTextureColor.b);\n\t\n\tvec3 albedoAreaColor = (1.0 - shadow) * albedoColor;\n\tvec3 shadowAreaColor = shadow * albedoColor * u_ShadowColor.rgb * u_ShadowIntensity;\n\tvec3 speculAreaColor = (1.0 - shadow) * albedoColor * u_SpecularIntensity * specular;\n\t\n\tvec3 finalColor = albedoAreaColor + speculAreaColor + shadowAreaColor;\n\t\n\tgl_FragColor = vec4(finalColor, 1.0);\n}\n",{a_Position:0,a_Normal:3,a_Texcoord0:2},{u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlbedoTexture:[1,1],u_SpecularTexture:[2,1],u_ShadowColor:[5,1],u_ShadowRange:[6,1],u_ShadowIntensity:[7,1],u_SpecularRange:[8,1],u_SpecularIntensity:[9,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4]});laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_ALBEDOTEXTURE=e.registerMaterialDefine("ALBEDOTEXTURE"),laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_SPECULARTEXTURE=e.registerMaterialDefine("SPECULARTEXTURE"),laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET=e.registerMaterialDefine("TILINGOFFSET")},Ss.ALBEDOTEXTURE=1,Ss.SPECULARTEXTURE=2,Ss.TILINGOFFSET=4,Ss.SHADOWCOLOR=5,Ss.SHADOWRANGE=6,Ss.SHADOWINTENSITY=7,Ss.SPECULARRANGE=8,Ss.SPECULARINTENSITY=9,Ss.SHADERDEFINE_ALBEDOTEXTURE=0,Ss.SHADERDEFINE_SPECULARTEXTURE=0,Ss.SHADERDEFINE_TILINGOFFSET=0,e(Ss,["shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);function Ss(){Ss.__super.call(this),this.setShaderName("CartoonShader"),this._setColor(5,new P(.6663285,.6544118,1,1)),this._setNumber(6,0),this._setNumber(7,.7956449),this._setNumber(8,.9820514),this._setNumber(9,1)}t(Ds,"laya.d3.extension.cartoonRender.OutlineMaterial",Va),n(0,r=Ds.prototype,"outlineTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.extension.cartoonRender.OutlineMaterial.SHADERDEFINE_OUTLINETEXTURE):this._removeShaderDefine(laya.d3.extension.cartoonRender.OutlineMaterial.SHADERDEFINE_OUTLINETEXTURE),this._setTexture(1,e)}),n(0,r,"outlineWidth",function(){return this._getNumber(2)},function(e){e=Math.max(0,Math.min(.05,e)),this._setNumber(2,e)}),n(0,r,"outlineLightness",function(){return this._getNumber(3)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(3,e)}),Ds.__init__=function(){Ds.SHADERDEFINE_OUTLINETEXTURE=Ds.shaderDefines.registerDefine("OUTLINETEXTURE")},Ds.initShader=function(){var e=Ko.nameKey.add("OutlineShader"),e=g.add(e,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform float u_OutlineWidth;\n\nvarying vec2 v_Texcoord0;\n\nvoid main()\n{\n\tv_Texcoord0 = a_Texcoord0;\n\t\n\tvec4 position = vec4(a_Position.xyz + a_Normal * u_OutlineWidth, 1.0);\n\tgl_Position = u_MvpMatrix * position;\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nvarying vec2 v_Texcoord0;\n\n#ifdef OUTLINETEXTURE\n\tuniform sampler2D u_OutlineTexture;\n#endif\nuniform float u_OutlineLightness;\n\nvoid main()\n{\n\tvec4 outlineTextureColor = vec4(1.0);\n\t#ifdef OUTLINETEXTURE\n\t\toutlineTextureColor = texture2D(u_OutlineTexture, v_Texcoord0);\n\t#endif\n\t\n\tvec3 finalColor = outlineTextureColor.rgb * u_OutlineLightness;\n\t\n\tgl_FragColor = vec4(finalColor,0.0);\n}\n",{a_Position:0,a_Normal:3,a_Texcoord0:2},{u_MvpMatrix:[1,2],u_OutlineTexture:[1,1],u_OutlineWidth:[2,1],u_OutlineLightness:[3,1]});laya.d3.extension.cartoonRender.OutlineMaterial.SHADERDEFINE_OUTLINETEXTURE=e.registerMaterialDefine("OUTLINETEXTURE")},Ds.OUTLINETEXTURE=1,Ds.OUTLINEWIDTH=2,Ds.OUTLINELIGHTNESS=3,Ds.SHADERDEFINE_OUTLINETEXTURE=0,e(Ds,["shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);function Ds(){Ds.__super.call(this),this.setShaderName("OutlineShader"),this._setNumber(2,.01581197),this._setNumber(3,1)}t(Ms,"laya.d3.extension.domino.DominoMaterial",Va),Ms.__init__=function(){},Ms.initShader=function(){var e=Ko.nameKey.add("DominoShader");g.add(e,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\nattribute vec4 a_Color;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\nvarying vec3 v_PositionWorld;\nvarying vec3 v_Normal;\nvarying vec3 v_ViewDir;\n\nvoid main()\n{\n\tv_Texcoord0 = a_Texcoord0;\n\tv_Color = a_Color;\n\t\n\tgl_Position = u_MvpMatrix * a_Position;\n\t\n\tv_Normal = mat3(u_WorldMat) * a_Normal;\n\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\nuniform DirectionLight u_DirectionLight;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\nvarying vec3 v_ViewDir; \nvarying vec3 v_Normal;\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 normal, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\t\n\t//mediump vec3 h = normalize(viewDir-light.Direction);\n\t//float nh = max (0.0, dot (h,normal));\n\t\n    lowp float ln = max (0.0, dot (-lightVec,normal));\n\tdiffuseColor = light.Color * ln;\n}\n\nvoid main()\n{\n\tvec3 diffuseColor;\n\tvec3 normal = normalize(v_Normal);\n\tvec3 viewDir = normalize(v_ViewDir);\n\tLayaAirBlinnPhongDiectionLight(normal, viewDir, u_DirectionLight, diffuseColor);\n\t\n\tgl_FragColor.xyz = diffuseColor * v_Color.xyz * 2.0;\n}\n\n",{a_Position:0,a_Normal:3,a_Color:1},{u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4]})},e(Ms,["defaultMaterial",function(){return this.defaultMaterial=new Ms},"shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var xs=Ms;function Ms(){Ms.__super.call(this),this.setShaderName("DominoShader")}t(Is,"laya.d3.extension.lineRender.LineMaterial",Va),n(0,a=Is.prototype,"tintColor",function(){return this._getColor(2)},function(e){this._setColor(2,e)}),n(0,a,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,e)}),n(0,a,"tilingOffset",function(){return this._getColor(3)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_TILINGOFFSET),this._setColor(3,e)}),Is.__init__=function(){Is.SHADERDEFINE_DIFFUSETEXTURE=Is.shaderDefines.registerDefine("DIFFUSETEXTURE"),Is.SHADERDEFINE_TILINGOFFSET=Is.shaderDefines.registerDefine("TILINGOFFSET")},Is.load=function(e){return v.loader.create(e,null,null,Is)},Is.initShader=function(){var e=Ko.nameKey.add("LineShader"),e=g.add(e,"attribute vec3 a_Position;\nattribute vec3 a_OffsetVector;\nattribute float a_Texcoord0X;\nattribute float a_Texcoord0X1;\nattribute float a_Texcoord0Y;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_VMatrix;\nuniform mat4 u_PMatrix;\n\nuniform vec4 u_TilingOffset;\n\nuniform vec4 u_WidthCurve[10];\nuniform int u_WidthCurveKeyLength;\n\nuniform vec4 u_GradientColorkey[10];\nuniform vec2 u_GradientAlphakey[10];\n\nvarying vec4 v_Color;\nvarying vec2 v_Texcoord0;\n\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\n{\n\tfloat t2 = t * t;\n\tfloat t3 = t2 * t;\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\n\tfloat b = t3 - 2.0 * t2 + t;\n\tfloat c = t3 - t2;\n\tfloat d = -2.0 * t3 + 3.0 * t2;\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\n}\n\nfloat getCurWidth(in float normalizeTime)\n{\n\tif(normalizeTime == 0.0){\n\t\treturn u_WidthCurve[0].w;\n\t}\n\telse if(normalizeTime >= 1.0){\n\t\treturn u_WidthCurve[u_WidthCurveKeyLength - 1].w;\n\t}\n\telse{\n\t\tfor(int i = 0; i < 10; i ++ )\n\t\t{\n\t\t\tif(normalizeTime == u_WidthCurve[i].x)\n\t\t\t{\n\t\t\t\treturn u_WidthCurve[i].w;\n\t\t\t}\n\t\t\t\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\n\t\t\t{\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\n\t\t\t\tfloat outTangent = lastFrame.z;\n\t\t\t\tfloat inTangent = nextFrame.y;\n\t\t\t\tfloat value1 = lastFrame.w;\n\t\t\t\tfloat value2 = nextFrame.w;\n\t\t\t\treturn hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\n\t\t\t}\n\t\t}\t\n\t}\n}\t\n\nvec4 getColorFromGradientByBlend(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tfloat colorKey = gradientColor.w;\n\t\tif(colorKey >= normalizeTime)\n\t\t{\n\t\t\tvec4 lastGradientColor = gradientColors[i-1];\n\t\t\tfloat lastColorKey = lastGradientColor.w;\n\t\t\tfloat age = (normalizeTime - lastColorKey) / (colorKey - lastColorKey);\n\t\t\tcolor.rgb = mix(gradientColors[i-1].xyz, gradientColor.xyz, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tfloat alphaKey = gradientAlpha.y;\n\t\tif(alphaKey >= normalizeTime)\n\t\t{\n\t\t\tvec2 lastGradientAlpha = gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey = lastGradientAlpha.y;\n\t\t\tfloat age = (normalizeTime - lastAlphaKey) / (alphaKey - lastAlphaKey);\n\t\t\tcolor.a = mix(lastGradientAlpha.x, gradientAlpha.x, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvec4 getColorFromGradientByFixed(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 0; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tif(gradientColor.w >= normalizeTime)\n\t\t{\n\t\t\tcolor.rgb = gradientColor.xyz;\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 0; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tif(gradientAlpha.y >= normalizeTime)\n\t\t{\n\t\t\tcolor.a = gradientAlpha.x;\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvoid main()\n{\n\t#ifdef TEXTUREMODE_STRETCH\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\n\t#else\n\t\tv_Texcoord0 = vec2(a_Texcoord0X1, a_Texcoord0Y);\n\t#endif\n\t\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0 = v_Texcoord0 * u_TilingOffset.xy + u_TilingOffset.zw;\n\t#endif\n\t\n\t#ifdef GRADIENTMODE_BLEND\n\t\tv_Color = getColorFromGradientByBlend(u_GradientColorkey, u_GradientAlphakey, a_Texcoord0X);\n\t#else\n\t\tv_Color = getColorFromGradientByFixed(u_GradientColorkey, u_GradientAlphakey, a_Texcoord0X);\n\t#endif\n\t\n\t#ifdef WORLDSPACE\n\t\tgl_Position = u_PMatrix * u_VMatrix * vec4(a_Position + a_OffsetVector * getCurWidth(a_Texcoord0X),1.0);\n\t#else\n\t\tgl_Position = u_MvpMatrix * vec4(a_Position + a_OffsetVector * getCurWidth(a_Texcoord0X),1.0);\n\t#endif\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_MainTexture;\nuniform vec4 u_MainColor;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nvoid main()\n{\n\tvec4 color = 2.0 * u_MainColor * v_Color;\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n\t\tcolor *= mainTextureColor;\n\t#endif\n\tgl_FragColor = color;\n}\n\n",{a_Position:0,a_OffsetVector:41,a_Texcoord0X:38,a_Texcoord0X1:39,a_Texcoord0Y:40},{u_MvpMatrix:[1,2],u_VMatrix:[1,3],u_PMatrix:[2,3],u_TilingOffset:[3,1],u_MainTexture:[1,1],u_MainColor:[2,1],u_WidthCurve:[3,2],u_WidthCurveKeyLength:[4,2],u_GradientColorkey:[5,2],u_GradientAlphakey:[6,2]});laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_DIFFUSETEXTURE=e.registerMaterialDefine("DIFFUSETEXTURE"),laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_TILINGOFFSET=e.registerMaterialDefine("TILINGOFFSET"),jl.SHADERDEFINE_GRADIENTMODE_BLEND=e.registerSpriteDefine("GRADIENTMODE_BLEND"),jl.SHADERDEFINE_TEXTUREMODE_STRETCH=e.registerSpriteDefine("TEXTUREMODE_STRETCH"),jl.SHADERDEFINE_WORLDSPACE=e.registerSpriteDefine("WORLDSPACE")},Is.SHADERDEFINE_DIFFUSETEXTURE=0,Is.SHADERDEFINE_TILINGOFFSET=0,Is.DIFFUSETEXTURE=1,Is.TINTCOLOR=2,Is.TILINGOFFSET=3,e(Is,["defaultMaterial",function(){return this.defaultMaterial=new Is},"shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var Rs=Is;function Is(){Is.__super.call(this),this.setShaderName("LineShader"),this._setColor(2,new P(1,1,1,1)),this.cull=0}t(As,"laya.d3.extension.lulingmen.DissolveMaterial",Va),n(0,l=As.prototype,"albedoColor",function(){return this._getColor(9)},function(e){this._setColor(9,e)}),n(0,l,"mainTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MAINTEXTURE):this._removeShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MAINTEXTURE),this._setTexture(1,e)}),n(0,l,"dissolveSpeed",function(){return this._getNumber(8)},function(e){this._setNumber(8,e)}),n(0,l,"tilingOffset",function(){return this._getColor(4)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MAINTILINGOFFSET):this._removeShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MAINTILINGOFFSET),this._setColor(4,e)}),n(0,l,"dissolveTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_DISSOLVETEXTURE):this._removeShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_DISSOLVETEXTURE),this._setTexture(2,e)}),n(0,l,"maskTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MASKTEXTURE):this._removeShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MASKTEXTURE),this._setTexture(3,e)}),n(0,l,"dissolveTilingOffset",function(){return this._getColor(5)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_DISSOLVETILINGOFFSET):this._removeShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_DISSOLVETILINGOFFSET),this._setColor(5,e)}),n(0,l,"maskTilingOffset",function(){return this._getColor(6)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MASKTILINGOFFSET):this._removeShaderDefine(laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MASKTILINGOFFSET),this._setColor(6,e)}),n(0,l,"dissolve",function(){return this._getNumber(7)},function(e){this._setNumber(7,e)}),As.__init__=function(){As.SHADERDEFINE_MAINTEXTURE=As.shaderDefines.registerDefine("MAINTEXTURE"),As.SHADERDEFINE_DISSOLVETEXTURE=As.shaderDefines.registerDefine("DISSOLVETEXTURE"),As.SHADERDEFINE_MASKTEXTURE=As.shaderDefines.registerDefine("MASKTEXTURE"),As.SHADERDEFINE_MAINTILINGOFFSET=As.shaderDefines.registerDefine("MAINTILINGOFFSET"),As.SHADERDEFINE_DISSOLVETILINGOFFSET=As.shaderDefines.registerDefine("DISSOLVETILINGOFFSET"),As.SHADERDEFINE_MASKTILINGOFFSET=As.shaderDefines.registerDefine("MASKTILINGOFFSET")},As.initShader=function(){var e=Ko.nameKey.add("Dissolve"),e=g.add(e,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nuniform vec4 u_MainTilingOffset;\nuniform vec4 u_DissolveTilingOffset;\nuniform vec4 u_MaskTilingOffset;\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec2 v_Texcoord2;\n\nvoid main()\n{\n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef MAINTILINGOFFSET\n\t\tv_Texcoord0 = (vec2(v_Texcoord0.x, v_Texcoord0.y - 1.0) * u_MainTilingOffset.xy) + u_MainTilingOffset.zw;\n\t\tv_Texcoord0 = vec2(v_Texcoord0.x, 1.0 + v_Texcoord0.y);\n\t#endif\n\t\n\tv_Texcoord1 = a_Texcoord0;\n\t#ifdef DISSOLVETILINGOFFSET\n\t\tv_Texcoord1 = (vec2(v_Texcoord1.x, v_Texcoord1.y - 1.0) * u_DissolveTilingOffset.xy) + u_DissolveTilingOffset.zw;\n\t\tv_Texcoord1 = vec2(v_Texcoord1.x, 1.0 + v_Texcoord1.y);\n\t#endif\n\t\n\tv_Texcoord2 = a_Texcoord0;\n\t\n\tgl_Position = u_MvpMatrix * a_Position;\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec2 v_Texcoord2;\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_MainTexture;\n#endif\n\n#ifdef DISSOLVETEXTURE\n\tuniform sampler2D u_DissolveTexture;\n#endif\n\n#ifdef MASKTEXTURE\n\tuniform sampler2D u_MaskTexture;\n#endif\n\nuniform vec4 u_BaseColor;\nuniform float u_Dissolve;\nuniform float u_DissolveSpeed;\n\nvoid main()\n{\n\tvec4 mainColor = u_BaseColor;\n\tmainColor.a = 1.0;\n\t#ifdef MAINTEXTURE\n\t\tmainColor *= texture2D(u_MainTexture, v_Texcoord0);\n\t#endif\n\t\n\tvec4 dissolveColor = vec4(1.0);\n\t#ifdef DISSOLVETEXTURE\n\t\tdissolveColor = texture2D(u_DissolveTexture, v_Texcoord1);\n\t#endif\n\t\n\tvec4 maskColor = vec4(1.0);\n\t#ifdef MASKTEXTURE\n\t\tmaskColor = texture2D(u_MaskTexture, v_Texcoord2);\n\t#endif\n\t\n\tvec4 outColor = mix(vec4(0.0), mainColor, maskColor);\n\tif(dissolveColor.a <= u_Dissolve){\n\t\tfloat alpha = clamp(outColor.a - u_Dissolve * 2.0 + dissolveColor.a, 0.0, 1.0);\n\t\talpha = pow(alpha, u_DissolveSpeed);\n\t\toutColor.a = alpha;\n\t}\n\t\n\tgl_FragColor = outColor;\n}\n",{a_Position:0,a_Normal:3,a_Texcoord0:2},{u_MvpMatrix:[1,2],u_MainTexture:[1,1],u_DissolveTexture:[2,1],u_MaskTexture:[3,1],u_BaseColor:[9,1],u_MainTilingOffset:[4,1],u_DissolveTilingOffset:[5,1],u_MaskTilingOffset:[6,1],u_Dissolve:[7,1],u_DissolveSpeed:[8,1]});laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MAINTEXTURE=e.registerMaterialDefine("MAINTEXTURE"),laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_DISSOLVETEXTURE=e.registerMaterialDefine("DISSOLVETEXTURE"),laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MASKTEXTURE=e.registerMaterialDefine("MASKTEXTURE"),laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MAINTILINGOFFSET=e.registerMaterialDefine("MAINTILINGOFFSET"),laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_DISSOLVETILINGOFFSET=e.registerMaterialDefine("DISSOLVETILINGOFFSET"),laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MASKTILINGOFFSET=e.registerMaterialDefine("MASKTILINGOFFSET")},As.MAINTEXTURE=1,As.DISSOLVETEXTURE=2,As.MASKTEXTURE=3,As.MAINTILINGOFFSET=4,As.DISSOLVETILINGOFFSET=5,As.MASKTILINGOFFSET=6,As.DISSOLVE=7,As.DISSOLVESPEED=8,As.BASECOLOR=9,As.SHADERDEFINE_MAINTEXTURE=0,As.SHADERDEFINE_DISSOLVETEXTURE=0,As.SHADERDEFINE_MASKTEXTURE=0,As.SHADERDEFINE_MAINTILINGOFFSET=0,As.SHADERDEFINE_DISSOLVETILINGOFFSET=0,As.SHADERDEFINE_MASKTILINGOFFSET=0,e(As,["shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);function As(){As.__super.call(this),this.setShaderName("Dissolve"),this._setColor(9,new P(1,1,1,1)),this._setNumber(7,0),this._setNumber(8,5)}t(ys,"laya.d3.extension.lulingmen.MeshParticleMaterial",Va),n(0,i=ys.prototype,"alpha",function(){return this._getNumber(6)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(6,e)}),n(0,i,"mainTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_MAINTEXTURE):this._removeShaderDefine(laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_MAINTEXTURE),this._setTexture(1,e)}),n(0,i,"maskTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_MASKTEXTURE):this._removeShaderDefine(laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_MASKTEXTURE),this._setTexture(2,e)}),n(0,i,"albedoColor",function(){return this._getColor(3)},function(e){this._setColor(3,e)}),n(0,i,"intensity",function(){return this._getNumber(5)},function(e){this._setNumber(5,e)}),n(0,i,"alphaColor",function(){return this._getColor(4)},function(e){this._setColor(4,e)}),n(0,i,"tilingOffset",function(){return this._getColor(7)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_TILINGOFFSET1):this._removeShaderDefine(laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_TILINGOFFSET1),this._setColor(7,e)}),n(0,i,"maskTilingOffset",function(){return this._getColor(8)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_TILINGOFFSET2):this._removeShaderDefine(laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_TILINGOFFSET2),this._setColor(8,e)}),ys.__init__=function(){ys.SHADERDEFINE_MAINTEXTURE=ys.shaderDefines.registerDefine("MAINTEXTURE"),ys.SHADERDEFINE_MASKTEXTURE=ys.shaderDefines.registerDefine("MASKTEXTURE"),ys.SHADERDEFINE_TILINGOFFSET1=ys.shaderDefines.registerDefine("TILINGOFFSET1"),ys.SHADERDEFINE_TILINGOFFSET2=ys.shaderDefines.registerDefine("TILINGOFFSET2")},ys.initShader=function(){var e=Ko.nameKey.add("MeshParticle"),e=g.add(e,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\nattribute vec4 a_Color;\n\nuniform mat4 u_MvpMatrix;\n\nuniform vec4 u_TilingOffset1;\nuniform vec4 u_TilingOffset2;\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec4 v_Color;\n\nvoid main()\n{\n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET1\n\t\tv_Texcoord0 = (vec2(v_Texcoord0.x, v_Texcoord0.y - 1.0) * u_TilingOffset1.xy) + u_TilingOffset1.zw;\n\t\tv_Texcoord0 = vec2(v_Texcoord0.x, 1.0 + v_Texcoord0.y);\n\t#endif\n\t\n\tv_Texcoord1 = a_Texcoord0;\n\t#ifdef TILINGOFFSET2\n\t\tv_Texcoord1 = (vec2(v_Texcoord1.x, v_Texcoord1.y - 1.0) * u_TilingOffset2.xy) + u_TilingOffset2.zw;\n\t\tv_Texcoord1 = vec2(v_Texcoord1.x, 1.0 + v_Texcoord1.y);\n\t#endif\n\t\n\tv_Color = vec4(1.0);\n\t#ifdef COLOR\n\t\tv_Color = a_Color;\n\t#endif\n\t\n\tgl_Position = u_MvpMatrix * a_Position;\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec4 v_Color;\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_MainTexture;\n#endif\n\n#ifdef MASKTEXTURE\n\tuniform sampler2D u_MaskTexture;\n#endif\n\nuniform vec4 u_BaseColor;\nuniform vec4 u_AlphaColor;\nuniform float u_Instensity;\nuniform float u_Alpha;\n\nvoid main()\n{\n\tvec4 mainTextureColor = vec4(1.0);\n\t#ifdef MAINTEXTURE\n\t\tmainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n\t#endif\n\t\n\tvec4 maskTextureColor = vec4(1.0);\n\t#ifdef MASKTEXTURE\n\t\tmaskTextureColor = texture2D(u_MaskTexture, v_Texcoord1);\n\t#endif\n\t\n\tvec4 outColor = mix(vec4(0.0), mainTextureColor, maskTextureColor);\n\t\n\tgl_FragColor = 2.0 * outColor * u_BaseColor * u_AlphaColor * u_Instensity * v_Color;\n\tgl_FragColor.a *= u_Alpha;\n}\n",{a_Position:0,a_Normal:3,a_Color:1,a_Texcoord0:2},{u_MvpMatrix:[1,2],u_MainTexture:[1,1],u_MaskTexture:[2,1],u_BaseColor:[3,1],u_AlphaColor:[4,1],u_Instensity:[5,1],u_Alpha:[6,1],u_TilingOffset1:[7,1],u_TilingOffset2:[8,1]});laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_MAINTEXTURE=e.registerMaterialDefine("MAINTEXTURE"),laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_MASKTEXTURE=e.registerMaterialDefine("MASKTEXTURE"),laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_TILINGOFFSET1=e.registerMaterialDefine("TILINGOFFSET1"),laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_TILINGOFFSET2=e.registerMaterialDefine("TILINGOFFSET2")},ys.MAINTEXTURE=1,ys.MASKTEXTURE=2,ys.BASECOLOR=3,ys.ALPHACOLOR=4,ys.INTENSITY=5,ys.ALPHA=6,ys.TILINGOFFSET1=7,ys.TILINGOFFSET2=8,ys.SHADERDEFINE_MAINTEXTURE=0,ys.SHADERDEFINE_MASKTEXTURE=0,ys.SHADERDEFINE_TILINGOFFSET1=0,ys.SHADERDEFINE_TILINGOFFSET2=0,e(ys,["shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);var Cs=ys;function ys(){ys.__super.call(this),this.setShaderName("MeshParticle"),this._setColor(3,new P(1,1,1,1)),this._setColor(4,new P(1,1,1,1)),this._setNumber(5,1),this._setNumber(6,1)}t(Os,"laya.d3.extension.lulingmen.ParticleMaterial",Va),n(0,d=Os.prototype,"alpha",function(){return this._getNumber(6)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(6,e)}),n(0,d,"tintColor",function(){return this._getColor(3)},function(e){this._setColor(3,e)}),n(0,d,"mainTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(Cs.SHADERDEFINE_MAINTEXTURE):this._removeShaderDefine(Cs.SHADERDEFINE_MAINTEXTURE),this._setTexture(1,e)}),n(0,d,"maskTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(Cs.SHADERDEFINE_MASKTEXTURE):this._removeShaderDefine(Cs.SHADERDEFINE_MASKTEXTURE),this._setTexture(2,e)}),n(0,d,"intensity",function(){return this._getNumber(5)},function(e){this._setNumber(5,e)}),n(0,d,"alphaColor",function(){return this._getColor(4)},function(e){this._setColor(4,e)}),n(0,d,"tilingOffset",function(){return this._getColor(7)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(Cs.SHADERDEFINE_TILINGOFFSET1):this._removeShaderDefine(Cs.SHADERDEFINE_TILINGOFFSET1),this._setColor(7,e)}),n(0,d,"maskTilingOffset",function(){return this._getColor(8)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(Cs.SHADERDEFINE_TILINGOFFSET2):this._removeShaderDefine(Cs.SHADERDEFINE_TILINGOFFSET2),this._setColor(8,e)}),Os.__init__=function(){Os.SHADERDEFINE_MAINTEXTURE=Os.shaderDefines.registerDefine("MAINTEXTURE"),Os.SHADERDEFINE_MASKTEXTURE=Os.shaderDefines.registerDefine("MASKTEXTURE"),Os.SHADERDEFINE_TILINGOFFSET1=Os.shaderDefines.registerDefine("TILINGOFFSET1"),Os.SHADERDEFINE_TILINGOFFSET2=Os.shaderDefines.registerDefine("TILINGOFFSET2")},Os.initShader=function(){var e=Ko.nameKey.add("Particle"),e=g.add(e,"#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\tattribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n\tattribute vec3 a_MeshPosition;\n\tattribute vec4 a_MeshColor;\n\tattribute vec2 a_MeshTextureCoordinate;\n\tvarying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef MAINTEXTURE\n\tvarying vec2 v_TextureCoordinate;\n\t#ifdef TILINGOFFSET1\n\t\tuniform vec4 u_TilingOffset1;\n\t#endif\n#endif\n\n#ifdef MASKTEXTURE\n\t#ifdef TILINGOFFSET2\n\t\tuniform vec4 u_TilingOffset2;\n\t#endif\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n\tuniform vec3 u_CameraPosition;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientW[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n\tfloat halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n\tfloat halfYaw = rot.y * 0.5;\n\n\tfloat sinRoll = sin(halfRoll);\n\tfloat cosRoll = cos(halfRoll);\n\tfloat sinPitch = sin(halfPitch);\n\tfloat cosPitch = cos(halfPitch);\n\tfloat sinYaw = sin(halfYaw);\n\tfloat cosYaw = cos(halfYaw);\n\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n\tfloat halfAngle = angle * 0.5;\n\tfloat sin = sin(halfAngle);\n\t\n\tfloat quaX = axis.x * sin;\n\tfloat quaY = axis.y * sin;\n\tfloat quaZ = axis.z * sin;\n\tfloat quaW = cos(halfAngle);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n\t  else\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n\t  else\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n\t else\n\t   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\n\tvec3 lifeVelocity;\n\tif(normalizedAge<1.0){ \n\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n\t#endif \n\tvec3 gravityVelocity=u_Gravity*age;\n\t\n\tvec4 worldRotation;\n\tif(u_SimulationSpace==0)\n\t\tworldRotation=a_SimulationWorldRotation;\n\telse\n\t\tworldRotation=u_WorldRotation;\n\t\n\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\tfloat c = cos(rot);\n\t\t\t\tfloat s = sin(rot);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat c = cos(a_StartRotation0.x);\n\t\t\t\tfloat s = sin(a_StartRotation0.x);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\tvec3 velocity;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t    if(u_VOLSpaceType==0)\n\t\t  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n\t    else\n\t\t  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n\t    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif\t\n\t\tvec3 cameraUpVector = normalize(velocity);\n\t\tvec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n\t\t\n\t\tsideVector=u_SizeScale.xzy*sideVector;\n\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n\t\t\n\t    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\n\t    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t    corner=rotaionZHalfPI*corner;\n\t    corner.y=corner.y-abs(corner.y);\n\t\t\n\t    float speed=length(velocity);//TODO:\n\t    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,1.0);\n\t    const vec3 sideVector = vec3(-1.0,0.0,0.0);\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n\t    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,-computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\t#ifdef ROTATIONOVERLIFETIME\n\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t\t\t\t//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\n\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,a_StartRotation0.z), age,normalizedAge);\n\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\n\t\t\t\t#endif\t\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\n\t\t\t\t\t#else\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t}\n\t\t#endif\n\t\tv_MeshColor=a_MeshColor;\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n\t#ifdef MAINTEXTURE\n\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n\t\t#endif\n\t\t#ifdef RENDERMODE_MESH\n\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n\t\t#endif\n\t\t\n\t\tv_Texcoord0 = v_TextureCoordinate;\n\t\t#ifdef TILINGOFFSET1 \n\t\t\tv_Texcoord0=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset1.xy+vec2(u_TilingOffset1.z,-u_TilingOffset1.w);//需要特殊处理\n\t\t\tv_Texcoord0=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n\t\t#endif\n\t\t\n\t\tv_Texcoord1 = v_TextureCoordinate;\n\t\t#ifdef TILINGOFFSET2 \n\t\t\tv_Texcoord1=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset2.xy+vec2(u_TilingOffset2.z,-u_TilingOffset2.w);//需要特殊处理\n\t\t\tv_Texcoord1=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n\t\t#endif\n\t\t\n\t#endif\n    v_Discard=0.0;\n\t  \n\t#ifdef FOG\n\t\tv_PositionWorld=center;\n\t#endif\n   }\n   else\n\t{\n\t\tv_Discard=1.0;\n\t}\n}\n\n","#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\nuniform vec4 u_BaseColor;\nuniform vec4 u_AlphaColor;\nuniform float u_Instensity;\nuniform float u_Alpha;\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_MainTexture;\n#endif\n\n#ifdef MASKTEXTURE\n\tuniform sampler2D u_MaskTexture;\n#endif\n\n#ifdef RENDERMODE_MESH\n\tvarying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n\tuniform vec3 u_CameraPosition;\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\nvoid main()\n{\t\n\t#ifdef RENDERMODE_MESH\n\t\tgl_FragColor=v_MeshColor;\n\t#else\n\t\tgl_FragColor=vec4(1.0);\t\n\t#endif\n\t\t\n\tvec4 mainTextureColor = vec4(1.0);\n\t#ifdef MAINTEXTURE\n\t\tmainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n\t#endif\n\t\n\tvec4 maskTextureColor = vec4(1.0);\n\t#ifdef MASKTEXTURE\n\t\tmaskTextureColor = texture2D(u_MaskTexture, v_Texcoord1);\n\t#endif\n\t\n\tvec4 outColor = mix(vec4(0.0), mainTextureColor, maskTextureColor);\n\t\n\tgl_FragColor *= 2.0 * outColor * u_BaseColor * u_AlphaColor * v_Color * u_Instensity;\n\tgl_FragColor.a *= u_Alpha;\n\t\n\t#ifdef FOG\n\t\tvec3 toEye=u_CameraPosition-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t\t\n\t\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}",{a_CornerTextureCoordinate:17,a_MeshPosition:0,a_MeshColor:1,a_MeshTextureCoordinate:2,a_ShapePositionStartLifeTime:30,a_DirectionTime:32,a_StartColor:19,a_EndColor:23,a_StartSize:20,a_StartRotation0:22,a_StartSpeed:31,a_Random0:34,a_Random1:35,a_SimulationWorldPostion:36,a_SimulationWorldRotation:37},{u_MainTexture:[1,1],u_MaskTexture:[2,1],u_BaseColor:[3,1],u_AlphaColor:[4,1],u_Instensity:[5,1],u_Alpha:[6,1],u_TilingOffset1:[7,1],u_TilingOffset2:[8,1],u_WorldPosition:[0,2],u_WorldRotation:[1,2],u_PositionScale:[4,2],u_SizeScale:[5,2],u_ScalingMode:[6,2],u_Gravity:[7,2],u_ThreeDStartRotation:[8,2],u_StretchedBillboardLengthScale:[9,2],u_StretchedBillboardSpeedScale:[10,2],u_SimulationSpace:[11,2],u_CurrentTime:[12,2],u_ColorOverLifeGradientAlphas:[22,2],u_ColorOverLifeGradientColors:[23,2],u_MaxColorOverLifeGradientAlphas:[24,2],u_MaxColorOverLifeGradientColors:[25,2],u_VOLVelocityConst:[13,2],u_VOLVelocityGradientX:[14,2],u_VOLVelocityGradientY:[15,2],u_VOLVelocityGradientZ:[16,2],u_VOLVelocityConstMax:[17,2],u_VOLVelocityGradientMaxX:[18,2],u_VOLVelocityGradientMaxY:[19,2],u_VOLVelocityGradientMaxZ:[20,2],u_VOLSpaceType:[21,2],u_SOLSizeGradient:[26,2],u_SOLSizeGradientX:[27,2],u_SOLSizeGradientY:[28,2],u_SOLSizeGradientZ:[29,2],u_SOLSizeGradientMax:[30,2],u_SOLSizeGradientMaxX:[31,2],u_SOLSizeGradientMaxY:[32,2],u_SOLSizeGradientMaxZ:[33,2],u_ROLAngularVelocityConst:[34,2],u_ROLAngularVelocityConstSeprarate:[35,2],u_ROLAngularVelocityGradient:[36,2],u_ROLAngularVelocityGradientX:[37,2],u_ROLAngularVelocityGradientY:[38,2],u_ROLAngularVelocityGradientZ:[39,2],u_ROLAngularVelocityGradientW:[40,2],u_ROLAngularVelocityConstMax:[41,2],u_ROLAngularVelocityConstMaxSeprarate:[42,2],u_ROLAngularVelocityGradientMax:[43,2],u_ROLAngularVelocityGradientMaxX:[44,2],u_ROLAngularVelocityGradientMaxY:[45,2],u_ROLAngularVelocityGradientMaxZ:[46,2],u_ROLAngularVelocityGradientMaxW:[47,2],u_TSACycles:[48,2],u_TSASubUVLength:[49,2],u_TSAGradientUVs:[50,2],u_TSAMaxGradientUVs:[51,2],u_CameraPosition:[0,3],u_CameraDirection:[5,3],u_CameraUp:[6,3],u_View:[1,3],u_Projection:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4]});Cs.SHADERDEFINE_MAINTEXTURE=e.registerMaterialDefine("MAINTEXTURE"),Cs.SHADERDEFINE_MASKTEXTURE=e.registerMaterialDefine("MASKTEXTURE"),Cs.SHADERDEFINE_TILINGOFFSET1=e.registerMaterialDefine("TILINGOFFSET1"),Cs.SHADERDEFINE_TILINGOFFSET2=e.registerMaterialDefine("TILINGOFFSET2"),V.SHADERDEFINE_RENDERMODE_BILLBOARD=e.registerSpriteDefine("SPHERHBILLBOARD"),V.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=e.registerSpriteDefine("STRETCHEDBILLBOARD"),V.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=e.registerSpriteDefine("HORIZONTALBILLBOARD"),V.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=e.registerSpriteDefine("VERTICALBILLBOARD"),V.SHADERDEFINE_COLOROVERLIFETIME=e.registerSpriteDefine("COLOROVERLIFETIME"),V.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=e.registerSpriteDefine("RANDOMCOLOROVERLIFETIME"),V.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=e.registerSpriteDefine("VELOCITYOVERLIFETIMECONSTANT"),V.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=e.registerSpriteDefine("VELOCITYOVERLIFETIMECURVE"),V.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=e.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),V.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=e.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),V.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=e.registerSpriteDefine("TEXTURESHEETANIMATIONCURVE"),V.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=e.registerSpriteDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),V.SHADERDEFINE_ROTATIONOVERLIFETIME=e.registerSpriteDefine("ROTATIONOVERLIFETIME"),V.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=e.registerSpriteDefine("ROTATIONOVERLIFETIMESEPERATE"),V.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=e.registerSpriteDefine("ROTATIONOVERLIFETIMECONSTANT"),V.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=e.registerSpriteDefine("ROTATIONOVERLIFETIMECURVE"),V.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=e.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),V.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=e.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),V.SHADERDEFINE_SIZEOVERLIFETIMECURVE=e.registerSpriteDefine("SIZEOVERLIFETIMECURVE"),V.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=e.registerSpriteDefine("SIZEOVERLIFETIMECURVESEPERATE"),V.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=e.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVES"),V.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=e.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),V.SHADERDEFINE_RENDERMODE_MESH=e.registerSpriteDefine("RENDERMODE_MESH"),V.SHADERDEFINE_SHAPE=e.registerSpriteDefine("SHAPE")},Os.MAINTEXTURE=1,Os.MASKTEXTURE=2,Os.BASECOLOR=3,Os.ALPHACOLOR=4,Os.INTENSITY=5,Os.ALPHA=6,Os.TILINGOFFSET1=7,Os.TILINGOFFSET2=8,Os.SHADERDEFINE_MAINTEXTURE=0,Os.SHADERDEFINE_MASKTEXTURE=0,Os.SHADERDEFINE_TILINGOFFSET1=0,Os.SHADERDEFINE_TILINGOFFSET2=0,e(Os,["shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);function Os(){Os.__super.call(this),this.setShaderName("Particle"),this._setColor(3,new P(1,1,1,1)),this._setColor(4,new P(1,1,1,1)),this._setNumber(5,1),this._setNumber(6,1)}t(Ns,"laya.d3.extension.lulingmen.UVSineMaterial",Va),n(0,r=Ns.prototype,"alpha",function(){return this._getNumber(9)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(9,e)}),n(0,r,"baseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_BASETEXTURE):this._removeShaderDefine(laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_BASETEXTURE),this._setTexture(1,e)}),n(0,r,"baseScrollSpeedX",function(){return this._getNumber(4)},function(e){this._setNumber(4,e)}),n(0,r,"secondTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_SECONDTEXTURE):this._removeShaderDefine(laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_SECONDTEXTURE),this._setTexture(2,e)}),n(0,r,"mMultiplier",function(){return this._getNumber(8)},function(e){this._setNumber(8,e)}),n(0,r,"baseScrollSpeedY",function(){return this._getNumber(5)},function(e){this._setNumber(5,e)}),n(0,r,"albedoColor",function(){return this._getColor(3)},function(e){this._setColor(3,e)}),n(0,r,"secondScrollSpeedX",function(){return this._getNumber(6)},function(e){this._setNumber(6,e)}),n(0,r,"secondScrollSpeedY",function(){return this._getNumber(7)},function(e){this._setNumber(7,e)}),n(0,r,"tilingOffset",function(){return this._getColor(10)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_TILINGOFFSET1):this._removeShaderDefine(laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_TILINGOFFSET1),this._setColor(10,e)}),n(0,r,"detailTilingOffset",function(){return this._getColor(11)},function(e){var t;e&&(1!=(t=e.elements)[0]||1!=t[1]||0!=t[2]||0!=t[3])?this._addShaderDefine(laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_TILINGOFFSET2):this._removeShaderDefine(laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_TILINGOFFSET2),this._setColor(11,e)}),Ns.__init__=function(){Ns.SHADERDEFINE_BASETEXTURE=Ns.shaderDefines.registerDefine("BASETEXTURE"),Ns.SHADERDEFINE_SECONDTEXTURE=Ns.shaderDefines.registerDefine("SECONDTEXTURE"),Ns.SHADERDEFINE_TILINGOFFSET1=Ns.shaderDefines.registerDefine("TILINGOFFSET1"),Ns.SHADERDEFINE_TILINGOFFSET2=Ns.shaderDefines.registerDefine("TILINGOFFSET2")},Ns.initShader=function(){var e=Ko.nameKey.add("UVSine"),e=g.add(e,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\nattribute vec4 a_Color;\n\nuniform mat4 u_MvpMatrix;\nuniform float u_Time;\nuniform float u_BaseScrollSpeedX;\nuniform float u_BaseScrollSpeedY;\nuniform float u_SecondScrollSpeedX;\nuniform float u_SecondScrollSpeedY;\n\nuniform vec4 u_TilingOffset1;\nuniform vec4 u_TilingOffset2;\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec4 v_Color;\n\nvoid main()\n{\n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET1\n\t\tv_Texcoord0 = (vec2(v_Texcoord0.x, v_Texcoord0.y - 1.0) * u_TilingOffset1.xy) + u_TilingOffset1.zw;\n\t\tv_Texcoord0 = vec2(v_Texcoord0.x, 1.0 + v_Texcoord0.y);\n\t#endif\n\t\n\tv_Texcoord1 = a_Texcoord0;\n\t#ifdef TILINGOFFSET2\n\t\tv_Texcoord1 = (vec2(v_Texcoord1.x, v_Texcoord1.y - 1.0) * u_TilingOffset2.xy) + u_TilingOffset2.zw;\n\t\tv_Texcoord1 = vec2(v_Texcoord1.x, 1.0 + v_Texcoord1.y);\n\t#endif\n\t\n\tv_Texcoord0 = v_Texcoord0 + vec2(fract(u_BaseScrollSpeedX * u_Time / 20.0), fract(-u_BaseScrollSpeedY * u_Time));\n\tv_Texcoord1 = v_Texcoord1 + vec2(fract(u_SecondScrollSpeedX * u_Time / 20.0), fract(-u_SecondScrollSpeedY * u_Time));\n\t\n\tv_Color = vec4(1.0);\n\t#ifdef COLOR\n\t\tv_Color = a_Color;\n\t#endif\n\t\n\tgl_Position = u_MvpMatrix * a_Position;\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec4 v_Color;\n\n#ifdef BASETEXTURE\n\tuniform sampler2D u_BaseTexture;\n#endif\n\n#ifdef SECONDTEXTURE\n\tuniform sampler2D u_SecondTexture;\n#endif\n\nuniform vec4 u_BaseColor;\nuniform float u_MMultiplier;\nuniform float u_Alpha;\n\nvoid main()\n{\n\tvec4 baseTextureColor = vec4(1.0);\n\t#ifdef BASETEXTURE\n\t\tbaseTextureColor = texture2D(u_BaseTexture, v_Texcoord0);\n\t#endif\n\t\n\tvec4 secondTextureColor = vec4(1.0);\n\t#ifdef SECONDTEXTURE\n\t\tsecondTextureColor = texture2D(u_SecondTexture, v_Texcoord1);\n\t#endif\n\t\n\tgl_FragColor = baseTextureColor * secondTextureColor * u_BaseColor * u_MMultiplier * v_Color;\n\tgl_FragColor.a *= u_Alpha;\n}\n",{a_Position:0,a_Normal:3,a_Color:1,a_Texcoord0:2},{u_MvpMatrix:[1,2],u_Time:[22,4],u_BaseTexture:[1,1],u_SecondTexture:[2,1],u_BaseColor:[3,1],u_BaseScrollSpeedX:[4,1],u_BaseScrollSpeedY:[5,1],u_SecondScrollSpeedX:[6,1],u_SecondScrollSpeedY:[7,1],u_MMultiplier:[8,1],u_Alpha:[9,1],u_TilingOffset1:[10,1],u_TilingOffset2:[11,1]});laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_BASETEXTURE=e.registerMaterialDefine("BASETEXTURE"),laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_SECONDTEXTURE=e.registerMaterialDefine("SECONDTEXTURE"),laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_TILINGOFFSET1=e.registerMaterialDefine("TILINGOFFSET1"),laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_TILINGOFFSET2=e.registerMaterialDefine("TILINGOFFSET2")},Ns.BASETEXTURE=1,Ns.SECONDTEXTURE=2,Ns.BASECOLOR=3,Ns.BASESCROLLSPEEDX=4,Ns.BASESCROLLSPEEDY=5,Ns.SECONDSCROLLSPEEDX=6,Ns.SECONDSCROLLSPEEDY=7,Ns.MMULTIPLIER=8,Ns.ALPHA=9,Ns.TILINGOFFSET1=10,Ns.TILINGOFFSET2=11,Ns.SHADERDEFINE_BASETEXTURE=0,Ns.SHADERDEFINE_SECONDTEXTURE=0,Ns.SHADERDEFINE_TILINGOFFSET1=0,Ns.SHADERDEFINE_TILINGOFFSET2=0,e(Ns,["shaderDefines",function(){return this.shaderDefines=new fr(Va.shaderDefines)}]);function Ns(){Ns.__super.call(this),this.setShaderName("UVSine"),this._setColor(3,new P(1,1,1,1)),this._setNumber(4,0),this._setNumber(5,0),this._setNumber(6,0),this._setNumber(7,0),this._setNumber(8,1),this._setNumber(9,1)}t(Ls,"laya.d3.water.WaterDetailMaterial",Va),n(0,a=Ls.prototype,"currentTm",function(){return this._getNumber(1)},function(e){this._setNumber(1,e-this._startTm)}),n(0,a,"waveInfo",function(){return this._getBuffer(12)},function(e){this._setBuffer(12,e)}),n(0,a,"waveInfoD",function(){return this._getBuffer(13)},function(e){this._setBuffer(13,e)}),n(0,a,"texWaveUVScale",function(){return this._getNumber(15)},function(e){this._setNumber(15,e)}),Ls.init=function(){var e;laya.d3.water.WaterDetailMaterial._bInited||(laya.d3.water.WaterDetailMaterial._bInited=!0,e=Ko.nameKey.add("WaterDetail"),g.add(e,"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\n\nvoid main() {\n\tvec3 pos = a_position;\n\tif(pos.z!=0.)pos.y=pos.z;\n\tpos.z=0.5;\n\tgl_Position = vec4(pos,1.);\n    vUv = uv;\n\t//vWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n\t//vWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n\t//vWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n}\n",'precision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\nuniform float u_curTm;\n\n#include "WaveFunction.glsl"\n\nvoid main() {\n\tvec3 wave_N,wave_B,wave_T;\n\tcalcWave(u_curTm, vUv,wave_B,wave_T,wave_N);\n\tgl_FragColor.rgb = normalize(wave_N)*0.5+vec3(0.5);// vec3(0.1,.4,0.1);\n    gl_FragColor.a = 1.0;\n}\n',{a_position:0,a_normal:3,uv:2},{u_curTm:[1,1],u_WaveInfo:[12,1],u_WaveInfoD:[13,1],TEXWAVE_UV_SCALE:[15,1]}))},Ls.CURTM=1,Ls.WAVEINFO=12,Ls.WAVEINFOD=13,Ls.WAVEMAINDIR=14,Ls.TEXWAVE_UV_SCALE=15,Ls._bInited=!1;var Vs=Ls;function Ls(){this._startTm=0,Ls.__super.call(this),laya.d3.water.WaterDetailMaterial.init(),this.setShaderName("WaterDetail"),this.cull=0,this._startTm=v.timer.currTimer}var ws;t(Fs,"laya.d3.component.animation.RigidAnimations",ws=D),(l=Fs.prototype)._init=function(){for(var e=this._templet.getNodes(this.currentAnimationClipIndex),t=this._owner,n=e.length,i=0,r=new Uint16Array(this._templet.getPublicExtData()),a=0;a<n;a++){var o=r.slice(i+1,i+1+r[i]);i+=r[i]+1;for(var s=1;s<o.length;s++){o[s];t=t._childs[o[s]]}var l=t.getChildByName(e[a].name);if(!l)break;this._animationSprites[a]=l;var h=(h=this._animationSpritesInitLocalMatrix[a])||(this._animationSpritesInitLocalMatrix[a]=new R);l.transform.localMatrix.cloneTo(h),t=this._owner}},l._animtionPlay=function(){this._templet.loaded?this._init():this._templet.once("loaded",this,this._init)},l._animtionStop=function(){if(this._lastFrameIndex=-1,this._player.returnToZeroStopped){this._curAnimationDatas=null;for(var e=0;e<this._animationSprites.length;e++)this._animationSprites[e].transform.localMatrix=this._animationSpritesInitLocalMatrix[e]}},l._effectAnimation=function(e){for(var t=0,n=this._animationSprites.length;t<n;t++){for(var i=this._animationSprites[t],r=i.transform.localMatrix,a=r.elements,o=0;o<16;o++)a[o]=this._curAnimationDatas[16*t+o];i.transform.localMatrix=r}},l._load=function(e){ws.prototype._load.call(this,e),this._player.on("stopped",this,this._animtionStop),this._player.on("played",this,this._animtionPlay)},l._update=function(e){if(2===this._player.state&&this._templet&&this._templet.loaded){var t=this._player.playbackRate*v.timer.scale,n=this._player.cachePlayRate,t=this._player.isCache&&n<=t,i=t?this.currentFrameIndex:-1;if(-1===i||this._lastFrameIndex!==i){var r=this.currentAnimationClipIndex,a=this._templet.getNodes(r),o=this._templet._animationDatasCache;if(t){var s=this._templet.getAnimationDataWithCache(n,o,r,i);if(s)return this._curAnimationDatas=s,this._lastFrameIndex=i,void this._effectAnimation(a)}s=16*a.length;t?this._curAnimationDatas=new Float32Array(s):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(s)),this._curAnimationDatas=this._tempCurAnimationData),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(r))),t?this._templet.getOriginalData(r,this._curOriginalData,this._player._fullFrames[r],i,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(r,this._curOriginalData,this._player.currentPlayTime),br._computeRootAnimationData(a,this._curOriginalData,this._curAnimationDatas),t&&this._templet.setAnimationDataWithCache(n,o,r,i,this._curAnimationDatas),this._lastFrameIndex=i,this._effectAnimation(a)}}},l._unload=function(e){ws.prototype._unload.call(this,e),this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._curAnimationDatas=null},n(0,l,"url",null,function(e){console.log("Warning: discard property,please use templet property instead.");e=v.loader.create(e,null,null,B);this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))}),n(0,l,"templet",ws.prototype._$get_templet,function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))});function Fs(){this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curAnimationDatas=null,Fs.__super.call(this),this._animationSprites=[],this._animationSpritesInitLocalMatrix=[]}t(Bs,"laya.d3.component.animation.SkinAnimations",Ps=D),(i=Bs.prototype)._computeBoneIndexToMeshOnTemplet=function(){this._templet.loaded?this._computeBoneIndexToMeshOnMesh():this._templet.once("loaded",this,this._computeBoneIndexToMeshOnMesh)},i._computeBoneIndexToMeshOnMesh=function(){"LAYAANIMATION:02"===this._templet._aniVersion?this._oldVersion=!1:this._oldVersion=!0;var e=this._owner.meshFilter.sharedMesh;e.loaded?this._computeBoneIndexToMesh(e):e.on("loaded",this,this._computeBoneIndexToMesh)},i._computeBoneIndexToMesh=function(e){var t=e._boneNames;if(t)for(var n=t.length,i=this._templet._anis,r=0,a=i.length;r<a;r++){var o=this._boneIndexToMeshList[r];(o=o||(this._boneIndexToMeshList[r]=[])).length=n;for(var s=i[r],l=0;l<n;l++)o[l]=s.bone3DMap[t[l]]}},i._getAnimationDatasWithCache=function(e,t,n,i,r){var n=n[i];return n&&(i=n[e])&&(n=i[t.id])?n[r]:null},i._setAnimationDatasWithCache=function(e,t,n,i,r,a){n=n[i]||(n[i]={}),i=n[e]||(n[e]={});(i[t.id]||(i[t.id]=[]))[r]=a},i._onAnimationPlayMeshLoaded=function(){for(var e=this._ownerMesh.meshRender._renderElements,t=0,n=e.length;t<n;t++)e[t]._canDynamicBatch=!1},i._onAnimationPlay=function(){this._ownerMesh._render._addShaderDefine(Ul.SHADERDEFINE_BONE);var e=this._ownerMesh.meshFilter.sharedMesh;e.loaded?this._onAnimationPlayMeshLoaded():e.once("loaded",this,this._onAnimationPlayMeshLoaded)},i._onAnimationStop=function(){this._lastFrameIndex=-1,this._player.returnToZeroStopped&&(this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh._render._removeShaderDefine(Ul.SHADERDEFINE_BONE));for(var e=this._ownerMesh.meshRender._renderElements,t=0,n=e.length;t<n;t++)e[t]._canDynamicBatch=!0},i._load=function(e){Ps.prototype._load.call(this,e),this._ownerMesh=e,this._player.on("played",this,this._onAnimationPlay),this._player.on("stopped",this,this._onAnimationStop),this._owner.meshFilter.on("meshchanged",this,this._computeBoneIndexToMeshOnTemplet)},i._update=function(e){var t=this._ownerMesh.meshFilter.sharedMesh;if(2===this._player.state&&this._templet&&this._templet.loaded&&t.loaded){var n=this._player.playbackRate*v.timer.scale,i=this._player.cachePlayRate,n=this._player.isCache&&i<=n,r=n?this.currentFrameIndex:-1;if(-1===r||this._lastFrameIndex!==r){var a=this.currentAnimationClipIndex,o=this._templet._animationDatasCache[0],s=this._templet._animationDatasCache[1];if(n){var l=this._getAnimationDatasWithCache(i,t,s,a,r);if(l)return this._curAnimationDatas=l,this._curBonesDatas=this._templet.getAnimationDataWithCache(i,o,a,r),void(this._lastFrameIndex=r)}var h,l=!1,_=(n&&(this._curBonesDatas=this._templet.getAnimationDataWithCache(i,o,a,r),l=!!this._curBonesDatas),this._templet.getNodes(a)),u=16*_.length,d=t.InverseAbsoluteBindPoses,c=(this._oldVersion?this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(u)):this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(16*d.length)),0),f=0,m=0,p=t.getSubMeshCount();if(n){for(this._curAnimationDatas=[],this._curAnimationDatas.length=p,c=0;c<p;c++)for(g=this._curAnimationDatas[c]=[],m=(h=t.getSubMesh(c))._boneIndicesList.length,g.length=m,f=0;f<m;f++)g[f]=new Float32Array(16*h._boneIndicesList[f].length);l||(this._curBonesDatas=new Float32Array(u))}else{if(!this._tempCurAnimationData)for(this._tempCurAnimationData=[],this._tempCurAnimationData.length=p,c=0;c<p;c++)for(g=this._tempCurAnimationData[c]=[],m=(h=t.getSubMesh(c))._boneIndicesList.length,g.length=m,f=0;f<m;f++)g[f]=new Float32Array(16*h._boneIndicesList[f].length);this._tempCurBonesData||(this._tempCurBonesData=new Float32Array(u)),this._curAnimationDatas=this._tempCurAnimationData,this._curBonesDatas=this._tempCurBonesData}for(this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(a))),n?this._templet.getOriginalData(a,this._curOriginalData,this._player._fullFrames[a],r,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(a,this._curOriginalData,this._player.currentPlayTime),this._oldVersion?n&&l?br._computeAnimationDatasByArrayAndMatrixFastOld(d,this._curBonesDatas,this._curMeshAnimationData):br._computeBoneAndAnimationDatasByBindPoseMatrxixOld(_,this._curOriginalData,d,this._curBonesDatas,this._curMeshAnimationData):(u=this._boneIndexToMeshList[a],n&&l?br._computeAnimationDatasByArrayAndMatrixFast(d,this._curBonesDatas,this._curMeshAnimationData,u):br._computeBoneAndAnimationDatasByBindPoseMatrxix(_,this._curOriginalData,d,this._curBonesDatas,this._curMeshAnimationData,u)),c=0;c<p;c++)for(var E=t.getSubMesh(c)._boneIndicesList,m=E.length,g=this._curAnimationDatas[c],f=0;f<m;f++)Bs._splitAnimationDatas(E[f],this._curMeshAnimationData,g[f]);n&&(this._setAnimationDatasWithCache(i,t,s,a,r,this._curAnimationDatas),l||this._templet.setAnimationDataWithCache(i,o,a,r,this._curBonesDatas)),this._lastFrameIndex=r}}},i._preRenderUpdate=function(e){e=e.renderElement.renderObj;this._curAnimationDatas?e._skinAnimationDatas=this._curAnimationDatas[e._indexInMesh]:e._skinAnimationDatas=null},i._unload=function(e){2==this.player.state&&this._ownerMesh._render._removeShaderDefine(Ul.SHADERDEFINE_BONE),this._templet&&!this._templet.loaded&&this._templet.off("loaded",this,this._computeBoneIndexToMeshOnMesh);var t=this._ownerMesh.meshFilter.sharedMesh;t.loaded||t.off("loaded",this,this._onAnimationPlayMeshLoaded),Ps.prototype._unload.call(this,e),this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null},n(0,i,"curBonesDatas",function(){return this._curBonesDatas}),n(0,i,"templet",Ps.prototype._$get_templet,function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._computeBoneIndexToMeshOnTemplet(),this._curOriginalData=null,this._curMeshAnimationData=null,this._tempCurBonesData=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[[],[]]),this.event("animationchanged",this))}),Bs._splitAnimationDatas=function(e,t,n){for(var i=0,r=e.length,a=0;i<r;i++)for(var o=0;o<16;o++,a++)n[a]=t[(e[i]<<4)+o]};var Ps,bs=Bs;function Bs(){this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null,this._boneIndexToMeshList=null,this._oldVersion=!1,Bs.__super.call(this),this._boneIndexToMeshList=[]}t(Hs,"laya.d3.component.physics.BoxCollider",s),(d=Hs.prototype)._updateCollider=function(){var e,t,n,i,r;this._needUpdate&&(e=this._transformOrientedBoundBox.transformation,r=(i=this._owner.transform).rotation,t=i.scale,0===(n=this.center.elements)[0]&&0===n[1]&&0===n[2]?R.createAffineTransformation(i.position,r,W.ONE,e):(W.multiply(this.center,t,Hs._deviationV3),W.transformQuat(Hs._deviationV3,r,Hs._deviationV3),W.add(i.position,Hs._deviationV3,Hs._deviationV3),R.createAffineTransformation(Hs._deviationV3,r,W.ONE,e)),this._transformOrientedBoundBox.transformation=e,n=this._transformOrientedBoundBox.extents.elements,i=this._size.elements,r=t.elements,n[0]=.5*i[0]*r[0],n[1]=.5*i[1]*r[1],n[2]=.5*i[2]*r[2],this._needUpdate=!1)},d._onWorldMatrixChanged=function(){for(var e in this._needUpdate=!0,this._runtimeCollisonMap)this._runtimeCollisonTestMap[e]=!0,this._runtimeCollisonMap[e]._runtimeCollisonTestMap[this.id]=!0},d._initialize=function(e){laya.d3.component.Component3D.prototype._initialize.call(this,e),this._transformOrientedBoundBox=new Ki(new W,new R),this._size=new W,this.center=new W,e.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},d._getType=function(){return 1},d._collisonTo=function(e){switch(e._getType()){case 0:return 0!==this.boundBox.containsSphere(e.boundSphere);case 1:return 0!==this.boundBox.containsOrientedBoundBox(e.boundBox);case 2:if(0!==this.boundBox.containsBoundBox(e._boundBox))for(var t=e.mesh._positions,n=0,i=t.length;n<i;n++)if(1===this.boundBox.containsPoint(t[n]))return!0;return!1;default:throw new Error("BoxCollider:unknown collider type.")}},d._cloneTo=function(e){var t=e.size;this.size.cloneTo(t),e.size=t,this.center.cloneTo(e.center)},d.raycast=function(e,t,n){void 0===n&&(n=179e306),this._updateCollider();e=this._transformOrientedBoundBox.intersectsRay(e,t.position);return-1!==e&&e<=n?(t.distance=e,t.sprite3D=this._owner,!0):(t.distance=-1,t.sprite3D=null,!1)},d.setFromBoundBox=function(e){Ki.createByBoundBox(e,this._transformOrientedBoundBox);var t=this._transformOrientedBoundBox.extents;this._size=new W(2*t.x,2*t.y,2*t.z),this.center=new W,W.add(e.min,e.max,this.center),W.scale(this.center,.5,this.center),this._needUpdate=!0},n(0,d,"boundBox",function(){return this._updateCollider(),this._transformOrientedBoundBox}),n(0,d,"size",function(){return this._size},function(e){this._size=e,this._needUpdate=!0}),e(Hs,["_deviationV3",function(){return this._deviationV3=new W},"_obbCenterV3",function(){return this._obbCenterV3=new W}]);var Us=Hs;function Hs(){this._size=null,this._transformOrientedBoundBox=null,this.center=null,Hs.__super.call(this),this._needUpdate=!1}t(zs,"laya.d3.component.physics.MeshCollider",s),(r=zs.prototype)._updateBoundBoxCollider=function(){if(this._needUpdate){for(var e=this._owner.transform.worldMatrix,t=this._mesh.boundingBoxCorners,n=0;n<8;n++)W.transformCoordinate(t[n],e,zs._tempBoundBoxCorners[n]);bi.createfromPoints(zs._tempBoundBoxCorners,this._transformBoundingBox),this._needUpdate=!1}},r._raycastMesh=function(e,t,n,i){void 0===i&&(i=179e306);for(var r=t.transform.worldMatrix,a=zs._tempMatrix4x40,o=(r.invert(a),e.origin),e=e.direction,s=zs._tempRay0,l=(W.transformCoordinate(o,a,s.origin),W.TransformNormal(e,a,s.direction),Number.MAX_VALUE),h=0,_=this._mesh.getRenderElementsCount();h<_;h++){var u=this._mesh.getRenderElement(h),d=u._getVertexBuffer(0),c=d.getData(),u=u._getIndexBuffer().getData(),f=zs._tempRaycastHit;if(Nr.rayIntersectsPositionsAndIndices(s,c,d.vertexDeclaration,u,f))return W.transformCoordinate(f.position,r,f.position),W.subtract(o,f.position,c=zs._tempVector30),(d=W.scalarLength(c))<i&&d<l&&(f.distance=d,f.sprite3D=t,u=f.trianglePositions,W.transformCoordinate(u[0],r,u[0]),W.transformCoordinate(u[1],r,u[1]),W.transformCoordinate(u[2],r,u[2]),c=f.triangleNormals,W.transformCoordinate(c[0],r,c[0]),W.transformCoordinate(c[1],r,c[1]),W.transformCoordinate(c[2],r,c[2]),l=d,f.cloneTo(n),!0)}return!1},r._onWorldMatrixChanged=function(){this._needUpdate=!0},r._initialize=function(e){laya.d3.component.Component3D.prototype._initialize.call(this,e),e.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},r._getType=function(){return 2},r._collisonTo=function(e){var t=0,n=0,i=this.mesh._positions;switch(e._getType()){case 0:var r=e;if(0!==Wi.sphereContainsBox(r.boundSphere,this._boundBox))for(t=0,n=i.length;t<n;t++)if(1===Wi.sphereContainsPoint(r.boundSphere,i[t]))return!0;return!1;case 1:var a=e;if(0!==a.boundBox.containsBoundBox(this._boundBox))for(t=0,n=i.length;t<n;t++)if(1===a.boundBox.containsPoint(i[t]))return!0;return!1;case 2:return 1!==Wi.intersectsBoxAndBox(e._boundBox,this._boundBox);default:throw new Error("MeshCollider:unknown collider type.")}},r._cloneTo=function(e){e.mesh=this._mesh},r.raycast=function(e,t,n){var i;return void 0===n&&(n=179e306),!(null==this._mesh||!this._mesh.loaded||!(-1!==(i=Wi.intersectsRayAndBoxRD(e,this._boundBox))&&i<=n&&this._raycastMesh(e,this._owner,t,n))&&(t.distance=-1,t.sprite3D=null,1))},n(0,r,"_boundBox",function(){return this._updateBoundBoxCollider(),this._transformBoundingBox}),n(0,r,"mesh",function(){return this._mesh},function(e){this._mesh=e}),e(zs,["_tempRay0",function(){return this._tempRay0=new ir(new W,new W)},"_tempVector30",function(){return this._tempVector30=new W},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new R},"_tempRaycastHit",function(){return this._tempRaycastHit=new Lr},"_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new W,new W,new W,new W,new W,new W,new W,new W]}]);var Gs=zs;function zs(){this._transformBoundingBox=null,this._mesh=null,zs.__super.call(this),this._transformBoundingBox=new bi(new W,new W),this._needUpdate=!1}t(ks,"laya.d3.component.physics.SphereCollider",s),(a=ks.prototype)._updateCollider=function(){var e,t,n;this._needUpdate&&(n=NaN,n=(t=(e=this._owner.transform).scale).x>=t.y&&t.x>=t.z?t.x:t.y>=t.z?t.y:t.z,W.transformCoordinate(this._originalBoundSphere.center,e.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=this._originalBoundSphere.radius*n,this._needUpdate=!1)},a._onWorldMatrixChanged=function(){for(var e in this._needUpdate=!0,this._runtimeCollisonMap)this._runtimeCollisonTestMap[e]=!0,this._runtimeCollisonMap[e]._runtimeCollisonTestMap[this.id]=!0},a._initialize=function(e){laya.d3.component.Component3D.prototype._initialize.call(this,e),this._originalBoundSphere=new Gi(new W(0,0,0),.5),this._transformBoundSphere=new Gi(new W(0,0,0),.5),e.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},a._getType=function(){return 0},a._collisonTo=function(e){switch(e._getType()){case 0:return 0!==Wi.sphereContainsSphere(this.boundSphere,e.boundSphere);case 1:return 0!==e.boundBox.containsSphere(this.boundSphere);case 2:var t=e;if(0!==Wi.sphereContainsBox(this.boundSphere,t._boundBox))for(var n=t.mesh._positions,i=0,r=n.length;i<r;i++)if(1===Wi.sphereContainsPoint(this.boundSphere,n[i]))return!0;return!1;default:throw new Error("SphereCollider:unknown collider type.")}},a._cloneTo=function(e){e.radius=this.radius;var t=e.center;this.center.cloneTo(t),e.center=t},a.raycast=function(e,t,n){void 0===n&&(n=179e306),this._updateCollider();e=this._transformBoundSphere.intersectsRayPoint(e,t.position);return-1!==e&&e<=n?(t.distance=e,t.sprite3D=this._owner,!0):(t.distance=-1,t.sprite3D=null,!1)},n(0,a,"center",function(){return this._originalBoundSphere.center},function(e){this._originalBoundSphere.center=e}),n(0,a,"radius",function(){return this._originalBoundSphere.radius},function(e){this._originalBoundSphere.radius=e}),n(0,a,"boundSphere",function(){return this._updateCollider(),this._transformBoundSphere});var Ws=ks;function ks(){this._originalBoundSphere=null,this._transformBoundSphere=null,ks.__super.call(this),this._needUpdate=!1}t(Ys,"laya.d3.resource.DataTexture2D",wa),(l=Ys.prototype).genDebugMipmaps=function(){var e=[];return e.push(new Uint8Array(new Uint32Array(131072).fill(4278190335).buffer)),e.push(new Uint8Array(new Uint32Array(32768).fill(4278223103).buffer)),e.push(new Uint8Array(new Uint32Array(8192).fill(4278255615).buffer)),e.push(new Uint8Array(new Uint32Array(2048).fill(4278255360).buffer)),e.push(new Uint8Array(new Uint32Array(512).fill(4286595072).buffer)),e.push(new Uint8Array(new Uint32Array(128).fill(4294901760).buffer)),e.push(new Uint8Array(new Uint32Array(32).fill(4294901888).buffer)),e.push(new Uint8Array(new Uint32Array(8).fill(0).buffer)),e.push(new Uint8Array(new Uint32Array(2).fill(4286611584).buffer)),e.push(new Uint8Array(new Uint32Array(1).fill(4294967295).buffer)),e},l._onTextureLoaded=function(e){},l._createWebGlTexture=function(){if(!this._buffer&&!this._mipmaps)throw"create GLTextur err:no data";var e=c.mainContext,t=(e.getExtension("EXT_shader_texture_lod"),this._source=e.createTexture()),n=this._width,i=this._height,r=f.curBindTexTarget,a=f.curBindTexValue;if(f.bindTexture(e,this._type,t),this._mipmaps){if(laya.d3.resource.DataTexture2D.lodasatlas){var o=0;e.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null);for(var s=0;s<this._mipmaps.length;s++){if(this._mipmaps[s].byteLength!=l*h*4)throw"mipmap size error  level:"+s;e.texSubImage2D(this._type,0,Ys.simLodRect[o++],Ys.simLodRect[o++],Ys.simLodRect[o++],Ys.simLodRect[o++],6408,5121,new Uint8Array(this._mipmaps[s]))}this.minFifter=9729,this.magFifter=9729}else{var l=this._width,h=this._height,o=0;for(e.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null),s=0;s<this._mipmaps.length;s++){if(this._mipmaps[s].byteLength!=l*h*4)throw"mipmap size error  level:"+s;e.texImage2D(this._type,s,6408,l,h,0,6408,5121,new Uint8Array(this._mipmaps[s])),(l/=2)<1&&(l=1),(h/=2)<1&&(h=1),this.minFifter=9987,this.magFifter=9729}}this.mipmap=!1}else e.texImage2D(this._type,0,6408,n,i,0,6408,5121,new Uint8Array(this._buffer));var t=this._minFifter,_=this._magFifter,u=this._repeat?10497:33071,d=U.isPOT(n,i);if(!d)throw"data texture must be POT";this._mipmap||this._mipmaps?-1===t&&(t=9987):-1===t&&(t=9729),-1===_&&(_=9729),e.texParameteri(this._type,10241,t),e.texParameteri(this._type,10240,_),e.texParameteri(this._type,10242,u),this._mipmaps?e.texParameteri(this._type,10243,33071):e.texParameteri(this._type,10243,u),this._mipmap&&e.generateMipmap(this._type),r&&a&&f.bindTexture(e,r,a),this.src&&0<this.src.length&&(this._buffer=null),this.memorySize=d?n*i*4*(1+1/3):n*i*4,this._recreateLock=!1},l.recreateResource=function(){(this._buffer||null!=this._src&&""!==this._src)&&(this._needReleaseAgain=!1,this._buffer||this._mipmaps?this._recreateLock||(this._createWebGlTexture(),this.completeCreate()):this._recreateLock=!0)},l.onAsynLoaded=function(e,t,n){var i;(i=n?n[0].call(this,t):i)&&(this._width=i.width,this._height=i.height,this._buffer=i.data),this._src=e,this._size=new Fr(this._width,this._height),this._conchTexture?alert("怎么给runtime传递datatexture数据"):this.activeResource(),this._endLoaded()},l.getPixels=function(){return new Uint8Array(this._buffer)},l.disposeResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(c.mainContext.deleteTexture(this._source),this._source=null,this._buffer=null,this.memorySize=0)},n(0,l,"src",function(){return this._src}),Ys.create=function(e,t,n,i,r,a){if(void 0===i&&(i=9729),void 0===r&&(r=9729),void 0===a&&(a=!0),!e||e.byteLength<t*n*4)throw"DataTexture2D create error";var o=new Ys;return o._buffer=e,o._width=t,o._height=n,o._mipmap=a,o._magFifter=i,o._minFifter=r,o._size=new Fr(o._width,o._height),o._conchTexture?alert("怎么给runtime传递datatexture数据"):o.activeResource(),o},Ys.load=function(e,t,n,i,r){if(void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=9729),void 0===r&&(r=9729),"mipmaps"===ae.getFileExtension(e)){var a=v.loader.create(e,null,null,Ys,[function(e){this._mipmaps=[];var t=new Uint32Array(e),n=(this._width=t[0],512);if(laya.d3.resource.DataTexture2D.lodasatlas&&(this._width*=2,n=1024),this._width!=n)throw console.error("现在只支持512x256的环境贴图。当前的是"+t[0]),"现在只支持512x256的环境贴图。当前的是"+t[0];this._height=t[1];for(var i=laya.d3.resource.DataTexture2D.lodasatlas?this._width/2:this._width,r=this._height,a=8;;){var o=i*r*4;if(a+o>e.byteLength)throw"load mipmaps data size error ";var s=new Uint8Array(e,a,o);if(this._mipmaps.push(s),a+=o,1==i&&1==r)break;(i/=2)<1&&(i=1),(r/=2)<1&&(r=1)}return null}]);if(laya.d3.resource.DataTexture2D.lodasatlas){a.simLodInfo=new Float32Array(40);for(var o=0;o<a.simLodInfo.length;)a.simLodInfo[o]=(Ys.simLodRect[o]+.5)/1024,a.simLodInfo[++o]=(Ys.simLodRect[o]+.5)/256,a.simLodInfo[++o]=Math.max(Ys.simLodRect[o]-1,.1)/1024,a.simLodInfo[++o]=Math.max(Ys.simLodRect[o]-1.5,.1)/256,o++}return a}if("number"==typeof t)return v.loader.create(e,null,null,Ys,[function(e){return this._width=t,this._height=n,this._buffer=e,null}]);if("function"==typeof t)return v.loader.create(e,null,null,Ys,[t]);throw new Error("unknown params.")},Ys.lodasatlas=!1,e(Ys,["simLodRect",function(){return this.simLodRect=new Uint32Array([0,0,512,256,512,0,256,128,768,0,128,64,896,0,64,32,960,0,32,16,992,0,16,8,1008,0,8,4,1016,0,4,2,1020,0,2,1,1022,0,1,1])}]);var Xs=Ys;function Ys(){this.simLodInfo=null,this._src=null,this._buffer=null,this._mipmaps=null,this._recreateLock=!1,this._needReleaseAgain=!1,Ys.__super.call(this),this._type=3553}t(Zs,"laya.d3.resource.models.PrimitiveMesh",u),D=Zs.prototype,v.imps(D,{"laya.d3.core.render.IRenderable":!0}),D._getVertexBuffer=function(e){return 0===(e=void 0===e?0:e)?this._vertexBuffer:null},D._getVertexBuffers=function(){return null},D._getIndexBuffer=function(){return this._indexBuffer},D._getPositions=function(){for(var e,t=[],n=this._vertexBuffer.vertexDeclaration.getVertexElements(),i=0,i=0;i<n.length;i++){var r=n[i];if("vector3"===r.elementFormat&&0===r.elementUsage){e=r;break}}var a=this._vertexBuffer.getData();for(i=0;i<a.length;i+=this._vertexBuffer.vertexDeclaration.vertexStride/4){var o=i+e.offset/4,o=new W(a[o+0],a[o+1],a[o+2]);t.push(o)}return t},D.getRenderElement=function(e){return this},D.getRenderElementsCount=function(){return 1},D.disposeResource=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._vertexBuffer=null),this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this.memorySize=0},D._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},D._render=function(e){c.mainContext.drawElements(4,this._numberIndices,5123,0),T.drawCall++,T.trianglesFaces+=this._numberIndices/3},n(0,D,"_vertexBufferCount",function(){return 1}),n(0,D,"triangleCount",function(){return this._indexBuffer.indexCount/3});i=Zs;function Zs(){this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,Zs.__super.call(this)}t(Ks,"laya.d3.resource.models.Mesh",u),(d=Ks.prototype)._getPositions=function(){var e,t,n,i=[],r=0,a=0,o=0;if(0!==this._vertexBuffers.length)for(var s=this._vertexBuffers.length,r=0;r<s;r++){for(_=(h=this._vertexBuffers[r]).vertexDeclaration.getVertexElements(),a=0;a<_.length;a++)if("vector3"===(t=_[a]).elementFormat&&0===t.elementUsage){e=t;break}for(n=h.getData(),a=0;a<n.length;a+=h.vertexDeclaration.vertexStride/4)o=a+e.offset/4,i.push(new W(n[o+0],n[o+1],n[o+2]))}else{var l=this._subMeshes.length;for(r=0;r<l;r++){for(var h,_=(h=this._subMeshes[r]._getVertexBuffer()).vertexDeclaration.getVertexElements(),a=0;a<_.length;a++)if("vector3"===(t=_[a]).elementFormat&&0===t.elementUsage){e=t;break}for(n=h.getData(),a=0;a<n.length;a+=h.vertexDeclaration.vertexStride/4)o=a+e.offset/4,i.push(new W(n[o+0],n[o+1],n[o+2]))}}return i},d._setSubMeshes=function(e){this._subMeshes=e,this._subMeshCount=e.length;for(var t=0;t<this._subMeshCount;t++)e[t]._indexInMesh=t;this._positions=this._getPositions(),this._generateBoundingObject()},d.onAsynLoaded=function(e,t,n){var i=t[0],t=t[1];Fi.read(i,this,this._materials,this._subMeshes,t),this.completeCreate(),this._endLoaded()},d.getSubMesh=function(e){return this._subMeshes[e]},d.getSubMeshCount=function(){return this._subMeshes.length},d.getRenderElementsCount=function(){return this._subMeshes.length},d.getRenderElement=function(e){return this._subMeshes[e]},d.disposeResource=function(){for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].dispose();this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null},n(0,d,"materials",function(){return this._materials.slice()}),n(0,d,"InverseAbsoluteBindPoses",function(){return this._inverseBindPoses}),Ks.load=function(e){return v.loader.create(e,null,null,Ks)};var js=Ks;function Ks(){this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null,this._skinnedDatas=null,Ks.__super.call(this),this._subMeshes=[],this._materials=[],this._vertexBuffers=[]}t(Qs,"laya.d3.resource.RenderTexture",wa),(r=Qs.prototype).recreateResource=function(){var e=c.mainContext,t=(this._frameBuffer=e.createFramebuffer(),this._source=e.createTexture(),f.curBindTexTarget),n=f.curBindTexValue,i=(f.bindTexture(e,this._type,this._source),e.texImage2D(this._type,0,6408,this._width,this._height,0,this._surfaceFormat,this._surfaceType,null),this._minFifter),r=this._magFifter,a=this._repeat?10497:33071;if(U.isPOT(this._width,this._height)?(this._mipmap?-1===i&&(i=9987):-1===i&&(i=9729),-1===r&&(r=9729),e.texParameteri(this._type,10241,i),e.texParameteri(this._type,10240,r),e.texParameteri(this._type,10242,a),e.texParameteri(this._type,10243,a),this._mipmap&&e.generateMipmap(this._type)):(-1===r&&(r=9729),e.texParameteri(this._type,10241,i=-1===i?9729:i),e.texParameteri(this._type,10240,r),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),e.bindFramebuffer(36160,this._frameBuffer),e.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,this._depthStencilBuffer),e.renderbufferStorage(36161,this._depthStencilFormat,this._width,this._height),this._depthStencilFormat){case 33189:e.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:e.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:e.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}e.bindFramebuffer(36160,null),t&&n&&f.bindTexture(e,t,n),e.bindRenderbuffer(36161,null),this.memorySize=this._width*this._height*4,this.completeCreate()},r.start=function(){c.mainContext.bindFramebuffer(36160,this.frameBuffer),(Qs._currentRenderTarget=this)._alreadyResolved=!1},r.end=function(){c.mainContext.bindFramebuffer(36160,null),Qs._currentRenderTarget=null,this._alreadyResolved=!0},r.getData=function(e,t,n,i){var r,a=c.mainContext;return a.bindFramebuffer(36160,this._frameBuffer),36053===a.checkFramebufferStatus(36160)?(r=new Uint8Array(this._width*this._height*4),a.readPixels(e,t,n,i,this._surfaceFormat,this._surfaceType,r),a.bindFramebuffer(36160,null),r):(a.bindFramebuffer(36160,null),null)},r.disposeResource=function(){var e;this._frameBuffer&&((e=c.mainContext).deleteTexture(this._source),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0)},n(0,r,"surfaceFormat",function(){return this._surfaceFormat}),n(0,r,"surfaceType",function(){return this._surfaceType}),n(0,r,"depthStencilFormat",function(){return this._depthStencilFormat}),n(0,r,"source",function(){return this._alreadyResolved?v.superGet(wa,this,"source"):null}),n(0,r,"depthStencilBuffer",function(){return this._depthStencilBuffer}),n(0,r,"frameBuffer",function(){return this._frameBuffer}),Qs._currentRenderTarget=null;var qs=Qs;function Qs(e,t,n,i,r,a,o,s,l){this._alreadyResolved=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._frameBuffer=null,this._depthStencilBuffer=null,void 0===n&&(n=6408),void 0===i&&(i=5121),void 0===r&&(r=33189),void 0===a&&(a=!1),void 0===o&&(o=!1),void 0===s&&(s=-1),void 0===l&&(l=-1),Qs.__super.call(this),this._type=3553,this._width=e,this._height=t,this._size=new Fr(e,t),this._surfaceFormat=n,this._surfaceType=i,this._depthStencilFormat=r,J.isConchWebGL&&34041===this._depthStencilFormat&&(this._depthStencilFormat=33189),this._mipmap=a,this._repeat=o,this._minFifter=s,this._magFifter=l,this.activeResource(),this._alreadyResolved=!0}t(Js,"laya.d3.resource.SolidColorTexture2D",wa),(s=Js.prototype)._createWebGlTexture=function(){var e=c.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=f.curBindTexTarget,a=f.curBindTexValue,t=(f.bindTexture(e,this._type,t),e.texImage2D(this._type,0,6408,n,i,0,6408,5121,this._pixels),this._minFifter),o=this._magFifter,s=this._repeat?10497:33071,l=U.isPOT(n,i);l?(this._mipmap?-1===t&&(t=9987):-1===t&&(t=9729),-1===o&&(o=9729),e.texParameteri(this._type,10241,t),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,s),e.texParameteri(this._type,10243,s),this._mipmap&&e.generateMipmap(this._type)):(-1===o&&(o=9729),e.texParameteri(this._type,10241,t=-1===t?9729:t),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&f.bindTexture(e,r,a),this.memorySize=l?n*i*4*(1+1/3):n*i*4},s.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},s.disposeResource=function(){this._source&&(c.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},e(Js,["magentaTexture",function(){return this.magentaTexture=new Js(new P(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new Js(new P(.5,.5,.5,1))}]);var $s=Js;function Js(e){this._color=null,this._pixels=null,Js.__super.call(this),this._type=3553,this._width=1,this._height=1,this._size=new Fr(this.width,this.height),this._color=e,this._pixels=new Uint8Array([255*e.x,255*e.y,255*e.z,255*e.w])}t(tl,"laya.d3.resource.SolidColorTextureCube",wa),(a=tl.prototype)._createWebGlTexture=function(){var e=c.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=f.curBindTexTarget,a=f.curBindTexValue,t=(f.bindTexture(e,this._type,t),e.texImage2D(34069,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34070,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34071,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34072,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34073,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34074,0,6408,n,i,0,6408,5121,this._pixels),this.minFifter),o=this.magFifter,s=this._repeat?10497:33071,l=U.isPOT(n,i);l?(this.mipmap?-1===t&&(t=9987):-1===t&&(t=9729),-1===o&&(o=9729),e.texParameteri(this._type,10241,t),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,s),e.texParameteri(this._type,10243,s),this.mipmap&&e.generateMipmap(this._type)):(-1===o&&(o=9729),e.texParameteri(this._type,10241,t=-1===t?9729:t),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&f.bindTexture(e,r,a),this.memorySize=l?n*i*4*(1+1/3)*this._texCount:n*i*4*this._texCount},a.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},a.disposeResource=function(){this._source&&(c.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},e(tl,["magentaTexture",function(){return this.magentaTexture=new tl(new P(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new tl(new P(.5,.5,.5,1))}]);var el=tl;function tl(e){this._color=null,this._pixels=null,this._texCount=6,tl.__super.call(this),this._type=34067,this._width=1,this._height=1,this._size=new Fr(this.width,this.height),this._color=e,this._pixels=new Uint8Array([255*e.x,255*e.y,255*e.z,255*e.w])}t(il,"laya.d3.resource.Texture2D",wa),(l=il.prototype)._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var e=c.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=f.curBindTexTarget,a=f.curBindTexValue;switch(f.bindTexture(e,this._type,t),this._format){case 6407:case 6408:this._canRead?e.texImage2D(this._type,0,this._format,n,i,0,this._format,5121,this._pixels):e.texImage2D(this._type,0,this._format,this._format,5121,this._image);break;case c.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:e.compressedTexImage2D(this._type,0,this._format,this._width,this._height,0,this._image)}var t=this._minFifter,o=this._magFifter,s=this._repeat?10497:33071,l=0==this._wrapModeU?10497:33071,h=0==this._wrapModeV?10497:33071,_=U.isPOT(n,i);_?(this._mipmap?-1===t&&(t=9987):-1===t&&(t=9729),-1===o&&(o=9729),e.texParameteri(this._type,10241,t),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,s),e.texParameteri(this._type,10243,s),e.texParameteri(this._type,10242,l),e.texParameteri(this._type,10243,h),this._mipmap&&e.generateMipmap(this._type)):(-1===o&&(o=9729),e.texParameteri(this._type,10241,t=-1===t?9729:t),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&f.bindTexture(e,r,a),this._image.onload=null,this._image=null,this.memorySize=_?n*i*4*(1+1/3):n*i*4},l.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},l.onAsynLoaded=function(e,t,n){var i;switch(n&&(void 0!==(i=n[0])&&(this._canRead=i),void 0!==(i=n[1])&&(this._repeat=i),void 0!==(i=n[2])&&(this._format=i),void 0!==(i=n[3])&&(this._mipmap=i),void 0!==(i=n.wrapModeU)&&(this._wrapModeU=i),void 0!==(i=n.wrapModeV))&&(this._wrapModeV=i),this._format){case 6407:case 6408:var r=(this._image=t).width,a=t.height;this._width=r,this._height=a,this._size=new Fr(r,a),this._canRead&&(J.isConchApp?t instanceof L.HTMLElement&&(this._pixels=new Uint8Array(t.getImageData(0,0,r,a))):(z.canvas.size(r,a),z.canvas.clear(),z.context.drawImage(t,0,0,r,a),this._pixels=new Uint8Array(z.context.getImageData(0,0,r,a).data.buffer)));break;case c.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:r=new X(t);r.readUTFBytes(4),r.readUTFBytes(2),r.getInt16(),r.endian="bigEndian",this._width=r.getInt16(),this._height=r.getInt16(),this._size=new Fr(this._width,this._height),r.getInt16(),r.getInt16();this._image=new Uint8Array(t,r.pos)}this.recreateResource(),this._endLoaded()},l.getPixels=function(){if(this._canRead)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")},l.disposeResource=function(){this._source&&(c.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},n(0,l,"_src",function(){return this.url}),n(0,l,"src",function(){return this.url}),il.load=function(e){return v.loader.create(e,null,null,il)};var nl=il;function il(e,t,n,i){this._canRead=!1,this._image=null,this._pixels=null,void 0===e&&(e=!1),void 0===t&&(t=!0),void 0===n&&(n=6408),void 0===i&&(i=!0),il.__super.call(this),this._type=3553,this._repeat=t,this._canRead=e,this._format=n,this._mipmap=i}t(al,"laya.d3.resource.TextureCube",wa),(D=al.prototype)._onTextureLoaded=function(e){this._images=e;for(var t=2147483647,n=2147483647,i=0;i<6;i++)var r=e[i],t=Math.min(t,r.width),n=Math.min(n,r.height);this._width=t,this._height=n,this._size=new Fr(t,n)},D._createWebGlTexture=function(){for(var e=0,e=0;e<6;e++)if(!this._images[e])throw"create GLTextur err:no data:"+this._images[e];var t=c.mainContext,n=this._source=t.createTexture(),i=this._width,r=this._height,a=f.curBindTexTarget,o=f.curBindTexValue,n=(f.bindTexture(t,this._type,n),t.texImage2D(34069,0,6408,6408,5121,this._images[0]),t.texImage2D(34070,0,6408,6408,5121,this._images[1]),t.texImage2D(34071,0,6408,6408,5121,this._images[2]),t.texImage2D(34072,0,6408,6408,5121,this._images[3]),t.texImage2D(34073,0,6408,6408,5121,this._images[4]),t.texImage2D(34074,0,6408,6408,5121,this._images[5]),this.minFifter),s=this.magFifter,l=this._repeat?10497:33071,h=U.isPOT(i,r);for(h?(this.mipmap?-1===n&&(n=9987):-1===n&&(n=9729),-1===s&&(s=9729),t.texParameteri(this._type,10241,n),t.texParameteri(this._type,10240,s),t.texParameteri(this._type,10242,l),t.texParameteri(this._type,10243,l),this.mipmap&&t.generateMipmap(this._type)):(-1===s&&(s=9729),t.texParameteri(this._type,10241,n=-1===n?9729:n),t.texParameteri(this._type,10240,s),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),a&&o&&f.bindTexture(t,a,o),e=0;e<6;e++)this._images[e].onload=null,this._images[e]=null;this.memorySize=h?i*r*4*(1+1/3)*6:i*r*4*6},D.recreateResource=function(){null!=this._url&&(this._createWebGlTexture(),this.completeCreate())},D.onAsynLoaded=function(e,t,n){this._onTextureLoaded(t),this.activeResource(),this._endLoaded()},D.disposeResource=function(){this._source&&(c.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},n(0,D,"defaulteTexture",function(){return el.grayTexture}),al.load=function(e){return v.loader.create(e,null,null,al)};var rl=al;function al(){al.__super.call(this),this._type=34067}t(ll,"laya.d3.core.SkinnedMeshRender",ol=io),(u=ll.prototype)._getCacheAnimationNodes=function(){for(var e=this._cacheMesh._boneNames,t=e.length,n=(this._cacheAnimationNode.length=t,this._cacheAnimationNodeIndex.length=t,this._cacheAnimator._avatarNodes),i=this._cacheAnimator._avatarNodeMap,r=0;r<t;r++){var a=i[e[r]];this._cacheAnimationNode[r]=a,this._cacheAnimationNodeIndex[r]=n.indexOf(a)}},u._offComputeBoneIndexToMeshEvent=function(e,t){e.loaded?t.loaded||t.off("loaded",this,this._getCacheAnimationNodes):e.off("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},u._computeBoneIndexToMeshWithAsyncAvatar=function(){this._cacheAvatar.loaded?this._computeBoneIndexToMeshWithAsyncMesh():this._cacheAvatar.once("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},u._computeBoneIndexToMeshWithAsyncMesh=function(){this._cacheMesh.loaded?this._getCacheAnimationNodes():this._cacheMesh.on("loaded",this,this._getCacheAnimationNodes)},u._$3__onMeshChanged=function(e,t,n){this._cacheMesh=n,t&&!t.loaded&&n.off("loaded",this,this._onMeshLoaded),n.loaded?this._onMeshLoaded(n):n.on("loaded",this,this._onMeshLoaded),this._cacheAvatar&&(t&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,t),n)&&this._computeBoneIndexToMeshWithAsyncAvatar()},u._onMeshLoaded=function(e){var t=e.subMeshCount;this._subSkinnedDatas=[],this._subSkinnedDatas.length=t;for(var n=0;n<t;n++)for(var i=this._subSkinnedDatas[n]=[],r=e.getSubMesh(n)._boneIndicesList,a=0,o=r.length;a<o;a++)i[a]=new Float32Array(16*r[a].length)},u._setCacheAnimator=function(e){this._cacheAnimator=e,this._rootBone&&(this._rootIndex=e._avatarNodes.indexOf(e._avatarNodeMap[this._rootBone]))},u._setRootBone=function(e){this._rootBone=e,this._cacheAnimator&&(this._rootIndex=this._cacheAnimator._avatarNodes.indexOf(this._cacheAnimator._avatarNodeMap[e]))},u._setCacheAvatar=function(e){this._cacheAvatar!==e&&(this._cacheMesh?(this._cacheAvatar&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,this._cacheMesh),(this._cacheAvatar=e)&&(this._addShaderDefine(Ul.SHADERDEFINE_BONE),this._computeBoneIndexToMeshWithAsyncAvatar())):this._cacheAvatar=e)},u._calculateBoundingBox=function(){var e,t,n;this._hasIndependentBound?this._cacheAnimator&&(t=(e=this._owner.transform).worldMatrix,this._cacheAnimator._canCache?(n=this._cacheAnimator._curAvatarNodeDatas,br.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,n[this._rootIndex],t)):br.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheAnimator._avatarNodeMap[this._rootBone].transform.getWorldMatrix(),t),e.worldMatrix=t,null==this._cacheAnimator._avatarNodeMap[this._rootBone]||null==this._localBoundBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(this._localBoundingBoxCorners)):ol.prototype._calculateBoundingBox.call(this)},u._calculateBoundingSphere=function(){var e,t,n;this._hasIndependentBound?this._cacheAnimator&&(t=(e=this._owner.transform).worldMatrix,this._cacheAnimator._canCache?(n=this._cacheAnimator._curAvatarNodeDatas,br.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,n[this._rootIndex],t)):br.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheAnimator._avatarNodeMap[this._rootBone].transform.getWorldMatrix(),t),e.worldMatrix=t,null==this._cacheAnimator._avatarNodeMap[this._rootBone]||null==this.localBoundSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(this.localBoundSphere)):ol.prototype._calculateBoundingSphere.call(this)},u._updateOctreeNode=function(){var e=this._treeNode;e&&e.updateObject(this)},u._renderUpdate=function(e){var t,n=this._cacheAnimator,i=this._cacheMesh.subMeshCount,r=this._owner.transform;if(n){var a=n._canCache,o=this._cacheAnimator._curAvatarNodeDatas,n=n.owner;if(this._setShaderValueMatrix4x4(0,n._transform.worldMatrix),t=n.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,t),this._cacheMesh&&this._cacheMesh.loaded&&this._cacheAvatar&&this._cacheAvatar.loaded){var s=0,l=0,h=this._cacheMesh._inverseBindPoses,_=this._cacheMesh._skinnedDatas;if(a)for(s=0,l=h.length;s<l;s++)br._mulMatrixArray(o[this._cacheAnimationNodeIndex[s]],h[s],_,16*s);else for(s=0,l=h.length;s<l;s++)br._mulMatrixArray(this._cacheAnimationNode[s].transform.getWorldMatrix(),h[s],_,16*s);for(s=0;s<i;s++){for(var u=this._cacheMesh.getSubMesh(s)._boneIndicesList,d=u.length,c=this._subSkinnedDatas[s],f=0;f<d;f++)ll._splitAnimationDatas(u[f],_,c[f]);this._renderElements[s]._skinAnimationDatas=c}}}else this._setShaderValueMatrix4x4(0,r.worldMatrix),t=this._owner.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,t);return Ur.debugMode&&this._renderRenderableBoundBox(),!0},n(0,u,"localBoundBox",function(){return this._localBoundBox},function(e){(this._localBoundBox=e).getCorners(this._localBoundingBoxCorners)}),n(0,u,"boundingSphere",function(){return this._calculateBoundingSphere(),this._boundingSphere}),n(0,u,"boundingBox",function(){return this._calculateBoundingBox(),this._boundingBox}),n(0,u,"boundingBoxCenter",function(){var e=this.boundingBox;return W.add(e.min,e.max,this._boundingBoxCenter),W.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenter}),ll._splitAnimationDatas=function(e,t,n){for(var i=0,r=e.length,a=0;i<r;i++)for(var o=e[i]<<4,s=0;s<16;s++,a++)n[a]=t[o+s]};var ol,sl=ll;function ll(e){this._hasIndependentBound=!0,ll.__super.call(this,e),this._owner.transform.off("worldmatrixneedchanged",this,this._onWorldMatNeedChange),this._cacheAnimationNodeIndex=[],this._cacheAnimationNode=[],this._localBoundingBoxCorners=w(8,null),this._owner.meshFilter.on("meshchanged",this,this._$3__onMeshChanged)}t(ul,"laya.d3.core.BaseCamera",hl=Uo),(d=ul.prototype)._sortCamerasByRenderingOrder=function(){if(this._displayedInStage)for(var e,t=this.scene._cameraPool,n=t.length-1,i=0;i<n;i++)t[i].renderingOrder>t[n].renderingOrder&&(e=t[i],t[i]=t[n],t[n]=e)},d._calculateProjectionMatrix=function(){},d._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},d._prepareCameraToRender=function(){Se._currentCameraCullingMask=this.cullingMask;var e=this._shaderValues;e.setValue(0,this.transform.position.elements),e.setValue(5,this.forward.elements),e.setValue(6,this.up.elements)},d._prepareCameraViewProject=function(e,t){var n=this._shaderValues;n.setValue(1,e.elements),n.setValue(2,t.elements)},d._renderCamera=function(e,t,n){},d.addLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask|e.mask)},d.removeLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask&~e.mask)},d.addAllLayers=function(){this.cullingMask=2147483647},d.removeAllLayers=function(){this.cullingMask=0|Se.getLayerByNumber(29).mask|Se.getLayerByNumber(30).mask},d.ResetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},d.moveForward=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=e,this.transform.translate(this._tempVector3)},d.moveRight=function(e){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=e,this.transform.translate(this._tempVector3)},d.moveVertical=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=e,this.transform.translate(this._tempVector3,!1)},d._addSelfRenderObjects=function(){var e=this.scene._cameraPool,t=e.length;if(0<t){for(var n=t-1;0<=n;n--)if(this.renderingOrder<=e[n].renderingOrder){e.splice(n+1,0,this);break}}else e.push(this),this.scene.conchModel&&this.scene.conchModel.setCurrentCamera(this.conchModel)},d._clearSelfRenderObjects=function(){var e=this.scene._cameraPool;e.splice(e.indexOf(this),1)},d.destroy=function(e){void 0===e&&(e=!0),this._sky&&this._sky.destroy(),this.renderTarget=null,v.stage.off("resize",this,this._onScreenSizeChanged),hl.prototype.destroy.call(this,e)},n(0,d,"sky",function(){return this._sky},function(e){(this._sky=e)._ownerCamera=this}),n(0,d,"forward",function(){var e=this.transform.worldMatrix.elements,t=this._forward.elements;return t[0]=-e[8],t[1]=-e[9],t[2]=-e[10],this._forward}),n(0,d,"position",function(){var e=this.transform.worldMatrix.elements,t=this._position.elements;return t[0]=e[12],t[1]=e[13],t[2]=e[14],this._position}),n(0,d,"renderTarget",function(){return this._renderTarget},function(e){null!=(this._renderTarget=e)&&(this._renderTargetSize=e.size)}),n(0,d,"up",function(){var e=this.transform.worldMatrix.elements,t=this._up.elements;return t[0]=e[4],t[1]=e[5],t[2]=e[6],this._up}),n(0,d,"right",function(){var e=this.transform.worldMatrix.elements,t=this._right.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],this._right}),n(0,d,"renderTargetSize",function(){return this._renderTargetSize},function(e){null!=this.renderTarget&&this._renderTargetSize,this._renderTargetSize=e,this._calculateProjectionMatrix()}),n(0,d,"fieldOfView",function(){return this._fieldOfView},function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}),n(0,d,"nearPlane",function(){return this._nearPlane},function(e){this._nearPlane=e,this._calculateProjectionMatrix()}),n(0,d,"farPlane",function(){return this._farPlane},function(e){this._farPlane=e,this._calculateProjectionMatrix()}),n(0,d,"orthographic",function(){return this._orthographic},function(e){this._orthographic=e,this._calculateProjectionMatrix()}),n(0,d,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}),n(0,d,"renderingOrder",function(){return this._renderingOrder},function(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}),ul.CAMERAPOS=0,ul.VIEWMATRIX=1,ul.PROJECTMATRIX=2,ul.VPMATRIX=3,ul.VPMATRIX_NO_TRANSLATE=4,ul.CAMERADIRECTION=5,ul.CAMERAUP=6,ul.ENVIRONMENTDIFFUSE=7,ul.ENVIRONMENTSPECULAR=8,ul.SIMLODINFO=9,ul.DIFFUSEIRRADMATR=10,ul.DIFFUSEIRRADMATG=11,ul.DIFFUSEIRRADMATB=12,ul.HDREXPOSURE=13,ul.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",ul.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",ul.CLEARFLAG_SOLIDCOLOR=0,ul.CLEARFLAG_SKY=1,ul.CLEARFLAG_DEPTHONLY=2,ul.CLEARFLAG_NONE=3,e(ul,["_invertYScaleMatrix",function(){return this._invertYScaleMatrix=new R(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1)},"_invertYProjectionMatrix",function(){return this._invertYProjectionMatrix=new R},"_invertYProjectionViewMatrix",function(){return this._invertYProjectionViewMatrix=new R}]);var hl,_l=ul;function ul(e,t){ul.__super.call(this),void 0===e&&(e=.3),void 0===t&&(t=1e3),this._tempVector3=new W,this._position=new W,this._up=new W,this._forward=new W,this._right=new W,this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._viewportExpressedInClipSpace=!0,this._renderTargetSize=Fr.fullScreen,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=e,this._farPlane=t,this.cullingMask=2147483647,this.clearFlag=0,this.useOcclusionCulling=!0,this._calculateProjectionMatrix(),v.stage.on("resize",this,this._onScreenSizeChanged)}t(fl,"laya.d3.core.RenderableSprite3D",dl=Uo),(r=fl.prototype)._addToInitStaticBatchManager=function(){},r._setBelongScene=function(e){dl.prototype._setBelongScene.call(this,e),e._renderableSprite3Ds.push(this),this._render._applyLightMapParams()},r._setUnBelongScene=function(){var e=this._scene._renderableSprite3Ds,t=e.indexOf(this);e.splice(t,1),this._render._removeShaderDefine(laya.d3.core.RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),dl.prototype._setUnBelongScene.call(this)},r._update=function(e){(e.owner=this)._activeInHierarchy&&(this._updateComponents(e),this._render._updateOctreeNode(),this._lateUpdateComponents(e),T.spriteCount++,this._childs.length)&&this._updateChilds(e)},r.destroy=function(e){dl.prototype.destroy.call(this,e=void 0===e?!0:e),this._render._destroy(),this._render=null},fl.__init__=function(){fl.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=fl.shaderDefines.registerDefine("SCALEOFFSETLIGHTINGMAPUV"),fl.SAHDERDEFINE_LIGHTMAP=fl.shaderDefines.registerDefine("LIGHTMAP")},fl.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=2,fl.SAHDERDEFINE_LIGHTMAP=4,fl.LIGHTMAPSCALEOFFSET=2,fl.LIGHTMAP=3,e(fl,["shaderDefines",function(){return this.shaderDefines=new fr}]);var dl,cl=fl;function fl(e){this._render=null,this._geometryFilter=null,fl.__super.call(this,e)}t(ml,"laya.d3.core.light.LightSprite",Uo),(s=ml.prototype)._parseCustomProps=function(e,t,n,i){var n=n.color,r=this.color.elements;r[0]=n[0],r[1]=n[1],r[2]=n[2]},s._addSelfRenderObjects=function(){this.lightmapBakedType!==ml.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._addLight(this)},s._clearSelfRenderObjects=function(){this.lightmapBakedType!==ml.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._removeLight(this)},s._prepareToScene=function(e){return!1},n(0,s,"lightmapBakedType",function(){return this._lightmapBakedType},function(e){this._lightmapBakedType!==e&&(this._lightmapBakedType=e,this._activeInHierarchy)&&(e!==ml.LIGHTMAPBAKEDTYPE_BAKED?this._scene._addLight(this):this._scene._removeLight(this))}),n(0,s,"shadowPCFType",function(){return this._shadowMapPCFType},function(e){this._shadowMapPCFType=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setPCFType(e)}),n(0,s,"intensity",function(){return this._intensity},function(e){this._intensity=e}),n(0,s,"shadow",function(){return this._shadow},function(e){throw new Error("LightSprite: must override it.")}),n(0,s,"shadowDistance",function(){return this._shadowFarPlane},function(e){this._shadowFarPlane=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setFarDistance(e)}),n(0,s,"shadowPSSMCount",function(){return this._shadowMapCount},function(e){this._shadowMapCount=e,this._parallelSplitShadowMap&&(this._parallelSplitShadowMap.PSSMNum=e)}),n(0,s,"shadowResolution",function(){return this._shadowMapSize},function(e){this._shadowMapSize=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setShadowMapTextureSize(e)}),n(0,s,"diffuseColor",function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},function(e){console.log("LightSprite: discard property,please use color property instead."),this.color=e}),ml.LIGHTMAPBAKEDTYPE_REALTIME=0,ml.LIGHTMAPBAKEDTYPE_MIXED=1,ml.LIGHTMAPBAKEDTYPE_BAKED=2;a=ml;function ml(){this._intensityColor=null,this._intensity=NaN,this._shadow=!1,this._shadowFarPlane=0,this._shadowMapSize=0,this._shadowMapCount=0,this._shadowMapPCFType=0,this._parallelSplitShadowMap=null,this._lightmapBakedType=0,this.color=null,ml.__super.call(this),this._intensity=1,this._intensityColor=new W,this.color=new W(1,1,1),this._shadow=!1,this._shadowFarPlane=8,this._shadowMapSize=512,this._shadowMapCount=1,this._shadowMapPCFType=0,this._lightmapBakedType=ml.LIGHTMAPBAKEDTYPE_REALTIME}t(El,"laya.d3.terrain.Terrain",Uo),(l=El.prototype)._parseCustomProps=function(e,t,n,i){this.terrainRes=K.getRes(t[n.dataPath]);t=n.lightmapIndex,null!=t&&this.setLightmapIndex(t),t=n.lightmapScaleOffset;t&&this.setLightmapScaleOffset(new P(t[0],t[1],t[2],t[3]))},l.setLightmapIndex=function(e){for(var t=0;t<this._childs.length;t++)this._childs[t].terrainRender.lightmapIndex=e},l.setLightmapScaleOffset=function(e){if(e){e.cloneTo(this._lightmapScaleOffset);for(var t=0;t<this._childs.length;t++)this._childs[t].terrainRender.lightmapScaleOffset=this._lightmapScaleOffset}},l.disableLight=function(){for(var e=0,t=this._childs.length;e<t;e++)for(var n=this._childs[e],i=0,r=n._render.sharedMaterials.length;i<r;i++)n._render.sharedMaterials[i].disableLight()},l.buildTerrain=function(e){for(var t=e._chunkNumX,n=e._chunkNumZ,i=e._heightData,r=0,a=0;a<n;a++)for(var o=0;o<t;o++){for(var s=new Ql(o,a,e._gridSize,i._terrainHeightData,i._width,i._height,e._cameraCoordinateInverse),l=e._chunkInfos[r++],h=0;h<l.alphaMap.length;h++){var _=l.detailID[h].length,u=0<_?e._detailTextureInfos[l.detailID[h][0]].diffuseTexture:null,d=1<_?e._detailTextureInfos[l.detailID[h][1]].diffuseTexture:null,c=2<_?e._detailTextureInfos[l.detailID[h][2]].diffuseTexture:null,f=3<_?e._detailTextureInfos[l.detailID[h][3]].diffuseTexture:null,m=0<_?e._detailTextureInfos[l.detailID[h][0]].scale:null,p=1<_?e._detailTextureInfos[l.detailID[h][1]].scale:null,E=2<_?e._detailTextureInfos[l.detailID[h][2]].scale:null,g=3<_?e._detailTextureInfos[l.detailID[h][3]].scale:null;s.buildRenderElementAndMaterial(_,l.normalMap,l.alphaMap[h],u,d,c,f,e._materialInfo.ambientColor,e._materialInfo.diffuseColor,e._materialInfo.specularColor,m?m.x:1,m?m.y:1,p?p.x:1,p?p.y:1,E?E.x:1,E?E.y:1,g?g.x:1,g?g.y:1)}s.terrainRender.receiveShadow=!0,s.terrainRender.lightmapScaleOffset=this._lightmapScaleOffset,this.addChild(s)}},l.width=function(){return this._terrainRes._chunkNumX*Dr.CHUNK_GRID_NUM*this._terrainRes._gridSize},l.depth=function(){return this._terrainRes._chunkNumZ*Dr.CHUNK_GRID_NUM*this._terrainRes._gridSize},l.getHeightXZ=function(e,t){var n,i,r,a,o;return!this._terrainRes||!this._terrainRes.loaded||(e-=this.transform.position.x,t-=this.transform.position.z,(El.__VECTOR3__=El.__VECTOR3__?El.__VECTOR3__:new W).elements[0]=e,El.__VECTOR3__.elements[1]=0,El.__VECTOR3__.elements[2]=t,W.transformV3ToV3(El.__VECTOR3__,Dr.__ADAPT_MATRIX_INV__,El.__VECTOR3__),e=El.__VECTOR3__.elements[0],t=El.__VECTOR3__.elements[2],e<0)||e>this.width()||t<0||t>this.depth()?NaN:(n=this._terrainRes._gridSize,i=parseInt(""+e/n),r=parseInt(""+t/n),a=NaN,o=this._terrainRes._heightData,n<(e=e-i*n)+(t=t-r*n)?(a=o._terrainHeightData[(r+1-1)*o._width+i+1])+(o._terrainHeightData[(r+1-1)*o._width+i]-a)*((n-e)/n)+(o._terrainHeightData[(r-1)*o._width+i+1]-a)*((n-t)/n):(a=o._terrainHeightData[Math.max(0,r-1)*o._width+i])+(o._terrainHeightData[Math.min(o._width*o._height-1,(r+1-1)*o._width+i)]-a)*(t/n)+(o._terrainHeightData[Math.min(o._width*o._height-1,Math.max(0,r-1)*o._width+i+1)]-a)*(e/n))},n(0,l,"terrainRes",null,function(e){e&&((this._terrainRes=e).loaded?this.buildTerrain(e):e.once("loaded",this,this.buildTerrain))}),El.load=function(e){return v.loader.create(e,null,null,El,null,1,!1)},El.RENDER_LINE_MODEL=!1,El.LOD_TOLERANCE_VALUE=4,El.LOD_DISTANCE_FACTOR=2,El.__VECTOR3__=null;var pl=El;function El(e){this._terrainRes=null,this._lightmapScaleOffset=null,El.__super.call(this),this._lightmapScaleOffset=new P(1,1,0,0),e&&((this._terrainRes=e).loaded?this.buildTerrain(e):e.once("loaded",this,this.buildTerrain))}t(gl,"laya.d3.resource.models.BoxMesh",i),(D=gl.prototype).recreateResource=function(){this._numberVertices=24,this._numberIndices=36;var e=Zn.vertexDeclaration,t=(e.vertexStride,this._long/2),n=this._height/2,i=this._width/2,t=new Float32Array([-t,n,-i,0,1,0,0,0,t,n,-i,0,1,0,1,0,t,n,i,0,1,0,1,1,-t,n,i,0,1,0,0,1,-t,-n,-i,0,-1,0,0,1,t,-n,-i,0,-1,0,1,1,t,-n,i,0,-1,0,1,0,-t,-n,i,0,-1,0,0,0,-t,n,-i,-1,0,0,0,0,-t,n,i,-1,0,0,1,0,-t,-n,i,-1,0,0,1,1,-t,-n,-i,-1,0,0,0,1,t,n,-i,1,0,0,1,0,t,n,i,1,0,0,0,0,t,-n,i,1,0,0,0,1,t,-n,-i,1,0,0,1,1,-t,n,i,0,0,1,0,0,t,n,i,0,0,1,1,0,t,-n,i,0,0,1,1,1,-t,-n,i,0,0,1,0,1,-t,n,-i,0,0,-1,1,0,t,n,-i,0,0,-1,0,0,t,-n,-i,0,0,-1,0,1,-t,-n,-i,0,0,-1,1,1]),n=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);this._vertexBuffer=new Es(e,this._numberVertices,35044,!0),this._indexBuffer=new ds("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(t),this._indexBuffer.setData(n),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},n(0,D,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),n(0,D,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())}),n(0,D,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())});function gl(e,t,n){this._long=NaN,this._width=NaN,this._height=NaN,void 0===e&&(e=1),void 0===t&&(t=1),void 0===n&&(n=1),gl.__super.call(this),this._long=e,this._width=t,this._height=n,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}t(vl,"laya.d3.resource.models.CapsuleMesh",i),(u=vl.prototype).recreateResource=function(){this._numberVertices=(this._stacks+1)*(this.slices+1)*2+2*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2*2+2*this._slices*3;for(var e=Zn.vertexDeclaration,t=e.vertexStride/4,n=new Float32Array(this._numberVertices*t),i=new Uint16Array(this._numberIndices),r=Math.PI/2/this._stacks,a=2*Math.PI/this._slices,o=this._height/2-this._radius,s=0,l=0,h=0,_=0,u=0,d=0,c=0,f=0,c=0;c<=this._stacks;c++)for(f=0;f<=this._slices;f++)s=this._radius*Math.cos(c*r)*Math.cos(f*a+Math.PI),l=this._radius*Math.sin(c*r),h=this._radius*Math.cos(c*r)*Math.sin(f*a+Math.PI),n[_++]=s,n[_++]=l+o,n[_++]=h,n[_++]=s,n[_++]=l,n[_++]=h,n[_++]=1-f/this._slices,n[_++]=(1-c/this._stacks)*(Math.PI*this._radius/2/(this._height+Math.PI*this._radius)),c<this._stacks&&(i[u++]=c*(this._slices+1)+f+(this._slices+1),i[u++]=c*(this._slices+1)+f,i[u++]=c*(this._slices+1)+f+1,i[u++]=c*(this._slices+1)+f+this._slices,i[u++]=c*(this._slices+1)+f,i[u++]=c*(this._slices+1)+f+(this._slices+1));for(d+=(this._stacks+1)*(this._slices+1),c=0;c<=this._stacks;c++)for(f=0;f<=this._slices;f++)s=this._radius*Math.cos(c*r)*Math.cos(f*a+Math.PI),l=this._radius*Math.sin(-c*r),h=this._radius*Math.cos(c*r)*Math.sin(f*a+Math.PI),n[_++]=s,n[_++]=l-o,n[_++]=h,n[_++]=s,n[_++]=l,n[_++]=h,n[_++]=1-f/this._slices,n[_++]=(c/this._stacks*(Math.PI*this._radius/2)+(this._height+Math.PI*this._radius/2))/(this._height+Math.PI*this._radius),c<this._stacks&&(i[u++]=d+c*(this._slices+1)+f,i[u++]=d+c*(this._slices+1)+f+(this._slices+1),i[u++]=d+c*(this._slices+1)+f+1,i[u++]=d+c*(this._slices+1)+f,i[u++]=d+c*(this._slices+1)+f+this._slices,i[u++]=d+c*(this._slices+1)+f+(this._slices+1));for(d+=(this._stacks+1)*(this._slices+1),f=0;f<=this._slices;f++)s=this._radius*Math.cos(f*a+Math.PI),l=o,h=this._radius*Math.sin(f*a+Math.PI),n[_++]=s,n[_+8*(this._slices+1)-1]=s,n[_++]=l,n[_+8*(this._slices+1)-1]=-l,n[_++]=h,n[_+8*(this._slices+1)-1]=h,n[_++]=s,n[_+8*(this._slices+1)-1]=s,n[_++]=0,n[_+8*(this._slices+1)-1]=0,n[_++]=h,n[_+8*(this._slices+1)-1]=h,n[_++]=1-+f/this._slices,n[_+8*(this._slices+1)-1]=1-+f/this._slices,n[_++]=Math.PI*this._radius/2/(this._height+Math.PI*this._radius),n[_+8*(this._slices+1)-1]=(Math.PI*this._radius/2+this._height)/(this._height+Math.PI*this._radius);for(f=0;f<this._slices;f++)i[u++]=f+d+(this._slices+1),i[u++]=f+d+1,i[u++]=f+d,i[u++]=f+d+(this._slices+1),i[u++]=f+d+(this._slices+1)+1,i[u++]=f+d+1;d+=2*(this._slices+1),this._vertexBuffer=new Es(e,this._numberVertices,35044,!0),this._indexBuffer=new ds("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},n(0,u,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),n(0,u,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())}),n(0,u,"stacks",function(){return this._stacks},function(e){this._stacks!==e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),n(0,u,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())});function vl(e,t,n,i){this._radius=NaN,this._height=NaN,this._slices=0,void(this._stacks=0)===e&&(e=.5),void 0===t&&(t=2),void 0===n&&(n=16),void 0===i&&(i=32),vl.__super.call(this),this._radius=e,this._height=t<2*e?2*e:t,this._stacks=n,this._slices=i,this.recreateResource(),this._positions=this._getPositions(),this._generateBoundingObject()}t(Tl,"laya.d3.resource.models.CylinderMesh",i),(d=Tl.prototype).recreateResource=function(){this._numberVertices=this._slices+1+1+2*(this._slices+1)+(this._slices+1+1),this._numberIndices=3*this._slices+6*this._slices+3*this._slices;for(var e=Zn.vertexDeclaration,t=e.vertexStride/4,n=new Float32Array(this._numberVertices*t),i=new Uint16Array(this._numberIndices),r=2*Math.PI/this._slices,a=this._height/2,o=0,s=0,l=0,h=0,_=0,u=0,d=0,c=0;c<=this._slices;c++)0===c&&(n[u++]=0,n[u++]=a,n[u++]=0,n[u++]=0,n[u++]=1,n[u++]=0,n[u++]=.5,n[u++]=.5),o=c*r,l=Math.cos(o)*this._radius,h=a,_=Math.sin(o)*this._radius,n[u++]=l,n[u++]=h,n[u++]=_,n[u++]=0,n[u++]=1,n[u++]=0,n[u++]=.5+.5*Math.cos(o),n[u++]=.5+.5*Math.sin(o);for(var f=0;f<this._slices;f++)i[d++]=0,i[d++]=f+1,i[d++]=f+2;s+=this._slices+1+1;for(var m=0;m<=this._slices;m++)o=m*r,l=Math.cos(o+Math.PI)*this._radius,h=a,_=Math.sin(o+Math.PI)*this._radius,n[u++]=l,n[u+8*(this._slices+1)-1]=l,n[u++]=h,n[u+8*(this._slices+1)-1]=-h,n[u++]=_,n[u+8*(this._slices+1)-1]=_,n[u++]=l,n[u+8*(this._slices+1)-1]=l,n[u++]=0,n[u+8*(this._slices+1)-1]=0,n[u++]=_,n[u+8*(this._slices+1)-1]=_,n[u++]=1-+m/this._slices,n[u+8*(this._slices+1)-1]=1-+m/this._slices,n[u++]=0,n[u+8*(this._slices+1)-1]=1;u+=8*(this._slices+1);for(var p=0;p<this._slices;p++)i[d++]=p+s+(this._slices+1),i[d++]=p+s+1,i[d++]=p+s,i[d++]=p+s+(this._slices+1),i[d++]=p+s+(this._slices+1)+1,i[d++]=p+s+1;s+=2*(this._slices+1);for(var E=0;E<=this._slices;E++)0===E&&(n[u++]=0,n[u++]=-a,n[u++]=0,n[u++]=0,n[u++]=-1,n[u++]=0,n[u++]=.5,n[u++]=.5),o=E*r,l=Math.cos(o+Math.PI)*this._radius,h=-a,_=Math.sin(o+Math.PI)*this._radius,n[u++]=l,n[u++]=h,n[u++]=_,n[u++]=0,n[u++]=-1,n[u++]=0,n[u++]=.5+.5*Math.cos(o),n[u++]=.5+.5*Math.sin(o);for(var g=0;g<this._slices;g++)i[d++]=0+s,i[d++]=g+2+s,i[d++]=g+1+s;s+=this._slices+1+1,this._vertexBuffer=new Es(e,this._numberVertices,35044,!0),this._indexBuffer=new ds("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},n(0,d,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),n(0,d,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())}),n(0,d,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())});function Tl(e,t,n){this._radius=NaN,this._height=NaN,void(this._slices=0)===e&&(e=.5),void 0===t&&(t=2),void 0===n&&(n=32),Tl.__super.call(this),this._radius=e,this._height=t,this._slices=n,this.recreateResource(),this._positions=this._getPositions(),this._generateBoundingObject()}t(Sl,"laya.d3.resource.models.PlaneMesh",i),(r=Sl.prototype).recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=this._stacks*this._slices*2*3;for(var e=new Uint16Array(this._numberIndices),t=Zn.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=this._long/2,a=this._width/2,o=this._long/this._stacks,s=this._width/this._slices,l=0,h=0;h<=this._slices;h++)for(var _=0;_<=this._stacks;_++)i[l++]=_*o-r,i[l++]=0,i[l++]=h*s-a,i[l++]=0,i[l++]=1,i[l++]=0,i[l++]=+_/this._stacks,i[l++]=+h/this._slices;for(var u=0,h=0;h<this._slices;h++)for(_=0;_<this._stacks;_++)e[u++]=(h+1)*(this._stacks+1)+_,e[u++]=h*(this._stacks+1)+_,e[u++]=(h+1)*(this._stacks+1)+_+1,e[u++]=h*(this._stacks+1)+_,e[u++]=h*(this._stacks+1)+_+1,e[u++]=(h+1)*(this._stacks+1)+_+1;this._vertexBuffer=new Es(t,this._numberVertices,35044,!0),this._indexBuffer=new ds("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},n(0,r,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),n(0,r,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())}),n(0,r,"stacks",function(){return this._stacks},function(e){this._stacks!==e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),n(0,r,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())});function Sl(e,t,n,i){this._long=NaN,this._width=NaN,this._stacks=0,void(this._slices=0)===e&&(e=10),void 0===t&&(t=10),void 0===n&&(n=10),void 0===i&&(i=10),Sl.__super.call(this),this._long=e,this._width=t,this._stacks=n,this._slices=i,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}t(xl,"laya.d3.resource.models.QuadMesh",i),(s=xl.prototype).recreateResource=function(){this._numberVertices=4,this._numberIndices=6;var e=Zn.vertexDeclaration,t=(e.vertexStride,this._long/2),n=this._width/2,t=new Float32Array([-t,n,0,0,0,1,0,0,t,n,0,0,0,1,1,0,-t,-n,0,0,0,1,0,1,t,-n,0,0,0,1,1,1]),n=new Uint16Array([0,1,2,3,2,1]);this._vertexBuffer=new Es(e,this._numberVertices,35044,!0),this._indexBuffer=new ds("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(t),this._indexBuffer.setData(n),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},n(0,s,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),n(0,s,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())});var Dl=xl;function xl(e,t){this._long=NaN,this._width=NaN,void 0===e&&(e=1),void 0===t&&(t=1),xl.__super.call(this),this._long=e,this._width=t,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}t(Ml,"laya.d3.resource.models.SphereMesh",i),(l=Ml.prototype).recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),t=Zn.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,o=0,s=0,l=0,h=0;h<this._stacks+1;h++)for(var _=Math.sin(h*r),u=Math.cos(h*r),d=0;d<this._slices+1;d++){var c=_*Math.sin(d*a+ +Math.PI/2),f=_*Math.cos(d*a+ +Math.PI/2);i[s+0]=c*this._radius,i[s+1]=u*this._radius,i[s+2]=f*this._radius,i[s+3]=c,i[s+4]=u,i[s+5]=f,i[s+6]=d/this._slices,i[s+7]=h/this._stacks,s+=n,h!=this._stacks-1&&(e[l++]=o+(this._slices+1),e[l++]=o,e[l++]=o+1,e[l++]=o+this._slices,e[l++]=o,e[l++]=o+(this._slices+1),o++)}this._vertexBuffer=new Es(t,this._numberVertices,35044,!0),this._indexBuffer=new ds("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},n(0,l,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),n(0,l,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())}),n(0,l,"stacks",function(){return this._stacks},function(e){this._stacks!==e&&(this._stacks=e,this.releaseResource(),this.activeResource())});function Ml(e,t,n){this._radius=NaN,this._slices=0,void(this._stacks=0)===e&&(e=.5),void 0===t&&(t=32),void 0===n&&(n=32),Ml.__super.call(this),this._radius=e,this._stacks=t,this._slices=n,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}t(Il,"laya.d3.core.Camera",_l),(D=Il.prototype)._onWorldMatrixChanged=function(){this._boundFrustumUpdate=!0},D._parseCustomProps=function(e,t,n,i){var r=n.clearColor,r=(this.clearColor=new P(r[0],r[1],r[2],r[3]),n.viewport);this.normalizedViewport=new hr(r[0],r[1],r[2],r[3])},D._calculateProjectionMatrix=function(){var e,t;this._useUserProjectionMatrix||(this._orthographic?(e=this.orthographicVerticalSize*this.aspectRatio*.5,t=.5*this.orthographicVerticalSize,R.createOrthoOffCenterRH(-e,e,-t,t,this.nearPlane,this.farPlane,this._projectionMatrix)):R.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix)),this._boundFrustumUpdate=!0},D._update=function(e){this.conchModel&&(this.conchModel.setViewMatrix(this.viewMatrix.elements),this.conchModel.setProjectMatrix(this.projectionMatrix.elements)),laya.d3.core.Sprite3D.prototype._update.call(this,e)},D._renderCamera=function(e,t,n){n.parallelSplitShadowMaps[0]&&n._renderShadowMap(e,t,this),(t.camera=this)._prepareCameraToRender(),n._preRenderUpdateComponents(t),i=t._viewMatrix=this.viewMatrix;var i,r,a=this._renderTarget;a?(a.start(),R.multiply(_l._invertYScaleMatrix,this._projectionMatrix,_l._invertYProjectionMatrix),R.multiply(_l._invertYScaleMatrix,this.projectionViewMatrix,_l._invertYProjectionViewMatrix),r=t._projectionMatrix=_l._invertYProjectionMatrix,t._projectionViewMatrix=_l._invertYProjectionViewMatrix):(r=t._projectionMatrix=this._projectionMatrix,t._projectionViewMatrix=this.projectionViewMatrix),this._prepareCameraViewProject(i,r),t._viewport=this.viewport,n._preRenderScene(e,t,this.boundFrustum),n._clear(e,t),n._renderScene(e,t),n._postRenderUpdateComponents(t),a&&a.end()},D.viewportPointToRay=function(e,t){Nr.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)},D.normalizedViewportPointToRay=function(e,t){var n=Il._tempVector20,i=this.viewport,e=e.elements,r=n.elements;r[0]=e[0]*i.width,r[1]=e[1]*i.height,Nr.calculateCursorRay(n,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)},D.worldToViewportPoint=function(e,t){R.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,t);e=t.elements;e[0]=e[0]/v.stage.clientScaleX,e[1]=e[1]/v.stage.clientScaleY},D.worldToNormalizedViewportPoint=function(e,t){R.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,t);e=t.elements;e[0]=e[0]/v.stage.clientScaleX,e[1]=e[1]/v.stage.clientScaleY},D.convertScreenCoordToOrthographicCoord=function(e,t){var n,i,r,a,o;return!!this._orthographic&&(n=dt.clientWidth,i=dt.clientHeight,r=this.orthographicVerticalSize*this.aspectRatio/n,a=this.orthographicVerticalSize/i,e=e.elements,(o=t.elements)[0]=(-n/2+e[0])*r,o[1]=(i/2-e[1])*a,o[2]=(this.nearPlane-this.farPlane)*(e[2]+1)/2-this.nearPlane,W.transformCoordinate(t,this.transform.worldMatrix,t),!0)},n(0,D,"projectionViewMatrix",function(){return R.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),n(0,D,"aspectRatio",function(){var e;return 0===this._aspectRatio?(e=this.viewport).width/e.height:this._aspectRatio},function(e){if(e<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}),n(0,D,"boundFrustum",function(){return this._boundFrustumUpdate&&(this._boundFrustum.matrix=this.projectionViewMatrix),this._boundFrustum}),n(0,D,"needViewport",function(){var e=this.normalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),n(0,D,"viewport",function(){var e,t,n;return this._viewportExpressedInClipSpace&&(e=this._normalizedViewport,t=(n=this.renderTargetSize).width,n=n.height,this._viewport.x=e.x*t,this._viewport.y=e.y*n,this._viewport.width=e.width*t,this._viewport.height=e.height*n),this._viewport},function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._viewport=e,this._calculateProjectionMatrix()}),n(0,D,"normalizedViewport",function(){var e,t,n;return this._viewportExpressedInClipSpace||(e=this._viewport,t=(n=this.renderTargetSize).width,n=n.height,this._normalizedViewport.x=e.x/t,this._normalizedViewport.y=e.y/n,this._normalizedViewport.width=e.width/t,this._normalizedViewport.height=e.height/n),this._normalizedViewport},function(e){e.x<0&&(e.x=0,console.warn("Camera: viewport.x must large than 0.0.")),e.y<0&&(e.y=0,console.warn("Camera: viewport.y must large than 0.0.")),1<e.x+e.width&&(e.width=1-e.x,console.warn("Camera: viewport.width + viewport.x must less than 1.0.")),1<e.y+e.height&&(e.height=1-e.y,console.warn("Camera: viewport.height + viewport.y must less than 1.0.")),this._viewportExpressedInClipSpace=!0,this._normalizedViewport=e,this._calculateProjectionMatrix()}),n(0,D,"projectionMatrix",function(){return this._projectionMatrix},function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}),n(0,D,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),e(Il,["_tempVector20",function(){return this._tempVector20=new ar}]);var Rl=Il;function Il(e,t,n){void 0===e&&(e=0),void 0===t&&(t=.3),void 0===n&&(n=1e3),this._viewMatrix=new R,this._projectionMatrix=new R,this._projectionViewMatrix=new R,this._viewport=new hr(0,0,0,0),this._normalizedViewport=new hr(0,0,1,1),this._aspectRatio=e,this._boundFrustumUpdate=!0,this._boundFrustum=new Ui(R.DEFAULT),Il.__super.call(this,t,n),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged)}var Al;t(Cl,"laya.d3.core.glitter.Glitter",Al=cl),(u=Cl.prototype)._changeRenderObject=function(e){var t=this._render._renderElements,n=t[e];(n=n||(t[e]=new lt))._render=this._render;t=(t=this._render.sharedMaterials[e])||Zo.defaultMaterial,e=this._geometryFilter;return n._mainSortID=0,n._sprite3D=this,n.renderObj=e,n._material=t,n},u._onMaterialChanged=function(e,t,n){t<e._renderElements.length&&this._changeRenderObject(t)},u._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},u._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},u._update=function(e){this._geometryFilter._update(e.elapsedTime),Al.prototype._update.call(this,e)},u.addGlitterByPositions=function(e,t){this._geometryFilter.addVertexPosition(e,t)},u.addGlitterByPositionsVelocitys=function(e,t,n,i){this._geometryFilter.addVertexPositionVelocity(e,t,n,i)},u.cloneTo=function(e){var t=e,n=t.templet,i=this._geometryFilter,n=(n.lifeTime=i.lifeTime,n.minSegmentDistance=i.minSegmentDistance,n.minInterpDistance=i.minInterpDistance,n.maxSlerpCount=i.maxSlerpCount,n._maxSegments=i._maxSegments,t._render),i=this._render;n.sharedMaterials=i.sharedMaterials,n.enable=i.enable,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},u.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(Al.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},n(0,u,"templet",function(){return this._geometryFilter}),n(0,u,"glitterRender",function(){return this._render}),Cl.CURRENTTIME=2,Cl.DURATION=3;function Cl(){Cl.__super.call(this),this._render=new $a(this),this._render.on("materialchanged",this,this._onMaterialChanged);var e=new Zo;this._render.sharedMaterial=e,this._geometryFilter=new Io(this),e.renderMode=8,this._changeRenderObject(0)}t(Nl,"laya.d3.core.light.DirectionLight",yl=a),(d=Nl.prototype)._initShadow=function(){var e;this._shadow?(this._parallelSplitShadowMap=new Tr,this.scene.parallelSplitShadowMaps.push(this._parallelSplitShadowMap),this.transform.worldMatrix.getForward(this._direction),W.normalize(this._direction,this._direction),this._parallelSplitShadowMap.setInfo(this.scene,this._shadowFarPlane,this._direction,this._shadowMapSize,this._shadowMapCount,this._shadowMapPCFType)):((e=this.scene.parallelSplitShadowMaps).splice(e.indexOf(this._parallelSplitShadowMap),1),this._parallelSplitShadowMap.disposeAllRenderTarget(),this._parallelSplitShadowMap=null,this.scene.removeShaderDefine(Tr.SHADERDEFINE_SHADOW_PSSM1),this.scene.removeShaderDefine(Tr.SHADERDEFINE_SHADOW_PSSM2),this.scene.removeShaderDefine(Tr.SHADERDEFINE_SHADOW_PSSM3))},d._addSelfRenderObjects=function(){yl.prototype._addSelfRenderObjects.call(this),this._shadow&&this._initShadow()},d._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(4,null),t.setValue(3,null),e.removeShaderDefine(g.SHADERDEFINE_DIRECTIONLIGHT)},d._prepareToScene=function(e){var t,e=e.scene;return e.enableLight&&this._activeInHierarchy?(t=e._shaderValues,e.addShaderDefine(g.SHADERDEFINE_DIRECTIONLIGHT),W.scale(this.color,this._intensity,this._intensityColor),t.setValue(4,this._intensityColor.elements),this.transform.worldMatrix.getForward(this._direction),W.normalize(this._direction,this._direction),t.setValue(3,this._direction.elements),!0):(e.removeShaderDefine(g.SHADERDEFINE_DIRECTIONLIGHT),!1)},d._onWorldMatrixChange=function(){this._updateDirection=!0},n(0,d,"shadow",yl.prototype._$get_shadow,function(e){this._shadow!==e&&(this._shadow=e,this.scene)&&this._initShadow()}),n(0,d,"direction",function(){return console.log("Warning: discard property,please use transform's property instead."),this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),W.normalize(this._direction,this._direction),this._updateDirection=!1),this._direction},function(e){console.log("Warning: discard property,please use transform's property instead.");var t=this.transform.worldMatrix;t.setForward(e),this.transform.worldMatrix=t,W.normalize(e,e),this._direction=e,this.shadow&&this._parallelSplitShadowMap&&this._parallelSplitShadowMap._setGlobalParallelLightDir(this._direction)});var yl,Ol=Nl;function Nl(){this._direction=null,this._updateDirection=!1,Nl.__super.call(this),this._updateDirection=!1,this._direction=new W,this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChange)}t(Vl,"laya.d3.core.light.PointLight",a),(r=Vl.prototype)._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(8,null),t.setValue(5,null),t.setValue(6,null),t.setValue(7,null),e.removeShaderDefine(g.SHADERDEFINE_POINTLIGHT)},r._prepareToScene=function(e){var t,e=e.scene;return e.enableLight&&this._activeInHierarchy?(t=e._shaderValues,e.addShaderDefine(g.SHADERDEFINE_POINTLIGHT),W.scale(this.color,this._intensity,this._intensityColor),t.setValue(8,this._intensityColor.elements),t.setValue(5,this.transform.position.elements),t.setValue(6,this.range),t.setValue(7,this.attenuation.elements),!0):(e.removeShaderDefine(g.SHADERDEFINE_POINTLIGHT),!1)},n(0,r,"range",function(){return this._range},function(e){this._range=e}),n(0,r,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e});function Vl(){this._range=NaN,this._attenuation=null,Vl.__super.call(this),this._range=6,this._attenuation=new W(.6,.6,.6)}t(Ll,"laya.d3.core.light.SpotLight",a),(s=Ll.prototype)._onWorldMatrixChange=function(){this._updateDirection=!0},s._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(14,null),t.setValue(9,null),t.setValue(10,null),t.setValue(12,null),t.setValue(11,null),t.setValue(13,null),e.removeShaderDefine(g.SHADERDEFINE_SPOTLIGHT)},s._prepareToScene=function(e){var t,e=e.scene;return e.enableLight&&this._activeInHierarchy?(t=e._shaderValues,e.addShaderDefine(g.SHADERDEFINE_SPOTLIGHT),W.scale(this.color,this._intensity,this._intensityColor),t.setValue(14,this._intensityColor.elements),t.setValue(9,this.transform.position.elements),this.transform.worldMatrix.getForward(this._direction),W.normalize(this._direction,this._direction),t.setValue(10,this._direction.elements),t.setValue(12,this.range),t.setValue(11,this.spot),t.setValue(13,this.attenuation.elements),!0):(e.removeShaderDefine(g.SHADERDEFINE_SPOTLIGHT),!1)},n(0,s,"spot",function(){return this._spot},function(e){this._spot=e}),n(0,s,"direction",function(){return console.log("Warning: discard property,please use transform's property instead."),this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),this._updateDirection=!1),this._direction},function(e){console.log("Warning: discard property,please use transform's property instead.");var t=this.transform.worldMatrix;t.setForward(e),this.transform.worldMatrix=t,this._direction=e}),n(0,s,"range",function(){return this._range},function(e){this._range=e}),n(0,s,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e});function Ll(){this._updateDirection=!1,this._direction=null,this._spot=NaN,this._range=NaN,this._attenuation=null,Ll.__super.call(this),this._updateDirection=!1,this.direction=new W(0,-1,-1),this._attenuation=new W(.6,.6,.6),this._spot=96,this._range=6,this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChange)}t(Pl,"laya.d3.core.MeshSprite3D",wl=cl),(i=Pl.prototype)._changeRenderObjectByMesh=function(e){var t=this._render._renderElements,n=t[e];(n=n||(t[e]=new ma))._render=this._render;t=(t=this._render.sharedMaterials[e])||as.defaultMaterial,e=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(e,t),n._sprite3D=this,n.renderObj=e,n._material=t,n},i._changeRenderObjectByMaterial=function(e,t){var n=this._render._renderElements[e],e=(t=t||as.defaultMaterial,this._geometryFilter.sharedMesh.getRenderElement(e));return n._mainSortID=this._getSortID(e,t),n._sprite3D=this,n.renderObj=e,n._material=t,n},i._changeRenderObjectsByMesh=function(){var e=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=e;for(var t=0;t<e;t++)this._changeRenderObjectByMesh(t)},i._onMeshChanged=function(e){e=e.sharedMesh;e.loaded?this._changeRenderObjectsByMesh():e.once("loaded",this,this._onMeshLoaded)},i._onMeshLoaded=function(e){e===this.meshFilter.sharedMesh&&this._changeRenderObjectsByMesh()},i._onMaterialChanged=function(e,t,n){t<this._render._renderElements.length&&this._changeRenderObjectByMaterial(t,n)},i._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},i._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},i._parseCustomProps=function(e,t,n,i){var r,a,o=this.meshRender,s=n.lightmapIndex,s=(null!=s&&(o.lightmapIndex=s),n.lightmapScaleOffset);if(s&&(o.lightmapScaleOffset=new P(s[0],s[1],s[2],s[3])),i.instanceParams)(r=i.instanceParams.loadPath)&&(a=K.getRes(t[r]),(this.meshFilter.sharedMesh=a).loaded?o.sharedMaterials=a.materials:a.once("loaded",this,this._applyMeshMaterials));else{(r=n.meshPath)&&(a=K.getRes(t[r]),this.meshFilter.sharedMesh=a);var l=n.materials;if(l){var h=o.sharedMaterials,_=l.length;h.length=_;for(var u=0;u<_;u++)h[u]=K.getRes(t[l[u].path]);o.sharedMaterials=h}}},i._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;i<r;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},i._addToInitStaticBatchManager=function(){Pl._staticBatchManager._addInitBatchSprite(this)},i.cloneTo=function(e){var t=e,n=(t._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh,this._render),t=t._render,i=(t.enable=n.enable,t.sharedMaterials=n.sharedMaterials,t.castShadow=n.castShadow,n.lightmapScaleOffset);i&&(t.lightmapScaleOffset=i.clone()),t.lightmapIndex=n.lightmapIndex,t.receiveShadow=n.receiveShadow,t.sortingFudge=n.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},i.destroy=function(e){var t;void 0===e&&(e=!0),this.destroyed||((t=this.meshFilter.sharedMesh).loaded||t.off("loaded",this,this._applyMeshMaterials),wl.prototype.destroy.call(this,e),this._geometryFilter._destroy())},n(0,i,"meshFilter",function(){return this._geometryFilter}),n(0,i,"meshRender",function(){return this._render}),Pl.__init__=function(){Yt._staticBatchManagers.push(Pl._staticBatchManager)},Pl.load=function(e){return v.loader.create(e,null,null,Pl)},e(Pl,["_staticBatchManager",function(){return this._staticBatchManager=new ga}]);var wl,Fl=Pl;function Pl(e,t){Pl.__super.call(this,t),this._geometryFilter=new to(this),this._render=new io(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),e&&(this._geometryFilter.sharedMesh=e)instanceof laya.d3.resource.models.Mesh&&(e.loaded?this._render.sharedMaterials=e.materials:e.once("loaded",this,this._applyMeshMaterials))}t(b,"laya.d3.core.particleShuriKen.ShuriKenParticle3D",bl=cl),(l=b.prototype)._initParticleVelocity=function(e){for(var t=new Ue,n=e.velocitys,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},l._initParticleColor=function(e){for(var t=new Fe,n=e.alphas,i=0,r=0,i=0,r=n.length;i<r;i++){var a=n[i];t.addAlpha(a.key,a.value)}var o=e.rgbs;for(i=0,r=o.length;i<r;i++){var s=o[i],l=s.value;t.addRGB(s.key,new W(l[0],l[1],l[2]))}return t},l._initParticleSize=function(e){for(var t=new Ue,n=e.sizes,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},l._initParticleRotation=function(e){for(var t=new Ue,n=e.angularVelocitys,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value/180*Math.PI)}return t},l._initParticleFrame=function(e){for(var t=new be,n=e.frames,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},l._createRenderElement=function(e){var t=this._render._renderElements[e]=new lt;t._render=this._render;var e=(e=this._render.sharedMaterials[e])||ms.defaultMaterial,n=this._geometryFilter;t._mainSortID=0,t._sprite3D=this,t.renderObj=n,t._material=e},l._onMaterialChanged=function(e,t,n){e=e._renderElements;t<e.length&&(e[t]._material=n||ms.defaultMaterial)},l._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},l._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},l._parseCustomProps=function(e,t,n,F){var i,r=Math.PI/180,a=0,o=this.particleRender,s=n.material,s=(s?l=K.getRes(t[s.path]):(s=n.materialPath)?l=K.getRes(t[s]):(l=new ms).diffuseTexture=t?K.getRes(t[n.texturePath]):nl.load(n.texturePath),o.sharedMaterial=l,n.meshPath),l=(s&&(o.mesh=K.getRes(t[s])),o.renderMode=n.renderMode,o.stretchedBillboardCameraSpeedScale=n.stretchedBillboardCameraSpeedScale,o.stretchedBillboardSpeedScale=n.stretchedBillboardSpeedScale,o.stretchedBillboardLengthScale=n.stretchedBillboardLengthScale,o.sortingFudge=n.sortingFudge||0,this.particleSystem),t=(l.isPerformanceMode=n.isPerformanceMode,l.duration=n.duration,l.looping=n.looping,l.prewarm=n.prewarm,l.startDelayType=n.startDelayType,l.startDelay=n.startDelay,l.startDelayMin=n.startDelayMin,l.startDelayMax=n.startDelayMax,l.startLifetimeType=n.startLifetimeType,l.startLifetimeConstant=n.startLifetimeConstant,l.startLifeTimeGradient=b._initStartLife(n.startLifetimeGradient),l.startLifetimeConstantMin=n.startLifetimeConstantMin,l.startLifetimeConstantMax=n.startLifetimeConstantMax,l.startLifeTimeGradientMin=b._initStartLife(n.startLifetimeGradientMin),l.startLifeTimeGradientMax=b._initStartLife(n.startLifetimeGradientMax),l.startSpeedType=n.startSpeedType,l.startSpeedConstant=n.startSpeedConstant,l.startSpeedConstantMin=n.startSpeedConstantMin,l.startSpeedConstantMax=n.startSpeedConstantMax,l.threeDStartSize=n.threeDStartSize,l.startSizeType=n.startSizeType,l.startSizeConstant=n.startSizeConstant,n.startSizeConstantSeparate),s=l.startSizeConstantSeparate.elements,o=(s[0]=t[0],s[1]=t[1],s[2]=t[2],l.startSizeConstantMin=n.startSizeConstantMin,l.startSizeConstantMax=n.startSizeConstantMax,n.startSizeConstantMinSeparate),s=l.startSizeConstantMinSeparate.elements,t=(s[0]=o[0],s[1]=o[1],s[2]=o[2],n.startSizeConstantMaxSeparate),s=l.startSizeConstantMaxSeparate.elements,o=(s[0]=t[0],s[1]=t[1],s[2]=t[2],l.threeDStartRotation=n.threeDStartRotation,l.startRotationType=n.startRotationType,l.startRotationConstant=n.startRotationConstant*r,n.startRotationConstantSeparate),s=l.startRotationConstantSeparate.elements,t=(s[0]=o[0]*r,s[1]=o[1]*r,s[2]=o[2]*r,l.startRotationConstantMin=n.startRotationConstantMin*r,l.startRotationConstantMax=n.startRotationConstantMax*r,n.startRotationConstantMinSeparate),s=l.startRotationConstantMinSeparate.elements,o=(s[0]=t[0]*r,s[1]=t[1]*r,s[2]=t[2]*r,n.startRotationConstantMaxSeparate),s=l.startRotationConstantMaxSeparate.elements,t=(s[0]=o[0]*r,s[1]=o[1]*r,s[2]=o[2]*r,l.randomizeRotationDirection=n.randomizeRotationDirection,l.startColorType=n.startColorType,n.startColorConstant),s=l.startColorConstant.elements,o=(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],n.startColorConstantMin),s=l.startColorConstantMin.elements,t=(s[0]=o[0],s[1]=o[1],s[2]=o[2],s[3]=o[3],n.startColorConstantMax),s=l.startColorConstantMax.elements,o=(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],l.gravityModifier=n.gravityModifier,l.simulationSpace=n.simulationSpace,l.scaleMode=n.scaleMode,l.playOnAwake=n.playOnAwake,l.maxParticles=n.maxParticles,n.autoRandomSeed),s=(null!=o&&(l.autoRandomSeed=o),n.randomSeed),t=(null!=s&&(l.randomSeed[0]=s),n.emission),h=l.emission;if(t){h.emissionRate=t.emissionRate;var _=t.bursts;if(_)for(a=0,i=_.length;a<i;a++){var u=_[a];h.addBurst(new xe(u.time,u.min,u.max))}h.enbale=t.enable}else h.enbale=!1;var d=n.shape;if(d){switch(d.shapeType){case 0:var c,f=c=new ca;c.radius=d.sphereRadius,c.emitFromShell=d.sphereEmitFromShell,c.randomDirection=d.sphereRandomDirection;break;case 1:f=c=new _a,c.radius=d.hemiSphereRadius,c.emitFromShell=d.hemiSphereEmitFromShell,c.randomDirection=d.hemiSphereRandomDirection;break;case 2:f=c=new sa,c.angle=d.coneAngle*r,c.radius=d.coneRadius,c.length=d.coneLength,c.emitType=d.coneEmitType,c.randomDirection=d.coneRandomDirection;break;case 3:f=c=new ta,c.x=d.boxX,c.y=d.boxY,c.z=d.boxZ,c.randomDirection=d.boxRandomDirection;break;case 7:f=c=new ra,c.radius=d.circleRadius,c.arc=d.circleArc*r,c.emitFromEdge=d.circleEmitFromEdge,c.randomDirection=d.circleRandomDirection;break;default:f=c=new ra,c.radius=d.circleRadius,c.arc=d.circleArc*r,c.emitFromEdge=d.circleEmitFromEdge,c.randomDirection=d.circleRandomDirection}f.enable=d.enable,l.shape=f}o=n.velocityOverLifetime;if(o){var m=o.velocity;switch(m.type){case 0:var p=m.constant,E=ke.createByConstant(new W(p[0],p[1],p[2]));break;case 1:E=ke.createByGradient(this._initParticleVelocity(m.gradientX),this._initParticleVelocity(m.gradientY),this._initParticleVelocity(m.gradientZ));break;case 2:var p=m.constantMin,g=m.constantMax;E=ke.createByRandomTwoConstant(new W(p[0],p[1],p[2]),new W(g[0],g[1],g[2]));break;case 3:E=ke.createByRandomTwoGradient(this._initParticleVelocity(m.gradientXMin),this._initParticleVelocity(m.gradientXMax),this._initParticleVelocity(m.gradientYMin),this._initParticleVelocity(m.gradientYMax),this._initParticleVelocity(m.gradientZMin),this._initParticleVelocity(m.gradientZMax))}s=new it(E);s.space=o.space,s.enbale=o.enable,l.velocityOverLifetime=s}t=n.colorOverLifetime;if(t){var v=t.color;switch(v.type){case 0:var T=v.constant,S=Le.createByConstant(new P(T[0],T[1],T[2],T[3]));break;case 1:S=Le.createByGradient(this._initParticleColor(v.gradient));break;case 2:var T=v.constantMin,D=v.constantMax;S=Le.createByRandomTwoConstant(new P(T[0],T[1],T[2],T[3]),new P(D[0],D[1],D[2],D[3]));break;case 3:S=Le.createByRandomTwoGradient(this._initParticleColor(v.gradientMin),this._initParticleColor(v.gradientMax))}o=new Re(S);o.enbale=t.enable,l.colorOverLifetime=o}s=n.sizeOverLifetime;if(s){var x,M,R,I=s.size;switch(I.type){case 0:R=I.separateAxes?ze.createByGradientSeparate(this._initParticleSize(I.gradientX),this._initParticleSize(I.gradientY),this._initParticleSize(I.gradientZ)):ze.createByGradient(this._initParticleSize(I.gradient));break;case 1:R=I.separateAxes?(x=I.constantMinSeparate,M=I.constantMaxSeparate,ze.createByRandomTwoConstantSeparate(new W(x[0],x[1],x[2]),new W(M[0],M[1],M[2]))):ze.createByRandomTwoConstant(I.constantMin,I.constantMax);break;case 2:R=I.separateAxes?ze.createByRandomTwoGradientSeparate(this._initParticleSize(I.gradientXMin),this._initParticleSize(I.gradientYMin),this._initParticleSize(I.gradientZMin),this._initParticleSize(I.gradientXMax),this._initParticleSize(I.gradientYMax),this._initParticleSize(I.gradientZMax)):ze.createByRandomTwoGradient(this._initParticleSize(I.gradientMin),this._initParticleSize(I.gradientMax))}t=new Qe(R);t.enbale=s.enable,l.sizeOverLifetime=t}o=n.rotationOverLifetime;if(o){var A,C,y,O=o.angularVelocity;switch(O.type){case 0:O.separateAxes||(y=Ne.createByConstant(O.constant*r));break;case 1:O.separateAxes||(y=Ne.createByGradient(this._initParticleRotation(O.gradient)));break;case 2:y=O.separateAxes?(A=O.constantMinSeparate,C=O.constantMaxSeparate,Ne.createByRandomTwoConstantSeparate(new W(A[0]*r,A[1]*r,A[2]*r),new W(C[0]*r,C[1]*r,C[2]*r))):Ne.createByRandomTwoConstant(O.constantMin*r,O.constantMax*r);break;case 3:O.separateAxes||(y=Ne.createByRandomTwoGradient(this._initParticleRotation(O.gradientMin),this._initParticleRotation(O.gradientMax)))}s=new Ye(y);s.enbale=o.enable,l.rotationOverLifetime=s}t=n.textureSheetAnimation;if(t){var N,V=t.frame;switch(V.type){case 0:N=ye.createByConstant(V.constant);break;case 1:N=ye.createByOverTime(this._initParticleFrame(V.overTime));break;case 2:N=ye.createByRandomTwoConstant(V.constantMin,V.constantMax);break;case 3:N=ye.createByRandomTwoOverTime(this._initParticleFrame(V.overTimeMin),this._initParticleFrame(V.overTimeMax))}var L,w=t.startFrame;switch(w.type){case 0:L=Je.createByConstant(w.constant);break;case 1:L=Je.createByRandomTwoConstant(w.constantMin,w.constantMax)}o=new tt(N,L),s=(o.enable=t.enable,t.tiles),n=(o.tiles=new ar(s[0],s[1]),o.type=t.type,o.randomRow=t.randomRow,t.rowIndex);void 0!==n&&(o.rowIndex=n),o.cycles=t.cycles,l.textureSheetAnimation=o}},l._activeHierarchy=function(){laya.d3.core.Sprite3D.prototype._activeHierarchy.call(this),this.particleSystem.playOnAwake&&this.particleSystem.play()},l._inActiveHierarchy=function(){laya.d3.core.Sprite3D.prototype._inActiveHierarchy.call(this),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)},l.cloneTo=function(e){var t=e,n=t._geometryFilter,n=(this._geometryFilter.cloneTo(n),t._render),t=this._render;n.sharedMaterials=t.sharedMaterials,n.enable=t.enable,n.renderMode=t.renderMode,n.mesh=t.mesh,n.stretchedBillboardCameraSpeedScale=t.stretchedBillboardCameraSpeedScale,n.stretchedBillboardSpeedScale=t.stretchedBillboardSpeedScale,n.stretchedBillboardLengthScale=t.stretchedBillboardLengthScale,n.sortingFudge=t.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},l.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(bl.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},n(0,l,"particleSystem",function(){return this._geometryFilter}),n(0,l,"particleRender",function(){return this._render}),b.__init__=function(){b.SHADERDEFINE_RENDERMODE_BILLBOARD=b.shaderDefines.registerDefine("SPHERHBILLBOARD"),b.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=b.shaderDefines.registerDefine("STRETCHEDBILLBOARD"),b.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=b.shaderDefines.registerDefine("HORIZONTALBILLBOARD"),b.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=b.shaderDefines.registerDefine("VERTICALBILLBOARD"),b.SHADERDEFINE_COLOROVERLIFETIME=b.shaderDefines.registerDefine("COLOROVERLIFETIME"),b.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=b.shaderDefines.registerDefine("RANDOMCOLOROVERLIFETIME"),b.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=b.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECONSTANT"),b.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=b.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECURVE"),b.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=b.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),b.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=b.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),b.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=b.shaderDefines.registerDefine("TEXTURESHEETANIMATIONCURVE"),b.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=b.shaderDefines.registerDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),b.SHADERDEFINE_ROTATIONOVERLIFETIME=b.shaderDefines.registerDefine("ROTATIONOVERLIFETIME"),b.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=b.shaderDefines.registerDefine("ROTATIONOVERLIFETIMESEPERATE"),b.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=b.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECONSTANT"),b.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=b.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECURVE"),b.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=b.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),b.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=b.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),b.SHADERDEFINE_SIZEOVERLIFETIMECURVE=b.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVE"),b.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=b.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVESEPERATE"),b.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=b.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVES"),b.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=b.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),b.SHADERDEFINE_RENDERMODE_MESH=b.shaderDefines.registerDefine("RENDERMODE_MESH"),b.SHADERDEFINE_SHAPE=b.shaderDefines.registerDefine("SHAPE")},b.load=function(e){return v.loader.create(e,null,null,b)},b._initStartLife=function(e){for(var t=new Ue,n=e.startLifetimes,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},b.SHADERDEFINE_RENDERMODE_BILLBOARD=0,b.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=0,b.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=0,b.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=0,b.SHADERDEFINE_COLOROVERLIFETIME=0,b.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=0,b.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=0,b.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=0,b.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=0,b.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=0,b.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=0,b.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=0,b.SHADERDEFINE_ROTATIONOVERLIFETIME=0,b.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=0,b.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=0,b.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=0,b.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=0,b.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=0,b.SHADERDEFINE_SIZEOVERLIFETIMECURVE=0,b.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=0,b.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=0,b.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=0,b.SHADERDEFINE_RENDERMODE_MESH=0,b.SHADERDEFINE_SHAPE=0,b.WORLDPOSITION=0,b.WORLDROTATION=1,b.POSITIONSCALE=4,b.SIZESCALE=5,b.SCALINGMODE=6,b.GRAVITY=7,b.THREEDSTARTROTATION=8,b.STRETCHEDBILLBOARDLENGTHSCALE=9,b.STRETCHEDBILLBOARDSPEEDSCALE=10,b.SIMULATIONSPACE=11,b.CURRENTTIME=12,b.VOLVELOCITYCONST=13,b.VOLVELOCITYGRADIENTX=14,b.VOLVELOCITYGRADIENTY=15,b.VOLVELOCITYGRADIENTZ=16,b.VOLVELOCITYCONSTMAX=17,b.VOLVELOCITYGRADIENTXMAX=18,b.VOLVELOCITYGRADIENTYMAX=19,b.VOLVELOCITYGRADIENTZMAX=20,b.VOLSPACETYPE=21,b.COLOROVERLIFEGRADIENTALPHAS=22,b.COLOROVERLIFEGRADIENTCOLORS=23,b.MAXCOLOROVERLIFEGRADIENTALPHAS=24,b.MAXCOLOROVERLIFEGRADIENTCOLORS=25,b.SOLSIZEGRADIENT=26,b.SOLSIZEGRADIENTX=27,b.SOLSIZEGRADIENTY=28,b.SOLSizeGradientZ=29,b.SOLSizeGradientMax=30,b.SOLSIZEGRADIENTXMAX=31,b.SOLSIZEGRADIENTYMAX=32,b.SOLSizeGradientZMAX=33,b.ROLANGULARVELOCITYCONST=34,b.ROLANGULARVELOCITYCONSTSEPRARATE=35,b.ROLANGULARVELOCITYGRADIENT=36,b.ROLANGULARVELOCITYGRADIENTX=37,b.ROLANGULARVELOCITYGRADIENTY=38,b.ROLANGULARVELOCITYGRADIENTZ=39,b.ROLANGULARVELOCITYGRADIENTW=40,b.ROLANGULARVELOCITYCONSTMAX=41,b.ROLANGULARVELOCITYCONSTMAXSEPRARATE=42,b.ROLANGULARVELOCITYGRADIENTMAX=43,b.ROLANGULARVELOCITYGRADIENTXMAX=44,b.ROLANGULARVELOCITYGRADIENTYMAX=45,b.ROLANGULARVELOCITYGRADIENTZMAX=46,b.ROLANGULARVELOCITYGRADIENTWMAX=47,b.TEXTURESHEETANIMATIONCYCLES=48,b.TEXTURESHEETANIMATIONSUBUVLENGTH=49,b.TEXTURESHEETANIMATIONGRADIENTUVS=50,b.TEXTURESHEETANIMATIONGRADIENTMAXUVS=51,e(b,["shaderDefines",function(){return this.shaderDefines=new fr(cl.shaderDefines)}]);var bl,V=b;function b(e){b.__super.call(this),this._render=new ho(this),this._render.on("materialchanged",this,this._onMaterialChanged),this._geometryFilter=new oo(this),this._createRenderElement(0),e&&(this._render.sharedMaterial=e)}t(Hl,"laya.d3.core.SkinnedMeshSprite3D",Bl=cl),(D=Hl.prototype)._changeRenderObjectByMesh=function(e){var t=this._render._renderElements,n=t[e];(n=n||(t[e]=new ma))._render=this._render;t=(t=this._render.sharedMaterials[e])||as.defaultMaterial,e=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(e,t),n._sprite3D=this,n.renderObj=e,n._material=t,n},D._changeRenderObjectByMaterial=function(e,t){var n=this._render._renderElements[e],e=(t=t||as.defaultMaterial,this._geometryFilter.sharedMesh.getRenderElement(e));return n._mainSortID=this._getSortID(e,t),n._sprite3D=this,n.renderObj=e,n._material=t,n},D._changeRenderObjectsByMesh=function(){var e=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=e;for(var t=0;t<e;t++)this._changeRenderObjectByMesh(t)},D._onMeshChanged=function(e){e=e.sharedMesh;e.loaded?this._changeRenderObjectsByMesh():e.once("loaded",this,this._changeRenderObjectsByMesh)},D._onMaterialChanged=function(e,t,n){t<this._render._renderElements.length&&this._changeRenderObjectByMaterial(t,n)},D._parseCustomProps=function(e,t,n,i){var r=this.skinnedMeshRender,a=n.lightmapIndex,a=(null!=a&&(r.lightmapIndex=a),n.lightmapScaleOffset);if(a&&(r.lightmapScaleOffset=new P(a[0],a[1],a[2],a[3])),i.instanceParams)(_=i.instanceParams.loadPath)&&(u=K.getRes(t[_]),(this.meshFilter.sharedMesh=u).loaded?r.sharedMaterials=u.materials:u.once("loaded",this,this._applyMeshMaterials));else{(_=n.meshPath)&&(u=K.getRes(t[_]),this.meshFilter.sharedMesh=u);var o=n.materials;if(o){var s=r.sharedMaterials,l=o.length;s.length=l;for(var h=0;h<l;h++)s[h]=K.getRes(t[o[h].path]);r.sharedMaterials=s}var _,u,a=n.rootBone,i=(a&&r._setRootBone(a),n.boundBox),i=(i?(_=i.min,u=i.max,a=new bi(new W(_[0],_[1],_[2]),new W(u[0],u[1],u[2])),r.localBoundBox=a):r._hasIndependentBound=!1,n.boundSphere);i&&(_=i.center,u=new Gi(new W(_[0],_[1],_[2]),i.radius),r.localBoundSphere=u)}},D._changeHierarchyAnimator=function(e){var t,n;e&&((t=this.skinnedMeshRender)._setCacheAnimator(e),n=e.avatar)&&t._setCacheAvatar(n),laya.d3.core.Sprite3D.prototype._changeHierarchyAnimator.call(this,e)},D._clearSelfRenderObjects=function(){this._scene.removeFrustumCullingObject(this._render)},D._addSelfRenderObjects=function(){this._scene.addFrustumCullingObject(this._render)},D._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;i<r;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},D.cloneTo=function(e){var t=e,n=(t._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh,this._render),t=t._render,i=(t.enable=n.enable,t.sharedMaterials=n.sharedMaterials,t.castShadow=n.castShadow,n.lightmapScaleOffset),i=(i&&(t.lightmapScaleOffset=i.clone()),t.receiveShadow=n.receiveShadow,t.sortingFudge=n.sortingFudge,t._rootBone=n._rootBone,n.localBoundSphere),i=(i&&(t.localBoundSphere=i.clone()),n.localBoundBox);i&&(t.localBoundBox=i.clone()),t._hasIndependentBound=n._hasIndependentBound,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},D.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(Bl.prototype.destroy.call(this,e),this._geometryFilter._destroy())},n(0,D,"meshFilter",function(){return this._geometryFilter}),n(0,D,"skinnedMeshRender",function(){return this._render}),Hl.__init__=function(){Hl.SHADERDEFINE_BONE=Hl.shaderDefines.registerDefine("BONE")},Hl.load=function(e){return v.loader.create(e,null,null,Hl)},Hl.SHADERDEFINE_BONE=8,Hl.BONES=0,e(Hl,["shaderDefines",function(){return this.shaderDefines=new fr(cl.shaderDefines)}]);var Bl,Ul=Hl;function Hl(e,t){this._subMeshOffset=null,Hl.__super.call(this,t),this._subMeshOffset=[],this._geometryFilter=new to(this),this._render=new sl(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),e&&(this._geometryFilter.sharedMesh=e)}t(Gl,"laya.d3.core.VRCamera",_l),(u=Gl.prototype)._onWorldMatrixChanged=function(){this._leftBoundFrustumUpdate=this._rightBoundFrustumUpdate=!0},u._calculatePupilOffset=function(){var e=this._tempVector3;return W.scale(this.right,this._pupilDistande/2,e),e.elements},u._calculateLeftProjectionMatrix=function(){var e,t;this._useUserProjectionMatrix||(this._orthographic?(e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize,R.createOrthoOffCenterRH(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix)):R.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix)),this._leftBoundFrustumUpdate=!0},u._calculateRightProjectionMatrix=function(){var e,t;this._useUserProjectionMatrix||(this._orthographic?(e=this.orthographicVerticalSize*this.rightAspectRatio*.5,t=.5*this.orthographicVerticalSize,R.createOrthoOffCenterRH(-e,e,t,t,this.nearPlane,this.farPlane,this._rightProjectionMatrix)):R.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix)),this._rightBoundFrustumUpdate=!0},u._calculateProjectionMatrix=function(){var e,t,n,i;this._useUserProjectionMatrix||(this._orthographic?(e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize,n=this.orthographicVerticalSize*this.rightAspectRatio*.5,i=.5*this.orthographicVerticalSize,R.createOrthoOffCenterRH(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix),R.createOrthoOffCenterRH(-n,n,i,i,this.nearPlane,this.farPlane,this._rightProjectionMatrix)):(R.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix),R.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix))),this._leftBoundFrustumUpdate=this._rightBoundFrustumUpdate=!0},u._renderCamera=function(e,t,n){(t.camera=this)._prepareCameraToRender(),n._preRenderUpdateComponents(t),r=t._viewMatrix=this.leftViewMatrix;var i,r,a,o=this._renderTarget;o?(o.start(),R.multiply(_l._invertYScaleMatrix,this._leftProjectionMatrix,_l._invertYProjectionMatrix),R.multiply(_l._invertYScaleMatrix,this.leftProjectionViewMatrix,_l._invertYProjectionViewMatrix),i=t._projectionMatrix=_l._invertYProjectionMatrix,t._projectionViewMatrix=_l._invertYProjectionViewMatrix):(i=t._projectionMatrix=this._leftProjectionMatrix,t._projectionViewMatrix=this.leftProjectionViewMatrix),this._prepareCameraViewProject(r,i),t._viewport=this.leftViewport,n._preRenderScene(e,t,this.leftBoundFrustum),n._clear(e,t),n._renderScene(e,t),r=t._viewMatrix=this.rightViewMatrix,o?(o.start(),R.multiply(_l._invertYScaleMatrix,this._rightProjectionMatrix,_l._invertYProjectionMatrix),R.multiply(_l._invertYScaleMatrix,this.rightProjectionViewMatrix,_l._invertYProjectionViewMatrix),t._projectionMatrix=_l._invertYProjectionMatrix,a=t._projectionViewMatrix=_l._invertYProjectionViewMatrix):(a=t._projectionMatrix=this._rightProjectionMatrix,t._projectionViewMatrix=this.rightProjectionViewMatrix),this._prepareCameraViewProject(r,a),t._viewport=this.rightViewport,n._preRenderScene(e,t,this.rightBoundFrustum),n._clear(e,t),n._renderScene(e,t),n._postRenderUpdateComponents(t),o&&o.end()},n(0,u,"rightBoundFrustum",function(){return this._rightBoundFrustumUpdate&&(this._rightBoundFrustum.matrix=this.rightProjectionViewMatrix),this._rightBoundFrustum}),n(0,u,"leftNormalizedViewport",function(){var e,t,n;return this._viewportExpressedInClipSpace||(e=this._leftViewport,t=(n=this.renderTargetSize).width,n=n.height,this._leftNormalizedViewport.x=e.x/t,this._leftNormalizedViewport.y=e.y/n,this._leftNormalizedViewport.width=e.width/t,this._leftNormalizedViewport.height=e.height/n),this._leftNormalizedViewport}),n(0,u,"rightViewport",function(){var e,t,n;return this._viewportExpressedInClipSpace&&(e=this._rightNormalizedViewport,t=(n=this.renderTargetSize).width,n=n.height,this._rightViewport.x=e.x*t,this._rightViewport.y=e.y*n,this._rightViewport.width=e.width*t,this._rightViewport.height=e.height*n),this._rightViewport}),n(0,u,"viewport",null,function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._leftViewport=new hr(0,0,e.width/2,e.height),this._rightViewport=new hr(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),n(0,u,"leftAspectRatio",function(){var e;return 0===this._leftAspectRatio?(e=this.leftViewport).width/e.height:this._leftAspectRatio}),n(0,u,"rightAspectRatio",function(){var e;return 0===this._rightAspectRatio?(e=this.rightViewport).width/e.height:this._rightAspectRatio}),n(0,u,"aspectRatio",null,function(e){if(e<0)throw new Error("VRCamera: the aspect ratio has to be a positive real number.");this._leftAspectRatio=e,this._rightAspectRatio=e,this._calculateRightProjectionMatrix()}),n(0,u,"rightNormalizedViewport",function(){var e,t,n;return this._viewportExpressedInClipSpace||(e=this._rightViewport,t=(n=this.renderTargetSize).width,n=n.height,this._rightNormalizedViewport.x=e.x/t,this._rightNormalizedViewport.y=e.y/n,this._rightNormalizedViewport.width=e.width/t,this._rightNormalizedViewport.height=e.height/n),this._rightNormalizedViewport}),n(0,u,"normalizedViewport",null,function(e){if(e.x<0||e.y<0||1<e.x+e.width||1<e.x+e.height)throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._leftNormalizedViewport=new hr(0,0,e.width/2,e.height),this._rightNormalizedViewport=new hr(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),n(0,u,"leftViewport",function(){var e,t,n;return this._viewportExpressedInClipSpace&&(e=this._leftNormalizedViewport,t=(n=this.renderTargetSize).width,n=n.height,this._leftViewport.x=e.x*t,this._leftViewport.y=e.y*n,this._leftViewport.width=e.width*t,this._leftViewport.height=e.height*n),this._leftViewport}),n(0,u,"needLeftViewport",function(){var e=this.leftNormalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),n(0,u,"needRightViewport",function(){var e=this.rightNormalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),n(0,u,"leftViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix,n=(this.transform.worldMatrix.cloneTo(t),t.elements);return n[12]-=e[0],n[13]-=e[1],n[14]-=e[2],t.invert(this._leftViewMatrix),this._leftViewMatrix}),n(0,u,"rightViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix,n=(this.transform.worldMatrix.cloneTo(t),t.elements);return n[12]+=e[0],n[13]+=e[1],n[14]+=e[2],t.invert(this._rightViewMatrix),this._rightViewMatrix}),n(0,u,"leftProjectionMatrix",function(){return this._leftProjectionMatrix}),n(0,u,"leftProjectionViewMatrix",function(){return R.multiply(this.leftProjectionMatrix,this.leftViewMatrix,this._leftProjectionViewMatrix),this._leftProjectionViewMatrix}),n(0,u,"rightProjectionMatrix",function(){return this._rightProjectionMatrix}),n(0,u,"rightProjectionViewMatrix",function(){return R.multiply(this.rightProjectionMatrix,this.rightViewMatrix,this._rightProjectionViewMatrix),this._rightProjectionViewMatrix}),n(0,u,"leftBoundFrustum",function(){return this._leftBoundFrustumUpdate&&(this._leftBoundFrustum.matrix=this.leftProjectionViewMatrix),this._leftBoundFrustum});function Gl(e,t,n,i,r){void 0===e&&(e=.1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=.3),void 0===r&&(r=1e3),this._tempMatrix=new R,this._leftViewMatrix=new R,this._leftProjectionMatrix=new R,this._leftProjectionViewMatrix=new R,this._leftViewport=new hr(0,0,0,0),this._leftNormalizedViewport=new hr(0,0,.5,1),this._leftAspectRatio=t,this._rightViewMatrix=new R,this._rightProjectionMatrix=new R,this._rightProjectionViewMatrix=new R,this._rightViewport=new hr(0,0,0,0),this._rightNormalizedViewport=new hr(.5,0,.5,1),this._rightAspectRatio=n,this._pupilDistande=e,this._leftBoundFrustumUpdate=!0,this._leftBoundFrustum=new Ui(R.DEFAULT),this._rightBoundFrustumUpdate=!0,this._rightBoundFrustum=new Ui(R.DEFAULT),Gl.__super.call(this,i,r),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged)}t(kl,"laya.d3.core.trail.TrailSprite3D",zl=cl),(d=kl.prototype)._changeRenderObjectsByMaterial=function(e,t,n){var i=this._geometryFilter.getRenderElementsCount();this._render._renderElements.length=i;for(var r=0;r<i;r++)this._changeRenderObjectByMaterial(r,n)},d._changeRenderObjectByMaterial=function(e,t){var n=this._render._renderElements,i=(t=t||vs.defaultMaterial,n[e]);(i=i||(n[e]=new lt))._sprite3D=this,i.renderObj=this._geometryFilter.getRenderElement(e),i._render=this._render,i._material=t},d._changeRenderObjectsByRenderElement=function(e,t){var n=this._render._renderElements,i=n[e];(i=i||(n[e]=new lt))._sprite3D=this,i.renderObj=t,i._render=this._render,i._material=this._render.sharedMaterial},d._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},d._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},d._update=function(e){zl.prototype._update.call(this,e),this._geometryFilter._update(e)},d._parseCustomProps=function(e,t,n,i){var r=this._render,a=this._geometryFilter,o=0,s=0,l=n.materials;if(l){var h=r.sharedMaterials,_=l.length;for(h.length=_,o=0;o<_;o++)h[o]=K.getRes(t[l[o].path]);r.sharedMaterials=h}for(var r=i.props,u=(a.time=r.time,a.minVertexDistance=r.minVertexDistance,a.widthMultiplier=r.widthMultiplier,a.textureMode=r.textureMode,[]),d=n.widthCurve,o=0,s=d.length;o<s;o++){var c=new At;c.time=d[o].time,c.inTangent=d[o].inTangent,c.outTangent=d[o].outTangent,c.value=d[o].value,u.push(c)}a.widthCurve=u;var f,i=n.colorGradient,r=new vt,m=(r.mode=i.mode,[]),p=i.colorKeys;for(o=0,s=p.length;o<s;o++)f=p[o],f=new xt(new Et(f.value[0],f.value[1],f.value[2],1),f.time),m.push(f);var E,g=[],v=i.alphaKeys;for(o=0,s=v.length;o<s;o++)E=v[o],E=new St(E.value,E.time),g.push(E);r.setKeys(m,g),a.colorGradient=r},d.reset=function(){this.trailFilter.reset()},d.cloneTo=function(e){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e);for(var t=0,n=e.trailFilter,i=(n.time=this.trailFilter.time,n.minVertexDistance=this.trailFilter.minVertexDistance,n.widthMultiplier=this.trailFilter.widthMultiplier,this.trailFilter.widthCurve),r=[],t=0,a=i.length;t<a;t++){var o=new At;i[t].cloneTo(o),r.push(o)}n.widthCurve=r;var s=new vt;this.trailFilter.colorGradient.cloneTo(s),n.colorGradient=s,n.textureMode=this.trailFilter.textureMode,e.trailRender.sharedMaterial=this.trailRender.sharedMaterial},d.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(zl.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},n(0,d,"trailFilter",function(){return this._geometryFilter}),n(0,d,"trailRender",function(){return this._render}),kl.__init__=function(){kl.SHADERDEFINE_GRADIENTMODE_BLEND=kl.shaderDefines.registerDefine("GRADIENTMODE_BLEND")},kl.CURTIME=3,kl.LIFETIME=4,kl.WIDTHCURVE=5,kl.WIDTHCURVEKEYLENGTH=6,kl.GRADIENTCOLORKEY=7,kl.GRADIENTALPHAKEY=8,kl.SHADERDEFINE_GRADIENTMODE_BLEND=0,e(kl,["shaderDefines",function(){return this.shaderDefines=new fr(cl.shaderDefines)}]);var zl,Wl=kl;function kl(){kl.__super.call(this),this._geometryFilter=new co(this),this._render=new mo(this),this._changeRenderObjectsByMaterial(this._render,0,vs.defaultMaterial),this._render.on("materialchanged",this,this._changeRenderObjectsByMaterial),this._geometryFilter.on("trailfilterchange",this,this._changeRenderObjectsByRenderElement)}var Xl;t(Yl,"laya.d3.extension.domino.DominoSprite3D",Xl=cl),(r=Yl.prototype).addDomino=function(e,t,n){void 0===e&&(e=W.ZERO),void 0===t&&(t=$i.DEFAULT),void 0===n&&(n=this._defaultScale),this._geometryFilter.addDomino(e,t,n)},r.updateDomino=function(e,t,n,i){void 0===t&&(t=W.ZERO),void 0===n&&(n=$i.DEFAULT),void 0===i&&(i=this._defaultScale),this._geometryFilter.updateDomino(e,t,n,i)},r.updateDominos=function(e,t,n){if(t>n.length)throw Error("Update domino count can't more than keyFrames Count!");this._geometryFilter.updateDominos(e,t,n)},r._changeRenderObjects=function(e,t,n){var i=this._geometryFilter.getDominoRenderElementsCount();this._render._renderElements.length=i;for(var r=0;r<i;r++)this._changeRenderObject(r,n)},r._changeRenderObject=function(e,t){var n=this._render._renderElements,i=(t=t||xs.defaultMaterial,n[e]);(i=i||(n[e]=new lt))._sprite3D=this,i.renderObj=this._geometryFilter.getRenderElement(e),i._render=this._render,i._material=t},r._changeRenderObjectsByRenderElement=function(e,t){var n=this._render._renderElements,i=n[e];(i=i||(n[e]=new lt))._sprite3D=this,i.renderObj=t,i._render=this._render,i._material=this._render.sharedMaterial||xs.defaultMaterial},r._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},r._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},r._update=function(e){Xl.prototype._update.call(this,e),this._geometryFilter._update(e)},n(0,r,"dominoFilter",function(){return this._geometryFilter}),n(0,r,"dominoRender",function(){return this._render});function Yl(){Yl.__super.call(this),this._defaultScale=new W(.4,1,.12),this._geometryFilter=new Eo(this),this._render=new So(this),this._changeRenderObjects(this._render,0,xs.defaultMaterial),this._render.on("materialchanged",this,this._changeRenderObjects),this._geometryFilter.on("dominofilterchange",this,this._changeRenderObjectsByRenderElement)}t(Kl,"laya.d3.extension.lineRender.LineSprite3D",Zl=cl),(a=Kl.prototype).addPosition=function(e,t){this._geometryFilter.addPosition(e,t)},a._changeRenderObjects=function(e,t,n){var i=this._render._renderElements,r=(n=n||Rs.defaultMaterial,i[t]);(r=r||(i[t]=new lt))._sprite3D=this,r.renderObj=this._geometryFilter,r._render=this._render,r._material=n},a._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},a._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},a._update=function(e){Zl.prototype._update.call(this,e),this._geometryFilter._update(e)},a._parseCustomProps=function(e,t,n,i){var r=this._render,a=this._geometryFilter,o=0,s=0,l=n.materials;if(l){var h=r.sharedMaterials,_=l.length;for(h.length=_,o=0;o<_;o++)h[o]=K.getRes(t[l[o].path]);r.sharedMaterials=h}for(var r=i.props,u=(a.widthMultiplier=r.widthMultiplier,a.textureMode=r.textureMode,[]),d=n.widthCurve,o=0,s=d.length;o<s;o++){var c=new At;c.time=d[o].time,c.inTangent=d[o].inTangent,c.outTangent=d[o].outTangent,c.value=d[o].value,u.push(c)}a.widthCurve=u;var f,i=n.colorGradient,r=new vt,m=(r.mode=i.mode,[]),p=i.colorKeys;for(o=0,s=p.length;o<s;o++)f=p[o],f=new xt(new Et(f.value[0],f.value[1],f.value[2],1),f.time),m.push(f);var E,g=[],v=i.alphaKeys;for(o=0,s=v.length;o<s;o++)E=v[o],E=new St(E.value,E.time),g.push(E);r.setKeys(m,g),a.colorGradient=r;var T,i=n.positions,S=i.size,D=i.values;for(o=0;o<S;o++)T=D[o],this._position.x=T[0],this._position.y=T[1],this._position.z=T[2],this.addPosition(this._position)},a.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(Zl.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._position=null)},n(0,a,"lineFilter",function(){return this._geometryFilter}),n(0,a,"lineRender",function(){return this._render}),Kl.__init__=function(){Kl.SHADERDEFINE_GRADIENTMODE_BLEND=Kl.shaderDefines.registerDefine("GRADIENTMODE_BLEND"),Kl.SHADERDEFINE_TEXTUREMODE_STRETCH=Kl.shaderDefines.registerDefine("TEXTUREMODE"),Kl.SHADERDEFINE_WORLDSPACE=Kl.shaderDefines.registerDefine("WORLDSPACE")},Kl.WIDTHCURVE=3,Kl.WIDTHCURVEKEYLENGTH=4,Kl.GRADIENTCOLORKEY=5,Kl.GRADIENTALPHAKEY=6,Kl.SHADERDEFINE_WORLDSPACE=0,Kl.SHADERDEFINE_GRADIENTMODE_BLEND=0,Kl.SHADERDEFINE_TEXTUREMODE_STRETCH=0,e(Kl,["shaderDefines",function(){return this.shaderDefines=new fr(cl.shaderDefines)}]);var Zl,jl=Kl;function Kl(){Kl.__super.call(this),this._position=new W,this._render=new xo(this),this._geometryFilter=new vo(this),this._changeRenderObjects(this._render,0,Rs.defaultMaterial),this._render.on("materialchanged",this,this._changeRenderObjects)}t($l,"laya.d3.terrain.TerrainChunk",ql=cl),(s=$l.prototype).buildRenderElementAndMaterial=function(e,t,n,i,r,a,o,s,l,h,_,u,d,c,f,m,p,E){void 0===_&&(_=1),void 0===u&&(u=1),void 0===d&&(d=1),void 0===c&&(c=1),void 0===f&&(f=1),void 0===m&&(m=1),void 0===p&&(p=1),void 0===E&&(E=1);var g=new ss,l=(l&&(g.diffuseColor=l),s&&(g.ambientColor=s),h&&(g.specularColor=h),g.splatAlphaTexture=K.getRes(n),g.normalTexture=t?K.getRes(t):null,g.diffuseTexture1=i?K.getRes(i):null,g.diffuseTexture2=r?K.getRes(r):null,g.diffuseTexture3=a?K.getRes(a):null,g.diffuseTexture4=o?K.getRes(o):null,g.setDiffuseScale1(_,u),g.setDiffuseScale2(d,c),g.setDiffuseScale3(f,m),g.setDiffuseScale4(p,E),g.setDetailNum(e),0!=this._render._renderElements.length&&(g.renderMode=2),new lt);l._mainSortID=0,l._sprite3D=this,l.renderObj=this._geometryFilter,l._material=g,this._render._materials.push(g),this._render._renderElements.push(l)},s._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},s._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},s._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;i<r;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},s.cloneTo=function(e){console.log("Terrain Chunk can't clone")},s.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(ql.prototype.destroy.call(this,e),this._geometryFilter._destroy())},n(0,s,"terrainFilter",function(){return this._geometryFilter}),n(0,s,"terrainRender",function(){return this._render}),$l.load=function(e){return v.loader.create(e,null,null,$l,null,1,!1)};var ql,Ql=$l;function $l(e,t,n,i,r,a,o,s){$l.__super.call(this,s),this._geometryFilter=new yo(this,e,t,n,i,r,a,o),this._render=new Vo(this)}t(Jl,"laya.d3.core.MeshTerrainSprite3D",Fl),(i=Jl.prototype)._disableRotation=function(){var e=this.transform.rotation;e.elements[0]=0,e.elements[1]=0,e.elements[2]=0,e.elements[3]=1,this.transform.rotation=e},i._getScaleX=function(){var e=this.transform.worldMatrix.elements,t=e[0],n=e[1],e=e[2];return Math.sqrt(t*t+n*n+e*e)},i._getScaleZ=function(){var e=this.transform.worldMatrix.elements,t=e[8],n=e[9],e=e[10];return Math.sqrt(t*t+n*n+e*e)},i._initCreateFromMesh=function(e,t){this._heightMap=ve.creatFromMesh(this.meshFilter.sharedMesh,e,t,this._cellSize);e=this.meshFilter.sharedMesh.boundingBox,t=e.min;e.max;this._minX=t.x,this._minZ=t.z},i._initCreateFromMeshHeightMap=function(e,t,n){var i=this,r=this.meshFilter.sharedMesh.boundingBox,a=(e.loaded?(this._heightMap=ve.createFromImage(e,t,n),this._computeCellSize(r)):e.once("loaded",null,function(){i._heightMap=ve.createFromImage(e,t,n),i._computeCellSize(r)}),r.min);r.max;this._minX=a.x,this._minZ=a.z},i._computeCellSize=function(e){var t=e.min,e=e.max,n=t.x,t=t.z,i=e.x,e=e.z-t;this._cellSize.elements[0]=(i-n)/(this._heightMap.width-1),this._cellSize.elements[1]=e/(this._heightMap.height-1)},i._update=function(e){this._disableRotation(),laya.d3.core.RenderableSprite3D.prototype._update.call(this,e)},i.getHeight=function(e,t){Jl._tempVector3.elements[0]=e,Jl._tempVector3.elements[1]=0,Jl._tempVector3.elements[2]=t,this._disableRotation();var n,i=this.transform.worldMatrix,e=(i.invert(Jl._tempMatrix4x4),W.transformCoordinate(Jl._tempVector3,Jl._tempMatrix4x4,Jl._tempVector3),e=Jl._tempVector3.elements[0],t=Jl._tempVector3.elements[2],(e-this._minX)/this._cellSize.x),t=(t-this._minZ)/this._cellSize.y,r=Math.floor(t),a=Math.floor(e),e=e-a,t=t-r,i=i.elements,o=i[4],s=i[5],l=i[6],o=Math.sqrt(o*o+s*s+l*l),s=i[13],l=this._heightMap.getHeight(r,a+1),i=this._heightMap.getHeight(r+1,a);return isNaN(l)||isNaN(i)?NaN:e+t<=1?(n=this._heightMap.getHeight(r,a),isNaN(n)?NaN:(n+e*(l-n)+t*(i-n))*o+s):(n=this._heightMap.getHeight(r+1,a+1),isNaN(n)?NaN:(n+(1-e)*(i-n)+(1-t)*(l-n))*o+s)},n(0,i,"minX",function(){var e=this.transform.worldMatrix.elements;return this._minX*this._getScaleX()+e[12]}),n(0,i,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}),n(0,i,"minZ",function(){var e=this.transform.worldMatrix.elements;return this._minZ*this._getScaleZ()+e[14]}),n(0,i,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}),Jl.createFromMesh=function(e,t,n,i){i=new Jl(e,null,i);return e.loaded?i._initCreateFromMesh(t,n):e.once("loaded",i,i._initCreateFromMesh,[t,n]),i},Jl.createFromMeshAndHeightMap=function(e,t,n,i,r){r=new Jl(e,null,r);return e.loaded?r._initCreateFromMeshHeightMap(t,n,i):e.once("loaded",r,r._initCreateFromMeshHeightMap,[t,n,i]),r},e(Jl,["_tempVector3",function(){return this._tempVector3=new W},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new R}]);function Jl(e,t,n){this._minX=NaN,this._minZ=NaN,this._cellSize=null,this._heightMap=null,Jl.__super.call(this,e,n),this._heightMap=t,this._cellSize=new ar}t(eh,"laya.d3.water.WaterSprite",Fl),(l=eh.prototype)._getWaveInfo=function(e,t,n,i,r,a,o){var s=n*eh._waveInfoEleNum,n=2*n,i=i*eh.deg2rad;t[n++]=Math.cos(i),t[+n]=Math.sin(i),e[s++]=a,e[s++]=o,e[s++]=eh._2pi/r,e[+s]=7.846987702957/Math.sqrt(r)},l.onDescLoaded=function(e){var n=this,t=js.load(e.mesh),t=(this._texWave=new qs(e.detailTexSize[0],e.detailTexSize[1],6408,5121,33189,!1,!1),this.useRefrTex?(this._texRefract=new qs(e.refracTexSize[0],e.refracTexSize[1]),this._texRefract.repeat=!1,this._texRefract.mipmap=!0,this.mtl.useRefractTexture=!0):this.mtl.useRefractTexture=!1,(this._geometryFilter.sharedMesh=t).once("loaded",this,this._applyMeshMaterials),t.on("loaded",this,this.onMeshLoaded),".ltc"===e.skyTexture.substr(e.skyTexture.length-4).toLowerCase()?(this.mtl.skyTexture=rl.load(e.skyTexture),this.mtl._addShaderDefine(_s.SHADERDEFINE_CUBE_ENV)):(this.mtl.skyTexture=nl.load(e.skyTexture),this.mtl._removeShaderDefine(_s.SHADERDEFINE_CUBE_ENV)),e.hdrsky&&this.mtl._addShaderDefine(_s.SHADERDEFINE_HDR_ENV),null!=e.deepScale&&(this.mtl.deepScale=e.deepScale),e.useVertexDeep&&(this.mtl.useVertexDeep=!0),this.mtl.skyTexture.repeat=!0,nl.load(e.infoTexture)),t=(t.repeat=!1,this.mtl.waterInfoTexture=t,nl.load(e.foamTexture));if(t.repeat=!0,this.mtl.foamTexture=t,this.mtl.renderMode=13,this.mtl.waveMainDir=e.geoWaveData[0].dir,this.mtl.geoWaveUVScale=e.geoWaveUVScale,this._detailMesh=new Dl(2,2),this.detailMtl=new Vs,this.detailMtl.texWaveUVScale=e.detailWaveUVScale,4!=e.geoWaveData.length)throw"error 3";if(4!=e.detailData.length)throw"error 4";e.geoWaveData.forEach(function(e,t){n._getWaveInfo(n._geoWaveInfo,n._geoWaveInfoDir,t,e.dir,e.L,e.Q,e.A)});e.detailData.forEach(function(e,t){n._getWaveInfo(n._texWaveInfo,n._texWaveInfoDir,t,e.dir,e.L,1.5,.01*e.L)}),this._waterColor.x=e.color[0]/255,this._waterColor.y=e.color[1]/255,this._waterColor.z=e.color[2]/255,this.mtl.seaColor=new Float32Array([this._waterColor.x,this._waterColor.y,this._waterColor.z]),this._waterFogStart=e.fogStart,this._waterFogRange=e.fogRange,this.afterDescLoaded&&this.afterDescLoaded.call(this)},l.onMeshLoaded=function(){if(this._refractQueue=new _t(this._scene),this._scrSizeInfo[0]=v.stage.width,this._scrSizeInfo[1]=v.stage.height,this.mtl.scrsize=this._scrSizeInfo,this.meshRender.sharedMaterial=this.mtl,!(0<this._render._renderElements.length))throw"error2";this._render._renderElements[0]._onPreRenderFunction=this.onPreRender,this._waterLoaded=!0},l.stop=function(){this._stop=!this._stop},l.addRefractObj=function(e){this._refractObjStack.push(e),this._refractObjecs.push(e)},l.onPreRender=function(t){var n=this;if(this._waterLoaded){if(this._refractObjStack.length)for(var e=0;e<this._refractObjStack.length;e++){var i=this._refractObjStack[e];i._render._renderElements.length&&(i._render._renderElements.forEach(function(e){n._refractQueue._addRenderElement(e)}),this._refractObjStack.splice(e,1),e--)}var r,a,o,s=c.mainContext,l=s.getParameter(2929),h=s.getParameter(2884),_=s.getParameter(2978),u=!1;this.useRefrTex&&(this._texRefract.start(),u=!0,s.viewport(0,0,this._texRefract.width,this._texRefract.height),s.clearColor(this._waterColor.x,this._waterColor.y,this._waterColor.z,1),s.clear(16640),this._refractObjecs.forEach(function(e){e._renderUpdate(t._projectionViewMatrix)}),this._refractQueue._preRender(t),this._refractQueue._render(t,!1),this._texRefract.end(),this._texRefract.repeat=!0),this.renderDetailWav&&(this._texWave.start(),s.disable(2929),s.disable(2884),u=!0,s.viewport(0,0,eh.detailTexWidth,eh.detailTexHeight),(r=this._detailMesh.getRenderElement(0))._beforeRender(t),this.detailMtl.currentTm=v.timer.currTimer,this.detailMtl.waveInfo=this._texWaveInfo,this.detailMtl.waveInfoD=this._texWaveInfoDir,(a=this.detailMtl._getShader(0,0,0)).bind(),o=this._detailMesh._getVertexBuffer(0),a.uploadAttributes(o.vertexDeclaration.shaderValues.data,null),this.detailMtl._upload(),r._render(t),this._texWave.end(),l&&s.enable(2929),h)&&s.enable(2884),u&&s.viewport(_[0],_[1],_[2],_[3]),this._syncObj?this.mtl.detailTexture=this._syncObj._texWave:this.mtl.detailTexture=this._texWave,this.mtl.waveInfo=this._geoWaveInfo,this.mtl.waveInfoD=this._geoWaveInfoDir,this.mtl.underWaterTexture=this._texRefract,this._stop||(this._syncObj?this.curTm=this._syncObj.curTm:this.curTm=v.timer.currTimer-this.startTm,this.mtl._setNumber(8,this.curTm)),L.shownormal&&!this._shownormal&&(this._shownormal=!0,this.mtl._addShaderDefine(_s.SHADERDEFINE_SHOW_NORMAL)),L.shownormal&&this._shownormal&&(this._shownormal=!1,this.mtl._removeShaderDefine(_s.SHADERDEFINE_SHOW_NORMAL))}},l._update=function(e){laya.d3.core.RenderableSprite3D.prototype._update.call(this,e)},n(0,l,"src",null,function(e){var t=new K;t.on("complete",this,this.onDescLoaded),t.load(e)}),n(0,l,"syncObj",null,function(e){this._syncObj=e,this.renderDetailWav=!1}),eh._waveInfoEleNum=4,eh.detailTexWidth=256,eh.detailTexHeight=256,e(eh,["deg2rad",function(){return this.deg2rad=Math.PI/180},"_2pi",function(){return this._2pi=2*Math.PI}]);function eh(e,t){this.mtl=null,this.detailMtl=null,this.mesh=null,this.useRefrTex=!0,this.renderDetailWav=!0,this._stop=!1,this._texWave=null,this._texRefract=null,this._detailMesh=null,this._texWaveDegTest=0,this._shownormal=!1,this._refractQueue=null,this._waterLoaded=!1,this._waterFogStart=0,this._waterFogRange=20,this.startTm=0,this.curTm=0,this._syncObj=null,this.afterDescLoaded=null,this._geoWaveInfo=new Float32Array(4*eh._waveInfoEleNum),this._geoWaveInfoDir=new Float32Array(8),this._texWaveInfo=new Float32Array(15*eh._waveInfoEleNum),this._texWaveInfoDir=new Float32Array(30),this._texWaveTrans=new Float32Array(9),this._refractObjStack=[],this._refractObjecs=[],this._scrSizeInfo=new Float32Array(2),this._waterColor=new W,eh.__super.call(this,e,t),this.mtl=new _s,this.startTm=v.timer.currTimer,this.curTm=0}}(window,(document,Laya)),"function"==typeof define&&define.amd&&define("laya.core",["require","exports"],function(e,t){"use strict";for(var n in Object.defineProperty(t,"__esModule",{value:!0}),Laya){var i=Laya[n];i&&i.__isclass&&(t[n]=i)}});